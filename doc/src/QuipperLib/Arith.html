<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<html>
<head>
<!-- Generated by HsColour, http://code.haskell.org/~malcolm/hscolour/ -->
<title>Haskell code</title>
</head>
<body>
<pre><a name="line-1"></a><font color=Blue><i>{-# LANGUAGE MultiParamTypeClasses #-}</i></font>
<a name="line-2"></a><font color=Blue><i>{-# LANGUAGE FlexibleInstances #-}</i></font>
<a name="line-3"></a><font color=Blue><i>{-# LANGUAGE UndecidableInstances #-}</i></font>
<a name="line-4"></a><font color=Blue><i>{-# LANGUAGE TypeFamilies #-}</i></font>
<a name="line-5"></a><font color=Blue><i>{-# LANGUAGE TypeSynonymInstances #-}</i></font>
<a name="line-6"></a>
<a name="line-7"></a><font color=Blue><i>{-# LANGUAGE IncoherentInstances #-}</i></font>
<a name="line-8"></a><font color=Blue><i>{-# LANGUAGE DeriveDataTypeable  #-}</i></font>
<a name="line-9"></a>
<a name="line-10"></a><font color=Blue><i>-- | This library provides a type of quantum integers, as well as</i></font>
<a name="line-11"></a><font color=Blue><i>-- basic arithmetic functions on them.</i></font>
<a name="line-12"></a><font color=Blue><i>-- </i></font>
<a name="line-13"></a><font color=Blue><i>-- The type 'QDInt' holds a fixed-size, &#8467;-qubit quantum integer,</i></font>
<a name="line-14"></a><font color=Blue><i>-- considered modulo 2[sup &#8467;]. The integers may be regarded as</i></font>
<a name="line-15"></a><font color=Blue><i>-- signed or unsigned, depending on the operation. If signs are used,</i></font>
<a name="line-16"></a><font color=Blue><i>-- they are assumed to be in two's complement.</i></font>
<a name="line-17"></a><font color=Blue><i>-- </i></font>
<a name="line-18"></a><font color=Blue><i>-- Some of the arithmetic operations are adapted from the GFI for the</i></font>
<a name="line-19"></a><font color=Blue><i>-- Triangle Finding algorithm. Most algorithms used are, for now, very</i></font>
<a name="line-20"></a><font color=Blue><i>-- na&#239;ve (ripple adders, etc).  Gate count estimates are given in the</i></font>
<a name="line-21"></a><font color=Blue><i>-- Toffoli gatebase.</i></font>
<a name="line-22"></a>
<a name="line-23"></a><font color=Blue><i>-- Documentation note: the table of contents is organized slightly</i></font>
<a name="line-24"></a><font color=Blue><i>-- differently than the source code. The guiding idea is that the</i></font>
<a name="line-25"></a><font color=Blue><i>-- documentation should expose the interface that is accessible to</i></font>
<a name="line-26"></a><font color=Blue><i>-- user-level code, and changeable implementation details are hidden.</i></font>
<a name="line-27"></a>
<a name="line-28"></a><font color=Green><u>module</u></font> QuipperLib<font color=Cyan>.</font>Arith <font color=Cyan>(</font>
<a name="line-29"></a>  <font color=Blue><i>-- * Quantum integers</i></font>
<a name="line-30"></a>  <font color=Blue><i>-- ** Data type definitions</i></font>
<a name="line-31"></a>  <font color=Blue><i>-- $DATATYPES</i></font>
<a name="line-32"></a>  XInt<font color=Cyan>,</font>  <font color=Blue><i>-- constructors not exported</i></font>
<a name="line-33"></a>  QDInt<font color=Cyan>,</font>
<a name="line-34"></a>  CInt<font color=Cyan>,</font>
<a name="line-35"></a>  IntM<font color=Cyan>,</font>
<a name="line-36"></a>  <font color=Blue><i>-- ** Operations on QDInt</i></font>
<a name="line-37"></a>  qulist_of_qdint_bh<font color=Cyan>,</font>
<a name="line-38"></a>  qdint_of_qulist_bh<font color=Cyan>,</font>
<a name="line-39"></a>  qulist_of_qdint_lh<font color=Cyan>,</font>
<a name="line-40"></a>  qdint_of_qulist_lh<font color=Cyan>,</font>
<a name="line-41"></a>  qdint_length<font color=Cyan>,</font>
<a name="line-42"></a>  qdint_extend_unsigned<font color=Cyan>,</font>
<a name="line-43"></a>  qdint_extend_signed<font color=Cyan>,</font>
<a name="line-44"></a>  <font color=Blue><i>-- ** Operations on CInt</i></font>
<a name="line-45"></a>  bitlist_of_cint_bh<font color=Cyan>,</font>
<a name="line-46"></a>  cint_of_bitlist_bh<font color=Cyan>,</font>
<a name="line-47"></a>  bitlist_of_cint_lh<font color=Cyan>,</font>
<a name="line-48"></a>  cint_of_bitlist_lh<font color=Cyan>,</font>
<a name="line-49"></a>  cint_length<font color=Cyan>,</font>
<a name="line-50"></a>  cint_extend_unsigned<font color=Cyan>,</font>
<a name="line-51"></a>  cint_extend_signed<font color=Cyan>,</font>
<a name="line-52"></a>  <font color=Blue><i>-- ** Operations on IntM</i></font>
<a name="line-53"></a>  <font color=Blue><i>-- $INTMCLASSES</i></font>
<a name="line-54"></a>  boollist_of_intm_bh<font color=Cyan>,</font>
<a name="line-55"></a>  intm_of_boollist_bh<font color=Cyan>,</font>
<a name="line-56"></a>  intm_length<font color=Cyan>,</font>
<a name="line-57"></a>  integer_of_intm_unsigned<font color=Cyan>,</font>
<a name="line-58"></a>  integer_of_intm_signed<font color=Cyan>,</font>
<a name="line-59"></a>  intm_with_length<font color=Cyan>,</font>
<a name="line-60"></a>  intm_of_integer<font color=Cyan>,</font>
<a name="line-61"></a>  intm<font color=Cyan>,</font>
<a name="line-62"></a>  intm_promote<font color=Cyan>,</font>
<a name="line-63"></a>  intm_interval_signed<font color=Cyan>,</font>
<a name="line-64"></a>  intm_interval_unsigned<font color=Cyan>,</font>
<a name="line-65"></a>  intm_extend_unsigned<font color=Cyan>,</font>
<a name="line-66"></a>  intm_extend_signed<font color=Cyan>,</font>
<a name="line-67"></a>  <font color=Blue><i>-- ** Shape parameters</i></font>
<a name="line-68"></a>  qdint_shape<font color=Cyan>,</font>
<a name="line-69"></a>  cint_shape<font color=Cyan>,</font>
<a name="line-70"></a>  <font color=Blue><i>-- ** Operations on XInt</i></font>
<a name="line-71"></a>  xint_maybe_length<font color=Cyan>,</font>
<a name="line-72"></a>  list_of_xint_bh<font color=Cyan>,</font>
<a name="line-73"></a>  xint_of_list_bh<font color=Cyan>,</font>
<a name="line-74"></a>  list_of_xint_lh<font color=Cyan>,</font>
<a name="line-75"></a>  xint_of_list_lh<font color=Cyan>,</font>
<a name="line-76"></a>  <font color=Blue><i>-- * Quantum arithmetic operations</i></font>
<a name="line-77"></a>  <font color=Blue><i>-- ** The QNum type class</i></font>
<a name="line-78"></a>  QNum<font color=Cyan>(</font><font color=Red>..</font><font color=Cyan>)</font><font color=Cyan>,</font>
<a name="line-79"></a>  <font color=Blue><i>-- ** In-place increment and decrement</i></font>
<a name="line-80"></a>  q_increment<font color=Cyan>,</font>
<a name="line-81"></a>  q_decrement<font color=Cyan>,</font>
<a name="line-82"></a>  <font color=Blue><i>-- ** In-place addition and subtraction</i></font>
<a name="line-83"></a>  q_add_in_place<font color=Cyan>,</font>
<a name="line-84"></a>  q_sub_in_place<font color=Cyan>,</font>
<a name="line-85"></a>  q_negate_in_place<font color=Cyan>,</font>
<a name="line-86"></a>  <font color=Blue><i>-- ** Arithmetic with classical parameter</i></font>
<a name="line-87"></a>  q_add_param<font color=Cyan>,</font>
<a name="line-88"></a>  q_sub_param<font color=Cyan>,</font>
<a name="line-89"></a>  q_add_param_in_place<font color=Cyan>,</font>
<a name="line-90"></a>  q_sub_param_in_place<font color=Cyan>,</font>
<a name="line-91"></a>  q_mult_param<font color=Cyan>,</font>
<a name="line-92"></a>  <font color=Blue><i>-- ** Comparison</i></font>
<a name="line-93"></a>  q_le_unsigned<font color=Cyan>,</font>
<a name="line-94"></a>  q_le_signed<font color=Cyan>,</font>
<a name="line-95"></a>  q_lt_signed<font color=Cyan>,</font>
<a name="line-96"></a>  q_negative<font color=Cyan>,</font>
<a name="line-97"></a>  <font color=Blue><i>-- ** Division and remainder</i></font>
<a name="line-98"></a>  q_moddiv_unsigned_in_place<font color=Cyan>,</font>
<a name="line-99"></a>  q_mod_unsigned<font color=Cyan>,</font>
<a name="line-100"></a>  q_divrem_unsigned<font color=Cyan>,</font>
<a name="line-101"></a>  q_div_unsigned<font color=Cyan>,</font>
<a name="line-102"></a>  q_div<font color=Cyan>,</font>
<a name="line-103"></a>  q_quot<font color=Cyan>,</font>
<a name="line-104"></a>  q_div_exact_unsigned<font color=Cyan>,</font>
<a name="line-105"></a>  q_div_exact<font color=Cyan>,</font>
<a name="line-106"></a>  <font color=Blue><i>-- ** Specialized functions</i></font>
<a name="line-107"></a>  q_ext_euclid<font color=Cyan>,</font>
<a name="line-108"></a>  <font color=Blue><i>-- * Lifting of arithmetic functions</i></font>
<a name="line-109"></a>  <font color=Blue><i>-- $LIFTING</i></font>
<a name="line-110"></a>  template_symb_plus_<font color=Cyan>,</font>
<a name="line-111"></a>  <font color=Cyan>)</font> <font color=Green><u>where</u></font>
<a name="line-112"></a>
<a name="line-113"></a><font color=Green><u>import</u></font> Quipper
<a name="line-114"></a><font color=Green><u>import</u></font> Quipper<font color=Cyan>.</font>Internal
<a name="line-115"></a>
<a name="line-116"></a><font color=Green><u>import</u></font> Libraries<font color=Cyan>.</font>Sampling
<a name="line-117"></a><font color=Green><u>import</u></font> Libraries<font color=Cyan>.</font>Auxiliary
<a name="line-118"></a>
<a name="line-119"></a><font color=Green><u>import</u></font> Control<font color=Cyan>.</font>Monad
<a name="line-120"></a><font color=Green><u>import</u></font> Data<font color=Cyan>.</font>Typeable
<a name="line-121"></a>
<a name="line-122"></a><font color=Blue><i>-- ======================================================================</i></font>
<a name="line-123"></a><font color=Blue><i>-- * Quantum integers</i></font>
<a name="line-124"></a>
<a name="line-125"></a><font color=Blue><i>-- ** Data type definitions</i></font>
<a name="line-126"></a>
<a name="line-127"></a><font color=Blue><i>-- $DATATYPES </i></font>
<a name="line-128"></a><font color=Blue><i>-- We define three versions of the fixed-length integer type: quantum,</i></font>
<a name="line-129"></a><font color=Blue><i>-- classical input, and classical parameter. The triple ('IntM',</i></font>
<a name="line-130"></a><font color=Blue><i>-- 'QDInt', 'CInt') forms an instance of the 'QShape' class.  All three</i></font>
<a name="line-131"></a><font color=Blue><i>-- types are special cases of the type 'XInt' /x/.</i></font>
<a name="line-132"></a>
<a name="line-133"></a><font color=Blue><i>-- | 'XInt' /x/ is the type of fixed-length integers, but using</i></font>
<a name="line-134"></a><font color=Blue><i>-- elements of type /x/ instead of bits. It is an abstract type, and</i></font>
<a name="line-135"></a><font color=Blue><i>-- details of its implementation is not exposed to user-level code.</i></font>
<a name="line-136"></a>
<a name="line-137"></a><a name="XInt"></a><font color=Blue><i>-- Implemenation notes: The integer types are currently implemented as</i></font>
<a name="line-138"></a><a name="XInt"></a><font color=Blue><i>-- big-headian bit lists. However, the details of the implementation</i></font>
<a name="line-139"></a><a name="XInt"></a><font color=Blue><i>-- are not exposed to user-level code, and are subject to change.</i></font>
<a name="line-140"></a><a name="XInt"></a><font color=Blue><i>-- </i></font>
<a name="line-141"></a><a name="XInt"></a><font color=Blue><i>-- The form ('XInt_indet' /n/ /id/) is permitted as a special case, to</i></font>
<a name="line-142"></a><a name="XInt"></a><font color=Blue><i>-- represent an integer of indeterminate length. Such a value can only</i></font>
<a name="line-143"></a><a name="XInt"></a><font color=Blue><i>-- be used when the length is deducible from the context. This form is</i></font>
<a name="line-144"></a><a name="XInt"></a><font color=Blue><i>-- only allowed in the special case /x/ = 'Bool', and we use an</i></font>
<a name="line-145"></a><a name="XInt"></a><font color=Blue><i>-- identity type to enforce this.</i></font>
<a name="line-146"></a><a name="XInt"></a><font color=Blue><i>-- </i></font>
<a name="line-147"></a><a name="XInt"></a><font color=Blue><i>-- Integers of indeterminate length may only be used in certain</i></font>
<a name="line-148"></a><a name="XInt"></a><font color=Blue><i>-- operations where the shape information is available from other</i></font>
<a name="line-149"></a><a name="XInt"></a><font color=Blue><i>-- data. It can be used, for example, for terminating or controlling a</i></font>
<a name="line-150"></a><a name="XInt"></a><font color=Blue><i>-- 'QDInt', but not for initializing a 'QDInt'.</i></font>
<a name="line-151"></a><a name="XInt"></a><font color=Green><u>data</u></font> XInt x <font color=Red>=</font> XInt <font color=Red>[</font>x<font color=Red>]</font> <font color=Red>|</font> XInt_indet Integer <font color=Cyan>(</font>Identity Bool x<font color=Cyan>)</font>
<a name="line-152"></a>  <font color=Green><u>deriving</u></font> <font color=Cyan>(</font>Show<font color=Cyan>,</font> Typeable<font color=Cyan>)</font>
<a name="line-153"></a>
<a name="line-154"></a><a name="QDInt"></a><font color=Blue><i>-- | The type of fixed-length /m/-qubit quantum integers. This is a</i></font>
<a name="line-155"></a><a name="QDInt"></a><font color=Blue><i>-- circuit execution time value.</i></font>
<a name="line-156"></a><a name="QDInt"></a><font color=Green><u>type</u></font> QDInt <font color=Red>=</font> XInt Qubit
<a name="line-157"></a>
<a name="line-158"></a><a name="instance%20Show%20QDInt"></a><font color=Green><u>instance</u></font> Show QDInt <font color=Green><u>where</u></font>
<a name="line-159"></a>  show <font color=Cyan>(</font>XInt l<font color=Cyan>)</font> <font color=Red>=</font> <font color=Magenta>"#"</font> <font color=Cyan>++</font> show l
<a name="line-160"></a>  show <font color=Cyan>(</font>XInt_indet n id<font color=Cyan>)</font> <font color=Red>=</font> error <font color=Magenta>"IntM: internal error"</font>
<a name="line-161"></a>
<a name="line-162"></a><font color=Blue><i>-- A better implementation might be something like:</i></font>
<a name="line-163"></a><font color=Blue><i>--   show (XInt l) = "qdint_of_qulist_bh " ++ show l</i></font>
<a name="line-164"></a><font color=Blue><i>-- However, as 'CInt' and 'QDInt' are currently synonyms, it seems best</i></font>
<a name="line-165"></a><font color=Blue><i>-- to keep the instance agnostic between them, while still distinguishing</i></font>
<a name="line-166"></a><font color=Blue><i>-- them somehow from naked lists.</i></font>
<a name="line-167"></a>
<a name="line-168"></a><a name="CInt"></a><font color=Blue><i>-- | The type of fixed-length /m/-bit classical integer inputs. This</i></font>
<a name="line-169"></a><a name="CInt"></a><font color=Blue><i>-- is a circuit execution time value.</i></font>
<a name="line-170"></a><a name="CInt"></a><font color=Green><u>type</u></font> CInt <font color=Red>=</font> XInt Bit
<a name="line-171"></a>
<a name="line-172"></a><font color=Blue><i>-- Currently, 'CInt' is literally a synonym of 'QDInt', since 'Qubit' is</i></font>
<a name="line-173"></a><font color=Blue><i>-- a synonym of 'Bit'.  If this changes, the following instance will be</i></font>
<a name="line-174"></a><font color=Blue><i>-- required:</i></font>
<a name="line-175"></a><font color=Blue><i>--</i></font>
<a name="line-176"></a><font color=Blue><i>-- instance Show CInt where</i></font>
<a name="line-177"></a><font color=Blue><i>--   show (XInt l) = show l</i></font>
<a name="line-178"></a><font color=Blue><i>--   show (XInt_indet n id) = error "IntM: internal error"</i></font>
<a name="line-179"></a>
<a name="line-180"></a><a name="IntM"></a><font color=Blue><i>-- | The type of fixed-length /m/-bit integer parameters.  Values of</i></font>
<a name="line-181"></a><a name="IntM"></a><font color=Blue><i>-- this type are parameters, i.e., they are classical and known at</i></font>
<a name="line-182"></a><a name="IntM"></a><font color=Blue><i>-- circuit generation time.</i></font>
<a name="line-183"></a><a name="IntM"></a><font color=Blue><i>-- </i></font>
<a name="line-184"></a><a name="IntM"></a><font color=Blue><i>-- Unlike values of type 'QDInt' and 'CInt', a value of type 'IntM'</i></font>
<a name="line-185"></a><a name="IntM"></a><font color=Blue><i>-- may have an indeterminate length. This happens, for example, if the</i></font>
<a name="line-186"></a><a name="IntM"></a><font color=Blue><i>-- value is specified by means of an integer literal (e.g., 17), which</i></font>
<a name="line-187"></a><a name="IntM"></a><font color=Blue><i>-- does not carry length information. In such cases, the value can</i></font>
<a name="line-188"></a><a name="IntM"></a><font color=Blue><i>-- only be used when it can be deduced from the context. For example,</i></font>
<a name="line-189"></a><a name="IntM"></a><font color=Blue><i>-- such values may be used for terminating or controlling a 'QDInt',</i></font>
<a name="line-190"></a><a name="IntM"></a><font color=Blue><i>-- but not for initializing a 'QDInt'.</i></font>
<a name="line-191"></a><a name="IntM"></a><font color=Green><u>type</u></font> IntM <font color=Red>=</font> XInt Bool
<a name="line-192"></a>
<a name="line-193"></a><a name="instance%20Show%20IntM"></a><font color=Green><u>instance</u></font> Show IntM <font color=Green><u>where</u></font>
<a name="line-194"></a>  show <font color=Cyan>(</font>XInt l<font color=Cyan>)</font> <font color=Red>=</font> <font color=Magenta>"intm "</font> <font color=Cyan>++</font> show <font color=Cyan>(</font>length l<font color=Cyan>)</font> <font color=Cyan>++</font> <font color=Magenta>" "</font> <font color=Cyan>++</font> show <font color=Cyan>(</font>int_of_boollist_signed_bh l<font color=Cyan>)</font>
<a name="line-195"></a>  show <font color=Cyan>(</font>XInt_indet n id<font color=Cyan>)</font> <font color=Red>=</font> show n
<a name="line-196"></a>
<a name="line-197"></a><font color=Blue><i>-- Note: for the purpose of forming intervals, we regard 'IntM' as an</i></font>
<a name="line-198"></a><font color=Blue><i>-- /unsigned/ type.  This disagrees with the 'Enum' instance, where</i></font>
<a name="line-199"></a><font color=Blue><i>-- 'IntM' is regarded as a /signed/ type. So for example, when /x/ =</i></font>
<a name="line-200"></a><font color=Blue><i>-- 'intm' 4 (-2) = 'intm' 4 14 and /y/ = 'intm' 4 10, then [/x/../y/]</i></font>
<a name="line-201"></a><font color=Blue><i>-- and 'interval' /y/ /x/ are non-empty, but [/y/../x/] and 'interval'</i></font>
<a name="line-202"></a><font color=Blue><i>-- /x/ /y/ are empty. </i></font>
<a name="line-203"></a><font color=Blue><i>-- </i></font>
<a name="line-204"></a><font color=Blue><i>-- This is confusing but for the time being there is no better</i></font>
<a name="line-205"></a><font color=Blue><i>-- alternative, unless we create distinct signed and unsigned types.</i></font>
<a name="line-206"></a>
<a name="line-207"></a><a name="instance%20Interval%20IntM"></a><font color=Green><u>instance</u></font> Interval IntM <font color=Green><u>where</u></font>
<a name="line-208"></a>  interval x y <font color=Red>=</font> intm_interval_unsigned x y
<a name="line-209"></a>
<a name="line-210"></a><a name="instance%20Zero%20IntM"></a><font color=Green><u>instance</u></font> Zero IntM <font color=Green><u>where</u></font>
<a name="line-211"></a>  zero x <font color=Red>=</font> intm_with_length <font color=Cyan>(</font>intm_length x<font color=Cyan>)</font> <font color=Magenta>0</font>
<a name="line-212"></a>  
<a name="line-213"></a><font color=Blue><i>-- ----------------------------------------------------------------------</i></font>
<a name="line-214"></a><font color=Blue><i>-- ** Primitive combinators on XInt</i></font>
<a name="line-215"></a>
<a name="line-216"></a><font color=Blue><i>-- $ 'XInt' is intended to be an abstract data type, and all access to</i></font>
<a name="line-217"></a><font color=Blue><i>-- it should pass through the three access functions of this</i></font>
<a name="line-218"></a><font color=Blue><i>-- section.</i></font>
<a name="line-219"></a>
<a name="line-220"></a><font color=Blue><i>-- *** Constructors</i></font>
<a name="line-221"></a>
<a name="line-222"></a><a name="xint_of_list_bh"></a><font color=Blue><i>-- | Create a 'XInt' /x/ from a list of /x/s. The conversion is</i></font>
<a name="line-223"></a><font color=Blue><i>-- big-headian, i.e., the head of the list holds the most significant</i></font>
<a name="line-224"></a><font color=Blue><i>-- digit.</i></font>
<a name="line-225"></a><font color=Blue>xint_of_list_bh</font> <font color=Red>::</font> <font color=Red>[</font>x<font color=Red>]</font> <font color=Red>-&gt;</font> XInt x
<a name="line-226"></a><font color=Blue>xint_of_list_bh</font> xs <font color=Red>=</font> XInt xs
<a name="line-227"></a>
<a name="line-228"></a><a name="intm_of_integer"></a><font color=Blue><i>-- | Create an 'IntM' of indeterminate length from an 'Integer'. </i></font>
<a name="line-229"></a><font color=Blue>intm_of_integer</font> <font color=Red>::</font> Integer <font color=Red>-&gt;</font> IntM
<a name="line-230"></a><font color=Blue>intm_of_integer</font> n <font color=Red>=</font> XInt_indet n reflexivity
<a name="line-231"></a>
<a name="line-232"></a><font color=Blue><i>-- *** Destructor</i></font>
<a name="line-233"></a>
<a name="line-234"></a><a name="xint_case"></a><font color=Blue><i>-- | If the 'XInt' is of determinate length, return its list of digits</i></font>
<a name="line-235"></a><font color=Blue><i>-- as a big-headian list, i.e., the head of the list holds the most</i></font>
<a name="line-236"></a><font color=Blue><i>-- significant digit. If the 'XInt' is of indeterminate length, return</i></font>
<a name="line-237"></a><font color=Blue><i>-- (/n/, /id/), where /n/ is the underlying 'Integer' and /id/ is the</i></font>
<a name="line-238"></a><font color=Blue><i>-- witness proving that /x/ = 'Bool'.</i></font>
<a name="line-239"></a><font color=Blue><i>-- </i></font>
<a name="line-240"></a><font color=Blue><i>-- This is a lowest-level access function not intended to be used by</i></font>
<a name="line-241"></a><font color=Blue><i>-- user-level code.</i></font>
<a name="line-242"></a><font color=Blue>xint_case</font> <font color=Red>::</font> XInt x <font color=Red>-&gt;</font> Either <font color=Red>[</font>x<font color=Red>]</font> <font color=Cyan>(</font>Integer<font color=Cyan>,</font> Identity Bool x<font color=Cyan>)</font>
<a name="line-243"></a><font color=Blue>xint_case</font> <font color=Cyan>(</font>XInt xs<font color=Cyan>)</font> <font color=Red>=</font> Left xs
<a name="line-244"></a><font color=Blue>xint_case</font> <font color=Cyan>(</font>XInt_indet n id<font color=Cyan>)</font> <font color=Red>=</font> Right <font color=Cyan>(</font>n<font color=Cyan>,</font> id<font color=Cyan>)</font>
<a name="line-245"></a>
<a name="line-246"></a><font color=Blue><i>-- ----------------------------------------------------------------------</i></font>
<a name="line-247"></a><font color=Blue><i>-- ** Other low-level operations</i></font>
<a name="line-248"></a>
<a name="line-249"></a><font color=Blue><i>-- $ The operations in this section are the only ones intended to use</i></font>
<a name="line-250"></a><font color=Blue><i>-- 'xint_case' directly.</i></font>
<a name="line-251"></a>
<a name="line-252"></a><a name="xint_set_length"></a><font color=Blue><i>-- | Set the length of an 'XInt' to /m/ &#8805; 0. This operation is only</i></font>
<a name="line-253"></a><font color=Blue><i>-- legal if the input (a) has indeterminate length or (b) has</i></font>
<a name="line-254"></a><font color=Blue><i>-- determinate length already equal to /m/. In particular, it cannot</i></font>
<a name="line-255"></a><font color=Blue><i>-- be used to change the length from anything other than from</i></font>
<a name="line-256"></a><font color=Blue><i>-- indeterminate to determinate.</i></font>
<a name="line-257"></a><font color=Blue><i>-- </i></font>
<a name="line-258"></a><font color=Blue><i>-- If both arguments already have determinate lengths, and they do not</i></font>
<a name="line-259"></a><font color=Blue><i>-- coincide, throw an error. The 'String' argument is used as an error</i></font>
<a name="line-260"></a><font color=Blue><i>-- message in that case.</i></font>
<a name="line-261"></a><font color=Blue><i>-- </i></font>
<a name="line-262"></a><font color=Blue><i>-- Note that if /x/ &#8800; 'Bool', the input is guaranteed to have</i></font>
<a name="line-263"></a><font color=Blue><i>-- determinate length. However, we cannot test for equality of types</i></font>
<a name="line-264"></a><font color=Blue><i>-- in a polymorphic function. This is where the 'id' argument to</i></font>
<a name="line-265"></a><font color=Blue><i>-- 'XInt_indet' is used.</i></font>
<a name="line-266"></a><font color=Blue>xint_set_length</font> <font color=Red>::</font> Int <font color=Red>-&gt;</font> XInt x <font color=Red>-&gt;</font> String <font color=Red>-&gt;</font> XInt x
<a name="line-267"></a><font color=Blue>xint_set_length</font> m x errmsg <font color=Red>|</font> m <font color=Cyan>&lt;</font> <font color=Magenta>0</font> <font color=Red>=</font> 
<a name="line-268"></a>  error <font color=Magenta>"xint_set_length: negative length not permitted"</font>  
<a name="line-269"></a><font color=Blue>xint_set_length</font> m x errmsg <font color=Red>=</font>
<a name="line-270"></a>  <font color=Green><u>case</u></font> xint_case x <font color=Green><u>of</u></font>
<a name="line-271"></a>    Left xs <font color=Red>|</font> m <font color=Cyan>==</font> length xs <font color=Red>-&gt;</font> x
<a name="line-272"></a>            <font color=Red>|</font> otherwise <font color=Red>-&gt;</font> error errmsg
<a name="line-273"></a>    Right <font color=Cyan>(</font>n<font color=Cyan>,</font> id<font color=Cyan>)</font> <font color=Red>-&gt;</font> XInt xs <font color=Green><u>where</u></font>
<a name="line-274"></a>      xs <font color=Red>=</font> <font color=Red>[</font> identity id b <font color=Red>|</font> b <font color=Red>&lt;-</font> boollist_of_int_bh m n <font color=Red>]</font>
<a name="line-275"></a>
<a name="line-276"></a><a name="xint_is_determinate"></a><font color=Blue><i>-- | Return 'True' if the 'XInt' is of determinate length, and 'False'</i></font>
<a name="line-277"></a><font color=Blue><i>-- if it is of indeterminate length. </i></font>
<a name="line-278"></a><font color=Blue>xint_is_determinate</font> <font color=Red>::</font> XInt x <font color=Red>-&gt;</font> Bool
<a name="line-279"></a><font color=Blue>xint_is_determinate</font> x <font color=Red>=</font> 
<a name="line-280"></a>  <font color=Green><u>case</u></font> xint_case x <font color=Green><u>of</u></font>
<a name="line-281"></a>    Left <font color=Green><u>_</u></font> <font color=Red>-&gt;</font> True
<a name="line-282"></a>    Right <font color=Green><u>_</u></font> <font color=Red>-&gt;</font> False
<a name="line-283"></a>
<a name="line-284"></a><a name="list_of_xint_bh"></a><font color=Blue><i>-- | From a 'XInt', which must be of determinate length, extract a</i></font>
<a name="line-285"></a><font color=Blue><i>-- list of /x/s. The conversion is big-headian, i.e., the head of the</i></font>
<a name="line-286"></a><font color=Blue><i>-- list holds the most significant digit. It is an error to call this</i></font>
<a name="line-287"></a><font color=Blue><i>-- function with an 'XInt' of indeterminate length.</i></font>
<a name="line-288"></a><font color=Blue>list_of_xint_bh</font> <font color=Red>::</font> XInt x <font color=Red>-&gt;</font> <font color=Red>[</font>x<font color=Red>]</font>
<a name="line-289"></a><font color=Blue>list_of_xint_bh</font> x <font color=Red>=</font> 
<a name="line-290"></a>  <font color=Green><u>case</u></font> xint_case x <font color=Green><u>of</u></font>
<a name="line-291"></a>    Left xs <font color=Red>-&gt;</font> xs
<a name="line-292"></a>    Right <font color=Green><u>_</u></font> <font color=Red>-&gt;</font> error <font color=Magenta>"list_of_xint_bh: integer has indeterminate length"</font>
<a name="line-293"></a>
<a name="line-294"></a><a name="xint_maybe_length"></a><font color=Blue><i>-- | Return the size of a 'XInt', or 'Nothing' if indeterminate.</i></font>
<a name="line-295"></a><font color=Blue>xint_maybe_length</font> <font color=Red>::</font> XInt x <font color=Red>-&gt;</font> Maybe Int
<a name="line-296"></a><font color=Blue>xint_maybe_length</font> x <font color=Red>=</font>
<a name="line-297"></a>  <font color=Green><u>case</u></font> xint_case x <font color=Green><u>of</u></font>
<a name="line-298"></a>    Left xs <font color=Red>-&gt;</font> Just <font color=Cyan>(</font>length xs<font color=Cyan>)</font>
<a name="line-299"></a>    Right <font color=Green><u>_</u></font> <font color=Red>-&gt;</font> Nothing
<a name="line-300"></a>
<a name="line-301"></a><a name="integer_of_intm_unsigned"></a><font color=Blue><i>-- | Convert an 'IntM' of length /m/ to an 'Integer' in the range {0,</i></font>
<a name="line-302"></a><font color=Blue><i>-- &#8230;, 2[sup /m/]-1}. If the 'IntM' has indeterminate length, return the</i></font>
<a name="line-303"></a><font color=Blue><i>-- original 'Integer'.</i></font>
<a name="line-304"></a><font color=Blue>integer_of_intm_unsigned</font> <font color=Red>::</font> IntM <font color=Red>-&gt;</font> Integer
<a name="line-305"></a><font color=Blue>integer_of_intm_unsigned</font> x <font color=Red>=</font> 
<a name="line-306"></a>  <font color=Green><u>case</u></font> xint_case x <font color=Green><u>of</u></font>
<a name="line-307"></a>    Left xs <font color=Red>-&gt;</font> int_of_boollist_unsigned_bh xs
<a name="line-308"></a>    Right <font color=Cyan>(</font>n<font color=Cyan>,</font> id<font color=Cyan>)</font> <font color=Red>-&gt;</font> n
<a name="line-309"></a>
<a name="line-310"></a><a name="integer_of_intm_signed"></a><font color=Blue><i>-- | Convert an 'IntM' of length /m/ to an 'Integer' in the range</i></font>
<a name="line-311"></a><font color=Blue><i>-- {-2[sup /m/-1], &#8230;, 2[sup /m/-1]-1}. If the 'IntM' has indeterminate</i></font>
<a name="line-312"></a><font color=Blue><i>-- length, return the original 'Integer'.</i></font>
<a name="line-313"></a><font color=Blue>integer_of_intm_signed</font> <font color=Red>::</font> IntM <font color=Red>-&gt;</font> Integer
<a name="line-314"></a><font color=Blue>integer_of_intm_signed</font> x <font color=Red>=</font>
<a name="line-315"></a>  <font color=Green><u>case</u></font> xint_case x <font color=Green><u>of</u></font>
<a name="line-316"></a>    Left xs <font color=Red>-&gt;</font> int_of_boollist_signed_bh xs
<a name="line-317"></a>    Right <font color=Cyan>(</font>n<font color=Cyan>,</font> id<font color=Cyan>)</font> <font color=Red>-&gt;</font> n
<a name="line-318"></a>
<a name="line-319"></a><a name="xint_equals"></a><font color=Blue><i>-- | Equality test. If at least one argument has determinate length,</i></font>
<a name="line-320"></a><font color=Blue><i>-- test equality modulo 2[sup /m/]. If both have indeterminate length,</i></font>
<a name="line-321"></a><font color=Blue><i>-- check equality of the underlying integers.</i></font>
<a name="line-322"></a><font color=Blue>xint_equals</font> <font color=Red>::</font> <font color=Cyan>(</font>Eq x<font color=Cyan>)</font> <font color=Red>=&gt;</font> XInt x <font color=Red>-&gt;</font> XInt x <font color=Red>-&gt;</font> Bool    
<a name="line-323"></a><font color=Blue>xint_equals</font> x y <font color=Red>=</font>
<a name="line-324"></a>  <font color=Green><u>case</u></font> <font color=Cyan>(</font>xint_case x<font color=Cyan>,</font> xint_case y<font color=Cyan>)</font> <font color=Green><u>of</u></font>
<a name="line-325"></a>    <font color=Cyan>(</font>Left xs<font color=Cyan>,</font> Left ys<font color=Cyan>)</font> 
<a name="line-326"></a>      <font color=Red>|</font> length xs <font color=Cyan>==</font> length ys <font color=Red>-&gt;</font> xs <font color=Cyan>==</font> ys
<a name="line-327"></a>      <font color=Red>|</font> otherwise <font color=Red>-&gt;</font> error <font color=Magenta>"Equality test on XInt: operands must be of equal length"</font>
<a name="line-328"></a>    <font color=Cyan>(</font><font color=Green><u>_</u></font><font color=Cyan>,</font> Left ys<font color=Cyan>)</font> <font color=Red>-&gt;</font> xint_equals <font color=Cyan>(</font>xint_set_length m x <font color=Magenta>"xint_equals"</font><font color=Cyan>)</font> y
<a name="line-329"></a>        <font color=Green><u>where</u></font> m <font color=Red>=</font> length ys
<a name="line-330"></a>    <font color=Cyan>(</font>Left xs<font color=Cyan>,</font> <font color=Green><u>_</u></font><font color=Cyan>)</font> <font color=Red>-&gt;</font> xint_equals x <font color=Cyan>(</font>xint_set_length m y <font color=Magenta>"xint_equals"</font><font color=Cyan>)</font>
<a name="line-331"></a>        <font color=Green><u>where</u></font> m <font color=Red>=</font> length xs
<a name="line-332"></a>    <font color=Cyan>(</font>Right <font color=Cyan>(</font>n<font color=Cyan>,</font> <font color=Green><u>_</u></font><font color=Cyan>)</font><font color=Cyan>,</font> Right <font color=Cyan>(</font>n'<font color=Cyan>,</font> <font color=Green><u>_</u></font><font color=Cyan>)</font><font color=Cyan>)</font> <font color=Red>-&gt;</font> n <font color=Cyan>==</font> n'
<a name="line-333"></a>    
<a name="line-334"></a><font color=Blue><i>-- ----------------------------------------------------------------------</i></font>
<a name="line-335"></a><font color=Blue><i>-- ** Derived operations on XInt</i></font>
<a name="line-336"></a>
<a name="line-337"></a><a name="xint_length"></a><font color=Blue><i>-- | Get the nominal length of an integer (in bits). It is an error to</i></font>
<a name="line-338"></a><font color=Blue><i>-- apply this function to an integer of indeterminate length.</i></font>
<a name="line-339"></a><font color=Blue>xint_length</font> <font color=Red>::</font> XInt x <font color=Red>-&gt;</font> Int
<a name="line-340"></a><font color=Blue>xint_length</font> x <font color=Red>=</font> 
<a name="line-341"></a>  <font color=Green><u>case</u></font> xint_maybe_length x <font color=Green><u>of</u></font>
<a name="line-342"></a>    Just m <font color=Red>-&gt;</font> m
<a name="line-343"></a>    Nothing <font color=Red>-&gt;</font> error <font color=Magenta>"xint_length: integer has indeterminate length"</font>
<a name="line-344"></a>
<a name="line-345"></a><a name="list_of_xint_lh"></a><font color=Blue><i>-- | Convert an integer to a bit list. The conversion is</i></font>
<a name="line-346"></a><font color=Blue><i>-- little-headian, i.e., the head of the list holds the least</i></font>
<a name="line-347"></a><font color=Blue><i>-- significant digit.</i></font>
<a name="line-348"></a><font color=Blue>list_of_xint_lh</font> <font color=Red>::</font> XInt x <font color=Red>-&gt;</font> <font color=Red>[</font>x<font color=Red>]</font>
<a name="line-349"></a><font color=Blue>list_of_xint_lh</font> <font color=Red>=</font> reverse <font color=Cyan>.</font> list_of_xint_bh
<a name="line-350"></a>
<a name="line-351"></a><a name="xint_of_list_lh"></a><font color=Blue><i>-- | Convert a bit list to an integer. The conversion is</i></font>
<a name="line-352"></a><font color=Blue><i>-- little-headian, i.e., the head of the list holds the least</i></font>
<a name="line-353"></a><font color=Blue><i>-- significant digit.</i></font>
<a name="line-354"></a><font color=Blue>xint_of_list_lh</font> <font color=Red>::</font> <font color=Red>[</font>x<font color=Red>]</font> <font color=Red>-&gt;</font> XInt x
<a name="line-355"></a><font color=Blue>xint_of_list_lh</font> <font color=Red>=</font> xint_of_list_bh <font color=Cyan>.</font> reverse
<a name="line-356"></a>
<a name="line-357"></a><a name="xint_extend_unsigned"></a><font color=Blue><i>-- | Extend a 'XInt' to the given length without changing its</i></font>
<a name="line-358"></a><font color=Blue><i>-- (unsigned) value. This is done by adding the required number of</i></font>
<a name="line-359"></a><font color=Blue><i>-- high bits initialized to /zero/. It is an error to call this</i></font>
<a name="line-360"></a><font color=Blue><i>-- function when the new length is shorter than the old one.</i></font>
<a name="line-361"></a><font color=Blue>xint_extend_unsigned</font> <font color=Red>::</font> <font color=Cyan>(</font>Monad m<font color=Cyan>)</font> <font color=Red>=&gt;</font> Int <font color=Red>-&gt;</font> m x <font color=Red>-&gt;</font> XInt x <font color=Red>-&gt;</font> m <font color=Cyan>(</font>XInt x<font color=Cyan>)</font>
<a name="line-362"></a><font color=Blue>xint_extend_unsigned</font> len zero x 
<a name="line-363"></a>  <font color=Red>|</font> len <font color=Cyan>&lt;</font> m <font color=Red>=</font>
<a name="line-364"></a>    error <font color=Magenta>"pad_xint: requested length is shorter than current length"</font>
<a name="line-365"></a>  <font color=Red>|</font> otherwise <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-366"></a>    pad <font color=Red>&lt;-</font> sequence <font color=Cyan>(</font>replicate extra zero<font color=Cyan>)</font>
<a name="line-367"></a>    return <font color=Cyan>$</font> xint_of_list_bh <font color=Cyan>(</font>pad <font color=Cyan>++</font> digits<font color=Cyan>)</font>
<a name="line-368"></a>  <font color=Green><u>where</u></font>
<a name="line-369"></a>    digits <font color=Red>=</font> list_of_xint_bh x
<a name="line-370"></a>    m <font color=Red>=</font> length digits
<a name="line-371"></a>    extra <font color=Red>=</font> len <font color=Blue><i>-</i></font> m
<a name="line-372"></a>
<a name="line-373"></a><a name="xint_extend_signed"></a><font color=Blue><i>-- | Extend a 'XInt' to the given length without changing its (signed)</i></font>
<a name="line-374"></a><font color=Blue><i>-- value. This is done by adding the required number of high bits</i></font>
<a name="line-375"></a><font color=Blue><i>-- initialized to copies of the sign bit (or to /zero/ if the original</i></font>
<a name="line-376"></a><font color=Blue><i>-- integer was of length 0). It is an error to call this function when</i></font>
<a name="line-377"></a><font color=Blue><i>-- the new length is shorter than the old one.</i></font>
<a name="line-378"></a><font color=Blue>xint_extend_signed</font> <font color=Red>::</font> <font color=Cyan>(</font>Monad m<font color=Cyan>)</font> <font color=Red>=&gt;</font> Int <font color=Red>-&gt;</font> m x <font color=Red>-&gt;</font> <font color=Cyan>(</font>x <font color=Red>-&gt;</font> m x<font color=Cyan>)</font> <font color=Red>-&gt;</font> XInt x <font color=Red>-&gt;</font> m <font color=Cyan>(</font>XInt x<font color=Cyan>)</font>
<a name="line-379"></a><font color=Blue>xint_extend_signed</font> len zero copy x
<a name="line-380"></a>  <font color=Red>|</font> len <font color=Cyan>&lt;</font> m 
<a name="line-381"></a>    <font color=Red>=</font> error <font color=Magenta>"pad_xint: requested length is shorter than current length"</font>
<a name="line-382"></a>  <font color=Red>|</font> m <font color=Cyan>==</font> <font color=Magenta>0</font>
<a name="line-383"></a>    <font color=Red>=</font> xint_extend_unsigned len zero x
<a name="line-384"></a>  <font color=Red>|</font> otherwise <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-385"></a>    pad <font color=Red>&lt;-</font> sequence <font color=Cyan>(</font>replicate extra <font color=Cyan>(</font>copy sign<font color=Cyan>)</font><font color=Cyan>)</font>
<a name="line-386"></a>    return <font color=Cyan>$</font> xint_of_list_bh <font color=Cyan>(</font>pad <font color=Cyan>++</font> digits<font color=Cyan>)</font>
<a name="line-387"></a>  <font color=Green><u>where</u></font>
<a name="line-388"></a>    digits <font color=Red>=</font> list_of_xint_bh x
<a name="line-389"></a>    m <font color=Red>=</font> length digits
<a name="line-390"></a>    extra <font color=Red>=</font> len <font color=Blue><i>-</i></font> m
<a name="line-391"></a>    sign <font color=Red>=</font> head digits
<a name="line-392"></a>
<a name="line-393"></a><font color=Blue><i>-- ----------------------------------------------------------------------</i></font>
<a name="line-394"></a><font color=Blue><i>-- ** Operations on IntM</i></font>
<a name="line-395"></a>
<a name="line-396"></a><a name="intm_length"></a><font color=Blue><i>-- | Return the size of an 'IntM', or 'Nothing' if indeterminate.</i></font>
<a name="line-397"></a><font color=Blue>intm_length</font> <font color=Red>::</font> IntM <font color=Red>-&gt;</font> Maybe Int
<a name="line-398"></a><font color=Blue>intm_length</font> <font color=Red>=</font> xint_maybe_length
<a name="line-399"></a>  
<a name="line-400"></a><a name="boollist_of_intm_bh"></a><font color=Blue><i>-- | Convert an 'IntM' to a list of booleans. The conversion is</i></font>
<a name="line-401"></a><font color=Blue><i>-- big-headian, i.e., the head of the list holds the most significant</i></font>
<a name="line-402"></a><font color=Blue><i>-- digit. As usual, 'False' is 0 and 'True' is 1. It is an error to</i></font>
<a name="line-403"></a><font color=Blue><i>-- apply this operation to an 'IntM' whose length is indeterminate.</i></font>
<a name="line-404"></a><font color=Blue>boollist_of_intm_bh</font> <font color=Red>::</font> IntM <font color=Red>-&gt;</font> <font color=Red>[</font>Bool<font color=Red>]</font>
<a name="line-405"></a><font color=Blue>boollist_of_intm_bh</font> <font color=Red>=</font> list_of_xint_bh
<a name="line-406"></a>
<a name="line-407"></a><a name="intm_of_boollist_bh"></a><font color=Blue><i>-- | Convert a boolean list to an 'IntM'. The conversion is</i></font>
<a name="line-408"></a><font color=Blue><i>-- big-headian, i.e., the head of the list holds the most significant</i></font>
<a name="line-409"></a><font color=Blue><i>-- digit.</i></font>
<a name="line-410"></a><font color=Blue>intm_of_boollist_bh</font> <font color=Red>::</font> <font color=Red>[</font>Bool<font color=Red>]</font> <font color=Red>-&gt;</font> IntM
<a name="line-411"></a><font color=Blue>intm_of_boollist_bh</font> <font color=Red>=</font> xint_of_list_bh
<a name="line-412"></a>
<a name="line-413"></a><a name="intm"></a><font color=Blue><i>-- | Create an 'IntM' of the specified length (first argument) and</i></font>
<a name="line-414"></a><font color=Blue><i>-- value (second argument).</i></font>
<a name="line-415"></a><font color=Blue>intm</font> <font color=Red>::</font> Int <font color=Red>-&gt;</font> Integer <font color=Red>-&gt;</font> IntM
<a name="line-416"></a><font color=Blue>intm</font> m n <font color=Red>=</font> intm_set_length m <font color=Cyan>(</font>intm_of_integer n<font color=Cyan>)</font> <font color=Magenta>"intm: internal error"</font>
<a name="line-417"></a>
<a name="line-418"></a><a name="intm_set_length"></a><font color=Blue><i>-- | Set the length of an 'IntM' to /m/ &#8805; 0. This operation is only</i></font>
<a name="line-419"></a><font color=Blue><i>-- legal if the input (a) has indeterminate length or (b) has</i></font>
<a name="line-420"></a><font color=Blue><i>-- determinate length already equal to /m/. In particular, it cannot</i></font>
<a name="line-421"></a><font color=Blue><i>-- be used to change the length from anything other than from</i></font>
<a name="line-422"></a><font color=Blue><i>-- indeterminate to determinate. (Use 'intm_extend_unsigned' or</i></font>
<a name="line-423"></a><font color=Blue><i>-- 'intm_extend_signed' to increase a determinate length).</i></font>
<a name="line-424"></a><font color=Blue><i>-- </i></font>
<a name="line-425"></a><font color=Blue><i>-- If both arguments already have determinate lengths, and they do not</i></font>
<a name="line-426"></a><font color=Blue><i>-- coincide, throw an error. The 'String' argument is used as an error</i></font>
<a name="line-427"></a><font color=Blue><i>-- message in that case.</i></font>
<a name="line-428"></a><font color=Blue>intm_set_length</font> <font color=Red>::</font> Int <font color=Red>-&gt;</font> IntM <font color=Red>-&gt;</font> String <font color=Red>-&gt;</font> IntM
<a name="line-429"></a><font color=Blue>intm_set_length</font> <font color=Red>=</font> xint_set_length
<a name="line-430"></a>
<a name="line-431"></a><a name="intm_extend_unsigned"></a><font color=Blue><i>-- | Extend an 'IntM' to the given length without changing its</i></font>
<a name="line-432"></a><font color=Blue><i>-- (unsigned) value. This is done by adding the required number of</i></font>
<a name="line-433"></a><font color=Blue><i>-- high bits initialized to 0. It is an error to call this function</i></font>
<a name="line-434"></a><font color=Blue><i>-- when the new length is shorter than the old one.</i></font>
<a name="line-435"></a><font color=Blue>intm_extend_unsigned</font> <font color=Red>::</font> Int <font color=Red>-&gt;</font> IntM <font color=Red>-&gt;</font> IntM
<a name="line-436"></a><font color=Blue>intm_extend_unsigned</font> len x <font color=Red>=</font>
<a name="line-437"></a>  getId <font color=Cyan>$</font> xint_extend_unsigned len <font color=Cyan>(</font>return False<font color=Cyan>)</font> x
<a name="line-438"></a>
<a name="line-439"></a><a name="intm_extend_signed"></a><font color=Blue><i>-- | Extend an 'IntM' to the given length without changing its</i></font>
<a name="line-440"></a><font color=Blue><i>-- (signed) value. This is done by adding the required number of</i></font>
<a name="line-441"></a><font color=Blue><i>-- high bits initialized to copies of the sign bit. It is an error to</i></font>
<a name="line-442"></a><font color=Blue><i>-- call this function when the new length is shorter than the old one.</i></font>
<a name="line-443"></a><font color=Blue>intm_extend_signed</font> <font color=Red>::</font> Int <font color=Red>-&gt;</font> IntM <font color=Red>-&gt;</font> IntM
<a name="line-444"></a><font color=Blue>intm_extend_signed</font> len x <font color=Red>=</font>
<a name="line-445"></a>  getId <font color=Cyan>$</font> xint_extend_signed len <font color=Cyan>(</font>return False<font color=Cyan>)</font> <font color=Cyan>(</font>return<font color=Cyan>)</font> x
<a name="line-446"></a>
<a name="line-447"></a><font color=Blue><i>-- ----------------------------------------------------------------------</i></font>
<a name="line-448"></a><font color=Blue><i>-- ** Operations on CInt</i></font>
<a name="line-449"></a>
<a name="line-450"></a><a name="bitlist_of_cint_bh"></a><font color=Blue><i>-- | Convert a 'CInt' to a list of qubits. The conversion is</i></font>
<a name="line-451"></a><font color=Blue><i>-- big-headian, i.e., the head of the list holds the most significant</i></font>
<a name="line-452"></a><font color=Blue><i>-- digit.</i></font>
<a name="line-453"></a><font color=Blue>bitlist_of_cint_bh</font> <font color=Red>::</font> CInt <font color=Red>-&gt;</font> <font color=Red>[</font>Bit<font color=Red>]</font>
<a name="line-454"></a><font color=Blue>bitlist_of_cint_bh</font> <font color=Red>=</font> list_of_xint_bh
<a name="line-455"></a>
<a name="line-456"></a><a name="cint_of_bitlist_bh"></a><font color=Blue><i>-- | Convert a list of qubits to a 'CInt'. The conversion is</i></font>
<a name="line-457"></a><font color=Blue><i>-- big-headian, i.e., the head of the list holds the most significant</i></font>
<a name="line-458"></a><font color=Blue><i>-- digit.</i></font>
<a name="line-459"></a><font color=Blue>cint_of_bitlist_bh</font> <font color=Red>::</font> <font color=Red>[</font>Bit<font color=Red>]</font> <font color=Red>-&gt;</font> CInt
<a name="line-460"></a><font color=Blue>cint_of_bitlist_bh</font> <font color=Red>=</font> xint_of_list_bh
<a name="line-461"></a>
<a name="line-462"></a><a name="bitlist_of_cint_lh"></a><font color=Blue><i>-- | Convert a 'CInt' to a list of bits. The conversion is</i></font>
<a name="line-463"></a><font color=Blue><i>-- little-headian, i.e., the head of the list holds the least</i></font>
<a name="line-464"></a><font color=Blue><i>-- significant digit.</i></font>
<a name="line-465"></a><font color=Blue>bitlist_of_cint_lh</font> <font color=Red>::</font> CInt <font color=Red>-&gt;</font> <font color=Red>[</font>Bit<font color=Red>]</font>
<a name="line-466"></a><font color=Blue>bitlist_of_cint_lh</font> <font color=Red>=</font> list_of_xint_lh
<a name="line-467"></a>
<a name="line-468"></a><a name="cint_of_bitlist_lh"></a><font color=Blue><i>-- | Convert a list of bits to a 'CInt'. The conversion is</i></font>
<a name="line-469"></a><font color=Blue><i>-- little-headian, i.e., the head of the list holds the least significant</i></font>
<a name="line-470"></a><font color=Blue><i>-- digit.</i></font>
<a name="line-471"></a><font color=Blue>cint_of_bitlist_lh</font> <font color=Red>::</font> <font color=Red>[</font>Bit<font color=Red>]</font> <font color=Red>-&gt;</font> CInt
<a name="line-472"></a><font color=Blue>cint_of_bitlist_lh</font> <font color=Red>=</font> xint_of_list_lh
<a name="line-473"></a>
<a name="line-474"></a><a name="cint_length"></a><font color=Blue><i>-- | Return the length of a 'CInt', in bits.</i></font>
<a name="line-475"></a><font color=Blue>cint_length</font> <font color=Red>::</font> CInt <font color=Red>-&gt;</font> Int
<a name="line-476"></a><font color=Blue>cint_length</font> <font color=Red>=</font> xint_length
<a name="line-477"></a>
<a name="line-478"></a><a name="cint_extend_unsigned"></a><font color=Blue><i>-- | Extend a 'CInt' to the given length without changing its</i></font>
<a name="line-479"></a><font color=Blue><i>-- (unsigned) value. This is done by adding the required number of</i></font>
<a name="line-480"></a><font color=Blue><i>-- high bits initialized to 0. It is an error to call this function</i></font>
<a name="line-481"></a><font color=Blue><i>-- when the new length is shorter than the old one.</i></font>
<a name="line-482"></a><font color=Blue>cint_extend_unsigned</font> <font color=Red>::</font> Int <font color=Red>-&gt;</font> CInt <font color=Red>-&gt;</font> Circ CInt
<a name="line-483"></a><font color=Blue>cint_extend_unsigned</font> len x <font color=Red>=</font>
<a name="line-484"></a>  xint_extend_unsigned len <font color=Cyan>(</font>cinit False<font color=Cyan>)</font> x
<a name="line-485"></a>
<a name="line-486"></a><a name="cint_extend_signed"></a><font color=Blue><i>-- | Extend a 'CInt' to the given length without changing its</i></font>
<a name="line-487"></a><font color=Blue><i>-- (signed) value. This is done by adding the required number of</i></font>
<a name="line-488"></a><font color=Blue><i>-- high bits initialized to copies of the sign bit. It is an error to</i></font>
<a name="line-489"></a><font color=Blue><i>-- call this function when the new length is shorter than the old one.</i></font>
<a name="line-490"></a><font color=Blue>cint_extend_signed</font> <font color=Red>::</font> Int <font color=Red>-&gt;</font> CInt <font color=Red>-&gt;</font> Circ CInt
<a name="line-491"></a><font color=Blue>cint_extend_signed</font> len x <font color=Red>=</font>
<a name="line-492"></a>  xint_extend_signed len <font color=Cyan>(</font>cinit False<font color=Cyan>)</font> <font color=Cyan>(</font>qc_copy<font color=Cyan>)</font> x
<a name="line-493"></a>
<a name="line-494"></a><font color=Blue><i>-- ----------------------------------------------------------------------</i></font>
<a name="line-495"></a><font color=Blue><i>-- ** Operations on QDInt</i></font>
<a name="line-496"></a>
<a name="line-497"></a><a name="qulist_of_qdint_bh"></a><font color=Blue><i>-- | Convert a 'QDInt' to a list of qubits. The conversion is</i></font>
<a name="line-498"></a><font color=Blue><i>-- big-headian, i.e., the head of the list holds the most significant</i></font>
<a name="line-499"></a><font color=Blue><i>-- digit.</i></font>
<a name="line-500"></a><font color=Blue>qulist_of_qdint_bh</font> <font color=Red>::</font> QDInt <font color=Red>-&gt;</font> <font color=Red>[</font>Qubit<font color=Red>]</font>
<a name="line-501"></a><font color=Blue>qulist_of_qdint_bh</font> <font color=Red>=</font> list_of_xint_bh
<a name="line-502"></a>
<a name="line-503"></a><a name="qdint_of_qulist_bh"></a><font color=Blue><i>-- | Convert a list of qubits to a 'QDInt'. The conversion is</i></font>
<a name="line-504"></a><font color=Blue><i>-- big-headian, i.e., the head of the list holds the most significant</i></font>
<a name="line-505"></a><font color=Blue><i>-- digit.</i></font>
<a name="line-506"></a><font color=Blue>qdint_of_qulist_bh</font> <font color=Red>::</font> <font color=Red>[</font>Qubit<font color=Red>]</font> <font color=Red>-&gt;</font> QDInt
<a name="line-507"></a><font color=Blue>qdint_of_qulist_bh</font> <font color=Red>=</font> xint_of_list_bh
<a name="line-508"></a>
<a name="line-509"></a><a name="qulist_of_qdint_lh"></a><font color=Blue><i>-- | Convert a 'QDInt' to a list of qubits. The conversion is</i></font>
<a name="line-510"></a><font color=Blue><i>-- little-headian, i.e., the head of the list holds the least significant</i></font>
<a name="line-511"></a><font color=Blue><i>-- digit.</i></font>
<a name="line-512"></a><font color=Blue>qulist_of_qdint_lh</font> <font color=Red>::</font> QDInt <font color=Red>-&gt;</font> <font color=Red>[</font>Qubit<font color=Red>]</font>
<a name="line-513"></a><font color=Blue>qulist_of_qdint_lh</font> <font color=Red>=</font> list_of_xint_lh
<a name="line-514"></a>
<a name="line-515"></a><a name="qdint_of_qulist_lh"></a><font color=Blue><i>-- | Convert a list of qubits to a 'QDInt'. The conversion is</i></font>
<a name="line-516"></a><font color=Blue><i>-- little-headian, i.e., the head of the list holds the least significant</i></font>
<a name="line-517"></a><font color=Blue><i>-- digit.</i></font>
<a name="line-518"></a><font color=Blue>qdint_of_qulist_lh</font> <font color=Red>::</font> <font color=Red>[</font>Qubit<font color=Red>]</font> <font color=Red>-&gt;</font> QDInt
<a name="line-519"></a><font color=Blue>qdint_of_qulist_lh</font> <font color=Red>=</font> xint_of_list_lh
<a name="line-520"></a>
<a name="line-521"></a><a name="qdint_length"></a><font color=Blue><i>-- | Return the length of a 'QDInt', in bits.</i></font>
<a name="line-522"></a><font color=Blue>qdint_length</font> <font color=Red>::</font> QDInt <font color=Red>-&gt;</font> Int
<a name="line-523"></a><font color=Blue>qdint_length</font> <font color=Red>=</font> xint_length
<a name="line-524"></a>
<a name="line-525"></a><a name="qdint_extend_unsigned"></a><font color=Blue><i>-- | Extend a 'QDInt' to the given length without changing its</i></font>
<a name="line-526"></a><font color=Blue><i>-- (unsigned) value. This is done by adding the required number of</i></font>
<a name="line-527"></a><font color=Blue><i>-- high bits initialized to 0. It is an error to call this function</i></font>
<a name="line-528"></a><font color=Blue><i>-- when the new length is shorter than the old one.</i></font>
<a name="line-529"></a><font color=Blue>qdint_extend_unsigned</font> <font color=Red>::</font> Int <font color=Red>-&gt;</font> QDInt <font color=Red>-&gt;</font> Circ QDInt
<a name="line-530"></a><font color=Blue>qdint_extend_unsigned</font> len x <font color=Red>=</font>
<a name="line-531"></a>  xint_extend_unsigned len <font color=Cyan>(</font>qinit False<font color=Cyan>)</font> x
<a name="line-532"></a>
<a name="line-533"></a><a name="qdint_extend_signed"></a><font color=Blue><i>-- | Extend a 'QDInt' to the given length without changing its</i></font>
<a name="line-534"></a><font color=Blue><i>-- (signed) value. This is done by adding the required number of</i></font>
<a name="line-535"></a><font color=Blue><i>-- high bits initialized to copies of the sign bit. It is an error to</i></font>
<a name="line-536"></a><font color=Blue><i>-- call this function when the new length is shorter than the old one.</i></font>
<a name="line-537"></a><font color=Blue>qdint_extend_signed</font> <font color=Red>::</font> Int <font color=Red>-&gt;</font> QDInt <font color=Red>-&gt;</font> Circ QDInt
<a name="line-538"></a><font color=Blue>qdint_extend_signed</font> len x <font color=Red>=</font>
<a name="line-539"></a>  xint_extend_signed len <font color=Cyan>(</font>qinit False<font color=Cyan>)</font> <font color=Cyan>(</font>qc_copy<font color=Cyan>)</font> x
<a name="line-540"></a>
<a name="line-541"></a><font color=Blue><i>-- ----------------------------------------------------------------------</i></font>
<a name="line-542"></a><font color=Blue><i>-- ** Shape parameters</i></font>
<a name="line-543"></a>
<a name="line-544"></a><a name="qdint_shape"></a><font color=Blue><i>-- | Return a piece of shape data to represent an /m/-qubit quantum</i></font>
<a name="line-545"></a><font color=Blue><i>-- integer. Please note that the data can only be used as shape; it</i></font>
<a name="line-546"></a><font color=Blue><i>-- will be undefined at the leaves.</i></font>
<a name="line-547"></a><font color=Blue>qdint_shape</font> <font color=Red>::</font> Int <font color=Red>-&gt;</font> QDInt
<a name="line-548"></a><font color=Blue>qdint_shape</font> m <font color=Red>=</font> xint_of_list_bh <font color=Cyan>(</font>replicate m qubit<font color=Cyan>)</font>
<a name="line-549"></a>
<a name="line-550"></a><a name="cint_shape"></a><font color=Blue><i>-- | Return a piece of shape data to represent an /m/-bit 'CInt'.</i></font>
<a name="line-551"></a><font color=Blue><i>-- Please note that the data can only be used as shape; it will be</i></font>
<a name="line-552"></a><font color=Blue><i>-- undefined at the leaves.</i></font>
<a name="line-553"></a><font color=Blue>cint_shape</font> <font color=Red>::</font> Int <font color=Red>-&gt;</font> CInt
<a name="line-554"></a><font color=Blue>cint_shape</font> m <font color=Red>=</font> xint_of_list_bh <font color=Cyan>(</font>replicate m bit<font color=Cyan>)</font>
<a name="line-555"></a>
<a name="line-556"></a><font color=Blue><i>-- ======================================================================</i></font>
<a name="line-557"></a><font color=Blue><i>-- ** Type class instances</i></font>
<a name="line-558"></a>
<a name="line-559"></a><font color=Blue><i>-- Note: instance declarations do not show up in the documentation</i></font>
<a name="line-560"></a>
<a name="line-561"></a><a name="combine_length"></a><font color=Blue><i>-- | Input the lengths of two inputs to a binary operation, and return</i></font>
<a name="line-562"></a><font color=Blue><i>-- the common length. If one length is indeterminate, return the other;</i></font>
<a name="line-563"></a><font color=Blue><i>-- if both are indeterminate, return 'Nothing'; if both are determinate but</i></font>
<a name="line-564"></a><font color=Blue><i>-- not equal, throw an error with the given error message.</i></font>
<a name="line-565"></a><font color=Blue>combine_length</font> <font color=Red>::</font> String <font color=Red>-&gt;</font> Maybe Int <font color=Red>-&gt;</font> Maybe Int <font color=Red>-&gt;</font> Maybe Int
<a name="line-566"></a><font color=Blue>combine_length</font> s Nothing m <font color=Red>=</font> m
<a name="line-567"></a><font color=Blue>combine_length</font> s m Nothing <font color=Red>=</font> m
<a name="line-568"></a><font color=Blue>combine_length</font> s <font color=Cyan>(</font>Just m<font color=Cyan>)</font> <font color=Cyan>(</font>Just m'<font color=Cyan>)</font> <font color=Red>|</font> m <font color=Cyan>==</font> m' <font color=Red>=</font> Just m
<a name="line-569"></a>                                    <font color=Red>|</font> otherwise <font color=Red>=</font> error s
<a name="line-570"></a>
<a name="line-571"></a><a name="intm_promote"></a><font color=Blue><i>-- | Try to set the length of an 'IntM' to that of another 'XInt'</i></font>
<a name="line-572"></a><font color=Blue><i>-- value (which could be a 'QDInt', a 'CInt', or another 'IntM'). This</i></font>
<a name="line-573"></a><font color=Blue><i>-- will fail with an error if both numbers already have determinate</i></font>
<a name="line-574"></a><font color=Blue><i>-- lengths that don't coincide. In this case, the string argument is</i></font>
<a name="line-575"></a><font color=Blue><i>-- used as an error message.</i></font>
<a name="line-576"></a><font color=Blue>intm_promote</font> <font color=Red>::</font> IntM <font color=Red>-&gt;</font> XInt x <font color=Red>-&gt;</font> String <font color=Red>-&gt;</font> IntM
<a name="line-577"></a><font color=Blue>intm_promote</font> bi xi errmsg <font color=Red>=</font> 
<a name="line-578"></a>  <font color=Green><u>case</u></font> xint_maybe_length xi <font color=Green><u>of</u></font>
<a name="line-579"></a>    Nothing <font color=Red>-&gt;</font> bi
<a name="line-580"></a>    Just m <font color=Red>-&gt;</font> intm_set_length m bi errmsg
<a name="line-581"></a>    
<a name="line-582"></a><font color=Green><u>type</u></font> <font color=Green><u>instance</u></font> QCType x y <font color=Cyan>(</font>XInt z<font color=Cyan>)</font> <font color=Red>=</font> XInt <font color=Cyan>(</font>QCType x y z<font color=Cyan>)</font>
<a name="line-583"></a><font color=Green><u>type</u></font> <font color=Green><u>instance</u></font> QTypeB IntM <font color=Red>=</font> QDInt
<a name="line-584"></a>
<a name="line-585"></a><a name="instance%20QCData%20(XInt%20x)"></a><font color=Green><u>instance</u></font> QCLeaf x <font color=Red>=&gt;</font> QCData <font color=Cyan>(</font>XInt x<font color=Cyan>)</font> <font color=Green><u>where</u></font>
<a name="line-586"></a>  qcdata_mapM shape f g xs <font color=Red>=</font> 
<a name="line-587"></a>    mmap xint_of_list_bh <font color=Cyan>$</font> qcdata_mapM <font color=Cyan>(</font>list_of_xint_bh shape<font color=Cyan>)</font> f g <font color=Cyan>(</font>list_of_xint_bh xs<font color=Cyan>)</font>
<a name="line-588"></a>  qcdata_zip shape q c q' c' xs ys e <font color=Red>=</font> 
<a name="line-589"></a>    xint_of_list_bh <font color=Cyan>$</font> qcdata_zip <font color=Cyan>(</font>list_of_xint_bh shape<font color=Cyan>)</font> q c q' c' <font color=Cyan>(</font>list_of_xint_bh xs<font color=Cyan>)</font> <font color=Cyan>(</font>list_of_xint_bh ys<font color=Cyan>)</font> <font color=Cyan>(</font>const <font color=Cyan>$</font> e <font color=Magenta>"XInt length mismatch"</font><font color=Cyan>)</font>
<a name="line-590"></a>  qcdata_promote b q e <font color=Red>=</font> intm_promote b q <font color=Cyan>(</font>e <font color=Magenta>"IntM length mismatch"</font><font color=Cyan>)</font>
<a name="line-591"></a>
<a name="line-592"></a><a name="instance%20Labelable%20(XInt%20x)%20String"></a><font color=Blue><i>-- Labeling of QDInt is s[m-1], ..., s[0], with the least significant</i></font>
<a name="line-593"></a><a name="instance%20Labelable%20(XInt%20x)%20String"></a><font color=Blue><i>-- bit at index 0.</i></font>
<a name="line-594"></a><a name="instance%20Labelable%20(XInt%20x)%20String"></a><font color=Green><u>instance</u></font> QCLeaf x <font color=Red>=&gt;</font> Labelable <font color=Cyan>(</font>XInt x<font color=Cyan>)</font> String <font color=Green><u>where</u></font>
<a name="line-595"></a>  label_rec qa <font color=Red>=</font> label_rec <font color=Cyan>(</font>list_of_xint_lh qa<font color=Cyan>)</font>
<a name="line-596"></a>
<a name="line-597"></a><a name="instance%20CircLiftingUnpack%20(Circ%20QDInt)%20(Circ%20QDInt)"></a><font color=Green><u>instance</u></font> CircLiftingUnpack <font color=Cyan>(</font>Circ QDInt<font color=Cyan>)</font> <font color=Cyan>(</font>Circ QDInt<font color=Cyan>)</font> <font color=Green><u>where</u></font>
<a name="line-598"></a>  pack x <font color=Red>=</font> x
<a name="line-599"></a>  unpack x <font color=Red>=</font> x
<a name="line-600"></a>
<a name="line-601"></a><font color=Blue><i>-- ======================================================================</i></font>
<a name="line-602"></a><font color=Blue><i>-- * Classical arithmetic on 'IntM'</i></font>
<a name="line-603"></a>
<a name="line-604"></a><font color=Blue><i>-- ----------------------------------------------------------------------</i></font>
<a name="line-605"></a><font color=Blue><i>-- ** Auxiliary functions</i></font>
<a name="line-606"></a>  
<a name="line-607"></a><a name="integers_of_intms_signed"></a><font color=Blue><i>-- | A useful auxiliary function that converts a list of 'IntM's to a</i></font>
<a name="line-608"></a><font color=Blue><i>-- list of 'Integer's, while also returning their common length. All</i></font>
<a name="line-609"></a><font color=Blue><i>-- arguments whose length is not indeterminate must have the same common</i></font>
<a name="line-610"></a><font color=Blue><i>-- length. If the lengths don't match, throw an error with the error</i></font>
<a name="line-611"></a><font color=Blue><i>-- message specified by the 'String' argument.</i></font>
<a name="line-612"></a><font color=Blue>integers_of_intms_signed</font> <font color=Red>::</font> <font color=Red>[</font>IntM<font color=Red>]</font> <font color=Red>-&gt;</font> String <font color=Red>-&gt;</font> <font color=Cyan>(</font>Maybe Int<font color=Cyan>,</font> <font color=Red>[</font>Integer<font color=Red>]</font><font color=Cyan>)</font>
<a name="line-613"></a><font color=Blue>integers_of_intms_signed</font> xs s <font color=Red>=</font> <font color=Cyan>(</font>m<font color=Cyan>,</font> is<font color=Cyan>)</font> <font color=Green><u>where</u></font>
<a name="line-614"></a>  m <font color=Red>=</font> foldl <font color=Cyan>(</font>combine_length s<font color=Cyan>)</font> Nothing <font color=Red>[</font> intm_length x <font color=Red>|</font> x <font color=Red>&lt;-</font> xs <font color=Red>]</font>
<a name="line-615"></a>  is <font color=Red>=</font> <font color=Red>[</font> integer_of_intm_signed x <font color=Red>|</font> x <font color=Red>&lt;-</font> xs <font color=Red>]</font>  
<a name="line-616"></a>
<a name="line-617"></a><a name="integers_of_intms_unsigned"></a><font color=Blue><i>-- | Like 'integers_of_intms_signed', but regards the 'IntM's as</i></font>
<a name="line-618"></a><font color=Blue><i>-- unsigned integers.</i></font>
<a name="line-619"></a><font color=Blue>integers_of_intms_unsigned</font> <font color=Red>::</font> <font color=Red>[</font>IntM<font color=Red>]</font> <font color=Red>-&gt;</font> String <font color=Red>-&gt;</font> <font color=Cyan>(</font>Maybe Int<font color=Cyan>,</font> <font color=Red>[</font>Integer<font color=Red>]</font><font color=Cyan>)</font>
<a name="line-620"></a><font color=Blue>integers_of_intms_unsigned</font> xs s <font color=Red>=</font> <font color=Cyan>(</font>m<font color=Cyan>,</font> is<font color=Cyan>)</font> <font color=Green><u>where</u></font>
<a name="line-621"></a>  m <font color=Red>=</font> foldl <font color=Cyan>(</font>combine_length s<font color=Cyan>)</font> Nothing <font color=Red>[</font> intm_length x <font color=Red>|</font> x <font color=Red>&lt;-</font> xs <font color=Red>]</font>
<a name="line-622"></a>  is <font color=Red>=</font> <font color=Red>[</font> integer_of_intm_unsigned x <font color=Red>|</font> x <font color=Red>&lt;-</font> xs <font color=Red>]</font>  
<a name="line-623"></a>
<a name="line-624"></a><a name="intm_with_length"></a><font color=Blue><i>-- | Create an 'IntM' of the given length and value. Leave the length</i></font>
<a name="line-625"></a><font color=Blue><i>-- indeterminate if it is given as 'Nothing'.</i></font>
<a name="line-626"></a><font color=Blue>intm_with_length</font> <font color=Red>::</font> Maybe Int <font color=Red>-&gt;</font> Integer <font color=Red>-&gt;</font> IntM
<a name="line-627"></a><font color=Blue>intm_with_length</font> <font color=Cyan>(</font>Just m<font color=Cyan>)</font> n <font color=Red>=</font> intm m n
<a name="line-628"></a><font color=Blue>intm_with_length</font> Nothing n <font color=Red>=</font> intm_of_integer n
<a name="line-629"></a>
<a name="line-630"></a><a name="intm_binop"></a><font color=Blue><i>-- | Auxiliary function for lifting a binary operator from 'Integer'</i></font>
<a name="line-631"></a><font color=Blue><i>-- to 'IntM'. The string argument is the name of the operator, for</i></font>
<a name="line-632"></a><font color=Blue><i>-- error messages.</i></font>
<a name="line-633"></a><font color=Blue>intm_binop</font> <font color=Red>::</font> <font color=Cyan>(</font>Integer <font color=Red>-&gt;</font> Integer <font color=Red>-&gt;</font> Integer<font color=Cyan>)</font> <font color=Red>-&gt;</font> String <font color=Red>-&gt;</font> IntM <font color=Red>-&gt;</font> IntM <font color=Red>-&gt;</font> IntM 
<a name="line-634"></a><font color=Blue>intm_binop</font> op opname x y <font color=Red>=</font> intm_with_length m <font color=Cyan>(</font>op x' y'<font color=Cyan>)</font> <font color=Green><u>where</u></font>
<a name="line-635"></a>  <font color=Cyan>(</font>m<font color=Cyan>,</font> <font color=Red>[</font>x'<font color=Cyan>,</font>y'<font color=Red>]</font><font color=Cyan>)</font> <font color=Red>=</font> integers_of_intms_signed <font color=Red>[</font>x<font color=Cyan>,</font> y<font color=Red>]</font> <font color=Cyan>(</font><font color=Magenta>"Binary operation "</font> <font color=Cyan>++</font> opname <font color=Cyan>++</font> <font color=Magenta>" on IntM: operands must be of equal length"</font><font color=Cyan>)</font>
<a name="line-636"></a>
<a name="line-637"></a><a name="intm_unop"></a><font color=Blue><i>-- | Auxiliary function for lifting a unary operator from 'Integer' to</i></font>
<a name="line-638"></a><font color=Blue><i>-- 'IntM'.</i></font>
<a name="line-639"></a><font color=Blue>intm_unop</font> <font color=Red>::</font> <font color=Cyan>(</font>Integer <font color=Red>-&gt;</font> Integer<font color=Cyan>)</font> <font color=Red>-&gt;</font> IntM <font color=Red>-&gt;</font> IntM
<a name="line-640"></a><font color=Blue>intm_unop</font> op x <font color=Red>=</font> intm_with_length xm <font color=Cyan>(</font>op x'<font color=Cyan>)</font> <font color=Green><u>where</u></font>
<a name="line-641"></a>  xm <font color=Red>=</font> intm_length x
<a name="line-642"></a>  x' <font color=Red>=</font> integer_of_intm_signed x
<a name="line-643"></a>  
<a name="line-644"></a><font color=Blue><i>-- ----------------------------------------------------------------------</i></font>
<a name="line-645"></a><font color=Blue><i>-- ** Type class instances</i></font>
<a name="line-646"></a>
<a name="line-647"></a><font color=Blue><i>-- $INTMCLASSES </i></font>
<a name="line-648"></a><font color=Blue><i>-- </i></font>
<a name="line-649"></a><font color=Blue><i>-- 'IntM' is an instance of Haskell's 'Eq', 'Num', 'Ord', 'Real',</i></font>
<a name="line-650"></a><font color=Blue><i>-- 'Enum', and 'Integral' type classes. This means that integer</i></font>
<a name="line-651"></a><font color=Blue><i>-- literals (e.g., 17), and the usual arithmetic functions, such as</i></font>
<a name="line-652"></a><font color=Blue><i>-- '+', '-', '*', 'abs', 'succ', 'pred', 'mod', 'div', and others, can</i></font>
<a name="line-653"></a><font color=Blue><i>-- be used for values of type 'IntM'. In general, we treat 'IntM' as a</i></font>
<a name="line-654"></a><font color=Blue><i>-- signed integer type. Use 'fromIntegral' to convert an integer to an</i></font>
<a name="line-655"></a><font color=Blue><i>-- 'IntM' of indeterminate length.</i></font>
<a name="line-656"></a><font color=Blue><i>-- </i></font>
<a name="line-657"></a><font color=Blue><i>-- The general convention for binary operations (such as</i></font>
<a name="line-658"></a><font color=Blue><i>-- multiplication) is: both operands must have the same length,</i></font>
<a name="line-659"></a><font color=Blue><i>-- except: if one operand has indeterminate length, it takes on the</i></font>
<a name="line-660"></a><font color=Blue><i>-- length of the other; if both operands have indeterminate length, the</i></font>
<a name="line-661"></a><font color=Blue><i>-- result will have indeterminate length.</i></font>
<a name="line-662"></a>
<a name="line-663"></a><a name="instance%20Eq%20(XInt%20x)"></a><font color=Green><u>instance</u></font> Eq x <font color=Red>=&gt;</font> Eq <font color=Cyan>(</font>XInt x<font color=Cyan>)</font> <font color=Green><u>where</u></font>
<a name="line-664"></a>  x <font color=Cyan>==</font> y <font color=Red>=</font> xint_equals x y
<a name="line-665"></a>    
<a name="line-666"></a><a name="instance%20Num%20IntM"></a><font color=Green><u>instance</u></font> Num IntM <font color=Green><u>where</u></font>
<a name="line-667"></a>  <font color=Cyan>(</font><font color=Cyan>+</font><font color=Cyan>)</font> <font color=Red>=</font> intm_binop <font color=Cyan>(</font><font color=Cyan>+</font><font color=Cyan>)</font> <font color=Magenta>"+"</font>
<a name="line-668"></a>  <font color=Cyan>(</font><font color=Cyan>*</font><font color=Cyan>)</font> <font color=Red>=</font> intm_binop <font color=Cyan>(</font><font color=Cyan>*</font><font color=Cyan>)</font> <font color=Magenta>"*"</font>
<a name="line-669"></a>  <font color=Cyan>(</font><font color=Blue><i>-</i></font><font color=Cyan>)</font> <font color=Red>=</font> intm_binop <font color=Cyan>(</font><font color=Blue><i>-</i></font><font color=Cyan>)</font> <font color=Magenta>"-"</font>
<a name="line-670"></a>  abs <font color=Red>=</font> intm_unop abs
<a name="line-671"></a>  signum <font color=Red>=</font> intm_unop signum
<a name="line-672"></a>  fromInteger <font color=Red>=</font> intm_of_integer
<a name="line-673"></a>
<a name="line-674"></a><a name="instance%20Ord%20IntM"></a><font color=Green><u>instance</u></font> Ord IntM <font color=Green><u>where</u></font>
<a name="line-675"></a>  compare x y <font color=Red>=</font> compare <font color=Cyan>(</font>toInteger x<font color=Cyan>)</font> <font color=Cyan>(</font>toInteger y<font color=Cyan>)</font>
<a name="line-676"></a>
<a name="line-677"></a><a name="instance%20Real%20IntM"></a><font color=Green><u>instance</u></font> Real IntM <font color=Green><u>where</u></font>
<a name="line-678"></a>  toRational <font color=Red>=</font> toRational <font color=Cyan>.</font> integer_of_intm_signed
<a name="line-679"></a>
<a name="line-680"></a><a name="instance%20Enum%20IntM"></a><font color=Green><u>instance</u></font> Enum IntM <font color=Green><u>where</u></font>
<a name="line-681"></a>  succ <font color=Red>=</font> intm_unop succ
<a name="line-682"></a>  pred <font color=Red>=</font> intm_unop pred
<a name="line-683"></a>  toEnum <font color=Red>=</font> intm_of_integer <font color=Cyan>.</font> fromIntegral
<a name="line-684"></a>  fromEnum <font color=Red>=</font> fromIntegral <font color=Cyan>.</font> integer_of_intm_signed
<a name="line-685"></a>  enumFrom x <font color=Red>=</font> map <font color=Cyan>(</font>intm_with_length m<font color=Cyan>)</font> <font color=Red>[</font>x'<font color=Red>..</font><font color=Red>]</font> <font color=Green><u>where</u></font>
<a name="line-686"></a>    <font color=Cyan>(</font>m<font color=Cyan>,</font> <font color=Red>[</font>x'<font color=Red>]</font><font color=Cyan>)</font> <font color=Red>=</font> integers_of_intms_signed <font color=Red>[</font>x<font color=Red>]</font> <font color=Magenta>"enumeration: IntM"</font>
<a name="line-687"></a>  enumFromThen x y <font color=Red>=</font> map <font color=Cyan>(</font>intm_with_length m<font color=Cyan>)</font> <font color=Red>[</font>x'<font color=Cyan>,</font>y'<font color=Red>..</font><font color=Red>]</font> <font color=Green><u>where</u></font>
<a name="line-688"></a>    <font color=Cyan>(</font>m<font color=Cyan>,</font> <font color=Red>[</font>x'<font color=Cyan>,</font>y'<font color=Red>]</font><font color=Cyan>)</font> <font color=Red>=</font> integers_of_intms_signed <font color=Red>[</font>x<font color=Cyan>,</font>y<font color=Red>]</font> <font color=Magenta>"enumeration: IntM operands must be of equal length"</font>
<a name="line-689"></a>  enumFromTo x y <font color=Red>=</font> map <font color=Cyan>(</font>intm_with_length m<font color=Cyan>)</font> <font color=Red>[</font>x'<font color=Red>..</font>y'<font color=Red>]</font> <font color=Green><u>where</u></font>
<a name="line-690"></a>    <font color=Cyan>(</font>m<font color=Cyan>,</font> <font color=Red>[</font>x'<font color=Cyan>,</font>y'<font color=Red>]</font><font color=Cyan>)</font> <font color=Red>=</font> integers_of_intms_signed <font color=Red>[</font>x<font color=Cyan>,</font>y<font color=Red>]</font> <font color=Magenta>"enumeration: IntM operands must be of equal length"</font>
<a name="line-691"></a>  enumFromThenTo x y z <font color=Red>=</font> map <font color=Cyan>(</font>intm_with_length m<font color=Cyan>)</font> <font color=Red>[</font>x'<font color=Cyan>,</font>y'<font color=Red>..</font>z'<font color=Red>]</font> <font color=Green><u>where</u></font>
<a name="line-692"></a>    <font color=Cyan>(</font>m<font color=Cyan>,</font> <font color=Red>[</font>x'<font color=Cyan>,</font>y'<font color=Cyan>,</font>z'<font color=Red>]</font><font color=Cyan>)</font> <font color=Red>=</font> integers_of_intms_signed <font color=Red>[</font>x<font color=Cyan>,</font>y<font color=Cyan>,</font>z<font color=Red>]</font> <font color=Magenta>"enumeration: IntM operands must be of equal length"</font>
<a name="line-693"></a>
<a name="line-694"></a><a name="intm_interval_signed"></a><font color=Blue><i>-- | Return the interval @[/x/../y/]@, with /x/ and /y/ regarded as</i></font>
<a name="line-695"></a><font color=Blue><i>-- signed values of type 'IntM'.</i></font>
<a name="line-696"></a><font color=Blue>intm_interval_signed</font> <font color=Red>::</font> IntM <font color=Red>-&gt;</font> IntM <font color=Red>-&gt;</font> <font color=Red>[</font>IntM<font color=Red>]</font>
<a name="line-697"></a><font color=Blue>intm_interval_signed</font> x y <font color=Red>=</font> <font color=Red>[</font>x<font color=Red>..</font>y<font color=Red>]</font>  <font color=Blue><i>-- this comes from the 'Enum' instance defined above</i></font>
<a name="line-698"></a>
<a name="line-699"></a><a name="intm_interval_unsigned"></a><font color=Blue><i>-- | Return the interval @[/x/../y/]@, with /x/ and /y/ regarded as</i></font>
<a name="line-700"></a><font color=Blue><i>-- unsigned values of type 'IntM'.</i></font>
<a name="line-701"></a><font color=Blue>intm_interval_unsigned</font> <font color=Red>::</font> IntM <font color=Red>-&gt;</font> IntM <font color=Red>-&gt;</font> <font color=Red>[</font>IntM<font color=Red>]</font>
<a name="line-702"></a><font color=Blue>intm_interval_unsigned</font> x y <font color=Red>=</font> map <font color=Cyan>(</font>intm_with_length m<font color=Cyan>)</font> <font color=Red>[</font>x'<font color=Red>..</font>y'<font color=Red>]</font> <font color=Green><u>where</u></font>
<a name="line-703"></a>  <font color=Cyan>(</font>m<font color=Cyan>,</font> <font color=Red>[</font>x'<font color=Cyan>,</font>y'<font color=Red>]</font><font color=Cyan>)</font> <font color=Red>=</font> integers_of_intms_unsigned <font color=Red>[</font>x<font color=Cyan>,</font>y<font color=Red>]</font> <font color=Magenta>"intm_interval: operands must be of equal length"</font>
<a name="line-704"></a>
<a name="line-705"></a><a name="instance%20Integral%20IntM"></a><font color=Green><u>instance</u></font> Integral IntM <font color=Green><u>where</u></font>
<a name="line-706"></a>  toInteger <font color=Red>=</font> integer_of_intm_signed
<a name="line-707"></a>  quotRem x y <font color=Red>=</font> <font color=Cyan>(</font>intm_with_length m q'<font color=Cyan>,</font> intm_with_length m r'<font color=Cyan>)</font> <font color=Green><u>where</u></font>
<a name="line-708"></a>    <font color=Cyan>(</font>m<font color=Cyan>,</font> <font color=Red>[</font>x'<font color=Cyan>,</font>y'<font color=Red>]</font><font color=Cyan>)</font> <font color=Red>=</font> integers_of_intms_signed <font color=Red>[</font>x<font color=Cyan>,</font> y<font color=Red>]</font> <font color=Magenta>"Division on IntM: operands must be of equal length"</font>
<a name="line-709"></a>    <font color=Cyan>(</font>q'<font color=Cyan>,</font>r'<font color=Cyan>)</font> <font color=Red>=</font> quotRem x' y'
<a name="line-710"></a>
<a name="line-711"></a><font color=Blue><i>-- ======================================================================</i></font>
<a name="line-712"></a><font color=Blue><i>-- * Quantum arithmetic on 'QDInt'</i></font>
<a name="line-713"></a>
<a name="line-714"></a><font color=Blue><i>-- Developer note: each quantum arithmetic function is implemented by</i></font>
<a name="line-715"></a><font color=Blue><i>-- an underlying low-level function operating on qubit lists. However,</i></font>
<a name="line-716"></a><font color=Blue><i>-- these lower-level functions are *not* exported. If any module needs</i></font>
<a name="line-717"></a><font color=Blue><i>-- them, it should define them explicitly using 'qulist_of_qdint_bh'</i></font>
<a name="line-718"></a><font color=Blue><i>-- and 'qdint_of_qulist_bh'. In particular, the low-level functions</i></font>
<a name="line-719"></a><font color=Blue><i>-- may not perform error checking if it is already performed by their</i></font>
<a name="line-720"></a><font color=Blue><i>-- high-level counterparts.</i></font>
<a name="line-721"></a>
<a name="line-722"></a><font color=Blue><i>-- ----------------------------------------------------------------------</i></font>
<a name="line-723"></a><font color=Blue><i>-- ** Auxiliary functions</i></font>
<a name="line-724"></a>
<a name="line-725"></a><a name="common_value"></a><font color=Blue><i>-- | @'common_value' error_str [n1,n2,n3]@: if /n1/, /n2/, /n3/ all equal, return this value; else throw an error.  Useful for checking that sizes of 'QDInt's match.</i></font>
<a name="line-726"></a><font color=Blue>common_value</font> <font color=Red>::</font> <font color=Cyan>(</font>Eq a<font color=Cyan>)</font> <font color=Red>=&gt;</font> String <font color=Red>-&gt;</font> <font color=Red>[</font>a<font color=Red>]</font> <font color=Red>-&gt;</font> a
<a name="line-727"></a><font color=Blue>common_value</font> <font color=Green><u>_</u></font> [] <font color=Red>=</font> error <font color=Magenta>"common_value: no inputs given"</font>
<a name="line-728"></a><font color=Blue>common_value</font> <font color=Green><u>_</u></font> <font color=Red>[</font>n<font color=Red>]</font> <font color=Red>=</font> n
<a name="line-729"></a><font color=Blue>common_value</font> error_str <font color=Cyan>(</font>n<font color=Red><b>:</b></font>ns<font color=Cyan>)</font> <font color=Red>=</font> <font color=Green><u>if</u></font> common_value error_str ns <font color=Cyan>==</font> n <font color=Green><u>then</u></font> n <font color=Green><u>else</u></font> error error_str
<a name="line-730"></a>
<a name="line-731"></a><a name="common_length"></a><font color=Blue><i>-- | @'common_length' error_str [x1,x2,x3]@: if /x1/, /x2/, /x3/ all have the same length, return this value; else throw an error. </i></font>
<a name="line-732"></a><font color=Blue>common_length</font> <font color=Red>::</font> String <font color=Red>-&gt;</font> <font color=Red>[</font>QDInt<font color=Red>]</font> <font color=Red>-&gt;</font> Int
<a name="line-733"></a><font color=Blue>common_length</font> error_str xs <font color=Red>=</font> common_value error_str <font color=Cyan>$</font> map qdint_length xs
<a name="line-734"></a>
<a name="line-735"></a><font color=Blue><i>-- ----------------------------------------------------------------------</i></font>
<a name="line-736"></a><font color=Blue><i>-- ** Incrementing and decrementing</i></font>
<a name="line-737"></a>
<a name="line-738"></a><a name="q_increment"></a><font color=Blue><i>-- | Increment a 'QDInt' in place.  /O/(&#8467;) gates. </i></font>
<a name="line-739"></a><font color=Blue><i>-- </i></font>
<a name="line-740"></a><font color=Blue><i>-- Implementation note: currently tries to minimize gate count, at the cost of a rather long Quipper description.  Can the latter be reduced without increasing the former?  </i></font>
<a name="line-741"></a><font color=Blue>q_increment</font> <font color=Red>::</font> QDInt <font color=Red>-&gt;</font> Circ QDInt
<a name="line-742"></a><font color=Blue>q_increment</font> <font color=Red>=</font> mmap xint_of_list_bh <font color=Cyan>.</font> q_increment_qulist <font color=Cyan>.</font> list_of_xint_bh
<a name="line-743"></a>
<a name="line-744"></a><a name="q_increment_qulist"></a><font color=Blue><i>-- | Low-level implementation of 'q_increment': represents integers as</i></font>
<a name="line-745"></a><font color=Blue><i>-- big-headian qubit lists.</i></font>
<a name="line-746"></a><font color=Blue>q_increment_qulist</font> <font color=Red>::</font> <font color=Red>[</font>Qubit<font color=Red>]</font> <font color=Red>-&gt;</font> Circ <font color=Red>[</font>Qubit<font color=Red>]</font>
<a name="line-747"></a><font color=Blue>q_increment_qulist</font> [] <font color=Red>=</font> return []
<a name="line-748"></a><font color=Blue>q_increment_qulist</font> <font color=Red>[</font>x_0<font color=Red>]</font> <font color=Red>=</font> <font color=Green><u>do</u></font> x_0 <font color=Red>&lt;-</font> qnot x_0<font color=Cyan>;</font> return <font color=Red>[</font>x_0<font color=Red>]</font>
<a name="line-749"></a><font color=Blue>q_increment_qulist</font> <font color=Red>[</font>x_1<font color=Cyan>,</font>x_0<font color=Red>]</font> <font color=Red>=</font> <font color=Green><u>do</u></font> x_0 <font color=Red>&lt;-</font> qnot x_0<font color=Cyan>;</font> x_1 <font color=Red>&lt;-</font> qnot x_1 <font color=Cyan>`controlled`</font> <font color=Cyan>(</font>x_0 <font color=Cyan>.==.</font> <font color=Magenta>0</font><font color=Cyan>)</font><font color=Cyan>;</font> return <font color=Red>[</font>x_1<font color=Cyan>,</font>x_0<font color=Red>]</font>
<a name="line-750"></a><font color=Blue>q_increment_qulist</font> <font color=Red>[</font>x_2<font color=Cyan>,</font>x_1<font color=Cyan>,</font>x_0<font color=Red>]</font> <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-751"></a>  x_0 <font color=Red>&lt;-</font> qnot x_0
<a name="line-752"></a>  x_1 <font color=Red>&lt;-</font> qnot x_1 <font color=Cyan>`controlled`</font> <font color=Cyan>(</font>x_0 <font color=Cyan>.==.</font> <font color=Magenta>0</font><font color=Cyan>)</font>
<a name="line-753"></a>  x_2 <font color=Red>&lt;-</font> qnot x_2 <font color=Cyan>`controlled`</font> <font color=Cyan>(</font>x_0 <font color=Cyan>.==.</font> <font color=Magenta>0</font><font color=Cyan>)</font> <font color=Cyan>.&amp;&amp;.</font> <font color=Cyan>(</font>x_1 <font color=Cyan>.==.</font> <font color=Magenta>0</font><font color=Cyan>)</font>
<a name="line-754"></a>  return <font color=Red>[</font>x_2<font color=Cyan>,</font>x_1<font color=Cyan>,</font>x_0<font color=Red>]</font>
<a name="line-755"></a><font color=Blue>q_increment_qulist</font> x_bits <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-756"></a>  <font color=Green><u>let</u></font> x_0 <font color=Red>=</font> last x_bits
<a name="line-757"></a>      x_1 <font color=Red>=</font> last <font color=Cyan>$</font> init x_bits
<a name="line-758"></a>      x_higher <font color=Red>=</font> init <font color=Cyan>$</font> init <font color=Cyan>$</font> x_bits
<a name="line-759"></a>  x_0 <font color=Red>&lt;-</font> qnot x_0
<a name="line-760"></a>  x_1 <font color=Red>&lt;-</font> qnot x_1 <font color=Cyan>`controlled`</font> <font color=Cyan>(</font>x_0 <font color=Cyan>.==.</font> <font color=Magenta>0</font><font color=Cyan>)</font>
<a name="line-761"></a>  <font color=Cyan>(</font>x_higher<font color=Cyan>,</font>x_1<font color=Cyan>,</font>x_0<font color=Cyan>)</font> <font color=Red>&lt;-</font> with_ancilla <font color=Cyan>(</font><font color=Red>\</font>c <font color=Red>-&gt;</font> <font color=Green><u>do</u></font>
<a name="line-762"></a>    c <font color=Red>&lt;-</font> qnot c <font color=Cyan>`controlled`</font> <font color=Cyan>(</font>x_0 <font color=Cyan>.==.</font> <font color=Magenta>0</font><font color=Cyan>)</font> <font color=Cyan>.&amp;&amp;.</font> <font color=Cyan>(</font>x_1 <font color=Cyan>.==.</font> <font color=Magenta>0</font><font color=Cyan>)</font>
<a name="line-763"></a>    <font color=Cyan>(</font>c<font color=Cyan>,</font>rev_x_higher<font color=Cyan>)</font> <font color=Red>&lt;-</font> q_increment_qulist_aux c <font color=Cyan>(</font>reverse x_higher<font color=Cyan>)</font>
<a name="line-764"></a>    c <font color=Red>&lt;-</font> qnot c <font color=Cyan>`controlled`</font> <font color=Cyan>(</font>x_0 <font color=Cyan>.==.</font> <font color=Magenta>0</font><font color=Cyan>)</font> <font color=Cyan>.&amp;&amp;.</font> <font color=Cyan>(</font>x_1 <font color=Cyan>.==.</font> <font color=Magenta>0</font><font color=Cyan>)</font>
<a name="line-765"></a>    return <font color=Cyan>(</font>reverse rev_x_higher<font color=Cyan>,</font> x_1<font color=Cyan>,</font> x_0<font color=Cyan>)</font><font color=Cyan>)</font>
<a name="line-766"></a>  return <font color=Cyan>(</font>x_higher <font color=Cyan>++</font> <font color=Red>[</font>x_1<font color=Cyan>,</font>x_0<font color=Red>]</font><font color=Cyan>)</font>
<a name="line-767"></a>  <font color=Green><u>where</u></font>
<a name="line-768"></a>  <font color=Blue><i>-- increment a LITTLE-endian bit-string, controlled by a single qubit.</i></font>
<a name="line-769"></a>    q_increment_qulist_aux <font color=Red>::</font> Qubit <font color=Red>-&gt;</font> <font color=Red>[</font>Qubit<font color=Red>]</font> <font color=Red>-&gt;</font> Circ <font color=Cyan>(</font>Qubit<font color=Cyan>,</font><font color=Red>[</font>Qubit<font color=Red>]</font><font color=Cyan>)</font>
<a name="line-770"></a>    q_increment_qulist_aux b [] <font color=Red>=</font> return <font color=Cyan>(</font>b<font color=Cyan>,</font>[]<font color=Cyan>)</font>
<a name="line-771"></a>    q_increment_qulist_aux b <font color=Red>[</font>x_0<font color=Red>]</font> <font color=Red>=</font>
<a name="line-772"></a>      <font color=Green><u>do</u></font> x_0 <font color=Red>&lt;-</font> qnot x_0 <font color=Cyan>`controlled`</font> b<font color=Cyan>;</font> return <font color=Cyan>(</font>b<font color=Cyan>,</font><font color=Red>[</font>x_0<font color=Red>]</font><font color=Cyan>)</font>
<a name="line-773"></a>    q_increment_qulist_aux b <font color=Red>[</font>x_0<font color=Cyan>,</font>x_1<font color=Red>]</font> <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-774"></a>      x_0 <font color=Red>&lt;-</font> qnot x_0 <font color=Cyan>`controlled`</font> b
<a name="line-775"></a>      x_1 <font color=Red>&lt;-</font> qnot x_1 <font color=Cyan>`controlled`</font> b <font color=Cyan>.&amp;&amp;.</font> <font color=Cyan>(</font>x_0 <font color=Cyan>.==.</font> <font color=Magenta>0</font><font color=Cyan>)</font>
<a name="line-776"></a>      return <font color=Cyan>(</font>b<font color=Cyan>,</font><font color=Red>[</font>x_0<font color=Cyan>,</font>x_1<font color=Red>]</font><font color=Cyan>)</font>
<a name="line-777"></a>    q_increment_qulist_aux b <font color=Cyan>(</font>x_0<font color=Red><b>:</b></font>x_higher<font color=Cyan>)</font> <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-778"></a>      x_0 <font color=Red>&lt;-</font> qnot x_0 <font color=Cyan>`controlled`</font> b 
<a name="line-779"></a>      <font color=Cyan>(</font>b<font color=Cyan>,</font>x_0<font color=Cyan>,</font>x_higher<font color=Cyan>)</font> <font color=Red>&lt;-</font> with_ancilla <font color=Cyan>(</font><font color=Red>\</font>c <font color=Red>-&gt;</font> <font color=Green><u>do</u></font>
<a name="line-780"></a>        c <font color=Red>&lt;-</font> qnot c <font color=Cyan>`controlled`</font> b <font color=Cyan>.&amp;&amp;.</font> <font color=Cyan>(</font>x_0 <font color=Cyan>.==.</font> <font color=Magenta>0</font><font color=Cyan>)</font>
<a name="line-781"></a>        <font color=Cyan>(</font>c<font color=Cyan>,</font>x_higher<font color=Cyan>)</font> <font color=Red>&lt;-</font> q_increment_qulist_aux c x_higher
<a name="line-782"></a>        c <font color=Red>&lt;-</font> qnot c <font color=Cyan>`controlled`</font> b <font color=Cyan>.&amp;&amp;.</font> <font color=Cyan>(</font>x_0 <font color=Cyan>.==.</font> <font color=Magenta>0</font><font color=Cyan>)</font>
<a name="line-783"></a>        return <font color=Cyan>(</font>b<font color=Cyan>,</font>x_0<font color=Cyan>,</font>x_higher<font color=Cyan>)</font><font color=Cyan>)</font>
<a name="line-784"></a>      return <font color=Cyan>(</font>b<font color=Cyan>,</font> <font color=Cyan>(</font>x_0<font color=Red><b>:</b></font>x_higher<font color=Cyan>)</font><font color=Cyan>)</font>
<a name="line-785"></a>    
<a name="line-786"></a><a name="q_decrement"></a><font color=Blue><i>-- | Decrement a 'QDInt' in place.  Inverse of 'q_increment'. /O/(&#8467;).</i></font>
<a name="line-787"></a><font color=Blue>q_decrement</font> <font color=Red>::</font> QDInt <font color=Red>-&gt;</font> Circ QDInt
<a name="line-788"></a><font color=Blue>q_decrement</font> <font color=Red>=</font> reverse_generic_endo q_increment
<a name="line-789"></a>
<a name="line-790"></a><font color=Blue><i>-- ----------------------------------------------------------------------</i></font>
<a name="line-791"></a><font color=Blue><i>-- ** Addition and subtraction</i></font>
<a name="line-792"></a>
<a name="line-793"></a><a name="q_add_qdint"></a><font color=Blue><i>-- | Add two 'QDInt's into a fresh one.  Arguments are assumed to be of equal size.  /O/(&#8467;) gates, both before and after transformation to Toffoli.</i></font>
<a name="line-794"></a><font color=Blue>q_add_qdint</font> <font color=Red>::</font> QDInt <font color=Red>-&gt;</font> QDInt <font color=Red>-&gt;</font> Circ <font color=Cyan>(</font>QDInt<font color=Cyan>,</font> QDInt<font color=Cyan>,</font> QDInt<font color=Cyan>)</font>
<a name="line-795"></a><font color=Blue>q_add_qdint</font> x y <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-796"></a>  <font color=Green><u>let</u></font> x' <font color=Red>=</font> list_of_xint_bh x
<a name="line-797"></a>  <font color=Green><u>let</u></font> y' <font color=Red>=</font> list_of_xint_bh y
<a name="line-798"></a>  <font color=Cyan>(</font>x'<font color=Cyan>,</font> y'<font color=Cyan>,</font> z'<font color=Cyan>)</font> <font color=Red>&lt;-</font> q_add_qulist x' y'
<a name="line-799"></a>  <font color=Green><u>let</u></font> x <font color=Red>=</font> xint_of_list_bh x'
<a name="line-800"></a>  <font color=Green><u>let</u></font> y <font color=Red>=</font> xint_of_list_bh y'
<a name="line-801"></a>  <font color=Green><u>let</u></font> z <font color=Red>=</font> xint_of_list_bh z'
<a name="line-802"></a>  return <font color=Cyan>(</font>x<font color=Cyan>,</font> y<font color=Cyan>,</font> z<font color=Cyan>)</font>
<a name="line-803"></a>
<a name="line-804"></a><a name="q_add_qulist"></a><font color=Blue><i>-- | Low-level implementation of 'q_add_qdint': represents integers as</i></font>
<a name="line-805"></a><font color=Blue><i>-- big-headian qubit lists.</i></font>
<a name="line-806"></a><font color=Blue>q_add_qulist</font> <font color=Red>::</font> <font color=Red>[</font>Qubit<font color=Red>]</font> <font color=Red>-&gt;</font> <font color=Red>[</font>Qubit<font color=Red>]</font> <font color=Red>-&gt;</font> Circ <font color=Cyan>(</font><font color=Red>[</font>Qubit<font color=Red>]</font><font color=Cyan>,</font> <font color=Red>[</font>Qubit<font color=Red>]</font><font color=Cyan>,</font> <font color=Red>[</font>Qubit<font color=Red>]</font><font color=Cyan>)</font>
<a name="line-807"></a><font color=Blue>q_add_qulist</font> x y <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-808"></a>  <font color=Green><u>let</u></font> l <font color=Red>=</font> length x
<a name="line-809"></a>  when <font color=Cyan>(</font>l <font color=Cyan>/=</font> length y<font color=Cyan>)</font> <font color=Cyan>$</font> <font color=Green><u>do</u></font>
<a name="line-810"></a>    error <font color=Magenta>"q_add_qdint: cannot add QDInts of different lengths"</font>
<a name="line-811"></a>
<a name="line-812"></a>  <font color=Cyan>(</font><font color=Cyan>(</font>x<font color=Cyan>,</font>y<font color=Cyan>)</font><font color=Cyan>,</font>s_out<font color=Cyan>)</font> <font color=Red>&lt;-</font> with_computed_fun <font color=Cyan>(</font>x<font color=Cyan>,</font>y<font color=Cyan>)</font>
<a name="line-813"></a>    <font color=Cyan>(</font><font color=Red>\</font><font color=Cyan>(</font>x<font color=Cyan>,</font>y<font color=Cyan>)</font> <font color=Red>-&gt;</font> <font color=Green><u>do</u></font>
<a name="line-814"></a>      s <font color=Red>&lt;-</font> qinit <font color=Cyan>(</font>replicate l False<font color=Cyan>)</font> <font color=Blue><i>-- holds the eventual sum</i></font>
<a name="line-815"></a>      c <font color=Red>&lt;-</font> qinit <font color=Cyan>(</font>replicate l False<font color=Cyan>)</font> <font color=Blue><i>-- holds the carries</i></font>
<a name="line-816"></a>
<a name="line-817"></a>      <font color=Blue><i>-- bring the lists&#8217; indexing in line with usual numeric indexing of binary expansons</i></font>
<a name="line-818"></a>      x <font color=Red>&lt;-</font> return <font color=Cyan>$</font> reverse x
<a name="line-819"></a>      y <font color=Red>&lt;-</font> return <font color=Cyan>$</font> reverse y
<a name="line-820"></a>      s <font color=Red>&lt;-</font> return <font color=Cyan>$</font> reverse s
<a name="line-821"></a>      c <font color=Red>&lt;-</font> return <font color=Cyan>$</font> reverse c
<a name="line-822"></a>
<a name="line-823"></a>      <font color=Cyan>(</font>x<font color=Cyan>,</font>y<font color=Cyan>,</font>s<font color=Cyan>,</font>c<font color=Cyan>)</font> <font color=Red>&lt;-</font> loop_with_indexM <font color=Cyan>(</font>l<font color=Blue><i>-</i></font><font color=Magenta>1</font><font color=Cyan>)</font> <font color=Cyan>(</font>x<font color=Cyan>,</font>y<font color=Cyan>,</font>s<font color=Cyan>,</font>c<font color=Cyan>)</font> <font color=Cyan>(</font><font color=Red>\</font>j <font color=Cyan>(</font>x<font color=Cyan>,</font>y<font color=Cyan>,</font>s<font color=Cyan>,</font>c<font color=Cyan>)</font> <font color=Red>-&gt;</font> <font color=Green><u>do</u></font>
<a name="line-824"></a>        <font color=Green><u>let</u></font> c_j1 <font color=Red>=</font> c <font color=Cyan>!!</font> <font color=Cyan>(</font>j<font color=Cyan>+</font><font color=Magenta>1</font><font color=Cyan>)</font>
<a name="line-825"></a>        <font color=Green><u>let</u></font> s_j <font color=Red>=</font> s <font color=Cyan>!!</font> j
<a name="line-826"></a>        <font color=Blue><i>-- If any two of the current bits x_j, y_j, and the carry c_j are true, then set the next carry:</i></font>
<a name="line-827"></a>        <font color=Blue><i>-- (Note: we use that (a &amp; b) xor (a &amp; c) xor (b &amp; c) == (a &amp; b) or (a &amp; c) or (b &amp; c).)</i></font>
<a name="line-828"></a>        c_j1 <font color=Red>&lt;-</font> qnot c_j1 <font color=Cyan>`controlled`</font> <font color=Cyan>(</font>x<font color=Cyan>!!</font>j <font color=Cyan>.&amp;&amp;.</font> y<font color=Cyan>!!</font>j<font color=Cyan>)</font>
<a name="line-829"></a>        c_j1 <font color=Red>&lt;-</font> qnot c_j1 <font color=Cyan>`controlled`</font> <font color=Cyan>(</font>x<font color=Cyan>!!</font>j <font color=Cyan>.&amp;&amp;.</font> c<font color=Cyan>!!</font>j<font color=Cyan>)</font>
<a name="line-830"></a>        c_j1 <font color=Red>&lt;-</font> qnot c_j1 <font color=Cyan>`controlled`</font> <font color=Cyan>(</font>y<font color=Cyan>!!</font>j <font color=Cyan>.&amp;&amp;.</font> c<font color=Cyan>!!</font>j<font color=Cyan>)</font>
<a name="line-831"></a>        <font color=Blue><i>-- Now the current sum digit is computed mod 2:</i></font>
<a name="line-832"></a>        s_j <font color=Red>&lt;-</font> qnot s_j <font color=Cyan>`controlled`</font> <font color=Cyan>(</font>x<font color=Cyan>!!</font>j<font color=Cyan>)</font>
<a name="line-833"></a>        s_j <font color=Red>&lt;-</font> qnot s_j <font color=Cyan>`controlled`</font> <font color=Cyan>(</font>y<font color=Cyan>!!</font>j<font color=Cyan>)</font>
<a name="line-834"></a>        s_j <font color=Red>&lt;-</font> qnot s_j <font color=Cyan>`controlled`</font> <font color=Cyan>(</font>c<font color=Cyan>!!</font>j<font color=Cyan>)</font> 
<a name="line-835"></a>        c <font color=Red>&lt;-</font> return <font color=Cyan>$</font> overwriteAt <font color=Cyan>(</font>j<font color=Cyan>+</font><font color=Magenta>1</font><font color=Cyan>)</font> c_j1 c
<a name="line-836"></a>        s <font color=Red>&lt;-</font> return <font color=Cyan>$</font> overwriteAt j s_j s
<a name="line-837"></a>
<a name="line-838"></a>        return <font color=Cyan>(</font>x<font color=Cyan>,</font>y<font color=Cyan>,</font>s<font color=Cyan>,</font>c<font color=Cyan>)</font><font color=Cyan>)</font>
<a name="line-839"></a>
<a name="line-840"></a>      <font color=Blue><i>-- Final sum digit; no carry required:</i></font>
<a name="line-841"></a>      <font color=Green><u>let</u></font> s_l1 <font color=Red>=</font> s <font color=Cyan>!!</font> <font color=Cyan>(</font>l<font color=Blue><i>-</i></font><font color=Magenta>1</font><font color=Cyan>)</font>
<a name="line-842"></a>      s_l1 <font color=Red>&lt;-</font> qnot s_l1 <font color=Cyan>`controlled`</font> <font color=Cyan>(</font>x<font color=Cyan>!!</font><font color=Cyan>(</font>l<font color=Blue><i>-</i></font><font color=Magenta>1</font><font color=Cyan>)</font><font color=Cyan>)</font>
<a name="line-843"></a>      s_l1 <font color=Red>&lt;-</font> qnot s_l1 <font color=Cyan>`controlled`</font> <font color=Cyan>(</font>y<font color=Cyan>!!</font><font color=Cyan>(</font>l<font color=Blue><i>-</i></font><font color=Magenta>1</font><font color=Cyan>)</font><font color=Cyan>)</font>
<a name="line-844"></a>      s_l1 <font color=Red>&lt;-</font> qnot s_l1 <font color=Cyan>`controlled`</font> <font color=Cyan>(</font>c<font color=Cyan>!!</font><font color=Cyan>(</font>l<font color=Blue><i>-</i></font><font color=Magenta>1</font><font color=Cyan>)</font><font color=Cyan>)</font> 
<a name="line-845"></a>      s <font color=Red>&lt;-</font> return <font color=Cyan>$</font> overwriteAt <font color=Cyan>(</font>l<font color=Blue><i>-</i></font><font color=Magenta>1</font><font color=Cyan>)</font> s_l1 s
<a name="line-846"></a>     
<a name="line-847"></a>      x <font color=Red>&lt;-</font> return <font color=Cyan>$</font> reverse x
<a name="line-848"></a>      y <font color=Red>&lt;-</font> return <font color=Cyan>$</font> reverse y
<a name="line-849"></a>      s <font color=Red>&lt;-</font> return <font color=Cyan>$</font> reverse s
<a name="line-850"></a>      c <font color=Red>&lt;-</font> return <font color=Cyan>$</font> reverse c
<a name="line-851"></a>
<a name="line-852"></a>      return <font color=Cyan>(</font>x<font color=Cyan>,</font>y<font color=Cyan>,</font>s<font color=Cyan>,</font>c<font color=Cyan>)</font><font color=Cyan>)</font>
<a name="line-853"></a>    
<a name="line-854"></a>    <font color=Cyan>(</font><font color=Red>\</font><font color=Cyan>(</font>x<font color=Cyan>,</font>y<font color=Cyan>,</font>s<font color=Cyan>,</font>c<font color=Cyan>)</font> <font color=Red>-&gt;</font> <font color=Green><u>do</u></font>
<a name="line-855"></a>      <font color=Cyan>(</font>s<font color=Cyan>,</font>s_out<font color=Cyan>)</font> <font color=Red>&lt;-</font> qc_copy_fun s
<a name="line-856"></a>      return <font color=Cyan>(</font><font color=Cyan>(</font>x<font color=Cyan>,</font>y<font color=Cyan>,</font>s<font color=Cyan>,</font>c<font color=Cyan>)</font><font color=Cyan>,</font> s_out<font color=Cyan>)</font><font color=Cyan>)</font>
<a name="line-857"></a>  return <font color=Cyan>(</font>x<font color=Cyan>,</font> y<font color=Cyan>,</font> s_out<font color=Cyan>)</font>
<a name="line-858"></a>
<a name="line-859"></a><a name="q_sub_qdint"></a><font color=Blue><i>-- | Subtract two 'QDInt's, into a fresh one.  Arguments are assumed to be of equal size.  /O/(&#8467;).</i></font>
<a name="line-860"></a><font color=Blue>q_sub_qdint</font> <font color=Red>::</font> QDInt <font color=Red>-&gt;</font> QDInt <font color=Red>-&gt;</font> Circ <font color=Cyan>(</font>QDInt<font color=Cyan>,</font>QDInt<font color=Cyan>,</font>QDInt<font color=Cyan>)</font>
<a name="line-861"></a><font color=Blue>q_sub_qdint</font> x y <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-862"></a>  <font color=Green><u>let</u></font> x' <font color=Red>=</font> list_of_xint_bh x
<a name="line-863"></a>  <font color=Green><u>let</u></font> y' <font color=Red>=</font> list_of_xint_bh y
<a name="line-864"></a>  <font color=Cyan>(</font>x'<font color=Cyan>,</font> y'<font color=Cyan>,</font> z'<font color=Cyan>)</font> <font color=Red>&lt;-</font> q_sub_qulist x' y'
<a name="line-865"></a>  <font color=Green><u>let</u></font> x <font color=Red>=</font> xint_of_list_bh x'  
<a name="line-866"></a>  <font color=Green><u>let</u></font> y <font color=Red>=</font> xint_of_list_bh y'
<a name="line-867"></a>  <font color=Green><u>let</u></font> z <font color=Red>=</font> xint_of_list_bh z'
<a name="line-868"></a>  return <font color=Cyan>(</font>x<font color=Cyan>,</font> y<font color=Cyan>,</font> z<font color=Cyan>)</font>
<a name="line-869"></a>
<a name="line-870"></a><a name="q_sub_qulist"></a><font color=Blue><i>-- | Low-level implementation of 'q_sub_qdint': represents integers as</i></font>
<a name="line-871"></a><font color=Blue><i>-- big-headian qubit lists.</i></font>
<a name="line-872"></a><font color=Blue>q_sub_qulist</font> <font color=Red>::</font> <font color=Red>[</font>Qubit<font color=Red>]</font> <font color=Red>-&gt;</font> <font color=Red>[</font>Qubit<font color=Red>]</font> <font color=Red>-&gt;</font> Circ <font color=Cyan>(</font><font color=Red>[</font>Qubit<font color=Red>]</font><font color=Cyan>,</font> <font color=Red>[</font>Qubit<font color=Red>]</font><font color=Cyan>,</font> <font color=Red>[</font>Qubit<font color=Red>]</font><font color=Cyan>)</font>
<a name="line-873"></a><font color=Blue>q_sub_qulist</font> x y <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-874"></a>  <font color=Green><u>let</u></font> l <font color=Red>=</font> length x
<a name="line-875"></a>  when <font color=Cyan>(</font>l <font color=Cyan>/=</font> length y<font color=Cyan>)</font> <font color=Cyan>$</font> <font color=Green><u>do</u></font>
<a name="line-876"></a>    error <font color=Magenta>"q_sub_qdint: cannot subtract QDInts of different lengths"</font>
<a name="line-877"></a>  
<a name="line-878"></a>  <font color=Cyan>(</font><font color=Cyan>(</font>x<font color=Cyan>,</font>y<font color=Cyan>)</font><font color=Cyan>,</font>d_out<font color=Cyan>)</font> <font color=Red>&lt;-</font> with_computed_fun <font color=Cyan>(</font>x<font color=Cyan>,</font>y<font color=Cyan>)</font>
<a name="line-879"></a>    <font color=Cyan>(</font><font color=Red>\</font><font color=Cyan>(</font>x<font color=Cyan>,</font>y<font color=Cyan>)</font> <font color=Red>-&gt;</font> <font color=Green><u>do</u></font>
<a name="line-880"></a>      d <font color=Red>&lt;-</font> qinit <font color=Cyan>(</font>replicate l False<font color=Cyan>)</font> <font color=Blue><i>-- holds the eventual difference</i></font>
<a name="line-881"></a>      b <font color=Red>&lt;-</font> qinit <font color=Cyan>(</font>replicate l False<font color=Cyan>)</font> <font color=Blue><i>-- holds the borrows</i></font>
<a name="line-882"></a>
<a name="line-883"></a>      <font color=Blue><i>-- bring the lists&#8217; indexing in line with usual numeric indexing of binary expansons</i></font>
<a name="line-884"></a>      x <font color=Red>&lt;-</font> return <font color=Cyan>$</font> reverse x
<a name="line-885"></a>      y <font color=Red>&lt;-</font> return <font color=Cyan>$</font> reverse y
<a name="line-886"></a>      d <font color=Red>&lt;-</font> return <font color=Cyan>$</font> reverse d
<a name="line-887"></a>      b <font color=Red>&lt;-</font> return <font color=Cyan>$</font> reverse b
<a name="line-888"></a>
<a name="line-889"></a>      <font color=Cyan>(</font>x<font color=Cyan>,</font>y<font color=Cyan>,</font>d<font color=Cyan>,</font>b<font color=Cyan>)</font> <font color=Red>&lt;-</font> loop_with_indexM <font color=Cyan>(</font>l<font color=Blue><i>-</i></font><font color=Magenta>1</font><font color=Cyan>)</font> <font color=Cyan>(</font>x<font color=Cyan>,</font>y<font color=Cyan>,</font>d<font color=Cyan>,</font>b<font color=Cyan>)</font> <font color=Cyan>(</font><font color=Red>\</font>j <font color=Cyan>(</font>x<font color=Cyan>,</font>y<font color=Cyan>,</font>d<font color=Cyan>,</font>b<font color=Cyan>)</font> <font color=Red>-&gt;</font> <font color=Green><u>do</u></font>
<a name="line-890"></a>        <font color=Green><u>let</u></font> b_j1 <font color=Red>=</font> b <font color=Cyan>!!</font> <font color=Cyan>(</font>j<font color=Cyan>+</font><font color=Magenta>1</font><font color=Cyan>)</font>
<a name="line-891"></a>        <font color=Green><u>let</u></font> d_j <font color=Red>=</font> d <font color=Cyan>!!</font> j
<a name="line-892"></a>        <font color=Blue><i>-- If any two of (not x_j), y_j, and the borrow c_j hold, then set the next borrow.</i></font>
<a name="line-893"></a>        <font color=Blue><i>-- (Note: we use that (a &amp; b) xor (a &amp; c) xor (b &amp; c) == (a &amp; b) or (a &amp; c) or (b &amp; c).)</i></font>
<a name="line-894"></a>        b_j1 <font color=Red>&lt;-</font> qnot b_j1 <font color=Cyan>`controlled`</font> <font color=Cyan>(</font>x<font color=Cyan>!!</font>j <font color=Cyan>.==.</font> <font color=Magenta>0</font><font color=Cyan>)</font> <font color=Cyan>.&amp;&amp;.</font> <font color=Cyan>(</font>y<font color=Cyan>!!</font>j <font color=Cyan>.==.</font> <font color=Magenta>1</font><font color=Cyan>)</font>
<a name="line-895"></a>        b_j1 <font color=Red>&lt;-</font> qnot b_j1 <font color=Cyan>`controlled`</font> <font color=Cyan>(</font>x<font color=Cyan>!!</font>j <font color=Cyan>.==.</font> <font color=Magenta>0</font><font color=Cyan>)</font> <font color=Cyan>.&amp;&amp;.</font> <font color=Cyan>(</font>b<font color=Cyan>!!</font>j <font color=Cyan>.==.</font> <font color=Magenta>1</font><font color=Cyan>)</font>
<a name="line-896"></a>        b_j1 <font color=Red>&lt;-</font> qnot b_j1 <font color=Cyan>`controlled`</font> <font color=Cyan>(</font>y<font color=Cyan>!!</font>j <font color=Cyan>.==.</font> <font color=Magenta>1</font><font color=Cyan>)</font> <font color=Cyan>.&amp;&amp;.</font> <font color=Cyan>(</font>b<font color=Cyan>!!</font>j <font color=Cyan>.==.</font> <font color=Magenta>1</font><font color=Cyan>)</font>
<a name="line-897"></a>        <font color=Blue><i>-- Now the current difference digit is computed mod 2:</i></font>
<a name="line-898"></a>        d_j <font color=Red>&lt;-</font> qnot d_j <font color=Cyan>`controlled`</font> <font color=Cyan>(</font>x<font color=Cyan>!!</font>j<font color=Cyan>)</font>
<a name="line-899"></a>        d_j <font color=Red>&lt;-</font> qnot d_j <font color=Cyan>`controlled`</font> <font color=Cyan>(</font>y<font color=Cyan>!!</font>j<font color=Cyan>)</font>
<a name="line-900"></a>        d_j <font color=Red>&lt;-</font> qnot d_j <font color=Cyan>`controlled`</font> <font color=Cyan>(</font>b<font color=Cyan>!!</font>j<font color=Cyan>)</font> 
<a name="line-901"></a>        b <font color=Red>&lt;-</font> return <font color=Cyan>$</font> overwriteAt <font color=Cyan>(</font>j<font color=Cyan>+</font><font color=Magenta>1</font><font color=Cyan>)</font> b_j1 b
<a name="line-902"></a>        d <font color=Red>&lt;-</font> return <font color=Cyan>$</font> overwriteAt j d_j d
<a name="line-903"></a>        return <font color=Cyan>(</font>x<font color=Cyan>,</font>y<font color=Cyan>,</font>d<font color=Cyan>,</font>b<font color=Cyan>)</font><font color=Cyan>)</font>
<a name="line-904"></a>
<a name="line-905"></a>      <font color=Blue><i>-- Final difference digit; no carry required:</i></font>
<a name="line-906"></a>      <font color=Green><u>let</u></font> d_l1 <font color=Red>=</font> d <font color=Cyan>!!</font> <font color=Cyan>(</font>l<font color=Blue><i>-</i></font><font color=Magenta>1</font><font color=Cyan>)</font>
<a name="line-907"></a>      d_l1 <font color=Red>&lt;-</font> qnot d_l1 <font color=Cyan>`controlled`</font> <font color=Cyan>(</font>x<font color=Cyan>!!</font><font color=Cyan>(</font>l<font color=Blue><i>-</i></font><font color=Magenta>1</font><font color=Cyan>)</font><font color=Cyan>)</font>
<a name="line-908"></a>      d_l1 <font color=Red>&lt;-</font> qnot d_l1 <font color=Cyan>`controlled`</font> <font color=Cyan>(</font>y<font color=Cyan>!!</font><font color=Cyan>(</font>l<font color=Blue><i>-</i></font><font color=Magenta>1</font><font color=Cyan>)</font><font color=Cyan>)</font>
<a name="line-909"></a>      d_l1 <font color=Red>&lt;-</font> qnot d_l1 <font color=Cyan>`controlled`</font> <font color=Cyan>(</font>b<font color=Cyan>!!</font><font color=Cyan>(</font>l<font color=Blue><i>-</i></font><font color=Magenta>1</font><font color=Cyan>)</font><font color=Cyan>)</font> 
<a name="line-910"></a>      d <font color=Red>&lt;-</font> return <font color=Cyan>$</font> overwriteAt <font color=Cyan>(</font>l<font color=Blue><i>-</i></font><font color=Magenta>1</font><font color=Cyan>)</font> d_l1 d
<a name="line-911"></a>
<a name="line-912"></a>      <font color=Blue><i>-- bring the lists&#8217; indexing in line with usual numeric indexing of binary expansons</i></font>
<a name="line-913"></a>      x <font color=Red>&lt;-</font> return <font color=Cyan>$</font> reverse x
<a name="line-914"></a>      y <font color=Red>&lt;-</font> return <font color=Cyan>$</font> reverse y
<a name="line-915"></a>      d <font color=Red>&lt;-</font> return <font color=Cyan>$</font> reverse d
<a name="line-916"></a>      b <font color=Red>&lt;-</font> return <font color=Cyan>$</font> reverse b
<a name="line-917"></a>
<a name="line-918"></a>      return <font color=Cyan>(</font>x<font color=Cyan>,</font>y<font color=Cyan>,</font>d<font color=Cyan>,</font>b<font color=Cyan>)</font><font color=Cyan>)</font>
<a name="line-919"></a>    
<a name="line-920"></a>    <font color=Cyan>(</font><font color=Red>\</font><font color=Cyan>(</font>x<font color=Cyan>,</font>y<font color=Cyan>,</font>d<font color=Cyan>,</font>b<font color=Cyan>)</font> <font color=Red>-&gt;</font> <font color=Green><u>do</u></font>
<a name="line-921"></a>      <font color=Cyan>(</font>d<font color=Cyan>,</font>d_out<font color=Cyan>)</font> <font color=Red>&lt;-</font> qc_copy_fun d
<a name="line-922"></a>      return <font color=Cyan>(</font><font color=Cyan>(</font>x<font color=Cyan>,</font>y<font color=Cyan>,</font>d<font color=Cyan>,</font>b<font color=Cyan>)</font><font color=Cyan>,</font> d_out<font color=Cyan>)</font><font color=Cyan>)</font>
<a name="line-923"></a>  return <font color=Cyan>(</font>x<font color=Cyan>,</font> y<font color=Cyan>,</font> d_out<font color=Cyan>)</font>
<a name="line-924"></a>
<a name="line-925"></a><a name="q_add_in_place"></a><font color=Blue><i>-- | Add one 'QDInt' onto a second, in place; i.e. (/x/,/y/) &#8614; (/x/,/x/+/y/).  Arguments are assumed to be of equal size.  /O/(&#8467;) gates.</i></font>
<a name="line-926"></a><font color=Blue>q_add_in_place</font> <font color=Red>::</font> QDInt <font color=Red>-&gt;</font> QDInt <font color=Red>-&gt;</font> Circ <font color=Cyan>(</font>QDInt<font color=Cyan>,</font>QDInt<font color=Cyan>)</font>
<a name="line-927"></a><font color=Blue>q_add_in_place</font> x y <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-928"></a>  <font color=Green><u>let</u></font> x' <font color=Red>=</font> list_of_xint_bh x
<a name="line-929"></a>  <font color=Green><u>let</u></font> y' <font color=Red>=</font> list_of_xint_bh y
<a name="line-930"></a>  <font color=Cyan>(</font>x'<font color=Cyan>,</font> y'<font color=Cyan>)</font> <font color=Red>&lt;-</font> q_add_in_place_qulist x' y'
<a name="line-931"></a>  <font color=Green><u>let</u></font> x <font color=Red>=</font> xint_of_list_bh x'
<a name="line-932"></a>  <font color=Green><u>let</u></font> y <font color=Red>=</font> xint_of_list_bh y'
<a name="line-933"></a>  return <font color=Cyan>(</font>x<font color=Cyan>,</font> y<font color=Cyan>)</font>
<a name="line-934"></a>
<a name="line-935"></a><a name="q_add_in_place_qulist"></a><font color=Blue><i>-- | Low-level implementation of 'q_add_in_place': represents integers</i></font>
<a name="line-936"></a><font color=Blue><i>-- as big-headian qubit lists.</i></font>
<a name="line-937"></a><font color=Blue>q_add_in_place_qulist</font> <font color=Red>::</font> <font color=Red>[</font>Qubit<font color=Red>]</font> <font color=Red>-&gt;</font> <font color=Red>[</font>Qubit<font color=Red>]</font> <font color=Red>-&gt;</font> Circ <font color=Cyan>(</font><font color=Red>[</font>Qubit<font color=Red>]</font><font color=Cyan>,</font> <font color=Red>[</font>Qubit<font color=Red>]</font><font color=Cyan>)</font>
<a name="line-938"></a><font color=Blue>q_add_in_place_qulist</font> [] [] <font color=Red>=</font> return <font color=Cyan>(</font>[]<font color=Cyan>,</font> []<font color=Cyan>)</font>
<a name="line-939"></a><font color=Blue>q_add_in_place_qulist</font> <font color=Red>[</font>x0<font color=Red>]</font> <font color=Red>[</font>y0<font color=Red>]</font> <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-940"></a>  y0 <font color=Red>&lt;-</font> qnot y0 <font color=Cyan>`controlled`</font> x0
<a name="line-941"></a>  return <font color=Cyan>(</font><font color=Red>[</font>x0<font color=Red>]</font><font color=Cyan>,</font> <font color=Red>[</font>y0<font color=Red>]</font><font color=Cyan>)</font>
<a name="line-942"></a><font color=Blue>q_add_in_place_qulist</font> x y <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-943"></a>  <font color=Green><u>let</u></font> <font color=Cyan>(</font>x0<font color=Red><b>:</b></font>x_higher<font color=Cyan>)</font> <font color=Red>=</font> reverse x  
<a name="line-944"></a>      <font color=Cyan>(</font>y0<font color=Red><b>:</b></font>y_higher<font color=Cyan>)</font> <font color=Red>=</font> reverse y
<a name="line-945"></a>
<a name="line-946"></a>  y0 <font color=Red>&lt;-</font> qnot y0 <font color=Cyan>`controlled`</font> x0
<a name="line-947"></a>
<a name="line-948"></a>  <font color=Cyan>(</font><font color=Cyan>(</font>x0<font color=Cyan>,</font>y0<font color=Cyan>)</font><font color=Cyan>,</font><font color=Cyan>(</font>x_higher<font color=Cyan>,</font>y_higher<font color=Cyan>)</font><font color=Cyan>)</font> <font color=Red>&lt;-</font> with_computed_fun <font color=Cyan>(</font>x0<font color=Cyan>,</font>y0<font color=Cyan>)</font>
<a name="line-949"></a>    <font color=Cyan>(</font><font color=Red>\</font><font color=Cyan>(</font>x0<font color=Cyan>,</font>y0<font color=Cyan>)</font> <font color=Red>-&gt;</font> <font color=Green><u>do</u></font>
<a name="line-950"></a>      c <font color=Red>&lt;-</font> qinit False
<a name="line-951"></a>      c <font color=Red>&lt;-</font> qnot c <font color=Cyan>`controlled`</font> <font color=Cyan>(</font>x0 <font color=Cyan>.==.</font> <font color=Magenta>1</font><font color=Cyan>)</font> <font color=Cyan>.&amp;&amp;.</font> <font color=Cyan>(</font>y0 <font color=Cyan>.==.</font> <font color=Magenta>0</font><font color=Cyan>)</font>
<a name="line-952"></a>      return <font color=Cyan>(</font>x0<font color=Cyan>,</font>y0<font color=Cyan>,</font>c<font color=Cyan>)</font><font color=Cyan>)</font>
<a name="line-953"></a>    <font color=Cyan>(</font><font color=Red>\</font><font color=Cyan>(</font>x0<font color=Cyan>,</font>y0<font color=Cyan>,</font>c<font color=Cyan>)</font> <font color=Red>-&gt;</font> <font color=Green><u>do</u></font>
<a name="line-954"></a>      <font color=Cyan>(</font>x_higher<font color=Cyan>,</font>y_higher<font color=Cyan>,</font>c<font color=Cyan>)</font> <font color=Red>&lt;-</font> q_add_aux <font color=Cyan>(</font>x_higher<font color=Cyan>)</font> <font color=Cyan>(</font>y_higher<font color=Cyan>)</font> c
<a name="line-955"></a>      return <font color=Cyan>(</font><font color=Cyan>(</font>x0<font color=Cyan>,</font>y0<font color=Cyan>,</font>c<font color=Cyan>)</font><font color=Cyan>,</font><font color=Cyan>(</font>x_higher<font color=Cyan>,</font>y_higher<font color=Cyan>)</font><font color=Cyan>)</font><font color=Cyan>)</font>
<a name="line-956"></a>  return <font color=Cyan>(</font>reverse <font color=Cyan>(</font>x0<font color=Red><b>:</b></font>x_higher<font color=Cyan>)</font><font color=Cyan>,</font> reverse <font color=Cyan>(</font>y0<font color=Red><b>:</b></font>y_higher<font color=Cyan>)</font><font color=Cyan>)</font>
<a name="line-957"></a>  <font color=Green><u>where</u></font>
<a name="line-958"></a>  <font color=Blue><i>-- Aux: add two LITTLE-endian bit strings, and an optional extra 1.</i></font>
<a name="line-959"></a>    q_add_aux <font color=Red>::</font> <font color=Red>[</font>Qubit<font color=Red>]</font> <font color=Red>-&gt;</font> <font color=Red>[</font>Qubit<font color=Red>]</font> <font color=Red>-&gt;</font> Qubit <font color=Red>-&gt;</font> Circ <font color=Cyan>(</font><font color=Red>[</font>Qubit<font color=Red>]</font><font color=Cyan>,</font><font color=Red>[</font>Qubit<font color=Red>]</font><font color=Cyan>,</font>Qubit<font color=Cyan>)</font>
<a name="line-960"></a>    q_add_aux [] [] c <font color=Red>=</font> return <font color=Cyan>(</font>[]<font color=Cyan>,</font>[]<font color=Cyan>,</font>c<font color=Cyan>)</font>
<a name="line-961"></a>    q_add_aux <font color=Red>[</font>x0<font color=Red>]</font> <font color=Red>[</font>y0<font color=Red>]</font> c <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-962"></a>      y0 <font color=Red>&lt;-</font> qnot y0 <font color=Cyan>`controlled`</font> x0
<a name="line-963"></a>      y0 <font color=Red>&lt;-</font> qnot y0 <font color=Cyan>`controlled`</font> c
<a name="line-964"></a>      return <font color=Cyan>(</font><font color=Red>[</font>x0<font color=Red>]</font><font color=Cyan>,</font><font color=Red>[</font>y0<font color=Red>]</font><font color=Cyan>,</font>c<font color=Cyan>)</font>
<a name="line-965"></a>    q_add_aux <font color=Cyan>(</font>x0<font color=Red><b>:</b></font>xs<font color=Cyan>)</font> <font color=Cyan>(</font>y0<font color=Red><b>:</b></font>ys<font color=Cyan>)</font> c <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-966"></a>      y0 <font color=Red>&lt;-</font> qnot y0 <font color=Cyan>`controlled`</font> x0
<a name="line-967"></a>      y0 <font color=Red>&lt;-</font> qnot y0 <font color=Cyan>`controlled`</font> c
<a name="line-968"></a>      <font color=Cyan>(</font><font color=Cyan>(</font>x0<font color=Cyan>,</font>y0<font color=Cyan>,</font>c<font color=Cyan>)</font><font color=Cyan>,</font><font color=Cyan>(</font>xs<font color=Cyan>,</font>ys<font color=Cyan>)</font><font color=Cyan>)</font> <font color=Red>&lt;-</font> with_computed_fun <font color=Cyan>(</font>x0<font color=Cyan>,</font>y0<font color=Cyan>,</font>c<font color=Cyan>)</font>
<a name="line-969"></a>        <font color=Cyan>(</font><font color=Red>\</font><font color=Cyan>(</font>x0<font color=Cyan>,</font>y0<font color=Cyan>,</font>c<font color=Cyan>)</font> <font color=Red>-&gt;</font> <font color=Green><u>do</u></font>
<a name="line-970"></a>          c' <font color=Red>&lt;-</font> qinit False
<a name="line-971"></a>          c' <font color=Red>&lt;-</font> qnot c' <font color=Cyan>`controlled`</font> <font color=Cyan>(</font>x0 <font color=Cyan>.==.</font> <font color=Magenta>1</font><font color=Cyan>)</font> <font color=Cyan>.&amp;&amp;.</font> <font color=Cyan>(</font>y0 <font color=Cyan>.==.</font> <font color=Magenta>0</font><font color=Cyan>)</font>
<a name="line-972"></a>          c' <font color=Red>&lt;-</font> qnot c' <font color=Cyan>`controlled`</font> <font color=Cyan>(</font>x0 <font color=Cyan>.==.</font> <font color=Magenta>1</font><font color=Cyan>)</font> <font color=Cyan>.&amp;&amp;.</font> <font color=Cyan>(</font>c <font color=Cyan>.==.</font> <font color=Magenta>1</font><font color=Cyan>)</font>
<a name="line-973"></a>          c' <font color=Red>&lt;-</font> qnot c' <font color=Cyan>`controlled`</font> <font color=Cyan>(</font>y0 <font color=Cyan>.==.</font> <font color=Magenta>0</font><font color=Cyan>)</font> <font color=Cyan>.&amp;&amp;.</font> <font color=Cyan>(</font>c <font color=Cyan>.==.</font> <font color=Magenta>1</font><font color=Cyan>)</font>
<a name="line-974"></a>          return <font color=Cyan>(</font>x0<font color=Cyan>,</font>y0<font color=Cyan>,</font>c<font color=Cyan>,</font>c'<font color=Cyan>)</font><font color=Cyan>)</font>
<a name="line-975"></a>        
<a name="line-976"></a>        <font color=Cyan>(</font><font color=Red>\</font><font color=Cyan>(</font>x0<font color=Cyan>,</font>y0<font color=Cyan>,</font>c<font color=Cyan>,</font>c'<font color=Cyan>)</font> <font color=Red>-&gt;</font> <font color=Green><u>do</u></font>
<a name="line-977"></a>          <font color=Cyan>(</font>xs<font color=Cyan>,</font>ys<font color=Cyan>,</font>c'<font color=Cyan>)</font> <font color=Red>&lt;-</font> q_add_aux xs ys c'
<a name="line-978"></a>          return <font color=Cyan>(</font><font color=Cyan>(</font>x0<font color=Cyan>,</font>y0<font color=Cyan>,</font>c<font color=Cyan>,</font>c'<font color=Cyan>)</font><font color=Cyan>,</font><font color=Cyan>(</font>xs<font color=Cyan>,</font>ys<font color=Cyan>)</font><font color=Cyan>)</font><font color=Cyan>)</font>
<a name="line-979"></a>      return <font color=Cyan>(</font>x0<font color=Red><b>:</b></font>xs<font color=Cyan>,</font>y0<font color=Red><b>:</b></font>ys<font color=Cyan>,</font>c<font color=Cyan>)</font>
<a name="line-980"></a>    q_add_aux <font color=Green><u>_</u></font> <font color=Green><u>_</u></font> <font color=Green><u>_</u></font> <font color=Red>=</font> error <font color=Magenta>"q_add_in_place: cannot add integers of different sizes."</font>
<a name="line-981"></a>
<a name="line-982"></a><a name="q_sub_in_place"></a><font color=Blue><i>-- | Subtract one 'QDInt' from a second, in place; i.e. (/x/,/y/) &#8614; (/x/,/y/&#8211;/x/).  Arguments are assumed to be of equal size.  /O/(&#8467;) gates.</i></font>
<a name="line-983"></a><font color=Blue>q_sub_in_place</font> <font color=Red>::</font> QDInt <font color=Red>-&gt;</font> QDInt <font color=Red>-&gt;</font> Circ <font color=Cyan>(</font>QDInt<font color=Cyan>,</font>QDInt<font color=Cyan>)</font>
<a name="line-984"></a><font color=Blue>q_sub_in_place</font> x y <font color=Red>=</font> reverse_generic_endo <font color=Cyan>(</font><font color=Red>\</font><font color=Cyan>(</font>x<font color=Cyan>,</font>d<font color=Cyan>)</font> <font color=Red>-&gt;</font> q_add_in_place x d<font color=Cyan>)</font> <font color=Cyan>(</font>x<font color=Cyan>,</font>y<font color=Cyan>)</font>
<a name="line-985"></a>
<a name="line-986"></a><a name="q_sub_in_place_qulist"></a><font color=Blue><i>-- | Low-level version of 'q_sub_in_place': represents integers</i></font>
<a name="line-987"></a><font color=Blue><i>-- as big-headian qubit lists.</i></font>
<a name="line-988"></a><font color=Blue>q_sub_in_place_qulist</font> <font color=Red>::</font> <font color=Red>[</font>Qubit<font color=Red>]</font> <font color=Red>-&gt;</font> <font color=Red>[</font>Qubit<font color=Red>]</font> <font color=Red>-&gt;</font> Circ <font color=Cyan>(</font><font color=Red>[</font>Qubit<font color=Red>]</font><font color=Cyan>,</font><font color=Red>[</font>Qubit<font color=Red>]</font><font color=Cyan>)</font>
<a name="line-989"></a><font color=Blue>q_sub_in_place_qulist</font> x y <font color=Red>=</font> reverse_generic_endo <font color=Cyan>(</font><font color=Red>\</font><font color=Cyan>(</font>x<font color=Cyan>,</font>d<font color=Cyan>)</font> <font color=Red>-&gt;</font> q_add_in_place_qulist x d<font color=Cyan>)</font> <font color=Cyan>(</font>x<font color=Cyan>,</font>y<font color=Cyan>)</font>
<a name="line-990"></a>
<a name="line-991"></a><font color=Blue><i>-- ----------------------------------------------------------------------</i></font>
<a name="line-992"></a><font color=Blue><i>-- ** Arithmetic with parameters</i></font>
<a name="line-993"></a>
<a name="line-994"></a><a name="q_add_param"></a><font color=Blue><i>-- | Add a parameter 'IntM' and a 'QDInt', into a fresh 'QDInt': (/x/, /y/) &#8614; (/y/, /x/+/y/).  The parameter /x/ must be of the same length as /y/, or /x/ can also be of undetermined length.  /O/(&#8467;).</i></font>
<a name="line-995"></a><font color=Blue>q_add_param</font> <font color=Red>::</font> IntM <font color=Red>-&gt;</font> QDInt <font color=Red>-&gt;</font> Circ <font color=Cyan>(</font>QDInt<font color=Cyan>,</font>QDInt<font color=Cyan>)</font>
<a name="line-996"></a><font color=Blue>q_add_param</font> x1 y <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-997"></a>  <font color=Green><u>let</u></font> x <font color=Red>=</font> intm_promote x1 y <font color=Magenta>"q_add_param: inputs must have equal length"</font>
<a name="line-998"></a>  <font color=Green><u>let</u></font> x' <font color=Red>=</font> boollist_of_intm_bh x
<a name="line-999"></a>  <font color=Green><u>let</u></font> y' <font color=Red>=</font> list_of_xint_bh y
<a name="line-1000"></a>  <font color=Cyan>(</font>y'<font color=Cyan>,</font> z'<font color=Cyan>)</font> <font color=Red>&lt;-</font> q_add_param_qulist x' y'
<a name="line-1001"></a>  <font color=Green><u>let</u></font> y <font color=Red>=</font> xint_of_list_bh y'
<a name="line-1002"></a>  <font color=Green><u>let</u></font> z <font color=Red>=</font> xint_of_list_bh z'
<a name="line-1003"></a>  return <font color=Cyan>(</font>y<font color=Cyan>,</font> z<font color=Cyan>)</font>
<a name="line-1004"></a>  
<a name="line-1005"></a><a name="q_add_param_qulist"></a><font color=Blue><i>-- | Low-level implementation of 'q_add_param': represents integers as</i></font>
<a name="line-1006"></a><font color=Blue><i>-- big-headian qubit lists. Precondition: /x/ and /y/ have the same length.</i></font>
<a name="line-1007"></a><font color=Blue>q_add_param_qulist</font> <font color=Red>::</font> <font color=Red>[</font>Bool<font color=Red>]</font> <font color=Red>-&gt;</font> <font color=Red>[</font>Qubit<font color=Red>]</font> <font color=Red>-&gt;</font> Circ <font color=Cyan>(</font><font color=Red>[</font>Qubit<font color=Red>]</font><font color=Cyan>,</font> <font color=Red>[</font>Qubit<font color=Red>]</font><font color=Cyan>)</font>
<a name="line-1008"></a><font color=Blue>q_add_param_qulist</font> x y <font color=Red>=</font> <font color=Green><u>do</u></font> 
<a name="line-1009"></a>  <font color=Blue><i>-- Implementation note: compare with q_add_qdint.  The code is almost verbatim identical, but since x consists of parameter Bools, `controlled` will omit gates when appropriate.</i></font>
<a name="line-1010"></a>
<a name="line-1011"></a>  <font color=Blue><i>-- Further slight optimisation would be possible, since if x doesn&#8217;t have low bits then no low carry qubits are required. </i></font>
<a name="line-1012"></a>
<a name="line-1013"></a>  <font color=Blue><i>-- Implementation note: once we have a general-purpose classical</i></font>
<a name="line-1014"></a>  <font color=Blue><i>-- circuit optimizer (even a primitive one), then this kind of</i></font>
<a name="line-1015"></a>  <font color=Blue><i>-- source-code level optimization will hopefully become moot.</i></font>
<a name="line-1016"></a>  
<a name="line-1017"></a>  <font color=Green><u>let</u></font> l <font color=Red>=</font> length x
<a name="line-1018"></a>
<a name="line-1019"></a>  <font color=Cyan>(</font>y<font color=Cyan>,</font>s_out<font color=Cyan>)</font> <font color=Red>&lt;-</font> with_computed_fun y
<a name="line-1020"></a>    <font color=Cyan>(</font><font color=Red>\</font>y <font color=Red>-&gt;</font> <font color=Green><u>do</u></font>
<a name="line-1021"></a>      s <font color=Red>&lt;-</font> qinit <font color=Cyan>(</font>replicate l False<font color=Cyan>)</font> <font color=Blue><i>-- holds the eventual sum</i></font>
<a name="line-1022"></a>      c <font color=Red>&lt;-</font> qinit <font color=Cyan>(</font>replicate l False<font color=Cyan>)</font> <font color=Blue><i>-- holds the carries</i></font>
<a name="line-1023"></a>
<a name="line-1024"></a>      <font color=Blue><i>-- bring the lists&#8217; indexing in line with usual numeric indexing of binary expansons</i></font>
<a name="line-1025"></a>      x <font color=Red>&lt;-</font> return <font color=Cyan>$</font> reverse x
<a name="line-1026"></a>      y <font color=Red>&lt;-</font> return <font color=Cyan>$</font> reverse y
<a name="line-1027"></a>      s <font color=Red>&lt;-</font> return <font color=Cyan>$</font> reverse s
<a name="line-1028"></a>      c <font color=Red>&lt;-</font> return <font color=Cyan>$</font> reverse c
<a name="line-1029"></a>
<a name="line-1030"></a>      <font color=Cyan>(</font>y<font color=Cyan>,</font>s<font color=Cyan>,</font>c<font color=Cyan>)</font> <font color=Red>&lt;-</font> loop_with_indexM <font color=Cyan>(</font>l<font color=Blue><i>-</i></font><font color=Magenta>1</font><font color=Cyan>)</font> <font color=Cyan>(</font>y<font color=Cyan>,</font>s<font color=Cyan>,</font>c<font color=Cyan>)</font> <font color=Cyan>(</font><font color=Red>\</font>j <font color=Cyan>(</font>y<font color=Cyan>,</font>s<font color=Cyan>,</font>c<font color=Cyan>)</font> <font color=Red>-&gt;</font> <font color=Green><u>do</u></font>
<a name="line-1031"></a>        <font color=Green><u>let</u></font> c_j1 <font color=Red>=</font> c <font color=Cyan>!!</font> <font color=Cyan>(</font>j<font color=Cyan>+</font><font color=Magenta>1</font><font color=Cyan>)</font>
<a name="line-1032"></a>        <font color=Green><u>let</u></font> s_j <font color=Red>=</font> s <font color=Cyan>!!</font> j
<a name="line-1033"></a>        <font color=Blue><i>-- If any two of the current bits x_j, y_j, and the carry c_j are true, then set the next carry:</i></font>
<a name="line-1034"></a>        <font color=Blue><i>-- (Note: we use that (a &amp; b) xor (a &amp; c) xor (b &amp; c) == (a &amp; b) or (a &amp; c) or (b &amp; c).)</i></font>
<a name="line-1035"></a>        c_j1 <font color=Red>&lt;-</font> qnot c_j1 <font color=Cyan>`controlled`</font> <font color=Cyan>(</font>x<font color=Cyan>!!</font>j <font color=Cyan>.&amp;&amp;.</font> y<font color=Cyan>!!</font>j<font color=Cyan>)</font>
<a name="line-1036"></a>        c_j1 <font color=Red>&lt;-</font> qnot c_j1 <font color=Cyan>`controlled`</font> <font color=Cyan>(</font>x<font color=Cyan>!!</font>j <font color=Cyan>.&amp;&amp;.</font> c<font color=Cyan>!!</font>j<font color=Cyan>)</font>
<a name="line-1037"></a>        c_j1 <font color=Red>&lt;-</font> qnot c_j1 <font color=Cyan>`controlled`</font> <font color=Cyan>(</font>y<font color=Cyan>!!</font>j <font color=Cyan>.&amp;&amp;.</font> c<font color=Cyan>!!</font>j<font color=Cyan>)</font>
<a name="line-1038"></a>        <font color=Blue><i>-- Now the current sum digit is computed mod 2:</i></font>
<a name="line-1039"></a>        s_j <font color=Red>&lt;-</font> qnot s_j <font color=Cyan>`controlled`</font> <font color=Cyan>(</font>x<font color=Cyan>!!</font>j<font color=Cyan>)</font>
<a name="line-1040"></a>        s_j <font color=Red>&lt;-</font> qnot s_j <font color=Cyan>`controlled`</font> <font color=Cyan>(</font>y<font color=Cyan>!!</font>j<font color=Cyan>)</font>
<a name="line-1041"></a>        s_j <font color=Red>&lt;-</font> qnot s_j <font color=Cyan>`controlled`</font> <font color=Cyan>(</font>c<font color=Cyan>!!</font>j<font color=Cyan>)</font> 
<a name="line-1042"></a>        c <font color=Red>&lt;-</font> return <font color=Cyan>$</font> overwriteAt <font color=Cyan>(</font>j<font color=Cyan>+</font><font color=Magenta>1</font><font color=Cyan>)</font> c_j1 c
<a name="line-1043"></a>        s <font color=Red>&lt;-</font> return <font color=Cyan>$</font> overwriteAt j s_j s
<a name="line-1044"></a>
<a name="line-1045"></a>        return <font color=Cyan>(</font>y<font color=Cyan>,</font>s<font color=Cyan>,</font>c<font color=Cyan>)</font><font color=Cyan>)</font>
<a name="line-1046"></a>
<a name="line-1047"></a>      <font color=Blue><i>-- Final sum digit; no carry required:</i></font>
<a name="line-1048"></a>      <font color=Green><u>let</u></font> s_l1 <font color=Red>=</font> s <font color=Cyan>!!</font> <font color=Cyan>(</font>l<font color=Blue><i>-</i></font><font color=Magenta>1</font><font color=Cyan>)</font>
<a name="line-1049"></a>      s_l1 <font color=Red>&lt;-</font> qnot s_l1 <font color=Cyan>`controlled`</font> <font color=Cyan>(</font>x<font color=Cyan>!!</font><font color=Cyan>(</font>l<font color=Blue><i>-</i></font><font color=Magenta>1</font><font color=Cyan>)</font><font color=Cyan>)</font>
<a name="line-1050"></a>      s_l1 <font color=Red>&lt;-</font> qnot s_l1 <font color=Cyan>`controlled`</font> <font color=Cyan>(</font>y<font color=Cyan>!!</font><font color=Cyan>(</font>l<font color=Blue><i>-</i></font><font color=Magenta>1</font><font color=Cyan>)</font><font color=Cyan>)</font>
<a name="line-1051"></a>      s_l1 <font color=Red>&lt;-</font> qnot s_l1 <font color=Cyan>`controlled`</font> <font color=Cyan>(</font>c<font color=Cyan>!!</font><font color=Cyan>(</font>l<font color=Blue><i>-</i></font><font color=Magenta>1</font><font color=Cyan>)</font><font color=Cyan>)</font> 
<a name="line-1052"></a>      s <font color=Red>&lt;-</font> return <font color=Cyan>$</font> overwriteAt <font color=Cyan>(</font>l<font color=Blue><i>-</i></font><font color=Magenta>1</font><font color=Cyan>)</font> s_l1 s
<a name="line-1053"></a>     
<a name="line-1054"></a>      x <font color=Red>&lt;-</font> return <font color=Cyan>$</font> reverse x
<a name="line-1055"></a>      y <font color=Red>&lt;-</font> return <font color=Cyan>$</font> reverse y
<a name="line-1056"></a>      s <font color=Red>&lt;-</font> return <font color=Cyan>$</font> reverse s
<a name="line-1057"></a>      c <font color=Red>&lt;-</font> return <font color=Cyan>$</font> reverse c
<a name="line-1058"></a>
<a name="line-1059"></a>      return <font color=Cyan>(</font>y<font color=Cyan>,</font>s<font color=Cyan>,</font>c<font color=Cyan>)</font><font color=Cyan>)</font>
<a name="line-1060"></a>    
<a name="line-1061"></a>    <font color=Cyan>(</font><font color=Red>\</font><font color=Cyan>(</font>y<font color=Cyan>,</font>s<font color=Cyan>,</font>c<font color=Cyan>)</font> <font color=Red>-&gt;</font> <font color=Green><u>do</u></font>
<a name="line-1062"></a>      <font color=Cyan>(</font>s<font color=Cyan>,</font>s_out<font color=Cyan>)</font> <font color=Red>&lt;-</font> qc_copy_fun s
<a name="line-1063"></a>      return <font color=Cyan>(</font><font color=Cyan>(</font>y<font color=Cyan>,</font>s<font color=Cyan>,</font>c<font color=Cyan>)</font><font color=Cyan>,</font> s_out<font color=Cyan>)</font><font color=Cyan>)</font>
<a name="line-1064"></a>  return <font color=Cyan>(</font>y<font color=Cyan>,</font> s_out<font color=Cyan>)</font>
<a name="line-1065"></a>
<a name="line-1066"></a><a name="q_sub_param"></a><font color=Blue><i>-- | Subtract a parameter 'IntM' from a 'QDInt', into a fresh 'QDInt'.  The 'IntM' cannot be shorter than the 'QDInt' (that would give ill-defined behavior), but can be of undetermined length.  /O/(&#8467;).</i></font>
<a name="line-1067"></a><font color=Blue>q_sub_param</font> <font color=Red>::</font> IntM <font color=Red>-&gt;</font> QDInt <font color=Red>-&gt;</font> Circ <font color=Cyan>(</font>QDInt<font color=Cyan>,</font>QDInt<font color=Cyan>)</font>
<a name="line-1068"></a><font color=Blue>q_sub_param</font> x y <font color=Red>=</font> q_add_param <font color=Cyan>(</font><font color=Blue><i>-</i></font>x<font color=Cyan>)</font> y
<a name="line-1069"></a>
<a name="line-1070"></a><a name="q_add_param_in_place"></a><font color=Blue><i>-- | Add a parameter 'IntM' onto a 'QDInt', in place; i.e. (/x/,/y/) &#8614; /x/+/y/. The parameter /x/ must be of the same length as /y/, or /x/ can also be of undetermined length.  /O/(&#8467;).</i></font>
<a name="line-1071"></a><font color=Blue>q_add_param_in_place</font> <font color=Red>::</font> IntM <font color=Red>-&gt;</font> QDInt <font color=Red>-&gt;</font> Circ QDInt
<a name="line-1072"></a><font color=Blue>q_add_param_in_place</font> x1 y <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-1073"></a>  <font color=Green><u>let</u></font> x <font color=Red>=</font> intm_promote x1 y <font color=Magenta>"q_add_param_in_place: inputs must have equal length"</font>
<a name="line-1074"></a>  <font color=Green><u>let</u></font> x' <font color=Red>=</font> boollist_of_intm_bh x
<a name="line-1075"></a>  <font color=Green><u>let</u></font> y' <font color=Red>=</font> list_of_xint_bh y
<a name="line-1076"></a>  y' <font color=Red>&lt;-</font> q_add_param_in_place_qulist x' y'
<a name="line-1077"></a>  <font color=Green><u>let</u></font> y <font color=Red>=</font> xint_of_list_bh y'
<a name="line-1078"></a>  return y
<a name="line-1079"></a>
<a name="line-1080"></a><a name="q_add_param_in_place_qulist"></a><font color=Blue><i>-- | Low-level implementation of 'q_add_param_in_place': represents</i></font>
<a name="line-1081"></a><font color=Blue><i>-- integers as big-headian qubit lists. Precondition: /xlist/ and /y/</i></font>
<a name="line-1082"></a><font color=Blue><i>-- have the same length. Precondition: /x/ and /y/ have the same length.</i></font>
<a name="line-1083"></a><font color=Blue>q_add_param_in_place_qulist</font> <font color=Red>::</font> <font color=Red>[</font>Bool<font color=Red>]</font> <font color=Red>-&gt;</font> <font color=Red>[</font>Qubit<font color=Red>]</font> <font color=Red>-&gt;</font> Circ <font color=Red>[</font>Qubit<font color=Red>]</font>
<a name="line-1084"></a><font color=Blue>q_add_param_in_place_qulist</font> [] [] <font color=Red>=</font> return []
<a name="line-1085"></a><font color=Blue>q_add_param_in_place_qulist</font> <font color=Red>[</font>False<font color=Red>]</font> <font color=Red>[</font>y0<font color=Red>]</font> <font color=Red>=</font> return <font color=Red>[</font>y0<font color=Red>]</font>
<a name="line-1086"></a><font color=Blue>q_add_param_in_place_qulist</font> <font color=Red>[</font>True<font color=Red>]</font> <font color=Red>[</font>y0<font color=Red>]</font> <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-1087"></a>  y0 <font color=Red>&lt;-</font> qnot y0
<a name="line-1088"></a>  return <font color=Red>[</font>y0<font color=Red>]</font>
<a name="line-1089"></a><font color=Blue>q_add_param_in_place_qulist</font> x y <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-1090"></a>  <font color=Green><u>let</u></font> l <font color=Red>=</font> length x
<a name="line-1091"></a>
<a name="line-1092"></a>  <font color=Green><u>let</u></font> <font color=Cyan>(</font>x0<font color=Red><b>:</b></font>x_higher<font color=Cyan>)</font> <font color=Red>=</font> reverse x  
<a name="line-1093"></a>      <font color=Cyan>(</font>y0<font color=Red><b>:</b></font>y_higher<font color=Cyan>)</font> <font color=Red>=</font> reverse y
<a name="line-1094"></a>
<a name="line-1095"></a>  y0 <font color=Red>&lt;-</font> qnot y0 <font color=Cyan>`controlled`</font> x0
<a name="line-1096"></a>
<a name="line-1097"></a>  <font color=Cyan>(</font>y0<font color=Cyan>,</font>y_higher<font color=Cyan>)</font> <font color=Red>&lt;-</font> with_computed_fun y0
<a name="line-1098"></a>    <font color=Cyan>(</font><font color=Red>\</font>y0 <font color=Red>-&gt;</font> <font color=Green><u>do</u></font>
<a name="line-1099"></a>      c <font color=Red>&lt;-</font> qinit False
<a name="line-1100"></a>      c <font color=Red>&lt;-</font> qnot c <font color=Cyan>`controlled`</font> <font color=Cyan>(</font>x0 <font color=Cyan>==</font> <font color=Magenta>1</font><font color=Cyan>)</font> <font color=Cyan>.&amp;&amp;.</font> <font color=Cyan>(</font>y0 <font color=Cyan>.==.</font> <font color=Magenta>0</font><font color=Cyan>)</font>
<a name="line-1101"></a>      return <font color=Cyan>(</font>y0<font color=Cyan>,</font>c<font color=Cyan>)</font><font color=Cyan>)</font>
<a name="line-1102"></a>    <font color=Cyan>(</font><font color=Red>\</font><font color=Cyan>(</font>y0<font color=Cyan>,</font>c<font color=Cyan>)</font> <font color=Red>-&gt;</font> <font color=Green><u>do</u></font>
<a name="line-1103"></a>      <font color=Cyan>(</font>y_higher<font color=Cyan>,</font>c<font color=Cyan>)</font> <font color=Red>&lt;-</font> q_add_aux x_higher y_higher c
<a name="line-1104"></a>      return <font color=Cyan>(</font><font color=Cyan>(</font>y0<font color=Cyan>,</font>c<font color=Cyan>)</font><font color=Cyan>,</font>y_higher<font color=Cyan>)</font><font color=Cyan>)</font>
<a name="line-1105"></a>  return <font color=Cyan>(</font>reverse <font color=Cyan>(</font>y0<font color=Red><b>:</b></font>y_higher<font color=Cyan>)</font><font color=Cyan>)</font>
<a name="line-1106"></a>  <font color=Green><u>where</u></font>
<a name="line-1107"></a>  <font color=Blue><i>-- Aux: add two LITTLE-endian bit strings, and an optional extra 1.</i></font>
<a name="line-1108"></a>    q_add_aux <font color=Red>::</font> <font color=Red>[</font>Bool<font color=Red>]</font> <font color=Red>-&gt;</font> <font color=Red>[</font>Qubit<font color=Red>]</font> <font color=Red>-&gt;</font> Qubit <font color=Red>-&gt;</font> Circ <font color=Cyan>(</font><font color=Red>[</font>Qubit<font color=Red>]</font><font color=Cyan>,</font>Qubit<font color=Cyan>)</font>
<a name="line-1109"></a>    q_add_aux [] [] c <font color=Red>=</font> return <font color=Cyan>(</font>[]<font color=Cyan>,</font>c<font color=Cyan>)</font>
<a name="line-1110"></a>    q_add_aux <font color=Red>[</font>x0<font color=Red>]</font> <font color=Red>[</font>y0<font color=Red>]</font> c <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-1111"></a>      y0 <font color=Red>&lt;-</font> qnot y0 <font color=Cyan>`controlled`</font> x0
<a name="line-1112"></a>      y0 <font color=Red>&lt;-</font> qnot y0 <font color=Cyan>`controlled`</font> c
<a name="line-1113"></a>      return <font color=Cyan>(</font><font color=Red>[</font>y0<font color=Red>]</font><font color=Cyan>,</font>c<font color=Cyan>)</font>
<a name="line-1114"></a>    q_add_aux <font color=Cyan>(</font>x0<font color=Red><b>:</b></font>xs<font color=Cyan>)</font> <font color=Cyan>(</font>y0<font color=Red><b>:</b></font>ys<font color=Cyan>)</font> c <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-1115"></a>      y0 <font color=Red>&lt;-</font> qnot y0 <font color=Cyan>`controlled`</font> x0
<a name="line-1116"></a>      y0 <font color=Red>&lt;-</font> qnot y0 <font color=Cyan>`controlled`</font> c
<a name="line-1117"></a>      <font color=Cyan>(</font><font color=Cyan>(</font>y0<font color=Cyan>,</font>c<font color=Cyan>)</font><font color=Cyan>,</font>ys<font color=Cyan>)</font> <font color=Red>&lt;-</font> with_computed_fun <font color=Cyan>(</font>y0<font color=Cyan>,</font>c<font color=Cyan>)</font>
<a name="line-1118"></a>        <font color=Cyan>(</font><font color=Red>\</font><font color=Cyan>(</font>y0<font color=Cyan>,</font>c<font color=Cyan>)</font> <font color=Red>-&gt;</font> <font color=Green><u>do</u></font>
<a name="line-1119"></a>          c' <font color=Red>&lt;-</font> qinit False
<a name="line-1120"></a>          c' <font color=Red>&lt;-</font> qnot c' <font color=Cyan>`controlled`</font> <font color=Cyan>(</font>x0 <font color=Cyan>==</font> <font color=Magenta>1</font><font color=Cyan>)</font> <font color=Cyan>.&amp;&amp;.</font> <font color=Cyan>(</font>y0 <font color=Cyan>.==.</font> <font color=Magenta>0</font><font color=Cyan>)</font>
<a name="line-1121"></a>          c' <font color=Red>&lt;-</font> qnot c' <font color=Cyan>`controlled`</font> <font color=Cyan>(</font>x0 <font color=Cyan>==</font> <font color=Magenta>1</font><font color=Cyan>)</font> <font color=Cyan>.&amp;&amp;.</font> <font color=Cyan>(</font>c <font color=Cyan>.==.</font> <font color=Magenta>1</font><font color=Cyan>)</font>
<a name="line-1122"></a>          c' <font color=Red>&lt;-</font> qnot c' <font color=Cyan>`controlled`</font> <font color=Cyan>(</font>y0 <font color=Cyan>.==.</font> <font color=Magenta>0</font><font color=Cyan>)</font> <font color=Cyan>.&amp;&amp;.</font> <font color=Cyan>(</font>c <font color=Cyan>.==.</font> <font color=Magenta>1</font><font color=Cyan>)</font>
<a name="line-1123"></a>          return <font color=Cyan>(</font>y0<font color=Cyan>,</font>c<font color=Cyan>,</font>c'<font color=Cyan>)</font><font color=Cyan>)</font>
<a name="line-1124"></a>        
<a name="line-1125"></a>        <font color=Cyan>(</font><font color=Red>\</font><font color=Cyan>(</font>y0<font color=Cyan>,</font>c<font color=Cyan>,</font>c'<font color=Cyan>)</font> <font color=Red>-&gt;</font> <font color=Green><u>do</u></font>
<a name="line-1126"></a>          <font color=Cyan>(</font>ys<font color=Cyan>,</font>c'<font color=Cyan>)</font> <font color=Red>&lt;-</font> q_add_aux xs ys c'
<a name="line-1127"></a>          return <font color=Cyan>(</font><font color=Cyan>(</font>y0<font color=Cyan>,</font>c<font color=Cyan>,</font>c'<font color=Cyan>)</font><font color=Cyan>,</font>ys<font color=Cyan>)</font><font color=Cyan>)</font>
<a name="line-1128"></a>      return <font color=Cyan>(</font>y0<font color=Red><b>:</b></font>ys<font color=Cyan>,</font>c<font color=Cyan>)</font>
<a name="line-1129"></a>    q_add_aux <font color=Green><u>_</u></font> <font color=Green><u>_</u></font> <font color=Green><u>_</u></font> <font color=Red>=</font> error <font color=Magenta>"q_add_in_place: cannot add integers of different sizes."</font>
<a name="line-1130"></a>
<a name="line-1131"></a><a name="q_sub_param_in_place"></a><font color=Blue><i>-- | Subtract a parameter 'IntM' from a 'QDInt', in place; i.e. (/x/,/y/) &#8614; (/x/,/x/-/y/).  /x/ cannot be shorter than /y/.  /O/(/l/) gates.</i></font>
<a name="line-1132"></a><font color=Blue>q_sub_param_in_place</font> <font color=Red>::</font> IntM <font color=Red>-&gt;</font> QDInt <font color=Red>-&gt;</font> Circ QDInt
<a name="line-1133"></a><font color=Blue>q_sub_param_in_place</font> x <font color=Red>=</font> q_add_param_in_place <font color=Cyan>(</font><font color=Blue><i>-</i></font>x<font color=Cyan>)</font>
<a name="line-1134"></a>
<a name="line-1135"></a><a name="q_mult_param"></a><font color=Blue><i>-- | Multiply a parameter 'IntM' by a 'QDInt', into a fresh 'QDInt'.  The 'IntM' cannot be shorter than the 'QDInt' (that would give ill-defined behavior), but can be of undetermined length.  /O/(&#8467;).</i></font>
<a name="line-1136"></a><font color=Blue>q_mult_param</font> <font color=Red>::</font> IntM <font color=Red>-&gt;</font> QDInt <font color=Red>-&gt;</font> Circ <font color=Cyan>(</font>QDInt<font color=Cyan>,</font>QDInt<font color=Cyan>)</font>
<a name="line-1137"></a><font color=Blue>q_mult_param</font> x1 y <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-1138"></a>  <font color=Green><u>let</u></font> x <font color=Red>=</font> intm_promote x1 y <font color=Magenta>"q_add_param: inputs must have equal length"</font>
<a name="line-1139"></a>  <font color=Green><u>let</u></font> x' <font color=Red>=</font> boollist_of_intm_bh x
<a name="line-1140"></a>  <font color=Green><u>let</u></font> y' <font color=Red>=</font> list_of_xint_bh y
<a name="line-1141"></a>  <font color=Cyan>(</font>y'<font color=Cyan>,</font> z'<font color=Cyan>)</font> <font color=Red>&lt;-</font> q_mult_param_qulist x' y'
<a name="line-1142"></a>  <font color=Green><u>let</u></font> y <font color=Red>=</font> xint_of_list_bh y'
<a name="line-1143"></a>  <font color=Green><u>let</u></font> z <font color=Red>=</font> xint_of_list_bh z'
<a name="line-1144"></a>  return <font color=Cyan>(</font>y<font color=Cyan>,</font> z<font color=Cyan>)</font>
<a name="line-1145"></a>
<a name="line-1146"></a><a name="q_mult_param_qulist"></a><font color=Blue><i>-- | Low-level implementation of 'q_mult_param': represents integers as</i></font>
<a name="line-1147"></a><font color=Blue><i>-- big-headian (qu)bit lists.</i></font>
<a name="line-1148"></a><font color=Blue>q_mult_param_qulist</font> <font color=Red>::</font> <font color=Red>[</font>Bool<font color=Red>]</font> <font color=Red>-&gt;</font> <font color=Red>[</font>Qubit<font color=Red>]</font> <font color=Red>-&gt;</font> Circ <font color=Cyan>(</font><font color=Red>[</font>Qubit<font color=Red>]</font><font color=Cyan>,</font><font color=Red>[</font>Qubit<font color=Red>]</font><font color=Cyan>)</font>
<a name="line-1149"></a><font color=Blue>q_mult_param_qulist</font> [] [] <font color=Red>=</font> return <font color=Cyan>(</font>[]<font color=Cyan>,</font> []<font color=Cyan>)</font>
<a name="line-1150"></a><font color=Blue>q_mult_param_qulist</font> xs ys <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-1151"></a>  <font color=Green><u>let</u></font> x0 <font color=Red>=</font> last xs 
<a name="line-1152"></a>      x_higher <font color=Red>=</font> init xs
<a name="line-1153"></a>      y_high <font color=Red>=</font> head ys
<a name="line-1154"></a>      y_lower <font color=Red>=</font> tail ys
<a name="line-1155"></a>  <font color=Cyan>(</font>y_lower<font color=Cyan>,</font> p_higher<font color=Cyan>)</font>
<a name="line-1156"></a>    <font color=Red>&lt;-</font> q_mult_param_qulist x_higher y_lower
<a name="line-1157"></a>  p0 <font color=Red>&lt;-</font> qinit False
<a name="line-1158"></a>  <font color=Green><u>let</u></font> y <font color=Red>=</font> y_high<font color=Red><b>:</b></font>y_lower
<a name="line-1159"></a>      p <font color=Red>=</font> p_higher <font color=Cyan>++</font> <font color=Red>[</font>p0<font color=Red>]</font>
<a name="line-1160"></a>  <font color=Blue><i>-- Once we have some optimisation, the following line should be replaced by:</i></font>
<a name="line-1161"></a>  <font color=Blue><i>-- (y,p) &lt;- q_add_in_place_qulist y p `controlled` x0</i></font>
<a name="line-1162"></a>  <font color=Cyan>(</font>y<font color=Cyan>,</font>p<font color=Cyan>)</font> <font color=Red>&lt;-</font> <font color=Green><u>if</u></font> x0 <font color=Green><u>then</u></font> q_add_in_place_qulist y p <font color=Green><u>else</u></font> return <font color=Cyan>(</font>y<font color=Cyan>,</font>p<font color=Cyan>)</font>
<a name="line-1163"></a>  return <font color=Cyan>(</font>y<font color=Cyan>,</font> p<font color=Cyan>)</font>  
<a name="line-1164"></a>
<a name="line-1165"></a><font color=Blue><i>-- ----------------------------------------------------------------------</i></font>
<a name="line-1166"></a><font color=Blue><i>-- ** Sign and negation</i></font>
<a name="line-1167"></a>
<a name="line-1168"></a><a name="q_negate_in_place"></a><font color=Blue><i>-- | Negate a (signed) 'QDInt' in place. /O/(&#8467;).</i></font>
<a name="line-1169"></a><font color=Blue>q_negate_in_place</font> <font color=Red>::</font> QDInt <font color=Red>-&gt;</font> Circ QDInt
<a name="line-1170"></a><font color=Blue>q_negate_in_place</font> x <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-1171"></a>  x <font color=Red>&lt;-</font> mapUnary qnot x
<a name="line-1172"></a>  x <font color=Red>&lt;-</font> q_increment x
<a name="line-1173"></a>  return x
<a name="line-1174"></a>
<a name="line-1175"></a><a name="q_negate_in_place_qulist"></a><font color=Blue><i>-- | Low-level version of 'q_negate_in_place': represents integers as</i></font>
<a name="line-1176"></a><font color=Blue><i>-- big-headian qubit lists.</i></font>
<a name="line-1177"></a><font color=Blue>q_negate_in_place_qulist</font> <font color=Red>::</font> <font color=Red>[</font>Qubit<font color=Red>]</font> <font color=Red>-&gt;</font> Circ <font color=Red>[</font>Qubit<font color=Red>]</font>
<a name="line-1178"></a><font color=Blue>q_negate_in_place_qulist</font> <font color=Red>=</font> mmap list_of_xint_bh <font color=Cyan>.</font> q_negate_in_place <font color=Cyan>.</font> xint_of_list_bh
<a name="line-1179"></a>
<a name="line-1180"></a><a name="q_negate_qdint"></a><font color=Blue><i>-- | Compute the negation of a (signed) 'QDInt'. /O/(&#8467;).</i></font>
<a name="line-1181"></a><font color=Blue><i>-- </i></font>
<a name="line-1182"></a><font color=Blue><i>-- (Fixes the minimum value, consistently with Haskell&#8217;s @'negate' 'minBound' :: 'Int'@.) </i></font>
<a name="line-1183"></a><font color=Blue>q_negate_qdint</font> <font color=Red>::</font> QDInt <font color=Red>-&gt;</font> Circ <font color=Cyan>(</font>QDInt<font color=Cyan>,</font>QDInt<font color=Cyan>)</font>
<a name="line-1184"></a><font color=Blue>q_negate_qdint</font> x <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-1185"></a>  <font color=Cyan>(</font>x<font color=Cyan>,</font>nx<font color=Cyan>)</font> <font color=Red>&lt;-</font> qc_copy_fun x
<a name="line-1186"></a>  nx <font color=Red>&lt;-</font> q_negate_in_place nx
<a name="line-1187"></a>  return <font color=Cyan>(</font>x<font color=Cyan>,</font>nx<font color=Cyan>)</font>
<a name="line-1188"></a>
<a name="line-1189"></a><a name="q_abs_qdint"></a><font color=Blue><i>-- | Compute the absolute value of a (signed) 'QDInt'.  /O/(&#8467;).</i></font>
<a name="line-1190"></a><font color=Blue><i>-- </i></font>
<a name="line-1191"></a><font color=Blue><i>-- (Fixes the minimum value, consistently with Haskell&#8217;s @'abs' 'minBound' :: 'Int'@.) </i></font>
<a name="line-1192"></a><font color=Blue>q_abs_qdint</font> <font color=Red>::</font> QDInt <font color=Red>-&gt;</font> Circ <font color=Cyan>(</font>QDInt<font color=Cyan>,</font>QDInt<font color=Cyan>)</font>
<a name="line-1193"></a><font color=Blue>q_abs_qdint</font> x <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-1194"></a>  <font color=Green><u>let</u></font> x' <font color=Red>=</font> list_of_xint_bh x
<a name="line-1195"></a>  <font color=Cyan>(</font>x'<font color=Cyan>,</font> a'<font color=Cyan>)</font> <font color=Red>&lt;-</font> q_abs_qulist x'
<a name="line-1196"></a>  <font color=Green><u>let</u></font> x <font color=Red>=</font> xint_of_list_bh x'
<a name="line-1197"></a>  <font color=Green><u>let</u></font> a <font color=Red>=</font> xint_of_list_bh a'
<a name="line-1198"></a>  return <font color=Cyan>(</font>x<font color=Cyan>,</font> a<font color=Cyan>)</font>
<a name="line-1199"></a>
<a name="line-1200"></a><a name="q_abs_qulist"></a><font color=Blue><i>-- | Low-level implementation of 'q_abs_qdint': represents integers as</i></font>
<a name="line-1201"></a><font color=Blue><i>-- big-headian qubit lists.</i></font>
<a name="line-1202"></a><font color=Blue>q_abs_qulist</font> <font color=Red>::</font> <font color=Red>[</font>Qubit<font color=Red>]</font> <font color=Red>-&gt;</font> Circ <font color=Cyan>(</font><font color=Red>[</font>Qubit<font color=Red>]</font><font color=Cyan>,</font><font color=Red>[</font>Qubit<font color=Red>]</font><font color=Cyan>)</font>
<a name="line-1203"></a><font color=Blue>q_abs_qulist</font> [] <font color=Red>=</font> return <font color=Cyan>(</font>[]<font color=Cyan>,</font> []<font color=Cyan>)</font>
<a name="line-1204"></a><font color=Blue>q_abs_qulist</font> <font color=Cyan>(</font>x_high<font color=Red><b>:</b></font>x_lower<font color=Cyan>)</font> <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-1205"></a>  a_high <font color=Red>&lt;-</font> qinit False
<a name="line-1206"></a>  <font color=Cyan>(</font>x_lower<font color=Cyan>,</font>a_lower<font color=Cyan>)</font> <font color=Red>&lt;-</font> qc_copy_fun x_lower
<a name="line-1207"></a>  a_lower <font color=Red>&lt;-</font> mapUnary qnot a_lower <font color=Cyan>`controlled`</font> x_high
<a name="line-1208"></a>  <font color=Green><u>let</u></font> a <font color=Red>=</font> a_high<font color=Red><b>:</b></font>a_lower
<a name="line-1209"></a>  a <font color=Red>&lt;-</font> q_increment_qulist a <font color=Cyan>`controlled`</font> x_high
<a name="line-1210"></a>  return <font color=Cyan>(</font>x_high<font color=Red><b>:</b></font>x_lower<font color=Cyan>,</font> a<font color=Cyan>)</font>
<a name="line-1211"></a>
<a name="line-1212"></a><a name="q_signum_qdint"></a><font color=Blue><i>-- | Compute a 'QDInt' of the same length as the input, with value 1, 0, or &#8211;1, depending on the sign of the input.  Analogous to Haskell&#8217;s 'signum'.  /O/(&#8467;).</i></font>
<a name="line-1213"></a><font color=Blue>q_signum_qdint</font> <font color=Red>::</font> QDInt <font color=Red>-&gt;</font> Circ <font color=Cyan>(</font>QDInt<font color=Cyan>,</font>QDInt<font color=Cyan>)</font>
<a name="line-1214"></a><font color=Blue>q_signum_qdint</font> x <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-1215"></a>  <font color=Green><u>let</u></font> x' <font color=Red>=</font> list_of_xint_bh x
<a name="line-1216"></a>  <font color=Cyan>(</font>x'<font color=Cyan>,</font> a'<font color=Cyan>)</font> <font color=Red>&lt;-</font> q_signum_qulist x'
<a name="line-1217"></a>  <font color=Green><u>let</u></font> x <font color=Red>=</font> xint_of_list_bh x'
<a name="line-1218"></a>  <font color=Green><u>let</u></font> a <font color=Red>=</font> xint_of_list_bh a'
<a name="line-1219"></a>  return <font color=Cyan>(</font>x<font color=Cyan>,</font> a<font color=Cyan>)</font>
<a name="line-1220"></a>
<a name="line-1221"></a><a name="q_signum_qulist"></a><font color=Blue><i>-- | Low-level implementation of 'q_abs_qdint': represents integers as</i></font>
<a name="line-1222"></a><font color=Blue><i>-- big-headian qubit lists.</i></font>
<a name="line-1223"></a><font color=Blue>q_signum_qulist</font> <font color=Red>::</font> <font color=Red>[</font>Qubit<font color=Red>]</font> <font color=Red>-&gt;</font> Circ <font color=Cyan>(</font><font color=Red>[</font>Qubit<font color=Red>]</font><font color=Cyan>,</font><font color=Red>[</font>Qubit<font color=Red>]</font><font color=Cyan>)</font>
<a name="line-1224"></a><font color=Blue>q_signum_qulist</font> [] <font color=Red>=</font> return <font color=Cyan>(</font>[]<font color=Cyan>,</font> []<font color=Cyan>)</font>
<a name="line-1225"></a><font color=Blue>q_signum_qulist</font> x <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-1226"></a>  <font color=Green><u>let</u></font> l <font color=Red>=</font> length x
<a name="line-1227"></a>  <font color=Cyan>(</font>s_higher<font color=Cyan>,</font> s_low<font color=Cyan>)</font> <font color=Red>&lt;-</font> qinit <font color=Cyan>(</font>replicate <font color=Cyan>(</font>l<font color=Blue><i>-</i></font><font color=Magenta>1</font><font color=Cyan>)</font> False<font color=Cyan>,</font> False<font color=Cyan>)</font>
<a name="line-1228"></a>  <font color=Blue><i>-- first set s = 1</i></font>
<a name="line-1229"></a>  s_low <font color=Red>&lt;-</font> qnot s_low
<a name="line-1230"></a>  <font color=Blue><i>-- case x &lt; 0: set s to -1 </i></font>
<a name="line-1231"></a>  s_higher <font color=Red>&lt;-</font> mapUnary qnot s_higher <font color=Cyan>`controlled`</font> <font color=Cyan>(</font>head x<font color=Cyan>)</font>
<a name="line-1232"></a>  <font color=Blue><i>-- case x = 0: reset s to 0</i></font>
<a name="line-1233"></a>  s_low <font color=Red>&lt;-</font> qnot s_low <font color=Cyan>`controlled`</font> <font color=Cyan>(</font>x <font color=Cyan>.==.</font> replicate l <font color=Magenta>0</font><font color=Cyan>)</font>
<a name="line-1234"></a>  return <font color=Cyan>(</font>x<font color=Cyan>,</font>s_higher <font color=Cyan>++</font> <font color=Red>[</font>s_low<font color=Red>]</font><font color=Cyan>)</font>
<a name="line-1235"></a>
<a name="line-1236"></a><font color=Blue><i>-- ----------------------------------------------------------------------</i></font>
<a name="line-1237"></a><font color=Blue><i>-- ** Comparison</i></font>
<a name="line-1238"></a>
<a name="line-1239"></a><a name="q_le_unsigned"></a><font color=Blue><i>-- | Comparison of two 'QDInt's, considered as unsigned.  /O/(&#8467;).</i></font>
<a name="line-1240"></a><font color=Blue>q_le_unsigned</font> <font color=Red>::</font> QDInt <font color=Red>-&gt;</font> QDInt <font color=Red>-&gt;</font> Circ <font color=Cyan>(</font>QDInt<font color=Cyan>,</font>QDInt<font color=Cyan>,</font>Qubit<font color=Cyan>)</font>
<a name="line-1241"></a><font color=Blue>q_le_unsigned</font> x y <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-1242"></a>  <font color=Green><u>let</u></font> x' <font color=Red>=</font> list_of_xint_bh x
<a name="line-1243"></a>  <font color=Green><u>let</u></font> y' <font color=Red>=</font> list_of_xint_bh y
<a name="line-1244"></a>  <font color=Cyan>(</font>x'<font color=Cyan>,</font>y'<font color=Cyan>,</font>le_out<font color=Cyan>)</font> <font color=Red>&lt;-</font> q_le_unsigned_qulist x' y'
<a name="line-1245"></a>  <font color=Green><u>let</u></font> x <font color=Red>=</font> xint_of_list_bh x'
<a name="line-1246"></a>  <font color=Green><u>let</u></font> y <font color=Red>=</font> xint_of_list_bh y'
<a name="line-1247"></a>  return <font color=Cyan>(</font>x<font color=Cyan>,</font>y<font color=Cyan>,</font>le_out<font color=Cyan>)</font>
<a name="line-1248"></a>
<a name="line-1249"></a><a name="q_le_unsigned_qulist"></a><font color=Blue><i>-- | Low-level implementation of 'q_le_unsigned': represents integers</i></font>
<a name="line-1250"></a><font color=Blue><i>-- as big-headian qubit lists.</i></font>
<a name="line-1251"></a><font color=Blue>q_le_unsigned_qulist</font> <font color=Red>::</font> <font color=Red>[</font>Qubit<font color=Red>]</font> <font color=Red>-&gt;</font> <font color=Red>[</font>Qubit<font color=Red>]</font> <font color=Red>-&gt;</font> Circ <font color=Cyan>(</font><font color=Red>[</font>Qubit<font color=Red>]</font><font color=Cyan>,</font><font color=Red>[</font>Qubit<font color=Red>]</font><font color=Cyan>,</font>Qubit<font color=Cyan>)</font>
<a name="line-1252"></a><font color=Blue>q_le_unsigned_qulist</font> x y <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-1253"></a>  <font color=Cyan>(</font><font color=Cyan>(</font>x<font color=Cyan>,</font>y<font color=Cyan>)</font><font color=Cyan>,</font>le_out<font color=Cyan>)</font> <font color=Red>&lt;-</font> with_computed_fun <font color=Cyan>(</font>x<font color=Cyan>,</font>y<font color=Cyan>)</font> q_le_unsigned_aux
<a name="line-1254"></a>    <font color=Cyan>(</font><font color=Red>\</font><font color=Cyan>(</font>x<font color=Cyan>,</font>y<font color=Cyan>,</font><font color=Cyan>(</font>le<font color=Red><b>:</b></font>garbage<font color=Cyan>)</font><font color=Cyan>)</font> <font color=Red>-&gt;</font> <font color=Green><u>do</u></font>
<a name="line-1255"></a>      <font color=Cyan>(</font>le<font color=Cyan>,</font>le_out<font color=Cyan>)</font> <font color=Red>&lt;-</font> qc_copy_fun le
<a name="line-1256"></a>      return <font color=Cyan>(</font><font color=Cyan>(</font>x<font color=Cyan>,</font>y<font color=Cyan>,</font><font color=Cyan>(</font>le<font color=Red><b>:</b></font>garbage<font color=Cyan>)</font><font color=Cyan>)</font><font color=Cyan>,</font>le_out<font color=Cyan>)</font><font color=Cyan>)</font>
<a name="line-1257"></a>  return <font color=Cyan>(</font>x<font color=Cyan>,</font>y<font color=Cyan>,</font>le_out<font color=Cyan>)</font>
<a name="line-1258"></a>
<a name="line-1259"></a><a name="q_le_unsigned_aux"></a><font color=Blue><i>-- | Same as 'q_le_unsigned', but uncurried, represents integers as</i></font>
<a name="line-1260"></a><font color=Blue><i>-- big-headian qubit lists, and doesn&#8217;t clean up its garbage.  (If</i></font>
<a name="line-1261"></a><font color=Blue><i>-- each recursive call cleans up its own garbage, gate use becomes</i></font>
<a name="line-1262"></a><font color=Blue><i>-- /O/(2[sup /n/]).)</i></font>
<a name="line-1263"></a><font color=Blue>q_le_unsigned_aux</font> <font color=Red>::</font> <font color=Cyan>(</font><font color=Red>[</font>Qubit<font color=Red>]</font><font color=Cyan>,</font> <font color=Red>[</font>Qubit<font color=Red>]</font><font color=Cyan>)</font> <font color=Red>-&gt;</font> Circ <font color=Cyan>(</font><font color=Red>[</font>Qubit<font color=Red>]</font><font color=Cyan>,</font><font color=Red>[</font>Qubit<font color=Red>]</font><font color=Cyan>,</font><font color=Red>[</font>Qubit<font color=Red>]</font><font color=Cyan>)</font>
<a name="line-1264"></a><font color=Blue>q_le_unsigned_aux</font> <font color=Cyan>(</font>[]<font color=Cyan>,</font> []<font color=Cyan>)</font> <font color=Red>=</font> <font color=Green><u>do</u></font> q <font color=Red>&lt;-</font> qinit True<font color=Cyan>;</font> return <font color=Cyan>(</font>[]<font color=Cyan>,</font> []<font color=Cyan>,</font> <font color=Red>[</font>q<font color=Red>]</font><font color=Cyan>)</font>
<a name="line-1265"></a><font color=Blue>q_le_unsigned_aux</font> <font color=Cyan>(</font>x_high<font color=Red><b>:</b></font>x_lower<font color=Cyan>,</font> y_high<font color=Red><b>:</b></font>y_lower<font color=Cyan>)</font> <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-1266"></a>  <font color=Blue><i>-- Classically, one would make the recursive call only if needed; but quantumly, it&#8217;s cheaper to do it unconditionally. </i></font>
<a name="line-1267"></a>  <font color=Cyan>(</font>x_lower<font color=Cyan>,</font> y_lower<font color=Cyan>,</font> le_lower<font color=Red><b>:</b></font>garbage<font color=Cyan>)</font> <font color=Red>&lt;-</font> q_le_unsigned_aux <font color=Cyan>(</font>x_lower<font color=Cyan>,</font> y_lower<font color=Cyan>)</font>
<a name="line-1268"></a>  <font color=Cyan>(</font>x_high<font color=Cyan>,</font>y_high<font color=Cyan>,</font>eq_high<font color=Cyan>)</font> <font color=Red>&lt;-</font> q_is_equal x_high y_high
<a name="line-1269"></a>  le <font color=Red>&lt;-</font> qinit False
<a name="line-1270"></a>  le <font color=Red>&lt;-</font> qnot le <font color=Cyan>`controlled`</font> <font color=Cyan>(</font>x_high <font color=Cyan>.==.</font> <font color=Magenta>0</font><font color=Cyan>)</font> <font color=Cyan>.&amp;&amp;.</font> <font color=Cyan>(</font>y_high <font color=Cyan>.==.</font> <font color=Magenta>1</font><font color=Cyan>)</font>
<a name="line-1271"></a>  le <font color=Red>&lt;-</font> qnot le <font color=Cyan>`controlled`</font> eq_high <font color=Cyan>.&amp;&amp;.</font> le_lower
<a name="line-1272"></a>  return <font color=Cyan>(</font>x_high<font color=Red><b>:</b></font>x_lower<font color=Cyan>,</font> y_high<font color=Red><b>:</b></font>y_lower<font color=Cyan>,</font> le<font color=Red><b>:</b></font>eq_high<font color=Red><b>:</b></font>le_lower<font color=Red><b>:</b></font>garbage<font color=Cyan>)</font>
<a name="line-1273"></a><font color=Blue>q_le_unsigned_aux</font> <font color=Green><u>_</u></font> <font color=Red>=</font> error <font color=Magenta>"q_le // QDInt: cannot compare QDInt&#8217;s of different lengths."</font>
<a name="line-1274"></a>
<a name="line-1275"></a><a name="q_le_signed"></a><font color=Blue><i>-- | Comparison of two 'QDInt's, considered as signed.  Used in @instance 'QOrd' 'QDInt'@.  /O/(&#8467;).</i></font>
<a name="line-1276"></a><font color=Blue>q_le_signed</font> <font color=Red>::</font> QDInt <font color=Red>-&gt;</font> QDInt <font color=Red>-&gt;</font> Circ <font color=Cyan>(</font>QDInt<font color=Cyan>,</font>QDInt<font color=Cyan>,</font>Qubit<font color=Cyan>)</font>
<a name="line-1277"></a><font color=Blue>q_le_signed</font> x y <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-1278"></a>  <font color=Green><u>let</u></font> x' <font color=Red>=</font> list_of_xint_bh x
<a name="line-1279"></a>  <font color=Green><u>let</u></font> y' <font color=Red>=</font> list_of_xint_bh y
<a name="line-1280"></a>  <font color=Cyan>(</font>x'<font color=Cyan>,</font>y'<font color=Cyan>,</font>le_out<font color=Cyan>)</font> <font color=Red>&lt;-</font> q_le_signed_qulist x' y'
<a name="line-1281"></a>  <font color=Green><u>let</u></font> x <font color=Red>=</font> xint_of_list_bh x'
<a name="line-1282"></a>  <font color=Green><u>let</u></font> y <font color=Red>=</font> xint_of_list_bh y'
<a name="line-1283"></a>  return <font color=Cyan>(</font>x<font color=Cyan>,</font>y<font color=Cyan>,</font>le_out<font color=Cyan>)</font>
<a name="line-1284"></a>
<a name="line-1285"></a><font color=Blue><i>-- | Low-level implementation of 'q_le_signed': represents integers</i></font>
<a name="line-1286"></a><font color=Blue><i>-- as big-headian qubit lists.</i></font>
<a name="line-1287"></a>
<a name="line-1288"></a><a name="q_le_signed_qulist"></a><font color=Blue><i>-- Implementation note: defined in terms of q_le_unsigned_aux</i></font>
<a name="line-1289"></a><font color=Blue>q_le_signed_qulist</font> <font color=Red>::</font> <font color=Red>[</font>Qubit<font color=Red>]</font> <font color=Red>-&gt;</font> <font color=Red>[</font>Qubit<font color=Red>]</font> <font color=Red>-&gt;</font> Circ <font color=Cyan>(</font><font color=Red>[</font>Qubit<font color=Red>]</font><font color=Cyan>,</font><font color=Red>[</font>Qubit<font color=Red>]</font><font color=Cyan>,</font>Qubit<font color=Cyan>)</font>
<a name="line-1290"></a><font color=Blue>q_le_signed_qulist</font> [] [] <font color=Red>=</font> <font color=Green><u>do</u></font> q <font color=Red>&lt;-</font> qinit True<font color=Cyan>;</font> return <font color=Cyan>(</font>[]<font color=Cyan>,</font> []<font color=Cyan>,</font> q<font color=Cyan>)</font>
<a name="line-1291"></a><font color=Blue>q_le_signed_qulist</font> <font color=Cyan>(</font>x_high<font color=Red><b>:</b></font>x_lower<font color=Cyan>)</font> <font color=Cyan>(</font>y_high<font color=Red><b>:</b></font>y_lower<font color=Cyan>)</font> <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-1292"></a>  <font color=Cyan>(</font><font color=Cyan>(</font>x<font color=Cyan>,</font>y<font color=Cyan>)</font><font color=Cyan>,</font> x_le_y<font color=Cyan>)</font> <font color=Red>&lt;-</font> with_computed_fun <font color=Cyan>(</font>x_high<font color=Red><b>:</b></font>x_lower<font color=Cyan>,</font> y_high<font color=Red><b>:</b></font>y_lower<font color=Cyan>)</font>
<a name="line-1293"></a>    <font color=Cyan>(</font><font color=Red>\</font><font color=Cyan>(</font>x_high<font color=Red><b>:</b></font>x_lower<font color=Cyan>,</font> y_high<font color=Red><b>:</b></font>y_lower<font color=Cyan>)</font> <font color=Red>-&gt;</font> <font color=Green><u>do</u></font> 
<a name="line-1294"></a>  <font color=Blue><i>-- Classically, one would make the recursive call only if needed; but quantumly, it&#8217;s cheaper to do it unconditionally. </i></font>
<a name="line-1295"></a>      <font color=Cyan>(</font>x_lower<font color=Cyan>,</font> y_lower<font color=Cyan>,</font> le_lower<font color=Red><b>:</b></font>garbage<font color=Cyan>)</font> <font color=Red>&lt;-</font> q_le_unsigned_aux <font color=Cyan>(</font>x_lower<font color=Cyan>,</font> y_lower<font color=Cyan>)</font>
<a name="line-1296"></a>      <font color=Cyan>(</font>x_high<font color=Cyan>,</font>y_high<font color=Cyan>,</font>eq_high<font color=Cyan>)</font> <font color=Red>&lt;-</font> q_is_equal x_high y_high
<a name="line-1297"></a>      return <font color=Cyan>(</font>x_high<font color=Cyan>,</font> y_high<font color=Cyan>,</font> x_lower<font color=Cyan>,</font> y_lower<font color=Cyan>,</font> le_lower<font color=Cyan>,</font> eq_high<font color=Cyan>,</font> garbage<font color=Cyan>)</font><font color=Cyan>)</font>
<a name="line-1298"></a>    <font color=Cyan>(</font><font color=Red>\</font><font color=Cyan>(</font>x_high<font color=Cyan>,</font> y_high<font color=Cyan>,</font> x_lower<font color=Cyan>,</font> y_lower<font color=Cyan>,</font> le_lower<font color=Cyan>,</font> eq_high<font color=Cyan>,</font> garbage<font color=Cyan>)</font> <font color=Red>-&gt;</font> <font color=Green><u>do</u></font>
<a name="line-1299"></a>      le <font color=Red>&lt;-</font> qinit False
<a name="line-1300"></a>      le <font color=Red>&lt;-</font> qnot le <font color=Cyan>`controlled`</font> <font color=Cyan>(</font>x_high <font color=Cyan>.==.</font> <font color=Magenta>1</font><font color=Cyan>)</font> <font color=Cyan>.&amp;&amp;.</font> <font color=Cyan>(</font>y_high <font color=Cyan>.==.</font> <font color=Magenta>0</font><font color=Cyan>)</font>
<a name="line-1301"></a>      le <font color=Red>&lt;-</font> qnot le <font color=Cyan>`controlled`</font> eq_high <font color=Cyan>.&amp;&amp;.</font> le_lower
<a name="line-1302"></a>      return <font color=Cyan>(</font><font color=Cyan>(</font>x_high<font color=Cyan>,</font> y_high<font color=Cyan>,</font> x_lower<font color=Cyan>,</font> y_lower<font color=Cyan>,</font> le_lower<font color=Cyan>,</font> eq_high<font color=Cyan>,</font> garbage<font color=Cyan>)</font><font color=Cyan>,</font> le<font color=Cyan>)</font><font color=Cyan>)</font>
<a name="line-1303"></a>  return <font color=Cyan>(</font>x<font color=Cyan>,</font>y<font color=Cyan>,</font>x_le_y<font color=Cyan>)</font>
<a name="line-1304"></a><font color=Blue>q_le_signed_qulist</font> <font color=Green><u>_</u></font> <font color=Green><u>_</u></font> <font color=Red>=</font> error <font color=Magenta>"q_le // QDInt: cannot compare QDInt&#8217;s of different lengths."</font>
<a name="line-1305"></a>
<a name="line-1306"></a><a name="q_lt_signed"></a><font color=Blue><i>-- | Comparison of two 'QDInt's, considered as signed.  Used in @instance 'QOrd' 'QDInt'@. /O/(&#8467;).</i></font>
<a name="line-1307"></a><font color=Blue>q_lt_signed</font> <font color=Red>::</font> QDInt <font color=Red>-&gt;</font> QDInt <font color=Red>-&gt;</font> Circ <font color=Cyan>(</font>QDInt<font color=Cyan>,</font>QDInt<font color=Cyan>,</font>Qubit<font color=Cyan>)</font>
<a name="line-1308"></a><font color=Blue>q_lt_signed</font> x y <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-1309"></a>  <font color=Green><u>let</u></font> x' <font color=Red>=</font> list_of_xint_bh x
<a name="line-1310"></a>  <font color=Green><u>let</u></font> y' <font color=Red>=</font> list_of_xint_bh y
<a name="line-1311"></a>  <font color=Cyan>(</font>y'<font color=Cyan>,</font>x'<font color=Cyan>,</font>y_le_x<font color=Cyan>)</font> <font color=Red>&lt;-</font> q_le_signed_qulist y' x'
<a name="line-1312"></a>  <font color=Green><u>let</u></font> x <font color=Red>=</font> xint_of_list_bh x'
<a name="line-1313"></a>  <font color=Green><u>let</u></font> y <font color=Red>=</font> xint_of_list_bh y'
<a name="line-1314"></a>  x_lt_y <font color=Red>&lt;-</font> qnot y_le_x
<a name="line-1315"></a>  return <font color=Cyan>(</font>x<font color=Cyan>,</font>y<font color=Cyan>,</font>x_lt_y<font color=Cyan>)</font>
<a name="line-1316"></a>
<a name="line-1317"></a><a name="q_negative"></a><font color=Blue><i>-- | Text whether a 'QDInt' is nonnegative.   /O/(1)</i></font>
<a name="line-1318"></a><font color=Blue>q_negative</font> <font color=Red>::</font> QDInt <font color=Red>-&gt;</font> Circ <font color=Cyan>(</font>QDInt<font color=Cyan>,</font>Qubit<font color=Cyan>)</font>
<a name="line-1319"></a><font color=Blue>q_negative</font> x <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-1320"></a>  <font color=Green><u>let</u></font> <font color=Cyan>(</font>x_high<font color=Red><b>:</b></font>x_lower<font color=Cyan>)</font> <font color=Red>=</font> list_of_xint_bh x
<a name="line-1321"></a>  <font color=Cyan>(</font>x_high<font color=Cyan>,</font>x_neg<font color=Cyan>)</font> <font color=Red>&lt;-</font> qc_copy_fun x_high
<a name="line-1322"></a>  return <font color=Cyan>(</font>xint_of_list_bh <font color=Cyan>(</font>x_high<font color=Red><b>:</b></font>x_lower<font color=Cyan>)</font><font color=Cyan>,</font>x_neg<font color=Cyan>)</font>
<a name="line-1323"></a>
<a name="line-1324"></a><a name="instance%20QOrd%20QDInt"></a><font color=Green><u>instance</u></font> QOrd QDInt <font color=Green><u>where</u></font>
<a name="line-1325"></a>  q_less qx qy <font color=Red>=</font> <font color=Green><u>do</u></font> <font color=Cyan>(</font>qx<font color=Cyan>,</font>qy<font color=Cyan>,</font>q<font color=Cyan>)</font> <font color=Red>&lt;-</font> q_lt_signed qx qy<font color=Cyan>;</font> return q
<a name="line-1326"></a>  q_leq qx qy <font color=Red>=</font> <font color=Green><u>do</u></font> <font color=Cyan>(</font>qx<font color=Cyan>,</font>qy<font color=Cyan>,</font>q<font color=Cyan>)</font> <font color=Red>&lt;-</font> q_le_signed qx qy<font color=Cyan>;</font> return q
<a name="line-1327"></a>
<a name="line-1328"></a><font color=Blue><i>-- ----------------------------------------------------------------------</i></font>
<a name="line-1329"></a><font color=Blue><i>-- ** Multiplication</i></font>
<a name="line-1330"></a>
<a name="line-1331"></a><a name="q_mult_qdint"></a><font color=Blue><i>-- | Multiply two 'QDInt's into a fresh third.  Arguments are assumed to be of equal size.  /O/(&#8467;[sup 2]).</i></font>
<a name="line-1332"></a><font color=Blue>q_mult_qdint</font> <font color=Red>::</font> QDInt <font color=Red>-&gt;</font> QDInt <font color=Red>-&gt;</font> Circ <font color=Cyan>(</font>QDInt<font color=Cyan>,</font>QDInt<font color=Cyan>,</font>QDInt<font color=Cyan>)</font>
<a name="line-1333"></a><font color=Blue>q_mult_qdint</font> x y <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-1334"></a>  <font color=Green><u>let</u></font> x' <font color=Red>=</font> list_of_xint_bh x
<a name="line-1335"></a>  <font color=Green><u>let</u></font> y' <font color=Red>=</font> list_of_xint_bh y
<a name="line-1336"></a>  <font color=Cyan>(</font>x'<font color=Cyan>,</font> y'<font color=Cyan>,</font> z'<font color=Cyan>)</font> <font color=Red>&lt;-</font> q_mult_qulist x' y'
<a name="line-1337"></a>  <font color=Green><u>let</u></font> x <font color=Red>=</font> xint_of_list_bh x'
<a name="line-1338"></a>  <font color=Green><u>let</u></font> y <font color=Red>=</font> xint_of_list_bh y'
<a name="line-1339"></a>  <font color=Green><u>let</u></font> z <font color=Red>=</font> xint_of_list_bh z'
<a name="line-1340"></a>  return <font color=Cyan>(</font>x<font color=Cyan>,</font> y<font color=Cyan>,</font> z<font color=Cyan>)</font>
<a name="line-1341"></a>
<a name="line-1342"></a><a name="q_mult_qulist"></a><font color=Blue><i>-- | Low-level implementation of 'q_mult_qdint': represents integers as</i></font>
<a name="line-1343"></a><font color=Blue><i>-- big-headian qubit lists.</i></font>
<a name="line-1344"></a><font color=Blue>q_mult_qulist</font> <font color=Red>::</font> <font color=Red>[</font>Qubit<font color=Red>]</font> <font color=Red>-&gt;</font> <font color=Red>[</font>Qubit<font color=Red>]</font> <font color=Red>-&gt;</font> Circ <font color=Cyan>(</font><font color=Red>[</font>Qubit<font color=Red>]</font><font color=Cyan>,</font><font color=Red>[</font>Qubit<font color=Red>]</font><font color=Cyan>,</font><font color=Red>[</font>Qubit<font color=Red>]</font><font color=Cyan>)</font>
<a name="line-1345"></a><font color=Blue>q_mult_qulist</font> [] [] <font color=Red>=</font> return <font color=Cyan>(</font>[]<font color=Cyan>,</font> []<font color=Cyan>,</font> []<font color=Cyan>)</font>
<a name="line-1346"></a><font color=Blue>q_mult_qulist</font> xs ys <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-1347"></a>  <font color=Green><u>let</u></font> x0 <font color=Red>=</font> last xs 
<a name="line-1348"></a>      x_higher <font color=Red>=</font> init xs
<a name="line-1349"></a>      y_high <font color=Red>=</font> head ys
<a name="line-1350"></a>      y_lower <font color=Red>=</font> tail ys
<a name="line-1351"></a>  <font color=Cyan>(</font>x_higher<font color=Cyan>,</font> y_lower<font color=Cyan>,</font> p_higher<font color=Cyan>)</font>
<a name="line-1352"></a>    <font color=Red>&lt;-</font> q_mult_qulist x_higher y_lower
<a name="line-1353"></a>  p0 <font color=Red>&lt;-</font> qinit False
<a name="line-1354"></a>  <font color=Green><u>let</u></font> y <font color=Red>=</font> y_high<font color=Red><b>:</b></font>y_lower
<a name="line-1355"></a>      p <font color=Red>=</font> p_higher <font color=Cyan>++</font> <font color=Red>[</font>p0<font color=Red>]</font>
<a name="line-1356"></a>  <font color=Cyan>(</font>y<font color=Cyan>,</font>p<font color=Cyan>)</font> <font color=Red>&lt;-</font> q_add_in_place_qulist y p <font color=Cyan>`controlled`</font> x0
<a name="line-1357"></a>  return <font color=Cyan>(</font>x_higher <font color=Cyan>++</font> <font color=Red>[</font>x0<font color=Red>]</font><font color=Cyan>,</font> y<font color=Cyan>,</font> p<font color=Cyan>)</font>
<a name="line-1358"></a>
<a name="line-1359"></a><font color=Blue><i>-- ----------------------------------------------------------------------</i></font>
<a name="line-1360"></a><font color=Blue><i>-- ** Division and remainder</i></font>
<a name="line-1361"></a>
<a name="line-1362"></a><a name="q_moddiv_unsigned_in_place"></a><font color=Blue><i>-- | Reduce one 'QDInt' modulo another, in place, returning also the</i></font>
<a name="line-1363"></a><font color=Blue><i>-- integer quotient, i.e. (/x/, /y/) &#8614; (/x/ mod /y/, /y/, /x/ div /y/).</i></font>
<a name="line-1364"></a><font color=Blue><i>-- All inputs and outputs are considered unsigned.  Inputs are assumed</i></font>
<a name="line-1365"></a><font color=Blue><i>-- to have the same length.  Division by zero returns (/x/,0,-1).</i></font>
<a name="line-1366"></a><font color=Blue><i>-- </i></font>
<a name="line-1367"></a><font color=Blue><i>-- /O/(&#8467;[sup 2]) gates, /O/(&#8467;) qubits.</i></font>
<a name="line-1368"></a><font color=Blue>q_moddiv_unsigned_in_place</font> <font color=Red>::</font> QDInt <font color=Red>-&gt;</font> QDInt <font color=Red>-&gt;</font> Circ <font color=Cyan>(</font>QDInt<font color=Cyan>,</font> QDInt<font color=Cyan>,</font>QDInt<font color=Cyan>)</font>
<a name="line-1369"></a><font color=Blue>q_moddiv_unsigned_in_place</font> x y <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-1370"></a>  <font color=Green><u>let</u></font> x' <font color=Red>=</font> list_of_xint_bh x
<a name="line-1371"></a>  <font color=Green><u>let</u></font> y' <font color=Red>=</font> list_of_xint_bh y
<a name="line-1372"></a>  <font color=Cyan>(</font>r'<font color=Cyan>,</font> y'<font color=Cyan>,</font> q'<font color=Cyan>)</font> <font color=Red>&lt;-</font> q_moddiv_unsigned_in_place_qulist x' y'
<a name="line-1373"></a>  <font color=Green><u>let</u></font> r <font color=Red>=</font> xint_of_list_bh r'
<a name="line-1374"></a>  <font color=Green><u>let</u></font> y <font color=Red>=</font> xint_of_list_bh y'
<a name="line-1375"></a>  <font color=Green><u>let</u></font> q <font color=Red>=</font> xint_of_list_bh q'
<a name="line-1376"></a>  return <font color=Cyan>(</font>r<font color=Cyan>,</font> y<font color=Cyan>,</font> q<font color=Cyan>)</font>
<a name="line-1377"></a>
<a name="line-1378"></a><a name="q_moddiv_unsigned_in_place_qulist"></a><font color=Blue><i>-- | Low-level implementation of 'q_moddiv_unsigned_in_place':</i></font>
<a name="line-1379"></a><font color=Blue><i>-- represents integers as big-headian qubit lists.</i></font>
<a name="line-1380"></a><font color=Blue><i>-- </i></font>
<a name="line-1381"></a><font color=Blue><i>-- Implementation note: this algorithm can be optimized significantly:</i></font>
<a name="line-1382"></a><font color=Blue><i>-- [scratch] is always 0, so can be optimized away.  This optimisation</i></font>
<a name="line-1383"></a><font color=Blue><i>-- is much clearer at the circuit level than the code level, however,</i></font>
<a name="line-1384"></a><font color=Blue><i>-- so is deferred for now.</i></font>
<a name="line-1385"></a><font color=Blue>q_moddiv_unsigned_in_place_qulist</font> <font color=Red>::</font> <font color=Red>[</font>Qubit<font color=Red>]</font> <font color=Red>-&gt;</font> <font color=Red>[</font>Qubit<font color=Red>]</font> <font color=Red>-&gt;</font> Circ <font color=Cyan>(</font><font color=Red>[</font>Qubit<font color=Red>]</font><font color=Cyan>,</font> <font color=Red>[</font>Qubit<font color=Red>]</font><font color=Cyan>,</font><font color=Red>[</font>Qubit<font color=Red>]</font><font color=Cyan>)</font>
<a name="line-1386"></a><font color=Blue>q_moddiv_unsigned_in_place_qulist</font> x y <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-1387"></a>  <font color=Green><u>let</u></font> l <font color=Red>=</font> common_value <font color=Magenta>"q_divrem_unsigned_in_place: arguments must be same length"</font> <font color=Cyan>$</font> map length <font color=Red>[</font>x<font color=Cyan>,</font>y<font color=Red>]</font>
<a name="line-1388"></a>  <font color=Blue><i>-- Set quot = 0, rem = x.  At each stage, we will have y * quot + rem = x.</i></font>
<a name="line-1389"></a>  quot_bits <font color=Red>&lt;-</font> qinit <font color=Cyan>(</font>replicate l False<font color=Cyan>)</font>
<a name="line-1390"></a>  <font color=Green><u>let</u></font> rem <font color=Red>=</font> x
<a name="line-1391"></a>  with_ancilla_init <font color=Cyan>(</font>replicate <font color=Cyan>(</font>l<font color=Blue><i>-</i></font><font color=Magenta>1</font><font color=Cyan>)</font> False<font color=Cyan>)</font> <font color=Cyan>(</font><font color=Red>\</font>scratch <font color=Red>-&gt;</font> <font color=Green><u>do</u></font>
<a name="line-1392"></a>    <font color=Blue><i>-- For j from (l-1) to 0, compute the jth bit of the quotient, and update the remainder </i></font>
<a name="line-1393"></a>    <font color=Cyan>(</font>y<font color=Cyan>,</font>scratch<font color=Cyan>,</font>quot_bits<font color=Cyan>,</font>rem<font color=Cyan>)</font> <font color=Red>&lt;-</font> loop_with_indexM l <font color=Cyan>(</font>y<font color=Cyan>,</font>scratch<font color=Cyan>,</font>quot_bits<font color=Cyan>,</font>rem<font color=Cyan>)</font>
<a name="line-1394"></a>      <font color=Cyan>(</font><font color=Red>\</font>i <font color=Cyan>(</font>y<font color=Cyan>,</font>scratch<font color=Cyan>,</font>quot_bits<font color=Cyan>,</font>rem<font color=Cyan>)</font> <font color=Red>-&gt;</font> <font color=Green><u>do</u></font>
<a name="line-1395"></a>        <font color=Green><u>let</u></font> j <font color=Red>=</font> l<font color=Blue><i>-</i></font><font color=Magenta>1</font><font color=Blue><i>-</i></font>i
<a name="line-1396"></a>        <font color=Blue><i>-- Getting y*(2^j) requires no quantum operations, just formal re-bracketing of the data:</i></font>
<a name="line-1397"></a>        <font color=Green><u>let</u></font> y_init <font color=Red>=</font> take j y
<a name="line-1398"></a>            y_2j <font color=Red>=</font> <font color=Cyan>(</font>drop j y<font color=Cyan>)</font> <font color=Cyan>++</font> <font color=Cyan>(</font>take j scratch<font color=Cyan>)</font>
<a name="line-1399"></a>            scratch_tail <font color=Red>=</font> drop j scratch
<a name="line-1400"></a>        <font color=Blue><i>-- Compare (2^j) y with rem.  If (2^j)y &lt;= rem, then subtract (2^j)y from rem and flip the jth bit of quot.</i></font>
<a name="line-1401"></a>        <font color=Cyan>(</font><font color=Cyan>(</font>y_init<font color=Cyan>,</font>y_2j<font color=Cyan>,</font>rem<font color=Cyan>,</font>quot_bits<font color=Cyan>)</font><font color=Cyan>,</font>()<font color=Cyan>)</font> <font color=Red>&lt;-</font> with_computed_fun 
<a name="line-1402"></a>          <font color=Cyan>(</font>y_init<font color=Cyan>,</font>y_2j<font color=Cyan>,</font>rem<font color=Cyan>,</font>quot_bits<font color=Cyan>)</font>
<a name="line-1403"></a>          <font color=Cyan>(</font><font color=Red>\</font><font color=Cyan>(</font>y_init<font color=Cyan>,</font>y_2j<font color=Cyan>,</font>rem<font color=Cyan>,</font>quot_bits<font color=Cyan>)</font> <font color=Red>-&gt;</font> <font color=Green><u>do</u></font>
<a name="line-1404"></a>            <font color=Blue><i>-- first, test that (2^j)y has not overflowed the register, i.e. that y_init is still all 0;</i></font>
<a name="line-1405"></a>            le1 <font color=Red>&lt;-</font> qinit False
<a name="line-1406"></a>            le1 <font color=Red>&lt;-</font> qnot le1 <font color=Cyan>`controlled`</font> <font color=Cyan>(</font>y_init <font color=Cyan>.==.</font> replicate <font color=Cyan>(</font>length y_init<font color=Cyan>)</font> False<font color=Cyan>)</font>
<a name="line-1407"></a>            <font color=Blue><i>-- next, test that (2^j)y &lt;= rem (this will be correct if (2^j)y has not overflowed yet);</i></font>
<a name="line-1408"></a>            <font color=Cyan>(</font>y_2j<font color=Cyan>,</font>rem<font color=Cyan>,</font>le2<font color=Cyan>)</font> <font color=Red>&lt;-</font> q_le_unsigned_qulist y_2j rem
<a name="line-1409"></a>            return <font color=Cyan>(</font>y_init<font color=Cyan>,</font>y_2j<font color=Cyan>,</font>rem<font color=Cyan>,</font>quot_bits<font color=Cyan>,</font>le1<font color=Cyan>,</font>le2<font color=Cyan>)</font><font color=Cyan>)</font>
<a name="line-1410"></a>          <font color=Cyan>(</font><font color=Red>\</font><font color=Cyan>(</font>y_init<font color=Cyan>,</font>y_2j<font color=Cyan>,</font>rem<font color=Cyan>,</font>quot_bits<font color=Cyan>,</font>le1<font color=Cyan>,</font>le2<font color=Cyan>)</font> <font color=Red>-&gt;</font> <font color=Green><u>do</u></font>
<a name="line-1411"></a>            <font color=Blue><i>-- flip jth bit of quot, if appropriate</i></font>
<a name="line-1412"></a>            <font color=Blue><i>-- (leave rem unchanged for now, since it&#8217;s needed to uncompute le1)</i></font>
<a name="line-1413"></a>            q_j <font color=Red>&lt;-</font> qnot <font color=Cyan>(</font>quot_bits <font color=Cyan>!!</font> <font color=Cyan>(</font>l<font color=Blue><i>-</i></font><font color=Magenta>1</font><font color=Blue><i>-</i></font>j<font color=Cyan>)</font><font color=Cyan>)</font> <font color=Cyan>`controlled`</font> le1 <font color=Cyan>.&amp;&amp;.</font> le2
<a name="line-1414"></a>            return <font color=Cyan>(</font><font color=Cyan>(</font>y_init<font color=Cyan>,</font>y_2j<font color=Cyan>,</font>rem<font color=Cyan>,</font><font color=Cyan>(</font>overwriteAt <font color=Cyan>(</font>l<font color=Blue><i>-</i></font><font color=Magenta>1</font><font color=Blue><i>-</i></font>j<font color=Cyan>)</font> q_j quot_bits<font color=Cyan>)</font><font color=Cyan>,</font>le1<font color=Cyan>,</font>le2<font color=Cyan>)</font><font color=Cyan>,</font>()<font color=Cyan>)</font><font color=Cyan>)</font>
<a name="line-1415"></a>        <font color=Blue><i>-- now, subtract (2^j) from rem, if appropriate.</i></font>
<a name="line-1416"></a>        <font color=Cyan>(</font>y_2j<font color=Cyan>,</font>rem<font color=Cyan>)</font> <font color=Red>&lt;-</font> q_sub_in_place_qulist y_2j rem <font color=Cyan>`controlled`</font> quot_bits <font color=Cyan>!!</font> <font color=Cyan>(</font>l<font color=Blue><i>-</i></font><font color=Magenta>1</font><font color=Blue><i>-</i></font>j<font color=Cyan>)</font>
<a name="line-1417"></a>        <font color=Blue><i>-- Finally, undo the formal re-bracketing:</i></font>
<a name="line-1418"></a>        <font color=Green><u>let</u></font> y <font color=Red>=</font> y_init <font color=Cyan>++</font> <font color=Cyan>(</font>take <font color=Cyan>(</font>l<font color=Blue><i>-</i></font>j<font color=Cyan>)</font> y_2j<font color=Cyan>)</font>
<a name="line-1419"></a>            scratch <font color=Red>=</font> <font color=Cyan>(</font>drop <font color=Cyan>(</font>l<font color=Blue><i>-</i></font>j<font color=Cyan>)</font> y_2j<font color=Cyan>)</font> <font color=Cyan>++</font> scratch_tail
<a name="line-1420"></a>        return <font color=Cyan>(</font>y<font color=Cyan>,</font>scratch<font color=Cyan>,</font>quot_bits<font color=Cyan>,</font>rem<font color=Cyan>)</font><font color=Cyan>)</font>
<a name="line-1421"></a>    return <font color=Cyan>(</font>rem<font color=Cyan>,</font> y<font color=Cyan>,</font> quot_bits<font color=Cyan>)</font><font color=Cyan>)</font>
<a name="line-1422"></a>
<a name="line-1423"></a><a name="q_mod_unsigned"></a><font color=Blue><i>-- | Reduce one 'QDInt' modulo another, i.e. (/x/, /y/) &#8614; (/x/, /y/, /x/ mod /y/).</i></font>
<a name="line-1424"></a><font color=Blue><i>-- All inputs and outputs are considered unsigned.  Inputs are assumed</i></font>
<a name="line-1425"></a><font color=Blue><i>-- to have the same length.  If /y/ = 0, returns (/x/,0,/x/).</i></font>
<a name="line-1426"></a><font color=Blue><i>-- </i></font>
<a name="line-1427"></a><font color=Blue><i>-- /O/(&#8467;[sup 2]) gates, /O/(&#8467;) qubits.</i></font>
<a name="line-1428"></a><font color=Blue>q_mod_unsigned</font> <font color=Red>::</font> QDInt <font color=Red>-&gt;</font> QDInt <font color=Red>-&gt;</font> Circ <font color=Cyan>(</font>QDInt<font color=Cyan>,</font> QDInt<font color=Cyan>,</font>QDInt<font color=Cyan>)</font>
<a name="line-1429"></a><font color=Blue>q_mod_unsigned</font> x y <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-1430"></a>  <font color=Cyan>(</font><font color=Cyan>(</font>x<font color=Cyan>,</font>y<font color=Cyan>)</font><font color=Cyan>,</font>x_mod_y<font color=Cyan>)</font> <font color=Red>&lt;-</font> with_computed_fun <font color=Cyan>(</font>x<font color=Cyan>,</font>y<font color=Cyan>)</font>
<a name="line-1431"></a>    <font color=Cyan>(</font><font color=Red>\</font><font color=Cyan>(</font>x<font color=Cyan>,</font>y<font color=Cyan>)</font> <font color=Red>-&gt;</font> q_moddiv_unsigned_in_place x y<font color=Cyan>)</font>
<a name="line-1432"></a>    <font color=Cyan>(</font><font color=Red>\</font><font color=Cyan>(</font>x_mod_y<font color=Cyan>,</font> y<font color=Cyan>,</font> x_div_y<font color=Cyan>)</font> <font color=Red>-&gt;</font> <font color=Green><u>do</u></font>
<a name="line-1433"></a>      <font color=Cyan>(</font>x_mod_y<font color=Cyan>,</font> x_mod_y_out<font color=Cyan>)</font> <font color=Red>&lt;-</font> qc_copy_fun x_mod_y
<a name="line-1434"></a>      return <font color=Cyan>(</font><font color=Cyan>(</font>x_mod_y<font color=Cyan>,</font> y<font color=Cyan>,</font> x_div_y<font color=Cyan>)</font><font color=Cyan>,</font> x_mod_y_out<font color=Cyan>)</font><font color=Cyan>)</font>
<a name="line-1435"></a>  return <font color=Cyan>(</font>x<font color=Cyan>,</font>y<font color=Cyan>,</font>x_mod_y<font color=Cyan>)</font>
<a name="line-1436"></a>
<a name="line-1437"></a><a name="q_divrem_unsigned"></a><font color=Blue><i>-- | Integer division of two 'QDInt's, returning the quotient and remainder,</i></font>
<a name="line-1438"></a><font color=Blue><i>-- i.e. (/x/,/y/) &#8614; (/x/,/y/,/x/ div /y/,/x/ mod /y/). </i></font>
<a name="line-1439"></a><font color=Blue><i>-- All inputs and outputs are considered unsigned.</i></font>
<a name="line-1440"></a><font color=Blue><i>-- Inputs are assumed to have the same length.</i></font>
<a name="line-1441"></a><font color=Blue><i>-- Division by zero returns (-1,/x/).</i></font>
<a name="line-1442"></a><font color=Blue><i>--</i></font>
<a name="line-1443"></a><font color=Blue><i>-- /O/(&#8467;[sup 2]) gates, /O/(&#8467;) qubits.</i></font>
<a name="line-1444"></a><font color=Blue>q_divrem_unsigned</font> <font color=Red>::</font> QDInt <font color=Red>-&gt;</font> QDInt <font color=Red>-&gt;</font> Circ <font color=Cyan>(</font>QDInt<font color=Cyan>,</font> QDInt<font color=Cyan>,</font>QDInt<font color=Cyan>,</font>QDInt<font color=Cyan>)</font>
<a name="line-1445"></a><font color=Blue>q_divrem_unsigned</font> x y <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-1446"></a>  <font color=Cyan>(</font>x<font color=Cyan>,</font>rem<font color=Cyan>)</font> <font color=Red>&lt;-</font> qc_copy_fun x
<a name="line-1447"></a>  <font color=Cyan>(</font>rem<font color=Cyan>,</font>y<font color=Cyan>,</font>quot<font color=Cyan>)</font> <font color=Red>&lt;-</font> q_moddiv_unsigned_in_place rem y
<a name="line-1448"></a>  return <font color=Cyan>(</font>x<font color=Cyan>,</font>y<font color=Cyan>,</font>quot<font color=Cyan>,</font>rem<font color=Cyan>)</font>
<a name="line-1449"></a>
<a name="line-1450"></a><font color=Blue><i>-- | Integer division of two 'QDInt's, returning just the quotient.  </i></font>
<a name="line-1451"></a><font color=Blue><i>-- All inputs/outputs considered unsigned.</i></font>
<a name="line-1452"></a><font color=Blue><i>-- Inputs are assumed to have the same length.</i></font>
<a name="line-1453"></a><font color=Blue><i>-- Division by zero returns &#8211;1.</i></font>
<a name="line-1454"></a><font color=Blue><i>-- </i></font>
<a name="line-1455"></a><font color=Blue><i>-- /O/(&#8467;[sup 2]) gates, /O/(&#8467;) qubits.</i></font>
<a name="line-1456"></a>
<a name="line-1457"></a><a name="q_div_unsigned"></a><font color=Blue><i>-- Implementation note: We use a multiplication to do the</i></font>
<a name="line-1458"></a><font color=Blue><i>-- uncomputation of the remainder, because this uses fewer total gates</i></font>
<a name="line-1459"></a><font color=Blue><i>-- than uncomputing divrem would.</i></font>
<a name="line-1460"></a><font color=Blue>q_div_unsigned</font> <font color=Red>::</font> QDInt <font color=Red>-&gt;</font> QDInt <font color=Red>-&gt;</font> Circ <font color=Cyan>(</font>QDInt<font color=Cyan>,</font> QDInt<font color=Cyan>,</font>QDInt<font color=Cyan>)</font>
<a name="line-1461"></a><font color=Blue>q_div_unsigned</font> x y <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-1462"></a>  <font color=Cyan>(</font>x<font color=Cyan>,</font>y<font color=Cyan>,</font>quot<font color=Cyan>,</font>rem<font color=Cyan>)</font> <font color=Red>&lt;-</font> q_divrem_unsigned x y
<a name="line-1463"></a>  <font color=Cyan>(</font><font color=Cyan>(</font>x<font color=Cyan>,</font>y<font color=Cyan>,</font>quot<font color=Cyan>)</font><font color=Cyan>,</font>()<font color=Cyan>)</font> <font color=Red>&lt;-</font> with_computed_fun <font color=Cyan>(</font>x<font color=Cyan>,</font>y<font color=Cyan>,</font>quot<font color=Cyan>)</font> 
<a name="line-1464"></a>    <font color=Cyan>(</font><font color=Red>\</font><font color=Cyan>(</font>x<font color=Cyan>,</font>y<font color=Cyan>,</font>quot<font color=Cyan>)</font> <font color=Red>-&gt;</font> <font color=Green><u>do</u></font>
<a name="line-1465"></a>      <font color=Cyan>(</font>y<font color=Cyan>,</font>quot<font color=Cyan>,</font>y_quot<font color=Cyan>)</font> <font color=Red>&lt;-</font> q_mult y quot
<a name="line-1466"></a>      <font color=Cyan>(</font>x<font color=Cyan>,</font>y_quot<font color=Cyan>,</font>rem_copy<font color=Cyan>)</font> <font color=Red>&lt;-</font> q_sub x y_quot
<a name="line-1467"></a>      return <font color=Cyan>(</font>x<font color=Cyan>,</font>y<font color=Cyan>,</font>quot<font color=Cyan>,</font>y_quot<font color=Cyan>,</font>rem_copy<font color=Cyan>)</font><font color=Cyan>)</font>
<a name="line-1468"></a>    <font color=Cyan>(</font><font color=Red>\</font><font color=Cyan>(</font>x<font color=Cyan>,</font>y<font color=Cyan>,</font>quot<font color=Cyan>,</font>y_quot<font color=Cyan>,</font>rem_copy<font color=Cyan>)</font> <font color=Red>-&gt;</font> <font color=Green><u>do</u></font>
<a name="line-1469"></a>      rem_copy <font color=Red>&lt;-</font> qc_uncopy_fun rem_copy rem
<a name="line-1470"></a>      return <font color=Cyan>(</font><font color=Cyan>(</font>x<font color=Cyan>,</font>y<font color=Cyan>,</font>quot<font color=Cyan>,</font>y_quot<font color=Cyan>,</font>rem_copy<font color=Cyan>)</font><font color=Cyan>,</font>()<font color=Cyan>)</font><font color=Cyan>)</font>
<a name="line-1471"></a>  return <font color=Cyan>(</font>x<font color=Cyan>,</font>y<font color=Cyan>,</font>quot<font color=Cyan>)</font>
<a name="line-1472"></a>
<a name="line-1473"></a><a name="q_div_unsigned_qulist"></a><font color=Blue><i>-- | Low-level version of 'q_div_unsigned': represents integers as</i></font>
<a name="line-1474"></a><font color=Blue><i>-- big-headian qubit lists.</i></font>
<a name="line-1475"></a><font color=Blue>q_div_unsigned_qulist</font> <font color=Red>::</font> <font color=Red>[</font>Qubit<font color=Red>]</font> <font color=Red>-&gt;</font> <font color=Red>[</font>Qubit<font color=Red>]</font> <font color=Red>-&gt;</font> Circ <font color=Cyan>(</font><font color=Red>[</font>Qubit<font color=Red>]</font><font color=Cyan>,</font> <font color=Red>[</font>Qubit<font color=Red>]</font><font color=Cyan>,</font> <font color=Red>[</font>Qubit<font color=Red>]</font><font color=Cyan>)</font>
<a name="line-1476"></a><font color=Blue>q_div_unsigned_qulist</font> x' y' <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-1477"></a>  <font color=Green><u>let</u></font> x <font color=Red>=</font> xint_of_list_bh x'
<a name="line-1478"></a>  <font color=Green><u>let</u></font> y <font color=Red>=</font> xint_of_list_bh y'
<a name="line-1479"></a>  <font color=Cyan>(</font>x<font color=Cyan>,</font> y<font color=Cyan>,</font> q<font color=Cyan>)</font> <font color=Red>&lt;-</font> q_div_unsigned x y            
<a name="line-1480"></a>  <font color=Green><u>let</u></font> x' <font color=Red>=</font> list_of_xint_bh x
<a name="line-1481"></a>  <font color=Green><u>let</u></font> y' <font color=Red>=</font> list_of_xint_bh y
<a name="line-1482"></a>  <font color=Green><u>let</u></font> q' <font color=Red>=</font> list_of_xint_bh q
<a name="line-1483"></a>  return <font color=Cyan>(</font>x'<font color=Cyan>,</font> y'<font color=Cyan>,</font> q'<font color=Cyan>)</font>
<a name="line-1484"></a>
<a name="line-1485"></a><a name="q_div"></a><font color=Blue><i>-- | Integer division of two 'QDInt's into a fresh third, rounding towards &#8211;&#8734;. </i></font>
<a name="line-1486"></a><font color=Blue><i>-- The first argument is the numerator, and is assumed to be signed.</i></font>
<a name="line-1487"></a><font color=Blue><i>-- The second argument is the denominator, and is assumed to be unsigned.</i></font>
<a name="line-1488"></a><font color=Blue><i>-- The output is signed.</i></font>
<a name="line-1489"></a><font color=Blue><i>-- Inputs are assumed to have the same length.</i></font>
<a name="line-1490"></a><font color=Blue><i>-- </i></font>
<a name="line-1491"></a><font color=Blue><i>-- /O/(&#8467;[sup 2]) gates, /O/(&#8467;) qubits.</i></font>
<a name="line-1492"></a><font color=Blue>q_div</font> <font color=Red>::</font> QDInt <font color=Red>-&gt;</font> QDInt <font color=Red>-&gt;</font> Circ <font color=Cyan>(</font>QDInt<font color=Cyan>,</font> QDInt<font color=Cyan>,</font> QDInt<font color=Cyan>)</font>
<a name="line-1493"></a><font color=Blue>q_div</font> x y <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-1494"></a>  <font color=Green><u>let</u></font> x' <font color=Red>=</font> list_of_xint_bh x
<a name="line-1495"></a>  <font color=Green><u>let</u></font> y' <font color=Red>=</font> list_of_xint_bh y
<a name="line-1496"></a>  <font color=Cyan>(</font>x'<font color=Cyan>,</font> y'<font color=Cyan>,</font> q'<font color=Cyan>)</font> <font color=Red>&lt;-</font> q_div_qulist x' y'            
<a name="line-1497"></a>  <font color=Green><u>let</u></font> x <font color=Red>=</font> xint_of_list_bh x'
<a name="line-1498"></a>  <font color=Green><u>let</u></font> y <font color=Red>=</font> xint_of_list_bh y'
<a name="line-1499"></a>  <font color=Green><u>let</u></font> q <font color=Red>=</font> xint_of_list_bh q'
<a name="line-1500"></a>  return <font color=Cyan>(</font>x<font color=Cyan>,</font> y<font color=Cyan>,</font> q<font color=Cyan>)</font>
<a name="line-1501"></a>
<a name="line-1502"></a><a name="q_div_qulist"></a><font color=Blue><i>-- | Low-level implementation of 'q_div': represents integers as</i></font>
<a name="line-1503"></a><font color=Blue><i>-- big-headian qubit lists.</i></font>
<a name="line-1504"></a><font color=Blue>q_div_qulist</font> <font color=Red>::</font> <font color=Red>[</font>Qubit<font color=Red>]</font> <font color=Red>-&gt;</font> <font color=Red>[</font>Qubit<font color=Red>]</font> <font color=Red>-&gt;</font> Circ <font color=Cyan>(</font><font color=Red>[</font>Qubit<font color=Red>]</font><font color=Cyan>,</font> <font color=Red>[</font>Qubit<font color=Red>]</font><font color=Cyan>,</font> <font color=Red>[</font>Qubit<font color=Red>]</font><font color=Cyan>)</font>
<a name="line-1505"></a><font color=Blue>q_div_qulist</font> [] [] <font color=Red>=</font> return <font color=Cyan>(</font>[]<font color=Cyan>,</font> []<font color=Cyan>,</font> []<font color=Cyan>)</font>
<a name="line-1506"></a><font color=Blue>q_div_qulist</font> <font color=Cyan>(</font>x_high<font color=Red><b>:</b></font>x_lower<font color=Cyan>)</font> y <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-1507"></a>  <font color=Blue><i>-- Writing x/y for unsigned division, we have x `div` y = </i></font>
<a name="line-1508"></a>  <font color=Blue><i>-- if x&gt;0 then x/y else ~((~x)/y)</i></font>
<a name="line-1509"></a>  <font color=Blue><i>-- where ~x := -1-x --- i.e. the bitflip of x.</i></font>
<a name="line-1510"></a>  <font color=Blue><i>--</i></font>
<a name="line-1511"></a>  <font color=Blue><i>-- We do this with an ancilla (which can easily be optimized away): </i></font>
<a name="line-1512"></a>  with_ancilla_init False <font color=Cyan>(</font><font color=Red>\</font>fake_x_high <font color=Red>-&gt;</font> <font color=Green><u>do</u></font>
<a name="line-1513"></a>    <font color=Blue><i>-- flip x if x&lt;0:</i></font>
<a name="line-1514"></a>    x_lower <font color=Red>&lt;-</font> mapUnary qnot x_lower <font color=Cyan>`controlled`</font> x_high
<a name="line-1515"></a>    <font color=Green><u>let</u></font> x' <font color=Red>=</font> fake_x_high<font color=Red><b>:</b></font>x_lower
<a name="line-1516"></a>    <font color=Blue><i>-- x' now holds (if x &gt; 0 then x else ~x) </i></font>
<a name="line-1517"></a>    <font color=Cyan>(</font>x'<font color=Cyan>,</font>y<font color=Cyan>,</font>quot<font color=Cyan>)</font> <font color=Red>&lt;-</font> q_div_unsigned_qulist x' y
<a name="line-1518"></a>    <font color=Blue><i>-- restore x and flip quotient, if necessary</i></font>
<a name="line-1519"></a>    <font color=Green><u>let</u></font> fake_x_high<font color=Red><b>:</b></font>x_lower <font color=Red>=</font> x'
<a name="line-1520"></a>    x_lower <font color=Red>&lt;-</font> mapUnary qnot x_lower <font color=Cyan>`controlled`</font> x_high
<a name="line-1521"></a>    quot <font color=Red>&lt;-</font>  mapUnary qnot quot <font color=Cyan>`controlled`</font> x_high
<a name="line-1522"></a>    return <font color=Cyan>(</font>x_high<font color=Red><b>:</b></font>x_lower<font color=Cyan>,</font> y<font color=Cyan>,</font> quot<font color=Cyan>)</font><font color=Cyan>)</font>
<a name="line-1523"></a><font color=Blue>q_div_qulist</font> <font color=Green><u>_</u></font> <font color=Green><u>_</u></font> <font color=Red>=</font> error <font color=Magenta>"q_div: arguments must have same length."</font>
<a name="line-1524"></a>
<a name="line-1525"></a><a name="q_quot"></a><font color=Blue><i>-- | Integer division of two 'QDInt's into a fresh third, rounding towards 0. </i></font>
<a name="line-1526"></a><font color=Blue><i>-- The first argument is the numerator, and is assumed to be signed.</i></font>
<a name="line-1527"></a><font color=Blue><i>-- The second argument is the denominator, and is assumed to be unsigned.</i></font>
<a name="line-1528"></a><font color=Blue><i>-- The output is signed.</i></font>
<a name="line-1529"></a><font color=Blue><i>-- Inputs are assumed to have the same length.</i></font>
<a name="line-1530"></a><font color=Blue><i>-- </i></font>
<a name="line-1531"></a><font color=Blue><i>-- /O/(&#8467;[sup 2]) gates, /O/(&#8467;) qubits.</i></font>
<a name="line-1532"></a><font color=Blue>q_quot</font> <font color=Red>::</font> QDInt <font color=Red>-&gt;</font> QDInt <font color=Red>-&gt;</font> Circ <font color=Cyan>(</font>QDInt<font color=Cyan>,</font> QDInt<font color=Cyan>,</font> QDInt<font color=Cyan>)</font>
<a name="line-1533"></a><font color=Blue>q_quot</font> x y <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-1534"></a>  <font color=Green><u>let</u></font> x' <font color=Red>=</font> list_of_xint_bh x
<a name="line-1535"></a>  <font color=Green><u>let</u></font> y' <font color=Red>=</font> list_of_xint_bh y
<a name="line-1536"></a>  <font color=Cyan>(</font>x'<font color=Cyan>,</font> y'<font color=Cyan>,</font> q'<font color=Cyan>)</font> <font color=Red>&lt;-</font> q_quot_qulist x' y'            
<a name="line-1537"></a>  <font color=Green><u>let</u></font> x <font color=Red>=</font> xint_of_list_bh x'
<a name="line-1538"></a>  <font color=Green><u>let</u></font> y <font color=Red>=</font> xint_of_list_bh y'
<a name="line-1539"></a>  <font color=Green><u>let</u></font> q <font color=Red>=</font> xint_of_list_bh q'
<a name="line-1540"></a>  return <font color=Cyan>(</font>x<font color=Cyan>,</font> y<font color=Cyan>,</font> q<font color=Cyan>)</font>
<a name="line-1541"></a>
<a name="line-1542"></a><a name="q_quot_qulist"></a><font color=Blue><i>-- | Low-level implementation of 'q_quot': represents integers as</i></font>
<a name="line-1543"></a><font color=Blue><i>-- big-headian qubit lists.</i></font>
<a name="line-1544"></a><font color=Blue>q_quot_qulist</font> <font color=Red>::</font> <font color=Red>[</font>Qubit<font color=Red>]</font> <font color=Red>-&gt;</font> <font color=Red>[</font>Qubit<font color=Red>]</font> <font color=Red>-&gt;</font> Circ <font color=Cyan>(</font><font color=Red>[</font>Qubit<font color=Red>]</font><font color=Cyan>,</font> <font color=Red>[</font>Qubit<font color=Red>]</font><font color=Cyan>,</font> <font color=Red>[</font>Qubit<font color=Red>]</font><font color=Cyan>)</font>
<a name="line-1545"></a><font color=Blue>q_quot_qulist</font> [] [] <font color=Red>=</font> return <font color=Cyan>(</font>[]<font color=Cyan>,</font> []<font color=Cyan>,</font> []<font color=Cyan>)</font>
<a name="line-1546"></a><font color=Blue>q_quot_qulist</font> <font color=Cyan>(</font>x_high<font color=Red><b>:</b></font>x_lower<font color=Cyan>)</font> y <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-1547"></a>  <font color=Blue><i>-- Writing x/y for unsigned division, we have x `div` y = </i></font>
<a name="line-1548"></a>  <font color=Blue><i>-- if x&gt;0 then x/y else -((-x)/y)</i></font>
<a name="line-1549"></a>  <font color=Blue><i>--</i></font>
<a name="line-1550"></a>  <font color=Blue><i>-- We do this with an ancilla (which can easily be optimized away): </i></font>
<a name="line-1551"></a>  with_ancilla_init False <font color=Cyan>(</font><font color=Red>\</font>fake_x_high <font color=Red>-&gt;</font> <font color=Green><u>do</u></font>
<a name="line-1552"></a>    <font color=Blue><i>-- flip x if x&lt;0:</i></font>
<a name="line-1553"></a>    x_lower <font color=Red>&lt;-</font> q_negate_in_place_qulist x_lower <font color=Cyan>`controlled`</font> x_high
<a name="line-1554"></a>    <font color=Green><u>let</u></font> x' <font color=Red>=</font> fake_x_high<font color=Red><b>:</b></font>x_lower
<a name="line-1555"></a>    <font color=Blue><i>-- x' now holds (if x &gt; 0 then x else ~x) </i></font>
<a name="line-1556"></a>    <font color=Cyan>(</font>x'<font color=Cyan>,</font>y<font color=Cyan>,</font>quot<font color=Cyan>)</font> <font color=Red>&lt;-</font> q_div_unsigned_qulist x' y
<a name="line-1557"></a>    <font color=Blue><i>-- restore x and flip quotient, if necessary</i></font>
<a name="line-1558"></a>    <font color=Green><u>let</u></font> fake_x_high<font color=Red><b>:</b></font>x_lower <font color=Red>=</font> x'
<a name="line-1559"></a>    x_lower <font color=Red>&lt;-</font> q_negate_in_place_qulist x_lower <font color=Cyan>`controlled`</font> x_high
<a name="line-1560"></a>    quot <font color=Red>&lt;-</font> q_negate_in_place_qulist quot <font color=Cyan>`controlled`</font> x_high
<a name="line-1561"></a>    return <font color=Cyan>(</font>x_high<font color=Red><b>:</b></font>x_lower<font color=Cyan>,</font> y<font color=Cyan>,</font> quot<font color=Cyan>)</font><font color=Cyan>)</font>
<a name="line-1562"></a><font color=Blue>q_quot_qulist</font> <font color=Green><u>_</u></font> <font color=Green><u>_</u></font> <font color=Red>=</font> error <font color=Magenta>"q_quot: arguments must have same length."</font>
<a name="line-1563"></a>
<a name="line-1564"></a><a name="q_div_exact_unsigned"></a><font color=Blue><i>-- | Integer division of two 'QDInt's, returning the quotient,</i></font>
<a name="line-1565"></a><font color=Blue><i>-- assuming that the second exactly divides the first and throwing an error otherwise.  </i></font>
<a name="line-1566"></a><font color=Blue><i>-- All inputs/outputs considered unsigned.</i></font>
<a name="line-1567"></a><font color=Blue><i>-- Inputs are assumed to have the same length.</i></font>
<a name="line-1568"></a><font color=Blue><i>-- </i></font>
<a name="line-1569"></a><font color=Blue><i>-- /O/(&#8467;[sup 2]) gates, /O/(&#8467;) qubits.</i></font>
<a name="line-1570"></a><font color=Blue>q_div_exact_unsigned</font> <font color=Red>::</font> QDInt <font color=Red>-&gt;</font> QDInt <font color=Red>-&gt;</font> Circ <font color=Cyan>(</font>QDInt<font color=Cyan>,</font> QDInt<font color=Cyan>,</font>QDInt<font color=Cyan>)</font>
<a name="line-1571"></a><font color=Blue>q_div_exact_unsigned</font> x y <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-1572"></a>  <font color=Cyan>(</font>x<font color=Cyan>,</font>y<font color=Cyan>,</font>quot<font color=Cyan>,</font>rem<font color=Cyan>)</font> <font color=Red>&lt;-</font> q_divrem_unsigned x y
<a name="line-1573"></a>  qterm <font color=Magenta>0</font> rem
<a name="line-1574"></a>  return <font color=Cyan>(</font>x<font color=Cyan>,</font>y<font color=Cyan>,</font>quot<font color=Cyan>)</font>
<a name="line-1575"></a>
<a name="line-1576"></a><a name="q_div_exact"></a><font color=Blue><i>-- | Integer division of two 'QDInt's, returning the quotient,</i></font>
<a name="line-1577"></a><font color=Blue><i>-- assuming that the second exactly divides the first.  </i></font>
<a name="line-1578"></a><font color=Blue><i>-- The first argument is the numerator, considered signed.</i></font>
<a name="line-1579"></a><font color=Blue><i>-- The second argument is the denominator, considered unsigned.</i></font>
<a name="line-1580"></a><font color=Blue><i>-- The output is signed.</i></font>
<a name="line-1581"></a><font color=Blue><i>-- </i></font>
<a name="line-1582"></a><font color=Blue><i>-- /O/(&#8467;[sup 2]) gates, /O/(&#8467;) qubits.</i></font>
<a name="line-1583"></a><font color=Blue>q_div_exact</font> <font color=Red>::</font> QDInt <font color=Red>-&gt;</font> QDInt <font color=Red>-&gt;</font> Circ <font color=Cyan>(</font>QDInt<font color=Cyan>,</font> QDInt<font color=Cyan>,</font>QDInt<font color=Cyan>)</font>
<a name="line-1584"></a><font color=Blue>q_div_exact</font> x y <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-1585"></a>  <font color=Cyan>(</font>x<font color=Cyan>,</font><font color=Cyan>(</font>y<font color=Cyan>,</font>quot<font color=Cyan>)</font><font color=Cyan>)</font> <font color=Red>&lt;-</font> with_computed_fun x
<a name="line-1586"></a>    <font color=Cyan>(</font><font color=Red>\</font>x <font color=Red>-&gt;</font> <font color=Green><u>do</u></font>
<a name="line-1587"></a>      <font color=Cyan>(</font>x<font color=Cyan>,</font>x_neg<font color=Cyan>)</font> <font color=Red>&lt;-</font> q_negative x
<a name="line-1588"></a>      x' <font color=Red>&lt;-</font> q_negate_in_place x <font color=Cyan>`controlled`</font> x_neg
<a name="line-1589"></a>      return <font color=Cyan>(</font>x'<font color=Cyan>,</font>x_neg<font color=Cyan>)</font><font color=Cyan>)</font>
<a name="line-1590"></a>    <font color=Cyan>(</font><font color=Red>\</font><font color=Cyan>(</font>x'<font color=Cyan>,</font>x_neg<font color=Cyan>)</font> <font color=Red>-&gt;</font> <font color=Green><u>do</u></font>
<a name="line-1591"></a>      <font color=Cyan>(</font>x'<font color=Cyan>,</font>y<font color=Cyan>,</font>quot<font color=Cyan>)</font> <font color=Red>&lt;-</font> q_div_exact_unsigned x' y
<a name="line-1592"></a>      quot <font color=Red>&lt;-</font> q_negate_in_place quot <font color=Cyan>`controlled`</font> x_neg
<a name="line-1593"></a>      return <font color=Cyan>(</font><font color=Cyan>(</font>x'<font color=Cyan>,</font>x_neg<font color=Cyan>)</font><font color=Cyan>,</font><font color=Cyan>(</font>y<font color=Cyan>,</font>quot<font color=Cyan>)</font><font color=Cyan>)</font><font color=Cyan>)</font>
<a name="line-1594"></a>  return <font color=Cyan>(</font>x<font color=Cyan>,</font>y<font color=Cyan>,</font>quot<font color=Cyan>)</font>
<a name="line-1595"></a>
<a name="line-1596"></a><font color=Blue><i>-- ----------------------------------------------------------------------</i></font>
<a name="line-1597"></a><font color=Blue><i>-- * The QNum type class</i></font>
<a name="line-1598"></a>
<a name="line-1599"></a><font color=Blue><i>-- $ This section defines a quantum analogue of Haskell&#8217;s 'Num' type</i></font>
<a name="line-1600"></a><font color=Blue><i>-- class.  See "Quipper.QClasses" for the general philosophy behind</i></font>
<a name="line-1601"></a><font color=Blue><i>-- quantum type classes.</i></font>
<a name="line-1602"></a><font color=Blue><i>-- </i></font>
<a name="line-1603"></a><font color=Blue><i>-- The type class 'QNum' corresponds to Haskell&#8217;s 'Num', with methods</i></font>
<a name="line-1604"></a><font color=Blue><i>-- including </i></font>
<a name="line-1605"></a><font color=Blue><i>-- </i></font>
<a name="line-1606"></a><font color=Blue><i>-- &gt; add_q :: (QNum qa) =&gt; qa -&gt; qa -&gt; Circ (qa,qa,qa), </i></font>
<a name="line-1607"></a><font color=Blue><i>-- </i></font>
<a name="line-1608"></a><font color=Blue><i>-- and so on.</i></font>
<a name="line-1609"></a><font color=Blue><i>-- </i></font>
<a name="line-1610"></a><font color=Blue><i>-- Note: type class instances don't show up in the documentation. View</i></font>
<a name="line-1611"></a><font color=Blue><i>-- the source code to see them.</i></font>
<a name="line-1612"></a>
<a name="line-1613"></a><font color=Blue><i>-- | Quantum analogue of Haskell&#8217;s 'Num' type class. This provides</i></font>
<a name="line-1614"></a><font color=Blue><i>-- basic addition, subtraction, multiplication, sign operations, and</i></font>
<a name="line-1615"></a><font color=Blue><i>-- conversion from integers.</i></font>
<a name="line-1616"></a>
<a name="line-1617"></a><a name="QNum"></a><font color=Green><u>class</u></font> <font color=Cyan>(</font>QData qa<font color=Cyan>)</font> <font color=Red>=&gt;</font> QNum qa <font color=Green><u>where</u></font>
<a name="line-1618"></a>  <font color=Blue><i>-- | Add two quantum numbers into a fresh one. The arguments are</i></font>
<a name="line-1619"></a>  <font color=Blue><i>-- assumed to be of equal size. The 'QDInt' instance uses /O/(&#8467;)</i></font>
<a name="line-1620"></a>  <font color=Blue><i>-- gates, both before and after transformation to Toffoli.</i></font>
<a name="line-1621"></a>  q_add <font color=Red>::</font> qa <font color=Red>-&gt;</font> qa <font color=Red>-&gt;</font> Circ <font color=Cyan>(</font>qa<font color=Cyan>,</font>qa<font color=Cyan>,</font>qa<font color=Cyan>)</font>
<a name="line-1622"></a>  
<a name="line-1623"></a>  <font color=Blue><i>-- | Multiply two quantum numbers into a fresh third. The arguments</i></font>
<a name="line-1624"></a>  <font color=Blue><i>-- are assumed to be of equal size.  The 'QDInt' instance is</i></font>
<a name="line-1625"></a>  <font color=Blue><i>-- /O/(&#8467;[sup 2]).</i></font>
<a name="line-1626"></a>  q_mult <font color=Red>::</font> qa <font color=Red>-&gt;</font> qa <font color=Red>-&gt;</font> Circ <font color=Cyan>(</font>qa<font color=Cyan>,</font>qa<font color=Cyan>,</font>qa<font color=Cyan>)</font>
<a name="line-1627"></a>  
<a name="line-1628"></a>  <font color=Blue><i>-- | Subtract two quantum numbers into a fresh one. The arguments</i></font>
<a name="line-1629"></a>  <font color=Blue><i>-- are assumed to be of equal size. The 'QDInt' instance uses /O/(&#8467;)</i></font>
<a name="line-1630"></a>  <font color=Blue><i>-- gates, both before and after transformation to Toffoli.</i></font>
<a name="line-1631"></a>  q_sub <font color=Red>::</font> qa <font color=Red>-&gt;</font> qa <font color=Red>-&gt;</font> Circ <font color=Cyan>(</font>qa<font color=Cyan>,</font>qa<font color=Cyan>,</font>qa<font color=Cyan>)</font>
<a name="line-1632"></a>  
<a name="line-1633"></a>  <font color=Blue><i>-- | Compute the absolute value of a (signed) quantum number. The</i></font>
<a name="line-1634"></a>  <font color=Blue><i>-- 'QDInt' instance is /O/(&#8467;).</i></font>
<a name="line-1635"></a>  q_abs <font color=Red>::</font> qa <font color=Red>-&gt;</font> Circ <font color=Cyan>(</font>qa<font color=Cyan>,</font>qa<font color=Cyan>)</font>
<a name="line-1636"></a>  
<a name="line-1637"></a>  <font color=Blue><i>-- | Compute the negation of a (signed) quantum number. The 'QDInt'</i></font>
<a name="line-1638"></a>  <font color=Blue><i>-- instance is /O/(&#8467;).</i></font>
<a name="line-1639"></a>  q_negate <font color=Red>::</font> qa <font color=Red>-&gt;</font> Circ <font color=Cyan>(</font>qa<font color=Cyan>,</font>qa<font color=Cyan>)</font>
<a name="line-1640"></a>  
<a name="line-1641"></a>  <font color=Blue><i>-- | Compute a quantum number of the same precision as the input,</i></font>
<a name="line-1642"></a>  <font color=Blue><i>-- with value 1, 0, or &#8211;1, depending on the sign of the</i></font>
<a name="line-1643"></a>  <font color=Blue><i>-- input. Analogous to Haskell&#8217;s 'signum'. The 'QDInt' instance is</i></font>
<a name="line-1644"></a>  <font color=Blue><i>-- /O/(&#8467;).</i></font>
<a name="line-1645"></a>  q_signum <font color=Red>::</font> qa <font color=Red>-&gt;</font> Circ <font color=Cyan>(</font>qa<font color=Cyan>,</font>qa<font color=Cyan>)</font>
<a name="line-1646"></a>  
<a name="line-1647"></a>  <font color=Blue><i>-- | Convert a 'QDInt' to a quantum number. For the 'QDInt'</i></font>
<a name="line-1648"></a>  <font color=Blue><i>-- instance, this is just a copy operation.</i></font>
<a name="line-1649"></a>  q_fromQDInt <font color=Red>::</font> QDInt <font color=Red>-&gt;</font> Circ <font color=Cyan>(</font>QDInt<font color=Cyan>,</font>qa<font color=Cyan>)</font>
<a name="line-1650"></a>   
<a name="line-1651"></a><a name="instance%20QNum%20QDInt"></a><font color=Green><u>instance</u></font> QNum QDInt <font color=Green><u>where</u></font>
<a name="line-1652"></a>  q_add <font color=Red>=</font> q_add_qdint
<a name="line-1653"></a>  q_mult <font color=Red>=</font> q_mult_qdint
<a name="line-1654"></a>  q_sub <font color=Red>=</font> q_sub_qdint
<a name="line-1655"></a>  q_abs <font color=Red>=</font> q_abs_qdint
<a name="line-1656"></a>  q_negate <font color=Red>=</font> q_negate_qdint
<a name="line-1657"></a>  q_signum <font color=Red>=</font> q_signum_qdint
<a name="line-1658"></a>  q_fromQDInt <font color=Red>=</font> qc_copy_fun
<a name="line-1659"></a>
<a name="line-1660"></a><font color=Blue><i>-- ----------------------------------------------------------------------</i></font>
<a name="line-1661"></a><font color=Blue><i>-- ** Specialized functions</i></font>
<a name="line-1662"></a>
<a name="line-1663"></a><a name="q_ext_euclid"></a><font color=Blue><i>-- | Euclid's extended algorithm. 'q_ext_euclid' /a/ /b/: returns</i></font>
<a name="line-1664"></a><font color=Blue><i>-- (/a/,/b/,/x/,/y/,/d/) such that /ax/ + /by/ = /d/ = gcd(/a/,/b/).</i></font>
<a name="line-1665"></a><font color=Blue>q_ext_euclid</font> <font color=Red>::</font> QDInt <font color=Red>-&gt;</font> QDInt <font color=Red>-&gt;</font> Circ <font color=Cyan>(</font>QDInt<font color=Cyan>,</font>QDInt<font color=Cyan>,</font>QDInt<font color=Cyan>,</font>QDInt<font color=Cyan>,</font>QDInt<font color=Cyan>)</font>
<a name="line-1666"></a><font color=Blue>q_ext_euclid</font> a b <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-1667"></a>  <font color=Green><u>let</u></font> l <font color=Red>=</font> common_length <font color=Magenta>"q_ext_euclid: inputs must have equal length"</font> <font color=Red>[</font>a<font color=Cyan>,</font>b<font color=Red>]</font>
<a name="line-1668"></a>
<a name="line-1669"></a>  <font color=Blue><i>-- Extended Euclidean algorithm:</i></font>
<a name="line-1670"></a>  <font color=Blue><i>--</i></font>
<a name="line-1671"></a>  <font color=Blue><i>-- compute three series of numbers (a_i), (x_i), (y_i), such that</i></font>
<a name="line-1672"></a>  <font color=Blue><i>--</i></font>
<a name="line-1673"></a>  <font color=Blue><i>-- a_0 = a, a_1 = b,</i></font>
<a name="line-1674"></a>  <font color=Blue><i>-- a_{i+2} = a_i `mod` a_{i+1},</i></font>
<a name="line-1675"></a>  <font color=Blue><i>-- and always a_i = (x_i * a) + (y_i * b),</i></font>
<a name="line-1676"></a>  <font color=Blue><i>--</i></font>
<a name="line-1677"></a>  <font color=Blue><i>-- When we first get a_{i+2} = 0, we know that a_{i+1} is gcd(a_0,a_1),</i></font>
<a name="line-1678"></a>  <font color=Blue><i>-- so we save a_{i+1}, x_{i+1} and y_{i+1} for output.</i></font>
<a name="line-1679"></a>  <font color=Blue><i>--</i></font>
<a name="line-1680"></a>  <font color=Blue><i>-- The bound on the length of this loop is standard.</i></font>
<a name="line-1681"></a>
<a name="line-1682"></a>  <font color=Cyan>(</font><font color=Cyan>(</font>a<font color=Cyan>,</font>b<font color=Cyan>)</font><font color=Cyan>,</font><font color=Cyan>(</font>x<font color=Cyan>,</font>y<font color=Cyan>)</font><font color=Cyan>)</font> <font color=Red>&lt;-</font> with_computed_fun <font color=Cyan>(</font>a<font color=Cyan>,</font>b<font color=Cyan>)</font> <font color=Cyan>(</font><font color=Red>\</font><font color=Cyan>(</font>a<font color=Cyan>,</font>b<font color=Cyan>)</font> <font color=Red>-&gt;</font> <font color=Green><u>do</u></font>
<a name="line-1683"></a>    x0 <font color=Red>&lt;-</font> qinit <font color=Cyan>(</font>intm l <font color=Magenta>1</font><font color=Cyan>)</font>
<a name="line-1684"></a>    y0 <font color=Red>&lt;-</font> qinit <font color=Cyan>(</font>intm l <font color=Magenta>0</font><font color=Cyan>)</font>
<a name="line-1685"></a>    x1 <font color=Red>&lt;-</font> qinit <font color=Cyan>(</font>intm l <font color=Magenta>0</font><font color=Cyan>)</font>
<a name="line-1686"></a>    y1 <font color=Red>&lt;-</font> qinit <font color=Cyan>(</font>intm l <font color=Magenta>1</font><font color=Cyan>)</font>
<a name="line-1687"></a>    done_yet <font color=Red>&lt;-</font> qinit False
<a name="line-1688"></a>    x_final <font color=Red>&lt;-</font> qinit <font color=Cyan>(</font>intm l <font color=Magenta>0</font><font color=Cyan>)</font>
<a name="line-1689"></a>    y_final <font color=Red>&lt;-</font> qinit <font color=Cyan>(</font>intm l <font color=Magenta>0</font><font color=Cyan>)</font>
<a name="line-1690"></a>
<a name="line-1691"></a>    <font color=Cyan>(</font>stuff1<font color=Cyan>,</font> stuff2<font color=Cyan>,</font> stuff3<font color=Cyan>,</font> <font color=Cyan>(</font>done_yet<font color=Cyan>,</font> x_final<font color=Cyan>,</font> y_final<font color=Cyan>)</font><font color=Cyan>)</font>
<a name="line-1692"></a>            <font color=Red>&lt;-</font> loopM <font color=Cyan>(</font>euclid_bound l<font color=Cyan>)</font> <font color=Cyan>(</font><font color=Cyan>(</font>a<font color=Cyan>,</font>b<font color=Cyan>,</font>x0<font color=Cyan>,</font>x1<font color=Cyan>,</font>y0<font color=Cyan>,</font>y1<font color=Cyan>)</font><font color=Cyan>,</font>[]<font color=Cyan>,</font>[]<font color=Cyan>,</font><font color=Cyan>(</font>done_yet<font color=Cyan>,</font>x_final<font color=Cyan>,</font>y_final<font color=Cyan>)</font><font color=Cyan>)</font>
<a name="line-1693"></a>      <font color=Cyan>(</font><font color=Red>\</font><font color=Cyan>(</font><font color=Cyan>(</font>a_i<font color=Cyan>,</font> a_i1<font color=Cyan>,</font> x_i<font color=Cyan>,</font> x_i1<font color=Cyan>,</font> y_i<font color=Cyan>,</font> y_i1<font color=Cyan>)</font><font color=Cyan>,</font> quots_scratch<font color=Cyan>,</font> tests_scratch<font color=Cyan>,</font> <font color=Cyan>(</font>done_yet<font color=Cyan>,</font> x_final<font color=Cyan>,</font> y_final<font color=Cyan>)</font><font color=Cyan>)</font> <font color=Red>-&gt;</font> <font color=Green><u>do</u></font>
<a name="line-1694"></a>        <font color=Cyan>(</font>a_i2<font color=Cyan>,</font> a_i1<font color=Cyan>,</font> q_i<font color=Cyan>)</font> <font color=Red>&lt;-</font> q_moddiv_unsigned_in_place a_i a_i1
<a name="line-1695"></a>        <font color=Cyan>(</font><font color=Cyan>(</font>x_i1<font color=Cyan>,</font> y_i1<font color=Cyan>,</font> q_i<font color=Cyan>)</font><font color=Cyan>,</font> <font color=Cyan>(</font>x_i2<font color=Cyan>,</font> y_i2<font color=Cyan>)</font><font color=Cyan>)</font> <font color=Red>&lt;-</font> with_computed_fun
<a name="line-1696"></a>          <font color=Cyan>(</font>x_i1<font color=Cyan>,</font> y_i1<font color=Cyan>,</font> q_i<font color=Cyan>)</font>
<a name="line-1697"></a>          <font color=Cyan>(</font><font color=Red>\</font><font color=Cyan>(</font>x_i1<font color=Cyan>,</font> y_i1<font color=Cyan>,</font> q_i<font color=Cyan>)</font> <font color=Red>-&gt;</font> <font color=Green><u>do</u></font>
<a name="line-1698"></a>            <font color=Cyan>(</font>q_i<font color=Cyan>,</font> x_i1<font color=Cyan>,</font> qx<font color=Cyan>)</font> <font color=Red>&lt;-</font> q_mult q_i x_i1
<a name="line-1699"></a>            <font color=Cyan>(</font>q_i<font color=Cyan>,</font> y_i1<font color=Cyan>,</font> qy<font color=Cyan>)</font> <font color=Red>&lt;-</font> q_mult q_i y_i1
<a name="line-1700"></a>            return <font color=Cyan>(</font>x_i1<font color=Cyan>,</font> y_i1<font color=Cyan>,</font> q_i<font color=Cyan>,</font> qx<font color=Cyan>,</font> qy<font color=Cyan>)</font><font color=Cyan>)</font>
<a name="line-1701"></a>          <font color=Cyan>(</font><font color=Red>\</font><font color=Cyan>(</font>x_i1<font color=Cyan>,</font> y_i1<font color=Cyan>,</font> q_i<font color=Cyan>,</font> qx<font color=Cyan>,</font> qy<font color=Cyan>)</font> <font color=Red>-&gt;</font> <font color=Green><u>do</u></font>
<a name="line-1702"></a>            <font color=Cyan>(</font>qx<font color=Cyan>,</font>x_i2<font color=Cyan>)</font> <font color=Red>&lt;-</font> q_sub_in_place qx x_i
<a name="line-1703"></a>            <font color=Cyan>(</font>qy<font color=Cyan>,</font>y_i2<font color=Cyan>)</font> <font color=Red>&lt;-</font> q_sub_in_place qy y_i
<a name="line-1704"></a>            return <font color=Cyan>(</font><font color=Cyan>(</font>x_i1<font color=Cyan>,</font> y_i1<font color=Cyan>,</font> q_i<font color=Cyan>,</font> qx<font color=Cyan>,</font> qy<font color=Cyan>)</font><font color=Cyan>,</font><font color=Cyan>(</font>x_i2<font color=Cyan>,</font>y_i2<font color=Cyan>)</font><font color=Cyan>)</font><font color=Cyan>)</font>
<a name="line-1705"></a>        done_this_time <font color=Red>&lt;-</font> qinit False
<a name="line-1706"></a>        done_this_time <font color=Red>&lt;-</font> qnot done_this_time <font color=Cyan>`controlled`</font> <font color=Cyan>(</font>a_i2 <font color=Cyan>.==.</font> <font color=Magenta>0</font><font color=Cyan>)</font> <font color=Cyan>.&amp;&amp;.</font> <font color=Cyan>(</font>done_yet <font color=Cyan>.==.</font> False<font color=Cyan>)</font>
<a name="line-1707"></a>        <font color=Cyan>(</font>x_i1<font color=Cyan>,</font>x_final<font color=Cyan>)</font> <font color=Red>&lt;-</font> controlled_not x_final x_i1 <font color=Cyan>`controlled`</font> done_this_time
<a name="line-1708"></a>        <font color=Cyan>(</font>y_i1<font color=Cyan>,</font>y_final<font color=Cyan>)</font> <font color=Red>&lt;-</font> controlled_not y_final y_i1 <font color=Cyan>`controlled`</font> done_this_time
<a name="line-1709"></a>        done_yet <font color=Red>&lt;-</font> qnot done_yet <font color=Cyan>`controlled`</font> done_this_time
<a name="line-1710"></a>        return <font color=Cyan>(</font><font color=Cyan>(</font>a_i1<font color=Cyan>,</font> a_i2<font color=Cyan>,</font> x_i1<font color=Cyan>,</font> x_i2<font color=Cyan>,</font> y_i1<font color=Cyan>,</font> y_i2<font color=Cyan>)</font><font color=Cyan>,</font>
<a name="line-1711"></a>                <font color=Cyan>(</font>q_i<font color=Red><b>:</b></font>quots_scratch<font color=Cyan>)</font><font color=Cyan>,</font> <font color=Cyan>(</font>done_this_time<font color=Red><b>:</b></font>tests_scratch<font color=Cyan>)</font><font color=Cyan>,</font> 
<a name="line-1712"></a>                <font color=Cyan>(</font>done_yet<font color=Cyan>,</font> x_final<font color=Cyan>,</font> y_final<font color=Cyan>)</font><font color=Cyan>)</font><font color=Cyan>)</font>
<a name="line-1713"></a>    qterm True done_yet <font color=Blue><i>-- Assert that we really did reach the end of the algorithm. </i></font>
<a name="line-1714"></a>    return <font color=Cyan>(</font>x_final<font color=Cyan>,</font>y_final<font color=Cyan>,</font><font color=Cyan>(</font>stuff1<font color=Cyan>,</font> stuff2<font color=Cyan>,</font> stuff3<font color=Cyan>)</font><font color=Cyan>)</font><font color=Cyan>)</font>
<a name="line-1715"></a>
<a name="line-1716"></a>    <font color=Cyan>(</font><font color=Red>\</font><font color=Cyan>(</font>x_final<font color=Cyan>,</font> y_final<font color=Cyan>,</font> stuff<font color=Cyan>)</font> <font color=Red>-&gt;</font> <font color=Green><u>do</u></font>
<a name="line-1717"></a>      <font color=Cyan>(</font>x_final<font color=Cyan>,</font>x<font color=Cyan>)</font> <font color=Red>&lt;-</font> qc_copy_fun x_final
<a name="line-1718"></a>      <font color=Cyan>(</font>y_final<font color=Cyan>,</font>y<font color=Cyan>)</font> <font color=Red>&lt;-</font> qc_copy_fun y_final
<a name="line-1719"></a>      return <font color=Cyan>(</font><font color=Cyan>(</font>x_final<font color=Cyan>,</font> y_final<font color=Cyan>,</font> stuff<font color=Cyan>)</font><font color=Cyan>,</font><font color=Cyan>(</font>x<font color=Cyan>,</font>y<font color=Cyan>)</font><font color=Cyan>)</font><font color=Cyan>)</font>
<a name="line-1720"></a>
<a name="line-1721"></a>  <font color=Cyan>(</font><font color=Cyan>(</font>a<font color=Cyan>,</font>b<font color=Cyan>,</font>x<font color=Cyan>,</font>y<font color=Cyan>)</font><font color=Cyan>,</font>gcd<font color=Cyan>)</font> <font color=Red>&lt;-</font> with_computed_fun
<a name="line-1722"></a>    <font color=Cyan>(</font>a<font color=Cyan>,</font>b<font color=Cyan>,</font>x<font color=Cyan>,</font>y<font color=Cyan>)</font>
<a name="line-1723"></a>    <font color=Cyan>(</font><font color=Red>\</font><font color=Cyan>(</font>a<font color=Cyan>,</font>b<font color=Cyan>,</font>x<font color=Cyan>,</font>y<font color=Cyan>)</font> <font color=Red>-&gt;</font> <font color=Green><u>do</u></font>
<a name="line-1724"></a>      <font color=Cyan>(</font>a<font color=Cyan>,</font>x<font color=Cyan>,</font>ax<font color=Cyan>)</font> <font color=Red>&lt;-</font> q_mult a x
<a name="line-1725"></a>      <font color=Cyan>(</font>b<font color=Cyan>,</font>y<font color=Cyan>,</font>by<font color=Cyan>)</font> <font color=Red>&lt;-</font> q_mult b y
<a name="line-1726"></a>      return <font color=Cyan>(</font>a<font color=Cyan>,</font>b<font color=Cyan>,</font>x<font color=Cyan>,</font>y<font color=Cyan>,</font>ax<font color=Cyan>,</font>by<font color=Cyan>)</font><font color=Cyan>)</font>
<a name="line-1727"></a>    <font color=Cyan>(</font><font color=Red>\</font><font color=Cyan>(</font>a<font color=Cyan>,</font>b<font color=Cyan>,</font>x<font color=Cyan>,</font>y<font color=Cyan>,</font>ax<font color=Cyan>,</font>by<font color=Cyan>)</font> <font color=Red>-&gt;</font> <font color=Green><u>do</u></font>
<a name="line-1728"></a>      <font color=Cyan>(</font>ax<font color=Cyan>,</font>by<font color=Cyan>,</font>gcd<font color=Cyan>)</font> <font color=Red>&lt;-</font> q_add ax by
<a name="line-1729"></a>      return <font color=Cyan>(</font><font color=Cyan>(</font>a<font color=Cyan>,</font>b<font color=Cyan>,</font>x<font color=Cyan>,</font>y<font color=Cyan>,</font>ax<font color=Cyan>,</font>by<font color=Cyan>)</font><font color=Cyan>,</font>gcd<font color=Cyan>)</font><font color=Cyan>)</font>
<a name="line-1730"></a>
<a name="line-1731"></a>  return <font color=Cyan>(</font>a<font color=Cyan>,</font>b<font color=Cyan>,</font>x<font color=Cyan>,</font>y<font color=Cyan>,</font>gcd<font color=Cyan>)</font>
<a name="line-1732"></a>
<a name="line-1733"></a>  <font color=Green><u>where</u></font>
<a name="line-1734"></a>  <font color=Blue><i>-- Classical bound on running time (Lam&#233;&#8217;s theorem), assuming b &lt; a:</i></font>
<a name="line-1735"></a>  <font color=Blue><i>-- t &lt;= 1 + log_{phi} b &lt;= 1 + l / (log_2 phi)</i></font>
<a name="line-1736"></a>  <font color=Blue><i>--  </i></font>
<a name="line-1737"></a>  <font color=Blue><i>-- We allow one extra step since we may have a &lt; b, in which case first step swaps them.</i></font>
<a name="line-1738"></a>    euclid_bound <font color=Red>::</font> Int <font color=Red>-&gt;</font> Int
<a name="line-1739"></a>    euclid_bound l <font color=Red>=</font> <font color=Magenta>2</font> <font color=Cyan>+</font> ceiling <font color=Cyan>(</font> <font color=Cyan>(</font>fromIntegral l<font color=Cyan>)</font> <font color=Cyan>/</font> <font color=Cyan>(</font>logBase <font color=Magenta>2</font> phi<font color=Cyan>)</font> <font color=Cyan>)</font>
<a name="line-1740"></a>    phi <font color=Red>=</font> <font color=Cyan>(</font><font color=Magenta>1</font><font color=Cyan>+</font>sqrt<font color=Cyan>(</font><font color=Magenta>5</font><font color=Cyan>)</font><font color=Cyan>)</font><font color=Cyan>/</font><font color=Magenta>2</font>
<a name="line-1741"></a>
<a name="line-1742"></a><font color=Blue><i>-- ----------------------------------------------------------------------</i></font>
<a name="line-1743"></a><font color=Blue><i>-- * Lifting of arithmetic functions</i></font>
<a name="line-1744"></a>
<a name="line-1745"></a><font color=Blue><i>-- $LIFTING </i></font>
<a name="line-1746"></a><font color=Blue><i>-- This sections provides templates for lifting various arithmetic</i></font>
<a name="line-1747"></a><font color=Blue><i>-- functions in connection with the @build_circuit@ keyword. This</i></font>
<a name="line-1748"></a><font color=Blue><i>-- extends the liftings given in "Quipper.CircLifting" to operations</i></font>
<a name="line-1749"></a><font color=Blue><i>-- of the 'Num' type class.</i></font>
<a name="line-1750"></a>
<a name="line-1751"></a><a name="template_symb_plus_"></a><font color=Blue><i>-- | Quantum lifting of the '+' operator.</i></font>
<a name="line-1752"></a><font color=Blue>template_symb_plus_</font> <font color=Red>::</font> <font color=Cyan>(</font>QNum qa<font color=Cyan>)</font> <font color=Red>=&gt;</font> Circ <font color=Cyan>(</font>qa <font color=Red>-&gt;</font> Circ <font color=Cyan>(</font>qa <font color=Red>-&gt;</font> Circ qa<font color=Cyan>)</font><font color=Cyan>)</font>
<a name="line-1753"></a><font color=Blue>template_symb_plus_</font> <font color=Red>=</font> return <font color=Cyan>$</font> <font color=Red>\</font>qx <font color=Red>-&gt;</font> return <font color=Cyan>$</font> <font color=Red>\</font>qy <font color=Red>-&gt;</font> <font color=Green><u>do</u></font> <font color=Cyan>(</font>qx<font color=Cyan>,</font>qy<font color=Cyan>,</font>qz<font color=Cyan>)</font> <font color=Red>&lt;-</font> q_add qx qy<font color=Cyan>;</font> return qz
<a name="line-1754"></a>
<a name="line-1755"></a><font color=Blue><i>-- TODO: complete templates of methods.</i></font>
<a name="line-1756"></a>
</pre>
</body>
</html>