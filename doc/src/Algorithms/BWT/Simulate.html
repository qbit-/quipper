<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<html>
<head>
<!-- Generated by HsColour, http://code.haskell.org/~malcolm/hscolour/ -->
<title>Haskell code</title>
</head>
<body>
<pre><a name="line-1"></a><font color=Blue><i>-- | This module contains functions for simulating and debugging</i></font>
<a name="line-2"></a><font color=Blue><i>-- BWT oracles.</i></font>
<a name="line-3"></a>
<a name="line-4"></a><font color=Green><u>module</u></font> Algorithms<font color=Cyan>.</font>BWT<font color=Cyan>.</font>Simulate <font color=Green><u>where</u></font>
<a name="line-5"></a>
<a name="line-6"></a><font color=Green><u>import</u></font> Quipper hiding <font color=Cyan>(</font>comment<font color=Cyan>)</font>
<a name="line-7"></a>
<a name="line-8"></a><font color=Green><u>import</u></font> QuipperLib<font color=Cyan>.</font>Qureg
<a name="line-9"></a><font color=Green><u>import</u></font> QuipperLib<font color=Cyan>.</font>Simulation
<a name="line-10"></a><font color=Green><u>import</u></font> QuipperLib<font color=Cyan>.</font>Decompose
<a name="line-11"></a>
<a name="line-12"></a><font color=Blue><i>-- import other Quipper stuff</i></font>
<a name="line-13"></a><font color=Green><u>import</u></font> Algorithms<font color=Cyan>.</font>BWT<font color=Cyan>.</font>Definitions
<a name="line-14"></a><font color=Green><u>import</u></font> Algorithms<font color=Cyan>.</font>BWT<font color=Cyan>.</font>BWT
<a name="line-15"></a>
<a name="line-16"></a><font color=Green><u>import</u></font> Libraries<font color=Cyan>.</font>Sampling
<a name="line-17"></a><font color=Green><u>import</u></font> Libraries<font color=Cyan>.</font>Auxiliary
<a name="line-18"></a>
<a name="line-19"></a><font color=Blue><i>-- import other stuff</i></font>
<a name="line-20"></a><font color=Green><u>import</u></font> Graphics<font color=Cyan>.</font>EasyRender
<a name="line-21"></a><font color=Green><u>import</u></font> Text<font color=Cyan>.</font>Printf
<a name="line-22"></a><font color=Green><u>import</u></font> Data<font color=Cyan>.</font>Bits
<a name="line-23"></a>
<a name="line-24"></a><font color=Blue><i>-- ======================================================================</i></font>
<a name="line-25"></a><font color=Blue><i>-- * Generic simulation</i></font>
<a name="line-26"></a>
<a name="line-27"></a><a name="simulate_edges"></a><font color=Blue><i>-- | Inputs an oracle and prints out a list of colored edges in text</i></font>
<a name="line-28"></a><font color=Blue><i>-- format. This is done by simulating the circuit for every possible</i></font>
<a name="line-29"></a><font color=Blue><i>-- input, decomposed to the given 'GateBase'.</i></font>
<a name="line-30"></a><font color=Blue>simulate_edges</font> <font color=Red>::</font> GateBase <font color=Red>-&gt;</font> Oracle <font color=Red>-&gt;</font> IO()
<a name="line-31"></a><font color=Blue>simulate_edges</font> gb oracle <font color=Red>=</font>
<a name="line-32"></a>  mapM_ output <font color=Cyan>(</font>sample_all0 <font color=Cyan>(</font><font color=Magenta>2</font><font color=Cyan>^</font>m'<font color=Blue><i>-</i></font><font color=Magenta>1</font><font color=Cyan>,</font> <font color=Magenta>3</font><font color=Cyan>)</font><font color=Cyan>)</font>
<a name="line-33"></a>  <font color=Green><u>where</u></font>
<a name="line-34"></a>    m' <font color=Red>=</font> <font color=Cyan>(</font>m oracle<font color=Cyan>)</font>
<a name="line-35"></a>    ofun c <font color=Cyan>(</font>a<font color=Cyan>,</font> b<font color=Cyan>,</font> r<font color=Cyan>)</font> <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-36"></a>      <font color=Green><u>let</u></font> a_reg <font color=Red>=</font> qureg_of_qulist_te a
<a name="line-37"></a>      <font color=Green><u>let</u></font> b_reg <font color=Red>=</font> qureg_of_qulist_te b
<a name="line-38"></a>      <font color=Cyan>(</font>oraclefun oracle<font color=Cyan>)</font> c <font color=Cyan>(</font>a_reg<font color=Cyan>,</font> b_reg<font color=Cyan>,</font> r<font color=Cyan>)</font>
<a name="line-39"></a>      return <font color=Cyan>(</font>a<font color=Cyan>,</font> b<font color=Cyan>,</font> r<font color=Cyan>)</font>
<a name="line-40"></a>    
<a name="line-41"></a>    simulate <font color=Red>::</font> <font color=Cyan>(</font>Int<font color=Cyan>,</font> Int<font color=Cyan>)</font> <font color=Red>-&gt;</font> <font color=Cyan>(</font>Int<font color=Cyan>,</font> Bool<font color=Cyan>)</font>
<a name="line-42"></a>    simulate <font color=Cyan>(</font>c<font color=Cyan>,</font> a<font color=Cyan>)</font> <font color=Red>=</font> <font color=Cyan>(</font>b1<font color=Cyan>,</font> r1<font color=Cyan>)</font> <font color=Green><u>where</u></font>
<a name="line-43"></a>      
<a name="line-44"></a>      <font color=Blue><i>-- convert inputs to boollisttors</i></font>
<a name="line-45"></a>      a_in <font color=Red>=</font> boollist_of_int_bh m' a
<a name="line-46"></a>      b_in <font color=Red>=</font> take m' <font color=Cyan>$</font> repeat False
<a name="line-47"></a>      r_in <font color=Red>=</font> False
<a name="line-48"></a>    
<a name="line-49"></a>      <font color=Cyan>(</font>a_out<font color=Cyan>,</font> b_out<font color=Cyan>,</font> r_out<font color=Cyan>)</font> <font color=Red>=</font> run_classical_generic <font color=Cyan>(</font>decompose_generic gb <font color=Cyan>(</font>ofun c<font color=Cyan>)</font><font color=Cyan>)</font> <font color=Cyan>(</font>a_in<font color=Cyan>,</font> b_in<font color=Cyan>,</font> r_in<font color=Cyan>)</font>
<a name="line-50"></a>      
<a name="line-51"></a>      <font color=Blue><i>-- convert outputs to integers</i></font>
<a name="line-52"></a>      a1 <font color=Red>=</font> int_of_boollist_unsigned_bh a_out
<a name="line-53"></a>      b1 <font color=Red>=</font> int_of_boollist_unsigned_bh b_out
<a name="line-54"></a>      r1 <font color=Red>=</font> r_out
<a name="line-55"></a>      
<a name="line-56"></a>    output <font color=Red>::</font> <font color=Cyan>(</font>Int<font color=Cyan>,</font> Int<font color=Cyan>)</font> <font color=Red>-&gt;</font> IO()
<a name="line-57"></a>    output <font color=Cyan>(</font>a<font color=Cyan>,</font> c<font color=Cyan>)</font> <font color=Red>=</font>
<a name="line-58"></a>      <font color=Green><u>case</u></font> simulate <font color=Cyan>(</font>c<font color=Cyan>,</font> a<font color=Cyan>)</font> <font color=Green><u>of</u></font>
<a name="line-59"></a>        <font color=Cyan>(</font>b<font color=Cyan>,</font> False<font color=Cyan>)</font> <font color=Red>-&gt;</font> printf <font color=Magenta>"%d ---%d---&gt; %d\n"</font> a c b
<a name="line-60"></a>        <font color=Cyan>(</font>b<font color=Cyan>,</font> True<font color=Cyan>)</font> <font color=Red>-&gt;</font> printf <font color=Magenta>"%d ---%d---&gt; None (%d)\n"</font> a c b
<a name="line-61"></a>        
<a name="line-62"></a><a name="render_oracle"></a><font color=Blue><i>-- | Input an oracle and output the colored edges in graphical</i></font>
<a name="line-63"></a><font color=Blue><i>-- format. This is done by simulating the circuit for every possible</i></font>
<a name="line-64"></a><font color=Blue><i>-- input. The second parameter is a boolean which determines whether</i></font>
<a name="line-65"></a><font color=Blue><i>-- the node numbering follows the schema of the orthodox oracle</i></font>
<a name="line-66"></a><font color=Blue><i>-- ('True') or the simple oracle ('False').</i></font>
<a name="line-67"></a><font color=Blue>render_oracle</font> <font color=Red>::</font> GateBase <font color=Red>-&gt;</font> Bool <font color=Red>-&gt;</font> Oracle <font color=Red>-&gt;</font> Document ()
<a name="line-68"></a><font color=Blue>render_oracle</font> gb node_style oracle <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-69"></a>  newpage <font color=Cyan>(</font>sc <font color=Cyan>*</font> width<font color=Cyan>)</font> <font color=Cyan>(</font>sc <font color=Cyan>*</font> height<font color=Cyan>)</font> <font color=Cyan>$</font> <font color=Green><u>do</u></font>
<a name="line-70"></a>    scale sc sc
<a name="line-71"></a>    setlinewidth linewidth
<a name="line-72"></a>    sequence_ <font color=Red>[</font> output a c <font color=Red>|</font> <font color=Cyan>(</font>a<font color=Cyan>,</font>c<font color=Cyan>)</font> <font color=Red>&lt;-</font> sample_all0 <font color=Cyan>(</font><font color=Magenta>2</font><font color=Cyan>^</font>m'<font color=Blue><i>-</i></font><font color=Magenta>1</font><font color=Cyan>,</font> <font color=Magenta>3</font><font color=Cyan>)</font> <font color=Red>]</font>
<a name="line-73"></a>    setcolor <font color=Cyan>(</font>Color_Gray <font color=Magenta>0</font><font color=Cyan>)</font>
<a name="line-74"></a>    sequence_ <font color=Red>[</font> label a <font color=Red>|</font> a <font color=Red>&lt;-</font> sample_all0 <font color=Cyan>(</font><font color=Magenta>2</font><font color=Cyan>^</font>m'<font color=Blue><i>-</i></font><font color=Magenta>1</font><font color=Cyan>)</font> <font color=Red>]</font>
<a name="line-75"></a>  <font color=Green><u>where</u></font>
<a name="line-76"></a>    sc <font color=Red>=</font> <font color=Magenta>5.0</font> <font color=Red>::</font> Double
<a name="line-77"></a>    labelfont <font color=Red>=</font> Font TimesRoman <font color=Magenta>0.8</font>
<a name="line-78"></a>    dotradius <font color=Red>=</font> <font color=Magenta>0.1</font> <font color=Red>::</font> Double
<a name="line-79"></a>    linewidth <font color=Red>=</font> <font color=Magenta>0.04</font> <font color=Red>::</font> Double
<a name="line-80"></a>    black <font color=Red>=</font> Color_Gray <font color=Magenta>0</font>
<a name="line-81"></a>
<a name="line-82"></a>    m' <font color=Red>=</font> <font color=Cyan>(</font>m oracle<font color=Cyan>)</font>
<a name="line-83"></a>    n' <font color=Red>=</font> <font color=Cyan>(</font>n oracle<font color=Cyan>)</font>
<a name="line-84"></a>    nn <font color=Red>=</font> fromIntegral n'
<a name="line-85"></a>    ofun c <font color=Cyan>(</font>a<font color=Cyan>,</font> b<font color=Cyan>,</font> r<font color=Cyan>)</font> <font color=Red>=</font> <font color=Green><u>do</u></font>    
<a name="line-86"></a>      <font color=Green><u>let</u></font> a_reg <font color=Red>=</font> qureg_of_qulist_te a
<a name="line-87"></a>      <font color=Green><u>let</u></font> b_reg <font color=Red>=</font> qureg_of_qulist_te b
<a name="line-88"></a>      <font color=Cyan>(</font>oraclefun oracle<font color=Cyan>)</font> c <font color=Cyan>(</font>a_reg<font color=Cyan>,</font> b_reg<font color=Cyan>,</font> r<font color=Cyan>)</font>
<a name="line-89"></a>      return <font color=Cyan>(</font>a<font color=Cyan>,</font> b<font color=Cyan>,</font> r<font color=Cyan>)</font>
<a name="line-90"></a>    
<a name="line-91"></a>    simulate <font color=Red>::</font> <font color=Cyan>(</font>Int<font color=Cyan>,</font> Int<font color=Cyan>)</font> <font color=Red>-&gt;</font> <font color=Cyan>(</font>Int<font color=Cyan>,</font> Bool<font color=Cyan>)</font>
<a name="line-92"></a>    simulate <font color=Cyan>(</font>c<font color=Cyan>,</font> a<font color=Cyan>)</font> <font color=Red>=</font> <font color=Cyan>(</font>b1<font color=Cyan>,</font> r1<font color=Cyan>)</font> <font color=Green><u>where</u></font>
<a name="line-93"></a>      
<a name="line-94"></a>      <font color=Blue><i>-- convert inputs to boollisttors</i></font>
<a name="line-95"></a>      a_in <font color=Red>=</font> boollist_of_int_bh m' a
<a name="line-96"></a>      b_in <font color=Red>=</font> take m' <font color=Cyan>$</font> repeat False
<a name="line-97"></a>      r_in <font color=Red>=</font> False
<a name="line-98"></a>    
<a name="line-99"></a>      <font color=Cyan>(</font>a_out<font color=Cyan>,</font> b_out<font color=Cyan>,</font> r_out<font color=Cyan>)</font> <font color=Red>=</font> run_classical_generic <font color=Cyan>(</font>decompose_generic gb <font color=Cyan>(</font>ofun c<font color=Cyan>)</font><font color=Cyan>)</font> <font color=Cyan>(</font>a_in<font color=Cyan>,</font> b_in<font color=Cyan>,</font> r_in<font color=Cyan>)</font>
<a name="line-100"></a>      
<a name="line-101"></a>      <font color=Blue><i>-- convert outputs to integers</i></font>
<a name="line-102"></a>      a1 <font color=Red>=</font> int_of_boollist_unsigned_bh a_out
<a name="line-103"></a>      b1 <font color=Red>=</font> int_of_boollist_unsigned_bh b_out
<a name="line-104"></a>      r1 <font color=Red>=</font> r_out
<a name="line-105"></a>      
<a name="line-106"></a>    width <font color=Red>=</font> <font color=Magenta>2.0</font><font color=Cyan>^</font><font color=Cyan>(</font>n'<font color=Cyan>+</font><font color=Magenta>1</font><font color=Cyan>)</font> 
<a name="line-107"></a>    height <font color=Red>=</font> <font color=Cyan>(</font><font color=Magenta>2.0</font><font color=Cyan>*</font><font color=Cyan>(</font>nn<font color=Cyan>)</font><font color=Cyan>+</font><font color=Magenta>4</font><font color=Cyan>)</font> <font color=Cyan>*</font> <font color=Magenta>2.0</font>  <font color=Cyan>+</font> <font color=Magenta>2.0</font><font color=Cyan>^</font>n' 
<a name="line-108"></a>    
<a name="line-109"></a>    <font color=Blue><i>-- coord: map a node id to a pair of coordinates</i></font>
<a name="line-110"></a>    coord_simple <font color=Red>::</font> Int <font color=Red>-&gt;</font> <font color=Cyan>(</font>Double<font color=Cyan>,</font> Double<font color=Cyan>)</font>
<a name="line-111"></a>    coord_simple a <font color=Red>=</font> <font color=Cyan>(</font>x<font color=Cyan>,</font>y<font color=Cyan>)</font> <font color=Green><u>where</u></font>
<a name="line-112"></a>      t <font color=Red>=</font> <font color=Cyan>(</font>a <font color=Cyan>.&amp;.</font> <font color=Cyan>(</font><font color=Magenta>2</font><font color=Cyan>^</font><font color=Cyan>(</font>n'<font color=Cyan>+</font><font color=Magenta>1</font><font color=Cyan>)</font><font color=Cyan>)</font> <font color=Cyan>/=</font> <font color=Magenta>0</font><font color=Cyan>)</font>  <font color=Blue><i>-- tree bit</i></font>
<a name="line-113"></a>      a' <font color=Red>=</font> a <font color=Cyan>.&amp;.</font> <font color=Cyan>(</font><font color=Magenta>2</font><font color=Cyan>^</font><font color=Cyan>(</font>n'<font color=Cyan>+</font><font color=Magenta>1</font><font color=Cyan>)</font><font color=Blue><i>-</i></font><font color=Magenta>1</font><font color=Cyan>)</font>      <font color=Blue><i>-- node address</i></font>
<a name="line-114"></a>      h <font color=Red>=</font> hibit a'                 <font color=Blue><i>-- logical height in subtree</i></font>
<a name="line-115"></a>      w <font color=Red>=</font> a' <font color=Cyan>.&amp;.</font> <font color=Cyan>(</font><font color=Magenta>2</font><font color=Cyan>^</font><font color=Cyan>(</font>h<font color=Blue><i>-</i></font><font color=Magenta>1</font><font color=Cyan>)</font><font color=Blue><i>-</i></font><font color=Magenta>1</font><font color=Cyan>)</font>       <font color=Blue><i>-- logical position in row</i></font>
<a name="line-116"></a>      hh <font color=Red>=</font> fromIntegral h
<a name="line-117"></a>      ww <font color=Red>=</font> fromIntegral w
<a name="line-118"></a>      h1 <font color=Red>=</font> <font color=Magenta>1</font> <font color=Cyan>+</font> <font color=Magenta>2</font> <font color=Cyan>*</font> hh    <font color=Blue><i>-- physical height in subtree</i></font>
<a name="line-119"></a>      y <font color=Red>=</font> <font color=Green><u>if</u></font> t <font color=Green><u>then</u></font> h1 <font color=Green><u>else</u></font> height <font color=Blue><i>-</i></font> h1
<a name="line-120"></a>      x <font color=Red>=</font> <font color=Green><u>if</u></font> h <font color=Cyan>==</font> <font color=Magenta>0</font> <font color=Green><u>then</u></font> <font color=Magenta>0.5</font> <font color=Cyan>*</font> width <font color=Green><u>else</u></font> <font color=Cyan>(</font><font color=Magenta>1</font><font color=Cyan>+</font><font color=Magenta>2</font><font color=Cyan>*</font>ww<font color=Cyan>)</font>  <font color=Cyan>*</font> <font color=Magenta>2</font><font color=Cyan>^</font><font color=Cyan>(</font>n'<font color=Cyan>+</font><font color=Magenta>1</font><font color=Blue><i>-</i></font>h<font color=Cyan>)</font>
<a name="line-121"></a>    
<a name="line-122"></a>    <font color=Blue><i>-- coord_orthodox: same as coord, but use the layout of the orthodox oracle.</i></font>
<a name="line-123"></a>    coord_orthodox <font color=Red>::</font> Int <font color=Red>-&gt;</font> <font color=Cyan>(</font>Double<font color=Cyan>,</font> Double<font color=Cyan>)</font>
<a name="line-124"></a>    coord_orthodox a <font color=Red>|</font> a <font color=Cyan>&gt;=</font> <font color=Magenta>2</font><font color=Cyan>^</font><font color=Cyan>(</font>n'<font color=Cyan>+</font><font color=Magenta>1</font><font color=Cyan>)</font> <font color=Red>=</font> <font color=Cyan>(</font>width <font color=Blue><i>-</i></font> x<font color=Cyan>,</font>y<font color=Cyan>)</font> <font color=Green><u>where</u></font>
<a name="line-125"></a>      <font color=Cyan>(</font>x<font color=Cyan>,</font>y<font color=Cyan>)</font> <font color=Red>=</font> coord_simple <font color=Cyan>(</font><font color=Magenta>2</font><font color=Cyan>^</font><font color=Cyan>(</font>n'<font color=Cyan>+</font><font color=Magenta>2</font><font color=Cyan>)</font><font color=Cyan>+</font><font color=Magenta>2</font><font color=Cyan>^</font><font color=Cyan>(</font>n'<font color=Cyan>+</font><font color=Magenta>1</font><font color=Cyan>)</font><font color=Blue><i>-</i></font><font color=Magenta>1</font><font color=Blue><i>-</i></font>a<font color=Cyan>)</font>
<a name="line-126"></a>    coord_orthodox a <font color=Red>=</font> coord_simple a <font color=Blue><i>-- for the upper subtree, no difference</i></font>
<a name="line-127"></a>    
<a name="line-128"></a>    coord <font color=Red>::</font> Int <font color=Red>-&gt;</font> <font color=Cyan>(</font>Double<font color=Cyan>,</font> Double<font color=Cyan>)</font>
<a name="line-129"></a>    coord <font color=Red>=</font> <font color=Green><u>if</u></font> node_style <font color=Green><u>then</u></font> coord_orthodox <font color=Green><u>else</u></font> coord_simple
<a name="line-130"></a>    
<a name="line-131"></a>    color <font color=Red>::</font> Int <font color=Red>-&gt;</font> Color
<a name="line-132"></a>    color <font color=Magenta>0</font> <font color=Red>=</font> Color_RGB <font color=Magenta>1</font> <font color=Magenta>0</font> <font color=Magenta>0</font>
<a name="line-133"></a>    color <font color=Magenta>1</font> <font color=Red>=</font> Color_RGB <font color=Magenta>0</font> <font color=Magenta>1</font> <font color=Magenta>0</font>
<a name="line-134"></a>    color <font color=Magenta>2</font> <font color=Red>=</font> Color_RGB <font color=Magenta>0</font> <font color=Magenta>0</font> <font color=Magenta>1</font>
<a name="line-135"></a>    color <font color=Magenta>3</font> <font color=Red>=</font> Color_RGB <font color=Magenta>1</font> <font color=Magenta>1</font> <font color=Magenta>0</font>
<a name="line-136"></a>    color n <font color=Red>=</font> error <font color=Cyan>(</font><font color=Magenta>"render_oracle: unknown color: "</font> <font color=Cyan>++</font> show n<font color=Cyan>)</font>
<a name="line-137"></a>
<a name="line-138"></a>    output <font color=Red>::</font> Int <font color=Red>-&gt;</font> Int <font color=Red>-&gt;</font> Draw ()
<a name="line-139"></a>    output a c <font color=Red>=</font>
<a name="line-140"></a>      <font color=Green><u>case</u></font> simulate <font color=Cyan>(</font>c<font color=Cyan>,</font> a<font color=Cyan>)</font> <font color=Green><u>of</u></font>
<a name="line-141"></a>        <font color=Cyan>(</font>b<font color=Cyan>,</font> False<font color=Cyan>)</font> <font color=Red>-&gt;</font> <font color=Green><u>do</u></font>
<a name="line-142"></a>          comment <font color=Cyan>(</font>printf <font color=Magenta>"%d ---%d---&gt; %d"</font> a c b<font color=Cyan>)</font>
<a name="line-143"></a>          moveto x0 y0
<a name="line-144"></a>          lineto x2 y2
<a name="line-145"></a>          setcolor <font color=Cyan>(</font>color c<font color=Cyan>)</font>
<a name="line-146"></a>          stroke
<a name="line-147"></a>          <font color=Green><u>where</u></font>
<a name="line-148"></a>            <font color=Cyan>(</font>x0<font color=Cyan>,</font>y0<font color=Cyan>)</font> <font color=Red>=</font> coord a
<a name="line-149"></a>            <font color=Cyan>(</font>x1<font color=Cyan>,</font>y1<font color=Cyan>)</font> <font color=Red>=</font> coord b
<a name="line-150"></a>            <font color=Cyan>(</font>x2<font color=Cyan>,</font>y2<font color=Cyan>)</font> <font color=Red>=</font> <font color=Cyan>(</font><font color=Cyan>(</font>x0<font color=Cyan>+</font>x1<font color=Cyan>)</font><font color=Cyan>/</font><font color=Magenta>2</font><font color=Cyan>,</font> <font color=Cyan>(</font>y0<font color=Cyan>+</font>y1<font color=Cyan>)</font><font color=Cyan>/</font><font color=Magenta>2</font><font color=Cyan>)</font>
<a name="line-151"></a>        <font color=Cyan>(</font>b<font color=Cyan>,</font> True<font color=Cyan>)</font> <font color=Red>-&gt;</font> <font color=Green><u>do</u></font>
<a name="line-152"></a>          comment <font color=Cyan>(</font>printf <font color=Magenta>"%d ---%d---&gt; None (%d)"</font> a c b<font color=Cyan>)</font>
<a name="line-153"></a>
<a name="line-154"></a>    label <font color=Red>::</font> Int <font color=Red>-&gt;</font> Draw ()
<a name="line-155"></a>    label a <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-156"></a>      render_dot x y
<a name="line-157"></a>      textbox align_left labelfont black <font color=Cyan>(</font>x<font color=Cyan>+</font><font color=Magenta>0.1</font><font color=Cyan>)</font> y <font color=Cyan>(</font>x<font color=Cyan>+</font><font color=Magenta>1.9</font><font color=Cyan>)</font> y <font color=Magenta>0</font> <font color=Cyan>(</font>show a<font color=Cyan>)</font>
<a name="line-158"></a>      <font color=Green><u>where</u></font>
<a name="line-159"></a>        <font color=Cyan>(</font>x<font color=Cyan>,</font>y<font color=Cyan>)</font> <font color=Red>=</font> coord a
<a name="line-160"></a>        
<a name="line-161"></a>    render_dot <font color=Red>::</font> X <font color=Red>-&gt;</font> Y <font color=Red>-&gt;</font> Draw ()
<a name="line-162"></a>    render_dot x y <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-163"></a>      arc x y dotradius <font color=Magenta>0</font> <font color=Magenta>360</font>
<a name="line-164"></a>      fill black
<a name="line-165"></a>
<a name="line-166"></a><font color=Blue><i>-- ======================================================================</i></font>
<a name="line-167"></a><font color=Blue><i>-- * Testing of specific circuit fragments</i></font>
<a name="line-168"></a>
<a name="line-169"></a><a name="simulate_parseNodeRoot"></a><font color=Blue><i>-- | Simulate 'parseNodeRoot' on all possible inputs for tree height /n/. </i></font>
<a name="line-170"></a><font color=Blue>simulate_parseNodeRoot</font> <font color=Red>::</font> Int <font color=Red>-&gt;</font> IO()
<a name="line-171"></a><font color=Blue>simulate_parseNodeRoot</font> n <font color=Red>=</font> mapM_ output <font color=Cyan>(</font>sample_all0 <font color=Cyan>(</font><font color=Magenta>4</font><font color=Cyan>*</font>nn<font color=Blue><i>-</i></font><font color=Magenta>1</font><font color=Cyan>,</font> True<font color=Cyan>,</font> True<font color=Cyan>)</font><font color=Cyan>)</font>
<a name="line-172"></a>  <font color=Green><u>where</u></font>
<a name="line-173"></a>    nn <font color=Red>=</font> <font color=Magenta>2</font><font color=Cyan>^</font><font color=Cyan>(</font>toInteger n<font color=Cyan>)</font> <font color=Red>::</font> Integer <font color=Blue><i>-- can be quite large!</i></font>
<a name="line-174"></a>    output <font color=Red>::</font> <font color=Cyan>(</font>Integer<font color=Cyan>,</font>Bool<font color=Cyan>,</font>Bool<font color=Cyan>)</font> <font color=Red>-&gt;</font> IO()
<a name="line-175"></a>    output <font color=Cyan>(</font>a<font color=Cyan>,</font> root<font color=Cyan>,</font> even<font color=Cyan>)</font> <font color=Red>=</font>
<a name="line-176"></a>      <font color=Green><u>let</u></font>
<a name="line-177"></a>        <font color=Green><u>as</u></font> <font color=Red>=</font> boollist_of_int_bh <font color=Cyan>(</font>n<font color=Cyan>+</font><font color=Magenta>2</font><font color=Cyan>)</font> a
<a name="line-178"></a>        <font color=Cyan>(</font>as'<font color=Cyan>,</font>root'<font color=Cyan>,</font>even'<font color=Cyan>)</font> <font color=Red>=</font> run_classical_generic <font color=Cyan>(</font>runfun n<font color=Cyan>)</font> <font color=Cyan>(</font><font color=Green><u>as</u></font><font color=Cyan>,</font> root<font color=Cyan>,</font> even<font color=Cyan>)</font>
<a name="line-179"></a>
<a name="line-180"></a>        runfun <font color=Red>::</font> Int <font color=Red>-&gt;</font> <font color=Cyan>(</font>Qulist<font color=Cyan>,</font>Qubit<font color=Cyan>,</font>Qubit<font color=Cyan>)</font> <font color=Red>-&gt;</font> Circ <font color=Cyan>(</font>Qulist<font color=Cyan>,</font>Qubit<font color=Cyan>,</font>Qubit<font color=Cyan>)</font>
<a name="line-181"></a>        runfun n <font color=Cyan>(</font><font color=Green><u>as</u></font><font color=Cyan>,</font> root<font color=Cyan>,</font> even<font color=Cyan>)</font> <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-182"></a>          parseNodeRoot <font color=Cyan>(</font>qureg_of_qulist_te <font color=Green><u>as</u></font><font color=Cyan>,</font> root<font color=Cyan>,</font> even<font color=Cyan>,</font> n<font color=Cyan>)</font>
<a name="line-183"></a>          return <font color=Cyan>(</font><font color=Green><u>as</u></font><font color=Cyan>,</font> root<font color=Cyan>,</font> even<font color=Cyan>)</font>
<a name="line-184"></a>        a' <font color=Red>=</font> int_of_boollist_unsigned_bh as' <font color=Red>::</font> Integer
<a name="line-185"></a>        d_root <font color=Red>=</font> root <font color=Cyan>`bool_xor`</font> root'
<a name="line-186"></a>        d_even <font color=Red>=</font> even <font color=Cyan>`bool_xor`</font> even'
<a name="line-187"></a>      <font color=Green><u>in</u></font> <font color=Green><u>do</u></font>
<a name="line-188"></a>        printf <font color=Magenta>"(a=%d, root=%s, even=%s) -&gt; (a=%d, root=%s, even=%s)\n"</font> a <font color=Cyan>(</font>show root<font color=Cyan>)</font> <font color=Cyan>(</font>show even<font color=Cyan>)</font> a' <font color=Cyan>(</font>show root'<font color=Cyan>)</font> <font color=Cyan>(</font>show even'<font color=Cyan>)</font>
<a name="line-189"></a>        <font color=Green><u>if</u></font> <font color=Cyan>(</font>a <font color=Cyan>/=</font> a' <font color=Cyan>||</font> d_root <font color=Cyan>/=</font> d_even<font color=Cyan>)</font> <font color=Green><u>then</u></font>
<a name="line-190"></a>          error <font color=Magenta>"Test failed (1)"</font>
<a name="line-191"></a>        <font color=Green><u>else</u></font> <font color=Green><u>if</u></font> <font color=Cyan>(</font>d_root <font color=Cyan>/=</font> <font color=Cyan>(</font><font color=Cyan>(</font>a <font color=Cyan>.&amp;.</font> <font color=Cyan>(</font><font color=Magenta>2</font><font color=Cyan>*</font>nn<font color=Blue><i>-</i></font><font color=Magenta>1</font><font color=Cyan>)</font><font color=Cyan>)</font> <font color=Cyan>&lt;=</font> <font color=Magenta>1</font><font color=Cyan>)</font><font color=Cyan>)</font> <font color=Green><u>then</u></font>
<a name="line-192"></a>          error <font color=Magenta>"Test failed (2)"</font>
<a name="line-193"></a>        <font color=Green><u>else</u></font>
<a name="line-194"></a>          return ()
<a name="line-195"></a>
<a name="line-196"></a><a name="simulate_parseNodeEven"></a><font color=Blue><i>-- | Simulate 'parseNodeEven' on all possible inputs for tree height /n/. </i></font>
<a name="line-197"></a><font color=Blue>simulate_parseNodeEven</font> <font color=Red>::</font> Int <font color=Red>-&gt;</font> IO()
<a name="line-198"></a><font color=Blue>simulate_parseNodeEven</font> n <font color=Red>=</font> mapM_ output <font color=Cyan>(</font>sample_all0 <font color=Cyan>(</font><font color=Magenta>4</font><font color=Cyan>*</font>nn<font color=Blue><i>-</i></font><font color=Magenta>1</font><font color=Cyan>,</font> True<font color=Cyan>)</font><font color=Cyan>)</font>
<a name="line-199"></a>  <font color=Green><u>where</u></font>
<a name="line-200"></a>    nn <font color=Red>=</font> <font color=Magenta>2</font><font color=Cyan>^</font><font color=Cyan>(</font>toInteger n<font color=Cyan>)</font> <font color=Red>::</font> Integer <font color=Blue><i>-- can be quite large!</i></font>
<a name="line-201"></a>    output <font color=Red>::</font> <font color=Cyan>(</font>Integer<font color=Cyan>,</font>Bool<font color=Cyan>)</font> <font color=Red>-&gt;</font> IO()
<a name="line-202"></a>    output <font color=Cyan>(</font>a<font color=Cyan>,</font> even<font color=Cyan>)</font> <font color=Red>=</font>
<a name="line-203"></a>      <font color=Green><u>let</u></font>
<a name="line-204"></a>        <font color=Green><u>as</u></font> <font color=Red>=</font> boollist_of_int_bh <font color=Cyan>(</font>n<font color=Cyan>+</font><font color=Magenta>2</font><font color=Cyan>)</font> a
<a name="line-205"></a>        <font color=Cyan>(</font>as'<font color=Cyan>,</font>even'<font color=Cyan>)</font> <font color=Red>=</font> run_classical_generic <font color=Cyan>(</font>runfun n<font color=Cyan>)</font> <font color=Cyan>(</font><font color=Green><u>as</u></font><font color=Cyan>,</font> even<font color=Cyan>)</font>
<a name="line-206"></a>
<a name="line-207"></a>        runfun <font color=Red>::</font> Int <font color=Red>-&gt;</font> <font color=Cyan>(</font>Qulist<font color=Cyan>,</font>Qubit<font color=Cyan>)</font> <font color=Red>-&gt;</font> Circ <font color=Cyan>(</font>Qulist<font color=Cyan>,</font>Qubit<font color=Cyan>)</font>
<a name="line-208"></a>        runfun n <font color=Cyan>(</font><font color=Green><u>as</u></font><font color=Cyan>,</font> even<font color=Cyan>)</font> <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-209"></a>          parseNodeEven <font color=Cyan>(</font>qureg_of_qulist_te <font color=Green><u>as</u></font><font color=Cyan>,</font> even<font color=Cyan>,</font> n<font color=Cyan>)</font>
<a name="line-210"></a>          return <font color=Cyan>(</font><font color=Green><u>as</u></font><font color=Cyan>,</font> even<font color=Cyan>)</font>
<a name="line-211"></a>        a' <font color=Red>=</font> int_of_boollist_unsigned_bh as' <font color=Red>::</font> Integer
<a name="line-212"></a>        d_even <font color=Red>=</font> even <font color=Cyan>`bool_xor`</font> even'
<a name="line-213"></a>      <font color=Green><u>in</u></font> <font color=Green><u>do</u></font>
<a name="line-214"></a>        printf <font color=Magenta>"(a=%d, even=%s) -&gt; (a=%d, even=%s)\n"</font> a <font color=Cyan>(</font>show even<font color=Cyan>)</font> a' <font color=Cyan>(</font>show even'<font color=Cyan>)</font>
<a name="line-215"></a>        <font color=Green><u>if</u></font> <font color=Cyan>(</font>a <font color=Cyan>/=</font> a'<font color=Cyan>)</font> <font color=Green><u>then</u></font>
<a name="line-216"></a>          error <font color=Magenta>"Test failed (3)"</font>
<a name="line-217"></a>        <font color=Green><u>else</u></font> <font color=Green><u>if</u></font> <font color=Cyan>(</font><font color=Cyan>(</font>a <font color=Cyan>.&amp;.</font> <font color=Cyan>(</font><font color=Magenta>2</font><font color=Cyan>*</font>nn<font color=Blue><i>-</i></font><font color=Magenta>1</font><font color=Cyan>)</font><font color=Cyan>)</font> <font color=Cyan>&lt;=</font> <font color=Magenta>1</font><font color=Cyan>)</font> <font color=Green><u>then</u></font>
<a name="line-218"></a>          <font color=Green><u>if</u></font> <font color=Cyan>(</font>d_even<font color=Cyan>)</font> <font color=Green><u>then</u></font>
<a name="line-219"></a>            error <font color=Magenta>"Test failed (4)"</font>
<a name="line-220"></a>          <font color=Green><u>else</u></font>
<a name="line-221"></a>            return ()
<a name="line-222"></a>        <font color=Green><u>else</u></font> <font color=Green><u>if</u></font> <font color=Cyan>(</font>d_even <font color=Cyan>/=</font> not <font color=Cyan>(</font>Prelude<font color=Cyan>.</font>even <font color=Cyan>(</font>hibit <font color=Cyan>(</font>a <font color=Cyan>.&amp;.</font> <font color=Cyan>(</font><font color=Magenta>2</font><font color=Cyan>*</font>nn<font color=Blue><i>-</i></font><font color=Magenta>1</font><font color=Cyan>)</font><font color=Cyan>)</font><font color=Cyan>)</font><font color=Cyan>)</font><font color=Cyan>)</font> <font color=Green><u>then</u></font>
<a name="line-223"></a>          error <font color=Magenta>"Test failed (5)"</font>
<a name="line-224"></a>        <font color=Green><u>else</u></font>
<a name="line-225"></a>          return ()
<a name="line-226"></a>
<a name="line-227"></a><a name="simulate_testIsParent"></a><font color=Blue><i>-- | Simulate 'testIsParent' on all possible inputs for tree height /n/. </i></font>
<a name="line-228"></a><font color=Blue>simulate_testIsParent</font> <font color=Red>::</font> Int <font color=Red>-&gt;</font> IO()
<a name="line-229"></a><font color=Blue>simulate_testIsParent</font> n <font color=Red>=</font> mapM_ output <font color=Cyan>(</font>sample_all0 <font color=Cyan>(</font><font color=Magenta>1</font><font color=Cyan>,</font> True<font color=Cyan>,</font> True<font color=Cyan>,</font> True<font color=Cyan>,</font> <font color=Magenta>3</font><font color=Cyan>,</font> <font color=Magenta>1</font><font color=Cyan>,</font> True<font color=Cyan>)</font><font color=Cyan>)</font>
<a name="line-230"></a>  <font color=Green><u>where</u></font>
<a name="line-231"></a>    nn <font color=Red>=</font> <font color=Magenta>2</font><font color=Cyan>^</font><font color=Cyan>(</font>toInteger n<font color=Cyan>)</font> <font color=Red>::</font> Integer <font color=Blue><i>-- can be quite large!</i></font>
<a name="line-232"></a>    output <font color=Red>::</font> <font color=Cyan>(</font>Integer<font color=Cyan>,</font> Bool<font color=Cyan>,</font> Bool<font color=Cyan>,</font> Bool<font color=Cyan>,</font> Integer<font color=Cyan>,</font> Int<font color=Cyan>,</font> Bool<font color=Cyan>)</font> <font color=Red>-&gt;</font> IO()
<a name="line-233"></a>    output <font color=Cyan>(</font>a<font color=Cyan>,</font> root<font color=Cyan>,</font> even<font color=Cyan>,</font> isparent<font color=Cyan>,</font> color<font color=Cyan>,</font> really<font color=Cyan>,</font> ismatch<font color=Cyan>)</font> <font color=Red>=</font>
<a name="line-234"></a>      <font color=Green><u>let</u></font>
<a name="line-235"></a>        <font color=Green><u>as</u></font> <font color=Red>=</font> boollist_of_int_bh <font color=Magenta>1</font> a
<a name="line-236"></a>        cs <font color=Red>=</font> boollist_of_int_bh <font color=Magenta>2</font> color
<a name="line-237"></a>        <font color=Cyan>(</font>as'<font color=Cyan>,</font> root'<font color=Cyan>,</font> even'<font color=Cyan>,</font> isparent'<font color=Cyan>,</font> ismatch'<font color=Cyan>)</font> <font color=Red>=</font> run_classical_generic <font color=Cyan>(</font>runfun n cs really<font color=Cyan>)</font> <font color=Cyan>(</font><font color=Green><u>as</u></font><font color=Cyan>,</font> root<font color=Cyan>,</font> even<font color=Cyan>,</font> isparent<font color=Cyan>,</font> ismatch<font color=Cyan>)</font>
<a name="line-238"></a>
<a name="line-239"></a>        runfun <font color=Red>::</font> Int <font color=Red>-&gt;</font> Boollist <font color=Red>-&gt;</font> Int <font color=Red>-&gt;</font> <font color=Cyan>(</font>Qulist<font color=Cyan>,</font>Qubit<font color=Cyan>,</font>Qubit<font color=Cyan>,</font>Qubit<font color=Cyan>,</font>Qubit<font color=Cyan>)</font> <font color=Red>-&gt;</font> Circ <font color=Cyan>(</font>Qulist<font color=Cyan>,</font>Qubit<font color=Cyan>,</font>Qubit<font color=Cyan>,</font>Qubit<font color=Cyan>,</font>Qubit<font color=Cyan>)</font>
<a name="line-240"></a>        runfun n cs rs <font color=Cyan>(</font><font color=Green><u>as</u></font><font color=Cyan>,</font> root<font color=Cyan>,</font> even<font color=Cyan>,</font> isparent<font color=Cyan>,</font> ismatch<font color=Cyan>)</font> <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-241"></a>          testIsParent <font color=Cyan>(</font>qureg_of_qulist_te <font color=Green><u>as</u></font><font color=Cyan>,</font> root<font color=Cyan>,</font> even<font color=Cyan>,</font> isparent<font color=Cyan>,</font> boolreg_of_boollist_te cs<font color=Cyan>,</font> n<font color=Cyan>,</font> really<font color=Cyan>,</font> ismatch<font color=Cyan>)</font>
<a name="line-242"></a>          return <font color=Cyan>(</font><font color=Green><u>as</u></font><font color=Cyan>,</font> root<font color=Cyan>,</font> even<font color=Cyan>,</font> isparent<font color=Cyan>,</font> ismatch<font color=Cyan>)</font>
<a name="line-243"></a>        
<a name="line-244"></a>        a' <font color=Red>=</font> int_of_boollist_unsigned_bh as' <font color=Red>::</font> Integer
<a name="line-245"></a>        d_root <font color=Red>=</font> root <font color=Cyan>`bool_xor`</font> root'
<a name="line-246"></a>        d_even <font color=Red>=</font> even <font color=Cyan>`bool_xor`</font> even'
<a name="line-247"></a>        d_isparent <font color=Red>=</font> isparent <font color=Cyan>`bool_xor`</font> isparent'
<a name="line-248"></a>        d_ismatch <font color=Red>=</font> ismatch <font color=Cyan>`bool_xor`</font> ismatch'
<a name="line-249"></a>      <font color=Green><u>in</u></font> <font color=Green><u>do</u></font>
<a name="line-250"></a>        printf <font color=Magenta>"(a=%d, root=%s, even=%s, isparent=%s, color=%d, really=%d, ismatch=%s) -&gt; (a=%d, root=%s, even=%s, isparent=%s, ismatch=%s)\n"</font> a <font color=Cyan>(</font>show root<font color=Cyan>)</font> <font color=Cyan>(</font>show even<font color=Cyan>)</font> <font color=Cyan>(</font>show isparent<font color=Cyan>)</font> color really <font color=Cyan>(</font>show ismatch<font color=Cyan>)</font> a' <font color=Cyan>(</font>show root'<font color=Cyan>)</font> <font color=Cyan>(</font>show even'<font color=Cyan>)</font> <font color=Cyan>(</font>show isparent'<font color=Cyan>)</font> <font color=Cyan>(</font>show ismatch'<font color=Cyan>)</font>
<a name="line-251"></a>        <font color=Green><u>if</u></font> <font color=Cyan>(</font>a <font color=Cyan>/=</font> a' <font color=Cyan>||</font> root <font color=Cyan>/=</font> root' <font color=Cyan>||</font> even <font color=Cyan>/=</font> even'<font color=Cyan>)</font> <font color=Green><u>then</u></font>
<a name="line-252"></a>          error <font color=Magenta>"Test failed (6)"</font>
<a name="line-253"></a>        <font color=Green><u>else</u></font> <font color=Green><u>if</u></font> <font color=Cyan>(</font>root <font color=Cyan>==</font> True <font color=Cyan>&amp;&amp;</font> even <font color=Cyan>==</font> True<font color=Cyan>)</font> <font color=Green><u>then</u></font>
<a name="line-254"></a>          <font color=Green><u>if</u></font> d_isparent <font color=Cyan>==</font> False <font color=Green><u>then</u></font>
<a name="line-255"></a>            return ()
<a name="line-256"></a>          <font color=Green><u>else</u></font>
<a name="line-257"></a>            error <font color=Magenta>"Test failed (7)"</font>
<a name="line-258"></a>        <font color=Green><u>else</u></font> <font color=Green><u>if</u></font> really <font color=Cyan>==</font> <font color=Magenta>1</font> <font color=Cyan>&amp;&amp;</font> ismatch <font color=Cyan>==</font> False <font color=Green><u>then</u></font>
<a name="line-259"></a>          <font color=Green><u>if</u></font> d_isparent <font color=Cyan>/=</font> <font color=Cyan>(</font>color <font color=Cyan>==</font> <font color=Cyan>(</font>a <font color=Cyan>.&amp;.</font> <font color=Magenta>1</font><font color=Cyan>)</font> <font color=Cyan>.|.</font> <font color=Cyan>(</font><font color=Green><u>if</u></font> even <font color=Green><u>then</u></font> <font color=Magenta>2</font> <font color=Green><u>else</u></font> <font color=Magenta>0</font><font color=Cyan>)</font><font color=Cyan>)</font> <font color=Green><u>then</u></font>
<a name="line-260"></a>            error <font color=Magenta>"Test failed (8)"</font>
<a name="line-261"></a>          <font color=Green><u>else</u></font> <font color=Green><u>if</u></font> d_ismatch <font color=Cyan>/=</font> <font color=Cyan>(</font>d_isparent <font color=Cyan>&amp;&amp;</font> even<font color=Cyan>)</font> <font color=Green><u>then</u></font>
<a name="line-262"></a>            error <font color=Magenta>"Test failed (9)"</font>
<a name="line-263"></a>          <font color=Green><u>else</u></font>
<a name="line-264"></a>            return ()
<a name="line-265"></a>        <font color=Green><u>else</u></font> <font color=Blue><i>-- really == 0 -- we don't write more test cases because the algorithm is so convoluted.</i></font>
<a name="line-266"></a>          return ()
<a name="line-267"></a>
<a name="line-268"></a><a name="simulate_testIsChild"></a><font color=Blue><i>-- | Simulate 'testIsChild' on all possible inputs for tree height /n/. </i></font>
<a name="line-269"></a><font color=Blue>simulate_testIsChild</font> <font color=Red>::</font> Int <font color=Red>-&gt;</font> IO()
<a name="line-270"></a><font color=Blue>simulate_testIsChild</font> n <font color=Red>=</font> mapM_ output <font color=Cyan>(</font>sample_all0 <font color=Cyan>(</font>True<font color=Cyan>,</font> True<font color=Cyan>,</font> True<font color=Cyan>,</font> <font color=Magenta>3</font><font color=Cyan>)</font><font color=Cyan>)</font>
<a name="line-271"></a>  <font color=Green><u>where</u></font>
<a name="line-272"></a>    nn <font color=Red>=</font> <font color=Magenta>2</font><font color=Cyan>^</font><font color=Cyan>(</font>toInteger n<font color=Cyan>)</font> <font color=Red>::</font> Integer <font color=Blue><i>-- can be quite large!</i></font>
<a name="line-273"></a>    output <font color=Red>::</font> <font color=Cyan>(</font>Bool<font color=Cyan>,</font> Bool<font color=Cyan>,</font> Bool<font color=Cyan>,</font> Integer<font color=Cyan>)</font> <font color=Red>-&gt;</font> IO()
<a name="line-274"></a>    output <font color=Cyan>(</font>even<font color=Cyan>,</font> ischild<font color=Cyan>,</font> direction<font color=Cyan>,</font> color<font color=Cyan>)</font> <font color=Red>=</font>
<a name="line-275"></a>      <font color=Green><u>let</u></font>
<a name="line-276"></a>        cs <font color=Red>=</font> boollist_of_int_bh <font color=Magenta>2</font> color
<a name="line-277"></a>        <font color=Cyan>(</font>even'<font color=Cyan>,</font> ischild'<font color=Cyan>,</font> direction'<font color=Cyan>)</font> <font color=Red>=</font> run_classical_generic <font color=Cyan>(</font>runfun cs n<font color=Cyan>)</font> <font color=Cyan>(</font>even<font color=Cyan>,</font> ischild<font color=Cyan>,</font> direction<font color=Cyan>)</font>
<a name="line-278"></a>
<a name="line-279"></a>        runfun <font color=Red>::</font> Boollist <font color=Red>-&gt;</font> Int <font color=Red>-&gt;</font> <font color=Cyan>(</font>Qubit<font color=Cyan>,</font>Qubit<font color=Cyan>,</font>Qubit<font color=Cyan>)</font> <font color=Red>-&gt;</font> Circ <font color=Cyan>(</font>Qubit<font color=Cyan>,</font>Qubit<font color=Cyan>,</font>Qubit<font color=Cyan>)</font>
<a name="line-280"></a>        runfun cs n <font color=Cyan>(</font>even<font color=Cyan>,</font> ischild<font color=Cyan>,</font> direction<font color=Cyan>)</font> <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-281"></a>          testIsChild <font color=Cyan>(</font>even<font color=Cyan>,</font> ischild<font color=Cyan>,</font> direction<font color=Cyan>,</font> boolreg_of_boollist_te cs<font color=Cyan>,</font> n<font color=Cyan>)</font>
<a name="line-282"></a>          return <font color=Cyan>(</font>even<font color=Cyan>,</font> ischild<font color=Cyan>,</font> direction<font color=Cyan>)</font>
<a name="line-283"></a>        d_ischild <font color=Red>=</font> ischild <font color=Cyan>`bool_xor`</font> ischild'
<a name="line-284"></a>        d_direction <font color=Red>=</font> direction <font color=Cyan>`bool_xor`</font> direction'
<a name="line-285"></a>      <font color=Green><u>in</u></font> <font color=Green><u>do</u></font>
<a name="line-286"></a>        printf <font color=Magenta>"(even=%s, ischild=%s, direction=%s, color=%d) -&gt; (even=%s, ischild=%s, direction=%s)\n"</font> <font color=Cyan>(</font>show even<font color=Cyan>)</font> <font color=Cyan>(</font>show ischild<font color=Cyan>)</font> <font color=Cyan>(</font>show direction<font color=Cyan>)</font> color <font color=Cyan>(</font>show even'<font color=Cyan>)</font> <font color=Cyan>(</font>show ischild'<font color=Cyan>)</font> <font color=Cyan>(</font>show direction'<font color=Cyan>)</font>
<a name="line-287"></a>        <font color=Green><u>if</u></font> <font color=Cyan>(</font>even <font color=Cyan>/=</font> even' <font color=Cyan>||</font> d_direction <font color=Cyan>==</font> <font color=Cyan>(</font>Prelude<font color=Cyan>.</font>even color<font color=Cyan>)</font><font color=Cyan>)</font> <font color=Green><u>then</u></font>
<a name="line-288"></a>          error <font color=Magenta>"Test failed (10)"</font>
<a name="line-289"></a>        <font color=Green><u>else</u></font> <font color=Green><u>if</u></font> even <font color=Cyan>&amp;&amp;</font> <font color=Cyan>(</font>d_ischild <font color=Cyan>/=</font> <font color=Cyan>(</font>color <font color=Cyan>&lt;=</font> <font color=Magenta>1</font><font color=Cyan>)</font><font color=Cyan>)</font> <font color=Green><u>then</u></font>
<a name="line-290"></a>          error <font color=Magenta>"Test failed (11)"</font>
<a name="line-291"></a>        <font color=Green><u>else</u></font> <font color=Green><u>if</u></font> not even <font color=Cyan>&amp;&amp;</font> <font color=Cyan>(</font>d_ischild <font color=Cyan>/=</font> <font color=Cyan>(</font>color <font color=Cyan>&gt;=</font> <font color=Magenta>2</font><font color=Cyan>)</font><font color=Cyan>)</font> <font color=Green><u>then</u></font>
<a name="line-292"></a>          error <font color=Magenta>"Test failed (12)"</font>
<a name="line-293"></a>        <font color=Green><u>else</u></font>
<a name="line-294"></a>          return ()
<a name="line-295"></a>
<a name="line-296"></a><a name="simulate_setParent"></a><font color=Blue><i>-- | Simulate 'setParent' on all possible inputs for tree height /n/. </i></font>
<a name="line-297"></a><font color=Blue>simulate_setParent</font> <font color=Red>::</font> Int <font color=Red>-&gt;</font> IO()
<a name="line-298"></a><font color=Blue>simulate_setParent</font> n <font color=Red>=</font> mapM_ output <font color=Cyan>(</font>sample_all0 <font color=Cyan>(</font><font color=Magenta>4</font><font color=Cyan>*</font>nn<font color=Blue><i>-</i></font><font color=Magenta>1</font><font color=Cyan>,</font> <font color=Magenta>4</font><font color=Cyan>*</font>nn<font color=Blue><i>-</i></font><font color=Magenta>1</font><font color=Cyan>,</font> True<font color=Cyan>)</font><font color=Cyan>)</font>
<a name="line-299"></a>  <font color=Green><u>where</u></font>
<a name="line-300"></a>    nn <font color=Red>=</font> <font color=Magenta>2</font><font color=Cyan>^</font><font color=Cyan>(</font>toInteger n<font color=Cyan>)</font> <font color=Red>::</font> Integer <font color=Blue><i>-- can be quite large!</i></font>
<a name="line-301"></a>    output <font color=Red>::</font> <font color=Cyan>(</font>Integer<font color=Cyan>,</font>Integer<font color=Cyan>,</font>Bool<font color=Cyan>)</font> <font color=Red>-&gt;</font> IO()
<a name="line-302"></a>    output <font color=Cyan>(</font>a<font color=Cyan>,</font>b<font color=Cyan>,</font>isparent<font color=Cyan>)</font> <font color=Red>=</font>
<a name="line-303"></a>      <font color=Green><u>let</u></font>
<a name="line-304"></a>        <font color=Green><u>as</u></font> <font color=Red>=</font> boollist_of_int_bh <font color=Cyan>(</font>n<font color=Cyan>+</font><font color=Magenta>2</font><font color=Cyan>)</font> a
<a name="line-305"></a>        bs <font color=Red>=</font> boollist_of_int_bh <font color=Cyan>(</font>n<font color=Cyan>+</font><font color=Magenta>2</font><font color=Cyan>)</font> b
<a name="line-306"></a>        <font color=Cyan>(</font>as'<font color=Cyan>,</font>bs'<font color=Cyan>,</font>isparent'<font color=Cyan>)</font> <font color=Red>=</font> run_classical_generic <font color=Cyan>(</font>runfun n<font color=Cyan>)</font> <font color=Cyan>(</font><font color=Green><u>as</u></font><font color=Cyan>,</font> bs<font color=Cyan>,</font> isparent<font color=Cyan>)</font>
<a name="line-307"></a>
<a name="line-308"></a>        runfun <font color=Red>::</font> Int <font color=Red>-&gt;</font> <font color=Cyan>(</font>Qulist<font color=Cyan>,</font>Qulist<font color=Cyan>,</font>Qubit<font color=Cyan>)</font> <font color=Red>-&gt;</font> Circ <font color=Cyan>(</font>Qulist<font color=Cyan>,</font>Qulist<font color=Cyan>,</font>Qubit<font color=Cyan>)</font>
<a name="line-309"></a>        runfun n <font color=Cyan>(</font><font color=Green><u>as</u></font><font color=Cyan>,</font> bs<font color=Cyan>,</font> isparent<font color=Cyan>)</font> <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-310"></a>          setParent <font color=Cyan>(</font>qureg_of_qulist_te <font color=Green><u>as</u></font><font color=Cyan>,</font> qureg_of_qulist_te bs<font color=Cyan>,</font> isparent<font color=Cyan>,</font> n<font color=Cyan>)</font>
<a name="line-311"></a>          return <font color=Cyan>(</font><font color=Green><u>as</u></font><font color=Cyan>,</font> bs<font color=Cyan>,</font> isparent<font color=Cyan>)</font>
<a name="line-312"></a>        a' <font color=Red>=</font> int_of_boollist_unsigned_bh as' <font color=Red>::</font> Integer
<a name="line-313"></a>        b' <font color=Red>=</font> int_of_boollist_unsigned_bh bs' <font color=Red>::</font> Integer
<a name="line-314"></a>        db <font color=Red>=</font> b <font color=Cyan>`xor`</font> b'
<a name="line-315"></a>      <font color=Green><u>in</u></font> <font color=Green><u>do</u></font>
<a name="line-316"></a>        printf <font color=Magenta>"(a=%d, b=%d) -&gt; (a=%d, b=%d) (db=%d) isparent=%s\n"</font> a b a' b' db <font color=Cyan>(</font>show isparent<font color=Cyan>)</font>
<a name="line-317"></a>        <font color=Green><u>if</u></font> <font color=Cyan>(</font>a <font color=Cyan>/=</font> a' <font color=Cyan>||</font> isparent <font color=Cyan>/=</font> isparent'<font color=Cyan>)</font> <font color=Green><u>then</u></font>
<a name="line-318"></a>          error <font color=Magenta>"Test failed (13)"</font>
<a name="line-319"></a>        <font color=Green><u>else</u></font> <font color=Green><u>if</u></font> <font color=Cyan>(</font>isparent <font color=Cyan>==</font> False<font color=Cyan>)</font> <font color=Green><u>then</u></font>
<a name="line-320"></a>           <font color=Green><u>if</u></font> <font color=Cyan>(</font>b <font color=Cyan>/=</font> b'<font color=Cyan>)</font> <font color=Green><u>then</u></font>
<a name="line-321"></a>             error <font color=Magenta>"Test failed (14)"</font>
<a name="line-322"></a>           <font color=Green><u>else</u></font>
<a name="line-323"></a>             return ()
<a name="line-324"></a>        <font color=Green><u>else</u></font> <font color=Green><u>if</u></font> db <font color=Cyan>/=</font> <font color=Cyan>(</font><font color=Cyan>(</font>a <font color=Cyan>`div`</font> <font color=Magenta>2</font><font color=Cyan>)</font> <font color=Cyan>.&amp;.</font> <font color=Cyan>(</font>nn<font color=Blue><i>-</i></font><font color=Magenta>1</font><font color=Cyan>)</font><font color=Cyan>)</font> <font color=Cyan>.|.</font> <font color=Cyan>(</font>a <font color=Cyan>.&amp;.</font> <font color=Cyan>(</font><font color=Magenta>2</font><font color=Cyan>*</font>nn<font color=Cyan>)</font><font color=Cyan>)</font> <font color=Green><u>then</u></font>
<a name="line-325"></a>          error <font color=Magenta>"Test failed (15)"</font>
<a name="line-326"></a>        <font color=Green><u>else</u></font>
<a name="line-327"></a>          return ()
<a name="line-328"></a>
<a name="line-329"></a><a name="simulate_setChild"></a><font color=Blue><i>-- | Simulate 'setChild' on all possible inputs for tree height /n/. </i></font>
<a name="line-330"></a><font color=Blue>simulate_setChild</font> <font color=Red>::</font> Int <font color=Red>-&gt;</font> IO()
<a name="line-331"></a><font color=Blue>simulate_setChild</font> n <font color=Red>=</font> mapM_ output <font color=Cyan>(</font>sample_all0 <font color=Cyan>(</font><font color=Magenta>4</font><font color=Cyan>*</font>nn<font color=Blue><i>-</i></font><font color=Magenta>1</font><font color=Cyan>,</font> <font color=Magenta>4</font><font color=Cyan>*</font>nn<font color=Blue><i>-</i></font><font color=Magenta>1</font><font color=Cyan>,</font> nn<font color=Blue><i>-</i></font><font color=Magenta>1</font><font color=Cyan>,</font> nn<font color=Blue><i>-</i></font><font color=Magenta>1</font><font color=Cyan>,</font> True<font color=Cyan>,</font> True<font color=Cyan>)</font><font color=Cyan>)</font>
<a name="line-332"></a>  <font color=Green><u>where</u></font>
<a name="line-333"></a>    nn <font color=Red>=</font> <font color=Magenta>2</font><font color=Cyan>^</font><font color=Cyan>(</font>toInteger n<font color=Cyan>)</font> <font color=Red>::</font> Integer <font color=Blue><i>-- can be quite large!</i></font>
<a name="line-334"></a>    output <font color=Red>::</font> <font color=Cyan>(</font>Integer<font color=Cyan>,</font>Integer<font color=Cyan>,</font>Integer<font color=Cyan>,</font>Integer<font color=Cyan>,</font>Bool<font color=Cyan>,</font>Bool<font color=Cyan>)</font> <font color=Red>-&gt;</font> IO()
<a name="line-335"></a>    output <font color=Cyan>(</font>a<font color=Cyan>,</font>b<font color=Cyan>,</font>f<font color=Cyan>,</font>g<font color=Cyan>,</font>ischild<font color=Cyan>,</font>direction<font color=Cyan>)</font> <font color=Red>=</font>
<a name="line-336"></a>      <font color=Green><u>let</u></font>
<a name="line-337"></a>        <font color=Green><u>as</u></font> <font color=Red>=</font> boollist_of_int_bh <font color=Cyan>(</font>n<font color=Cyan>+</font><font color=Magenta>2</font><font color=Cyan>)</font> a
<a name="line-338"></a>        bs <font color=Red>=</font> boollist_of_int_bh <font color=Cyan>(</font>n<font color=Cyan>+</font><font color=Magenta>2</font><font color=Cyan>)</font> b
<a name="line-339"></a>        fs <font color=Red>=</font> boollist_of_int_bh n f
<a name="line-340"></a>        gs <font color=Red>=</font> boollist_of_int_bh n g
<a name="line-341"></a>        <font color=Cyan>(</font>as'<font color=Cyan>,</font>bs'<font color=Cyan>,</font>ischild'<font color=Cyan>,</font>direction'<font color=Cyan>)</font> <font color=Red>=</font> run_classical_generic <font color=Cyan>(</font>runfun n fs gs<font color=Cyan>)</font> <font color=Cyan>(</font><font color=Green><u>as</u></font><font color=Cyan>,</font> bs<font color=Cyan>,</font> ischild<font color=Cyan>,</font> direction<font color=Cyan>)</font>
<a name="line-342"></a>
<a name="line-343"></a>        runfun <font color=Red>::</font> Int <font color=Red>-&gt;</font> Boollist <font color=Red>-&gt;</font> Boollist <font color=Red>-&gt;</font> <font color=Cyan>(</font>Qulist<font color=Cyan>,</font>Qulist<font color=Cyan>,</font>Qubit<font color=Cyan>,</font>Qubit<font color=Cyan>)</font> <font color=Red>-&gt;</font> Circ <font color=Cyan>(</font>Qulist<font color=Cyan>,</font>Qulist<font color=Cyan>,</font>Qubit<font color=Cyan>,</font>Qubit<font color=Cyan>)</font>
<a name="line-344"></a>        runfun n f g <font color=Cyan>(</font><font color=Green><u>as</u></font><font color=Cyan>,</font> bs<font color=Cyan>,</font> ischild<font color=Cyan>,</font> direction<font color=Cyan>)</font> <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-345"></a>          setChild <font color=Cyan>(</font>qureg_of_qulist_te <font color=Green><u>as</u></font><font color=Cyan>,</font> qureg_of_qulist_te bs<font color=Cyan>,</font> ischild<font color=Cyan>,</font> direction<font color=Cyan>,</font> boolreg_of_boollist_te f<font color=Cyan>,</font> boolreg_of_boollist_te g<font color=Cyan>,</font> n<font color=Cyan>)</font>
<a name="line-346"></a>          return <font color=Cyan>(</font><font color=Green><u>as</u></font><font color=Cyan>,</font> bs<font color=Cyan>,</font> ischild<font color=Cyan>,</font> direction<font color=Cyan>)</font>
<a name="line-347"></a>        a' <font color=Red>=</font> int_of_boollist_unsigned_bh as' <font color=Red>::</font> Integer
<a name="line-348"></a>        b' <font color=Red>=</font> int_of_boollist_unsigned_bh bs' <font color=Red>::</font> Integer
<a name="line-349"></a>        db <font color=Red>=</font> b <font color=Cyan>`xor`</font> b'
<a name="line-350"></a>      <font color=Green><u>in</u></font> <font color=Green><u>do</u></font>
<a name="line-351"></a>        printf <font color=Magenta>"(a=%d, b=%d, f=%d, g=%d) -&gt; (a=%d, b=%d) (db=%d) ischild=%s direction=%s\n"</font> a b f g a' b' db <font color=Cyan>(</font>show ischild<font color=Cyan>)</font> <font color=Cyan>(</font>show direction<font color=Cyan>)</font>
<a name="line-352"></a>        <font color=Green><u>if</u></font> <font color=Cyan>(</font>a <font color=Cyan>/=</font> a' <font color=Cyan>||</font> ischild <font color=Cyan>/=</font> ischild' <font color=Cyan>||</font> direction <font color=Cyan>/=</font> direction'<font color=Cyan>)</font> <font color=Green><u>then</u></font>
<a name="line-353"></a>          error <font color=Magenta>"Test failed (16)"</font>
<a name="line-354"></a>        <font color=Green><u>else</u></font> <font color=Green><u>if</u></font> <font color=Cyan>(</font>ischild <font color=Cyan>==</font> False<font color=Cyan>)</font> <font color=Green><u>then</u></font>
<a name="line-355"></a>           <font color=Green><u>if</u></font> <font color=Cyan>(</font>b <font color=Cyan>/=</font> b'<font color=Cyan>)</font> <font color=Green><u>then</u></font>
<a name="line-356"></a>             error <font color=Magenta>"Test failed (17)"</font>
<a name="line-357"></a>           <font color=Green><u>else</u></font>
<a name="line-358"></a>             return ()
<a name="line-359"></a>        <font color=Green><u>else</u></font> <font color=Green><u>if</u></font> a <font color=Cyan>.&amp;.</font> nn <font color=Cyan>/=</font> <font color=Magenta>0</font> <font color=Green><u>then</u></font>
<a name="line-360"></a>          <font color=Green><u>if</u></font> direction <font color=Cyan>==</font> False <font color=Cyan>&amp;&amp;</font> db <font color=Cyan>/=</font> <font color=Cyan>(</font>a <font color=Cyan>`xor`</font> f <font color=Cyan>`xor`</font> <font color=Magenta>2</font><font color=Cyan>*</font>nn<font color=Cyan>)</font> <font color=Cyan>.|.</font> nn <font color=Green><u>then</u></font>
<a name="line-361"></a>            error <font color=Magenta>"Test failed (18)"</font>
<a name="line-362"></a>          <font color=Green><u>else</u></font> <font color=Green><u>if</u></font> direction <font color=Cyan>==</font> True <font color=Cyan>&amp;&amp;</font> a <font color=Cyan>.&amp;.</font> <font color=Cyan>(</font><font color=Magenta>2</font><font color=Cyan>*</font>nn<font color=Cyan>)</font> <font color=Cyan>/=</font> <font color=Magenta>0</font> <font color=Cyan>&amp;&amp;</font> db <font color=Cyan>/=</font> <font color=Cyan>(</font><font color=Cyan>(</font>a <font color=Blue><i>-</i></font> g<font color=Cyan>)</font> <font color=Cyan>.&amp;.</font> <font color=Cyan>(</font><font color=Magenta>2</font><font color=Cyan>*</font>nn<font color=Blue><i>-</i></font><font color=Magenta>1</font><font color=Cyan>)</font><font color=Cyan>)</font> <font color=Cyan>.|.</font> nn <font color=Green><u>then</u></font>
<a name="line-363"></a>            error <font color=Magenta>"Test failed (19)"</font>
<a name="line-364"></a>          <font color=Green><u>else</u></font> <font color=Green><u>if</u></font> direction <font color=Cyan>==</font> True <font color=Cyan>&amp;&amp;</font> a <font color=Cyan>.&amp;.</font> <font color=Cyan>(</font><font color=Magenta>2</font><font color=Cyan>*</font>nn<font color=Cyan>)</font> <font color=Cyan>==</font> <font color=Magenta>0</font> <font color=Cyan>&amp;&amp;</font> db <font color=Cyan>/=</font> <font color=Cyan>(</font><font color=Cyan>(</font><font color=Cyan>(</font>a <font color=Cyan>+</font> g<font color=Cyan>)</font> <font color=Cyan>.&amp;.</font> <font color=Cyan>(</font><font color=Magenta>2</font><font color=Cyan>*</font>nn<font color=Blue><i>-</i></font><font color=Magenta>1</font><font color=Cyan>)</font><font color=Cyan>)</font> <font color=Cyan>.|.</font> <font color=Cyan>(</font><font color=Magenta>2</font><font color=Cyan>*</font>nn<font color=Cyan>)</font> <font color=Cyan>.|.</font> nn<font color=Cyan>)</font> <font color=Green><u>then</u></font>
<a name="line-365"></a>            error <font color=Magenta>"Test failed (20)"</font>
<a name="line-366"></a>          <font color=Green><u>else</u></font>
<a name="line-367"></a>            return ()
<a name="line-368"></a>        <font color=Green><u>else</u></font>
<a name="line-369"></a>          <font color=Green><u>if</u></font> db <font color=Cyan>/=</font> <font color=Cyan>(</font><font color=Cyan>(</font><font color=Magenta>2</font><font color=Cyan>*</font>a<font color=Cyan>)</font> <font color=Cyan>.&amp;.</font> <font color=Cyan>(</font><font color=Magenta>2</font><font color=Cyan>*</font>nn<font color=Blue><i>-</i></font><font color=Magenta>1</font><font color=Cyan>)</font><font color=Cyan>)</font> <font color=Cyan>.|.</font> <font color=Cyan>(</font>a <font color=Cyan>.&amp;.</font> <font color=Cyan>(</font><font color=Magenta>2</font><font color=Cyan>*</font>nn<font color=Cyan>)</font><font color=Cyan>)</font> <font color=Cyan>.|.</font> <font color=Cyan>(</font><font color=Green><u>if</u></font> direction <font color=Green><u>then</u></font> <font color=Magenta>1</font> <font color=Green><u>else</u></font> <font color=Magenta>0</font><font color=Cyan>)</font> <font color=Green><u>then</u></font>
<a name="line-370"></a>            error <font color=Magenta>"Test failed (21)"</font>
<a name="line-371"></a>          <font color=Green><u>else</u></font>
<a name="line-372"></a>            return ()
<a name="line-373"></a>
<a name="line-374"></a><a name="simulate_setChildInTree"></a><font color=Blue><i>-- | Simulate 'setChildInTree' on all possible inputs for tree height /n/. </i></font>
<a name="line-375"></a><font color=Blue>simulate_setChildInTree</font> <font color=Red>::</font> Int <font color=Red>-&gt;</font> IO()
<a name="line-376"></a><font color=Blue>simulate_setChildInTree</font> n <font color=Red>=</font> mapM_ output <font color=Cyan>(</font>sample_all0 <font color=Cyan>(</font><font color=Magenta>4</font><font color=Cyan>*</font>nn<font color=Blue><i>-</i></font><font color=Magenta>1</font><font color=Cyan>,</font> <font color=Magenta>4</font><font color=Cyan>*</font>nn<font color=Blue><i>-</i></font><font color=Magenta>1</font><font color=Cyan>,</font> True<font color=Cyan>,</font> True<font color=Cyan>)</font><font color=Cyan>)</font>
<a name="line-377"></a>  <font color=Green><u>where</u></font>
<a name="line-378"></a>    nn <font color=Red>=</font> <font color=Magenta>2</font><font color=Cyan>^</font><font color=Cyan>(</font>toInteger n<font color=Cyan>)</font> <font color=Red>::</font> Integer <font color=Blue><i>-- can be quite large!</i></font>
<a name="line-379"></a>    output <font color=Red>::</font> <font color=Cyan>(</font>Integer<font color=Cyan>,</font>Integer<font color=Cyan>,</font>Bool<font color=Cyan>,</font>Bool<font color=Cyan>)</font> <font color=Red>-&gt;</font> IO()
<a name="line-380"></a>    output <font color=Cyan>(</font>a<font color=Cyan>,</font>b<font color=Cyan>,</font>childctrl<font color=Cyan>,</font>direction<font color=Cyan>)</font> <font color=Red>=</font>
<a name="line-381"></a>      <font color=Green><u>let</u></font>
<a name="line-382"></a>        <font color=Green><u>as</u></font> <font color=Red>=</font> boollist_of_int_bh <font color=Cyan>(</font>n<font color=Cyan>+</font><font color=Magenta>2</font><font color=Cyan>)</font> a
<a name="line-383"></a>        bs <font color=Red>=</font> boollist_of_int_bh <font color=Cyan>(</font>n<font color=Cyan>+</font><font color=Magenta>2</font><font color=Cyan>)</font> b
<a name="line-384"></a>        <font color=Cyan>(</font>as'<font color=Cyan>,</font>bs'<font color=Cyan>,</font>childctrl'<font color=Cyan>,</font>direction'<font color=Cyan>)</font> <font color=Red>=</font> run_classical_generic <font color=Cyan>(</font>runfun n<font color=Cyan>)</font> <font color=Cyan>(</font><font color=Green><u>as</u></font><font color=Cyan>,</font> bs<font color=Cyan>,</font> childctrl<font color=Cyan>,</font> direction<font color=Cyan>)</font>
<a name="line-385"></a>
<a name="line-386"></a>        runfun <font color=Red>::</font> Int <font color=Red>-&gt;</font> <font color=Cyan>(</font>Qulist<font color=Cyan>,</font>Qulist<font color=Cyan>,</font>Qubit<font color=Cyan>,</font>Qubit<font color=Cyan>)</font> <font color=Red>-&gt;</font> Circ <font color=Cyan>(</font>Qulist<font color=Cyan>,</font>Qulist<font color=Cyan>,</font>Qubit<font color=Cyan>,</font>Qubit<font color=Cyan>)</font>
<a name="line-387"></a>        runfun n <font color=Cyan>(</font><font color=Green><u>as</u></font><font color=Cyan>,</font> bs<font color=Cyan>,</font> childctrl<font color=Cyan>,</font> direction<font color=Cyan>)</font> <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-388"></a>          setChildInTree <font color=Cyan>(</font>qureg_of_qulist_te <font color=Green><u>as</u></font><font color=Cyan>,</font> qureg_of_qulist_te bs<font color=Cyan>,</font> childctrl<font color=Cyan>,</font> direction<font color=Cyan>,</font> n<font color=Cyan>)</font>
<a name="line-389"></a>          return <font color=Cyan>(</font><font color=Green><u>as</u></font><font color=Cyan>,</font> bs<font color=Cyan>,</font> childctrl<font color=Cyan>,</font> direction<font color=Cyan>)</font>
<a name="line-390"></a>        a' <font color=Red>=</font> int_of_boollist_unsigned_bh as' <font color=Red>::</font> Integer
<a name="line-391"></a>        b' <font color=Red>=</font> int_of_boollist_unsigned_bh bs' <font color=Red>::</font> Integer
<a name="line-392"></a>        db <font color=Red>=</font> b <font color=Cyan>`xor`</font> b'
<a name="line-393"></a>      <font color=Green><u>in</u></font> <font color=Green><u>do</u></font>
<a name="line-394"></a>        printf <font color=Magenta>"(a=%d, b=%d) -&gt; (a=%d, b=%d) (db=%d) childctrl=%s direction=%s\n"</font> a b a' b' db <font color=Cyan>(</font>show childctrl<font color=Cyan>)</font> <font color=Cyan>(</font>show direction<font color=Cyan>)</font>
<a name="line-395"></a>        <font color=Green><u>if</u></font> <font color=Cyan>(</font>a <font color=Cyan>/=</font> a' <font color=Cyan>||</font> childctrl <font color=Cyan>/=</font> childctrl' <font color=Cyan>||</font> direction <font color=Cyan>/=</font> direction'<font color=Cyan>)</font> <font color=Green><u>then</u></font>
<a name="line-396"></a>          error <font color=Magenta>"Test failed (22)"</font>
<a name="line-397"></a>        <font color=Green><u>else</u></font> <font color=Green><u>if</u></font> <font color=Cyan>(</font>childctrl <font color=Cyan>==</font> False<font color=Cyan>)</font> <font color=Green><u>then</u></font>
<a name="line-398"></a>           <font color=Green><u>if</u></font> <font color=Cyan>(</font>b <font color=Cyan>/=</font> b'<font color=Cyan>)</font> <font color=Green><u>then</u></font>
<a name="line-399"></a>             error <font color=Magenta>"Test failed (23)"</font>
<a name="line-400"></a>           <font color=Green><u>else</u></font>
<a name="line-401"></a>             return ()
<a name="line-402"></a>        <font color=Green><u>else</u></font> <font color=Green><u>if</u></font> db <font color=Cyan>/=</font> <font color=Cyan>(</font><font color=Cyan>(</font><font color=Magenta>2</font><font color=Cyan>*</font>a<font color=Cyan>)</font> <font color=Cyan>.&amp;.</font> <font color=Cyan>(</font><font color=Magenta>2</font><font color=Cyan>*</font>nn<font color=Blue><i>-</i></font><font color=Magenta>1</font><font color=Cyan>)</font><font color=Cyan>)</font> <font color=Cyan>.|.</font> <font color=Cyan>(</font>a <font color=Cyan>.&amp;.</font> <font color=Cyan>(</font><font color=Magenta>2</font><font color=Cyan>*</font>nn<font color=Cyan>)</font><font color=Cyan>)</font> <font color=Cyan>.|.</font> <font color=Cyan>(</font><font color=Green><u>if</u></font> direction <font color=Green><u>then</u></font> <font color=Magenta>1</font> <font color=Green><u>else</u></font> <font color=Magenta>0</font><font color=Cyan>)</font> <font color=Green><u>then</u></font>
<a name="line-403"></a>          error <font color=Magenta>"Test failed (24)"</font>
<a name="line-404"></a>        <font color=Green><u>else</u></font>
<a name="line-405"></a>          return ()
<a name="line-406"></a>
<a name="line-407"></a><a name="simulate_setWeld"></a><font color=Blue><i>-- | Simulate 'setWeld' on all possible inputs for tree height /n/. </i></font>
<a name="line-408"></a><font color=Blue>simulate_setWeld</font> <font color=Red>::</font> Int <font color=Red>-&gt;</font> IO()
<a name="line-409"></a><font color=Blue>simulate_setWeld</font> n <font color=Red>=</font> mapM_ output <font color=Cyan>(</font>sample_all0 <font color=Cyan>(</font><font color=Magenta>4</font><font color=Cyan>*</font>nn<font color=Blue><i>-</i></font><font color=Magenta>1</font><font color=Cyan>,</font> <font color=Magenta>4</font><font color=Cyan>*</font>nn<font color=Blue><i>-</i></font><font color=Magenta>1</font><font color=Cyan>,</font> nn<font color=Blue><i>-</i></font><font color=Magenta>1</font><font color=Cyan>,</font> nn<font color=Blue><i>-</i></font><font color=Magenta>1</font><font color=Cyan>,</font> True<font color=Cyan>,</font> True<font color=Cyan>)</font><font color=Cyan>)</font>
<a name="line-410"></a>  <font color=Green><u>where</u></font>
<a name="line-411"></a>    nn <font color=Red>=</font> <font color=Magenta>2</font><font color=Cyan>^</font><font color=Cyan>(</font>toInteger n<font color=Cyan>)</font> <font color=Red>::</font> Integer <font color=Blue><i>-- can be quite large!</i></font>
<a name="line-412"></a>    output <font color=Red>::</font> <font color=Cyan>(</font>Integer<font color=Cyan>,</font>Integer<font color=Cyan>,</font>Integer<font color=Cyan>,</font>Integer<font color=Cyan>,</font>Bool<font color=Cyan>,</font>Bool<font color=Cyan>)</font> <font color=Red>-&gt;</font> IO()
<a name="line-413"></a>    output <font color=Cyan>(</font>a<font color=Cyan>,</font>b<font color=Cyan>,</font>f<font color=Cyan>,</font>g<font color=Cyan>,</font>childctrl<font color=Cyan>,</font>direction<font color=Cyan>)</font> <font color=Red>=</font>
<a name="line-414"></a>      <font color=Green><u>let</u></font>
<a name="line-415"></a>        <font color=Green><u>as</u></font> <font color=Red>=</font> boollist_of_int_bh <font color=Cyan>(</font>n<font color=Cyan>+</font><font color=Magenta>2</font><font color=Cyan>)</font> a
<a name="line-416"></a>        bs <font color=Red>=</font> boollist_of_int_bh <font color=Cyan>(</font>n<font color=Cyan>+</font><font color=Magenta>2</font><font color=Cyan>)</font> b
<a name="line-417"></a>        fs <font color=Red>=</font> boollist_of_int_bh n f
<a name="line-418"></a>        gs <font color=Red>=</font> boollist_of_int_bh n g
<a name="line-419"></a>        <font color=Cyan>(</font>as'<font color=Cyan>,</font>bs'<font color=Cyan>,</font>childctrl'<font color=Cyan>,</font>direction'<font color=Cyan>)</font> <font color=Red>=</font> run_classical_generic <font color=Cyan>(</font>runfun n fs gs<font color=Cyan>)</font> <font color=Cyan>(</font><font color=Green><u>as</u></font><font color=Cyan>,</font> bs<font color=Cyan>,</font> childctrl<font color=Cyan>,</font> direction<font color=Cyan>)</font>
<a name="line-420"></a>
<a name="line-421"></a>        runfun <font color=Red>::</font> Int <font color=Red>-&gt;</font> Boollist <font color=Red>-&gt;</font> Boollist <font color=Red>-&gt;</font> <font color=Cyan>(</font>Qulist<font color=Cyan>,</font>Qulist<font color=Cyan>,</font>Qubit<font color=Cyan>,</font>Qubit<font color=Cyan>)</font> <font color=Red>-&gt;</font> Circ <font color=Cyan>(</font>Qulist<font color=Cyan>,</font>Qulist<font color=Cyan>,</font>Qubit<font color=Cyan>,</font>Qubit<font color=Cyan>)</font>
<a name="line-422"></a>        runfun n f g <font color=Cyan>(</font><font color=Green><u>as</u></font><font color=Cyan>,</font> bs<font color=Cyan>,</font> childctrl<font color=Cyan>,</font> direction<font color=Cyan>)</font> <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-423"></a>          setWeld <font color=Cyan>(</font>qureg_of_qulist_te <font color=Green><u>as</u></font><font color=Cyan>,</font> qureg_of_qulist_te bs<font color=Cyan>,</font> childctrl<font color=Cyan>,</font> direction<font color=Cyan>,</font> boolreg_of_boollist_te f<font color=Cyan>,</font> boolreg_of_boollist_te g<font color=Cyan>,</font> n<font color=Cyan>)</font>
<a name="line-424"></a>          return <font color=Cyan>(</font><font color=Green><u>as</u></font><font color=Cyan>,</font> bs<font color=Cyan>,</font> childctrl<font color=Cyan>,</font> direction<font color=Cyan>)</font>
<a name="line-425"></a>        a' <font color=Red>=</font> int_of_boollist_unsigned_bh as' <font color=Red>::</font> Integer
<a name="line-426"></a>        b' <font color=Red>=</font> int_of_boollist_unsigned_bh bs' <font color=Red>::</font> Integer
<a name="line-427"></a>        db <font color=Red>=</font> b <font color=Cyan>`xor`</font> b'
<a name="line-428"></a>      <font color=Green><u>in</u></font> <font color=Green><u>do</u></font>
<a name="line-429"></a>        printf <font color=Magenta>"(a=%d, b=%d, f=%d, g=%d) -&gt; (a=%d, b=%d) (db=%d) childctrl=%s direction=%s\n"</font> a b f g a' b' db <font color=Cyan>(</font>show childctrl<font color=Cyan>)</font> <font color=Cyan>(</font>show direction<font color=Cyan>)</font>
<a name="line-430"></a>        <font color=Green><u>if</u></font> <font color=Cyan>(</font>a <font color=Cyan>/=</font> a' <font color=Cyan>||</font> childctrl <font color=Cyan>/=</font> childctrl' <font color=Cyan>||</font> direction <font color=Cyan>/=</font> direction'<font color=Cyan>)</font> <font color=Green><u>then</u></font>
<a name="line-431"></a>          error <font color=Magenta>"Test failed (25)"</font>
<a name="line-432"></a>        <font color=Green><u>else</u></font> <font color=Green><u>if</u></font> <font color=Cyan>(</font>childctrl <font color=Cyan>==</font> False<font color=Cyan>)</font> <font color=Green><u>then</u></font>
<a name="line-433"></a>           <font color=Green><u>if</u></font> <font color=Cyan>(</font>b <font color=Cyan>/=</font> b'<font color=Cyan>)</font> <font color=Green><u>then</u></font>
<a name="line-434"></a>             error <font color=Magenta>"Test failed (26)"</font>
<a name="line-435"></a>           <font color=Green><u>else</u></font>
<a name="line-436"></a>             return ()
<a name="line-437"></a>        <font color=Green><u>else</u></font> <font color=Green><u>if</u></font> direction <font color=Cyan>==</font> False <font color=Cyan>&amp;&amp;</font> db <font color=Cyan>/=</font> <font color=Cyan>(</font>a <font color=Cyan>`xor`</font> f <font color=Cyan>`xor`</font> <font color=Magenta>2</font><font color=Cyan>*</font>nn<font color=Cyan>)</font> <font color=Cyan>.|.</font> nn <font color=Green><u>then</u></font>
<a name="line-438"></a>          error <font color=Magenta>"Test failed (27)"</font>
<a name="line-439"></a>        <font color=Green><u>else</u></font> <font color=Green><u>if</u></font> direction <font color=Cyan>==</font> True <font color=Cyan>&amp;&amp;</font> a <font color=Cyan>.&amp;.</font> <font color=Cyan>(</font><font color=Magenta>2</font><font color=Cyan>*</font>nn<font color=Cyan>)</font> <font color=Cyan>/=</font> <font color=Magenta>0</font> <font color=Cyan>&amp;&amp;</font> db <font color=Cyan>/=</font> <font color=Cyan>(</font><font color=Cyan>(</font>a <font color=Blue><i>-</i></font> g<font color=Cyan>)</font> <font color=Cyan>.&amp;.</font> <font color=Cyan>(</font><font color=Magenta>2</font><font color=Cyan>*</font>nn<font color=Blue><i>-</i></font><font color=Magenta>1</font><font color=Cyan>)</font><font color=Cyan>)</font> <font color=Cyan>.|.</font> nn <font color=Green><u>then</u></font>
<a name="line-440"></a>          error <font color=Magenta>"Test failed (28)"</font>
<a name="line-441"></a>        <font color=Green><u>else</u></font> <font color=Green><u>if</u></font> direction <font color=Cyan>==</font> True <font color=Cyan>&amp;&amp;</font> a <font color=Cyan>.&amp;.</font> <font color=Cyan>(</font><font color=Magenta>2</font><font color=Cyan>*</font>nn<font color=Cyan>)</font> <font color=Cyan>==</font> <font color=Magenta>0</font> <font color=Cyan>&amp;&amp;</font> db <font color=Cyan>/=</font> <font color=Cyan>(</font><font color=Cyan>(</font><font color=Cyan>(</font>a <font color=Cyan>+</font> g<font color=Cyan>)</font> <font color=Cyan>.&amp;.</font> <font color=Cyan>(</font><font color=Magenta>2</font><font color=Cyan>*</font>nn<font color=Blue><i>-</i></font><font color=Magenta>1</font><font color=Cyan>)</font><font color=Cyan>)</font> <font color=Cyan>.|.</font> <font color=Cyan>(</font><font color=Magenta>2</font><font color=Cyan>*</font>nn<font color=Cyan>)</font> <font color=Cyan>.|.</font> nn<font color=Cyan>)</font> <font color=Green><u>then</u></font>
<a name="line-442"></a>          error <font color=Magenta>"Test failed (29)"</font>
<a name="line-443"></a>        <font color=Green><u>else</u></font>
<a name="line-444"></a>          return ()
<a name="line-445"></a>
<a name="line-446"></a><a name="simulate_doWeld1"></a><font color=Blue><i>-- | Simulate 'doWeld1' on all possible inputs for tree height /n/. </i></font>
<a name="line-447"></a><font color=Blue>simulate_doWeld1</font> <font color=Red>::</font> Int <font color=Red>-&gt;</font> IO()
<a name="line-448"></a><font color=Blue>simulate_doWeld1</font> n <font color=Red>=</font> mapM_ output <font color=Cyan>(</font>sample_all0 <font color=Cyan>(</font><font color=Magenta>4</font><font color=Cyan>*</font>nn<font color=Blue><i>-</i></font><font color=Magenta>1</font><font color=Cyan>,</font> <font color=Magenta>4</font><font color=Cyan>*</font>nn<font color=Blue><i>-</i></font><font color=Magenta>1</font><font color=Cyan>,</font> nn<font color=Blue><i>-</i></font><font color=Magenta>1</font><font color=Cyan>,</font> True<font color=Cyan>)</font><font color=Cyan>)</font>
<a name="line-449"></a>  <font color=Green><u>where</u></font>
<a name="line-450"></a>    nn <font color=Red>=</font> <font color=Magenta>2</font><font color=Cyan>^</font><font color=Cyan>(</font>toInteger n<font color=Cyan>)</font> <font color=Red>::</font> Integer <font color=Blue><i>-- can be quite large!</i></font>
<a name="line-451"></a>    output <font color=Red>::</font> <font color=Cyan>(</font>Integer<font color=Cyan>,</font> Integer<font color=Cyan>,</font> Integer<font color=Cyan>,</font> Bool<font color=Cyan>)</font> <font color=Red>-&gt;</font> IO()
<a name="line-452"></a>    output <font color=Cyan>(</font>a<font color=Cyan>,</font>b<font color=Cyan>,</font>c<font color=Cyan>,</font>control<font color=Cyan>)</font> <font color=Red>=</font>    
<a name="line-453"></a>      <font color=Green><u>let</u></font>
<a name="line-454"></a>        <font color=Green><u>as</u></font> <font color=Red>=</font> boollist_of_int_bh <font color=Cyan>(</font>n<font color=Cyan>+</font><font color=Magenta>2</font><font color=Cyan>)</font> a
<a name="line-455"></a>        bs <font color=Red>=</font> boollist_of_int_bh <font color=Cyan>(</font>n<font color=Cyan>+</font><font color=Magenta>2</font><font color=Cyan>)</font> b
<a name="line-456"></a>        cs <font color=Red>=</font> boollist_of_int_bh n c
<a name="line-457"></a>        <font color=Cyan>(</font>control'<font color=Cyan>,</font> bs'<font color=Cyan>,</font> as'<font color=Cyan>)</font> <font color=Red>=</font> run_classical_generic <font color=Cyan>(</font>runfun n cs<font color=Cyan>)</font> <font color=Cyan>(</font>control<font color=Cyan>,</font> bs<font color=Cyan>,</font> <font color=Green><u>as</u></font><font color=Cyan>)</font>
<a name="line-458"></a>
<a name="line-459"></a>        runfun <font color=Red>::</font> Int <font color=Red>-&gt;</font> Boollist <font color=Red>-&gt;</font> <font color=Cyan>(</font>Qubit<font color=Cyan>,</font> Qulist<font color=Cyan>,</font> Qulist<font color=Cyan>)</font> <font color=Red>-&gt;</font> Circ <font color=Cyan>(</font>Qubit<font color=Cyan>,</font> Qulist<font color=Cyan>,</font> Qulist<font color=Cyan>)</font>
<a name="line-460"></a>        runfun n c <font color=Cyan>(</font>control<font color=Cyan>,</font> b<font color=Cyan>,</font> a<font color=Cyan>)</font> <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-461"></a>          doWeld1 <font color=Cyan>(</font>qureg_of_qulist_te a<font color=Cyan>,</font> qureg_of_qulist_te b<font color=Cyan>,</font> control<font color=Cyan>,</font> boolreg_of_boollist_te c<font color=Cyan>,</font> n<font color=Cyan>)</font>
<a name="line-462"></a>          return <font color=Cyan>(</font>control<font color=Cyan>,</font> b<font color=Cyan>,</font> a<font color=Cyan>)</font>
<a name="line-463"></a>        a' <font color=Red>=</font> int_of_boollist_unsigned_bh as' <font color=Red>::</font> Integer
<a name="line-464"></a>        b' <font color=Red>=</font> int_of_boollist_unsigned_bh bs' <font color=Red>::</font> Integer
<a name="line-465"></a>      <font color=Green><u>in</u></font> <font color=Green><u>do</u></font>
<a name="line-466"></a>        printf <font color=Magenta>"(%d, %d, %d) -&gt; (%d, %d) %s %s\n"</font> a b c a' b' <font color=Cyan>(</font>show control<font color=Cyan>)</font> <font color=Cyan>(</font>show control'<font color=Cyan>)</font>
<a name="line-467"></a>        <font color=Green><u>if</u></font> <font color=Cyan>(</font>control <font color=Cyan>&amp;&amp;</font> a <font color=Cyan>.&amp;.</font> <font color=Cyan>(</font><font color=Magenta>2</font><font color=Cyan>*</font>nn<font color=Cyan>)</font> <font color=Cyan>/=</font> <font color=Magenta>0</font> <font color=Cyan>&amp;&amp;</font> a' <font color=Cyan>==</font> a <font color=Cyan>&amp;&amp;</font> b' <font color=Cyan>==</font> <font color=Cyan>(</font><font color=Cyan>(</font><font color=Cyan>(</font>a<font color=Blue><i>-</i></font>c<font color=Cyan>)</font> <font color=Cyan>.&amp;.</font> <font color=Cyan>(</font>nn<font color=Blue><i>-</i></font><font color=Magenta>1</font><font color=Cyan>)</font><font color=Cyan>)</font> <font color=Cyan>`xor`</font> b<font color=Cyan>)</font> <font color=Cyan>&amp;&amp;</font> control' <font color=Cyan>==</font> control<font color=Cyan>)</font>
<a name="line-468"></a>           <font color=Cyan>||</font> <font color=Cyan>(</font>control <font color=Cyan>&amp;&amp;</font> a <font color=Cyan>.&amp;.</font> <font color=Cyan>(</font><font color=Magenta>2</font><font color=Cyan>*</font>nn<font color=Cyan>)</font> <font color=Cyan>==</font> <font color=Magenta>0</font> <font color=Cyan>&amp;&amp;</font> a' <font color=Cyan>==</font> a <font color=Cyan>&amp;&amp;</font> b' <font color=Cyan>==</font> <font color=Cyan>(</font><font color=Cyan>(</font><font color=Cyan>(</font>a<font color=Cyan>+</font>c<font color=Cyan>)</font> <font color=Cyan>.&amp;.</font> <font color=Cyan>(</font>nn<font color=Blue><i>-</i></font><font color=Magenta>1</font><font color=Cyan>)</font><font color=Cyan>)</font> <font color=Cyan>`xor`</font> b<font color=Cyan>)</font> <font color=Cyan>&amp;&amp;</font> control' <font color=Cyan>==</font> control<font color=Cyan>)</font>
<a name="line-469"></a>           <font color=Cyan>||</font> <font color=Cyan>(</font>not control <font color=Cyan>&amp;&amp;</font> a' <font color=Cyan>==</font> a <font color=Cyan>&amp;&amp;</font> b' <font color=Cyan>==</font> b <font color=Cyan>&amp;&amp;</font> control' <font color=Cyan>==</font> control<font color=Cyan>)</font> <font color=Green><u>then</u></font>
<a name="line-470"></a>          return ()  <font color=Blue><i>-- assertion succeeds</i></font>
<a name="line-471"></a>          <font color=Green><u>else</u></font>
<a name="line-472"></a>          error <font color=Magenta>"Test failed (30)"</font>
<a name="line-473"></a>
<a name="line-474"></a><a name="simulate_doWeld0"></a><font color=Blue><i>-- | Simulate 'doWeld0' on all possible inputs for tree height /n/. </i></font>
<a name="line-475"></a><font color=Blue>simulate_doWeld0</font> <font color=Red>::</font> Int <font color=Red>-&gt;</font> IO()
<a name="line-476"></a><font color=Blue>simulate_doWeld0</font> n <font color=Red>=</font> mapM_ output <font color=Cyan>(</font>sample_all0 <font color=Cyan>(</font><font color=Magenta>2</font><font color=Cyan>*</font>nn<font color=Blue><i>-</i></font><font color=Magenta>1</font><font color=Cyan>,</font> <font color=Magenta>2</font><font color=Cyan>*</font>nn<font color=Blue><i>-</i></font><font color=Magenta>1</font><font color=Cyan>,</font> nn<font color=Blue><i>-</i></font><font color=Magenta>1</font><font color=Cyan>,</font> True<font color=Cyan>)</font><font color=Cyan>)</font>
<a name="line-477"></a>  <font color=Green><u>where</u></font>
<a name="line-478"></a>    nn <font color=Red>=</font> <font color=Magenta>2</font><font color=Cyan>^</font><font color=Cyan>(</font>toInteger n<font color=Cyan>)</font> <font color=Red>::</font> Integer <font color=Blue><i>-- can be quite large!</i></font>
<a name="line-479"></a>    output <font color=Red>::</font> <font color=Cyan>(</font>Integer<font color=Cyan>,</font> Integer<font color=Cyan>,</font> Integer<font color=Cyan>,</font> Bool<font color=Cyan>)</font> <font color=Red>-&gt;</font> IO()
<a name="line-480"></a>    output <font color=Cyan>(</font>a<font color=Cyan>,</font>b<font color=Cyan>,</font>c<font color=Cyan>,</font>control<font color=Cyan>)</font> <font color=Red>=</font>    
<a name="line-481"></a>      <font color=Green><u>let</u></font>
<a name="line-482"></a>        <font color=Green><u>as</u></font> <font color=Red>=</font> boollist_of_int_bh <font color=Cyan>(</font>n<font color=Cyan>+</font><font color=Magenta>1</font><font color=Cyan>)</font> a
<a name="line-483"></a>        bs <font color=Red>=</font> boollist_of_int_bh <font color=Cyan>(</font>n<font color=Cyan>+</font><font color=Magenta>1</font><font color=Cyan>)</font> b
<a name="line-484"></a>        cs <font color=Red>=</font> boollist_of_int_bh n c
<a name="line-485"></a>        <font color=Cyan>(</font>control'<font color=Cyan>,</font> bs'<font color=Cyan>,</font> as'<font color=Cyan>)</font> <font color=Red>=</font> run_classical_generic <font color=Cyan>(</font>runfun n cs<font color=Cyan>)</font> <font color=Cyan>(</font>control<font color=Cyan>,</font> bs<font color=Cyan>,</font> <font color=Green><u>as</u></font><font color=Cyan>)</font>
<a name="line-486"></a>
<a name="line-487"></a>        runfun <font color=Red>::</font> Int <font color=Red>-&gt;</font> Boollist <font color=Red>-&gt;</font> <font color=Cyan>(</font>Qubit<font color=Cyan>,</font> Qulist<font color=Cyan>,</font> Qulist<font color=Cyan>)</font> <font color=Red>-&gt;</font> Circ <font color=Cyan>(</font>Qubit<font color=Cyan>,</font> Qulist<font color=Cyan>,</font> Qulist<font color=Cyan>)</font>
<a name="line-488"></a>        runfun n c <font color=Cyan>(</font>control<font color=Cyan>,</font> b<font color=Cyan>,</font> a<font color=Cyan>)</font> <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-489"></a>          doWeld0 <font color=Cyan>(</font>qureg_of_qulist_te a<font color=Cyan>,</font> qureg_of_qulist_te b<font color=Cyan>,</font> control<font color=Cyan>,</font> boolreg_of_boollist_te c<font color=Cyan>,</font> n<font color=Cyan>)</font>
<a name="line-490"></a>          return <font color=Cyan>(</font>control<font color=Cyan>,</font> b<font color=Cyan>,</font> a<font color=Cyan>)</font>
<a name="line-491"></a>        a' <font color=Red>=</font> int_of_boollist_unsigned_bh as' <font color=Red>::</font> Integer
<a name="line-492"></a>        b' <font color=Red>=</font> int_of_boollist_unsigned_bh bs' <font color=Red>::</font> Integer
<a name="line-493"></a>      <font color=Green><u>in</u></font> <font color=Green><u>do</u></font>
<a name="line-494"></a>        printf <font color=Magenta>"(%d, %d, %d) -&gt; (%d, %d) %s %s\n"</font> a b c a' b' <font color=Cyan>(</font>show control<font color=Cyan>)</font> <font color=Cyan>(</font>show control'<font color=Cyan>)</font>
<a name="line-495"></a>        <font color=Green><u>if</u></font> <font color=Cyan>(</font>control <font color=Cyan>&amp;&amp;</font> a' <font color=Cyan>==</font> a <font color=Cyan>&amp;&amp;</font> b' <font color=Cyan>==</font> <font color=Cyan>(</font><font color=Cyan>(</font><font color=Cyan>(</font>a <font color=Cyan>`xor`</font> c<font color=Cyan>)</font> <font color=Cyan>.&amp;.</font> <font color=Cyan>(</font>nn<font color=Blue><i>-</i></font><font color=Magenta>1</font><font color=Cyan>)</font><font color=Cyan>)</font> <font color=Cyan>`xor`</font> b<font color=Cyan>)</font> <font color=Cyan>&amp;&amp;</font> control' <font color=Cyan>==</font> control<font color=Cyan>)</font>
<a name="line-496"></a>           <font color=Cyan>||</font> <font color=Cyan>(</font>not control <font color=Cyan>&amp;&amp;</font> a' <font color=Cyan>==</font> a <font color=Cyan>&amp;&amp;</font> b' <font color=Cyan>==</font> b <font color=Cyan>&amp;&amp;</font> control' <font color=Cyan>==</font> control<font color=Cyan>)</font> <font color=Green><u>then</u></font>
<a name="line-497"></a>          return ()  <font color=Blue><i>-- assertion succeeds</i></font>
<a name="line-498"></a>          <font color=Green><u>else</u></font>
<a name="line-499"></a>          error <font color=Magenta>"Test failed (31)"</font>
<a name="line-500"></a>
<a name="line-501"></a><a name="simulate_cAddNum"></a><font color=Blue><i>-- | Simulate 'cAddNum' (including 'cAddNumClear') on all possible inputs for tree height /n/. </i></font>
<a name="line-502"></a><font color=Blue>simulate_cAddNum</font> <font color=Red>::</font> Int <font color=Red>-&gt;</font> IO()
<a name="line-503"></a><font color=Blue>simulate_cAddNum</font> n <font color=Red>=</font> mapM_ output <font color=Cyan>(</font>sample_all0 <font color=Cyan>(</font>nn<font color=Blue><i>-</i></font><font color=Magenta>1</font><font color=Cyan>,</font> nn<font color=Blue><i>-</i></font><font color=Magenta>1</font><font color=Cyan>,</font> nn<font color=Blue><i>-</i></font><font color=Magenta>1</font><font color=Cyan>,</font> True<font color=Cyan>)</font><font color=Cyan>)</font>
<a name="line-504"></a>  <font color=Green><u>where</u></font>
<a name="line-505"></a>    nn <font color=Red>=</font> <font color=Magenta>2</font><font color=Cyan>^</font><font color=Cyan>(</font>toInteger n<font color=Cyan>)</font> <font color=Red>::</font> Integer
<a name="line-506"></a>    output <font color=Red>::</font> <font color=Cyan>(</font>Integer<font color=Cyan>,</font> Integer<font color=Cyan>,</font> Integer<font color=Cyan>,</font> Bool<font color=Cyan>)</font> <font color=Red>-&gt;</font> IO()
<a name="line-507"></a>    output <font color=Cyan>(</font>a<font color=Cyan>,</font>b<font color=Cyan>,</font>c<font color=Cyan>,</font>control<font color=Cyan>)</font> <font color=Red>=</font>    
<a name="line-508"></a>      <font color=Green><u>let</u></font>
<a name="line-509"></a>        <font color=Green><u>as</u></font> <font color=Red>=</font> boollist_of_int_bh n a
<a name="line-510"></a>        bs <font color=Red>=</font> boollist_of_int_bh n b
<a name="line-511"></a>        cs <font color=Red>=</font> boollist_of_int_bh n c
<a name="line-512"></a>        <font color=Cyan>(</font>control'<font color=Cyan>,</font> bs'<font color=Cyan>,</font> as'<font color=Cyan>)</font> <font color=Red>=</font> run_classical_generic <font color=Cyan>(</font>runfun n cs<font color=Cyan>)</font> <font color=Cyan>(</font>control<font color=Cyan>,</font> bs<font color=Cyan>,</font> <font color=Green><u>as</u></font><font color=Cyan>)</font>
<a name="line-513"></a>
<a name="line-514"></a>        runfun <font color=Red>::</font> Int <font color=Red>-&gt;</font> Boollist <font color=Red>-&gt;</font> <font color=Cyan>(</font>Qubit<font color=Cyan>,</font> Qulist<font color=Cyan>,</font> Qulist<font color=Cyan>)</font> <font color=Red>-&gt;</font> Circ <font color=Cyan>(</font>Qubit<font color=Cyan>,</font> Qulist<font color=Cyan>,</font> Qulist<font color=Cyan>)</font>
<a name="line-515"></a>        runfun n c <font color=Cyan>(</font>control<font color=Cyan>,</font> b<font color=Cyan>,</font> a<font color=Cyan>)</font> <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-516"></a>          cAddNum <font color=Cyan>(</font>control<font color=Cyan>,</font> qureg_of_qulist_te b<font color=Cyan>,</font> qureg_of_qulist_te a<font color=Cyan>,</font> boolreg_of_boollist_te c<font color=Cyan>,</font> n<font color=Cyan>)</font>
<a name="line-517"></a>          return <font color=Cyan>(</font>control<font color=Cyan>,</font> b<font color=Cyan>,</font> a<font color=Cyan>)</font>
<a name="line-518"></a>        a' <font color=Red>=</font> int_of_boollist_unsigned_bh as'
<a name="line-519"></a>        b' <font color=Red>=</font> int_of_boollist_unsigned_bh bs'
<a name="line-520"></a>      <font color=Green><u>in</u></font> <font color=Green><u>do</u></font>
<a name="line-521"></a>        printf <font color=Magenta>"(%d, %d, %d) -&gt; (%d, %d) %s %s\n"</font> a b c a' b' <font color=Cyan>(</font>show control<font color=Cyan>)</font> <font color=Cyan>(</font>show control'<font color=Cyan>)</font>
<a name="line-522"></a>        <font color=Green><u>if</u></font> <font color=Cyan>(</font>control <font color=Cyan>&amp;&amp;</font> a' <font color=Cyan>==</font> a <font color=Cyan>&amp;&amp;</font> b' <font color=Cyan>==</font> <font color=Cyan>(</font><font color=Cyan>(</font><font color=Cyan>(</font>a<font color=Cyan>+</font>c<font color=Cyan>)</font> <font color=Cyan>`mod`</font> <font color=Cyan>(</font><font color=Magenta>2</font><font color=Cyan>^</font>n<font color=Cyan>)</font><font color=Cyan>)</font> <font color=Cyan>`xor`</font> b<font color=Cyan>)</font> <font color=Cyan>&amp;&amp;</font> control' <font color=Cyan>==</font> control<font color=Cyan>)</font>
<a name="line-523"></a>           <font color=Cyan>||</font> <font color=Cyan>(</font>not control <font color=Cyan>&amp;&amp;</font> a' <font color=Cyan>==</font> a <font color=Cyan>&amp;&amp;</font> b' <font color=Cyan>==</font> b <font color=Cyan>&amp;&amp;</font> control' <font color=Cyan>==</font> control<font color=Cyan>)</font> <font color=Green><u>then</u></font>
<a name="line-524"></a>          return ()  <font color=Blue><i>-- assertion succeeds</i></font>
<a name="line-525"></a>          <font color=Green><u>else</u></font>
<a name="line-526"></a>          error <font color=Magenta>"Test failed (32)"</font>
<a name="line-527"></a>
<a name="line-528"></a><a name="simulate_cSubNum"></a><font color=Blue><i>-- | Simulate 'cSubNum' (including 'cSubNumClear') on all possible inputs for tree height /n/. </i></font>
<a name="line-529"></a><font color=Blue>simulate_cSubNum</font> <font color=Red>::</font> Int <font color=Red>-&gt;</font> IO()
<a name="line-530"></a><font color=Blue>simulate_cSubNum</font> n <font color=Red>=</font> mapM_ output <font color=Cyan>(</font>sample_all0 <font color=Cyan>(</font>nn<font color=Blue><i>-</i></font><font color=Magenta>1</font><font color=Cyan>,</font> nn<font color=Blue><i>-</i></font><font color=Magenta>1</font><font color=Cyan>,</font> nn<font color=Blue><i>-</i></font><font color=Magenta>1</font><font color=Cyan>,</font> True<font color=Cyan>)</font><font color=Cyan>)</font>
<a name="line-531"></a>  <font color=Green><u>where</u></font>
<a name="line-532"></a>    nn <font color=Red>=</font> <font color=Magenta>2</font><font color=Cyan>^</font><font color=Cyan>(</font>toInteger n<font color=Cyan>)</font> <font color=Red>::</font> Integer <font color=Blue><i>-- can be quite large!</i></font>
<a name="line-533"></a>    output <font color=Red>::</font> <font color=Cyan>(</font>Integer<font color=Cyan>,</font> Integer<font color=Cyan>,</font> Integer<font color=Cyan>,</font> Bool<font color=Cyan>)</font> <font color=Red>-&gt;</font> IO()
<a name="line-534"></a>    output <font color=Cyan>(</font>a<font color=Cyan>,</font>b<font color=Cyan>,</font>c<font color=Cyan>,</font>control<font color=Cyan>)</font> <font color=Red>=</font>    
<a name="line-535"></a>      <font color=Green><u>let</u></font>
<a name="line-536"></a>        <font color=Green><u>as</u></font> <font color=Red>=</font> boollist_of_int_bh n a
<a name="line-537"></a>        bs <font color=Red>=</font> boollist_of_int_bh n b
<a name="line-538"></a>        cs <font color=Red>=</font> boollist_of_int_bh n c
<a name="line-539"></a>        <font color=Cyan>(</font>control'<font color=Cyan>,</font> bs'<font color=Cyan>,</font> as'<font color=Cyan>)</font> <font color=Red>=</font> run_classical_generic <font color=Cyan>(</font>runfun n cs<font color=Cyan>)</font> <font color=Cyan>(</font>control<font color=Cyan>,</font> bs<font color=Cyan>,</font> <font color=Green><u>as</u></font><font color=Cyan>)</font>
<a name="line-540"></a>
<a name="line-541"></a>        runfun <font color=Red>::</font> Int <font color=Red>-&gt;</font> Boollist <font color=Red>-&gt;</font> <font color=Cyan>(</font>Qubit<font color=Cyan>,</font> Qulist<font color=Cyan>,</font> Qulist<font color=Cyan>)</font> <font color=Red>-&gt;</font> Circ <font color=Cyan>(</font>Qubit<font color=Cyan>,</font> Qulist<font color=Cyan>,</font> Qulist<font color=Cyan>)</font>
<a name="line-542"></a>        runfun n c <font color=Cyan>(</font>control<font color=Cyan>,</font> b<font color=Cyan>,</font> a<font color=Cyan>)</font> <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-543"></a>          cSubNum <font color=Cyan>(</font>control<font color=Cyan>,</font> qureg_of_qulist_te b<font color=Cyan>,</font> qureg_of_qulist_te a<font color=Cyan>,</font> boolreg_of_boollist_te c<font color=Cyan>,</font> n<font color=Cyan>)</font>
<a name="line-544"></a>          return <font color=Cyan>(</font>control<font color=Cyan>,</font> b<font color=Cyan>,</font> a<font color=Cyan>)</font>
<a name="line-545"></a>        a' <font color=Red>=</font> int_of_boollist_unsigned_bh as'
<a name="line-546"></a>        b' <font color=Red>=</font> int_of_boollist_unsigned_bh bs'
<a name="line-547"></a>      <font color=Green><u>in</u></font> <font color=Green><u>do</u></font>
<a name="line-548"></a>        printf <font color=Magenta>"(%d, %d, %d) -&gt; (%d, %d) %s %s\n"</font> a b c a' b' <font color=Cyan>(</font>show control<font color=Cyan>)</font> <font color=Cyan>(</font>show control'<font color=Cyan>)</font>
<a name="line-549"></a>        <font color=Green><u>if</u></font> <font color=Cyan>(</font>control <font color=Cyan>&amp;&amp;</font> a' <font color=Cyan>==</font> a <font color=Cyan>&amp;&amp;</font> b' <font color=Cyan>==</font> <font color=Cyan>(</font><font color=Cyan>(</font><font color=Cyan>(</font>a<font color=Blue><i>-</i></font>c<font color=Cyan>)</font> <font color=Cyan>`mod`</font> nn<font color=Cyan>)</font> <font color=Cyan>`xor`</font> b<font color=Cyan>)</font> <font color=Cyan>&amp;&amp;</font> control' <font color=Cyan>==</font> control<font color=Cyan>)</font>
<a name="line-550"></a>           <font color=Cyan>||</font> <font color=Cyan>(</font>not control <font color=Cyan>&amp;&amp;</font> a' <font color=Cyan>==</font> a <font color=Cyan>&amp;&amp;</font> b' <font color=Cyan>==</font> b <font color=Cyan>&amp;&amp;</font> control' <font color=Cyan>==</font> control<font color=Cyan>)</font> <font color=Green><u>then</u></font>
<a name="line-551"></a>          return ()  <font color=Blue><i>-- assertion succeeds</i></font>
<a name="line-552"></a>          <font color=Green><u>else</u></font>
<a name="line-553"></a>          error <font color=Magenta>"Test failed (33)"</font>
<a name="line-554"></a>
<a name="line-555"></a><font color=Blue><i>-- ======================================================================</i></font>
<a name="line-556"></a><font color=Blue><i>-- * Auxiliary functions</i></font>
<a name="line-557"></a>
<a name="line-558"></a><a name="hibit"></a><font color=Blue><i>-- | Return the smallest number of bits required to hold the given integer.</i></font>
<a name="line-559"></a><font color=Blue>hibit</font> <font color=Red>::</font> Integral a <font color=Red>=&gt;</font> Integral b <font color=Red>=&gt;</font> a <font color=Red>-&gt;</font> b
<a name="line-560"></a><font color=Blue>hibit</font> n <font color=Red>=</font>
<a name="line-561"></a>  <font color=Green><u>if</u></font> n <font color=Cyan>&lt;=</font> <font color=Magenta>0</font> <font color=Green><u>then</u></font> 
<a name="line-562"></a>    <font color=Magenta>0</font> 
<a name="line-563"></a>  <font color=Green><u>else</u></font>
<a name="line-564"></a>    <font color=Magenta>1</font> <font color=Cyan>+</font> hibit <font color=Cyan>(</font>n <font color=Cyan>`div`</font> <font color=Magenta>2</font><font color=Cyan>)</font>
<a name="line-565"></a>
<a name="line-566"></a><font color=Blue><i>-- ======================================================================</i></font>
<a name="line-567"></a><font color=Blue><i>-- * Main functions</i></font>
<a name="line-568"></a>
<a name="line-569"></a><a name="main_all"></a><font color=Blue><i>-- | Run simulations of 'parseNodeRoot', 'parseNodeEven',</i></font>
<a name="line-570"></a><font color=Blue><i>-- 'testIsParent', 'testIsChild', 'setParent', 'setChild',</i></font>
<a name="line-571"></a><font color=Blue><i>-- 'setChildInTree', 'setWeld', 'doWeld0', 'doWeld1', 'cAddNum', and</i></font>
<a name="line-572"></a><font color=Blue><i>-- 'cSubNum' for tree height /n/.</i></font>
<a name="line-573"></a><font color=Blue>main_all</font> <font color=Red>::</font> Int <font color=Red>-&gt;</font> IO()
<a name="line-574"></a><font color=Blue>main_all</font> n <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-575"></a>  simulate_parseNodeRoot n
<a name="line-576"></a>  simulate_parseNodeEven n
<a name="line-577"></a>  simulate_testIsParent n
<a name="line-578"></a>  simulate_testIsChild n
<a name="line-579"></a>  simulate_setParent n
<a name="line-580"></a>  simulate_setChild n
<a name="line-581"></a>  simulate_setChildInTree n
<a name="line-582"></a>  simulate_setWeld n
<a name="line-583"></a>  simulate_doWeld0 n
<a name="line-584"></a>  simulate_doWeld1 n
<a name="line-585"></a>  simulate_cAddNum n
<a name="line-586"></a>  simulate_cSubNum n
</pre>
</body>
</html>