<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<html>
<head>
<!-- Generated by HsColour, http://code.haskell.org/~malcolm/hscolour/ -->
<title>Haskell code</title>
</head>
<body>
<pre><a name="line-1"></a><font color=Blue><i>{-# LANGUAGE MultiParamTypeClasses #-}</i></font>
<a name="line-2"></a><font color=Blue><i>{-# LANGUAGE FunctionalDependencies #-}</i></font>
<a name="line-3"></a><font color=Blue><i>{-# LANGUAGE FlexibleContexts #-}</i></font>
<a name="line-4"></a><font color=Blue><i>{-# LANGUAGE TypeSynonymInstances #-}</i></font>
<a name="line-5"></a>
<a name="line-6"></a><font color=Blue><i>{-# OPTIONS -fcontext-stack=50 #-}</i></font>
<a name="line-7"></a>
<a name="line-8"></a><font color=Blue><i>-- | This module contains the Quipper implementation of the Quantum</i></font>
<a name="line-9"></a><font color=Blue><i>-- Linear Systems Algorithm.</i></font>
<a name="line-10"></a><font color=Blue><i>-- </i></font>
<a name="line-11"></a><font color=Blue><i>-- The algorithm estimates the radar cross section for a FEM</i></font>
<a name="line-12"></a><font color=Blue><i>-- scattering problem by using amplitude estimation to calculate</i></font>
<a name="line-13"></a><font color=Blue><i>-- probability amplitudes. </i></font>
<a name="line-14"></a><font color=Blue><i>-- </i></font>
<a name="line-15"></a><font color=Blue><i>-- The notations are based on the paper </i></font>
<a name="line-16"></a><font color=Blue><i>-- </i></font>
<a name="line-17"></a><font color=Blue><i>-- * B. D. Clader, B. C. Jacobs, C. R. Sprouse. Quantum algorithm to</i></font>
<a name="line-18"></a><font color=Blue><i>-- calculate electromagnetic scattering cross</i></font>
<a name="line-19"></a><font color=Blue><i>-- sections. &lt;<a href="http://arxiv.org/abs/1301.2340">http://arxiv.org/abs/1301.2340</a>&gt;.</i></font>
<a name="line-20"></a><font color=Green><u>module</u></font> Algorithms<font color=Cyan>.</font>QLS<font color=Cyan>.</font>QLS <font color=Green><u>where</u></font>
<a name="line-21"></a>
<a name="line-22"></a><font color=Green><u>import</u></font> Quipper
<a name="line-23"></a>
<a name="line-24"></a><font color=Green><u>import</u></font> QuipperLib<font color=Cyan>.</font>QFT
<a name="line-25"></a><font color=Green><u>import</u></font> QuipperLib<font color=Cyan>.</font>Arith
<a name="line-26"></a><font color=Green><u>import</u></font> QuipperLib<font color=Cyan>.</font>Decompose
<a name="line-27"></a>
<a name="line-28"></a><font color=Green><u>import</u></font> Data<font color=Cyan>.</font>Complex
<a name="line-29"></a><font color=Green><u>import</u></font> <font color=Green><u>qualified</u></font> Data<font color=Cyan>.</font>Map <font color=Green><u>as</u></font> Map
<a name="line-30"></a>
<a name="line-31"></a><font color=Green><u>import</u></font> <font color=Green><u>qualified</u></font> Algorithms<font color=Cyan>.</font>QLS<font color=Cyan>.</font>TemplateOracle <font color=Green><u>as</u></font> Template
<a name="line-32"></a><font color=Green><u>import</u></font> Algorithms<font color=Cyan>.</font>QLS<font color=Cyan>.</font>QDouble
<a name="line-33"></a><font color=Green><u>import</u></font> Algorithms<font color=Cyan>.</font>QLS<font color=Cyan>.</font>QSignedInt
<a name="line-34"></a><font color=Green><u>import</u></font> Algorithms<font color=Cyan>.</font>QLS<font color=Cyan>.</font>CircLiftingImport
<a name="line-35"></a><font color=Green><u>import</u></font> Algorithms<font color=Cyan>.</font>QLS<font color=Cyan>.</font>Utils
<a name="line-36"></a>
<a name="line-37"></a><font color=Green><u>import</u></font> Libraries<font color=Cyan>.</font>Auxiliary<font color=Cyan>(</font>boollist_of_int_bh<font color=Cyan>)</font>
<a name="line-38"></a>
<a name="line-39"></a>
<a name="line-40"></a><a name="OracleARunTime"></a><font color=Blue><i>-- | The type of 'oracle_A' input arguments during runtime.</i></font>
<a name="line-41"></a><a name="OracleARunTime"></a><font color=Green><u>type</u></font> OracleARunTime <font color=Red>=</font> Double  <font color=Blue><i>-- ^Value resolution.</i></font>
<a name="line-42"></a>       <font color=Red>-&gt;</font> Int                 <font color=Blue><i>-- ^Band.</i></font>
<a name="line-43"></a>       <font color=Red>-&gt;</font> Bool                <font color=Blue><i>-- ^Argflag.</i></font>
<a name="line-44"></a>       <font color=Red>-&gt;</font> <font color=Cyan>(</font><font color=Red>[</font>Qubit<font color=Red>]</font><font color=Cyan>,</font><font color=Red>[</font>Qubit<font color=Red>]</font><font color=Cyan>,</font><font color=Red>[</font>Qubit<font color=Red>]</font><font color=Cyan>)</font>  <font color=Blue><i>-- ^(x=index,y+node,z+value).</i></font>
<a name="line-45"></a>       <font color=Red>-&gt;</font> Circ <font color=Cyan>(</font><font color=Red>[</font>Qubit<font color=Red>]</font><font color=Cyan>,</font><font color=Red>[</font>Qubit<font color=Red>]</font><font color=Cyan>,</font><font color=Red>[</font>Qubit<font color=Red>]</font><font color=Cyan>)</font>
<a name="line-46"></a>
<a name="line-47"></a><a name="OracleBRRunTime"></a><font color=Blue><i>-- | The type of 'oracle_b' and 'oracle_r' input arguments during runtime.</i></font>
<a name="line-48"></a><a name="OracleBRRunTime"></a><font color=Green><u>type</u></font> OracleBRRunTime <font color=Red>=</font> Double  <font color=Blue><i>-- ^Magnitude resolution.</i></font>
<a name="line-49"></a>        <font color=Red>-&gt;</font> Double              <font color=Blue><i>-- ^Phase resolution.</i></font>
<a name="line-50"></a>        <font color=Red>-&gt;</font> <font color=Cyan>(</font><font color=Red>[</font>Qubit<font color=Red>]</font><font color=Cyan>,</font><font color=Red>[</font>Qubit<font color=Red>]</font><font color=Cyan>,</font><font color=Red>[</font>Qubit<font color=Red>]</font><font color=Cyan>)</font> <font color=Blue><i>-- ^(x=index,m+magnitude,p+phase).</i></font>
<a name="line-51"></a>        <font color=Red>-&gt;</font> Circ <font color=Cyan>(</font><font color=Red>[</font>Qubit<font color=Red>]</font><font color=Cyan>,</font><font color=Red>[</font>Qubit<font color=Red>]</font><font color=Cyan>,</font><font color=Red>[</font>Qubit<font color=Red>]</font><font color=Cyan>)</font>
<a name="line-52"></a>
<a name="line-53"></a>
<a name="line-54"></a><a name="Oracle"></a><font color=Blue><i>-- | A type to encapsulate all three oracles.</i></font>
<a name="line-55"></a><a name="Oracle"></a><font color=Green><u>data</u></font> Oracle <font color=Red>=</font> Oracle <font color=Cyan>{</font>
<a name="line-56"></a>  oracle_A <font color=Red>::</font> RunTimeParam <font color=Red>-&gt;</font> OracleARunTime<font color=Cyan>,</font>
<a name="line-57"></a>  oracle_b <font color=Red>::</font> RunTimeParam <font color=Red>-&gt;</font> OracleBRRunTime<font color=Cyan>,</font>
<a name="line-58"></a>  oracle_r <font color=Red>::</font> RunTimeParam <font color=Red>-&gt;</font> OracleBRRunTime
<a name="line-59"></a><font color=Cyan>}</font>
<a name="line-60"></a>
<a name="line-61"></a>
<a name="line-62"></a><a name="dummy_oracle"></a><font color=Blue><i>-- | A set of oracles using only blackboxes.</i></font>
<a name="line-63"></a><font color=Blue>dummy_oracle</font> <font color=Red>::</font> Oracle
<a name="line-64"></a><font color=Blue>dummy_oracle</font> <font color=Red>=</font> Oracle <font color=Cyan>{</font>
<a name="line-65"></a>  oracle_A <font color=Red>=</font> <font color=Red>\</font>d r i b x <font color=Red>-&gt;</font> named_gate <font color=Magenta>"Oracle A"</font> x<font color=Cyan>,</font>
<a name="line-66"></a>  oracle_b <font color=Red>=</font> <font color=Red>\</font>d1 d2 r x <font color=Red>-&gt;</font> named_gate <font color=Magenta>"Oracle b"</font> x<font color=Cyan>,</font>
<a name="line-67"></a>  oracle_r <font color=Red>=</font> <font color=Red>\</font>d1 d2 r x <font color=Red>-&gt;</font> named_gate <font color=Magenta>"Oracle r"</font> x
<a name="line-68"></a><font color=Cyan>}</font>
<a name="line-69"></a>
<a name="line-70"></a>
<a name="line-71"></a>
<a name="line-72"></a><a name="RunTimeParam"></a><font color=Blue><i>-- | A type to hold the runtime parameters.</i></font>
<a name="line-73"></a><a name="RunTimeParam"></a><font color=Green><u>data</u></font> RunTimeParam <font color=Red>=</font> RT_param <font color=Cyan>{</font>
<a name="line-74"></a>  k <font color=Red>::</font> Double<font color=Cyan>,</font>       <font color=Blue><i>-- ^ Wave number.</i></font>
<a name="line-75"></a>  theta <font color=Red>::</font> Double<font color=Cyan>,</font>   <font color=Blue><i>-- ^ Incident wave angle.</i></font>
<a name="line-76"></a>  phi <font color=Red>::</font> Double<font color=Cyan>,</font>     <font color=Blue><i>-- ^ Direction of desired far field radiation pattern.</i></font>
<a name="line-77"></a>  e0 <font color=Red>::</font> Double<font color=Cyan>,</font>      <font color=Blue><i>-- ^ Incident wave amplitude.</i></font>
<a name="line-78"></a>  lambda <font color=Red>::</font> Double<font color=Cyan>,</font>  <font color=Blue><i>-- ^ Wavelength.</i></font>
<a name="line-79"></a>  xlength <font color=Red>::</font> Double<font color=Cyan>,</font> <font color=Blue><i>-- ^ /x/-length of square scattering region.</i></font>
<a name="line-80"></a>  ylength <font color=Red>::</font> Double<font color=Cyan>,</font> <font color=Blue><i>-- ^ /y/-length of square scattering region.</i></font>
<a name="line-81"></a>
<a name="line-82"></a>  scatteringnodes <font color=Red>::</font> <font color=Red>[</font><font color=Cyan>(</font>Int<font color=Cyan>,</font>Int<font color=Cyan>)</font><font color=Red>]</font><font color=Cyan>,</font> <font color=Blue><i>-- ^ Metallic region.</i></font>
<a name="line-83"></a>  
<a name="line-84"></a>  nx <font color=Red>::</font> Int<font color=Cyan>,</font>
<a name="line-85"></a>  ny <font color=Red>::</font> Int<font color=Cyan>,</font>
<a name="line-86"></a>  lx <font color=Red>::</font> Double<font color=Cyan>,</font>
<a name="line-87"></a>  ly <font color=Red>::</font> Double<font color=Cyan>,</font>
<a name="line-88"></a>
<a name="line-89"></a>  kappa <font color=Red>::</font> Double<font color=Cyan>,</font>
<a name="line-90"></a>  epsilon <font color=Red>::</font> Double<font color=Cyan>,</font>
<a name="line-91"></a>  t0 <font color=Red>::</font> Double<font color=Cyan>,</font>
<a name="line-92"></a>  r <font color=Red>::</font> Double<font color=Cyan>,</font>
<a name="line-93"></a>  b_max <font color=Red>::</font> Double<font color=Cyan>,</font>
<a name="line-94"></a>  r_max <font color=Red>::</font> Double<font color=Cyan>,</font>
<a name="line-95"></a>  d  <font color=Red>::</font> Int<font color=Cyan>,</font>
<a name="line-96"></a>  nb <font color=Red>::</font> Int<font color=Cyan>,</font>
<a name="line-97"></a>  p2 <font color=Red>::</font> Double<font color=Cyan>,</font>
<a name="line-98"></a>  n0 <font color=Red>::</font> Int<font color=Cyan>,</font>
<a name="line-99"></a>  n1 <font color=Red>::</font> Int<font color=Cyan>,</font>
<a name="line-100"></a>  n2 <font color=Red>::</font> Int<font color=Cyan>,</font>
<a name="line-101"></a>  n4 <font color=Red>::</font> Int<font color=Cyan>,</font>
<a name="line-102"></a>
<a name="line-103"></a>  <font color=Blue><i>-- argflags for oracle_A</i></font>
<a name="line-104"></a>  magnitudeArgflag <font color=Red>::</font> Bool<font color=Cyan>,</font>
<a name="line-105"></a>  phaseArgflag <font color=Red>::</font> Bool
<a name="line-106"></a><font color=Cyan>}</font> <font color=Green><u>deriving</u></font> <font color=Cyan>(</font>Show<font color=Cyan>)</font>
<a name="line-107"></a>
<a name="line-108"></a>
<a name="line-109"></a><a name="dummy_RT_param"></a><font color=Blue><i>-- | A convenient set of runtime parameters for testing. </i></font>
<a name="line-110"></a><font color=Blue>dummy_RT_param</font> <font color=Red>::</font> RunTimeParam
<a name="line-111"></a><font color=Blue>dummy_RT_param</font> <font color=Red>=</font> RT_param <font color=Cyan>{</font>
<a name="line-112"></a>
<a name="line-113"></a>  k <font color=Red>=</font> <font color=Magenta>2.0</font><font color=Cyan>*</font>pi<font color=Cyan>*</font><font color=Magenta>1.0</font><font color=Cyan>,</font>
<a name="line-114"></a>  theta <font color=Red>=</font> <font color=Magenta>0.0</font><font color=Cyan>*</font>pi<font color=Cyan>/</font><font color=Magenta>4.0</font><font color=Cyan>,</font>
<a name="line-115"></a>  phi <font color=Red>=</font> <font color=Magenta>0.0</font><font color=Cyan>,</font>
<a name="line-116"></a>  e0 <font color=Red>=</font> <font color=Magenta>1.0</font><font color=Cyan>,</font>
<a name="line-117"></a>  lambda <font color=Red>=</font> <font color=Cyan>(</font>k dummy_RT_param<font color=Cyan>)</font><font color=Cyan>/</font><font color=Cyan>(</font><font color=Magenta>2.0</font><font color=Cyan>*</font>pi<font color=Cyan>)</font><font color=Cyan>,</font>
<a name="line-118"></a>  xlength <font color=Red>=</font> <font color=Magenta>2.0</font><font color=Cyan>*</font><font color=Cyan>(</font>lambda dummy_RT_param<font color=Cyan>)</font><font color=Cyan>,</font>
<a name="line-119"></a>  ylength <font color=Red>=</font> <font color=Magenta>2.0</font><font color=Cyan>*</font><font color=Cyan>(</font>lambda dummy_RT_param<font color=Cyan>)</font><font color=Cyan>,</font>
<a name="line-120"></a>  
<a name="line-121"></a>  scatteringnodes <font color=Red>=</font> 
<a name="line-122"></a>    <font color=Green><u>let</u></font> rt <font color=Red>=</font> dummy_RT_param <font color=Green><u>in</u></font>
<a name="line-123"></a>    <font color=Green><u>let</u></font> xul <font color=Red>=</font> round<font color=Cyan>(</font><font color=Cyan>(</font>fromIntegral <font color=Cyan>$</font> nx rt<font color=Cyan>)</font><font color=Cyan>/</font><font color=Magenta>2</font><font color=Cyan>)</font>
<a name="line-124"></a>              <font color=Blue><i>-</i></font> round<font color=Cyan>(</font><font color=Cyan>(</font>xlength rt<font color=Cyan>)</font><font color=Cyan>/</font><font color=Cyan>(</font><font color=Magenta>2.0</font><font color=Cyan>*</font><font color=Cyan>(</font>lx rt<font color=Cyan>)</font><font color=Cyan>)</font><font color=Cyan>)</font> <font color=Green><u>in</u></font> <font color=Blue><i>-- Upper left x index</i></font>
<a name="line-125"></a>    <font color=Green><u>let</u></font> yul <font color=Red>=</font> round<font color=Cyan>(</font><font color=Cyan>(</font>fromIntegral <font color=Cyan>$</font> ny rt<font color=Cyan>)</font><font color=Cyan>/</font><font color=Magenta>2</font><font color=Cyan>)</font>
<a name="line-126"></a>              <font color=Blue><i>-</i></font> round<font color=Cyan>(</font><font color=Cyan>(</font>ylength rt<font color=Cyan>)</font><font color=Cyan>/</font><font color=Cyan>(</font><font color=Magenta>2.0</font><font color=Cyan>*</font><font color=Cyan>(</font>ly rt<font color=Cyan>)</font><font color=Cyan>)</font><font color=Cyan>)</font> <font color=Green><u>in</u></font> <font color=Blue><i>-- Upper left y index</i></font>
<a name="line-127"></a>    <font color=Green><u>let</u></font> xlr <font color=Red>=</font> round<font color=Cyan>(</font><font color=Cyan>(</font>fromIntegral <font color=Cyan>$</font> nx rt<font color=Cyan>)</font><font color=Cyan>/</font><font color=Magenta>2</font><font color=Cyan>)</font>
<a name="line-128"></a>              <font color=Cyan>+</font> round<font color=Cyan>(</font><font color=Cyan>(</font>xlength rt<font color=Cyan>)</font><font color=Cyan>/</font><font color=Cyan>(</font><font color=Magenta>2.0</font><font color=Cyan>*</font><font color=Cyan>(</font>lx rt<font color=Cyan>)</font><font color=Cyan>)</font><font color=Cyan>)</font> <font color=Green><u>in</u></font>  <font color=Blue><i>-- Lower right x index</i></font>
<a name="line-129"></a>    <font color=Green><u>let</u></font> ylr <font color=Red>=</font> round<font color=Cyan>(</font><font color=Cyan>(</font>fromIntegral <font color=Cyan>$</font> ny rt<font color=Cyan>)</font><font color=Cyan>/</font><font color=Magenta>2</font><font color=Cyan>)</font>
<a name="line-130"></a>              <font color=Cyan>+</font> round<font color=Cyan>(</font><font color=Cyan>(</font>ylength rt<font color=Cyan>)</font><font color=Cyan>/</font><font color=Cyan>(</font><font color=Magenta>2.0</font><font color=Cyan>*</font><font color=Cyan>(</font>ly rt<font color=Cyan>)</font><font color=Cyan>)</font><font color=Cyan>)</font> <font color=Green><u>in</u></font> <font color=Blue><i>-- Lower right y in</i></font>
<a name="line-131"></a>      <font color=Red>[</font><font color=Cyan>(</font>xul<font color=Cyan>,</font> yul<font color=Cyan>)</font><font color=Cyan>,</font> <font color=Cyan>(</font>xlr<font color=Cyan>,</font> ylr<font color=Cyan>)</font><font color=Red>]</font><font color=Cyan>,</font>
<a name="line-132"></a>
<a name="line-133"></a>  nx <font color=Red>=</font> <font color=Magenta>12885</font><font color=Cyan>,</font>
<a name="line-134"></a>  ny <font color=Red>=</font> <font color=Magenta>12885</font><font color=Cyan>,</font>
<a name="line-135"></a>  lx <font color=Red>=</font> <font color=Magenta>0.1</font><font color=Cyan>,</font>
<a name="line-136"></a>  ly <font color=Red>=</font> <font color=Magenta>0.1</font><font color=Cyan>,</font>
<a name="line-137"></a>
<a name="line-138"></a>  kappa <font color=Red>=</font> <font color=Magenta>1.0</font><font color=Cyan>,</font>
<a name="line-139"></a>  epsilon <font color=Red>=</font> <font color=Magenta>1.0</font><font color=Cyan>,</font>
<a name="line-140"></a>  t0 <font color=Red>=</font> <font color=Magenta>1.0</font><font color=Cyan>,</font>
<a name="line-141"></a>  r <font color=Red>=</font> <font color=Magenta>1.0</font><font color=Cyan>,</font>
<a name="line-142"></a>  b_max <font color=Red>=</font> <font color=Magenta>1.0</font><font color=Cyan>,</font>
<a name="line-143"></a>  r_max <font color=Red>=</font> <font color=Magenta>1.0</font><font color=Cyan>,</font>
<a name="line-144"></a>  d  <font color=Red>=</font> <font color=Magenta>3</font><font color=Cyan>,</font>
<a name="line-145"></a>  nb <font color=Red>=</font> <font color=Magenta>2</font><font color=Cyan>,</font>
<a name="line-146"></a>  p2 <font color=Red>=</font> <font color=Magenta>3</font><font color=Cyan>,</font>
<a name="line-147"></a>  n0 <font color=Red>=</font> <font color=Magenta>3</font><font color=Cyan>,</font> 
<a name="line-148"></a>  n1 <font color=Red>=</font> <font color=Magenta>3</font><font color=Cyan>,</font>
<a name="line-149"></a>  n2 <font color=Red>=</font> <font color=Magenta>3</font><font color=Cyan>,</font>
<a name="line-150"></a>  n4 <font color=Red>=</font> <font color=Magenta>3</font><font color=Cyan>,</font> 
<a name="line-151"></a>
<a name="line-152"></a>  <font color=Blue><i>-- argflags for oracle_A</i></font>
<a name="line-153"></a>  magnitudeArgflag <font color=Red>=</font> False<font color=Cyan>,</font>
<a name="line-154"></a>  phaseArgflag <font color=Red>=</font> True
<a name="line-155"></a><font color=Cyan>}</font>
<a name="line-156"></a>
<a name="line-157"></a>
<a name="line-158"></a><a name="large_RT_param"></a><font color=Blue><i>-- | A set of larger values, for testing scalability.</i></font>
<a name="line-159"></a><font color=Blue>large_RT_param</font> <font color=Red>::</font> RunTimeParam
<a name="line-160"></a><font color=Blue>large_RT_param</font> <font color=Red>=</font> RT_param <font color=Cyan>{</font>
<a name="line-161"></a>
<a name="line-162"></a>  k <font color=Red>=</font> <font color=Magenta>2.0</font><font color=Cyan>*</font>pi<font color=Cyan>*</font><font color=Magenta>1.0</font><font color=Cyan>,</font>
<a name="line-163"></a>  theta <font color=Red>=</font> <font color=Magenta>0.0</font><font color=Cyan>*</font>pi<font color=Cyan>/</font><font color=Magenta>4.0</font><font color=Cyan>,</font>
<a name="line-164"></a>  phi <font color=Red>=</font> <font color=Magenta>0.0</font><font color=Cyan>,</font>
<a name="line-165"></a>  e0 <font color=Red>=</font> <font color=Magenta>1.0</font><font color=Cyan>,</font>
<a name="line-166"></a>  lambda <font color=Red>=</font> <font color=Cyan>(</font>k large_RT_param<font color=Cyan>)</font><font color=Cyan>/</font><font color=Cyan>(</font><font color=Magenta>2.0</font><font color=Cyan>*</font>pi<font color=Cyan>)</font><font color=Cyan>,</font>
<a name="line-167"></a>  xlength <font color=Red>=</font> <font color=Magenta>2.0</font><font color=Cyan>*</font><font color=Cyan>(</font>lambda large_RT_param<font color=Cyan>)</font><font color=Cyan>,</font>
<a name="line-168"></a>  ylength <font color=Red>=</font> <font color=Magenta>2.0</font><font color=Cyan>*</font><font color=Cyan>(</font>lambda large_RT_param<font color=Cyan>)</font><font color=Cyan>,</font>
<a name="line-169"></a>  
<a name="line-170"></a>  scatteringnodes <font color=Red>=</font> 
<a name="line-171"></a>    <font color=Green><u>let</u></font> rt <font color=Red>=</font> large_RT_param <font color=Green><u>in</u></font>
<a name="line-172"></a>    <font color=Green><u>let</u></font> xul <font color=Red>=</font> round<font color=Cyan>(</font><font color=Cyan>(</font>fromIntegral <font color=Cyan>$</font> nx rt<font color=Cyan>)</font><font color=Cyan>/</font><font color=Magenta>2</font><font color=Cyan>)</font>
<a name="line-173"></a>              <font color=Blue><i>-</i></font> round<font color=Cyan>(</font><font color=Cyan>(</font>xlength rt<font color=Cyan>)</font><font color=Cyan>/</font><font color=Cyan>(</font><font color=Magenta>2.0</font><font color=Cyan>*</font><font color=Cyan>(</font>lx rt<font color=Cyan>)</font><font color=Cyan>)</font><font color=Cyan>)</font> <font color=Green><u>in</u></font> <font color=Blue><i>-- Upper left x index</i></font>
<a name="line-174"></a>    <font color=Green><u>let</u></font> yul <font color=Red>=</font> round<font color=Cyan>(</font><font color=Cyan>(</font>fromIntegral <font color=Cyan>$</font> ny rt<font color=Cyan>)</font><font color=Cyan>/</font><font color=Magenta>2</font><font color=Cyan>)</font>
<a name="line-175"></a>              <font color=Blue><i>-</i></font> round<font color=Cyan>(</font><font color=Cyan>(</font>ylength rt<font color=Cyan>)</font><font color=Cyan>/</font><font color=Cyan>(</font><font color=Magenta>2.0</font><font color=Cyan>*</font><font color=Cyan>(</font>ly rt<font color=Cyan>)</font><font color=Cyan>)</font><font color=Cyan>)</font> <font color=Green><u>in</u></font> <font color=Blue><i>-- Upper left y index</i></font>
<a name="line-176"></a>    <font color=Green><u>let</u></font> xlr <font color=Red>=</font> round<font color=Cyan>(</font><font color=Cyan>(</font>fromIntegral <font color=Cyan>$</font> nx rt<font color=Cyan>)</font><font color=Cyan>/</font><font color=Magenta>2</font><font color=Cyan>)</font>
<a name="line-177"></a>              <font color=Cyan>+</font> round<font color=Cyan>(</font><font color=Cyan>(</font>xlength rt<font color=Cyan>)</font><font color=Cyan>/</font><font color=Cyan>(</font><font color=Magenta>2.0</font><font color=Cyan>*</font><font color=Cyan>(</font>lx rt<font color=Cyan>)</font><font color=Cyan>)</font><font color=Cyan>)</font> <font color=Green><u>in</u></font>  <font color=Blue><i>-- Lower right x index</i></font>
<a name="line-178"></a>    <font color=Green><u>let</u></font> ylr <font color=Red>=</font> round<font color=Cyan>(</font><font color=Cyan>(</font>fromIntegral <font color=Cyan>$</font> ny rt<font color=Cyan>)</font><font color=Cyan>/</font><font color=Magenta>2</font><font color=Cyan>)</font>
<a name="line-179"></a>              <font color=Cyan>+</font> round<font color=Cyan>(</font><font color=Cyan>(</font>ylength rt<font color=Cyan>)</font><font color=Cyan>/</font><font color=Cyan>(</font><font color=Magenta>2.0</font><font color=Cyan>*</font><font color=Cyan>(</font>ly rt<font color=Cyan>)</font><font color=Cyan>)</font><font color=Cyan>)</font> <font color=Green><u>in</u></font> <font color=Blue><i>-- Lower right y in</i></font>
<a name="line-180"></a>      <font color=Red>[</font><font color=Cyan>(</font>xul<font color=Cyan>,</font> yul<font color=Cyan>)</font><font color=Cyan>,</font> <font color=Cyan>(</font>xlr<font color=Cyan>,</font> ylr<font color=Cyan>)</font><font color=Red>]</font><font color=Cyan>,</font>
<a name="line-181"></a>
<a name="line-182"></a>  nx <font color=Red>=</font> <font color=Magenta>12885</font><font color=Cyan>,</font>
<a name="line-183"></a>  ny <font color=Red>=</font> <font color=Magenta>12885</font><font color=Cyan>,</font>
<a name="line-184"></a>  lx <font color=Red>=</font> <font color=Magenta>0.1</font><font color=Cyan>,</font>
<a name="line-185"></a>  ly <font color=Red>=</font> <font color=Magenta>0.1</font><font color=Cyan>,</font>
<a name="line-186"></a>
<a name="line-187"></a>  kappa <font color=Red>=</font> <font color=Magenta>1e4</font><font color=Cyan>,</font>
<a name="line-188"></a>  epsilon <font color=Red>=</font> <font color=Magenta>0.01</font><font color=Cyan>,</font>
<a name="line-189"></a>  t0 <font color=Red>=</font> <font color=Magenta>7.0e6</font><font color=Cyan>,</font>
<a name="line-190"></a>  r <font color=Red>=</font> <font color=Magenta>2.5e12</font><font color=Cyan>,</font>
<a name="line-191"></a>  b_max <font color=Red>=</font> <font color=Magenta>5.0</font><font color=Cyan>,</font>
<a name="line-192"></a>  r_max <font color=Red>=</font> <font color=Magenta>1.01</font><font color=Cyan>,</font>
<a name="line-193"></a>  d  <font color=Red>=</font> <font color=Magenta>7</font><font color=Cyan>,</font>
<a name="line-194"></a>  nb <font color=Red>=</font> <font color=Magenta>9</font><font color=Cyan>,</font>
<a name="line-195"></a>  p2 <font color=Red>=</font> <font color=Cyan>(</font>  <font color=Magenta>1.0</font> <font color=Cyan>/</font> <font color=Cyan>(</font><font color=Magenta>4</font><font color=Blue><i>-</i></font><font color=Cyan>(</font><font color=Magenta>4</font><font color=Cyan>**</font><font color=Cyan>(</font><font color=Magenta>1</font><font color=Cyan>/</font><font color=Magenta>3</font><font color=Cyan>)</font><font color=Cyan>)</font><font color=Cyan>)</font>  <font color=Cyan>)</font><font color=Cyan>,</font>
<a name="line-196"></a>  n0 <font color=Red>=</font> <font color=Magenta>14</font><font color=Cyan>,</font>
<a name="line-197"></a>  n1 <font color=Red>=</font> <font color=Magenta>24</font><font color=Cyan>,</font>
<a name="line-198"></a>  n2 <font color=Red>=</font> <font color=Magenta>30</font><font color=Cyan>,</font>
<a name="line-199"></a>  n4 <font color=Red>=</font> <font color=Magenta>65</font><font color=Cyan>,</font> 
<a name="line-200"></a>
<a name="line-201"></a>  <font color=Blue><i>-- argflags for oracle_A</i></font>
<a name="line-202"></a>  magnitudeArgflag <font color=Red>=</font> False<font color=Cyan>,</font>
<a name="line-203"></a>  phaseArgflag <font color=Red>=</font> True
<a name="line-204"></a><font color=Cyan>}</font>
<a name="line-205"></a>
<a name="line-206"></a>
<a name="line-207"></a><a name="small_RT_param"></a><font color=Blue><i>-- | A set of smaller values, for manageable yet meaningful output.</i></font>
<a name="line-208"></a><font color=Blue>small_RT_param</font> <font color=Red>::</font> RunTimeParam
<a name="line-209"></a><font color=Blue>small_RT_param</font> <font color=Red>=</font> RT_param <font color=Cyan>{</font>
<a name="line-210"></a>
<a name="line-211"></a>  k <font color=Red>=</font> <font color=Magenta>2.0</font><font color=Cyan>*</font>pi<font color=Cyan>*</font><font color=Magenta>1.0</font><font color=Cyan>,</font>
<a name="line-212"></a>  theta <font color=Red>=</font> <font color=Magenta>0.0</font><font color=Cyan>*</font>pi<font color=Cyan>/</font><font color=Magenta>4.0</font><font color=Cyan>,</font>
<a name="line-213"></a>  phi <font color=Red>=</font> <font color=Magenta>0.0</font><font color=Cyan>,</font>
<a name="line-214"></a>  e0 <font color=Red>=</font> <font color=Magenta>1.0</font><font color=Cyan>,</font>
<a name="line-215"></a>  lambda <font color=Red>=</font> <font color=Cyan>(</font>k small_RT_param<font color=Cyan>)</font><font color=Cyan>/</font><font color=Cyan>(</font><font color=Magenta>2.0</font><font color=Cyan>*</font>pi<font color=Cyan>)</font><font color=Cyan>,</font>
<a name="line-216"></a>  xlength <font color=Red>=</font> <font color=Magenta>2.0</font><font color=Cyan>*</font><font color=Cyan>(</font>lambda small_RT_param<font color=Cyan>)</font><font color=Cyan>,</font>
<a name="line-217"></a>  ylength <font color=Red>=</font> <font color=Magenta>2.0</font><font color=Cyan>*</font><font color=Cyan>(</font>lambda small_RT_param<font color=Cyan>)</font><font color=Cyan>,</font>
<a name="line-218"></a>  
<a name="line-219"></a>  scatteringnodes <font color=Red>=</font> 
<a name="line-220"></a>    <font color=Green><u>let</u></font> xul <font color=Red>=</font> <font color=Magenta>2</font> <font color=Green><u>in</u></font>
<a name="line-221"></a>    <font color=Green><u>let</u></font> yul <font color=Red>=</font> <font color=Magenta>2</font> <font color=Green><u>in</u></font>
<a name="line-222"></a>    <font color=Green><u>let</u></font> xlr <font color=Red>=</font> <font color=Magenta>3</font> <font color=Green><u>in</u></font>
<a name="line-223"></a>    <font color=Green><u>let</u></font> ylr <font color=Red>=</font> <font color=Magenta>3</font> <font color=Green><u>in</u></font>
<a name="line-224"></a>      <font color=Red>[</font><font color=Cyan>(</font>xul<font color=Cyan>,</font> yul<font color=Cyan>)</font><font color=Cyan>,</font> <font color=Cyan>(</font>xlr<font color=Cyan>,</font> ylr<font color=Cyan>)</font><font color=Red>]</font><font color=Cyan>,</font>
<a name="line-225"></a>
<a name="line-226"></a>  nx <font color=Red>=</font> <font color=Magenta>4</font><font color=Cyan>,</font>
<a name="line-227"></a>  ny <font color=Red>=</font> <font color=Magenta>4</font><font color=Cyan>,</font>
<a name="line-228"></a>  lx <font color=Red>=</font> <font color=Magenta>0.1</font><font color=Cyan>,</font>
<a name="line-229"></a>  ly <font color=Red>=</font> <font color=Magenta>0.1</font><font color=Cyan>,</font>
<a name="line-230"></a>
<a name="line-231"></a>  kappa <font color=Red>=</font> <font color=Magenta>1e4</font><font color=Cyan>,</font>
<a name="line-232"></a>  epsilon <font color=Red>=</font> <font color=Magenta>0.01</font><font color=Cyan>,</font>
<a name="line-233"></a>  t0 <font color=Red>=</font> <font color=Magenta>7.0e6</font><font color=Cyan>,</font>
<a name="line-234"></a>  r <font color=Red>=</font> <font color=Magenta>2.5e12</font><font color=Cyan>,</font>
<a name="line-235"></a>  b_max <font color=Red>=</font> <font color=Magenta>5.0</font><font color=Cyan>,</font>
<a name="line-236"></a>  r_max <font color=Red>=</font> <font color=Magenta>1.01</font><font color=Cyan>,</font>
<a name="line-237"></a>  d  <font color=Red>=</font> <font color=Magenta>7</font><font color=Cyan>,</font>
<a name="line-238"></a>  nb <font color=Red>=</font> <font color=Magenta>9</font><font color=Cyan>,</font>
<a name="line-239"></a>  p2 <font color=Red>=</font> <font color=Cyan>(</font>  <font color=Magenta>1.0</font> <font color=Cyan>/</font> <font color=Cyan>(</font><font color=Magenta>4</font><font color=Blue><i>-</i></font><font color=Cyan>(</font><font color=Magenta>4</font><font color=Cyan>**</font><font color=Cyan>(</font><font color=Magenta>1</font><font color=Cyan>/</font><font color=Magenta>3</font><font color=Cyan>)</font><font color=Cyan>)</font><font color=Cyan>)</font>  <font color=Cyan>)</font><font color=Cyan>,</font>
<a name="line-240"></a>  n0 <font color=Red>=</font> <font color=Magenta>14</font><font color=Cyan>,</font>
<a name="line-241"></a>  n1 <font color=Red>=</font> <font color=Magenta>24</font><font color=Cyan>,</font>
<a name="line-242"></a>  n2 <font color=Red>=</font> <font color=Magenta>6</font><font color=Cyan>,</font>
<a name="line-243"></a>  n4 <font color=Red>=</font> <font color=Magenta>65</font><font color=Cyan>,</font> 
<a name="line-244"></a>
<a name="line-245"></a>  <font color=Blue><i>-- argflags for oracle_A</i></font>
<a name="line-246"></a>  magnitudeArgflag <font color=Red>=</font> False<font color=Cyan>,</font>
<a name="line-247"></a>  phaseArgflag <font color=Red>=</font> True
<a name="line-248"></a><font color=Cyan>}</font>
<a name="line-249"></a>
<a name="line-250"></a>
<a name="line-251"></a>
<a name="line-252"></a><a name="expYt"></a><font color=Blue><i>-- | Apply an [exp &#8722;/iYt/] gate. The timestep /t/ is a parameter.</i></font>
<a name="line-253"></a><font color=Blue>expYt</font> <font color=Red>::</font> Timestep <font color=Red>-&gt;</font> Qubit <font color=Red>-&gt;</font> Circ Qubit
<a name="line-254"></a><font color=Blue>expYt</font> <font color=Red>=</font> named_rotation <font color=Magenta>"exp(-i%Y)"</font>
<a name="line-255"></a>
<a name="line-256"></a>
<a name="line-257"></a><a name="expYt_at"></a><font color=Blue><i>-- | Apply an [exp &#8722;/iYt/] gate. The timestep /t/ is a parameter.</i></font>
<a name="line-258"></a><font color=Blue>expYt_at</font> <font color=Red>::</font> Timestep <font color=Red>-&gt;</font> Qubit <font color=Red>-&gt;</font> Circ ()
<a name="line-259"></a><font color=Blue>expYt_at</font> <font color=Red>=</font> named_rotation_at <font color=Magenta>"exp(-i%Y)"</font>
<a name="line-260"></a>
<a name="line-261"></a>
<a name="line-262"></a><a name="dynamic_lift_double"></a><font color=Blue><i>-- | Read a list of bits and make it into a 'Double', by multiplying</i></font>
<a name="line-263"></a><font color=Blue><i>-- its integer value by the provided factor.</i></font>
<a name="line-264"></a><font color=Blue>dynamic_lift_double</font> <font color=Red>::</font> Double <font color=Red>-&gt;</font> <font color=Red>[</font>Bit<font color=Red>]</font> <font color=Red>-&gt;</font> Circ Double
<a name="line-265"></a><font color=Blue>dynamic_lift_double</font> factor cl <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-266"></a>      cdiscard cl
<a name="line-267"></a>
<a name="line-268"></a><font color=Blue><i>-- Implementation note: removed dynamic_lift as for now it breaks all</i></font>
<a name="line-269"></a><font color=Blue><i>-- output formats except ASCII.</i></font>
<a name="line-270"></a>
<a name="line-271"></a><font color=Blue><i>--      bl &lt;- dynamic_lift cl</i></font>
<a name="line-272"></a>      <font color=Green><u>let</u></font> sign <font color=Red>=</font> <font color=Magenta>1</font> <font color=Blue><i>-- if (head $ reverse bl) then 1 else -1</i></font>
<a name="line-273"></a>      <font color=Green><u>let</u></font> unsigned_value <font color=Red>=</font> <font color=Magenta>1</font> <font color=Blue><i>-- integer_of_intm_unsigned $ </i></font>
<a name="line-274"></a>                              <font color=Blue><i>-- intm_of_boollist_bh (tail $ reverse bl)</i></font>
<a name="line-275"></a>      return <font color=Cyan>(</font>sign <font color=Cyan>*</font> factor <font color=Cyan>*</font> <font color=Cyan>(</font>fromIntegral unsigned_value<font color=Cyan>)</font><font color=Cyan>)</font>
<a name="line-276"></a>
<a name="line-277"></a>
<a name="line-278"></a><a name="qft_for_show"></a><font color=Blue><i>-- | A black box gate to stand in as a replacement for QFT.</i></font>
<a name="line-279"></a><font color=Blue>qft_for_show</font> <font color=Red>::</font> <font color=Red>[</font>Qubit<font color=Red>]</font> <font color=Red>-&gt;</font> Circ <font color=Red>[</font>Qubit<font color=Red>]</font>
<a name="line-280"></a><font color=Blue>qft_for_show</font> qs <font color=Red>=</font> named_gate <font color=Magenta>"QFT"</font> qs
<a name="line-281"></a>
<a name="line-282"></a>
<a name="line-283"></a>
<a name="line-284"></a><a name="qlsa_FEM_main"></a><font color=Blue><i>-- | Main function: for estimating the radar cross section for a FEM</i></font>
<a name="line-285"></a><font color=Blue><i>-- scattering problem. The problem can be reduced to the calculation</i></font>
<a name="line-286"></a><font color=Blue><i>-- of four angles: &#966;[sub /b/], &#966;[sub /bx/], &#966;[sub /r/1] and &#966;[sub /r/0].</i></font>
<a name="line-287"></a><font color=Blue>qlsa_FEM_main</font> <font color=Red>::</font> RunTimeParam <font color=Red>-&gt;</font> Oracle <font color=Red>-&gt;</font> Circ Double
<a name="line-288"></a><font color=Blue>qlsa_FEM_main</font> param oracle <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-289"></a>     comment <font color=Magenta>"FEM_main"</font>
<a name="line-290"></a>     phi_b  <font color=Red>&lt;-</font> qlsa_AmpEst_phi_b param oracle
<a name="line-291"></a>     phi_bx <font color=Red>&lt;-</font> qlsa_AmpEst_phi_bx param oracle
<a name="line-292"></a>     phi_r1 <font color=Red>&lt;-</font> qlsa_AmpEst_phi_bxr param oracle True
<a name="line-293"></a>     phi_r0 <font color=Red>&lt;-</font> qlsa_AmpEst_phi_bxr param oracle False
<a name="line-294"></a>     <font color=Green><u>let</u></font> sigma <font color=Red>=</font> <font color=Cyan>(</font><font color=Cyan>(</font><font color=Cyan>(</font><font color=Cyan>(</font>fromIntegral <font color=Cyan>$</font> nb param<font color=Cyan>)</font> <font color=Cyan>^</font> <font color=Magenta>2</font><font color=Cyan>)</font> <font color=Cyan>*</font> <font color=Cyan>(</font><font color=Cyan>(</font>b_max param<font color=Cyan>)</font> <font color=Cyan>^</font> <font color=Magenta>2</font><font color=Cyan>)</font> <font color=Cyan>*</font> <font color=Cyan>(</font><font color=Cyan>(</font>r_max param<font color=Cyan>)</font> <font color=Cyan>^</font> <font color=Magenta>2</font><font color=Cyan>)</font> <font color=Cyan>*</font> <font color=Cyan>(</font><font color=Cyan>(</font>sin phi_b<font color=Cyan>)</font> <font color=Cyan>^</font> <font color=Magenta>2</font><font color=Cyan>)</font><font color=Cyan>)</font> <font color=Cyan>/</font> <font color=Cyan>(</font> <font color=Magenta>4</font> <font color=Cyan>*</font> pi<font color=Cyan>)</font><font color=Cyan>)</font>
<a name="line-295"></a>     comment <font color=Magenta>"FEM_main"</font>
<a name="line-296"></a>     return sigma
<a name="line-297"></a>
<a name="line-298"></a>
<a name="line-299"></a>
<a name="line-300"></a>
<a name="line-301"></a><font color=Blue><i>-- * Amplitude Estimation Functions</i></font>
<a name="line-302"></a>
<a name="line-303"></a><a name="qlsa_AmpEst_phi_b"></a><font color=Blue><i>-- | Estimates &#966;[sub /b/], related to the probability of success for the</i></font>
<a name="line-304"></a><font color=Blue><i>-- preparation of the known state /b/, using amplitude amplification.</i></font>
<a name="line-305"></a><font color=Blue>qlsa_AmpEst_phi_b</font> <font color=Red>::</font> RunTimeParam <font color=Red>-&gt;</font> Oracle <font color=Red>-&gt;</font> Circ Double
<a name="line-306"></a><font color=Blue>qlsa_AmpEst_phi_b</font> param oracle <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-307"></a>    g <font color=Red>&lt;-</font> qinit <font color=Cyan>$</font> replicate <font color=Cyan>(</font>n0 param<font color=Cyan>)</font> False
<a name="line-308"></a>    with_ancilla_init <font color=Cyan>(</font>replicate <font color=Cyan>(</font>n2 param<font color=Cyan>)</font> False<font color=Cyan>)</font> <font color=Cyan>$</font> <font color=Red>\</font>x <font color=Red>-&gt;</font> <font color=Green><u>do</u></font>
<a name="line-309"></a>       label <font color=Cyan>(</font>g<font color=Cyan>,</font>x<font color=Cyan>)</font> <font color=Cyan>(</font><font color=Magenta>"g"</font><font color=Cyan>,</font><font color=Magenta>"x"</font><font color=Cyan>)</font>
<a name="line-310"></a>       with_ancilla <font color=Cyan>$</font> <font color=Red>\</font>a <font color=Red>-&gt;</font> <font color=Green><u>do</u></font>
<a name="line-311"></a>           label <font color=Cyan>(</font>a<font color=Cyan>)</font> <font color=Cyan>(</font><font color=Magenta>"anc. a"</font><font color=Cyan>)</font>
<a name="line-312"></a>           with_ancilla <font color=Cyan>$</font> <font color=Red>\</font>b <font color=Red>-&gt;</font> <font color=Green><u>do</u></font>
<a name="line-313"></a>               label <font color=Cyan>(</font>b<font color=Cyan>)</font> <font color=Cyan>(</font><font color=Magenta>"anc. b"</font><font color=Cyan>)</font>
<a name="line-314"></a>               g <font color=Red>&lt;-</font> map_hadamard g  
<a name="line-315"></a>               u_b <font color=Cyan>(</font>x<font color=Cyan>,</font>b<font color=Cyan>)</font>  
<a name="line-316"></a>               loop g u_g <font color=Cyan>(</font>x<font color=Cyan>,</font>b<font color=Cyan>,</font>a<font color=Cyan>)</font>
<a name="line-317"></a>               return ()
<a name="line-318"></a>           return ()
<a name="line-319"></a>    g' <font color=Red>&lt;-</font> qft_big_endian g <font color=Blue><i>-- QFT : Is it really big-endian?</i></font>
<a name="line-320"></a>    value_bits  <font color=Red>&lt;-</font> measure g'
<a name="line-321"></a>    value_double <font color=Red>&lt;-</font> dynamic_lift_double <font color=Magenta>1.0</font> value_bits
<a name="line-322"></a>    return <font color=Cyan>(</font>pi <font color=Cyan>*</font> value_double <font color=Cyan>/</font> <font color=Cyan>(</font><font color=Magenta>2</font> <font color=Cyan>**</font> <font color=Cyan>(</font>fromIntegral <font color=Cyan>$</font> n0 param<font color=Cyan>)</font><font color=Cyan>)</font><font color=Cyan>)</font>    
<a name="line-323"></a>    <font color=Green><u>where</u></font>
<a name="line-324"></a>        loop <font color=Red>::</font> <font color=Red>[</font>Qubit<font color=Red>]</font> <font color=Red>-&gt;</font> <font color=Cyan>(</font>a <font color=Red>-&gt;</font> Circ ()<font color=Cyan>)</font> <font color=Red>-&gt;</font> a <font color=Red>-&gt;</font> Circ ()
<a name="line-325"></a>        loop [] f x <font color=Red>=</font> return ()
<a name="line-326"></a>        loop <font color=Cyan>(</font>h<font color=Red><b>:</b></font>t<font color=Cyan>)</font> f x <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-327"></a>            f x <font color=Cyan>`controlled`</font> h
<a name="line-328"></a>            loop t f' x<font color=Cyan>;</font>
<a name="line-329"></a>            <font color=Green><u>where</u></font>
<a name="line-330"></a>               f' x <font color=Red>=</font> <font color=Green><u>do</u></font> f x<font color=Cyan>;</font> f x 
<a name="line-331"></a>
<a name="line-332"></a>        u_b <font color=Red>::</font> <font color=Cyan>(</font><font color=Red>[</font>Qubit<font color=Red>]</font><font color=Cyan>,</font>Qubit<font color=Cyan>)</font> <font color=Red>-&gt;</font> Circ ()
<a name="line-333"></a>        u_b xb <font color=Red>=</font> qlsa_StatePrep param xb <font color=Cyan>(</font>oracle_b oracle param<font color=Cyan>)</font> <font color=Cyan>(</font><font color=Magenta>1.0</font><font color=Cyan>/</font><font color=Cyan>(</font>b_max param<font color=Cyan>)</font><font color=Cyan>)</font>
<a name="line-334"></a>
<a name="line-335"></a>
<a name="line-336"></a>        u_g <font color=Red>::</font> <font color=Cyan>(</font><font color=Red>[</font>Qubit<font color=Red>]</font><font color=Cyan>,</font>Qubit<font color=Cyan>,</font>Qubit<font color=Cyan>)</font> <font color=Red>-&gt;</font> Circ ()
<a name="line-337"></a>        u_g <font color=Cyan>(</font>x<font color=Cyan>,</font>b<font color=Cyan>,</font>a<font color=Cyan>)</font> <font color=Red>=</font> <font color=Green><u>do</u></font> 
<a name="line-338"></a>            comment <font color=Magenta>"U_g starts"</font>
<a name="line-339"></a>            gate_Z_at b
<a name="line-340"></a>            <font color=Blue><i>-- For unitrary linear transformation, adjoint == inverse, hence reverse_...</i></font>
<a name="line-341"></a>            <font color=Cyan>(</font>reverse_generic_imp u_b<font color=Cyan>)</font> <font color=Cyan>(</font>x<font color=Cyan>,</font>b<font color=Cyan>)</font> 
<a name="line-342"></a>            qnot_at a <font color=Cyan>`controlled`</font> x <font color=Cyan>.==.</font> <font color=Cyan>(</font>map <font color=Cyan>(</font><font color=Red>\</font>x <font color=Red>-&gt;</font> False<font color=Cyan>)</font> x<font color=Cyan>)</font>
<a name="line-343"></a>            gate_X_at a
<a name="line-344"></a>            gate_Z_at a
<a name="line-345"></a>            gate_X_at a
<a name="line-346"></a>            qnot_at a <font color=Cyan>`controlled`</font> x <font color=Cyan>.==.</font> <font color=Cyan>(</font>map <font color=Cyan>(</font><font color=Red>\</font>x <font color=Red>-&gt;</font> False<font color=Cyan>)</font> x<font color=Cyan>)</font>
<a name="line-347"></a>            u_b <font color=Cyan>(</font>x<font color=Cyan>,</font>b<font color=Cyan>)</font>
<a name="line-348"></a>            comment <font color=Magenta>"U_g ends"</font>
<a name="line-349"></a>            return ()
<a name="line-350"></a>
<a name="line-351"></a>        
<a name="line-352"></a>            
<a name="line-353"></a><a name="test_qlsa_AmpEst_phi_b"></a><font color=Blue><i>-- | Testing function for 'qlsa_AmpEst_phi_b'.</i></font>
<a name="line-354"></a><font color=Blue>test_qlsa_AmpEst_phi_b</font> <font color=Red>::</font> Bool <font color=Red>-&gt;</font> IO ()
<a name="line-355"></a><font color=Blue>test_qlsa_AmpEst_phi_b</font> dummyRTParamFlag <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-356"></a>    <font color=Green><u>let</u></font> param <font color=Red>=</font> <font color=Green><u>if</u></font> dummyRTParamFlag <font color=Green><u>then</u></font> dummy_RT_param <font color=Green><u>else</u></font> large_RT_param 
<a name="line-357"></a>    print_simple GateCount <font color=Cyan>(</font>qlsa_AmpEst_phi_b param dummy_oracle<font color=Cyan>)</font>
<a name="line-358"></a>    print_simple Preview <font color=Cyan>(</font>qlsa_AmpEst_phi_b param dummy_oracle<font color=Cyan>)</font>
<a name="line-359"></a>
<a name="line-360"></a>
<a name="line-361"></a><a name="qlsa_AmpEst_phi_bx"></a><font color=Blue><i>-- | Estimates &#966;[sub /bx/], related to the probability of success in</i></font>
<a name="line-362"></a><font color=Blue><i>-- computing solution value /x/.</i></font>
<a name="line-363"></a><font color=Blue>qlsa_AmpEst_phi_bx</font> <font color=Red>::</font> RunTimeParam <font color=Red>-&gt;</font> Oracle <font color=Red>-&gt;</font> Circ Double
<a name="line-364"></a><font color=Blue>qlsa_AmpEst_phi_bx</font> param oracle  <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-365"></a>    g <font color=Red>&lt;-</font> qinit <font color=Cyan>(</font>take <font color=Cyan>(</font>n0 param<font color=Cyan>)</font> <font color=Cyan>(</font>repeat False<font color=Cyan>)</font><font color=Cyan>)</font>
<a name="line-366"></a>    with_ancilla_init <font color=Cyan>(</font>take <font color=Cyan>(</font>n2 param<font color=Cyan>)</font> <font color=Cyan>(</font>repeat False<font color=Cyan>)</font><font color=Cyan>)</font> <font color=Cyan>$</font> <font color=Red>\</font>x <font color=Red>-&gt;</font> <font color=Green><u>do</u></font>
<a name="line-367"></a>      with_ancilla <font color=Cyan>$</font> <font color=Red>\</font>a <font color=Red>-&gt;</font> <font color=Green><u>do</u></font> 
<a name="line-368"></a>          with_ancilla <font color=Cyan>$</font> <font color=Red>\</font>b <font color=Red>-&gt;</font> <font color=Green><u>do</u></font>
<a name="line-369"></a>              with_ancilla <font color=Cyan>$</font> <font color=Red>\</font>s <font color=Red>-&gt;</font> <font color=Green><u>do</u></font>
<a name="line-370"></a>                  g <font color=Red>&lt;-</font> map_hadamard g    
<a name="line-371"></a>                  u_bx <font color=Cyan>(</font>x<font color=Cyan>,</font>b<font color=Cyan>,</font>s<font color=Cyan>)</font>
<a name="line-372"></a>                  loop g u_g <font color=Cyan>(</font>x<font color=Cyan>,</font>b<font color=Cyan>,</font>s<font color=Cyan>,</font>a<font color=Cyan>)</font>
<a name="line-373"></a>                  return ()
<a name="line-374"></a>              return () 
<a name="line-375"></a>          return ()
<a name="line-376"></a>    g' <font color=Red>&lt;-</font> qft_big_endian g <font color=Blue><i>-- QFT : Is it really big-endian?</i></font>
<a name="line-377"></a>    value_bits  <font color=Red>&lt;-</font> measure g'
<a name="line-378"></a>    value_double <font color=Red>&lt;-</font> dynamic_lift_double <font color=Magenta>1.0</font> value_bits
<a name="line-379"></a>    return <font color=Cyan>(</font>pi <font color=Cyan>*</font> value_double <font color=Cyan>/</font> <font color=Cyan>(</font><font color=Magenta>2</font> <font color=Cyan>**</font> <font color=Cyan>(</font>fromIntegral <font color=Cyan>$</font> n0 param<font color=Cyan>)</font><font color=Cyan>)</font><font color=Cyan>)</font>
<a name="line-380"></a>    <font color=Green><u>where</u></font>
<a name="line-381"></a>        loop <font color=Red>::</font> <font color=Red>[</font>Qubit<font color=Red>]</font> <font color=Red>-&gt;</font> <font color=Cyan>(</font>a <font color=Red>-&gt;</font> Circ ()<font color=Cyan>)</font> <font color=Red>-&gt;</font> a <font color=Red>-&gt;</font> Circ ()
<a name="line-382"></a>        loop [] f x <font color=Red>=</font> return ()
<a name="line-383"></a>        loop <font color=Cyan>(</font>h<font color=Red><b>:</b></font>t<font color=Cyan>)</font> f x <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-384"></a>            f x <font color=Cyan>`controlled`</font> h
<a name="line-385"></a>            loop t f' x
<a name="line-386"></a>            <font color=Green><u>where</u></font>
<a name="line-387"></a>            f' x <font color=Red>=</font> <font color=Green><u>do</u></font> f x<font color=Cyan>;</font> f x
<a name="line-388"></a>         
<a name="line-389"></a>        u_bx <font color=Red>::</font> <font color=Cyan>(</font><font color=Red>[</font>Qubit<font color=Red>]</font><font color=Cyan>,</font>Qubit<font color=Cyan>,</font>Qubit<font color=Cyan>)</font> <font color=Red>-&gt;</font> Circ ()
<a name="line-390"></a>        u_bx <font color=Cyan>(</font>x<font color=Cyan>,</font>b<font color=Cyan>,</font>s<font color=Cyan>)</font> <font color=Red>=</font> <font color=Green><u>do</u></font> 
<a name="line-391"></a>            qlsa_StatePrep param <font color=Cyan>(</font>x<font color=Cyan>,</font>b<font color=Cyan>)</font> <font color=Cyan>(</font>oracle_b oracle param<font color=Cyan>)</font> <font color=Cyan>(</font><font color=Magenta>1.0</font><font color=Cyan>/</font><font color=Cyan>(</font>b_max param<font color=Cyan>)</font><font color=Cyan>)</font> 
<a name="line-392"></a>            qlsa_Solve_x param <font color=Cyan>(</font>x<font color=Cyan>,</font>s<font color=Cyan>)</font> oracle
<a name="line-393"></a>            return ()
<a name="line-394"></a>
<a name="line-395"></a>        u_g <font color=Red>::</font> <font color=Cyan>(</font><font color=Red>[</font>Qubit<font color=Red>]</font><font color=Cyan>,</font>Qubit<font color=Cyan>,</font>Qubit<font color=Cyan>,</font>Qubit<font color=Cyan>)</font> <font color=Red>-&gt;</font> Circ ()
<a name="line-396"></a>        u_g <font color=Cyan>(</font>x<font color=Cyan>,</font>b<font color=Cyan>,</font>s<font color=Cyan>,</font>a<font color=Cyan>)</font> <font color=Red>=</font> <font color=Green><u>do</u></font> <font color=Blue><i>--named_gate_at "Ug_phi_bx" (x,b,s,a)</i></font>
<a name="line-397"></a>            qnot_at a <font color=Cyan>`controlled`</font> b <font color=Cyan>.&amp;&amp;.</font> s
<a name="line-398"></a>            gate_Z_at a
<a name="line-399"></a>            qnot_at a <font color=Cyan>`controlled`</font> b <font color=Cyan>.&amp;&amp;.</font> s
<a name="line-400"></a>            <font color=Cyan>(</font>reverse_generic_imp u_bx<font color=Cyan>)</font> <font color=Cyan>(</font>x<font color=Cyan>,</font>b<font color=Cyan>,</font>s<font color=Cyan>)</font>
<a name="line-401"></a>            qnot_at a <font color=Cyan>`controlled`</font> <font color=Red>[</font> q <font color=Cyan>.==.</font> <font color=Magenta>0</font> <font color=Red>|</font> q <font color=Red>&lt;-</font> x <font color=Red>]</font> <font color=Cyan>.&amp;&amp;.</font> b <font color=Cyan>.==.</font> <font color=Magenta>0</font> <font color=Cyan>.&amp;&amp;.</font> s <font color=Cyan>.==.</font> <font color=Magenta>0</font>
<a name="line-402"></a>            gate_X_at a
<a name="line-403"></a>            gate_Z_at a
<a name="line-404"></a>            gate_X_at a
<a name="line-405"></a>            qnot_at a <font color=Cyan>`controlled`</font> <font color=Red>[</font> q <font color=Cyan>.==.</font> <font color=Magenta>0</font> <font color=Red>|</font> q <font color=Red>&lt;-</font> x <font color=Red>]</font> <font color=Cyan>.&amp;&amp;.</font> b <font color=Cyan>.==.</font> <font color=Magenta>0</font> <font color=Cyan>.&amp;&amp;.</font> s <font color=Cyan>.==.</font> <font color=Magenta>0</font>
<a name="line-406"></a>            u_bx <font color=Cyan>(</font>x<font color=Cyan>,</font>b<font color=Cyan>,</font>s<font color=Cyan>)</font>
<a name="line-407"></a>            return ()
<a name="line-408"></a>        
<a name="line-409"></a>
<a name="line-410"></a>        
<a name="line-411"></a>       
<a name="line-412"></a><a name="qlsa_AmpEst_phi_bxr"></a><font color=Blue><i>-- | Estimates &#966;[sub /r/0] and &#966;[sub /r/1] (depending on the boolean</i></font>
<a name="line-413"></a><font color=Blue><i>-- parameter), related to the overlap of the solution with the</i></font>
<a name="line-414"></a><font color=Blue><i>-- arbitrary state /r/.</i></font>
<a name="line-415"></a><font color=Blue>qlsa_AmpEst_phi_bxr</font> <font color=Red>::</font> RunTimeParam <font color=Red>-&gt;</font> Oracle <font color=Red>-&gt;</font> Bool <font color=Red>-&gt;</font> Circ Double
<a name="line-416"></a><font color=Blue>qlsa_AmpEst_phi_bxr</font> param oracle target <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-417"></a>    g <font color=Red>&lt;-</font> qinit <font color=Cyan>(</font>take <font color=Cyan>(</font>n0 param<font color=Cyan>)</font> <font color=Cyan>(</font>repeat False<font color=Cyan>)</font><font color=Cyan>)</font>
<a name="line-418"></a>    with_ancilla_init <font color=Cyan>(</font>take <font color=Cyan>(</font>n2 param<font color=Cyan>)</font> <font color=Cyan>(</font>repeat False<font color=Cyan>)</font><font color=Cyan>)</font> <font color=Cyan>$</font> <font color=Red>\</font>x <font color=Red>-&gt;</font> <font color=Green><u>do</u></font>
<a name="line-419"></a>      with_ancilla_init <font color=Cyan>(</font>take <font color=Cyan>(</font>n2 param<font color=Cyan>)</font> <font color=Cyan>(</font>repeat False<font color=Cyan>)</font><font color=Cyan>)</font> <font color=Cyan>$</font> <font color=Red>\</font>y <font color=Red>-&gt;</font> <font color=Green><u>do</u></font> 
<a name="line-420"></a>        with_ancilla <font color=Cyan>$</font> <font color=Red>\</font>a <font color=Red>-&gt;</font> <font color=Green><u>do</u></font> 
<a name="line-421"></a>          with_ancilla <font color=Cyan>$</font> <font color=Red>\</font>b <font color=Red>-&gt;</font> <font color=Green><u>do</u></font>
<a name="line-422"></a>             with_ancilla <font color=Cyan>$</font> <font color=Red>\</font>s <font color=Red>-&gt;</font> <font color=Green><u>do</u></font>
<a name="line-423"></a>                with_ancilla <font color=Cyan>$</font> <font color=Red>\</font>r <font color=Red>-&gt;</font> <font color=Green><u>do</u></font> 
<a name="line-424"></a>                    with_ancilla <font color=Cyan>$</font> <font color=Red>\</font>c <font color=Red>-&gt;</font> <font color=Green><u>do</u></font>
<a name="line-425"></a>                        g <font color=Red>&lt;-</font> map_hadamard g    
<a name="line-426"></a>                        u_r <font color=Cyan>(</font>x<font color=Cyan>,</font>y<font color=Cyan>,</font>b<font color=Cyan>,</font>s<font color=Cyan>,</font>r<font color=Cyan>,</font>c<font color=Cyan>)</font>
<a name="line-427"></a>                        loop g u_g <font color=Cyan>(</font>x<font color=Cyan>,</font>y<font color=Cyan>,</font>b<font color=Cyan>,</font>s<font color=Cyan>,</font>r<font color=Cyan>,</font>c<font color=Cyan>,</font>a<font color=Cyan>)</font>
<a name="line-428"></a>                        return ()
<a name="line-429"></a>                    return ()
<a name="line-430"></a>                return ()
<a name="line-431"></a>             return ()
<a name="line-432"></a>          return ()   
<a name="line-433"></a>    g' <font color=Red>&lt;-</font> qft_big_endian g <font color=Blue><i>-- QFT : Is it really big-endian?</i></font>
<a name="line-434"></a>    value_bits  <font color=Red>&lt;-</font> measure g'
<a name="line-435"></a>    value_double <font color=Red>&lt;-</font> dynamic_lift_double <font color=Magenta>1.0</font> value_bits
<a name="line-436"></a>    return <font color=Cyan>(</font>pi <font color=Cyan>*</font> value_double <font color=Cyan>/</font> <font color=Cyan>(</font><font color=Magenta>2</font> <font color=Cyan>**</font> <font color=Cyan>(</font>fromIntegral <font color=Cyan>$</font> n0 param<font color=Cyan>)</font><font color=Cyan>)</font><font color=Cyan>)</font>
<a name="line-437"></a>    <font color=Green><u>where</u></font>
<a name="line-438"></a>    loop <font color=Red>::</font> <font color=Red>[</font>Qubit<font color=Red>]</font> <font color=Red>-&gt;</font> <font color=Cyan>(</font>a <font color=Red>-&gt;</font> Circ ()<font color=Cyan>)</font> <font color=Red>-&gt;</font> a <font color=Red>-&gt;</font> Circ ()
<a name="line-439"></a>    loop [] f x <font color=Red>=</font> return ()
<a name="line-440"></a>    loop <font color=Cyan>(</font>h<font color=Red><b>:</b></font>t<font color=Cyan>)</font> f x <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-441"></a>       f x <font color=Cyan>`controlled`</font> h
<a name="line-442"></a>       loop t f' x
<a name="line-443"></a>       <font color=Green><u>where</u></font>
<a name="line-444"></a>         f' x <font color=Red>=</font> <font color=Green><u>do</u></font> f x<font color=Cyan>;</font> f x
<a name="line-445"></a>         
<a name="line-446"></a>    u_r <font color=Red>::</font> <font color=Cyan>(</font><font color=Red>[</font>Qubit<font color=Red>]</font><font color=Cyan>,</font><font color=Red>[</font>Qubit<font color=Red>]</font><font color=Cyan>,</font>Qubit<font color=Cyan>,</font>Qubit<font color=Cyan>,</font>Qubit<font color=Cyan>,</font>Qubit<font color=Cyan>)</font> <font color=Red>-&gt;</font> Circ ()
<a name="line-447"></a>    u_r <font color=Cyan>(</font>x<font color=Cyan>,</font>y<font color=Cyan>,</font>b<font color=Cyan>,</font>s<font color=Cyan>,</font>r<font color=Cyan>,</font>c<font color=Cyan>)</font> <font color=Red>=</font> <font color=Green><u>do</u></font> 
<a name="line-448"></a>        qlsa_Solve_xr param <font color=Cyan>(</font>x<font color=Cyan>,</font>y<font color=Cyan>,</font>b<font color=Cyan>,</font>s<font color=Cyan>,</font>r<font color=Cyan>,</font>c<font color=Cyan>)</font> oracle
<a name="line-449"></a>        return ()
<a name="line-450"></a>
<a name="line-451"></a>    u_g <font color=Red>::</font> <font color=Cyan>(</font><font color=Red>[</font>Qubit<font color=Red>]</font><font color=Cyan>,</font><font color=Red>[</font>Qubit<font color=Red>]</font><font color=Cyan>,</font>Qubit<font color=Cyan>,</font>Qubit<font color=Cyan>,</font>Qubit<font color=Cyan>,</font>Qubit<font color=Cyan>,</font>Qubit<font color=Cyan>)</font> <font color=Red>-&gt;</font> Circ ()
<a name="line-452"></a>    u_g <font color=Cyan>(</font>x<font color=Cyan>,</font>y<font color=Cyan>,</font>b<font color=Cyan>,</font>s<font color=Cyan>,</font>r<font color=Cyan>,</font>c<font color=Cyan>,</font>a<font color=Cyan>)</font> <font color=Red>=</font> <font color=Green><u>do</u></font> <font color=Blue><i>--named_gate_at "Ug_phi_bxr" (x,y,b,s,r,c,a)</i></font>
<a name="line-453"></a>         qnot_at a <font color=Cyan>`controlled`</font> <font color=Cyan>(</font>b <font color=Cyan>.==.</font> <font color=Magenta>1</font> <font color=Cyan>.&amp;&amp;.</font> s <font color=Cyan>.==.</font> <font color=Magenta>1</font> <font color=Cyan>.&amp;&amp;.</font> r <font color=Cyan>.==.</font> <font color=Magenta>1</font> <font color=Cyan>.&amp;&amp;.</font> c <font color=Cyan>.==.</font> target<font color=Cyan>)</font>
<a name="line-454"></a>         gate_Z_at a
<a name="line-455"></a>         qnot_at a <font color=Cyan>`controlled`</font> <font color=Cyan>(</font>b <font color=Cyan>.==.</font> <font color=Magenta>1</font> <font color=Cyan>.&amp;&amp;.</font> s <font color=Cyan>.==.</font> <font color=Magenta>1</font> <font color=Cyan>.&amp;&amp;.</font> r <font color=Cyan>.==.</font> <font color=Magenta>1</font> <font color=Cyan>.&amp;&amp;.</font> c <font color=Cyan>.==.</font> target<font color=Cyan>)</font>
<a name="line-456"></a>         <font color=Cyan>(</font>reverse_generic_imp u_r<font color=Cyan>)</font> <font color=Cyan>(</font>x<font color=Cyan>,</font>y<font color=Cyan>,</font>b<font color=Cyan>,</font>s<font color=Cyan>,</font>r<font color=Cyan>,</font>c<font color=Cyan>)</font>
<a name="line-457"></a>         qnot_at a <font color=Cyan>`controlled`</font> <font color=Red>[</font> q <font color=Cyan>.==.</font> <font color=Magenta>0</font> <font color=Red>|</font> q <font color=Red>&lt;-</font> x <font color=Red>]</font> <font color=Cyan>.&amp;&amp;.</font> <font color=Red>[</font> q <font color=Cyan>.==.</font> <font color=Magenta>0</font> <font color=Red>|</font> q <font color=Red>&lt;-</font> y <font color=Red>]</font> <font color=Cyan>.&amp;&amp;.</font> b <font color=Cyan>.==.</font> <font color=Magenta>0</font> <font color=Cyan>.&amp;&amp;.</font> s <font color=Cyan>.==.</font> <font color=Magenta>0</font> <font color=Cyan>.&amp;&amp;.</font> r <font color=Cyan>.==.</font> <font color=Magenta>0</font> <font color=Cyan>.&amp;&amp;.</font> c <font color=Cyan>.==.</font> <font color=Magenta>0</font>
<a name="line-458"></a>         gate_X_at a
<a name="line-459"></a>         gate_Z_at a
<a name="line-460"></a>         gate_X_at a
<a name="line-461"></a>         qnot_at a <font color=Cyan>`controlled`</font> <font color=Red>[</font> q <font color=Cyan>.==.</font> <font color=Magenta>0</font> <font color=Red>|</font> q <font color=Red>&lt;-</font> x <font color=Red>]</font> <font color=Cyan>.&amp;&amp;.</font> <font color=Red>[</font> q <font color=Cyan>.==.</font> <font color=Magenta>0</font> <font color=Red>|</font> q <font color=Red>&lt;-</font> y <font color=Red>]</font> <font color=Cyan>.&amp;&amp;.</font> b <font color=Cyan>.==.</font> <font color=Magenta>0</font> <font color=Cyan>.&amp;&amp;.</font> s <font color=Cyan>.==.</font> <font color=Magenta>0</font> <font color=Cyan>.&amp;&amp;.</font> r <font color=Cyan>.==.</font> <font color=Magenta>0</font> <font color=Cyan>.&amp;&amp;.</font> c <font color=Cyan>.==.</font> <font color=Magenta>0</font>
<a name="line-462"></a>         u_r <font color=Cyan>(</font>x<font color=Cyan>,</font>y<font color=Cyan>,</font>b<font color=Cyan>,</font>s<font color=Cyan>,</font>r<font color=Cyan>,</font>c<font color=Cyan>)</font>
<a name="line-463"></a>         return ()
<a name="line-464"></a>
<a name="line-465"></a>
<a name="line-466"></a><font color=Blue><i>-- * State Preparation.</i></font>
<a name="line-467"></a>
<a name="line-468"></a><a name="qlsa_StatePrep"></a><font color=Blue><i>-- | Prepares a quantum state /x/, as specified by an oracle function,</i></font>
<a name="line-469"></a><font color=Blue><i>-- entangled with a single qubit flag /q/ marking the desired state.</i></font>
<a name="line-470"></a><font color=Blue>qlsa_StatePrep</font> <font color=Red>::</font> 
<a name="line-471"></a>    RunTimeParam
<a name="line-472"></a>    <font color=Red>-&gt;</font> <font color=Cyan>(</font><font color=Red>[</font>Qubit<font color=Red>]</font><font color=Cyan>,</font> Qubit<font color=Cyan>)</font> <font color=Blue><i>-- x &amp; qare handles to wires to be changed by StatePrep </i></font>
<a name="line-473"></a>    <font color=Red>-&gt;</font> OracleBRRunTime <font color=Blue><i>-- Common type of (oracle_b oracle) and (oracle_r oracle), if oracle is typed Oracle</i></font>
<a name="line-474"></a>    <font color=Red>-&gt;</font> Double
<a name="line-475"></a>    <font color=Red>-&gt;</font> Circ ()
<a name="line-476"></a><font color=Blue>qlsa_StatePrep</font> param <font color=Cyan>(</font>x<font color=Cyan>,</font> q<font color=Cyan>)</font> oracle phi0 <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-477"></a>  <font color=Green><u>_</u></font> <font color=Red>&lt;-</font> <font color=Cyan>(</font>flip <font color=Cyan>$</font> box <font color=Cyan>(</font><font color=Magenta>"qlsa_StatePrep_"</font> <font color=Cyan>++</font> <font color=Cyan>(</font>show phi0<font color=Cyan>)</font><font color=Cyan>)</font><font color=Cyan>)</font> <font color=Cyan>(</font>x<font color=Cyan>,</font>q<font color=Cyan>)</font> <font color=Cyan>$</font> <font color=Red>\</font><font color=Cyan>(</font>x<font color=Cyan>,</font>q<font color=Cyan>)</font> <font color=Red>-&gt;</font> <font color=Green><u>do</u></font>
<a name="line-478"></a>    <font color=Blue><i>-- comment "StatePrep starts"</i></font>
<a name="line-479"></a>    label <font color=Cyan>(</font>x<font color=Cyan>,</font>q<font color=Cyan>)</font> <font color=Cyan>(</font><font color=Magenta>"x"</font><font color=Cyan>,</font> <font color=Magenta>"q"</font><font color=Cyan>)</font>
<a name="line-480"></a>    with_ancilla_list <font color=Cyan>(</font>n4 param<font color=Cyan>)</font> <font color=Cyan>$</font> <font color=Red>\</font>m <font color=Red>-&gt;</font> <font color=Green><u>do</u></font>
<a name="line-481"></a>        label <font color=Cyan>(</font>m<font color=Cyan>)</font> <font color=Cyan>(</font><font color=Magenta>"anc. m"</font><font color=Cyan>)</font>
<a name="line-482"></a>        with_ancilla_list <font color=Cyan>(</font>n4 param<font color=Cyan>)</font> <font color=Cyan>$</font> <font color=Red>\</font>p <font color=Red>-&gt;</font> <font color=Green><u>do</u></font>
<a name="line-483"></a>            label <font color=Cyan>(</font>p<font color=Cyan>)</font> <font color=Cyan>(</font><font color=Magenta>"anc. p"</font><font color=Cyan>)</font>
<a name="line-484"></a>            x <font color=Red>&lt;-</font> map_hadamard x
<a name="line-485"></a>            <font color=Cyan>(</font>x<font color=Cyan>,</font> m<font color=Cyan>,</font> p<font color=Cyan>)</font> <font color=Red>&lt;-</font> oracle phi0 <font color=Cyan>(</font>epsilon param<font color=Cyan>)</font> <font color=Cyan>(</font>x<font color=Cyan>,</font> m<font color=Cyan>,</font> p<font color=Cyan>)</font>
<a name="line-486"></a>            qlsa_ControlledPhase p <font color=Cyan>(</font>epsilon param<font color=Cyan>)</font> False
<a name="line-487"></a>            qlsa_ControlledRotation <font color=Cyan>(</font>m<font color=Cyan>,</font> q<font color=Cyan>)</font> phi0 False
<a name="line-488"></a>            <font color=Cyan>(</font>x<font color=Cyan>,</font> m<font color=Cyan>,</font> p<font color=Cyan>)</font> <font color=Red>&lt;-</font> oracle phi0 <font color=Cyan>(</font>epsilon param<font color=Cyan>)</font> <font color=Cyan>(</font>x<font color=Cyan>,</font> m<font color=Cyan>,</font> p<font color=Cyan>)</font>
<a name="line-489"></a>            return <font color=Cyan>(</font>x<font color=Cyan>,</font>q<font color=Cyan>)</font>
<a name="line-490"></a>    <font color=Blue><i>-- comment "StatePrep ends"</i></font>
<a name="line-491"></a>  return ()
<a name="line-492"></a>
<a name="line-493"></a>
<a name="line-494"></a><a name="test_qlsa_StatePrep"></a><font color=Blue><i>-- | Testing function for 'qlsa_StatePrep'.</i></font>
<a name="line-495"></a><font color=Blue>test_qlsa_StatePrep</font> <font color=Red>::</font> Bool <font color=Red>-&gt;</font> IO ()
<a name="line-496"></a><font color=Blue>test_qlsa_StatePrep</font> dummyRTParamFlag <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-497"></a>          <font color=Green><u>let</u></font> param <font color=Red>=</font> <font color=Green><u>if</u></font> dummyRTParamFlag <font color=Green><u>then</u></font> dummy_RT_param <font color=Green><u>else</u></font> large_RT_param
<a name="line-498"></a>          <font color=Green><u>let</u></font> oraclebRunTime <font color=Red>=</font> <font color=Cyan>(</font>oracle_b dummy_oracle param<font color=Cyan>)</font>  
<a name="line-499"></a>          <font color=Green><u>let</u></font> testCirc <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-500"></a>              x <font color=Red>&lt;-</font> qinit <font color=Cyan>$</font> replicate <font color=Cyan>(</font>n2 param<font color=Cyan>)</font> False
<a name="line-501"></a>              q <font color=Red>&lt;-</font> qinit False
<a name="line-502"></a>              qlsa_StatePrep param <font color=Cyan>(</font>x<font color=Cyan>,</font>q<font color=Cyan>)</font> oraclebRunTime <font color=Magenta>1.0</font>
<a name="line-503"></a>          print_simple GateCount testCirc
<a name="line-504"></a>          print_simple Preview testCirc
<a name="line-505"></a>
<a name="line-506"></a>
<a name="line-507"></a>
<a name="line-508"></a>
<a name="line-509"></a><font color=Blue><i>-- * Linear System Solver Functions</i></font>
<a name="line-510"></a>
<a name="line-511"></a><a name="qlsa_Solve_x"></a><font color=Blue><i>-- | Implements the QLSA procedure to generate the solution state |/x/&#9002;.</i></font>
<a name="line-512"></a><font color=Blue>qlsa_Solve_x</font> <font color=Red>::</font> RunTimeParam <font color=Red>-&gt;</font><font color=Cyan>(</font><font color=Red>[</font>Qubit<font color=Red>]</font><font color=Cyan>,</font>Qubit<font color=Cyan>)</font> <font color=Red>-&gt;</font> Oracle <font color=Red>-&gt;</font> Circ ()   
<a name="line-513"></a><font color=Blue>qlsa_Solve_x</font> param <font color=Cyan>(</font>x<font color=Cyan>,</font>s<font color=Cyan>)</font> oracle <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-514"></a>  <font color=Green><u>_</u></font> <font color=Red>&lt;-</font> <font color=Cyan>(</font>flip <font color=Cyan>$</font> box <font color=Magenta>"qlsa_Solve_x"</font><font color=Cyan>)</font> <font color=Cyan>(</font>x<font color=Cyan>,</font>s<font color=Cyan>)</font> <font color=Cyan>$</font> <font color=Red>\</font><font color=Cyan>(</font>x<font color=Cyan>,</font>s<font color=Cyan>)</font> <font color=Red>-&gt;</font> <font color=Green><u>do</u></font>
<a name="line-515"></a>    with_ancilla_list <font color=Cyan>(</font>n1 param<font color=Cyan>)</font> <font color=Cyan>$</font> <font color=Red>\</font>t <font color=Red>-&gt;</font> <font color=Green><u>do</u></font> 
<a name="line-516"></a>        with_ancilla_list <font color=Cyan>(</font>length t<font color=Cyan>)</font> <font color=Cyan>$</font> <font color=Red>\</font>f <font color=Red>-&gt;</font> <font color=Green><u>do</u></font> 
<a name="line-517"></a>            <font color=Green><u>let</u></font> phi0 <font color=Red>=</font> <font color=Magenta>2</font> <font color=Cyan>*</font> pi  <font color=Cyan>/</font> <font color=Cyan>(</font><font color=Magenta>2</font> <font color=Cyan>**</font> <font color=Cyan>(</font>fromIntegral <font color=Cyan>$</font> n1 param<font color=Cyan>)</font> <font color=Blue><i>-</i></font> <font color=Cyan>(</font>epsilon param<font color=Cyan>)</font><font color=Cyan>)</font>
<a name="line-518"></a>            t <font color=Red>&lt;-</font> map_hadamard t
<a name="line-519"></a>            u_hs <font color=Cyan>(</font>t<font color=Cyan>,</font>x<font color=Cyan>)</font>
<a name="line-520"></a>            t <font color=Red>&lt;-</font> qft_big_endian t
<a name="line-521"></a>            integer_inverse <font color=Cyan>(</font>t<font color=Cyan>,</font>f<font color=Cyan>)</font> 
<a name="line-522"></a>            qlsa_ControlledRotation <font color=Cyan>(</font>f<font color=Cyan>,</font>s<font color=Cyan>)</font> phi0 False
<a name="line-523"></a>            integer_inverse <font color=Cyan>(</font>t<font color=Cyan>,</font>f<font color=Cyan>)</font>
<a name="line-524"></a>            <font color=Cyan>(</font>reverse_generic_endo qft_big_endian<font color=Cyan>)</font> t
<a name="line-525"></a>            <font color=Cyan>(</font>reverse_generic_imp u_hs<font color=Cyan>)</font> <font color=Cyan>(</font>t<font color=Cyan>,</font>x<font color=Cyan>)</font>
<a name="line-526"></a>            t <font color=Red>&lt;-</font> map_hadamard t
<a name="line-527"></a>            return()  
<a name="line-528"></a>        return ()
<a name="line-529"></a>    return <font color=Cyan>(</font>x<font color=Cyan>,</font>s<font color=Cyan>)</font>
<a name="line-530"></a>  return ()
<a name="line-531"></a>    <font color=Green><u>where</u></font>
<a name="line-532"></a>        u_hs <font color=Red>::</font> <font color=Cyan>(</font><font color=Red>[</font>Qubit<font color=Red>]</font><font color=Cyan>,</font><font color=Red>[</font>Qubit<font color=Red>]</font><font color=Cyan>)</font> <font color=Red>-&gt;</font> Circ ()
<a name="line-533"></a>        u_hs <font color=Cyan>(</font>t<font color=Cyan>,</font>x<font color=Cyan>)</font> <font color=Red>=</font> <font color=Green><u>do</u></font> 
<a name="line-534"></a>            qlsa_HamiltonianSimulation param <font color=Cyan>(</font>t<font color=Cyan>,</font>x<font color=Cyan>)</font> <font color=Cyan>(</font>oracle_A oracle param<font color=Cyan>)</font>
<a name="line-535"></a>            return ()
<a name="line-536"></a>            
<a name="line-537"></a>
<a name="line-538"></a><a name="integer_inverse"></a><font color=Blue><i>-- | Implementation of the integer division. The two registers are</i></font>
<a name="line-539"></a><font color=Blue><i>-- supposed to be of the same size and represent little-headian</i></font>
<a name="line-540"></a><font color=Blue><i>-- unsigned integers, i.e., the head of the list holds the least</i></font>
<a name="line-541"></a><font color=Blue><i>-- significant bit.</i></font>
<a name="line-542"></a><font color=Blue>integer_inverse</font> <font color=Red>::</font> <font color=Cyan>(</font><font color=Red>[</font>Qubit<font color=Red>]</font><font color=Cyan>,</font><font color=Red>[</font>Qubit<font color=Red>]</font><font color=Cyan>)</font> <font color=Red>-&gt;</font> Circ ()
<a name="line-543"></a><font color=Blue>integer_inverse</font> <font color=Cyan>(</font>t<font color=Cyan>,</font>f<font color=Cyan>)</font> <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-544"></a>  <font color=Green><u>_</u></font> <font color=Red>&lt;-</font> <font color=Cyan>(</font>flip <font color=Cyan>$</font> box <font color=Magenta>"integer_inverse"</font><font color=Cyan>)</font> <font color=Cyan>(</font>t<font color=Cyan>,</font>f<font color=Cyan>)</font> <font color=Cyan>$</font> <font color=Red>\</font><font color=Cyan>(</font>t<font color=Cyan>,</font>f<font color=Cyan>)</font> <font color=Red>-&gt;</font> <font color=Green><u>do</u></font>
<a name="line-545"></a>    <font color=Blue><i>-- sanity check</i></font>
<a name="line-546"></a>    <font color=Green><u>if</u></font> <font color=Cyan>(</font>length t <font color=Cyan>/=</font> length f<font color=Cyan>)</font> 
<a name="line-547"></a>      <font color=Green><u>then</u></font> error <font color=Magenta>"integer_inverse: registers of distinct sizes"</font> 
<a name="line-548"></a>      <font color=Green><u>else</u></font> return ()
<a name="line-549"></a>    <font color=Blue><i>-- initialize an unsigned integer to 2^(length t) - 1</i></font>
<a name="line-550"></a>    with_ancilla_init <font color=Cyan>(</font>map <font color=Cyan>(</font><font color=Red>\</font><font color=Green><u>_</u></font> <font color=Red>-&gt;</font> True<font color=Cyan>)</font> t<font color=Cyan>)</font> <font color=Cyan>$</font> <font color=Red>\</font>num <font color=Red>-&gt;</font> <font color=Green><u>do</u></font>
<a name="line-551"></a>      <font color=Blue><i>-- perform the division (encapsulated in a subroutine)</i></font>
<a name="line-552"></a>      <font color=Green><u>let</u></font> d <font color=Red>=</font> classical_to_reversible <font color=Cyan>$</font> <font color=Red>\</font><font color=Cyan>(</font>t<font color=Cyan>,</font>num<font color=Cyan>)</font> <font color=Red>-&gt;</font> <font color=Green><u>do</u></font>
<a name="line-553"></a>                <font color=Green><u>let</u></font> x <font color=Red>=</font> <font color=Cyan>(</font><font color=Cyan>(</font>qdint_of_qulist_lh num<font color=Cyan>)</font><font color=Cyan>,</font><font color=Cyan>(</font>qdint_of_qulist_lh t<font color=Cyan>)</font><font color=Cyan>)</font>
<a name="line-554"></a>                <font color=Cyan>(</font><font color=Green><u>_</u></font><font color=Cyan>,</font><font color=Green><u>_</u></font><font color=Cyan>,</font>f'<font color=Cyan>)</font> <font color=Red>&lt;-</font> uncurry q_div_unsigned x
<a name="line-555"></a>                return <font color=Cyan>$</font> qulist_of_qdint_lh f'
<a name="line-556"></a>      d <font color=Cyan>(</font><font color=Cyan>(</font>t<font color=Cyan>,</font>num<font color=Cyan>)</font><font color=Cyan>,</font>f<font color=Cyan>)</font>
<a name="line-557"></a>      return <font color=Cyan>(</font>t<font color=Cyan>,</font>f<font color=Cyan>)</font>
<a name="line-558"></a>  return ()
<a name="line-559"></a>
<a name="line-560"></a>
<a name="line-561"></a>
<a name="line-562"></a>
<a name="line-563"></a>            
<a name="line-564"></a><a name="qlsa_Solve_xr"></a><font color=Blue><i>-- | Implements the complete QLSA procedure to find the</i></font>
<a name="line-565"></a><font color=Blue><i>-- solution state |/x/&#9002; and then implements the swap protocol</i></font>
<a name="line-566"></a><font color=Blue><i>-- required for estimation of &#9001;/x/|/r/&#9002;.</i></font>
<a name="line-567"></a><font color=Blue>qlsa_Solve_xr</font> <font color=Red>::</font> RunTimeParam <font color=Red>-&gt;</font><font color=Cyan>(</font><font color=Red>[</font>Qubit<font color=Red>]</font><font color=Cyan>,</font><font color=Red>[</font>Qubit<font color=Red>]</font><font color=Cyan>,</font>Qubit<font color=Cyan>,</font>Qubit<font color=Cyan>,</font>Qubit<font color=Cyan>,</font>Qubit<font color=Cyan>)</font> <font color=Red>-&gt;</font> Oracle <font color=Red>-&gt;</font> Circ ()      
<a name="line-568"></a><font color=Blue><i>-- qlsa_Solve_xr param (x,y,b,s,r,c) oracle  = named_gate_at "Solve_xr" (x,y,b,s,r,c)</i></font>
<a name="line-569"></a><font color=Blue>qlsa_Solve_xr</font> param <font color=Cyan>(</font>x<font color=Cyan>,</font>y<font color=Cyan>,</font>b<font color=Cyan>,</font>s<font color=Cyan>,</font>r<font color=Cyan>,</font>c<font color=Cyan>)</font> oracle <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-570"></a>  <font color=Green><u>_</u></font> <font color=Red>&lt;-</font> <font color=Cyan>(</font>flip <font color=Cyan>$</font> box <font color=Magenta>"qlsa_Solve_xr"</font><font color=Cyan>)</font> <font color=Cyan>(</font>x<font color=Cyan>,</font>y<font color=Cyan>,</font>b<font color=Cyan>,</font>s<font color=Cyan>,</font>r<font color=Cyan>,</font>c<font color=Cyan>)</font> <font color=Cyan>$</font> <font color=Red>\</font><font color=Cyan>(</font>x<font color=Cyan>,</font>y<font color=Cyan>,</font>b<font color=Cyan>,</font>s<font color=Cyan>,</font>r<font color=Cyan>,</font>c<font color=Cyan>)</font> <font color=Red>-&gt;</font> <font color=Green><u>do</u></font>
<a name="line-571"></a>    qlsa_StatePrep param <font color=Cyan>(</font>x<font color=Cyan>,</font>b<font color=Cyan>)</font> <font color=Cyan>(</font>oracle_b oracle param<font color=Cyan>)</font> <font color=Cyan>(</font><font color=Magenta>1.0</font><font color=Cyan>/</font><font color=Cyan>(</font>b_max param<font color=Cyan>)</font><font color=Cyan>)</font> 
<a name="line-572"></a>    qlsa_Solve_x param <font color=Cyan>(</font>x<font color=Cyan>,</font>s<font color=Cyan>)</font> oracle     
<a name="line-573"></a>    qlsa_StatePrep param <font color=Cyan>(</font>y<font color=Cyan>,</font>r<font color=Cyan>)</font> <font color=Cyan>(</font>oracle_r oracle param<font color=Cyan>)</font> <font color=Cyan>(</font><font color=Magenta>1.0</font><font color=Cyan>/</font><font color=Cyan>(</font>r_max param<font color=Cyan>)</font><font color=Cyan>)</font> 
<a name="line-574"></a>    hadamard_at c
<a name="line-575"></a>    swap_at y x  <font color=Cyan>`controlled`</font> c
<a name="line-576"></a>    hadamard_at c
<a name="line-577"></a>    return <font color=Cyan>(</font>x<font color=Cyan>,</font>y<font color=Cyan>,</font>b<font color=Cyan>,</font>s<font color=Cyan>,</font>r<font color=Cyan>,</font>c<font color=Cyan>)</font>
<a name="line-578"></a>  return ()
<a name="line-579"></a>    
<a name="line-580"></a>
<a name="line-581"></a><font color=Blue><i>-- * Hamiltonian Simulation Functions.</i></font>
<a name="line-582"></a>
<a name="line-583"></a><a name="qlsa_HamiltonianSimulation"></a><font color=Blue><i>-- | Uses a quantum register |/t/&#9002; to control the</i></font>
<a name="line-584"></a><font color=Blue><i>-- implementation of the Suzuki method for simulating a Hamiltonian</i></font>
<a name="line-585"></a><font color=Blue><i>-- specified by an oracle function.</i></font>
<a name="line-586"></a><font color=Blue>qlsa_HamiltonianSimulation</font> <font color=Red>::</font> 
<a name="line-587"></a>    RunTimeParam 
<a name="line-588"></a>    <font color=Red>-&gt;</font> <font color=Cyan>(</font><font color=Red>[</font>Qubit<font color=Red>]</font><font color=Cyan>,</font> <font color=Red>[</font>Qubit<font color=Red>]</font><font color=Cyan>)</font>
<a name="line-589"></a>    <font color=Red>-&gt;</font> OracleARunTime 
<a name="line-590"></a>    <font color=Red>-&gt;</font> Circ ()
<a name="line-591"></a><font color=Blue>qlsa_HamiltonianSimulation</font> param <font color=Cyan>(</font>t<font color=Cyan>,</font> x<font color=Cyan>)</font> oracleA <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-592"></a>  <font color=Green><u>_</u></font> <font color=Red>&lt;-</font> <font color=Cyan>(</font>flip <font color=Cyan>$</font> box <font color=Magenta>"qlsa_HamiltonianSimulation"</font><font color=Cyan>)</font> <font color=Cyan>(</font>t<font color=Cyan>,</font>x<font color=Cyan>)</font> <font color=Cyan>$</font> <font color=Red>\</font><font color=Cyan>(</font>t<font color=Cyan>,</font>x<font color=Cyan>)</font> <font color=Red>-&gt;</font> <font color=Green><u>do</u></font>
<a name="line-593"></a>    <font color=Blue><i>-- Code the first line in a way that depends on the length of t rather </i></font>
<a name="line-594"></a>    <font color=Blue><i>-- explicitly on (n1 param) which is supposed to be the length of t</i></font>
<a name="line-595"></a>    <font color=Blue><i>-- Hence replaced the line below by the line after it.</i></font>
<a name="line-596"></a>    <font color=Blue><i>-- let denom = 2 * (r param) * (fromIntegral ((n1 param) - 1))</i></font>
<a name="line-597"></a>    <font color=Green><u>let</u></font> denom <font color=Red>=</font> <font color=Magenta>2</font> <font color=Cyan>*</font> <font color=Cyan>(</font>r param<font color=Cyan>)</font> <font color=Cyan>*</font> <font color=Cyan>(</font> <font color=Magenta>2</font><font color=Cyan>^</font><font color=Cyan>(</font><font color=Cyan>(</font>length t<font color=Cyan>)</font> <font color=Blue><i>-</i></font> <font color=Magenta>1</font><font color=Cyan>)</font> <font color=Cyan>)</font>
<a name="line-598"></a>    <font color=Green><u>let</u></font> t1 <font color=Red>=</font> <font color=Cyan>(</font>p2 param<font color=Cyan>)</font> <font color=Cyan>*</font> <font color=Cyan>(</font>t0 param<font color=Cyan>)</font> <font color=Cyan>/</font> denom
<a name="line-599"></a>    <font color=Green><u>let</u></font> t2 <font color=Red>=</font> <font color=Cyan>(</font><font color=Magenta>1.0</font> <font color=Blue><i>-</i></font> <font color=Magenta>4.0</font> <font color=Cyan>*</font> <font color=Cyan>(</font>p2 param<font color=Cyan>)</font><font color=Cyan>)</font> <font color=Cyan>*</font> <font color=Cyan>(</font>t0 param<font color=Cyan>)</font> <font color=Cyan>/</font> denom
<a name="line-600"></a>    <font color=Cyan>(</font>t<font color=Cyan>,</font>x<font color=Cyan>)</font> <font color=Red>&lt;-</font> box_loopM  <font color=Magenta>"TrotterLoop"</font> <font color=Cyan>(</font>round <font color=Cyan>$</font> r param<font color=Cyan>)</font> <font color=Cyan>(</font>t<font color=Cyan>,</font>x<font color=Cyan>)</font> <font color=Cyan>(</font>hs_loop t1 t2<font color=Cyan>)</font>
<a name="line-601"></a>    return <font color=Cyan>(</font>t<font color=Cyan>,</font>x<font color=Cyan>)</font>
<a name="line-602"></a>  return ()
<a name="line-603"></a>    <font color=Green><u>where</u></font> 
<a name="line-604"></a>          hs_loop <font color=Red>::</font> Double <font color=Red>-&gt;</font> Double <font color=Red>-&gt;</font> <font color=Cyan>(</font><font color=Red>[</font>Qubit<font color=Red>]</font><font color=Cyan>,</font> <font color=Red>[</font>Qubit<font color=Red>]</font><font color=Cyan>)</font> <font color=Red>-&gt;</font> Circ <font color=Cyan>(</font><font color=Red>[</font>Qubit<font color=Red>]</font><font color=Cyan>,</font> <font color=Red>[</font>Qubit<font color=Red>]</font><font color=Cyan>)</font>
<a name="line-605"></a>          hs_loop t1 t2 <font color=Cyan>(</font>t<font color=Cyan>,</font>x<font color=Cyan>)</font> <font color=Red>=</font> <font color=Green><u>do</u></font> 
<a name="line-606"></a>            u_z_at <font color=Cyan>(</font>t<font color=Cyan>,</font>x<font color=Cyan>)</font> t1
<a name="line-607"></a>            u_z_at <font color=Cyan>(</font>t<font color=Cyan>,</font>x<font color=Cyan>)</font> t1
<a name="line-608"></a>            u_z_at <font color=Cyan>(</font>t<font color=Cyan>,</font>x<font color=Cyan>)</font> t2
<a name="line-609"></a>            u_z_at <font color=Cyan>(</font>t<font color=Cyan>,</font>x<font color=Cyan>)</font> t1
<a name="line-610"></a>            u_z_at <font color=Cyan>(</font>t<font color=Cyan>,</font>x<font color=Cyan>)</font> t1
<a name="line-611"></a>            return <font color=Cyan>(</font>t<font color=Cyan>,</font>x<font color=Cyan>)</font>
<a name="line-612"></a>
<a name="line-613"></a>          u_z_at <font color=Red>::</font> <font color=Cyan>(</font><font color=Red>[</font>Qubit<font color=Red>]</font><font color=Cyan>,</font> <font color=Red>[</font>Qubit<font color=Red>]</font><font color=Cyan>)</font> <font color=Red>-&gt;</font> Double <font color=Red>-&gt;</font> Circ ()
<a name="line-614"></a>          u_z_at <font color=Cyan>(</font>t<font color=Cyan>,</font> x<font color=Cyan>)</font> timeStep <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-615"></a>              for <font color=Cyan>(</font>nb param<font color=Cyan>)</font> <font color=Magenta>1</font> <font color=Cyan>(</font><font color=Blue><i>-</i></font><font color=Magenta>1</font><font color=Cyan>)</font> <font color=Cyan>$</font> <font color=Red>\</font>jj <font color=Red>-&gt;</font> <font color=Green><u>do</u></font>
<a name="line-616"></a>                  qlsa_HsimKernel param <font color=Cyan>(</font>t<font color=Cyan>,</font> x<font color=Cyan>)</font> jj timeStep oracleA 
<a name="line-617"></a>                  endfor
<a name="line-618"></a>              for <font color=Magenta>1</font> <font color=Cyan>(</font>nb param<font color=Cyan>)</font> <font color=Magenta>1</font> <font color=Cyan>$</font> <font color=Red>\</font>jj <font color=Red>-&gt;</font> <font color=Green><u>do</u></font>
<a name="line-619"></a>                  qlsa_HsimKernel param <font color=Cyan>(</font>t<font color=Cyan>,</font> x<font color=Cyan>)</font> jj timeStep oracleA 
<a name="line-620"></a>                  endfor
<a name="line-621"></a>              return ()
<a name="line-622"></a>
<a name="line-623"></a><a name="test_qlsa_HamiltonianSimulation"></a><font color=Blue><i>-- | Testing function for 'qlsa_HamiltonianSimulation'.</i></font>
<a name="line-624"></a><font color=Blue>test_qlsa_HamiltonianSimulation</font> <font color=Red>::</font> Bool <font color=Red>-&gt;</font> IO ()
<a name="line-625"></a><font color=Blue>test_qlsa_HamiltonianSimulation</font> dummyRTParamFlag <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-626"></a>    <font color=Green><u>let</u></font> param <font color=Red>=</font> <font color=Green><u>if</u></font> dummyRTParamFlag <font color=Green><u>then</u></font> dummy_RT_param <font color=Green><u>else</u></font> large_RT_param
<a name="line-627"></a>    <font color=Green><u>let</u></font> oracleARunTime <font color=Red>=</font> <font color=Cyan>(</font>oracle_A dummy_oracle param<font color=Cyan>)</font> 
<a name="line-628"></a>    <font color=Green><u>let</u></font> testCirc <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-629"></a>              t <font color=Red>&lt;-</font> qinit <font color=Cyan>(</font>take <font color=Cyan>(</font>n0 param<font color=Cyan>)</font> <font color=Cyan>(</font>repeat False<font color=Cyan>)</font><font color=Cyan>)</font>
<a name="line-630"></a>              x <font color=Red>&lt;-</font> qinit <font color=Cyan>(</font>take <font color=Cyan>(</font>n4 param<font color=Cyan>)</font> <font color=Cyan>(</font>repeat False<font color=Cyan>)</font><font color=Cyan>)</font>
<a name="line-631"></a>              label<font color=Cyan>(</font>t<font color=Cyan>,</font>x<font color=Cyan>)</font> <font color=Cyan>(</font><font color=Magenta>"t"</font><font color=Cyan>,</font> <font color=Magenta>"x"</font><font color=Cyan>)</font>
<a name="line-632"></a>              qlsa_HamiltonianSimulation param <font color=Cyan>(</font>t<font color=Cyan>,</font>x<font color=Cyan>)</font> oracleARunTime
<a name="line-633"></a>    print_simple GateCount testCirc
<a name="line-634"></a><font color=Blue><i>--    print_simple Preview testCirc</i></font>
<a name="line-635"></a>
<a name="line-636"></a>
<a name="line-637"></a>
<a name="line-638"></a><a name="qlsa_HsimKernel"></a><font color=Blue><i>-- | Uses an oracle function and timestep control register (/t/) to</i></font>
<a name="line-639"></a><font color=Blue><i>-- apply 1-sparse Hamiltonian to the input state |/t/, /x/&#9002;.</i></font>
<a name="line-640"></a><font color=Blue>qlsa_HsimKernel</font> <font color=Red>::</font> 
<a name="line-641"></a>    RunTimeParam
<a name="line-642"></a>    <font color=Red>-&gt;</font> <font color=Cyan>(</font><font color=Red>[</font>Qubit<font color=Red>]</font><font color=Cyan>,</font> <font color=Red>[</font>Qubit<font color=Red>]</font><font color=Cyan>)</font> 
<a name="line-643"></a>    <font color=Red>-&gt;</font> Int 
<a name="line-644"></a>    <font color=Red>-&gt;</font> Double 
<a name="line-645"></a>    <font color=Red>-&gt;</font> OracleARunTime
<a name="line-646"></a>    <font color=Red>-&gt;</font> Circ ()
<a name="line-647"></a><font color=Blue><i>-- qlsa_HsimKernel param tx band timeStep oracleA = named_gate_at "HsimKernel" tx</i></font>
<a name="line-648"></a>
<a name="line-649"></a><font color=Blue>qlsa_HsimKernel</font> param <font color=Cyan>(</font>t<font color=Cyan>,</font> x<font color=Cyan>)</font> band timeStep oracleA <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-650"></a>  <font color=Green><u>_</u></font> <font color=Red>&lt;-</font> <font color=Cyan>(</font>flip <font color=Cyan>$</font> box <font color=Cyan>(</font><font color=Magenta>"qlsa_HsimKernel"</font> <font color=Cyan>++</font> <font color=Cyan>(</font>show band<font color=Cyan>)</font> <font color=Cyan>++</font> <font color=Cyan>(</font>show timeStep<font color=Cyan>)</font><font color=Cyan>)</font><font color=Cyan>)</font> <font color=Cyan>(</font>t<font color=Cyan>,</font>x<font color=Cyan>)</font> <font color=Cyan>$</font> <font color=Red>\</font><font color=Cyan>(</font>t<font color=Cyan>,</font>x<font color=Cyan>)</font> <font color=Red>-&gt;</font> <font color=Green><u>do</u></font>
<a name="line-651"></a>    <font color=Green><u>let</u></font> phiP <font color=Red>=</font> <font color=Cyan>(</font>epsilon param<font color=Cyan>)</font>
<a name="line-652"></a>    with_ancilla_list <font color=Cyan>(</font>n2 param<font color=Cyan>)</font> <font color=Cyan>$</font> <font color=Red>\</font>y <font color=Red>-&gt;</font> <font color=Green><u>do</u></font>
<a name="line-653"></a>       with_ancilla_list <font color=Cyan>(</font>n4 param<font color=Cyan>)</font> <font color=Cyan>$</font> <font color=Red>\</font>m <font color=Red>-&gt;</font> <font color=Green><u>do</u></font> 
<a name="line-654"></a>           with_ancilla_list <font color=Cyan>(</font>n4 param<font color=Cyan>)</font> <font color=Cyan>$</font> <font color=Red>\</font>p <font color=Red>-&gt;</font> <font color=Green><u>do</u></font> 
<a name="line-655"></a>               label <font color=Cyan>(</font>y<font color=Cyan>,</font>m<font color=Cyan>,</font>p<font color=Cyan>)</font> <font color=Cyan>(</font><font color=Magenta>"y"</font><font color=Cyan>,</font><font color=Magenta>"m"</font><font color=Cyan>,</font><font color=Magenta>"p"</font><font color=Cyan>)</font>
<a name="line-656"></a>               <font color=Blue><i>-- phases</i></font>
<a name="line-657"></a>               oracleA phiP band <font color=Cyan>(</font>phaseArgflag param<font color=Cyan>)</font> <font color=Cyan>(</font>x<font color=Cyan>,</font>y<font color=Cyan>,</font>p<font color=Cyan>)</font>
<a name="line-658"></a>               qlsa_ControlledPhase p phiP False
<a name="line-659"></a>               oracleA phiP band <font color=Cyan>(</font>phaseArgflag param<font color=Cyan>)</font> <font color=Cyan>(</font>x<font color=Cyan>,</font>y<font color=Cyan>,</font>p<font color=Cyan>)</font>
<a name="line-660"></a>               <font color=Blue><i>-- magnitudes</i></font>
<a name="line-661"></a>               <font color=Green><u>let</u></font> phiMag <font color=Red>=</font> <font color=Magenta>2</font> <font color=Cyan>**</font> <font color=Cyan>(</font>negate <font color=Cyan>$</font> fromIntegral <font color=Cyan>$</font> after_radix_length<font color=Cyan>)</font>
<a name="line-662"></a>               oracleA phiMag band <font color=Cyan>(</font>magnitudeArgflag param<font color=Cyan>)</font> <font color=Cyan>(</font>x<font color=Cyan>,</font>y<font color=Cyan>,</font>m<font color=Cyan>)</font>
<a name="line-663"></a>               for <font color=Magenta>0</font> <font color=Cyan>(</font><font color=Cyan>(</font>length t<font color=Cyan>)</font> <font color=Blue><i>-</i></font> <font color=Magenta>1</font><font color=Cyan>)</font> <font color=Magenta>1</font> <font color=Cyan>$</font> <font color=Red>\</font>ii <font color=Red>-&gt;</font> <font color=Green><u>do</u></font> 
<a name="line-664"></a>                   <font color=Green><u>let</u></font> phi_mt <font color=Red>=</font> timeStep <font color=Cyan>*</font> phiMag <font color=Cyan>*</font> <font color=Cyan>(</font><font color=Magenta>2</font><font color=Cyan>^</font>ii<font color=Cyan>)</font>
<a name="line-665"></a>                   qlsa_ApplyHmag param <font color=Cyan>(</font>x<font color=Cyan>,</font>y<font color=Cyan>,</font>m<font color=Cyan>)</font> phi_mt <font color=Cyan>`controlled`</font> <font color=Cyan>(</font>t <font color=Cyan>!!</font> ii<font color=Cyan>)</font>
<a name="line-666"></a>                   endfor
<a name="line-667"></a>               oracleA phiMag band <font color=Cyan>(</font>magnitudeArgflag param<font color=Cyan>)</font> <font color=Cyan>(</font>x<font color=Cyan>,</font>y<font color=Cyan>,</font>m<font color=Cyan>)</font>
<a name="line-668"></a>               <font color=Blue><i>-- phases again</i></font>
<a name="line-669"></a>               oracleA phiP band <font color=Cyan>(</font>phaseArgflag param<font color=Cyan>)</font> <font color=Cyan>(</font>x<font color=Cyan>,</font>y<font color=Cyan>,</font>p<font color=Cyan>)</font>
<a name="line-670"></a>               qlsa_ControlledPhase p phiP True
<a name="line-671"></a>               oracleA phiP band <font color=Cyan>(</font>phaseArgflag param<font color=Cyan>)</font> <font color=Cyan>(</font>x<font color=Cyan>,</font>y<font color=Cyan>,</font>p<font color=Cyan>)</font>
<a name="line-672"></a>               return ()
<a name="line-673"></a>           return ()
<a name="line-674"></a>       return () 
<a name="line-675"></a>    return <font color=Cyan>(</font>t<font color=Cyan>,</font>x<font color=Cyan>)</font>
<a name="line-676"></a>  return ()
<a name="line-677"></a>
<a name="line-678"></a><a name="test_qlsa_HsimKernel"></a><font color=Blue><i>-- | Testing function for 'qlsa_HsimKernel'.</i></font>
<a name="line-679"></a><font color=Blue>test_qlsa_HsimKernel</font> <font color=Red>::</font> Bool <font color=Red>-&gt;</font> IO ()
<a name="line-680"></a><font color=Blue>test_qlsa_HsimKernel</font> dummyRTParamFlag <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-681"></a>    <font color=Green><u>let</u></font> param <font color=Red>=</font> <font color=Green><u>if</u></font> dummyRTParamFlag <font color=Green><u>then</u></font> dummy_RT_param <font color=Green><u>else</u></font> large_RT_param
<a name="line-682"></a>    <font color=Green><u>let</u></font> oracleARunTime <font color=Red>=</font> <font color=Cyan>(</font>oracle_A dummy_oracle param<font color=Cyan>)</font> 
<a name="line-683"></a>    <font color=Green><u>let</u></font> testCirc <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-684"></a>              t <font color=Red>&lt;-</font> qinit <font color=Cyan>(</font>take <font color=Cyan>(</font>n0 param<font color=Cyan>)</font> <font color=Cyan>(</font>repeat False<font color=Cyan>)</font><font color=Cyan>)</font>
<a name="line-685"></a>              x <font color=Red>&lt;-</font> qinit <font color=Cyan>(</font>take <font color=Cyan>(</font>n4 param<font color=Cyan>)</font> <font color=Cyan>(</font>repeat False<font color=Cyan>)</font><font color=Cyan>)</font>
<a name="line-686"></a>              label<font color=Cyan>(</font>t<font color=Cyan>,</font>x<font color=Cyan>)</font> <font color=Cyan>(</font><font color=Magenta>"t"</font><font color=Cyan>,</font> <font color=Magenta>"x"</font><font color=Cyan>)</font>
<a name="line-687"></a>              qlsa_HsimKernel param <font color=Cyan>(</font>t<font color=Cyan>,</font>x<font color=Cyan>)</font> <font color=Magenta>1</font> <font color=Magenta>0.1</font> oracleARunTime
<a name="line-688"></a>    print_simple GateCount testCirc
<a name="line-689"></a><font color=Blue><i>--    print_simple Preview testCirc</i></font>
<a name="line-690"></a>
<a name="line-691"></a>
<a name="line-692"></a><a name="qlsa_ApplyHmag"></a><font color=Blue><i>-- | Applies the magnitude component of coupling elements in a</i></font>
<a name="line-693"></a><font color=Blue><i>-- 1-sparse Hamiltonian.</i></font>
<a name="line-694"></a><font color=Blue>qlsa_ApplyHmag</font> <font color=Red>::</font> RunTimeParam <font color=Red>-&gt;</font> <font color=Cyan>(</font><font color=Red>[</font>Qubit<font color=Red>]</font><font color=Cyan>,</font> <font color=Red>[</font>Qubit<font color=Red>]</font><font color=Cyan>,</font> <font color=Red>[</font>Qubit<font color=Red>]</font><font color=Cyan>)</font> <font color=Red>-&gt;</font> Double <font color=Red>-&gt;</font> Circ ()
<a name="line-695"></a><font color=Blue>qlsa_ApplyHmag</font> param <font color=Cyan>(</font>x<font color=Cyan>,</font>y<font color=Cyan>,</font>m<font color=Cyan>)</font> phi0 <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-696"></a>  <font color=Green><u>_</u></font> <font color=Red>&lt;-</font> <font color=Cyan>(</font>flip <font color=Cyan>$</font> box <font color=Cyan>(</font><font color=Magenta>"qlsa_ApplyHmag "</font> <font color=Cyan>++</font> <font color=Cyan>(</font>show phi0<font color=Cyan>)</font><font color=Cyan>)</font><font color=Cyan>)</font> <font color=Cyan>(</font>x<font color=Cyan>,</font>y<font color=Cyan>,</font>m<font color=Cyan>)</font> <font color=Cyan>$</font> <font color=Red>\</font><font color=Cyan>(</font>x<font color=Cyan>,</font>y<font color=Cyan>,</font>m<font color=Cyan>)</font> <font color=Red>-&gt;</font> <font color=Green><u>do</u></font>
<a name="line-697"></a>    <font color=Green><u>let</u></font> <font color=Cyan>(</font>onOne<font color=Cyan>,</font> onZero<font color=Cyan>)</font> <font color=Red>=</font> <font color=Cyan>(</font>True<font color=Cyan>,</font> False<font color=Cyan>)</font>
<a name="line-698"></a>    with_ancilla <font color=Cyan>$</font> <font color=Red>\</font>a <font color=Red>-&gt;</font> <font color=Green><u>do</u></font> <font color=Blue><i>-- Assume initialized to False (0)</i></font>
<a name="line-699"></a>        label <font color=Cyan>(</font>a<font color=Cyan>)</font> <font color=Cyan>(</font><font color=Magenta>"anc. a"</font><font color=Cyan>)</font>
<a name="line-700"></a>        <font color=Green><u>if</u></font> <font color=Cyan>(</font>length x <font color=Cyan>/=</font> length y<font color=Cyan>)</font> 
<a name="line-701"></a>           <font color=Green><u>then</u></font> error <font color=Magenta>"qlsa_ApplyHmag: Input registers x and y have different lengths."</font> 
<a name="line-702"></a>           <font color=Green><u>else</u></font> return ()
<a name="line-703"></a>        <font color=Green><u>let</u></font> length_xy <font color=Red>=</font> length x
<a name="line-704"></a>        for <font color=Magenta>0</font> <font color=Cyan>(</font>length_xy <font color=Blue><i>-</i></font> <font color=Magenta>1</font><font color=Cyan>)</font> <font color=Magenta>1</font> <font color=Cyan>$</font> <font color=Red>\</font>ii <font color=Red>-&gt;</font> <font color=Green><u>do</u></font>
<a name="line-705"></a>            <font color=Green><u>let</u></font> <font color=Cyan>(</font>xi<font color=Cyan>,</font> yi<font color=Cyan>)</font> <font color=Red>=</font> <font color=Cyan>(</font>x <font color=Cyan>!!</font> ii<font color=Cyan>,</font> y <font color=Cyan>!!</font> ii<font color=Cyan>)</font>
<a name="line-706"></a>            w <font color=Cyan>(</font>xi<font color=Cyan>,</font> yi<font color=Cyan>)</font>
<a name="line-707"></a>            qnot_at a <font color=Cyan>`controlled`</font> <font color=Cyan>(</font>xi <font color=Cyan>.==.</font> onOne <font color=Cyan>.&amp;&amp;.</font> yi <font color=Cyan>.==.</font> onZero<font color=Cyan>)</font>
<a name="line-708"></a>            endfor
<a name="line-709"></a>        qlsa_ControlledPhase <font color=Cyan>(</font>m <font color=Cyan>++</font> <font color=Red>[</font>a<font color=Red>]</font><font color=Cyan>)</font> phi0 False
<a name="line-710"></a>        for <font color=Cyan>(</font>length_xy <font color=Blue><i>-</i></font> <font color=Magenta>1</font><font color=Cyan>)</font> <font color=Magenta>0</font> <font color=Cyan>(</font><font color=Blue><i>-</i></font><font color=Magenta>1</font><font color=Cyan>)</font> <font color=Cyan>$</font> <font color=Red>\</font>ii <font color=Red>-&gt;</font> <font color=Green><u>do</u></font>
<a name="line-711"></a>            <font color=Green><u>let</u></font> <font color=Cyan>(</font>xi<font color=Cyan>,</font> yi<font color=Cyan>)</font> <font color=Red>=</font> <font color=Cyan>(</font>x <font color=Cyan>!!</font> ii<font color=Cyan>,</font> y <font color=Cyan>!!</font> ii<font color=Cyan>)</font>
<a name="line-712"></a>            qnot_at a <font color=Cyan>`controlled`</font> <font color=Cyan>(</font>xi <font color=Cyan>.==.</font> onOne <font color=Cyan>.&amp;&amp;.</font> yi <font color=Cyan>.==.</font> onZero<font color=Cyan>)</font>
<a name="line-713"></a>            w <font color=Cyan>(</font>xi<font color=Cyan>,</font> yi<font color=Cyan>)</font>
<a name="line-714"></a>            endfor 
<a name="line-715"></a>        return ()
<a name="line-716"></a>    return <font color=Cyan>(</font>x<font color=Cyan>,</font>y<font color=Cyan>,</font>m<font color=Cyan>)</font>
<a name="line-717"></a>  return ()
<a name="line-718"></a>
<a name="line-719"></a>
<a name="line-720"></a><a name="test_qlsa_ApplyHmag"></a><font color=Blue><i>-- | Testing function for 'qlsa_ApplyHmag'.</i></font>
<a name="line-721"></a><font color=Blue>test_qlsa_ApplyHmag</font> <font color=Red>::</font> Bool <font color=Red>-&gt;</font> IO ()
<a name="line-722"></a><font color=Blue>test_qlsa_ApplyHmag</font> dummyRTParamFlag <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-723"></a>    <font color=Green><u>let</u></font> param <font color=Red>=</font> <font color=Green><u>if</u></font> dummyRTParamFlag <font color=Green><u>then</u></font> dummy_RT_param <font color=Green><u>else</u></font> large_RT_param
<a name="line-724"></a>    <font color=Green><u>let</u></font> testCirc <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-725"></a>              x <font color=Red>&lt;-</font> qinit <font color=Cyan>(</font>take <font color=Cyan>(</font>n2 param<font color=Cyan>)</font> <font color=Cyan>(</font>repeat False<font color=Cyan>)</font><font color=Cyan>)</font>
<a name="line-726"></a>              y <font color=Red>&lt;-</font> qinit <font color=Cyan>(</font>take <font color=Cyan>(</font>n2 param<font color=Cyan>)</font> <font color=Cyan>(</font>repeat False<font color=Cyan>)</font><font color=Cyan>)</font>
<a name="line-727"></a>              m <font color=Red>&lt;-</font> qinit <font color=Cyan>(</font>take <font color=Cyan>(</font>n4 param<font color=Cyan>)</font> <font color=Cyan>(</font>repeat False<font color=Cyan>)</font><font color=Cyan>)</font>
<a name="line-728"></a>              label<font color=Cyan>(</font>x<font color=Cyan>,</font>y<font color=Cyan>,</font>m<font color=Cyan>)</font> <font color=Cyan>(</font><font color=Magenta>"x"</font><font color=Cyan>,</font> <font color=Magenta>"y"</font><font color=Cyan>,</font> <font color=Magenta>"m"</font><font color=Cyan>)</font>
<a name="line-729"></a>              qlsa_ApplyHmag param <font color=Cyan>(</font>x<font color=Cyan>,</font>y<font color=Cyan>,</font>m<font color=Cyan>)</font> <font color=Magenta>0.1</font> 
<a name="line-730"></a>    print_simple GateCount testCirc
<a name="line-731"></a>    print_simple Preview testCirc
<a name="line-732"></a>
<a name="line-733"></a>
<a name="line-734"></a>
<a name="line-735"></a>
<a name="line-736"></a>
<a name="line-737"></a><a name="w"></a><font color=Blue><i>-- | Auxiliary function: the /W/-gate.</i></font>
<a name="line-738"></a><font color=Blue>w</font> <font color=Red>::</font> <font color=Cyan>(</font>Qubit<font color=Cyan>,</font> Qubit<font color=Cyan>)</font> <font color=Red>-&gt;</font> Circ ()
<a name="line-739"></a><font color=Blue><i>-- w xy = named_gate_at "W" xy</i></font>
<a name="line-740"></a><font color=Blue>w</font> <font color=Cyan>(</font>xi<font color=Cyan>,</font>yi<font color=Cyan>)</font> <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-741"></a>  <font color=Green><u>_</u></font> <font color=Red>&lt;-</font> box <font color=Magenta>"w"</font> <font color=Cyan>(</font><font color=Red>\</font><font color=Cyan>(</font>xi<font color=Cyan>,</font> yi<font color=Cyan>)</font> <font color=Red>-&gt;</font> <font color=Green><u>do</u></font>
<a name="line-742"></a>    label <font color=Cyan>(</font>xi<font color=Cyan>,</font>yi<font color=Cyan>)</font> <font color=Cyan>(</font><font color=Magenta>"x[i]"</font><font color=Cyan>,</font><font color=Magenta>"y[i]"</font><font color=Cyan>)</font>
<a name="line-743"></a>    gate_X_at xi <font color=Cyan>`controlled`</font> yi
<a name="line-744"></a>    gate_X_at yi <font color=Cyan>`controlled`</font> xi
<a name="line-745"></a>    hadamard_at yi <font color=Cyan>`controlled`</font> xi
<a name="line-746"></a>    gate_X_at yi <font color=Cyan>`controlled`</font> xi
<a name="line-747"></a>    gate_X_at xi <font color=Cyan>`controlled`</font> yi
<a name="line-748"></a>    return <font color=Cyan>(</font>xi<font color=Cyan>,</font>yi<font color=Cyan>)</font><font color=Cyan>)</font> <font color=Cyan>(</font>xi<font color=Cyan>,</font>yi<font color=Cyan>)</font>
<a name="line-749"></a>  return ()
<a name="line-750"></a>
<a name="line-751"></a><a name="test_w"></a><font color=Blue><i>-- | Testing function for 'w'.</i></font>
<a name="line-752"></a><font color=Blue>test_w</font> <font color=Red>::</font> IO ()
<a name="line-753"></a><font color=Blue>test_w</font> <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-754"></a>    <font color=Green><u>let</u></font> testCirc <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-755"></a>        xi <font color=Red>&lt;-</font> qinit False    
<a name="line-756"></a>        yi <font color=Red>&lt;-</font> qinit False
<a name="line-757"></a>        w <font color=Cyan>(</font>xi<font color=Cyan>,</font> yi<font color=Cyan>)</font>
<a name="line-758"></a>    print_simple GateCount testCirc
<a name="line-759"></a>    print_simple Preview testCirc
<a name="line-760"></a>
<a name="line-761"></a>
<a name="line-762"></a><font color=Blue><i>-- * Controlled Logic Operations</i></font>
<a name="line-763"></a>
<a name="line-764"></a>
<a name="line-765"></a><font color=Blue><i>-- | Applies a phase shift of &#966;\/2 to the signed input register |&#966;&#9002;.</i></font>
<a name="line-766"></a>
<a name="line-767"></a><a name="qlsa_ControlledPhase"></a><font color=Blue><i>-- For c, bit locations are counted starting from 0 (least significant) to (length c - 2) (most significant)</i></font>
<a name="line-768"></a><font color=Blue><i>-- last c (or c !! (n-1)) is the sign bit</i></font>
<a name="line-769"></a><font color=Blue>qlsa_ControlledPhase</font> <font color=Red>::</font> <font color=Red>[</font>Qubit<font color=Red>]</font> <font color=Red>-&gt;</font> Double <font color=Red>-&gt;</font> Bool <font color=Red>-&gt;</font> Circ ()
<a name="line-770"></a><font color=Blue><i>-- qlsa_ControlledPhase c phi0 f = named_gate_at "CPhase" c</i></font>
<a name="line-771"></a><font color=Blue>qlsa_ControlledPhase</font> c phi0 f <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-772"></a>  <font color=Green><u>_</u></font> <font color=Red>&lt;-</font> <font color=Cyan>(</font>flip <font color=Cyan>$</font> box <font color=Cyan>(</font><font color=Magenta>"qlsa_ControlledPhase "</font> <font color=Cyan>++</font> <font color=Cyan>(</font>show phi0<font color=Cyan>)</font> <font color=Cyan>++</font> <font color=Magenta>" "</font> <font color=Cyan>++</font> <font color=Cyan>(</font>show f<font color=Cyan>)</font><font color=Cyan>)</font><font color=Cyan>)</font> c <font color=Cyan>$</font> <font color=Red>\</font>c <font color=Red>-&gt;</font> <font color=Green><u>do</u></font>
<a name="line-773"></a>    with_ancilla <font color=Cyan>$</font> <font color=Red>\</font>a <font color=Red>-&gt;</font> <font color=Green><u>do</u></font> <font color=Blue><i>-- ancilla is initialized to False</i></font>
<a name="line-774"></a>        <font color=Green><u>if</u></font> f <font color=Green><u>then</u></font> <font color=Cyan>(</font>qnot_at a<font color=Cyan>)</font> <font color=Green><u>else</u></font> return ()
<a name="line-775"></a>        <font color=Green><u>let</u></font> signQubit <font color=Red>=</font> last c
<a name="line-776"></a>        qnot_at a <font color=Cyan>`controlled`</font> signQubit
<a name="line-777"></a>        for <font color=Magenta>0</font> <font color=Cyan>(</font>length c <font color=Blue><i>-</i></font> <font color=Magenta>2</font><font color=Cyan>)</font> <font color=Magenta>1</font> <font color=Cyan>$</font> <font color=Red>\</font>ii <font color=Red>-&gt;</font> <font color=Green><u>do</u></font> 
<a name="line-778"></a>            <font color=Green><u>let</u></font> theta <font color=Red>=</font> <font color=Cyan>(</font> <font color=Cyan>(</font><font color=Magenta>2.0</font><font color=Cyan>^</font><font color=Cyan>(</font>ii<font color=Cyan>)</font><font color=Cyan>)</font> <font color=Cyan>*</font> phi0 <font color=Cyan>/</font> <font color=Magenta>2.0</font><font color=Cyan>)</font> <font color=Blue><i>-- Note the divide by 2</i></font>
<a name="line-779"></a>            <font color=Blue><i>-- The following three lines are equivalent</i></font>
<a name="line-780"></a>            expZt_at theta a <font color=Cyan>`controlled`</font> <font color=Cyan>(</font>c <font color=Cyan>!!</font> ii<font color=Cyan>)</font>
<a name="line-781"></a>            <font color=Blue><i>-- a &lt;- expZt theta a `controlled` (c !! ii); return ()</i></font>
<a name="line-782"></a>            <font color=Blue><i>-- qlsa_ControlledU (c !! ii, a) (expZt theta) False    </i></font>
<a name="line-783"></a>            endfor
<a name="line-784"></a>        qnot_at a <font color=Cyan>`controlled`</font> signQubit  
<a name="line-785"></a>        return c
<a name="line-786"></a>  return ()
<a name="line-787"></a>
<a name="line-788"></a>
<a name="line-789"></a><a name="qlsa_ControlledRotation"></a><font color=Blue><i>-- | Applies a rotation of &#966;\/2 to the signed input register |&#966;&#9002;.</i></font>
<a name="line-790"></a><font color=Blue>qlsa_ControlledRotation</font> <font color=Red>::</font> <font color=Cyan>(</font><font color=Red>[</font>Qubit<font color=Red>]</font><font color=Cyan>,</font> Qubit<font color=Cyan>)</font> <font color=Red>-&gt;</font> Double <font color=Red>-&gt;</font> Bool <font color=Red>-&gt;</font> Circ ()
<a name="line-791"></a><font color=Blue><i>-- qlsa_ControlledRotation ct phi0 f = named_gate_at "CRotate" ct</i></font>
<a name="line-792"></a><font color=Blue>qlsa_ControlledRotation</font> <font color=Cyan>(</font>c<font color=Cyan>,</font> t<font color=Cyan>)</font> phi0 f <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-793"></a>  <font color=Green><u>_</u></font> <font color=Red>&lt;-</font> <font color=Cyan>(</font>flip <font color=Cyan>$</font> box <font color=Cyan>(</font><font color=Magenta>"qlsa_ControlledRotation "</font> <font color=Cyan>++</font> <font color=Cyan>(</font>show phi0<font color=Cyan>)</font> <font color=Cyan>++</font> <font color=Magenta>" "</font> <font color=Cyan>++</font> <font color=Cyan>(</font>show f<font color=Cyan>)</font><font color=Cyan>)</font><font color=Cyan>)</font> <font color=Cyan>(</font>c<font color=Cyan>,</font>t<font color=Cyan>)</font> <font color=Cyan>$</font> <font color=Red>\</font><font color=Cyan>(</font>c<font color=Cyan>,</font>t<font color=Cyan>)</font> <font color=Red>-&gt;</font> <font color=Green><u>do</u></font>
<a name="line-794"></a>    <font color=Green><u>if</u></font> f <font color=Green><u>then</u></font> <font color=Cyan>(</font>qnot_at t<font color=Cyan>)</font> <font color=Green><u>else</u></font> return ()
<a name="line-795"></a>    <font color=Green><u>let</u></font> signQubit <font color=Red>=</font> last c
<a name="line-796"></a>    qnot_at t <font color=Cyan>`controlled`</font> signQubit
<a name="line-797"></a>    for <font color=Magenta>0</font> <font color=Cyan>(</font>length c <font color=Blue><i>-</i></font> <font color=Magenta>2</font><font color=Cyan>)</font> <font color=Magenta>1</font> <font color=Cyan>$</font> <font color=Red>\</font>ii <font color=Red>-&gt;</font> <font color=Green><u>do</u></font>
<a name="line-798"></a>        <font color=Green><u>let</u></font> theta <font color=Red>=</font> <font color=Cyan>(</font><font color=Magenta>2.0</font><font color=Cyan>^</font><font color=Cyan>(</font>ii<font color=Cyan>)</font><font color=Cyan>)</font> <font color=Cyan>*</font> phi0 <font color=Cyan>/</font> <font color=Magenta>2.0</font>
<a name="line-799"></a>        expYt_at theta t <font color=Cyan>`controlled`</font> <font color=Cyan>(</font>c <font color=Cyan>!!</font> ii<font color=Cyan>)</font>
<a name="line-800"></a>        endfor
<a name="line-801"></a>    qnot_at t <font color=Cyan>`controlled`</font> signQubit
<a name="line-802"></a>    <font color=Green><u>if</u></font> f <font color=Green><u>then</u></font> <font color=Cyan>(</font>qnot_at t<font color=Cyan>)</font> <font color=Green><u>else</u></font> return ()
<a name="line-803"></a>    return <font color=Cyan>(</font>c<font color=Cyan>,</font>t<font color=Cyan>)</font>
<a name="line-804"></a>  return ()
<a name="line-805"></a>
<a name="line-806"></a>
<a name="line-807"></a><font color=Blue><i>----------------------------------------------------------------------</i></font>
<a name="line-808"></a><font color=Blue><i>-- * Oracles</i></font>
<a name="line-809"></a>
<a name="line-810"></a><a name="make_factor_rep"></a><font color=Blue><i>-- | Map a 'QDouble' into an integer, understood as being scaled by</i></font>
<a name="line-811"></a><font color=Blue><i>-- the given factor. Take the factor and the size of the output</i></font>
<a name="line-812"></a><font color=Blue><i>-- register as parameter.</i></font>
<a name="line-813"></a><font color=Blue>make_factor_rep</font> <font color=Red>::</font> Double <font color=Red>-&gt;</font> Int <font color=Red>-&gt;</font> QDouble <font color=Red>-&gt;</font> Circ <font color=Red>[</font>Qubit<font color=Red>]</font>
<a name="line-814"></a><font color=Blue>make_factor_rep</font> factor size p <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-815"></a>     <font color=Blue><i>-- number of high bits of p</i></font>
<a name="line-816"></a>     <font color=Green><u>let</u></font> p_int_size <font color=Red>=</font> <font color=Cyan>(</font>xdouble_length p<font color=Cyan>)</font> <font color=Blue><i>-</i></font> <font color=Cyan>(</font>xdouble_exponent p<font color=Cyan>)</font>
<a name="line-817"></a>     <font color=Blue><i>-- get the required number of bits for doing the encoding</i></font>
<a name="line-818"></a>     <font color=Green><u>let</u></font> auxsize <font color=Red>=</font> max <font color=Cyan>(</font>size <font color=Blue><i>-</i></font> <font color=Magenta>1</font><font color=Cyan>)</font> p_int_size
<a name="line-819"></a>     <font color=Blue><i>-- do the operation:</i></font>
<a name="line-820"></a>     <font color=Blue><i>--    (1) build a QDouble from the factor: need (size-1) bits of integer part</i></font>
<a name="line-821"></a>     qfactor <font color=Red>&lt;-</font> qinit <font color=Cyan>$</font> fdouble_of_double <font color=Cyan>(</font>xdouble_exponent p<font color=Cyan>)</font> 
<a name="line-822"></a>                                          <font color=Cyan>(</font>auxsize <font color=Cyan>+</font> xdouble_exponent p<font color=Cyan>)</font> factor
<a name="line-823"></a>     <font color=Blue><i>--    (2) scale p</i></font>
<a name="line-824"></a>     p_large <font color=Red>&lt;-</font> qdouble_pad_to_extent <font color=Cyan>(</font>auxsize<font color=Cyan>,</font><font color=Blue><i>-</i></font> <font color=Cyan>(</font>xdouble_exponent p<font color=Cyan>)</font><font color=Cyan>)</font> p
<a name="line-825"></a>     <font color=Blue><i>--    (3) divide p by factor</i></font>
<a name="line-826"></a>     qreal_multiples <font color=Red>&lt;-</font> unpack template_symb_slash_ p_large qfactor
<a name="line-827"></a>     <font color=Blue><i>--    (4) get the floor of the result</i></font>
<a name="line-828"></a>     q_floor <font color=Red>&lt;-</font> template_floor
<a name="line-829"></a>     qmultiples <font color=Red>&lt;-</font> q_floor qreal_multiples
<a name="line-830"></a>     <font color=Blue><i>--    (5) set them in the right format (it has size elements)</i></font>
<a name="line-831"></a>     <font color=Green><u>let</u></font> <font color=Cyan>(</font>SInt tp bp<font color=Cyan>)</font> <font color=Red>=</font> qmultiples
<a name="line-832"></a>     <font color=Green><u>let</u></font> new_p <font color=Red>=</font> <font color=Cyan>(</font>take <font color=Cyan>(</font>size <font color=Blue><i>-</i></font> <font color=Magenta>1</font><font color=Cyan>)</font> <font color=Cyan>$</font> reverse tp<font color=Cyan>)</font> <font color=Cyan>++</font> <font color=Red>[</font>bp<font color=Red>]</font>
<a name="line-833"></a>     return new_p
<a name="line-834"></a>
<a name="line-835"></a>
<a name="line-836"></a>
<a name="line-837"></a><a name="inline_oracle_r"></a><font color=Blue><i>-- | Implements the oracle for the arbitrary state |/r/&#9002;, using the</i></font>
<a name="line-838"></a><font color=Blue><i>-- Template Haskell implementation of 'calcRweights'.</i></font>
<a name="line-839"></a><font color=Blue>inline_oracle_r</font> <font color=Red>::</font> RunTimeParam <font color=Red>-&gt;</font> Double <font color=Red>-&gt;</font> Double <font color=Red>-&gt;</font> <font color=Cyan>(</font><font color=Red>[</font>Qubit<font color=Red>]</font><font color=Cyan>,</font><font color=Red>[</font>Qubit<font color=Red>]</font><font color=Cyan>,</font><font color=Red>[</font>Qubit<font color=Red>]</font><font color=Cyan>)</font> <font color=Red>-&gt;</font> Circ <font color=Cyan>(</font><font color=Red>[</font>Qubit<font color=Red>]</font><font color=Cyan>,</font><font color=Red>[</font>Qubit<font color=Red>]</font><font color=Cyan>,</font><font color=Red>[</font>Qubit<font color=Red>]</font><font color=Cyan>)</font>
<a name="line-840"></a><font color=Blue>inline_oracle_r</font> rt factor_m factor_p <font color=Red>=</font>  box <font color=Cyan>(</font><font color=Magenta>"Or "</font> <font color=Cyan>++</font> <font color=Cyan>(</font>show factor_m<font color=Cyan>)</font> <font color=Cyan>++</font> <font color=Magenta>" "</font> <font color=Cyan>++</font> <font color=Cyan>(</font>show factor_p<font color=Cyan>)</font><font color=Cyan>)</font> <font color=Cyan>$</font> decompose_generic Toffoli <font color=Cyan>$</font> <font color=Red>\</font><font color=Cyan>(</font>x'<font color=Cyan>,</font>m'<font color=Cyan>,</font>p'<font color=Cyan>)</font> <font color=Red>-&gt;</font>
<a name="line-841"></a>    with_ancilla_init <font color=Cyan>(</font>fromIntegral <font color=Cyan>$</font> nx rt <font color=Red>::</font> FSignedInt<font color=Cyan>)</font> <font color=Cyan>$</font> <font color=Red>\</font>qnx <font color=Red>-&gt;</font> 
<a name="line-842"></a>     with_ancilla_init <font color=Cyan>(</font>fromIntegral <font color=Cyan>$</font> ny rt <font color=Red>::</font> FSignedInt<font color=Cyan>)</font> <font color=Cyan>$</font> <font color=Red>\</font>qny <font color=Red>-&gt;</font> 
<a name="line-843"></a>      with_ancilla_init <font color=Cyan>(</font>fdouble <font color=Cyan>$</font> lx rt<font color=Cyan>)</font> <font color=Cyan>$</font> <font color=Red>\</font>qlx <font color=Red>-&gt;</font>
<a name="line-844"></a>       with_ancilla_init <font color=Cyan>(</font>fdouble <font color=Cyan>$</font> ly rt<font color=Cyan>)</font> <font color=Cyan>$</font> <font color=Red>\</font>qly <font color=Red>-&gt;</font>
<a name="line-845"></a>        with_ancilla_init <font color=Cyan>(</font>fdouble <font color=Cyan>$</font> k rt<font color=Cyan>)</font> <font color=Cyan>$</font> <font color=Red>\</font>qk <font color=Red>-&gt;</font>
<a name="line-846"></a>         with_ancilla_init <font color=Cyan>(</font>fdouble <font color=Cyan>$</font> theta rt<font color=Cyan>)</font> <font color=Cyan>$</font> <font color=Red>\</font>qtheta <font color=Red>-&gt;</font>
<a name="line-847"></a>          with_ancilla_init <font color=Cyan>(</font>fdouble <font color=Cyan>$</font> phi rt<font color=Cyan>)</font> <font color=Cyan>$</font> <font color=Red>\</font>qphi <font color=Red>-&gt;</font> 
<a name="line-848"></a>                <font color=Blue><i>-- the x register is smaller than the size of a QSInt,</i></font>
<a name="line-849"></a>                <font color=Blue><i>-- and x is an unsigned integer: make up a positive</i></font>
<a name="line-850"></a>                <font color=Blue><i>-- sign and a pad</i></font>
<a name="line-851"></a>                
<a name="line-852"></a>                with_ancilla_init False <font color=Cyan>$</font> <font color=Red>\</font>bx <font color=Red>-&gt;</font> <font color=Green><u>do</u></font>
<a name="line-853"></a>                  with_ancilla_init <font color=Cyan>(</font>replicate <font color=Cyan>(</font>fixed_int_register_length <font color=Blue><i>-</i></font> <font color=Cyan>(</font>n2 rt<font color=Cyan>)</font><font color=Cyan>)</font> 
<a name="line-854"></a>                                               False<font color=Cyan>)</font> <font color=Cyan>$</font> <font color=Red>\</font>pad_x <font color=Red>-&gt;</font> <font color=Green><u>do</u></font>
<a name="line-855"></a>                    
<a name="line-856"></a>                    <font color=Green><u>let</u></font> x <font color=Red>=</font> SInt <font color=Cyan>(</font>pad_x <font color=Cyan>++</font> <font color=Cyan>(</font>reverse x'<font color=Cyan>)</font><font color=Cyan>)</font> bx
<a name="line-857"></a>                    <font color=Green><u>let</u></font> f <font color=Red>=</font> classical_to_reversible <font color=Cyan>$</font> 
<a name="line-858"></a>                              <font color=Red>\</font><font color=Cyan>(</font>x<font color=Cyan>,</font>nx<font color=Cyan>,</font>ny<font color=Cyan>,</font>lx<font color=Cyan>,</font>ly<font color=Cyan>,</font>k<font color=Cyan>,</font>theta<font color=Cyan>,</font>phi<font color=Cyan>)</font> <font color=Red>-&gt;</font> <font color=Green><u>do</u></font> 
<a name="line-859"></a>                                 <font color=Cyan>(</font>m<font color=Cyan>,</font>p<font color=Cyan>)</font> <font color=Red>&lt;-</font> unpack Template<font color=Cyan>.</font>template_calcRweights 
<a name="line-860"></a>                                            x nx ny lx ly k theta phi
<a name="line-861"></a>                                 new_p <font color=Red>&lt;-</font> make_factor_rep factor_p <font color=Cyan>(</font>n4 rt<font color=Cyan>)</font> p
<a name="line-862"></a>                                 new_m <font color=Red>&lt;-</font> make_factor_rep factor_m <font color=Cyan>(</font>n4 rt<font color=Cyan>)</font> m
<a name="line-863"></a>                                 return <font color=Cyan>(</font>new_m<font color=Cyan>,</font> new_p<font color=Cyan>)</font>
<a name="line-864"></a>                    f <font color=Cyan>(</font><font color=Cyan>(</font>x<font color=Cyan>,</font>qnx<font color=Cyan>,</font>qny<font color=Cyan>,</font>qlx<font color=Cyan>,</font>qly<font color=Cyan>,</font>qk<font color=Cyan>,</font>qtheta<font color=Cyan>,</font>qphi<font color=Cyan>)</font><font color=Cyan>,</font><font color=Cyan>(</font>m'<font color=Cyan>,</font>p'<font color=Cyan>)</font><font color=Cyan>)</font>
<a name="line-865"></a>                    return <font color=Cyan>(</font>x'<font color=Cyan>,</font>m'<font color=Cyan>,</font>p'<font color=Cyan>)</font>
<a name="line-866"></a>
<a name="line-867"></a>
<a name="line-868"></a>
<a name="line-869"></a>
<a name="line-870"></a>
<a name="line-871"></a><a name="inline_oracle_b"></a><font color=Blue><i>-- | Implements the oracle for the known state |/b/&#9002;, using the</i></font>
<a name="line-872"></a><font color=Blue><i>-- Template Haskell implementation of 'getKnownWeights'.</i></font>
<a name="line-873"></a><font color=Blue>inline_oracle_b</font> <font color=Red>::</font> RunTimeParam <font color=Red>-&gt;</font> Double <font color=Red>-&gt;</font> Double <font color=Red>-&gt;</font> <font color=Cyan>(</font><font color=Red>[</font>Qubit<font color=Red>]</font><font color=Cyan>,</font><font color=Red>[</font>Qubit<font color=Red>]</font><font color=Cyan>,</font><font color=Red>[</font>Qubit<font color=Red>]</font><font color=Cyan>)</font> <font color=Red>-&gt;</font> Circ <font color=Cyan>(</font><font color=Red>[</font>Qubit<font color=Red>]</font><font color=Cyan>,</font><font color=Red>[</font>Qubit<font color=Red>]</font><font color=Cyan>,</font><font color=Red>[</font>Qubit<font color=Red>]</font><font color=Cyan>)</font>
<a name="line-874"></a><font color=Blue>inline_oracle_b</font> rt factor_m factor_p <font color=Red>=</font> box <font color=Cyan>(</font><font color=Magenta>"Ob "</font> <font color=Cyan>++</font> <font color=Cyan>(</font>show factor_m<font color=Cyan>)</font> <font color=Cyan>++</font> <font color=Magenta>" "</font> <font color=Cyan>++</font> <font color=Cyan>(</font>show factor_p<font color=Cyan>)</font><font color=Cyan>)</font> <font color=Cyan>$</font> decompose_generic Toffoli <font color=Cyan>$</font> <font color=Red>\</font><font color=Cyan>(</font>x'<font color=Cyan>,</font>m'<font color=Cyan>,</font>p'<font color=Cyan>)</font> <font color=Red>-&gt;</font> 
<a name="line-875"></a>    <font color=Blue><i>-- Make ancillas for constant values</i></font>
<a name="line-876"></a>    
<a name="line-877"></a>    with_ancilla_init <font color=Cyan>(</font>listpair_fmap fromIntegral <font color=Cyan>$</font> scatteringnodes rt <font color=Red>::</font> <font color=Red>[</font><font color=Cyan>(</font>FDouble<font color=Cyan>,</font>FDouble<font color=Cyan>)</font><font color=Red>]</font><font color=Cyan>)</font> <font color=Cyan>$</font> <font color=Red>\</font>qscatteringnodes <font color=Red>-&gt;</font>
<a name="line-878"></a>     with_ancilla_init <font color=Cyan>(</font>fromIntegral <font color=Cyan>$</font> ny rt <font color=Red>::</font> FSignedInt<font color=Cyan>)</font> <font color=Cyan>$</font> <font color=Red>\</font>qny <font color=Red>-&gt;</font> 
<a name="line-879"></a>      with_ancilla_init <font color=Cyan>(</font>fdouble <font color=Cyan>$</font> lx rt<font color=Cyan>)</font> <font color=Cyan>$</font> <font color=Red>\</font>qlx <font color=Red>-&gt;</font>
<a name="line-880"></a>       with_ancilla_init <font color=Cyan>(</font>fdouble <font color=Cyan>$</font> ly rt<font color=Cyan>)</font> <font color=Cyan>$</font> <font color=Red>\</font>qly <font color=Red>-&gt;</font>
<a name="line-881"></a>        with_ancilla_init <font color=Cyan>(</font>fdouble <font color=Cyan>$</font> k rt<font color=Cyan>)</font> <font color=Cyan>$</font> <font color=Red>\</font>qk <font color=Red>-&gt;</font>
<a name="line-882"></a>         with_ancilla_init <font color=Cyan>(</font>fdouble <font color=Cyan>$</font> theta rt<font color=Cyan>)</font> <font color=Cyan>$</font> <font color=Red>\</font>qtheta <font color=Red>-&gt;</font>
<a name="line-883"></a>          with_ancilla_init <font color=Cyan>(</font>fdouble <font color=Cyan>$</font> e0 rt<font color=Cyan>)</font> <font color=Cyan>$</font> <font color=Red>\</font>qe0 <font color=Red>-&gt;</font>
<a name="line-884"></a>           with_ancilla_init <font color=Cyan>(</font>fromIntegral <font color=Cyan>$</font> nx rt <font color=Red>::</font> FSignedInt<font color=Cyan>)</font> <font color=Cyan>$</font> <font color=Red>\</font>qnx <font color=Red>-&gt;</font> <font color=Green><u>do</u></font>
<a name="line-885"></a>
<a name="line-886"></a>                <font color=Blue><i>-- the x register is smaller than the size of a QSInt,</i></font>
<a name="line-887"></a>                <font color=Blue><i>-- and x is an unsigned integer: make up a positive</i></font>
<a name="line-888"></a>                <font color=Blue><i>-- sign and a pad</i></font>
<a name="line-889"></a>                
<a name="line-890"></a>                with_ancilla_init False <font color=Cyan>$</font> <font color=Red>\</font>bx <font color=Red>-&gt;</font> <font color=Green><u>do</u></font>
<a name="line-891"></a>                  with_ancilla_init <font color=Cyan>(</font>replicate <font color=Cyan>(</font>fixed_int_register_length <font color=Blue><i>-</i></font> <font color=Cyan>(</font>n2 rt<font color=Cyan>)</font><font color=Cyan>)</font> 
<a name="line-892"></a>                                               False<font color=Cyan>)</font> <font color=Cyan>$</font> <font color=Red>\</font>pad_x <font color=Red>-&gt;</font> <font color=Green><u>do</u></font>
<a name="line-893"></a>                    
<a name="line-894"></a>                    <font color=Green><u>let</u></font> x <font color=Red>=</font> SInt <font color=Cyan>(</font>pad_x <font color=Cyan>++</font> <font color=Cyan>(</font>reverse x'<font color=Cyan>)</font><font color=Cyan>)</font> bx
<a name="line-895"></a>                    
<a name="line-896"></a>                    <font color=Green><u>let</u></font> f <font color=Red>=</font> classical_to_reversible <font color=Cyan>$</font> 
<a name="line-897"></a>                              <font color=Red>\</font><font color=Cyan>(</font>y<font color=Cyan>,</font>nx<font color=Cyan>,</font>ny<font color=Cyan>,</font>scatteringnodes<font color=Cyan>,</font>lx<font color=Cyan>,</font>ly<font color=Cyan>,</font>k<font color=Cyan>,</font>theta<font color=Cyan>,</font>e0<font color=Cyan>)</font> <font color=Red>-&gt;</font> <font color=Green><u>do</u></font>
<a name="line-898"></a>                                  <font color=Blue><i>-- get some QSInt and QDouble</i></font>
<a name="line-899"></a>                                  <font color=Cyan>(</font>m<font color=Cyan>,</font>p<font color=Cyan>)</font> <font color=Red>&lt;-</font> unpack Template<font color=Cyan>.</font>template_getKnownWeights 
<a name="line-900"></a>                                              y nx ny scatteringnodes lx ly k theta e0 <font color=Magenta>7</font>
<a name="line-901"></a>                                  new_p <font color=Red>&lt;-</font> make_factor_rep factor_p <font color=Cyan>(</font>n4 rt<font color=Cyan>)</font> p
<a name="line-902"></a>                                  new_m <font color=Red>&lt;-</font> make_factor_rep factor_m <font color=Cyan>(</font>n4 rt<font color=Cyan>)</font> m
<a name="line-903"></a>                                  
<a name="line-904"></a>                                  return <font color=Cyan>(</font>new_m<font color=Cyan>,</font> new_p<font color=Cyan>)</font>
<a name="line-905"></a>                                  
<a name="line-906"></a>                    f <font color=Cyan>(</font><font color=Cyan>(</font>x<font color=Cyan>,</font>qnx<font color=Cyan>,</font>qny<font color=Cyan>,</font>qscatteringnodes<font color=Cyan>,</font>qlx<font color=Cyan>,</font>qly<font color=Cyan>,</font>qk<font color=Cyan>,</font>qtheta<font color=Cyan>,</font>qe0<font color=Cyan>)</font><font color=Cyan>,</font><font color=Cyan>(</font>m'<font color=Cyan>,</font>p'<font color=Cyan>)</font><font color=Cyan>)</font>
<a name="line-907"></a>                    return <font color=Cyan>(</font>x'<font color=Cyan>,</font>m'<font color=Cyan>,</font>p'<font color=Cyan>)</font>
<a name="line-908"></a>
<a name="line-909"></a>
<a name="line-910"></a><a name="inline_oracle_A"></a><font color=Blue><i>-- | Implementation of the oracle calculating the matrix /A/</i></font>
<a name="line-911"></a><font color=Blue><i>-- corresponding to the discretization of the scattering problem,</i></font>
<a name="line-912"></a><font color=Blue><i>-- using the Template Haskell implementation of</i></font>
<a name="line-913"></a><font color=Blue><i>-- 'getNodeValuesMoreOutputs'.</i></font>
<a name="line-914"></a><font color=Blue>inline_oracle_A</font> <font color=Red>::</font>  RunTimeParam <font color=Red>-&gt;</font> Double <font color=Red>-&gt;</font> Int <font color=Red>-&gt;</font> Bool <font color=Red>-&gt;</font> <font color=Cyan>(</font><font color=Red>[</font>Qubit<font color=Red>]</font><font color=Cyan>,</font><font color=Red>[</font>Qubit<font color=Red>]</font><font color=Cyan>,</font><font color=Red>[</font>Qubit<font color=Red>]</font><font color=Cyan>)</font> <font color=Red>-&gt;</font> Circ <font color=Cyan>(</font><font color=Red>[</font>Qubit<font color=Red>]</font><font color=Cyan>,</font><font color=Red>[</font>Qubit<font color=Red>]</font><font color=Cyan>,</font><font color=Red>[</font>Qubit<font color=Red>]</font><font color=Cyan>)</font>
<a name="line-915"></a><font color=Blue>inline_oracle_A</font> rt factor band argflag <font color=Red>=</font>  box <font color=Cyan>(</font><font color=Magenta>"OA "</font> <font color=Cyan>++</font> <font color=Cyan>(</font>show band<font color=Cyan>)</font> <font color=Cyan>++</font> <font color=Magenta>" "</font> <font color=Cyan>++</font> <font color=Cyan>(</font>show argflag<font color=Cyan>)</font><font color=Cyan>)</font> <font color=Cyan>$</font> decompose_generic Toffoli <font color=Cyan>$</font> <font color=Red>\</font><font color=Cyan>(</font>x'<font color=Cyan>,</font>y'<font color=Cyan>,</font>p'<font color=Cyan>)</font> <font color=Red>-&gt;</font> <font color=Green><u>do</u></font>
<a name="line-916"></a>
<a name="line-917"></a>    <font color=Green><u>let</u></font> argflag' <font color=Red>=</font> <font color=Green><u>if</u></font> argflag <font color=Green><u>then</u></font> PTrue <font color=Green><u>else</u></font> PFalse
<a name="line-918"></a>    
<a name="line-919"></a>    <font color=Blue><i>-- Make ancillas for constant values</i></font>
<a name="line-920"></a>    
<a name="line-921"></a>    with_ancilla_init <font color=Cyan>(</font>listpair_fmap fromIntegral <font color=Cyan>$</font> scatteringnodes rt <font color=Red>::</font> <font color=Red>[</font><font color=Cyan>(</font>FDouble<font color=Cyan>,</font> FDouble<font color=Cyan>)</font><font color=Red>]</font><font color=Cyan>)</font> <font color=Cyan>$</font> <font color=Red>\</font>qscatteringnodes <font color=Red>-&gt;</font> 
<a name="line-922"></a>      with_ancilla_init <font color=Cyan>(</font>fromIntegral <font color=Cyan>$</font> ny rt <font color=Red>::</font> FSignedInt<font color=Cyan>)</font> <font color=Cyan>$</font> <font color=Red>\</font>qny <font color=Red>-&gt;</font> 
<a name="line-923"></a>        with_ancilla_init <font color=Cyan>(</font>fromRational <font color=Cyan>$</font> toRational <font color=Cyan>$</font> lx rt<font color=Cyan>)</font> <font color=Cyan>$</font> <font color=Red>\</font>qlx <font color=Red>-&gt;</font>
<a name="line-924"></a>          with_ancilla_init <font color=Cyan>(</font>fromRational <font color=Cyan>$</font> toRational <font color=Cyan>$</font> ly rt<font color=Cyan>)</font> <font color=Cyan>$</font> <font color=Red>\</font>qly <font color=Red>-&gt;</font>
<a name="line-925"></a>            with_ancilla_init <font color=Cyan>(</font>fromRational <font color=Cyan>$</font> toRational <font color=Cyan>$</font> k rt<font color=Cyan>)</font> <font color=Cyan>$</font> <font color=Red>\</font>qk <font color=Red>-&gt;</font>
<a name="line-926"></a>             with_ancilla_init <font color=Cyan>(</font>fromIntegral <font color=Cyan>$</font> nx rt <font color=Red>::</font> FSignedInt<font color=Cyan>)</font> <font color=Cyan>$</font> <font color=Red>\</font>qnx <font color=Red>-&gt;</font> <font color=Green><u>do</u></font>
<a name="line-927"></a>
<a name="line-928"></a>                <font color=Blue><i>-- the x register is smaller than the size of a QSInt,</i></font>
<a name="line-929"></a>                <font color=Blue><i>-- and x is an unsigned integer: make up a positive</i></font>
<a name="line-930"></a>                <font color=Blue><i>-- sign and a pad</i></font>
<a name="line-931"></a>                
<a name="line-932"></a>                with_ancilla_init False <font color=Cyan>$</font> <font color=Red>\</font>bx <font color=Red>-&gt;</font> <font color=Green><u>do</u></font>
<a name="line-933"></a>                  with_ancilla_init <font color=Cyan>(</font>replicate <font color=Cyan>(</font>fixed_int_register_length <font color=Blue><i>-</i></font> <font color=Cyan>(</font>n2 rt<font color=Cyan>)</font><font color=Cyan>)</font>
<a name="line-934"></a>                                               False<font color=Cyan>)</font> <font color=Cyan>$</font> <font color=Red>\</font>pad_x <font color=Red>-&gt;</font> <font color=Green><u>do</u></font>
<a name="line-935"></a>                    
<a name="line-936"></a>                    <font color=Green><u>let</u></font> x <font color=Red>=</font> SInt <font color=Cyan>(</font>pad_x <font color=Cyan>++</font> <font color=Cyan>(</font>reverse x'<font color=Cyan>)</font><font color=Cyan>)</font> bx
<a name="line-937"></a>                    
<a name="line-938"></a>                    <font color=Green><u>let</u></font> f <font color=Red>=</font> classical_to_reversible <font color=Cyan>$</font> 
<a name="line-939"></a>                              <font color=Red>\</font><font color=Cyan>(</font>v<font color=Cyan>,</font>nx<font color=Cyan>,</font>ny<font color=Cyan>,</font>scatteringnodes<font color=Cyan>,</font>lx<font color=Cyan>,</font>ly<font color=Cyan>,</font>k<font color=Cyan>)</font> <font color=Red>-&gt;</font> <font color=Green><u>do</u></font>
<a name="line-940"></a>                               <font color=Blue><i>-- get some QSInt and QDouble</i></font>
<a name="line-941"></a>                               <font color=Cyan>(</font>y<font color=Cyan>,</font>p<font color=Cyan>)</font> <font color=Red>&lt;-</font> unpack Template<font color=Cyan>.</font>template_getNodeValuesMoreOutputs
<a name="line-942"></a>                                           v band nx ny scatteringnodes lx ly k argflag' <font color=Magenta>7</font>
<a name="line-943"></a>                               
<a name="line-944"></a>                               new_p <font color=Red>&lt;-</font> make_factor_rep factor <font color=Cyan>(</font>n4 rt<font color=Cyan>)</font> p 
<a name="line-945"></a>                               
<a name="line-946"></a>                               <font color=Blue><i>-- set y in the correct format (it has n2 elements)</i></font>
<a name="line-947"></a>                               <font color=Blue><i>-- we can assume that the sign is positive.</i></font>
<a name="line-948"></a>                               <font color=Blue><i>-- we also assume that n2 &lt; size of QSInt register</i></font>
<a name="line-949"></a>                               <font color=Green><u>let</u></font> <font color=Cyan>(</font>SInt ty <font color=Green><u>_</u></font><font color=Cyan>)</font> <font color=Red>=</font> y
<a name="line-950"></a>                               <font color=Green><u>let</u></font> new_y <font color=Red>=</font> <font color=Cyan>(</font>take <font color=Cyan>(</font>n2 rt<font color=Cyan>)</font> <font color=Cyan>$</font> reverse ty<font color=Cyan>)</font>
<a name="line-951"></a>                               
<a name="line-952"></a>                               <font color=Blue><i>-- return the values in the right format.</i></font>
<a name="line-953"></a>                               return <font color=Cyan>(</font>new_y<font color=Cyan>,</font>new_p<font color=Cyan>)</font>
<a name="line-954"></a>                           
<a name="line-955"></a>                    f <font color=Cyan>(</font><font color=Cyan>(</font>x<font color=Cyan>,</font>qnx<font color=Cyan>,</font>qny<font color=Cyan>,</font>qscatteringnodes<font color=Cyan>,</font>qlx<font color=Cyan>,</font>qly<font color=Cyan>,</font>qk<font color=Cyan>)</font><font color=Cyan>,</font><font color=Cyan>(</font>y'<font color=Cyan>,</font>p'<font color=Cyan>)</font><font color=Cyan>)</font>
<a name="line-956"></a>                    
<a name="line-957"></a>                    return <font color=Cyan>(</font>x'<font color=Cyan>,</font>y'<font color=Cyan>,</font>p'<font color=Cyan>)</font>
<a name="line-958"></a>    
<a name="line-959"></a>
<a name="line-960"></a><a name="inline_oracle"></a><font color=Blue><i>-- | Encapsulate the inline oracles in Template Haskell into an object</i></font>
<a name="line-961"></a><font color=Blue><i>-- of type 'Oracle'.</i></font>
<a name="line-962"></a><font color=Blue>inline_oracle</font> <font color=Red>::</font> Oracle
<a name="line-963"></a><font color=Blue>inline_oracle</font> <font color=Red>=</font> Oracle <font color=Cyan>{</font>
<a name="line-964"></a>  oracle_A <font color=Red>=</font> inline_oracle_A<font color=Cyan>,</font>
<a name="line-965"></a>  oracle_b <font color=Red>=</font> inline_oracle_b<font color=Cyan>,</font>
<a name="line-966"></a>  oracle_r <font color=Red>=</font> inline_oracle_r
<a name="line-967"></a><font color=Cyan>}</font>
</pre>
</body>
</html>