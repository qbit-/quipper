<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<html>
<head>
<!-- Generated by HsColour, http://code.haskell.org/~malcolm/hscolour/ -->
<title>Haskell code</title>
</head>
<body>
<pre><a name="line-1"></a><font color=Blue><i>{-# LANGUAGE FlexibleContexts #-}</i></font>
<a name="line-2"></a><font color=Blue><i>{-# LANGUAGE BangPatterns #-}</i></font>
<a name="line-3"></a>
<a name="line-4"></a><font color=Blue><i>-- | Pretty-printing of low-level quantum circuits.</i></font>
<a name="line-5"></a>
<a name="line-6"></a><font color=Green><u>module</u></font> Quipper<font color=Cyan>.</font>Printing <font color=Cyan>(</font>
<a name="line-7"></a>  <font color=Blue><i>-- * ASCII representation of circuits</i></font>
<a name="line-8"></a>  ascii_of_bcircuit<font color=Cyan>,</font>
<a name="line-9"></a>  print_dbcircuit_ascii<font color=Cyan>,</font>
<a name="line-10"></a>  getBit<font color=Cyan>,</font>
<a name="line-11"></a>  <font color=Blue><i>-- * Gate counts</i></font>
<a name="line-12"></a>  print_gatecounts_bcircuit<font color=Cyan>,</font>
<a name="line-13"></a>  <font color=Blue><i>-- * Graphical representation of circuits</i></font>
<a name="line-14"></a>  render_dbcircuit<font color=Cyan>,</font>
<a name="line-15"></a>  <font color=Blue><i>-- * Previewing</i></font>
<a name="line-16"></a>  preview_bcircuit<font color=Cyan>,</font>
<a name="line-17"></a>  <font color=Blue><i>-- * Printing to multiple formats</i></font>
<a name="line-18"></a>  Format<font color=Cyan>(</font><font color=Red>..</font><font color=Cyan>)</font><font color=Cyan>,</font>
<a name="line-19"></a>  FormatStyle<font color=Cyan>(</font><font color=Red>..</font><font color=Cyan>)</font><font color=Cyan>,</font>
<a name="line-20"></a>  pdf<font color=Cyan>,</font>
<a name="line-21"></a>  eps<font color=Cyan>,</font>
<a name="line-22"></a>  ps<font color=Cyan>,</font>
<a name="line-23"></a>  format_enum<font color=Cyan>,</font>
<a name="line-24"></a>  print_dbcircuit<font color=Cyan>,</font>
<a name="line-25"></a>  print_of_document<font color=Cyan>,</font>
<a name="line-26"></a>  print_of_document_custom<font color=Cyan>,</font>
<a name="line-27"></a>  <font color=Blue><i>-- * Generic printing</i></font>
<a name="line-28"></a>  print_unary<font color=Cyan>,</font>
<a name="line-29"></a>  print_generic<font color=Cyan>,</font>
<a name="line-30"></a>  print_simple<font color=Cyan>,</font>
<a name="line-31"></a>  <font color=Cyan>)</font> <font color=Green><u>where</u></font>
<a name="line-32"></a>
<a name="line-33"></a><font color=Blue><i>-- import other Quipper stuff</i></font>
<a name="line-34"></a><font color=Green><u>import</u></font> Libraries<font color=Cyan>.</font>Auxiliary
<a name="line-35"></a><font color=Green><u>import</u></font> Quipper<font color=Cyan>.</font>Circuit
<a name="line-36"></a><font color=Green><u>import</u></font> Quipper<font color=Cyan>.</font>Generic
<a name="line-37"></a><font color=Green><u>import</u></font> Quipper<font color=Cyan>.</font>Monad
<a name="line-38"></a><font color=Green><u>import</u></font> Quipper<font color=Cyan>.</font>QData
<a name="line-39"></a>
<a name="line-40"></a><font color=Blue><i>-- import other stuff</i></font>
<a name="line-41"></a><font color=Green><u>import</u></font> Prelude
<a name="line-42"></a><font color=Green><u>import</u></font> Text<font color=Cyan>.</font>Printf
<a name="line-43"></a><font color=Green><u>import</u></font> Data<font color=Cyan>.</font>Char<font color=Cyan>(</font>isSpace<font color=Cyan>)</font>
<a name="line-44"></a><font color=Green><u>import</u></font> Data<font color=Cyan>.</font>List
<a name="line-45"></a><font color=Green><u>import</u></font> Data<font color=Cyan>.</font>Maybe
<a name="line-46"></a><font color=Green><u>import</u></font> Control<font color=Cyan>.</font>Monad<font color=Cyan>(</font>when<font color=Cyan>)</font>
<a name="line-47"></a><font color=Green><u>import</u></font> Graphics<font color=Cyan>.</font>EasyRender
<a name="line-48"></a><font color=Green><u>import</u></font> System<font color=Cyan>.</font>IO
<a name="line-49"></a><font color=Green><u>import</u></font> System<font color=Cyan>.</font>Process
<a name="line-50"></a><font color=Green><u>import</u></font> System<font color=Cyan>.</font>Directory
<a name="line-51"></a><font color=Green><u>import</u></font> System<font color=Cyan>.</font>Environment
<a name="line-52"></a><font color=Green><u>import</u></font> System<font color=Cyan>.</font>Info
<a name="line-53"></a>
<a name="line-54"></a><font color=Green><u>import</u></font> Data<font color=Cyan>.</font>Set <font color=Cyan>(</font>Set<font color=Cyan>)</font>
<a name="line-55"></a><font color=Green><u>import</u></font> <font color=Green><u>qualified</u></font> Data<font color=Cyan>.</font>Set <font color=Green><u>as</u></font> Set
<a name="line-56"></a>
<a name="line-57"></a><font color=Green><u>import</u></font> Data<font color=Cyan>.</font>Map <font color=Cyan>(</font>Map<font color=Cyan>)</font>
<a name="line-58"></a><font color=Green><u>import</u></font> <font color=Green><u>qualified</u></font> Data<font color=Cyan>.</font>Map <font color=Green><u>as</u></font> Map
<a name="line-59"></a>
<a name="line-60"></a><font color=Green><u>import</u></font> <font color=Green><u>qualified</u></font> Data<font color=Cyan>.</font>IntMap <font color=Green><u>as</u></font> IntMap
<a name="line-61"></a><font color=Green><u>import</u></font> <font color=Green><u>qualified</u></font> Data<font color=Cyan>.</font>List <font color=Green><u>as</u></font> List
<a name="line-62"></a>
<a name="line-63"></a><font color=Blue><i>-- ======================================================================</i></font>
<a name="line-64"></a><font color=Blue><i>-- * Auxiliary functions</i></font>
<a name="line-65"></a>
<a name="line-66"></a><a name="self_inverse"></a><font color=Blue><i>-- | Determine whether a named gate is self-inverse. The kind of a</i></font>
<a name="line-67"></a><font color=Blue><i>-- gate is uniquely determined by its name, and the number of input</i></font>
<a name="line-68"></a><font color=Blue><i>-- wires and generalized controls.</i></font>
<a name="line-69"></a><font color=Blue><i>-- </i></font>
<a name="line-70"></a><font color=Blue><i>-- For now, we only recognize "X", "Y", "Z", "H", "not", "swap", and</i></font>
<a name="line-71"></a><font color=Blue><i>-- "W" as self-inverse; it is not currently possible for user code to</i></font>
<a name="line-72"></a><font color=Blue><i>-- extend this list.</i></font>
<a name="line-73"></a><font color=Blue>self_inverse</font> <font color=Red>::</font> String <font color=Red>-&gt;</font> <font color=Red>[</font>Wire<font color=Red>]</font> <font color=Red>-&gt;</font> <font color=Red>[</font>Wire<font color=Red>]</font> <font color=Red>-&gt;</font> Bool
<a name="line-74"></a><font color=Blue>self_inverse</font> <font color=Magenta>"X"</font> <font color=Red>[</font>q<font color=Red>]</font> [] <font color=Red>=</font> True
<a name="line-75"></a><font color=Blue>self_inverse</font> <font color=Magenta>"Y"</font> <font color=Red>[</font>q<font color=Red>]</font> [] <font color=Red>=</font> True
<a name="line-76"></a><font color=Blue>self_inverse</font> <font color=Magenta>"Z"</font> <font color=Red>[</font>q<font color=Red>]</font> [] <font color=Red>=</font> True
<a name="line-77"></a><font color=Blue>self_inverse</font> <font color=Magenta>"H"</font> <font color=Red>[</font>q<font color=Red>]</font> [] <font color=Red>=</font> True
<a name="line-78"></a><font color=Blue>self_inverse</font> <font color=Magenta>"not"</font> <font color=Red>[</font>q<font color=Red>]</font> [] <font color=Red>=</font> True
<a name="line-79"></a><font color=Blue>self_inverse</font> <font color=Magenta>"swap"</font> <font color=Red>[</font>q1<font color=Cyan>,</font>q2<font color=Red>]</font> [] <font color=Red>=</font> True
<a name="line-80"></a><font color=Blue>self_inverse</font> <font color=Magenta>"W"</font> <font color=Red>[</font>q1<font color=Cyan>,</font>q2<font color=Red>]</font> [] <font color=Red>=</font> True
<a name="line-81"></a><font color=Blue>self_inverse</font> <font color=Green><u>_</u></font> <font color=Green><u>_</u></font> <font color=Green><u>_</u></font> <font color=Red>=</font> False
<a name="line-82"></a>
<a name="line-83"></a><font color=Blue><i>-- ======================================================================</i></font>
<a name="line-84"></a><font color=Blue><i>-- * ASCII representation of circuits</i></font>
<a name="line-85"></a>
<a name="line-86"></a><font color=Blue><i>-- $ Convert a circuit to ASCII: one gate per line.</i></font>
<a name="line-87"></a>
<a name="line-88"></a><a name="WireTypeMap"></a><font color=Green><u>type</u></font> WireTypeMap <font color=Red>=</font> IntMap<font color=Cyan>.</font>IntMap Wiretype
<a name="line-89"></a>
<a name="line-90"></a><a name="track_wiretype"></a><font color=Blue><i>-- | Given a map of wiretypes, and a gate, update the wiretype in the map</i></font>
<a name="line-91"></a><font color=Blue><i>-- if the gate changes it.</i></font>
<a name="line-92"></a><font color=Blue>track_wiretype</font> <font color=Red>::</font> WireTypeMap <font color=Red>-&gt;</font> Gate <font color=Red>-&gt;</font> WireTypeMap
<a name="line-93"></a><font color=Blue>track_wiretype</font> wtm <font color=Cyan>(</font>QInit    <font color=Green><u>_</u></font> w <font color=Green><u>_</u></font>  <font color=Cyan>)</font> <font color=Red>=</font> IntMap<font color=Cyan>.</font>insert w Qbit wtm
<a name="line-94"></a><font color=Blue>track_wiretype</font> wtm <font color=Cyan>(</font>CInit    <font color=Green><u>_</u></font> w <font color=Green><u>_</u></font>  <font color=Cyan>)</font> <font color=Red>=</font> IntMap<font color=Cyan>.</font>insert w Cbit wtm
<a name="line-95"></a><font color=Blue>track_wiretype</font> wtm <font color=Cyan>(</font>QMeas      w    <font color=Cyan>)</font> <font color=Red>=</font> IntMap<font color=Cyan>.</font>insert w Cbit wtm
<a name="line-96"></a><font color=Blue>track_wiretype</font> wtm <font color=Cyan>(</font>CGate    <font color=Green><u>_</u></font> w <font color=Green><u>_</u></font> <font color=Green><u>_</u></font><font color=Cyan>)</font> <font color=Red>=</font> IntMap<font color=Cyan>.</font>insert w Cbit wtm
<a name="line-97"></a><font color=Blue>track_wiretype</font> wtm <font color=Cyan>(</font>CGateInv <font color=Green><u>_</u></font> w <font color=Green><u>_</u></font> <font color=Green><u>_</u></font><font color=Cyan>)</font> <font color=Red>=</font> IntMap<font color=Cyan>.</font>insert w Cbit wtm
<a name="line-98"></a><font color=Blue>track_wiretype</font> wtm <font color=Cyan>(</font>QPrep      w <font color=Green><u>_</u></font>  <font color=Cyan>)</font> <font color=Red>=</font> IntMap<font color=Cyan>.</font>insert w Qbit wtm
<a name="line-99"></a><font color=Blue>track_wiretype</font> wtm <font color=Cyan>(</font>QUnprep    w <font color=Green><u>_</u></font>  <font color=Cyan>)</font> <font color=Red>=</font> IntMap<font color=Cyan>.</font>insert w Cbit wtm
<a name="line-100"></a><font color=Blue>track_wiretype</font> wtm <font color=Cyan>(</font>Subroutine boxid inv ws1 a1 ws2 a2 c ncf scf rep<font color=Cyan>)</font> <font color=Red>=</font> a2 <font color=Cyan>`</font>IntMap<font color=Cyan>.</font>union<font color=Cyan>`</font> wtm 
<a name="line-101"></a><font color=Blue>track_wiretype</font> wtm <font color=Green><u>_</u></font> <font color=Red>=</font> wtm
<a name="line-102"></a>
<a name="line-103"></a><a name="ascii_of_boxid"></a><font color=Blue><i>-- | Convert a 'BoxId' to the string in the format \"/name/\", shape \"/x/\".</i></font>
<a name="line-104"></a><font color=Blue>ascii_of_boxid</font> <font color=Red>::</font> BoxId <font color=Red>-&gt;</font> String
<a name="line-105"></a><font color=Blue>ascii_of_boxid</font> <font color=Cyan>(</font>BoxId name shape<font color=Cyan>)</font> <font color=Red>=</font> show name <font color=Cyan>++</font> <font color=Magenta>", shape "</font> <font color=Cyan>++</font> show shape
<a name="line-106"></a>
<a name="line-107"></a><a name="ascii_render_control"></a><font color=Blue><i>-- | Generate an ASCII representation of a control. </i></font>
<a name="line-108"></a><font color=Blue><i>-- As controls are stored as untyped wires, we can lookup the wiretype in</i></font>
<a name="line-109"></a><font color=Blue><i>-- the current map and annotate the control if it's classical.</i></font>
<a name="line-110"></a><font color=Blue>ascii_render_control</font> <font color=Red>::</font> WireTypeMap <font color=Red>-&gt;</font> Signed Wire <font color=Red>-&gt;</font> String
<a name="line-111"></a><font color=Blue>ascii_render_control</font> wtm <font color=Cyan>(</font>Signed w b<font color=Cyan>)</font> <font color=Red>=</font>
<a name="line-112"></a>  <font color=Cyan>(</font><font color=Green><u>if</u></font> b <font color=Green><u>then</u></font> <font color=Magenta>"+"</font> <font color=Green><u>else</u></font> <font color=Magenta>"-"</font><font color=Cyan>)</font> <font color=Cyan>++</font> show w <font color=Cyan>++</font> ascii_render_control_type wtype
<a name="line-113"></a>  <font color=Green><u>where</u></font> 
<a name="line-114"></a>    wtype <font color=Red>=</font> <font color=Green><u>if</u></font> <font color=Cyan>(</font>w <font color=Cyan>`</font>IntMap<font color=Cyan>.</font>member<font color=Cyan>`</font> wtm<font color=Cyan>)</font> <font color=Green><u>then</u></font> <font color=Cyan>(</font>wtm IntMap<font color=Cyan>.!</font> w<font color=Cyan>)</font> <font color=Green><u>else</u></font> Qbit
<a name="line-115"></a>    ascii_render_control_type Qbit <font color=Red>=</font> <font color=Magenta>""</font>
<a name="line-116"></a>    ascii_render_control_type Cbit <font color=Red>=</font> <font color=Magenta>"c"</font>
<a name="line-117"></a>
<a name="line-118"></a><a name="ascii_render_controls"></a><font color=Blue><i>-- | Generate an ASCII representation of a list of controls.</i></font>
<a name="line-119"></a><font color=Blue>ascii_render_controls</font> <font color=Red>::</font> WireTypeMap <font color=Red>-&gt;</font> Controls <font color=Red>-&gt;</font> String
<a name="line-120"></a><font color=Blue>ascii_render_controls</font> wtm c <font color=Red>=</font>
<a name="line-121"></a>  string_of_list <font color=Magenta>" with controls=["</font> <font color=Magenta>", "</font> <font color=Magenta>"]"</font> <font color=Magenta>""</font> <font color=Cyan>(</font>ascii_render_control wtm<font color=Cyan>)</font> c
<a name="line-122"></a>
<a name="line-123"></a><a name="ascii_render_nocontrolflag"></a><font color=Blue><i>-- | Generate an ASCII representation of a NoControlFlag</i></font>
<a name="line-124"></a><font color=Blue>ascii_render_nocontrolflag</font> <font color=Red>::</font> NoControlFlag <font color=Red>-&gt;</font> String
<a name="line-125"></a><font color=Blue>ascii_render_nocontrolflag</font> False <font color=Red>=</font> <font color=Magenta>""</font>
<a name="line-126"></a><font color=Blue>ascii_render_nocontrolflag</font> True <font color=Red>=</font> <font color=Magenta>" with nocontrol"</font>
<a name="line-127"></a>
<a name="line-128"></a><a name="ascii_render_gate"></a><font color=Blue><i>-- | Generate an ASCII representation of a single gate.</i></font>
<a name="line-129"></a><font color=Blue>ascii_render_gate</font> <font color=Red>::</font> WireTypeMap <font color=Red>-&gt;</font> Gate <font color=Red>-&gt;</font> String
<a name="line-130"></a><font color=Blue>ascii_render_gate</font> wtm <font color=Cyan>(</font>QGate <font color=Magenta>"trace"</font> <font color=Green><u>_</u></font> <font color=Green><u>_</u></font> <font color=Green><u>_</u></font> <font color=Green><u>_</u></font> <font color=Green><u>_</u></font><font color=Cyan>)</font> <font color=Red>=</font> <font color=Magenta>""</font>
<a name="line-131"></a><font color=Blue>ascii_render_gate</font> wtm <font color=Cyan>(</font>QGate name inv ws1 ws2 c ncf<font color=Cyan>)</font> <font color=Red>=</font> 
<a name="line-132"></a>  <font color=Magenta>"QGate["</font> <font color=Cyan>++</font> show name <font color=Cyan>++</font> <font color=Magenta>"]"</font> 
<a name="line-133"></a>  <font color=Cyan>++</font> optional inv' <font color=Magenta>"*"</font>
<a name="line-134"></a>  <font color=Cyan>++</font> <font color=Cyan>(</font>string_of_list <font color=Magenta>"("</font> <font color=Magenta>","</font> <font color=Magenta>")"</font> <font color=Magenta>"()"</font> show ws1<font color=Cyan>)</font>
<a name="line-135"></a>  <font color=Cyan>++</font> <font color=Cyan>(</font>string_of_list <font color=Magenta>"; ["</font> <font color=Magenta>","</font> <font color=Magenta>"]"</font> <font color=Magenta>""</font> show ws2<font color=Cyan>)</font>
<a name="line-136"></a>  <font color=Cyan>++</font> ascii_render_controls wtm c
<a name="line-137"></a>  <font color=Cyan>++</font> ascii_render_nocontrolflag ncf
<a name="line-138"></a>  <font color=Green><u>where</u></font>
<a name="line-139"></a>    inv' <font color=Red>=</font> inv <font color=Cyan>&amp;&amp;</font> not <font color=Cyan>(</font>self_inverse name ws1 ws2<font color=Cyan>)</font>
<a name="line-140"></a><font color=Blue>ascii_render_gate</font> wtm <font color=Cyan>(</font>QRot name inv theta ws1 ws2 c ncf<font color=Cyan>)</font> <font color=Red>=</font> 
<a name="line-141"></a>  <font color=Magenta>"QRot["</font> <font color=Cyan>++</font> show name <font color=Cyan>++</font> <font color=Magenta>","</font> <font color=Cyan>++</font> <font color=Cyan>(</font>show theta<font color=Cyan>)</font> <font color=Cyan>++</font> <font color=Magenta>"]"</font> 
<a name="line-142"></a>  <font color=Cyan>++</font> optional inv <font color=Magenta>"*"</font>
<a name="line-143"></a>  <font color=Cyan>++</font> <font color=Cyan>(</font>string_of_list <font color=Magenta>"("</font> <font color=Magenta>","</font> <font color=Magenta>")"</font> <font color=Magenta>"()"</font> show ws1<font color=Cyan>)</font>
<a name="line-144"></a>  <font color=Cyan>++</font> <font color=Cyan>(</font>string_of_list <font color=Magenta>"; ["</font> <font color=Magenta>","</font> <font color=Magenta>"]"</font> <font color=Magenta>""</font> show ws2<font color=Cyan>)</font>
<a name="line-145"></a>  <font color=Cyan>++</font> ascii_render_controls wtm c
<a name="line-146"></a>  <font color=Cyan>++</font> ascii_render_nocontrolflag ncf
<a name="line-147"></a><font color=Blue>ascii_render_gate</font> wtm <font color=Cyan>(</font>GPhase t ws c ncf<font color=Cyan>)</font> <font color=Red>=</font> 
<a name="line-148"></a>  <font color=Magenta>"GPhase() with t="</font> <font color=Cyan>++</font> show t 
<a name="line-149"></a>  <font color=Cyan>++</font> ascii_render_controls wtm c 
<a name="line-150"></a>  <font color=Cyan>++</font> ascii_render_nocontrolflag ncf
<a name="line-151"></a>  <font color=Cyan>++</font> string_of_list <font color=Magenta>" with anchors=["</font> <font color=Magenta>", "</font> <font color=Magenta>"]"</font> <font color=Magenta>""</font> show ws
<a name="line-152"></a><font color=Blue>ascii_render_gate</font> wtm <font color=Cyan>(</font>CNot w c ncf<font color=Cyan>)</font> <font color=Red>=</font> 
<a name="line-153"></a>  <font color=Magenta>"CNot("</font> <font color=Cyan>++</font> show w <font color=Cyan>++</font> <font color=Magenta>")"</font> 
<a name="line-154"></a>  <font color=Cyan>++</font> ascii_render_controls wtm c
<a name="line-155"></a>  <font color=Cyan>++</font> ascii_render_nocontrolflag ncf
<a name="line-156"></a><font color=Blue>ascii_render_gate</font> wtm <font color=Cyan>(</font>CGate n w c ncf<font color=Cyan>)</font> <font color=Red>=</font> 
<a name="line-157"></a>  <font color=Blue><i>-- special case</i></font>
<a name="line-158"></a>  <font color=Magenta>"CGate["</font> <font color=Cyan>++</font> show n <font color=Cyan>++</font> <font color=Magenta>"]"</font> <font color=Cyan>++</font> <font color=Cyan>(</font>string_of_list <font color=Magenta>"("</font> <font color=Magenta>","</font> <font color=Magenta>")"</font> <font color=Magenta>"()"</font> show <font color=Cyan>(</font>w<font color=Red><b>:</b></font>c<font color=Cyan>)</font><font color=Cyan>)</font>
<a name="line-159"></a>  <font color=Cyan>++</font> ascii_render_nocontrolflag ncf
<a name="line-160"></a><font color=Blue>ascii_render_gate</font> wtm <font color=Cyan>(</font>CGateInv n w c ncf<font color=Cyan>)</font> <font color=Red>=</font> 
<a name="line-161"></a>  <font color=Magenta>"CGate["</font> <font color=Cyan>++</font> show n <font color=Cyan>++</font> <font color=Magenta>"]"</font> <font color=Cyan>++</font> <font color=Magenta>"*"</font> <font color=Cyan>++</font> <font color=Cyan>(</font>string_of_list <font color=Magenta>"("</font> <font color=Magenta>","</font> <font color=Magenta>")"</font> <font color=Magenta>"()"</font> show <font color=Cyan>(</font>w<font color=Red><b>:</b></font>c<font color=Cyan>)</font><font color=Cyan>)</font>
<a name="line-162"></a>  <font color=Cyan>++</font> ascii_render_nocontrolflag ncf
<a name="line-163"></a><font color=Blue>ascii_render_gate</font> wtm <font color=Cyan>(</font>CSwap w1 w2 c ncf<font color=Cyan>)</font> <font color=Red>=</font> 
<a name="line-164"></a>  <font color=Magenta>"CSwap("</font> <font color=Cyan>++</font> show w1 <font color=Cyan>++</font> <font color=Magenta>","</font> <font color=Cyan>++</font> show w2 <font color=Cyan>++</font> <font color=Magenta>")"</font> 
<a name="line-165"></a>  <font color=Cyan>++</font> ascii_render_controls wtm c
<a name="line-166"></a>  <font color=Cyan>++</font> ascii_render_nocontrolflag ncf
<a name="line-167"></a><font color=Blue>ascii_render_gate</font> wtm <font color=Cyan>(</font>QPrep w ncf<font color=Cyan>)</font> <font color=Red>=</font> 
<a name="line-168"></a>  <font color=Magenta>"QPrep("</font> <font color=Cyan>++</font> show w <font color=Cyan>++</font> <font color=Magenta>")"</font>
<a name="line-169"></a>  <font color=Cyan>++</font> ascii_render_nocontrolflag ncf
<a name="line-170"></a><font color=Blue>ascii_render_gate</font> wtm <font color=Cyan>(</font>QUnprep w ncf<font color=Cyan>)</font> <font color=Red>=</font> 
<a name="line-171"></a>  <font color=Magenta>"QUnprep("</font> <font color=Cyan>++</font> show w <font color=Cyan>++</font> <font color=Magenta>")"</font>
<a name="line-172"></a>  <font color=Cyan>++</font> ascii_render_nocontrolflag ncf
<a name="line-173"></a><font color=Blue>ascii_render_gate</font> wtm <font color=Cyan>(</font>QInit b w ncf<font color=Cyan>)</font> <font color=Red>=</font> 
<a name="line-174"></a>  <font color=Magenta>"QInit"</font> <font color=Cyan>++</font> <font color=Cyan>(</font><font color=Green><u>if</u></font> b <font color=Green><u>then</u></font> <font color=Magenta>"1"</font> <font color=Green><u>else</u></font> <font color=Magenta>"0"</font><font color=Cyan>)</font> <font color=Cyan>++</font> <font color=Magenta>"("</font> <font color=Cyan>++</font> show w <font color=Cyan>++</font> <font color=Magenta>")"</font>
<a name="line-175"></a>  <font color=Cyan>++</font> ascii_render_nocontrolflag ncf
<a name="line-176"></a><font color=Blue>ascii_render_gate</font> wtm <font color=Cyan>(</font>CInit b w ncf<font color=Cyan>)</font> <font color=Red>=</font> 
<a name="line-177"></a>  <font color=Magenta>"CInit"</font> <font color=Cyan>++</font> <font color=Cyan>(</font><font color=Green><u>if</u></font> b <font color=Green><u>then</u></font> <font color=Magenta>"1"</font> <font color=Green><u>else</u></font> <font color=Magenta>"0"</font><font color=Cyan>)</font> <font color=Cyan>++</font> <font color=Magenta>"("</font> <font color=Cyan>++</font> show w <font color=Cyan>++</font> <font color=Magenta>")"</font>
<a name="line-178"></a>  <font color=Cyan>++</font> ascii_render_nocontrolflag ncf
<a name="line-179"></a><font color=Blue>ascii_render_gate</font> wtm <font color=Cyan>(</font>QTerm b w ncf<font color=Cyan>)</font> <font color=Red>=</font> 
<a name="line-180"></a>  <font color=Magenta>"QTerm"</font> <font color=Cyan>++</font> <font color=Cyan>(</font><font color=Green><u>if</u></font> b <font color=Green><u>then</u></font> <font color=Magenta>"1"</font> <font color=Green><u>else</u></font> <font color=Magenta>"0"</font><font color=Cyan>)</font> <font color=Cyan>++</font> <font color=Magenta>"("</font> <font color=Cyan>++</font> show w <font color=Cyan>++</font> <font color=Magenta>")"</font>
<a name="line-181"></a>  <font color=Cyan>++</font> ascii_render_nocontrolflag ncf
<a name="line-182"></a><font color=Blue>ascii_render_gate</font> wtm <font color=Cyan>(</font>CTerm b w ncf<font color=Cyan>)</font> <font color=Red>=</font> 
<a name="line-183"></a>  <font color=Magenta>"CTerm"</font> <font color=Cyan>++</font> <font color=Cyan>(</font><font color=Green><u>if</u></font> b <font color=Green><u>then</u></font> <font color=Magenta>"1"</font> <font color=Green><u>else</u></font> <font color=Magenta>"0"</font><font color=Cyan>)</font> <font color=Cyan>++</font> <font color=Magenta>"("</font> <font color=Cyan>++</font> show w <font color=Cyan>++</font> <font color=Magenta>")"</font>
<a name="line-184"></a>  <font color=Cyan>++</font> ascii_render_nocontrolflag ncf
<a name="line-185"></a><font color=Blue>ascii_render_gate</font> wtm <font color=Cyan>(</font>QMeas w<font color=Cyan>)</font> <font color=Red>=</font> 
<a name="line-186"></a>  <font color=Magenta>"QMeas("</font> <font color=Cyan>++</font> show w <font color=Cyan>++</font> <font color=Magenta>")"</font>
<a name="line-187"></a><font color=Blue>ascii_render_gate</font> wtm <font color=Cyan>(</font>QDiscard w<font color=Cyan>)</font> <font color=Red>=</font> 
<a name="line-188"></a>  <font color=Magenta>"QDiscard("</font> <font color=Cyan>++</font> show w <font color=Cyan>++</font> <font color=Magenta>")"</font>
<a name="line-189"></a><font color=Blue>ascii_render_gate</font> wtm <font color=Cyan>(</font>CDiscard w<font color=Cyan>)</font> <font color=Red>=</font> 
<a name="line-190"></a>  <font color=Magenta>"CDiscard("</font> <font color=Cyan>++</font> show w <font color=Cyan>++</font> <font color=Magenta>")"</font>
<a name="line-191"></a><font color=Blue>ascii_render_gate</font> wtm <font color=Cyan>(</font>DTerm b w<font color=Cyan>)</font> <font color=Red>=</font> 
<a name="line-192"></a>  <font color=Magenta>"DTerm"</font> <font color=Cyan>++</font> <font color=Cyan>(</font><font color=Green><u>if</u></font> b <font color=Green><u>then</u></font> <font color=Magenta>"1"</font> <font color=Green><u>else</u></font> <font color=Magenta>"0"</font><font color=Cyan>)</font> <font color=Cyan>++</font> <font color=Magenta>"("</font> <font color=Cyan>++</font> show w <font color=Cyan>++</font> <font color=Magenta>")"</font>
<a name="line-193"></a><font color=Blue>ascii_render_gate</font> wtm <font color=Cyan>(</font>Subroutine boxid inv ws1 a1 ws2 a2 c ncf scf rep<font color=Cyan>)</font> <font color=Red>=</font> 
<a name="line-194"></a>  <font color=Magenta>"Subroutine"</font> <font color=Cyan>++</font> show_rep <font color=Cyan>++</font> <font color=Magenta>"["</font> <font color=Cyan>++</font> ascii_of_boxid boxid <font color=Cyan>++</font> <font color=Magenta>"]"</font>
<a name="line-195"></a>  <font color=Cyan>++</font> optional inv <font color=Magenta>"*"</font>
<a name="line-196"></a>  <font color=Cyan>++</font> <font color=Magenta>" "</font>
<a name="line-197"></a>  <font color=Cyan>++</font> <font color=Cyan>(</font>string_of_list <font color=Magenta>"("</font> <font color=Magenta>","</font> <font color=Magenta>")"</font> <font color=Magenta>"()"</font> show ws1<font color=Cyan>)</font>
<a name="line-198"></a>  <font color=Cyan>++</font> <font color=Cyan>(</font>string_of_list <font color=Magenta>" -&gt; ("</font> <font color=Magenta>","</font> <font color=Magenta>")"</font> <font color=Magenta>"()"</font> show ws2<font color=Cyan>)</font>
<a name="line-199"></a>  <font color=Cyan>++</font> ascii_render_controls wtm c
<a name="line-200"></a>  <font color=Cyan>++</font> ascii_render_nocontrolflag ncf
<a name="line-201"></a>  <font color=Green><u>where</u></font>
<a name="line-202"></a>    show_rep <font color=Red>=</font> <font color=Green><u>if</u></font> rep <font color=Cyan>==</font> RepeatFlag <font color=Magenta>1</font> <font color=Green><u>then</u></font> <font color=Magenta>""</font> <font color=Green><u>else</u></font> <font color=Magenta>"(x"</font> <font color=Cyan>++</font> show rep <font color=Cyan>++</font> <font color=Magenta>")"</font>
<a name="line-203"></a><font color=Blue>ascii_render_gate</font> wtm <font color=Cyan>(</font>Comment s inv ws<font color=Cyan>)</font> <font color=Red>=</font> 
<a name="line-204"></a>  <font color=Magenta>"Comment["</font> <font color=Cyan>++</font> show s <font color=Cyan>++</font> <font color=Magenta>"]"</font> 
<a name="line-205"></a>  <font color=Cyan>++</font> optional inv <font color=Magenta>"*"</font>
<a name="line-206"></a>  <font color=Cyan>++</font> <font color=Cyan>(</font>string_of_list <font color=Magenta>"("</font> <font color=Magenta>", "</font> <font color=Magenta>")"</font> <font color=Magenta>"()"</font> <font color=Cyan>(</font><font color=Red>\</font><font color=Cyan>(</font>w<font color=Cyan>,</font>s<font color=Cyan>)</font> <font color=Red>-&gt;</font> show w <font color=Cyan>++</font> <font color=Magenta>":"</font> <font color=Cyan>++</font> show s<font color=Cyan>)</font> ws<font color=Cyan>)</font>
<a name="line-207"></a>  
<a name="line-208"></a><a name="ascii_render_gatelist"></a><font color=Blue><i>-- | Generate an ASCII representation of a gate list.</i></font>
<a name="line-209"></a><font color=Blue>ascii_render_gatelist</font> <font color=Red>::</font> WireTypeMap <font color=Red>-&gt;</font> <font color=Red>[</font>Gate<font color=Red>]</font> <font color=Red>-&gt;</font> String
<a name="line-210"></a><font color=Blue>ascii_render_gatelist</font> wtm []     <font color=Red>=</font> <font color=Magenta>""</font>
<a name="line-211"></a><font color=Blue>ascii_render_gatelist</font> wtm <font color=Cyan>(</font>g<font color=Red><b>:</b></font>gs<font color=Cyan>)</font> <font color=Red>=</font>
<a name="line-212"></a>  <font color=Cyan>(</font>ascii_render_gate wtm g<font color=Cyan>)</font> <font color=Cyan>++</font> <font color=Magenta>"\n"</font> <font color=Cyan>++</font> 
<a name="line-213"></a>  <font color=Cyan>(</font>ascii_render_gatelist <font color=Cyan>(</font>track_wiretype wtm g<font color=Cyan>)</font> gs<font color=Cyan>)</font>
<a name="line-214"></a>  <font color=Green><u>where</u></font>
<a name="line-215"></a>
<a name="line-216"></a><a name="ascii_render_wiretype"></a><font color=Blue><i>-- | Generate an ASCII representation of a wiretype.</i></font>
<a name="line-217"></a><font color=Blue>ascii_render_wiretype</font> <font color=Red>::</font> Wiretype <font color=Red>-&gt;</font> String
<a name="line-218"></a><font color=Blue>ascii_render_wiretype</font> Qbit <font color=Red>=</font> <font color=Magenta>"Qbit"</font>
<a name="line-219"></a><font color=Blue>ascii_render_wiretype</font> Cbit <font color=Red>=</font> <font color=Magenta>"Cbit"</font>
<a name="line-220"></a>
<a name="line-221"></a><a name="ascii_render_typeas"></a><font color=Blue><i>-- | Generate an ASCII representation of a type assignment.</i></font>
<a name="line-222"></a><font color=Blue>ascii_render_typeas</font> <font color=Red>::</font> <font color=Cyan>(</font>Wire<font color=Cyan>,</font> Wiretype<font color=Cyan>)</font> <font color=Red>-&gt;</font> String
<a name="line-223"></a><font color=Blue>ascii_render_typeas</font> <font color=Cyan>(</font>w<font color=Cyan>,</font> t<font color=Cyan>)</font> <font color=Red>=</font>
<a name="line-224"></a>  show w <font color=Cyan>++</font> <font color=Magenta>":"</font> <font color=Cyan>++</font> ascii_render_wiretype t
<a name="line-225"></a>
<a name="line-226"></a><a name="ascii_render_arity"></a><font color=Blue><i>-- | Generate an ASCII representation of an arity, preceded by a title</i></font>
<a name="line-227"></a><font color=Blue><i>-- (input or output).</i></font>
<a name="line-228"></a><font color=Blue>ascii_render_arity</font> <font color=Red>::</font> String <font color=Red>-&gt;</font> Arity <font color=Red>-&gt;</font> String
<a name="line-229"></a><font color=Blue>ascii_render_arity</font> title a <font color=Red>=</font>
<a name="line-230"></a>  title <font color=Cyan>++</font> <font color=Magenta>": "</font> <font color=Cyan>++</font> <font color=Cyan>(</font>string_of_list <font color=Magenta>""</font> <font color=Magenta>", "</font> <font color=Magenta>""</font> <font color=Magenta>"none"</font> ascii_render_typeas <font color=Cyan>(</font>IntMap<font color=Cyan>.</font>toList a<font color=Cyan>)</font><font color=Cyan>)</font> <font color=Cyan>++</font> <font color=Magenta>"\n"</font>
<a name="line-231"></a>
<a name="line-232"></a><a name="ascii_render_oarity"></a><font color=Blue><i>-- | Generate an ASCII representation of an ordered arity, preceded by</i></font>
<a name="line-233"></a><font color=Blue><i>-- a title (input or output).</i></font>
<a name="line-234"></a><font color=Blue>ascii_render_oarity</font> <font color=Red>::</font> String <font color=Red>-&gt;</font> <font color=Red>[</font>Wire<font color=Red>]</font> <font color=Red>-&gt;</font> Arity <font color=Red>-&gt;</font> String
<a name="line-235"></a><font color=Blue>ascii_render_oarity</font> title ws a <font color=Red>=</font>
<a name="line-236"></a>  title <font color=Cyan>++</font> <font color=Magenta>": "</font> 
<a name="line-237"></a>  <font color=Cyan>++</font> <font color=Cyan>(</font>string_of_list <font color=Magenta>""</font> <font color=Magenta>", "</font> <font color=Magenta>""</font> <font color=Magenta>"none"</font> ascii_render_typeas tas_list<font color=Cyan>)</font> <font color=Cyan>++</font> <font color=Magenta>"\n"</font>
<a name="line-238"></a>  <font color=Green><u>where</u></font>
<a name="line-239"></a>    tas_list <font color=Red>=</font> <font color=Red>[</font> <font color=Cyan>(</font>w<font color=Cyan>,</font> a IntMap<font color=Cyan>.!</font> w<font color=Cyan>)</font> <font color=Red>|</font> w <font color=Red>&lt;-</font> ws <font color=Red>]</font>
<a name="line-240"></a>
<a name="line-241"></a><a name="ascii_of_ocircuit"></a><font color=Blue><i>-- | Generate an ASCII representation of a low-level ordered quantum</i></font>
<a name="line-242"></a><font color=Blue><i>-- circuit.</i></font>
<a name="line-243"></a><font color=Blue>ascii_of_ocircuit</font> <font color=Red>::</font> OCircuit <font color=Red>-&gt;</font> String
<a name="line-244"></a><font color=Blue>ascii_of_ocircuit</font> ocircuit <font color=Red>=</font> 
<a name="line-245"></a>  <font color=Cyan>(</font>ascii_render_oarity <font color=Magenta>"Inputs"</font> win a1<font color=Cyan>)</font> <font color=Cyan>++</font>
<a name="line-246"></a>  <font color=Cyan>(</font>ascii_render_gatelist a1 gl<font color=Cyan>)</font> <font color=Cyan>++</font>
<a name="line-247"></a>  <font color=Cyan>(</font>ascii_render_oarity <font color=Magenta>"Outputs"</font> wout a2<font color=Cyan>)</font>
<a name="line-248"></a>    <font color=Green><u>where</u></font>
<a name="line-249"></a>      OCircuit <font color=Cyan>(</font>win<font color=Cyan>,</font> circuit<font color=Cyan>,</font> wout<font color=Cyan>)</font> <font color=Red>=</font> ocircuit
<a name="line-250"></a>      <font color=Cyan>(</font>a1<font color=Cyan>,</font> gl<font color=Cyan>,</font> a2<font color=Cyan>,</font> <font color=Green><u>_</u></font><font color=Cyan>)</font> <font color=Red>=</font> circuit
<a name="line-251"></a>
<a name="line-252"></a><a name="ascii_of_circuit"></a><font color=Blue><i>-- | Generate an ASCII representation of a low-level quantum circuit.</i></font>
<a name="line-253"></a><font color=Blue>ascii_of_circuit</font> <font color=Red>::</font> Circuit <font color=Red>-&gt;</font> String
<a name="line-254"></a><font color=Blue>ascii_of_circuit</font> circuit <font color=Red>=</font> ascii_of_ocircuit ocircuit <font color=Green><u>where</u></font>
<a name="line-255"></a>  ocircuit <font color=Red>=</font> OCircuit <font color=Cyan>(</font>w_in<font color=Cyan>,</font> circuit<font color=Cyan>,</font> w_out<font color=Cyan>)</font>
<a name="line-256"></a>  <font color=Cyan>(</font>a1<font color=Cyan>,</font> <font color=Green><u>_</u></font><font color=Cyan>,</font> a2<font color=Cyan>,</font> <font color=Green><u>_</u></font><font color=Cyan>)</font> <font color=Red>=</font> circuit
<a name="line-257"></a>  w_in <font color=Red>=</font> IntMap<font color=Cyan>.</font>keys a1
<a name="line-258"></a>  w_out <font color=Red>=</font> IntMap<font color=Cyan>.</font>keys a2
<a name="line-259"></a>
<a name="line-260"></a><a name="ascii_of_bcircuit"></a><font color=Blue><i>-- | Generate an ASCII representation of a low-level boxed quantum</i></font>
<a name="line-261"></a><font color=Blue><i>-- circuit.</i></font>
<a name="line-262"></a><font color=Blue>ascii_of_bcircuit</font> <font color=Red>::</font> BCircuit <font color=Red>-&gt;</font> String
<a name="line-263"></a><font color=Blue>ascii_of_bcircuit</font> <font color=Cyan>(</font>c<font color=Cyan>,</font>s<font color=Cyan>)</font> <font color=Red>=</font> 
<a name="line-264"></a>  <font color=Cyan>(</font>ascii_of_circuit c<font color=Cyan>)</font> <font color=Cyan>++</font>
<a name="line-265"></a>  <font color=Cyan>(</font>concat <font color=Cyan>$</font> map ascii_of_subroutine <font color=Cyan>(</font>Map<font color=Cyan>.</font>toList s<font color=Cyan>)</font><font color=Cyan>)</font> <font color=Cyan>++</font>
<a name="line-266"></a>  <font color=Magenta>"\n"</font>
<a name="line-267"></a>
<a name="line-268"></a><a name="ascii_of_subroutine"></a><font color=Blue><i>-- | Generate an ASCII representation of a named subroutine.</i></font>
<a name="line-269"></a><font color=Blue>ascii_of_subroutine</font> <font color=Red>::</font> <font color=Cyan>(</font>BoxId<font color=Cyan>,</font> TypedSubroutine<font color=Cyan>)</font> <font color=Red>-&gt;</font> String
<a name="line-270"></a><font color=Blue>ascii_of_subroutine</font> <font color=Cyan>(</font>boxid<font color=Cyan>,</font> TypedSubroutine ocirc input_strux output_strux ctrble<font color=Cyan>)</font> <font color=Red>=</font>
<a name="line-271"></a>  <font color=Magenta>"\n"</font> 
<a name="line-272"></a>  <font color=Cyan>++</font> <font color=Magenta>"Subroutine: "</font> <font color=Cyan>++</font> show name <font color=Cyan>++</font> <font color=Magenta>"\n"</font>
<a name="line-273"></a>  <font color=Cyan>++</font> <font color=Magenta>"Shape: "</font> <font color=Cyan>++</font> show shape <font color=Cyan>++</font> <font color=Magenta>"\n"</font>
<a name="line-274"></a>  <font color=Cyan>++</font> <font color=Magenta>"Controllable: "</font> <font color=Cyan>++</font> <font color=Cyan>(</font><font color=Green><u>case</u></font> ctrble <font color=Green><u>of</u></font> <font color=Cyan>{</font>AllCtl <font color=Red>-&gt;</font> <font color=Magenta>"yes"</font><font color=Cyan>;</font> NoCtl <font color=Red>-&gt;</font> <font color=Magenta>"no"</font><font color=Cyan>;</font> OnlyClassicalCtl <font color=Red>-&gt;</font> <font color=Magenta>"classically"</font><font color=Cyan>}</font><font color=Cyan>)</font> <font color=Cyan>++</font> <font color=Magenta>"\n"</font>
<a name="line-275"></a>  <font color=Cyan>++</font> ascii_of_ocircuit ocirc
<a name="line-276"></a>    <font color=Green><u>where</u></font>
<a name="line-277"></a>      BoxId name shape <font color=Red>=</font> boxid
<a name="line-278"></a>  
<a name="line-279"></a><font color=Blue><i>-- ======================================================================</i></font>
<a name="line-280"></a><font color=Blue><i>-- * Dynamic ASCII representation of circuits</i></font>
<a name="line-281"></a>
<a name="line-282"></a><font color=Blue><i>-- $</i></font>
<a name="line-283"></a><font color=Blue><i>-- The dynamic ASCII representation prints a circuit to standard</i></font>
<a name="line-284"></a><font color=Blue><i>-- output in ASCII format, just like the static ASCII representation.</i></font>
<a name="line-285"></a><font color=Blue><i>-- However, when a 'dynamic_lift' operation is encountered, it prompts</i></font>
<a name="line-286"></a><font color=Blue><i>-- the user for the value of the corresponding bit. In effect, the</i></font>
<a name="line-287"></a><font color=Blue><i>-- user is asked to act as the quantum device or simulator.   </i></font>
<a name="line-288"></a>
<a name="line-289"></a><a name="prompt"></a><font color=Blue><i>-- | Write a prompt to get input from the user. Since the prompt</i></font>
<a name="line-290"></a><font color=Blue><i>-- doesn't include a newline, the output must be flushed explicitly.</i></font>
<a name="line-291"></a><font color=Blue>prompt</font> <font color=Red>::</font> String <font color=Red>-&gt;</font> IO ()
<a name="line-292"></a><font color=Blue>prompt</font> s <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-293"></a>  putStr s
<a name="line-294"></a>  hFlush stdout
<a name="line-295"></a>
<a name="line-296"></a><a name="getBit"></a><font color=Blue><i>-- | Interactively read a bit (either 0 or 1) from standard input.</i></font>
<a name="line-297"></a><font color=Blue><i>-- This is intended for interactive user input, so it skips white</i></font>
<a name="line-298"></a><font color=Blue><i>-- space until a 0 or 1 is encountered. In case the first</i></font>
<a name="line-299"></a><font color=Blue><i>-- non-whitespace character isn't 0 or 1 or '#', the rest of the line</i></font>
<a name="line-300"></a><font color=Blue><i>-- is ignored and the user is prompted to try again.</i></font>
<a name="line-301"></a><font color=Blue><i>-- </i></font>
<a name="line-302"></a><font color=Blue><i>-- However, this also works for non-interactive input, so that the</i></font>
<a name="line-303"></a><font color=Blue><i>-- input can be redirected from a file. In this case, the characters 0</i></font>
<a name="line-304"></a><font color=Blue><i>-- and 1 and whitespace, including newlines, can be interspersed</i></font>
<a name="line-305"></a><font color=Blue><i>-- freely. \'@#@\' starts a comment that extends until the end of the</i></font>
<a name="line-306"></a><font color=Blue><i>-- line. </i></font>
<a name="line-307"></a><font color=Blue>getBit</font> <font color=Red>::</font> IO Bool
<a name="line-308"></a><font color=Blue>getBit</font> <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-309"></a>  c <font color=Red>&lt;-</font> getChar
<a name="line-310"></a>  <font color=Green><u>case</u></font> c <font color=Green><u>of</u></font>
<a name="line-311"></a>    <font color=Magenta>'0'</font> <font color=Red>-&gt;</font> return False
<a name="line-312"></a>    <font color=Magenta>'1'</font> <font color=Red>-&gt;</font> return True
<a name="line-313"></a>    <font color=Magenta>'#'</font> <font color=Red>-&gt;</font> <font color=Green><u>do</u></font>
<a name="line-314"></a>      getLine
<a name="line-315"></a>      getBit
<a name="line-316"></a>    c <font color=Red>|</font> isSpace c <font color=Red>-&gt;</font> getBit
<a name="line-317"></a>    c <font color=Red>-&gt;</font> <font color=Green><u>do</u></font>
<a name="line-318"></a>      getLine
<a name="line-319"></a>      prompt <font color=Cyan>$</font> <font color=Magenta>"# Expecting 0 or 1. Please try again: "</font>
<a name="line-320"></a>      getBit
<a name="line-321"></a>
<a name="line-322"></a><a name="run_readwrite_ascii"></a><font color=Blue><i>-- | Embed a read-write computation in the 'IO' monad, by writing</i></font>
<a name="line-323"></a><font color=Blue><i>-- gates to the terminal and interactively querying the user (or a</i></font>
<a name="line-324"></a><font color=Blue><i>-- file on stdin) for dynamic liftings. We also update a 'Namespace'</i></font>
<a name="line-325"></a><font color=Blue><i>-- while doing so, to collect any subroutines that are defined along</i></font>
<a name="line-326"></a><font color=Blue><i>-- the way.</i></font>
<a name="line-327"></a><font color=Blue>run_readwrite_ascii</font> <font color=Red>::</font> WireTypeMap <font color=Red>-&gt;</font> ReadWrite a <font color=Red>-&gt;</font> Namespace <font color=Red>-&gt;</font> IO <font color=Cyan>(</font>a<font color=Cyan>,</font> Namespace<font color=Cyan>)</font>
<a name="line-328"></a><font color=Blue>run_readwrite_ascii</font> wtm <font color=Cyan>(</font>RW_Return a<font color=Cyan>)</font> ns <font color=Red>=</font> return <font color=Cyan>(</font>a<font color=Cyan>,</font> ns<font color=Cyan>)</font>
<a name="line-329"></a><font color=Blue>run_readwrite_ascii</font> wtm <font color=Cyan>(</font>RW_Write gate comp<font color=Cyan>)</font> ns <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-330"></a>  putStrLn <font color=Cyan>(</font>ascii_render_gate wtm gate<font color=Cyan>)</font>
<a name="line-331"></a>  run_readwrite_ascii <font color=Cyan>(</font>track_wiretype wtm gate<font color=Cyan>)</font> comp ns
<a name="line-332"></a><font color=Blue>run_readwrite_ascii</font> wtm <font color=Cyan>(</font>RW_Read w cont<font color=Cyan>)</font> ns <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-333"></a>  prompt <font color=Cyan>$</font> <font color=Magenta>"# Value of wire "</font> <font color=Cyan>++</font> show w <font color=Cyan>++</font> <font color=Magenta>": "</font>
<a name="line-334"></a>  bool <font color=Red>&lt;-</font> getBit
<a name="line-335"></a>  putStrLn <font color=Cyan>$</font> <font color=Magenta>"# Value: "</font> <font color=Cyan>++</font> show bool
<a name="line-336"></a>  run_readwrite_ascii wtm <font color=Cyan>(</font>cont bool<font color=Cyan>)</font> ns
<a name="line-337"></a><font color=Blue>run_readwrite_ascii</font> wtm <font color=Cyan>(</font>RW_Subroutine name subroutine comp<font color=Cyan>)</font> ns <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-338"></a>  <font color=Green><u>let</u></font> <font color=Cyan>!</font>ns' <font color=Red>=</font> map_provide name subroutine ns
<a name="line-339"></a>  run_readwrite_ascii wtm comp ns'
<a name="line-340"></a>
<a name="line-341"></a><a name="print_dbcircuit_ascii"></a><font color=Blue><i>-- | Interactively output a 'DBCircuit' to standard output. This</i></font>
<a name="line-342"></a><font color=Blue><i>-- supports dynamic lifting by prompting the user for bit values when</i></font>
<a name="line-343"></a><font color=Blue><i>-- a dynamic lifting operation is encountered. Effectively the user is</i></font>
<a name="line-344"></a><font color=Blue><i>-- asked to behave like a quantum device.</i></font>
<a name="line-345"></a><font color=Blue>print_dbcircuit_ascii</font> <font color=Red>::</font> ErrMsg <font color=Red>-&gt;</font> DBCircuit a <font color=Red>-&gt;</font> IO ()
<a name="line-346"></a><font color=Blue>print_dbcircuit_ascii</font> <font color=Green><u>_</u></font> <font color=Cyan>(</font>a0<font color=Cyan>,</font> comp<font color=Cyan>)</font> <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-347"></a>  hSetBuffering stdout LineBuffering <font color=Blue><i>-- flush output after each line</i></font>
<a name="line-348"></a>  putStr <font color=Cyan>(</font>ascii_render_arity <font color=Magenta>"Inputs"</font> a0<font color=Cyan>)</font>
<a name="line-349"></a>  <font color=Cyan>(</font><font color=Cyan>(</font>a1<font color=Cyan>,</font> <font color=Green><u>_</u></font><font color=Cyan>,</font> <font color=Green><u>_</u></font><font color=Cyan>)</font><font color=Cyan>,</font>ns<font color=Cyan>)</font> <font color=Red>&lt;-</font> run_readwrite_ascii a0 comp namespace_empty
<a name="line-350"></a>  putStr <font color=Cyan>(</font>ascii_render_arity <font color=Magenta>"Outputs"</font> a1<font color=Cyan>)</font>
<a name="line-351"></a>  sequence_ <font color=Red>[</font> putStr <font color=Cyan>$</font> ascii_of_subroutine subr <font color=Red>|</font> subr <font color=Red>&lt;-</font> Map<font color=Cyan>.</font>toList ns <font color=Red>]</font>
<a name="line-352"></a>  putStr <font color=Magenta>"\n"</font>
<a name="line-353"></a>
<a name="line-354"></a><font color=Blue><i>-- ----------------------------------------------------------------------</i></font>
<a name="line-355"></a><font color=Blue><i>-- * Graphical representation of circuits</i></font>
<a name="line-356"></a>
<a name="line-357"></a><a name="white"></a><font color=Blue><i>-- | The color white.</i></font>
<a name="line-358"></a><font color=Blue>white</font> <font color=Red>::</font> Color
<a name="line-359"></a><font color=Blue>white</font> <font color=Red>=</font> Color_Gray <font color=Magenta>1.0</font>
<a name="line-360"></a>
<a name="line-361"></a><a name="black"></a><font color=Blue><i>-- | The color black.</i></font>
<a name="line-362"></a><font color=Blue>black</font> <font color=Red>::</font> Color
<a name="line-363"></a><font color=Blue>black</font> <font color=Red>=</font> Color_Gray <font color=Magenta>0.0</font>
<a name="line-364"></a>
<a name="line-365"></a><a name="FormatStyle"></a><font color=Blue><i>-- | A data type that holds all the customizable parameters.</i></font>
<a name="line-366"></a><a name="FormatStyle"></a><font color=Green><u>data</u></font> FormatStyle <font color=Red>=</font> FormatStyle <font color=Cyan>{</font>
<a name="line-367"></a>  <font color=Blue><i>-- | The RenderFormat to use.</i></font>
<a name="line-368"></a>  renderformat <font color=Red>::</font> RenderFormat<font color=Cyan>,</font>
<a name="line-369"></a>  <font color=Blue><i>-- | The color of the background.</i></font>
<a name="line-370"></a>  backgroundcolor <font color=Red>::</font> Color<font color=Cyan>,</font>
<a name="line-371"></a>  <font color=Blue><i>-- | The color of the foreground (e.g. wires and gates).</i></font>
<a name="line-372"></a>  foregroundcolor <font color=Red>::</font> Color<font color=Cyan>,</font>
<a name="line-373"></a>  <font color=Blue><i>-- | Line width.</i></font>
<a name="line-374"></a>  linewidth <font color=Red>::</font> Double<font color=Cyan>,</font>
<a name="line-375"></a>  <font color=Blue><i>-- | Gap for double line representing classical bit.</i></font>
<a name="line-376"></a>  coffs <font color=Red>::</font> Double<font color=Cyan>,</font>
<a name="line-377"></a>  <font color=Blue><i>-- | Radius of dots for \"controlled\" gates.</i></font>
<a name="line-378"></a>  dotradius <font color=Red>::</font> Double<font color=Cyan>,</font>
<a name="line-379"></a>  <font color=Blue><i>-- | Radius of oplus for \"not\" gate.</i></font>
<a name="line-380"></a>  oplusradius <font color=Red>::</font> Double<font color=Cyan>,</font>
<a name="line-381"></a>  <font color=Blue><i>-- | Horizontal column width.</i></font>
<a name="line-382"></a>  xoff <font color=Red>::</font> Double<font color=Cyan>,</font>
<a name="line-383"></a>  <font color=Blue><i>-- | Difference between width of box and width of label.</i></font>
<a name="line-384"></a>  gatepad <font color=Red>::</font> Double<font color=Cyan>,</font>
<a name="line-385"></a>  <font color=Blue><i>-- | Height of labelled box.</i></font>
<a name="line-386"></a>  gateheight <font color=Red>::</font> Double<font color=Cyan>,</font>
<a name="line-387"></a>  <font color=Blue><i>-- | Width and height of \"cross\" for swap gate.</i></font>
<a name="line-388"></a>  crossradius <font color=Red>::</font> Double<font color=Cyan>,</font>
<a name="line-389"></a>  <font color=Blue><i>-- | Vertical shift for text labels.</i></font>
<a name="line-390"></a>  stringbase <font color=Red>::</font> Double<font color=Cyan>,</font>
<a name="line-391"></a>  <font color=Blue><i>-- | Width of \"bar\" bar.</i></font>
<a name="line-392"></a>  barwidth <font color=Red>::</font> Double<font color=Cyan>,</font> 
<a name="line-393"></a>  <font color=Blue><i>-- | Height of \"bar\" bar.</i></font>
<a name="line-394"></a>  barheight <font color=Red>::</font> Double<font color=Cyan>,</font>
<a name="line-395"></a>  <font color=Blue><i>-- | Width of \"D\" symbol.</i></font>
<a name="line-396"></a>  dwidth <font color=Red>::</font> Double<font color=Cyan>,</font>
<a name="line-397"></a>  <font color=Blue><i>-- | Height of \"D\" symbol.</i></font>
<a name="line-398"></a>  dheight <font color=Red>::</font> Double<font color=Cyan>,</font>
<a name="line-399"></a>  <font color=Blue><i>-- | Maximal width of a gate label.</i></font>
<a name="line-400"></a>  maxgatelabelwidth <font color=Red>::</font> Double<font color=Cyan>,</font>
<a name="line-401"></a>  <font color=Blue><i>-- | Maximal width of a wire label.</i></font>
<a name="line-402"></a>  maxlabelwidth <font color=Red>::</font> Double<font color=Cyan>,</font>
<a name="line-403"></a>  <font color=Blue><i>-- | Maximal width of a wire number.</i></font>
<a name="line-404"></a>  maxnumberwidth <font color=Red>::</font> Double<font color=Cyan>,</font>
<a name="line-405"></a>  <font color=Blue><i>-- | Font to use for labels on gates.</i></font>
<a name="line-406"></a>  gatefont <font color=Red>::</font> Font<font color=Cyan>,</font>
<a name="line-407"></a>  <font color=Blue><i>-- | Font to use for comments.</i></font>
<a name="line-408"></a>  commentfont <font color=Red>::</font> Font<font color=Cyan>,</font>
<a name="line-409"></a>  <font color=Blue><i>-- | Color to use for comments.</i></font>
<a name="line-410"></a>  commentcolor <font color=Red>::</font> Color<font color=Cyan>,</font>
<a name="line-411"></a>  <font color=Blue><i>-- | Font to use for labels.</i></font>
<a name="line-412"></a>  labelfont <font color=Red>::</font> Font<font color=Cyan>,</font>
<a name="line-413"></a>  <font color=Blue><i>-- | Color to use for labels.</i></font>
<a name="line-414"></a>  labelcolor <font color=Red>::</font> Color<font color=Cyan>,</font>
<a name="line-415"></a>  <font color=Blue><i>-- | Font to use for numbers.</i></font>
<a name="line-416"></a>  numberfont <font color=Red>::</font> Font<font color=Cyan>,</font>
<a name="line-417"></a>  <font color=Blue><i>-- | Color to use for numbers.</i></font>
<a name="line-418"></a>  numbercolor <font color=Red>::</font> Color<font color=Cyan>,</font>
<a name="line-419"></a>  <font color=Blue><i>-- | Whether to label each subroutine call with shape parameters</i></font>
<a name="line-420"></a>  subroutineshape <font color=Red>::</font> Bool
<a name="line-421"></a><font color=Cyan>}</font> <font color=Green><u>deriving</u></font> Show
<a name="line-422"></a>
<a name="line-423"></a><a name="defaultStyle"></a><font color=Blue><i>-- | A RenderFormat consisting of some default parameters, </i></font>
<a name="line-424"></a><font color=Blue><i>-- along with the given RenderFormat.</i></font>
<a name="line-425"></a><font color=Blue>defaultStyle</font> <font color=Red>::</font> RenderFormat <font color=Red>-&gt;</font> FormatStyle
<a name="line-426"></a><font color=Blue>defaultStyle</font> rf <font color=Red>=</font> FormatStyle <font color=Cyan>{</font>
<a name="line-427"></a>  renderformat <font color=Red>=</font> rf<font color=Cyan>,</font>
<a name="line-428"></a>  backgroundcolor <font color=Red>=</font> white<font color=Cyan>,</font>
<a name="line-429"></a>  foregroundcolor <font color=Red>=</font> black<font color=Cyan>,</font>
<a name="line-430"></a>  linewidth <font color=Red>=</font> <font color=Magenta>0.02</font><font color=Cyan>,</font> 
<a name="line-431"></a>  coffs <font color=Red>=</font> <font color=Magenta>0.03</font><font color=Cyan>,</font>
<a name="line-432"></a>  dotradius  <font color=Red>=</font> <font color=Magenta>0.15</font><font color=Cyan>,</font>
<a name="line-433"></a>  oplusradius <font color=Red>=</font> <font color=Magenta>0.25</font><font color=Cyan>,</font>
<a name="line-434"></a>  xoff <font color=Red>=</font> <font color=Magenta>1.5</font><font color=Cyan>,</font>
<a name="line-435"></a>  gatepad <font color=Red>=</font> <font color=Magenta>0.3</font><font color=Cyan>,</font> 
<a name="line-436"></a>  gateheight  <font color=Red>=</font> <font color=Magenta>0.8</font><font color=Cyan>,</font>
<a name="line-437"></a>  crossradius <font color=Red>=</font> <font color=Magenta>0.2</font><font color=Cyan>,</font>
<a name="line-438"></a>  stringbase <font color=Red>=</font> <font color=Magenta>0.25</font><font color=Cyan>,</font>
<a name="line-439"></a>  barwidth <font color=Red>=</font> <font color=Magenta>0.1</font><font color=Cyan>,</font>
<a name="line-440"></a>  barheight <font color=Red>=</font> <font color=Magenta>0.5</font><font color=Cyan>,</font>
<a name="line-441"></a>  dwidth <font color=Red>=</font> <font color=Magenta>0.3</font><font color=Cyan>,</font>
<a name="line-442"></a>  dheight <font color=Red>=</font> <font color=Magenta>0.4</font><font color=Cyan>,</font>
<a name="line-443"></a>  maxgatelabelwidth <font color=Red>=</font> <font color=Magenta>1.1</font><font color=Cyan>,</font>
<a name="line-444"></a>  maxlabelwidth <font color=Red>=</font> <font color=Magenta>0.7</font><font color=Cyan>,</font>
<a name="line-445"></a>  maxnumberwidth <font color=Red>=</font> <font color=Magenta>0.7</font><font color=Cyan>,</font>
<a name="line-446"></a>  gatefont <font color=Red>=</font> Font TimesRoman <font color=Magenta>0.5</font><font color=Cyan>,</font>
<a name="line-447"></a>  commentfont <font color=Red>=</font> Font TimesRoman <font color=Magenta>0.3</font><font color=Cyan>,</font>
<a name="line-448"></a>  commentcolor <font color=Red>=</font> Color_RGB <font color=Magenta>1</font> <font color=Magenta>0.2</font> <font color=Magenta>0.2</font><font color=Cyan>,</font>
<a name="line-449"></a>  labelfont <font color=Red>=</font> Font TimesRoman <font color=Magenta>0.3</font><font color=Cyan>,</font>
<a name="line-450"></a>  labelcolor <font color=Red>=</font> Color_RGB <font color=Magenta>0</font> <font color=Magenta>0</font> <font color=Magenta>1</font><font color=Cyan>,</font>
<a name="line-451"></a>  numberfont <font color=Red>=</font> Font Helvetica <font color=Magenta>0.5</font><font color=Cyan>,</font>
<a name="line-452"></a>  numbercolor <font color=Red>=</font> Color_RGB <font color=Magenta>0</font> <font color=Magenta>0.7</font> <font color=Magenta>0</font><font color=Cyan>,</font>
<a name="line-453"></a>  subroutineshape <font color=Red>=</font> True
<a name="line-454"></a><font color=Cyan>}</font>
<a name="line-455"></a>
<a name="line-456"></a><a name="pdf"></a><font color=Blue><i>-- | The default PDF Style.</i></font>
<a name="line-457"></a><font color=Blue>pdf</font> <font color=Red>::</font> FormatStyle
<a name="line-458"></a><font color=Blue>pdf</font> <font color=Red>=</font> defaultStyle Format_PDF
<a name="line-459"></a>
<a name="line-460"></a><a name="eps"></a><font color=Blue><i>-- | The default EPS Style.</i></font>
<a name="line-461"></a><font color=Blue>eps</font> <font color=Red>::</font> FormatStyle
<a name="line-462"></a><font color=Blue>eps</font> <font color=Red>=</font> defaultStyle <font color=Cyan>(</font>Format_EPS <font color=Magenta>1</font><font color=Cyan>)</font>
<a name="line-463"></a>
<a name="line-464"></a><a name="ps"></a><font color=Blue><i>-- | The default PS Style.</i></font>
<a name="line-465"></a><font color=Blue>ps</font> <font color=Red>::</font> FormatStyle
<a name="line-466"></a><font color=Blue>ps</font> <font color=Red>=</font> defaultStyle <font color=Cyan>(</font>Format_PS<font color=Cyan>)</font>
<a name="line-467"></a>
<a name="line-468"></a><font color=Blue><i>-- ----------------------------------------------------------------------</i></font>
<a name="line-469"></a><font color=Blue><i>-- ** General-purpose PostScript functions</i></font>
<a name="line-470"></a>
<a name="line-471"></a><a name="ps_escape"></a><font color=Blue><i>-- | Escape special characters in a string literal.</i></font>
<a name="line-472"></a><font color=Blue>ps_escape</font> <font color=Red>::</font> String <font color=Red>-&gt;</font> String
<a name="line-473"></a><font color=Blue>ps_escape</font> [] <font color=Red>=</font> []
<a name="line-474"></a><font color=Blue>ps_escape</font> <font color=Cyan>(</font><font color=Magenta>'\\'</font> <font color=Red><b>:</b></font> t<font color=Cyan>)</font> <font color=Red>=</font> <font color=Magenta>'\\'</font> <font color=Red><b>:</b></font> <font color=Magenta>'\\'</font> <font color=Red><b>:</b></font> ps_escape t
<a name="line-475"></a><font color=Blue>ps_escape</font> <font color=Cyan>(</font><font color=Magenta>'('</font>  <font color=Red><b>:</b></font> t<font color=Cyan>)</font> <font color=Red>=</font> <font color=Magenta>'\\'</font> <font color=Red><b>:</b></font> <font color=Magenta>'('</font>  <font color=Red><b>:</b></font> ps_escape t
<a name="line-476"></a><font color=Blue>ps_escape</font> <font color=Cyan>(</font><font color=Magenta>')'</font>  <font color=Red><b>:</b></font> t<font color=Cyan>)</font> <font color=Red>=</font> <font color=Magenta>'\\'</font> <font color=Red><b>:</b></font> <font color=Magenta>')'</font>  <font color=Red><b>:</b></font> ps_escape t
<a name="line-477"></a><font color=Blue>ps_escape</font> <font color=Cyan>(</font>h <font color=Red><b>:</b></font> t<font color=Cyan>)</font>    <font color=Red>=</font> h <font color=Red><b>:</b></font> ps_escape t
<a name="line-478"></a>
<a name="line-479"></a><font color=Blue><i>-- ----------------------------------------------------------------------</i></font>
<a name="line-480"></a><font color=Blue><i>-- ** String formatting</i></font>
<a name="line-481"></a>
<a name="line-482"></a><a name="string_of_boxid"></a><font color=Blue><i>-- | Convert a 'BoxId' to the string in the format \"/name/, shape /x/\".</i></font>
<a name="line-483"></a><font color=Blue>string_of_boxid</font> <font color=Red>::</font> BoxId <font color=Red>-&gt;</font> String
<a name="line-484"></a><font color=Blue>string_of_boxid</font> <font color=Cyan>(</font>BoxId name shape<font color=Cyan>)</font> <font color=Red>=</font> name <font color=Cyan>++</font> <font color=Magenta>", shape "</font> <font color=Cyan>++</font> shape
<a name="line-485"></a>
<a name="line-486"></a><font color=Blue><i>-- ----------------------------------------------------------------------</i></font>
<a name="line-487"></a><font color=Blue><i>-- ** Functions for dealing with x-coordinates</i></font>
<a name="line-488"></a>
<a name="line-489"></a><a name="assign_x_coordinates"></a><font color=Blue><i>-- | Pre-processing: figure out the /x/-column of each gate. Returns</i></font>
<a name="line-490"></a><font color=Blue><i>-- (/n/,/xgs/) where /xgs/ is a list of ('Gate', 'X') pairs, and</i></font>
<a name="line-491"></a><font color=Blue><i>-- /n/ is the rightmost /x/-coordinate of the circuit. Here we start</i></font>
<a name="line-492"></a><font color=Blue><i>-- from /x0/ and use constant step /xoff/ taken from the 'FormatStyle'.</i></font>
<a name="line-493"></a><font color=Blue>assign_x_coordinates</font> <font color=Red>::</font> FormatStyle <font color=Red>-&gt;</font> <font color=Red>[</font>Gate<font color=Red>]</font> <font color=Red>-&gt;</font> X <font color=Red>-&gt;</font> <font color=Cyan>(</font>X<font color=Cyan>,</font> <font color=Red>[</font><font color=Cyan>(</font>Gate<font color=Cyan>,</font> X<font color=Cyan>)</font><font color=Red>]</font><font color=Cyan>)</font>
<a name="line-494"></a><font color=Blue>assign_x_coordinates</font> fs gs x0 <font color=Red>=</font>
<a name="line-495"></a>  <font color=Green><u>let</u></font> <font color=Cyan>(</font><font color=Cyan>(</font>x<font color=Cyan>,</font>ws<font color=Cyan>)</font><font color=Cyan>,</font> xgs<font color=Cyan>)</font> <font color=Red>=</font> mapAccumL <font color=Cyan>(</font><font color=Red>\</font> <font color=Cyan>(</font>x<font color=Cyan>,</font> ws<font color=Cyan>)</font> g <font color=Red>-&gt;</font>
<a name="line-496"></a>        <font color=Blue><i>-- count the wires attached to the gate. If there is precisely</i></font>
<a name="line-497"></a>        <font color=Blue><i>-- one (unary gate), merge it with adjacent unary gates. Do</i></font>
<a name="line-498"></a>        <font color=Blue><i>-- not merge comments.</i></font>
<a name="line-499"></a>        <font color=Green><u>let</u></font> merge <font color=Red>=</font> <font color=Green><u>case</u></font> <font color=Cyan>(</font>g<font color=Cyan>,</font> wirelist_of_gate g<font color=Cyan>)</font> <font color=Green><u>of</u></font>
<a name="line-500"></a>              <font color=Cyan>(</font>Comment <font color=Green><u>_</u></font> <font color=Green><u>_</u></font> <font color=Green><u>_</u></font><font color=Cyan>,</font> <font color=Green><u>_</u></font><font color=Cyan>)</font> <font color=Red>-&gt;</font> Nothing
<a name="line-501"></a>              <font color=Cyan>(</font><font color=Green><u>_</u></font><font color=Cyan>,</font> <font color=Red>[</font>w<font color=Red>]</font><font color=Cyan>)</font> <font color=Red>-&gt;</font> Just w
<a name="line-502"></a>              <font color=Cyan>(</font><font color=Green><u>_</u></font><font color=Cyan>,</font> <font color=Green><u>_</u></font><font color=Cyan>)</font> <font color=Red>-&gt;</font> Nothing
<a name="line-503"></a>        <font color=Green><u>in</u></font>
<a name="line-504"></a>        <font color=Green><u>case</u></font> merge <font color=Green><u>of</u></font>
<a name="line-505"></a>          Just w <font color=Red>-&gt;</font>
<a name="line-506"></a>            <font color=Green><u>if</u></font> not <font color=Cyan>(</font>w <font color=Cyan>`elem`</font> ws<font color=Cyan>)</font> <font color=Green><u>then</u></font>
<a name="line-507"></a>              <font color=Cyan>(</font><font color=Cyan>(</font>x<font color=Cyan>,</font> w<font color=Red><b>:</b></font>ws<font color=Cyan>)</font><font color=Cyan>,</font> <font color=Cyan>(</font>g<font color=Cyan>,</font> x<font color=Cyan>)</font><font color=Cyan>)</font>
<a name="line-508"></a>            <font color=Green><u>else</u></font>
<a name="line-509"></a>              <font color=Cyan>(</font><font color=Cyan>(</font>x <font color=Cyan>+</font> <font color=Cyan>(</font>xoff fs<font color=Cyan>)</font><font color=Cyan>,</font> <font color=Red>[</font>w<font color=Red>]</font><font color=Cyan>)</font><font color=Cyan>,</font> <font color=Cyan>(</font>g<font color=Cyan>,</font> x <font color=Cyan>+</font> <font color=Cyan>(</font>xoff fs<font color=Cyan>)</font><font color=Cyan>)</font><font color=Cyan>)</font>
<a name="line-510"></a>          <font color=Green><u>_</u></font> <font color=Red>-&gt;</font>
<a name="line-511"></a>            <font color=Green><u>if</u></font> ws <font color=Cyan>==</font> [] <font color=Green><u>then</u></font>
<a name="line-512"></a>              <font color=Cyan>(</font><font color=Cyan>(</font>x <font color=Cyan>+</font> <font color=Cyan>(</font>xoff fs<font color=Cyan>)</font><font color=Cyan>,</font> []<font color=Cyan>)</font><font color=Cyan>,</font> <font color=Cyan>(</font>g<font color=Cyan>,</font> x<font color=Cyan>)</font><font color=Cyan>)</font>
<a name="line-513"></a>            <font color=Green><u>else</u></font>
<a name="line-514"></a>              <font color=Cyan>(</font><font color=Cyan>(</font>x <font color=Cyan>+</font> <font color=Magenta>2.0</font> <font color=Cyan>*</font> <font color=Cyan>(</font>xoff fs<font color=Cyan>)</font><font color=Cyan>,</font> []<font color=Cyan>)</font><font color=Cyan>,</font> <font color=Cyan>(</font>g<font color=Cyan>,</font> x <font color=Cyan>+</font> <font color=Cyan>(</font>xoff fs<font color=Cyan>)</font><font color=Cyan>)</font><font color=Cyan>)</font>
<a name="line-515"></a>        <font color=Cyan>)</font> <font color=Cyan>(</font>x0<font color=Cyan>,</font> []<font color=Cyan>)</font> gs
<a name="line-516"></a>  <font color=Green><u>in</u></font>
<a name="line-517"></a>   <font color=Green><u>if</u></font> ws <font color=Cyan>==</font> [] <font color=Green><u>then</u></font>
<a name="line-518"></a>     <font color=Cyan>(</font>x<font color=Cyan>,</font> xgs<font color=Cyan>)</font>
<a name="line-519"></a>   <font color=Green><u>else</u></font>
<a name="line-520"></a>     <font color=Cyan>(</font>x <font color=Cyan>+</font> <font color=Cyan>(</font>xoff fs<font color=Cyan>)</font><font color=Cyan>,</font> xgs<font color=Cyan>)</font>
<a name="line-521"></a>
<a name="line-522"></a><a name="Xarity"></a><font color=Blue><i>-- | A 'Xarity' is a map from wire id's to pairs of a wiretype and a</i></font>
<a name="line-523"></a><a name="Xarity"></a><font color=Blue><i>-- starting /x/-coordinate.</i></font>
<a name="line-524"></a><a name="Xarity"></a><font color=Green><u>type</u></font> Xarity <font color=Red>=</font> Map Wire <font color=Cyan>(</font>Wiretype<font color=Cyan>,</font> X<font color=Cyan>)</font>
<a name="line-525"></a>
<a name="line-526"></a><a name="update_xarity"></a><font color=Blue><i>-- | Figure out how a gate at coordinate /x/ affects the current 'Xarity'.</i></font>
<a name="line-527"></a><font color=Blue><i>-- Return a pair (/term/, /new/), where /term/ is the 'Xarity' of wires</i></font>
<a name="line-528"></a><font color=Blue><i>-- terminated by this gate, and /new/ is the outgoing 'Xarity' of this</i></font>
<a name="line-529"></a><font color=Blue><i>-- gate.</i></font>
<a name="line-530"></a><font color=Blue>update_xarity</font> <font color=Red>::</font> Xarity <font color=Red>-&gt;</font> Gate <font color=Red>-&gt;</font> X <font color=Red>-&gt;</font> <font color=Cyan>(</font>Xarity<font color=Cyan>,</font> Xarity<font color=Cyan>)</font>
<a name="line-531"></a><font color=Blue>update_xarity</font> xarity gate x <font color=Red>=</font>
<a name="line-532"></a>  <font color=Green><u>let</u></font> <font color=Cyan>(</font>win<font color=Cyan>,</font> wout<font color=Cyan>)</font> <font color=Red>=</font> gate_arity gate
<a name="line-533"></a>      safe_lookup xarity w <font color=Red>=</font> 
<a name="line-534"></a>        <font color=Green><u>case</u></font> Map<font color=Cyan>.</font>lookup w xarity <font color=Green><u>of</u></font> 
<a name="line-535"></a>          Just x <font color=Red>-&gt;</font> x
<a name="line-536"></a>          Nothing <font color=Red>-&gt;</font> <font color=Cyan>(</font>Qbit<font color=Cyan>,</font> x<font color=Cyan>)</font> <font color=Blue><i>-- error ("update_xarity: the wire " ++ show w ++ " does not exist. In the gate:\n" ++ ascii_render_gate gate)</i></font>
<a name="line-537"></a>      <font color=Cyan>(</font>win'<font color=Cyan>,</font> wout'<font color=Cyan>)</font> <font color=Red>=</font> <font color=Cyan>(</font>win <font color=Cyan>\\</font> wout<font color=Cyan>,</font> wout <font color=Cyan>\\</font> win<font color=Cyan>)</font>
<a name="line-538"></a>      <font color=Blue><i>-- extract terminating wires from xarity</i></font>
<a name="line-539"></a>      xarity_term <font color=Red>=</font> foldl <font color=Cyan>(</font><font color=Red>\</font>xar <font color=Cyan>(</font>w<font color=Cyan>,</font><font color=Green><u>_</u></font><font color=Cyan>)</font> <font color=Red>-&gt;</font> Map<font color=Cyan>.</font>insert w <font color=Cyan>(</font>xarity <font color=Cyan>`safe_lookup`</font> w<font color=Cyan>)</font> xar<font color=Cyan>)</font> Map<font color=Cyan>.</font>empty win' 
<a name="line-540"></a>      <font color=Blue><i>-- extract continuing wires from xarity</i></font>
<a name="line-541"></a>      xarity_cont <font color=Red>=</font> foldl <font color=Cyan>(</font><font color=Red>\</font>xar <font color=Cyan>(</font>w<font color=Cyan>,</font><font color=Green><u>_</u></font><font color=Cyan>)</font> <font color=Red>-&gt;</font> Map<font color=Cyan>.</font>delete w xar<font color=Cyan>)</font> xarity win'
<a name="line-542"></a>      <font color=Blue><i>-- add new wires to xarity_cont</i></font>
<a name="line-543"></a>      xarity_new <font color=Red>=</font> foldl <font color=Cyan>(</font><font color=Red>\</font>xar <font color=Cyan>(</font>w<font color=Cyan>,</font>t<font color=Cyan>)</font> <font color=Red>-&gt;</font> Map<font color=Cyan>.</font>insert w <font color=Cyan>(</font>t<font color=Cyan>,</font>x<font color=Cyan>)</font> xar<font color=Cyan>)</font> xarity_cont wout'
<a name="line-544"></a>  <font color=Green><u>in</u></font>
<a name="line-545"></a>   <font color=Cyan>(</font>xarity_term<font color=Cyan>,</font> xarity_new<font color=Cyan>)</font>
<a name="line-546"></a>
<a name="line-547"></a><font color=Blue><i>-- ----------------------------------------------------------------------</i></font>
<a name="line-548"></a><font color=Blue><i>-- ** Low-level drawing functions</i></font>
<a name="line-549"></a>
<a name="line-550"></a><a name="render_line"></a><font color=Blue><i>-- | @'render_line' x0 y0 x1 y1@: Draw a line from (/x0/, /y0/)</i></font>
<a name="line-551"></a><font color=Blue><i>-- to (/x1/, /y1/). In case of a zero-length line, draw nothing.</i></font>
<a name="line-552"></a><font color=Blue>render_line</font> <font color=Red>::</font> X <font color=Red>-&gt;</font> Y <font color=Red>-&gt;</font> X <font color=Red>-&gt;</font> Y <font color=Red>-&gt;</font> Draw ()
<a name="line-553"></a><font color=Blue>render_line</font> x0 y0 x1 y1 <font color=Red>|</font> x0 <font color=Cyan>==</font> x1 <font color=Cyan>&amp;&amp;</font> y0 <font color=Cyan>==</font> y1 <font color=Red>=</font> return ()
<a name="line-554"></a><font color=Blue>render_line</font> x0 y0 x1 y1 <font color=Red>=</font> draw_subroutine alt <font color=Cyan>$</font> <font color=Green><u>do</u></font>
<a name="line-555"></a>  moveto x0 y0
<a name="line-556"></a>  lineto x1 y1
<a name="line-557"></a>  stroke
<a name="line-558"></a>  <font color=Green><u>where</u></font>
<a name="line-559"></a>    alt <font color=Red>=</font> <font color=Red>[</font>custom_ps <font color=Cyan>$</font> printf <font color=Magenta>"%f %f %f %f line\n"</font> x0 y0 x1 y1<font color=Red>]</font>
<a name="line-560"></a>
<a name="line-561"></a><a name="render_dot"></a><font color=Blue><i>-- | @'render_dot' x y@: Draw a filled control dot at (/x/,/y/).</i></font>
<a name="line-562"></a><font color=Blue>render_dot</font> <font color=Red>::</font> FormatStyle <font color=Red>-&gt;</font> X <font color=Red>-&gt;</font> Y <font color=Red>-&gt;</font> Draw ()
<a name="line-563"></a><font color=Blue>render_dot</font> fs x y <font color=Red>=</font> draw_subroutine alt <font color=Cyan>$</font> <font color=Green><u>do</u></font>
<a name="line-564"></a>  arc x y <font color=Cyan>(</font>dotradius fs<font color=Cyan>)</font> <font color=Magenta>0</font> <font color=Magenta>360</font>
<a name="line-565"></a>  fill <font color=Cyan>(</font>foregroundcolor fs<font color=Cyan>)</font>
<a name="line-566"></a>  <font color=Green><u>where</u></font>
<a name="line-567"></a>    alt <font color=Red>=</font> <font color=Red>[</font>custom_ps <font color=Cyan>$</font> printf <font color=Magenta>"%f %f dot\n"</font> x y<font color=Red>]</font>
<a name="line-568"></a>
<a name="line-569"></a><a name="render_circle"></a><font color=Blue><i>-- | @'render_circle' x y@: Draw an empty control dot at</i></font>
<a name="line-570"></a><font color=Blue><i>-- (/x/,/y/).</i></font>
<a name="line-571"></a><font color=Blue>render_circle</font> <font color=Red>::</font> FormatStyle <font color=Red>-&gt;</font> X <font color=Red>-&gt;</font> Y <font color=Red>-&gt;</font> Draw ()
<a name="line-572"></a><font color=Blue>render_circle</font> fs x y <font color=Red>=</font> draw_subroutine alt <font color=Cyan>$</font> <font color=Green><u>do</u></font>
<a name="line-573"></a>  arc x y <font color=Cyan>(</font>dotradius fs<font color=Cyan>)</font> <font color=Magenta>0</font> <font color=Magenta>360</font>
<a name="line-574"></a>  fillstroke <font color=Cyan>(</font>backgroundcolor fs<font color=Cyan>)</font>
<a name="line-575"></a>  <font color=Green><u>where</u></font>
<a name="line-576"></a>    alt <font color=Red>=</font> <font color=Red>[</font>custom_ps <font color=Cyan>$</font> printf <font color=Magenta>"%f %f circ\n"</font> x y<font color=Red>]</font>
<a name="line-577"></a>
<a name="line-578"></a><a name="render_not"></a><font color=Blue><i>-- | @'render_not' x y@: Draw a \"not\" gate at (/x/,/y/).</i></font>
<a name="line-579"></a><font color=Blue>render_not</font> <font color=Red>::</font> FormatStyle <font color=Red>-&gt;</font> X <font color=Red>-&gt;</font> Y <font color=Red>-&gt;</font> Draw ()
<a name="line-580"></a><font color=Blue>render_not</font> fs x y <font color=Red>=</font> draw_subroutine alt <font color=Cyan>$</font> <font color=Green><u>do</u></font>
<a name="line-581"></a>  arc x y <font color=Cyan>(</font>oplusradius fs<font color=Cyan>)</font> <font color=Magenta>0</font> <font color=Magenta>360</font>
<a name="line-582"></a>  fillstroke <font color=Cyan>(</font>backgroundcolor fs<font color=Cyan>)</font>
<a name="line-583"></a>  render_line <font color=Cyan>(</font>x<font color=Blue><i>-</i></font><font color=Cyan>(</font>oplusradius fs<font color=Cyan>)</font><font color=Cyan>)</font> y <font color=Cyan>(</font>x<font color=Cyan>+</font><font color=Cyan>(</font>oplusradius fs<font color=Cyan>)</font><font color=Cyan>)</font> y
<a name="line-584"></a>  render_line x <font color=Cyan>(</font>y<font color=Blue><i>-</i></font><font color=Cyan>(</font>oplusradius fs<font color=Cyan>)</font><font color=Cyan>)</font> x <font color=Cyan>(</font>y<font color=Cyan>+</font><font color=Cyan>(</font>oplusradius fs<font color=Cyan>)</font><font color=Cyan>)</font>
<a name="line-585"></a>  <font color=Green><u>where</u></font>
<a name="line-586"></a>    alt <font color=Red>=</font> <font color=Red>[</font>custom_ps <font color=Cyan>$</font> printf <font color=Magenta>"%f %f oplus\n"</font> x y<font color=Red>]</font>
<a name="line-587"></a>
<a name="line-588"></a><a name="render_swap"></a><font color=Blue><i>-- | @'render_swap' x y@: Draw a cross (swap gate component) at</i></font>
<a name="line-589"></a><font color=Blue><i>--  (/x/,/y/).</i></font>
<a name="line-590"></a><font color=Blue>render_swap</font> <font color=Red>::</font> FormatStyle <font color=Red>-&gt;</font> X <font color=Red>-&gt;</font> Y <font color=Red>-&gt;</font> Draw ()
<a name="line-591"></a><font color=Blue>render_swap</font> fs x y <font color=Red>=</font> draw_subroutine alt <font color=Cyan>$</font> <font color=Green><u>do</u></font>
<a name="line-592"></a>  render_line <font color=Cyan>(</font>x<font color=Blue><i>-</i></font><font color=Cyan>(</font>crossradius fs<font color=Cyan>)</font><font color=Cyan>)</font> <font color=Cyan>(</font>y<font color=Blue><i>-</i></font><font color=Cyan>(</font>crossradius fs<font color=Cyan>)</font><font color=Cyan>)</font> <font color=Cyan>(</font>x<font color=Cyan>+</font><font color=Cyan>(</font>crossradius fs<font color=Cyan>)</font><font color=Cyan>)</font> <font color=Cyan>(</font>y<font color=Cyan>+</font><font color=Cyan>(</font>crossradius fs<font color=Cyan>)</font><font color=Cyan>)</font>
<a name="line-593"></a>  render_line <font color=Cyan>(</font>x<font color=Blue><i>-</i></font><font color=Cyan>(</font>crossradius fs<font color=Cyan>)</font><font color=Cyan>)</font> <font color=Cyan>(</font>y<font color=Cyan>+</font><font color=Cyan>(</font>crossradius fs<font color=Cyan>)</font><font color=Cyan>)</font> <font color=Cyan>(</font>x<font color=Cyan>+</font><font color=Cyan>(</font>crossradius fs<font color=Cyan>)</font><font color=Cyan>)</font> <font color=Cyan>(</font>y<font color=Blue><i>-</i></font><font color=Cyan>(</font>crossradius fs<font color=Cyan>)</font><font color=Cyan>)</font>
<a name="line-594"></a>  <font color=Green><u>where</u></font>  
<a name="line-595"></a>    alt <font color=Red>=</font> <font color=Red>[</font>custom_ps <font color=Cyan>$</font> printf <font color=Magenta>"%f %f cross\n"</font> x y<font color=Red>]</font>
<a name="line-596"></a>
<a name="line-597"></a><a name="render_bar"></a><font color=Blue><i>-- | @'render_bar' x y@: Draw an init/term bar at (/x/,/y/).</i></font>
<a name="line-598"></a><font color=Blue>render_bar</font> <font color=Red>::</font> FormatStyle <font color=Red>-&gt;</font> X <font color=Red>-&gt;</font> Y <font color=Red>-&gt;</font> Draw ()
<a name="line-599"></a><font color=Blue>render_bar</font> fs x y <font color=Red>=</font> draw_subroutine alt <font color=Cyan>$</font> <font color=Green><u>do</u></font>
<a name="line-600"></a>  rectangle <font color=Cyan>(</font>x <font color=Blue><i>-</i></font> <font color=Cyan>(</font>barwidth fs<font color=Cyan>)</font><font color=Cyan>/</font><font color=Magenta>2</font><font color=Cyan>)</font> <font color=Cyan>(</font>y <font color=Blue><i>-</i></font> <font color=Cyan>(</font>barheight fs<font color=Cyan>)</font><font color=Cyan>/</font><font color=Magenta>2</font><font color=Cyan>)</font> <font color=Cyan>(</font>barwidth fs<font color=Cyan>)</font> <font color=Cyan>(</font>barheight fs<font color=Cyan>)</font>
<a name="line-601"></a>  fill <font color=Cyan>(</font>foregroundcolor fs<font color=Cyan>)</font>
<a name="line-602"></a>  <font color=Green><u>where</u></font>
<a name="line-603"></a>    alt <font color=Red>=</font> <font color=Red>[</font>custom_ps <font color=Cyan>$</font> printf <font color=Magenta>"%f %f bar\n"</font> x y<font color=Red>]</font>
<a name="line-604"></a>
<a name="line-605"></a><a name="render_dbar"></a><font color=Blue><i>-- | @'render_bar' x y@: Draw a dterm bar at (/x/,/y/).</i></font>
<a name="line-606"></a><font color=Blue>render_dbar</font> <font color=Red>::</font> FormatStyle <font color=Red>-&gt;</font> X <font color=Red>-&gt;</font> Y <font color=Red>-&gt;</font> Draw ()
<a name="line-607"></a><font color=Blue>render_dbar</font> fs x y <font color=Red>=</font> draw_subroutine alt <font color=Cyan>$</font> <font color=Green><u>do</u></font>
<a name="line-608"></a>  block <font color=Cyan>$</font> <font color=Green><u>do</u></font>
<a name="line-609"></a>    translate <font color=Cyan>(</font>x<font color=Cyan>+</font><font color=Cyan>(</font>barwidth fs<font color=Cyan>)</font><font color=Cyan>/</font><font color=Magenta>2</font><font color=Cyan>)</font> y
<a name="line-610"></a>    scale <font color=Cyan>(</font>dwidth fs<font color=Cyan>)</font> <font color=Cyan>(</font>dheight fs<font color=Cyan>)</font>
<a name="line-611"></a>    moveto <font color=Cyan>(</font><font color=Blue><i>-</i></font><font color=Magenta>1</font><font color=Cyan>)</font> <font color=Cyan>(</font><font color=Blue><i>-</i></font><font color=Magenta>0.5</font><font color=Cyan>)</font>
<a name="line-612"></a>    arc_append <font color=Cyan>(</font><font color=Blue><i>-</i></font><font color=Magenta>0.5</font><font color=Cyan>)</font> <font color=Magenta>0</font> <font color=Magenta>0.5</font> <font color=Cyan>(</font><font color=Blue><i>-</i></font><font color=Magenta>90</font><font color=Cyan>)</font> <font color=Magenta>90</font>
<a name="line-613"></a>    lineto <font color=Cyan>(</font><font color=Blue><i>-</i></font><font color=Magenta>1</font><font color=Cyan>)</font> <font color=Magenta>0.5</font>
<a name="line-614"></a>    closepath
<a name="line-615"></a>    fill <font color=Cyan>(</font>foregroundcolor fs<font color=Cyan>)</font>
<a name="line-616"></a>  <font color=Green><u>where</u></font>
<a name="line-617"></a>    alt <font color=Red>=</font> <font color=Red>[</font>custom_ps <font color=Cyan>$</font> printf <font color=Magenta>"%f %f dbar\n"</font> x y<font color=Red>]</font>
<a name="line-618"></a>
<a name="line-619"></a><a name="render_init"></a><font color=Blue><i>-- | @'render_init' name x y@: Draw an \"init\" gate at</i></font>
<a name="line-620"></a><font color=Blue><i>-- (/x/,/y/), with state /name/.</i></font>
<a name="line-621"></a><font color=Blue>render_init</font> <font color=Red>::</font> FormatStyle <font color=Red>-&gt;</font> String <font color=Red>-&gt;</font> X <font color=Red>-&gt;</font> Y <font color=Red>-&gt;</font> Draw ()
<a name="line-622"></a><font color=Blue>render_init</font> fs name x y <font color=Red>=</font> draw_subroutine alt <font color=Cyan>$</font> <font color=Green><u>do</u></font>
<a name="line-623"></a>  render_bar fs x y
<a name="line-624"></a>  textbox align_right <font color=Cyan>(</font>gatefont fs<font color=Cyan>)</font> <font color=Cyan>(</font>foregroundcolor fs<font color=Cyan>)</font> <font color=Cyan>(</font>x<font color=Blue><i>-</i></font><font color=Cyan>(</font>xoff fs<font color=Cyan>)</font><font color=Cyan>/</font><font color=Magenta>2</font><font color=Cyan>+</font><font color=Cyan>(</font>gatepad fs<font color=Cyan>)</font><font color=Cyan>/</font><font color=Magenta>2</font><font color=Cyan>)</font> y <font color=Cyan>(</font>x<font color=Blue><i>-</i></font><font color=Cyan>(</font>gatepad fs<font color=Cyan>)</font><font color=Cyan>/</font><font color=Magenta>2</font><font color=Cyan>)</font> y <font color=Cyan>(</font>stringbase fs<font color=Cyan>)</font> name
<a name="line-625"></a>  <font color=Green><u>where</u></font>
<a name="line-626"></a>    alt <font color=Red>=</font> <font color=Red>[</font>custom_ps <font color=Cyan>$</font> printf <font color=Magenta>"(%s) %f %f init\n"</font> <font color=Cyan>(</font>ps_escape name<font color=Cyan>)</font> x y<font color=Red>]</font>
<a name="line-627"></a>
<a name="line-628"></a><a name="render_term"></a><font color=Blue><i>-- | @'render_term' name x y@: Draw a \"term\" gate at</i></font>
<a name="line-629"></a><font color=Blue><i>-- (/x/,/y/), with state /name/.</i></font>
<a name="line-630"></a><font color=Blue>render_term</font> <font color=Red>::</font> FormatStyle <font color=Red>-&gt;</font> String <font color=Red>-&gt;</font> X <font color=Red>-&gt;</font> Y <font color=Red>-&gt;</font> Draw ()
<a name="line-631"></a><font color=Blue>render_term</font> fs name x y <font color=Red>=</font> draw_subroutine alt <font color=Cyan>$</font> <font color=Green><u>do</u></font>
<a name="line-632"></a>  render_bar fs x y
<a name="line-633"></a>  textbox align_left <font color=Cyan>(</font>gatefont fs<font color=Cyan>)</font> <font color=Cyan>(</font>foregroundcolor fs<font color=Cyan>)</font> <font color=Cyan>(</font>x<font color=Cyan>+</font><font color=Cyan>(</font>gatepad fs<font color=Cyan>)</font><font color=Cyan>/</font><font color=Magenta>2</font><font color=Cyan>)</font> y <font color=Cyan>(</font>x<font color=Cyan>+</font><font color=Cyan>(</font>xoff fs<font color=Cyan>)</font><font color=Cyan>/</font><font color=Magenta>2</font><font color=Blue><i>-</i></font><font color=Cyan>(</font>gatepad fs<font color=Cyan>)</font><font color=Cyan>/</font><font color=Magenta>2</font><font color=Cyan>)</font> y <font color=Cyan>(</font>stringbase fs<font color=Cyan>)</font> name
<a name="line-634"></a>  <font color=Green><u>where</u></font>
<a name="line-635"></a>    alt <font color=Red>=</font> <font color=Red>[</font>custom_ps <font color=Cyan>$</font> printf <font color=Magenta>"(%s) %f %f term\n"</font> <font color=Cyan>(</font>ps_escape name<font color=Cyan>)</font> x y<font color=Red>]</font>
<a name="line-636"></a>
<a name="line-637"></a><a name="render_dterm"></a><font color=Blue><i>-- | @'render_dterm' name x y@: Draw a \"dterm\" gate at</i></font>
<a name="line-638"></a><font color=Blue><i>-- (/x/,/y/), with state /name/.</i></font>
<a name="line-639"></a><font color=Blue>render_dterm</font> <font color=Red>::</font> FormatStyle <font color=Red>-&gt;</font> String <font color=Red>-&gt;</font> X <font color=Red>-&gt;</font> Y <font color=Red>-&gt;</font> Draw ()
<a name="line-640"></a><font color=Blue>render_dterm</font> fs name x y <font color=Red>=</font> draw_subroutine alt <font color=Cyan>$</font> <font color=Green><u>do</u></font>
<a name="line-641"></a>  render_dbar fs x y
<a name="line-642"></a>  textbox align_left <font color=Cyan>(</font>gatefont fs<font color=Cyan>)</font> <font color=Cyan>(</font>foregroundcolor fs<font color=Cyan>)</font> <font color=Cyan>(</font>x<font color=Cyan>+</font><font color=Cyan>(</font>gatepad fs<font color=Cyan>)</font><font color=Cyan>/</font><font color=Magenta>2</font><font color=Cyan>)</font> y <font color=Cyan>(</font>x<font color=Cyan>+</font><font color=Cyan>(</font>xoff fs<font color=Cyan>)</font><font color=Cyan>/</font><font color=Magenta>2</font><font color=Blue><i>-</i></font><font color=Cyan>(</font>gatepad fs<font color=Cyan>)</font><font color=Cyan>/</font><font color=Magenta>2</font><font color=Cyan>)</font> y <font color=Cyan>(</font>stringbase fs<font color=Cyan>)</font> name
<a name="line-643"></a>  <font color=Green><u>where</u></font>
<a name="line-644"></a>    alt <font color=Red>=</font> <font color=Red>[</font>custom_ps <font color=Cyan>$</font> printf <font color=Magenta>"(%s) %f %f dterm\n"</font> <font color=Cyan>(</font>ps_escape name<font color=Cyan>)</font> x y<font color=Red>]</font>
<a name="line-645"></a>
<a name="line-646"></a><a name="render_namedgate"></a><font color=Blue><i>-- | @'render_namedgate' name inv x y@: draw a named box centered at</i></font>
<a name="line-647"></a><font color=Blue><i>-- (/x/,/y/). If /inv/ = 'True', append an \"inverse\" symbol to the</i></font>
<a name="line-648"></a><font color=Blue><i>-- end of the name.</i></font>
<a name="line-649"></a><font color=Blue>render_namedgate</font> <font color=Red>::</font> FormatStyle <font color=Red>-&gt;</font> String <font color=Red>-&gt;</font> InverseFlag <font color=Red>-&gt;</font> X <font color=Red>-&gt;</font> Y <font color=Red>-&gt;</font> Draw ()
<a name="line-650"></a><font color=Blue>render_namedgate</font> fs name inv x y <font color=Red>=</font> draw_subroutine alt <font color=Cyan>$</font> <font color=Green><u>do</u></font>
<a name="line-651"></a>  rectangle <font color=Cyan>(</font>x<font color=Blue><i>-</i></font>gatewidth<font color=Cyan>/</font><font color=Magenta>2</font><font color=Cyan>)</font> <font color=Cyan>(</font>y<font color=Blue><i>-</i></font><font color=Cyan>(</font>gateheight fs<font color=Cyan>)</font><font color=Cyan>/</font><font color=Magenta>2</font><font color=Cyan>)</font> gatewidth <font color=Cyan>(</font>gateheight fs<font color=Cyan>)</font>
<a name="line-652"></a>  fillstroke <font color=Cyan>(</font>backgroundcolor fs<font color=Cyan>)</font>
<a name="line-653"></a>  textbox align_center <font color=Cyan>(</font>gatefont fs<font color=Cyan>)</font> <font color=Cyan>(</font>foregroundcolor fs<font color=Cyan>)</font> <font color=Cyan>(</font>x<font color=Blue><i>-</i></font>labelwidth<font color=Cyan>/</font><font color=Magenta>2</font><font color=Cyan>)</font> y <font color=Cyan>(</font>x<font color=Cyan>+</font>labelwidth<font color=Cyan>/</font><font color=Magenta>2</font><font color=Cyan>)</font> y <font color=Cyan>(</font>stringbase fs<font color=Cyan>)</font> name'
<a name="line-654"></a>  <font color=Green><u>where</u></font>
<a name="line-655"></a>    alt <font color=Red>=</font> <font color=Red>[</font>custom_ps <font color=Cyan>$</font> printf <font color=Magenta>"(%s) %f %f gate\n"</font> <font color=Cyan>(</font>ps_escape name'<font color=Cyan>)</font> x y<font color=Red>]</font>
<a name="line-656"></a>    name' <font color=Red>=</font> name <font color=Cyan>++</font> optional inv <font color=Magenta>"*"</font>
<a name="line-657"></a>    w <font color=Red>=</font> text_width <font color=Cyan>(</font>gatefont fs<font color=Cyan>)</font> name'
<a name="line-658"></a>    labelwidth <font color=Red>=</font> min w <font color=Cyan>(</font>maxgatelabelwidth fs<font color=Cyan>)</font>
<a name="line-659"></a>    gatewidth <font color=Red>=</font> labelwidth <font color=Cyan>+</font> <font color=Cyan>(</font>gatepad fs<font color=Cyan>)</font>
<a name="line-660"></a>            
<a name="line-661"></a><a name="render_gphasegate"></a><font color=Blue><i>-- | @'render_gphasegate' name x y@: draw a global phase gate</i></font>
<a name="line-662"></a><font color=Blue><i>-- centered at (/x/,/y/).</i></font>
<a name="line-663"></a><font color=Blue>render_gphasegate</font> <font color=Red>::</font> FormatStyle <font color=Red>-&gt;</font> String <font color=Red>-&gt;</font> X <font color=Red>-&gt;</font> Y <font color=Red>-&gt;</font> Draw ()
<a name="line-664"></a><font color=Blue>render_gphasegate</font> fs name x y <font color=Red>=</font> draw_subroutine alt <font color=Cyan>$</font> <font color=Green><u>do</u></font>
<a name="line-665"></a>  render_circgate fs name x <font color=Cyan>(</font>y<font color=Blue><i>-</i></font><font color=Magenta>0.5</font><font color=Cyan>)</font>
<a name="line-666"></a>  <font color=Green><u>where</u></font>
<a name="line-667"></a>    alt <font color=Red>=</font> <font color=Red>[</font>custom_ps <font color=Cyan>$</font> printf <font color=Magenta>"(%s) %f %f gphase\n"</font> <font color=Cyan>(</font>ps_escape name<font color=Cyan>)</font> x y<font color=Red>]</font>
<a name="line-668"></a>
<a name="line-669"></a><a name="render_circgate"></a><font color=Blue><i>-- | @'render_circgate' name x y@: draw a named oval centered at</i></font>
<a name="line-670"></a><font color=Blue><i>-- (/x/,/y/).</i></font>
<a name="line-671"></a><font color=Blue>render_circgate</font> <font color=Red>::</font> FormatStyle <font color=Red>-&gt;</font> String <font color=Red>-&gt;</font> X <font color=Red>-&gt;</font> Y <font color=Red>-&gt;</font> Draw ()
<a name="line-672"></a><font color=Blue>render_circgate</font> fs name x y <font color=Red>=</font> draw_subroutine alt <font color=Cyan>$</font> <font color=Green><u>do</u></font>
<a name="line-673"></a>  oval x y <font color=Cyan>(</font><font color=Magenta>0.5</font><font color=Cyan>*</font>gatewidth<font color=Cyan>)</font> <font color=Cyan>(</font><font color=Magenta>0.4</font><font color=Cyan>*</font><font color=Cyan>(</font>gateheight fs<font color=Cyan>)</font><font color=Cyan>)</font>
<a name="line-674"></a>  fillstroke <font color=Cyan>(</font>backgroundcolor fs<font color=Cyan>)</font>
<a name="line-675"></a>  textbox align_center <font color=Cyan>(</font>gatefont fs<font color=Cyan>)</font> <font color=Cyan>(</font>foregroundcolor fs<font color=Cyan>)</font> <font color=Cyan>(</font>x<font color=Blue><i>-</i></font>labelwidth<font color=Cyan>/</font><font color=Magenta>2</font><font color=Cyan>)</font> y <font color=Cyan>(</font>x<font color=Cyan>+</font>labelwidth<font color=Cyan>/</font><font color=Magenta>2</font><font color=Cyan>)</font> y <font color=Cyan>(</font>stringbase fs<font color=Cyan>)</font> name
<a name="line-676"></a>  <font color=Green><u>where</u></font>
<a name="line-677"></a>    alt <font color=Red>=</font> <font color=Red>[</font>custom_ps <font color=Cyan>$</font> printf <font color=Magenta>"(%s) %f %f circgate\n"</font> <font color=Cyan>(</font>ps_escape name<font color=Cyan>)</font> x y<font color=Red>]</font>
<a name="line-678"></a>    w <font color=Red>=</font> text_width <font color=Cyan>(</font>gatefont fs<font color=Cyan>)</font> name
<a name="line-679"></a>    labelwidth <font color=Red>=</font> min w <font color=Cyan>(</font>maxgatelabelwidth fs<font color=Cyan>)</font>
<a name="line-680"></a>    gatewidth <font color=Red>=</font> labelwidth <font color=Cyan>+</font> <font color=Cyan>(</font>gatepad fs<font color=Cyan>)</font>
<a name="line-681"></a>    
<a name="line-682"></a><a name="render_blankgate"></a><font color=Blue><i>-- | @'render_blankgate' name x y@: draw an empty box centered</i></font>
<a name="line-683"></a><font color=Blue><i>-- at (/x/,/y/), big enough to hold /name/.</i></font>
<a name="line-684"></a><font color=Blue>render_blankgate</font> <font color=Red>::</font> FormatStyle <font color=Red>-&gt;</font> String <font color=Red>-&gt;</font> X <font color=Red>-&gt;</font> Y <font color=Red>-&gt;</font> Draw ()
<a name="line-685"></a><font color=Blue>render_blankgate</font> fs name x y <font color=Red>=</font> draw_subroutine alt <font color=Cyan>$</font> <font color=Green><u>do</u></font>
<a name="line-686"></a>  rectangle <font color=Cyan>(</font>x<font color=Blue><i>-</i></font>gatewidth<font color=Cyan>/</font><font color=Magenta>2</font><font color=Cyan>)</font> <font color=Cyan>(</font>y<font color=Blue><i>-</i></font><font color=Cyan>(</font>gateheight fs<font color=Cyan>)</font><font color=Cyan>/</font><font color=Magenta>2</font><font color=Cyan>)</font> gatewidth <font color=Cyan>(</font>gateheight fs<font color=Cyan>)</font>
<a name="line-687"></a>  fillstroke <font color=Cyan>(</font>backgroundcolor fs<font color=Cyan>)</font>
<a name="line-688"></a>  <font color=Green><u>where</u></font>
<a name="line-689"></a>    alt <font color=Red>=</font> <font color=Red>[</font>custom_ps <font color=Cyan>$</font> printf <font color=Magenta>"(%s) %f %f box\n"</font> <font color=Cyan>(</font>ps_escape name<font color=Cyan>)</font> x y<font color=Red>]</font>
<a name="line-690"></a>    w <font color=Red>=</font> text_width <font color=Cyan>(</font>gatefont fs<font color=Cyan>)</font> name
<a name="line-691"></a>    labelwidth <font color=Red>=</font> min w <font color=Cyan>(</font>maxgatelabelwidth fs<font color=Cyan>)</font>
<a name="line-692"></a>    gatewidth <font color=Red>=</font> labelwidth <font color=Cyan>+</font> <font color=Cyan>(</font>gatepad fs<font color=Cyan>)</font>
<a name="line-693"></a>
<a name="line-694"></a><a name="render_comment"></a><font color=Blue><i>-- | @'render_comment' center s x y m@: draw the given string</i></font>
<a name="line-695"></a><font color=Blue><i>-- vertically, with the top of the string near the given</i></font>
<a name="line-696"></a><font color=Blue><i>-- /y/-coordinate. If /center/=='True', center it at the</i></font>
<a name="line-697"></a><font color=Blue><i>-- /x/-coordinate, else move it just to the left of the</i></font>
<a name="line-698"></a><font color=Blue><i>-- /x/-coordinate. /m/ is the maximum height allowed for the comment.</i></font>
<a name="line-699"></a><font color=Blue>render_comment</font> <font color=Red>::</font> FormatStyle <font color=Red>-&gt;</font> Bool <font color=Red>-&gt;</font> String <font color=Red>-&gt;</font> X <font color=Red>-&gt;</font> Y <font color=Red>-&gt;</font> Y <font color=Red>-&gt;</font> Draw ()
<a name="line-700"></a><font color=Blue>render_comment</font> fs center s x y maxh <font color=Red>=</font> draw_subroutine alt <font color=Cyan>$</font> <font color=Green><u>do</u></font>
<a name="line-701"></a>  textbox align_right <font color=Cyan>(</font>commentfont fs<font color=Cyan>)</font> <font color=Cyan>(</font>commentcolor fs<font color=Cyan>)</font> x <font color=Cyan>(</font>y<font color=Blue><i>-</i></font>maxh<font color=Cyan>)</font> x <font color=Cyan>(</font>y<font color=Cyan>+</font><font color=Magenta>0.4</font><font color=Cyan>)</font> b s
<a name="line-702"></a>  <font color=Green><u>where</u></font>
<a name="line-703"></a>    alt <font color=Red>=</font> <font color=Red>[</font>custom_ps <font color=Cyan>$</font> printf <font color=Magenta>"(%s) %f %f %f %f comment\n"</font> <font color=Cyan>(</font>ps_escape s<font color=Cyan>)</font> x y maxh yshift<font color=Red>]</font>
<a name="line-704"></a>    b <font color=Red>=</font> <font color=Green><u>if</u></font> center <font color=Green><u>then</u></font> <font color=Magenta>0.15</font> <font color=Green><u>else</u></font> <font color=Blue><i>-</i></font><font color=Magenta>0.25</font>
<a name="line-705"></a>    yshift <font color=Red>=</font> <font color=Blue><i>-</i></font>b <font color=Cyan>*</font> nominalsize <font color=Cyan>(</font>commentfont fs<font color=Cyan>)</font>
<a name="line-706"></a>
<a name="line-707"></a><a name="render_label"></a><font color=Blue><i>-- | @'render_label' center s x y@: draw the given label just above</i></font>
<a name="line-708"></a><font color=Blue><i>-- the given point. If /center/=='True', center it at the</i></font>
<a name="line-709"></a><font color=Blue><i>-- /x/-coordinate, else move it just to the right of the</i></font>
<a name="line-710"></a><font color=Blue><i>-- /x/-coordinate.</i></font>
<a name="line-711"></a><font color=Blue>render_label</font> <font color=Red>::</font> FormatStyle <font color=Red>-&gt;</font> Bool <font color=Red>-&gt;</font> String <font color=Red>-&gt;</font> X <font color=Red>-&gt;</font> Y <font color=Red>-&gt;</font> Draw ()
<a name="line-712"></a><font color=Blue>render_label</font> fs True s x y <font color=Red>=</font> draw_subroutine alt <font color=Cyan>$</font> <font color=Green><u>do</u></font>
<a name="line-713"></a>  textbox align_center <font color=Cyan>(</font>labelfont fs<font color=Cyan>)</font> <font color=Cyan>(</font>labelcolor fs<font color=Cyan>)</font> <font color=Cyan>(</font>x<font color=Blue><i>-</i></font><font color=Cyan>(</font>maxlabelwidth fs<font color=Cyan>)</font><font color=Cyan>)</font> y' <font color=Cyan>(</font>x<font color=Cyan>+</font><font color=Cyan>(</font>maxlabelwidth fs<font color=Cyan>)</font><font color=Cyan>)</font> y' <font color=Cyan>(</font><font color=Blue><i>-</i></font><font color=Magenta>0.5</font><font color=Cyan>)</font> s
<a name="line-714"></a>  <font color=Green><u>where</u></font>
<a name="line-715"></a>    alt <font color=Red>=</font> <font color=Red>[</font>custom_ps <font color=Cyan>$</font> printf <font color=Magenta>"(%s) %f %f clabel\n"</font> <font color=Cyan>(</font>ps_escape s<font color=Cyan>)</font> x y'<font color=Red>]</font>
<a name="line-716"></a>    y' <font color=Red>=</font> y <font color=Cyan>+</font> <font color=Magenta>0.5</font> <font color=Cyan>*</font> <font color=Cyan>(</font>coffs fs<font color=Cyan>)</font>
<a name="line-717"></a><font color=Blue>render_label</font> fs False s x y <font color=Red>=</font> draw_subroutine alt <font color=Cyan>$</font> <font color=Green><u>do</u></font>
<a name="line-718"></a>  textbox align_left <font color=Cyan>(</font>labelfont fs<font color=Cyan>)</font> <font color=Cyan>(</font>labelcolor fs<font color=Cyan>)</font> x y' <font color=Cyan>(</font>x<font color=Cyan>+</font><font color=Cyan>(</font>maxlabelwidth fs<font color=Cyan>)</font><font color=Cyan>)</font> y' <font color=Cyan>(</font><font color=Blue><i>-</i></font><font color=Magenta>0.5</font><font color=Cyan>)</font> s
<a name="line-719"></a>  <font color=Green><u>where</u></font>
<a name="line-720"></a>    alt <font color=Red>=</font> <font color=Red>[</font>custom_ps <font color=Cyan>$</font> printf <font color=Magenta>"(%s) %f %f rlabel\n"</font> <font color=Cyan>(</font>ps_escape s<font color=Cyan>)</font> x y'<font color=Red>]</font>
<a name="line-721"></a>    y' <font color=Red>=</font> y <font color=Cyan>+</font> <font color=Magenta>0.5</font> <font color=Cyan>*</font> <font color=Cyan>(</font>coffs fs<font color=Cyan>)</font>
<a name="line-722"></a>    
<a name="line-723"></a><a name="render_number"></a><font color=Blue><i>-- | Render the number at the given point (/x/,/y/). If the boolean</i></font>
<a name="line-724"></a><font color=Blue><i>-- argument is 'True', put the number to the right of /x/, else to the left. </i></font>
<a name="line-725"></a><font color=Blue>render_number</font> <font color=Red>::</font> FormatStyle <font color=Red>-&gt;</font> Int <font color=Red>-&gt;</font> Bool <font color=Red>-&gt;</font> X <font color=Red>-&gt;</font> Y <font color=Red>-&gt;</font> Draw ()
<a name="line-726"></a><font color=Blue>render_number</font> fs i True x y <font color=Red>=</font> draw_subroutine alt <font color=Cyan>$</font> <font color=Green><u>do</u></font>
<a name="line-727"></a>  textbox align_left <font color=Cyan>(</font>numberfont fs<font color=Cyan>)</font> <font color=Cyan>(</font>numbercolor fs<font color=Cyan>)</font> <font color=Cyan>(</font>x<font color=Cyan>+</font><font color=Magenta>0.2</font><font color=Cyan>)</font> y <font color=Cyan>(</font>x<font color=Cyan>+</font><font color=Magenta>0.2</font><font color=Cyan>+</font><font color=Cyan>(</font>maxnumberwidth fs<font color=Cyan>)</font><font color=Cyan>)</font> y <font color=Cyan>(</font>stringbase fs<font color=Cyan>)</font> <font color=Cyan>(</font>show i<font color=Cyan>)</font>
<a name="line-728"></a>  <font color=Green><u>where</u></font>
<a name="line-729"></a>    alt <font color=Red>=</font> <font color=Red>[</font>custom_ps <font color=Cyan>$</font> printf <font color=Magenta>"(%s) %f %f rnumber\n"</font> <font color=Cyan>(</font>ps_escape <font color=Cyan>(</font>show i<font color=Cyan>)</font><font color=Cyan>)</font> x y<font color=Red>]</font>
<a name="line-730"></a><font color=Blue>render_number</font> fs i False x y <font color=Red>=</font> draw_subroutine alt <font color=Cyan>$</font> <font color=Green><u>do</u></font>
<a name="line-731"></a>  textbox align_right <font color=Cyan>(</font>numberfont fs<font color=Cyan>)</font> <font color=Cyan>(</font>numbercolor fs<font color=Cyan>)</font> <font color=Cyan>(</font>x<font color=Blue><i>-</i></font><font color=Magenta>0.2</font><font color=Blue><i>-</i></font><font color=Cyan>(</font>maxnumberwidth fs<font color=Cyan>)</font><font color=Cyan>)</font> y <font color=Cyan>(</font>x<font color=Blue><i>-</i></font><font color=Magenta>0.2</font><font color=Cyan>)</font> y <font color=Cyan>(</font>stringbase fs<font color=Cyan>)</font> <font color=Cyan>(</font>show i<font color=Cyan>)</font>
<a name="line-732"></a>  <font color=Green><u>where</u></font>
<a name="line-733"></a>    alt <font color=Red>=</font> <font color=Red>[</font>custom_ps <font color=Cyan>$</font> printf <font color=Magenta>"(%s) %f %f lnumber\n"</font> <font color=Cyan>(</font>ps_escape <font color=Cyan>(</font>show i<font color=Cyan>)</font><font color=Cyan>)</font> x y<font color=Red>]</font>
<a name="line-734"></a>
<a name="line-735"></a><font color=Blue><i>-- ----------------------------------------------------------------------</i></font>
<a name="line-736"></a><font color=Blue><i>-- ** Higher-level rendering functions</i></font>
<a name="line-737"></a>
<a name="line-738"></a><a name="render_typeas"></a><font color=Blue><i>-- | Render a horizontal wire from /x/-coordinates /oldx/ to /x/,</i></font>
<a name="line-739"></a><font color=Blue><i>-- using /t/ as the type and figuring out the /y/-coordinate from /ys/</i></font>
<a name="line-740"></a><font color=Blue><i>-- and /w/. Append to the given string. If the parameters are invalid</i></font>
<a name="line-741"></a><font color=Blue><i>-- (/w/ not in /ys/), throw an error.</i></font>
<a name="line-742"></a><font color=Blue>render_typeas</font> <font color=Red>::</font> FormatStyle <font color=Red>-&gt;</font> Map Wire Y <font color=Red>-&gt;</font> X <font color=Red>-&gt;</font> X <font color=Red>-&gt;</font> Wire <font color=Red>-&gt;</font> Wiretype <font color=Red>-&gt;</font> Draw ()
<a name="line-743"></a><font color=Blue>render_typeas</font> fs ys oldx x w t <font color=Red>=</font>
<a name="line-744"></a>  <font color=Green><u>let</u></font> y <font color=Red>=</font> ys Map<font color=Cyan>.!</font> w <font color=Green><u>in</u></font>
<a name="line-745"></a>  <font color=Green><u>case</u></font> t <font color=Green><u>of</u></font>
<a name="line-746"></a>    Qbit <font color=Red>-&gt;</font> <font color=Green><u>do</u></font>
<a name="line-747"></a>      render_line oldx y x y
<a name="line-748"></a>    Cbit <font color=Red>-&gt;</font> <font color=Green><u>do</u></font>
<a name="line-749"></a>      render_line oldx <font color=Cyan>(</font>y <font color=Cyan>+</font> <font color=Cyan>(</font>coffs fs<font color=Cyan>)</font><font color=Cyan>)</font> x <font color=Cyan>(</font>y <font color=Cyan>+</font> <font color=Cyan>(</font>coffs fs<font color=Cyan>)</font><font color=Cyan>)</font>
<a name="line-750"></a>      render_line oldx <font color=Cyan>(</font>y <font color=Blue><i>-</i></font> <font color=Cyan>(</font>coffs fs<font color=Cyan>)</font><font color=Cyan>)</font> x <font color=Cyan>(</font>y <font color=Blue><i>-</i></font> <font color=Cyan>(</font>coffs fs<font color=Cyan>)</font><font color=Cyan>)</font>
<a name="line-751"></a>
<a name="line-752"></a><a name="render_xarity"></a><font color=Blue><i>-- | Render a bunch of horizontal wires from their repective starting</i></font>
<a name="line-753"></a><font color=Blue><i>-- 'Xarity' to /x/.</i></font>
<a name="line-754"></a><font color=Blue>render_xarity</font> <font color=Red>::</font> FormatStyle <font color=Red>-&gt;</font> Map Wire Y <font color=Red>-&gt;</font> Xarity <font color=Red>-&gt;</font> X <font color=Red>-&gt;</font> Draw ()
<a name="line-755"></a><font color=Blue>render_xarity</font> fs ys xarity x <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-756"></a>  sequence_ <font color=Red>[</font> render_typeas fs ys oldx x w t <font color=Red>|</font> <font color=Cyan>(</font>w<font color=Cyan>,</font><font color=Cyan>(</font>t<font color=Cyan>,</font>oldx<font color=Cyan>)</font><font color=Cyan>)</font> <font color=Red>&lt;-</font> Map<font color=Cyan>.</font>toList xarity <font color=Red>]</font>
<a name="line-757"></a>
<a name="line-758"></a><a name="dshow"></a><font color=Blue><i>-- | Format a floating point number in concise form, with limited</i></font>
<a name="line-759"></a><font color=Blue><i>-- accuracy.</i></font>
<a name="line-760"></a><font color=Blue>dshow</font> <font color=Red>::</font> Double <font color=Red>-&gt;</font> String
<a name="line-761"></a><font color=Blue>dshow</font> dbl <font color=Red>=</font> 
<a name="line-762"></a>  <font color=Green><u>if</u></font> abs dbl <font color=Cyan>&lt;</font> <font color=Magenta>0.01</font> 
<a name="line-763"></a>  <font color=Green><u>then</u></font>
<a name="line-764"></a>    printf <font color=Magenta>"%.1e"</font> dbl
<a name="line-765"></a>  <font color=Green><u>else</u></font>
<a name="line-766"></a>    <font color=Cyan>(</font>reverse <font color=Cyan>.</font> strip <font color=Cyan>.</font> reverse<font color=Cyan>)</font> <font color=Cyan>(</font>printf <font color=Magenta>"%.3f"</font> dbl<font color=Cyan>)</font>
<a name="line-767"></a>      <font color=Green><u>where</u></font>
<a name="line-768"></a>        strip [] <font color=Red>=</font> []
<a name="line-769"></a>        strip <font color=Cyan>(</font><font color=Magenta>'.'</font> <font color=Red><b>:</b></font> t<font color=Cyan>)</font> <font color=Red>=</font> t
<a name="line-770"></a>        strip <font color=Cyan>(</font><font color=Magenta>'0'</font> <font color=Red><b>:</b></font> t<font color=Cyan>)</font> <font color=Red>=</font> strip t
<a name="line-771"></a>        strip t <font color=Red>=</font> t
<a name="line-772"></a>        
<a name="line-773"></a><a name="render_controlwire"></a><font color=Blue><i>-- | @'render_controlwire' /x/ /ys/ /ws/ /c/@: </i></font>
<a name="line-774"></a><font color=Blue><i>-- Render the line connecting all the box components and all the</i></font>
<a name="line-775"></a><font color=Blue><i>-- control dots of some gate. </i></font>
<a name="line-776"></a><font color=Blue><i>-- </i></font>
<a name="line-777"></a><font color=Blue><i>-- Parameters: /x/ is the current /x/-coordinate, /ys/ is an indexed</i></font>
<a name="line-778"></a><font color=Blue><i>-- array of /y/-coordinates, /ws/ is the set of wires for boxes, and</i></font>
<a name="line-779"></a><font color=Blue><i>-- /c/ is a list of controls.</i></font>
<a name="line-780"></a><font color=Blue>render_controlwire</font> <font color=Red>::</font> X <font color=Red>-&gt;</font> Map Wire Y <font color=Red>-&gt;</font> <font color=Red>[</font>Wire<font color=Red>]</font> <font color=Red>-&gt;</font> Controls <font color=Red>-&gt;</font> Draw ()
<a name="line-781"></a><font color=Blue>render_controlwire</font> x ys ws c <font color=Red>=</font>
<a name="line-782"></a>  <font color=Green><u>case</u></font> ws <font color=Green><u>of</u></font>
<a name="line-783"></a>    [] <font color=Red>-&gt;</font> return ()
<a name="line-784"></a>    w<font color=Red><b>:</b></font>ws <font color=Red>-&gt;</font> render_line x y0 x y1      
<a name="line-785"></a>      <font color=Green><u>where</u></font>
<a name="line-786"></a>        ymap w <font color=Red>=</font> ys Map<font color=Cyan>.!</font> w
<a name="line-787"></a>        y <font color=Red>=</font> ymap w
<a name="line-788"></a>        cy <font color=Red>=</font> map <font color=Cyan>(</font><font color=Red>\</font><font color=Cyan>(</font>Signed w <font color=Green><u>_</u></font><font color=Cyan>)</font> <font color=Red>-&gt;</font> ymap w<font color=Cyan>)</font> c
<a name="line-789"></a>        yy <font color=Red>=</font> map <font color=Cyan>(</font><font color=Red>\</font>w <font color=Red>-&gt;</font> ymap w<font color=Cyan>)</font> ws
<a name="line-790"></a>        y0 <font color=Red>=</font> foldr min y <font color=Cyan>(</font>cy <font color=Cyan>++</font> yy<font color=Cyan>)</font>
<a name="line-791"></a>        y1 <font color=Red>=</font> foldr max y <font color=Cyan>(</font>cy <font color=Cyan>++</font> yy<font color=Cyan>)</font>
<a name="line-792"></a>
<a name="line-793"></a><a name="render_controlwire_float"></a><font color=Blue><i>-- | @'render_controlwire_float' /x/ /ys/ /y/ /c/@: Render the line</i></font>
<a name="line-794"></a><font color=Blue><i>-- connecting all control dots of the given controls, as well as a</i></font>
<a name="line-795"></a><font color=Blue><i>-- floating \"global phase\" gate located just below (/x/, /y/). </i></font>
<a name="line-796"></a><font color=Blue><i>-- </i></font>
<a name="line-797"></a><font color=Blue><i>-- Parameters: /x/ is the current /x/-coordinate, /ys/ is an indexed</i></font>
<a name="line-798"></a><font color=Blue><i>-- array of /y/-coordinates, /y/ is the /y/-coordinate of the wire</i></font>
<a name="line-799"></a><font color=Blue><i>-- where the floating gate is attached, and /c/ is a list of controls.</i></font>
<a name="line-800"></a><font color=Blue>render_controlwire_float</font> <font color=Red>::</font> X <font color=Red>-&gt;</font> Map Wire Y <font color=Red>-&gt;</font> Y <font color=Red>-&gt;</font> Controls <font color=Red>-&gt;</font> Draw ()
<a name="line-801"></a><font color=Blue>render_controlwire_float</font> x ys y c <font color=Red>=</font> render_line x y0 x y1 
<a name="line-802"></a>  <font color=Green><u>where</u></font>
<a name="line-803"></a>    y' <font color=Red>=</font> y <font color=Blue><i>-</i></font> <font color=Magenta>0.5</font>
<a name="line-804"></a>    cy <font color=Red>=</font> map <font color=Cyan>(</font><font color=Red>\</font><font color=Cyan>(</font>Signed w <font color=Green><u>_</u></font><font color=Cyan>)</font> <font color=Red>-&gt;</font> ys Map<font color=Cyan>.!</font> w<font color=Cyan>)</font> c
<a name="line-805"></a>    y0 <font color=Red>=</font> minimum <font color=Cyan>(</font>y'<font color=Red><b>:</b></font>cy<font color=Cyan>)</font>
<a name="line-806"></a>    y1 <font color=Red>=</font> maximum <font color=Cyan>(</font>y'<font color=Red><b>:</b></font>cy<font color=Cyan>)</font>
<a name="line-807"></a>
<a name="line-808"></a><a name="render_controldots"></a><font color=Blue><i>-- | @'render_controldots' /x/ /ys/ /c/@: Render the control dots</i></font>
<a name="line-809"></a><font color=Blue><i>-- for the given controls.</i></font>
<a name="line-810"></a><font color=Blue>render_controldots</font> <font color=Red>::</font> FormatStyle <font color=Red>-&gt;</font> X <font color=Red>-&gt;</font> Map Wire Y <font color=Red>-&gt;</font> Controls <font color=Red>-&gt;</font> Draw ()
<a name="line-811"></a><font color=Blue>render_controldots</font> fs x ys c <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-812"></a>  sequence_ <font color=Red>[</font> renderdot x <font color=Red>|</font> x <font color=Red>&lt;-</font> c <font color=Red>]</font>
<a name="line-813"></a>  <font color=Green><u>where</u></font>
<a name="line-814"></a>    renderdot <font color=Cyan>(</font>Signed w True<font color=Cyan>)</font> <font color=Red>=</font> render_dot fs x <font color=Cyan>(</font>ys Map<font color=Cyan>.!</font> w<font color=Cyan>)</font>
<a name="line-815"></a>    renderdot <font color=Cyan>(</font>Signed w False<font color=Cyan>)</font> <font color=Red>=</font> render_circle fs x <font color=Cyan>(</font>ys Map<font color=Cyan>.!</font> w<font color=Cyan>)</font>
<a name="line-816"></a>
<a name="line-817"></a><a name="render_multi_gate"></a><font color=Blue><i>-- | @'render_multi_gate' /x/ /ys/ /name/ /inv/ /wires/@: Render the</i></font>
<a name="line-818"></a><font color=Blue><i>-- boxes for an /n/-ary gate of the given /name/, potentially</i></font>
<a name="line-819"></a><font color=Blue><i>-- /inv/erted, at the given list of /wires/. The first two arguments</i></font>
<a name="line-820"></a><font color=Blue><i>-- are the current /x/-coordinate and an indexed array of</i></font>
<a name="line-821"></a><font color=Blue><i>-- /y/-coordinates.</i></font>
<a name="line-822"></a><font color=Blue>render_multi_gate</font> <font color=Red>::</font> FormatStyle <font color=Red>-&gt;</font> X <font color=Red>-&gt;</font> Map Wire Y <font color=Red>-&gt;</font> String <font color=Red>-&gt;</font> InverseFlag <font color=Red>-&gt;</font> <font color=Red>[</font>Wire<font color=Red>]</font> <font color=Red>-&gt;</font> Draw ()
<a name="line-823"></a><font color=Blue>render_multi_gate</font> fs x ys name inv <font color=Red>[</font>w<font color=Red>]</font> <font color=Red>=</font> 
<a name="line-824"></a>  render_namedgate fs name inv x <font color=Cyan>(</font>ys Map<font color=Cyan>.!</font> w<font color=Cyan>)</font>
<a name="line-825"></a><font color=Blue>render_multi_gate</font> fs x ys name inv ws <font color=Red>=</font>
<a name="line-826"></a>  sequence_ <font color=Red>[</font> render_namedgate fs <font color=Cyan>(</font>name <font color=Cyan>++</font> <font color=Magenta>" "</font> <font color=Cyan>++</font> show i<font color=Cyan>)</font> inv x <font color=Cyan>(</font>ys Map<font color=Cyan>.!</font> a<font color=Cyan>)</font> <font color=Red>|</font> <font color=Cyan>(</font>a<font color=Cyan>,</font>i<font color=Cyan>)</font> <font color=Red>&lt;-</font> zip ws <font color=Red>[</font><font color=Magenta>1</font><font color=Red>..</font><font color=Red>]</font> <font color=Red>]</font>
<a name="line-827"></a>
<a name="line-828"></a><a name="render_multi_named_ctrl"></a><font color=Blue><i>-- | @'render_multi_named_ctrl' /x/ /ys/ /wires/ /names/@: Render</i></font>
<a name="line-829"></a><font color=Blue><i>-- the boxes for multiple generalized controls at the given /wires/,</i></font>
<a name="line-830"></a><font color=Blue><i>-- using the given /names/. We take special care of the fact that</i></font>
<a name="line-831"></a><font color=Blue><i>-- generalized controls may be used non-linearly. </i></font>
<a name="line-832"></a><font color=Blue>render_multi_named_ctrl</font> <font color=Red>::</font> FormatStyle <font color=Red>-&gt;</font> X <font color=Red>-&gt;</font> Map Wire Y <font color=Red>-&gt;</font> <font color=Red>[</font>Wire<font color=Red>]</font> <font color=Red>-&gt;</font> <font color=Red>[</font>String<font color=Red>]</font> <font color=Red>-&gt;</font> Draw ()
<a name="line-833"></a><font color=Blue>render_multi_named_ctrl</font> fs x ys ws names <font color=Red>=</font>
<a name="line-834"></a>  sequence_ <font color=Red>[</font> render_circgate fs name x <font color=Cyan>(</font>ys Map<font color=Cyan>.!</font> a<font color=Cyan>)</font> <font color=Red>|</font> <font color=Cyan>(</font>a<font color=Cyan>,</font>name<font color=Cyan>)</font> <font color=Red>&lt;-</font> IntMap<font color=Cyan>.</font>toList map <font color=Red>]</font>
<a name="line-835"></a>  <font color=Green><u>where</u></font>
<a name="line-836"></a>    <font color=Blue><i>-- Combine the labels for w if w has multiple occurrences.</i></font>
<a name="line-837"></a>    map <font color=Red>=</font> IntMap<font color=Cyan>.</font>fromListWith <font color=Cyan>(</font><font color=Red>\</font>x y <font color=Red>-&gt;</font> y <font color=Cyan>++</font> <font color=Magenta>","</font> <font color=Cyan>++</font> x<font color=Cyan>)</font> <font color=Cyan>(</font>zip ws names<font color=Cyan>)</font>
<a name="line-838"></a>
<a name="line-839"></a><a name="render_multi_genctrl"></a><font color=Blue><i>-- | @'render_multi_genctrl' /x/ /ys/ /wires/@: Render the boxes for</i></font>
<a name="line-840"></a><font color=Blue><i>-- multiple (numbered) generalized controls at the given /wires/.</i></font>
<a name="line-841"></a><font color=Blue>render_multi_genctrl</font> <font color=Red>::</font> FormatStyle <font color=Red>-&gt;</font> X <font color=Red>-&gt;</font> Map Wire Y <font color=Red>-&gt;</font> <font color=Red>[</font>Wire<font color=Red>]</font> <font color=Red>-&gt;</font> Draw ()
<a name="line-842"></a><font color=Blue>render_multi_genctrl</font> fs x ys ws <font color=Red>=</font> render_multi_named_ctrl fs x ys ws names
<a name="line-843"></a>  <font color=Green><u>where</u></font>
<a name="line-844"></a>    names <font color=Red>=</font> map show <font color=Red>[</font><font color=Magenta>1</font><font color=Red>..</font><font color=Red>]</font>
<a name="line-845"></a>            
<a name="line-846"></a><a name="render_ordering"></a><font color=Blue><i>-- | Number a list of wires in increasing order, at the given</i></font>
<a name="line-847"></a><font color=Blue><i>-- /x/-coordinate. If the boolean argument is 'True', put the numbers</i></font>
<a name="line-848"></a><font color=Blue><i>-- to the right of /x/, else to the left.</i></font>
<a name="line-849"></a><font color=Blue>render_ordering</font> <font color=Red>::</font> FormatStyle <font color=Red>-&gt;</font> X <font color=Red>-&gt;</font> Map Wire Y <font color=Red>-&gt;</font> Bool <font color=Red>-&gt;</font> <font color=Red>[</font>Wire<font color=Red>]</font> <font color=Red>-&gt;</font> Draw ()
<a name="line-850"></a><font color=Blue>render_ordering</font> fs x ys b ws <font color=Red>=</font>
<a name="line-851"></a>  sequence_ <font color=Red>[</font> render_number fs i b x <font color=Cyan>(</font>ys Map<font color=Cyan>.!</font> w<font color=Cyan>)</font> <font color=Red>|</font> <font color=Cyan>(</font>w<font color=Cyan>,</font>i<font color=Cyan>)</font> <font color=Red>&lt;-</font> numbering <font color=Red>]</font>
<a name="line-852"></a>  <font color=Green><u>where</u></font>
<a name="line-853"></a>    numbering <font color=Red>=</font> zip ws <font color=Red>[</font><font color=Magenta>1</font><font color=Red>..</font><font color=Red>]</font>
<a name="line-854"></a>
<a name="line-855"></a><a name="render_gate"></a><font color=Blue><i>-- | Render gate /g/ at /x/-coordinate /x/ and /y/-coordinates as</i></font>
<a name="line-856"></a><font color=Blue><i>-- given by /ys/, which is a map from wires to</i></font>
<a name="line-857"></a><font color=Blue><i>-- /y/-coordinates. Returns a pair (/s/,/t/) of draw actions for</i></font>
<a name="line-858"></a><font color=Blue><i>-- background and foreground, respectively.</i></font>
<a name="line-859"></a><font color=Blue>render_gate</font> <font color=Red>::</font> FormatStyle <font color=Red>-&gt;</font> Gate <font color=Red>-&gt;</font> X <font color=Red>-&gt;</font> Map Wire Y <font color=Red>-&gt;</font> Y <font color=Red>-&gt;</font> <font color=Cyan>(</font>Draw ()<font color=Cyan>,</font> Draw ()<font color=Cyan>)</font>
<a name="line-860"></a><font color=Blue>render_gate</font> fs g x ys maxh <font color=Red>=</font>
<a name="line-861"></a>  <font color=Green><u>let</u></font> ymap w <font color=Red>=</font> ys Map<font color=Cyan>.!</font> w 
<a name="line-862"></a>  <font color=Green><u>in</u></font>
<a name="line-863"></a>  <font color=Green><u>case</u></font> g <font color=Green><u>of</u></font>
<a name="line-864"></a>    <font color=Blue><i>-- Certain named gates are recognized for custom rendering.</i></font>
<a name="line-865"></a>    QGate <font color=Magenta>"not"</font> <font color=Green><u>_</u></font> <font color=Red>[</font>w<font color=Red>]</font> [] c ncf <font color=Red>-&gt;</font> <font color=Cyan>(</font>s2<font color=Cyan>,</font> t2 <font color=Cyan>&gt;&gt;</font> t3<font color=Cyan>)</font>
<a name="line-866"></a>      <font color=Green><u>where</u></font>
<a name="line-867"></a>        y <font color=Red>=</font> ymap w
<a name="line-868"></a>        s2 <font color=Red>=</font> render_controlwire x ys <font color=Red>[</font>w<font color=Red>]</font> c
<a name="line-869"></a>        t2 <font color=Red>=</font> render_controldots fs x ys c
<a name="line-870"></a>        t3 <font color=Red>=</font> <font color=Cyan>(</font>render_not fs x y<font color=Cyan>)</font>
<a name="line-871"></a>    QGate <font color=Magenta>"multinot"</font> <font color=Green><u>_</u></font> ws [] c ncf <font color=Red>-&gt;</font> <font color=Cyan>(</font>s2<font color=Cyan>,</font> t2 <font color=Cyan>&gt;&gt;</font> t3<font color=Cyan>)</font>
<a name="line-872"></a>      <font color=Green><u>where</u></font>
<a name="line-873"></a>        s2 <font color=Red>=</font> render_controlwire x ys ws c
<a name="line-874"></a>        t2 <font color=Red>=</font> render_controldots fs x ys c
<a name="line-875"></a>        t3 <font color=Red>=</font> sequence_ <font color=Cyan>(</font>map <font color=Cyan>(</font><font color=Red>\</font>w <font color=Red>-&gt;</font> <font color=Cyan>(</font>render_not fs x <font color=Cyan>(</font>ymap w<font color=Cyan>)</font><font color=Cyan>)</font><font color=Cyan>)</font> ws<font color=Cyan>)</font>
<a name="line-876"></a>    QGate <font color=Magenta>"swap"</font> <font color=Green><u>_</u></font> <font color=Red>[</font>w1<font color=Cyan>,</font>w2<font color=Red>]</font> [] c ncf <font color=Red>-&gt;</font> <font color=Cyan>(</font>s2<font color=Cyan>,</font> t2 <font color=Cyan>&gt;&gt;</font> t3<font color=Cyan>)</font>
<a name="line-877"></a>      <font color=Green><u>where</u></font>
<a name="line-878"></a>        y1 <font color=Red>=</font> ymap w1
<a name="line-879"></a>        y2 <font color=Red>=</font> ymap w2
<a name="line-880"></a>        s2 <font color=Red>=</font> render_controlwire x ys <font color=Red>[</font>w1<font color=Cyan>,</font>w2<font color=Red>]</font> c
<a name="line-881"></a>        t2 <font color=Red>=</font> render_controldots fs x ys c
<a name="line-882"></a>        t3 <font color=Red>=</font> <font color=Cyan>(</font>render_swap fs x y1<font color=Cyan>)</font> <font color=Cyan>&gt;&gt;</font> <font color=Cyan>(</font>render_swap fs x y2<font color=Cyan>)</font>
<a name="line-883"></a>    QGate <font color=Magenta>"trace"</font> <font color=Green><u>_</u></font> <font color=Green><u>_</u></font> <font color=Green><u>_</u></font> <font color=Green><u>_</u></font> <font color=Green><u>_</u></font> <font color=Red>-&gt;</font> <font color=Cyan>(</font>return ()<font color=Cyan>,</font> return ()<font color=Cyan>)</font>
<a name="line-884"></a>    QGate name inv ws1 ws2 c ncf <font color=Red>-&gt;</font> <font color=Cyan>(</font>s2<font color=Cyan>,</font> t2 <font color=Cyan>&gt;&gt;</font> t3 <font color=Cyan>&gt;&gt;</font> t4<font color=Cyan>)</font>
<a name="line-885"></a>      <font color=Green><u>where</u></font>
<a name="line-886"></a>       s2 <font color=Red>=</font> render_controlwire x ys <font color=Cyan>(</font>ws1 <font color=Cyan>++</font> ws2<font color=Cyan>)</font> c
<a name="line-887"></a>       t2 <font color=Red>=</font> render_multi_gate fs x ys name inv' ws1
<a name="line-888"></a>       t3 <font color=Red>=</font> render_controldots fs x ys c
<a name="line-889"></a>       t4 <font color=Red>=</font> render_multi_genctrl fs x ys ws2
<a name="line-890"></a>       inv' <font color=Red>=</font> inv <font color=Cyan>&amp;&amp;</font> not <font color=Cyan>(</font>self_inverse name ws1 ws2<font color=Cyan>)</font>
<a name="line-891"></a>    QRot name inv theta ws1 ws2 c ncf <font color=Red>-&gt;</font> <font color=Cyan>(</font>s2<font color=Cyan>,</font> t2 <font color=Cyan>&gt;&gt;</font> t3 <font color=Cyan>&gt;&gt;</font> t4<font color=Cyan>)</font>
<a name="line-892"></a>      <font color=Green><u>where</u></font>
<a name="line-893"></a>       s2 <font color=Red>=</font> render_controlwire x ys <font color=Cyan>(</font>ws1 <font color=Cyan>++</font> ws2<font color=Cyan>)</font> c
<a name="line-894"></a>       t2 <font color=Red>=</font> render_multi_gate fs x ys name' inv ws1
<a name="line-895"></a>       t3 <font color=Red>=</font> render_controldots fs x ys c
<a name="line-896"></a>       t4 <font color=Red>=</font> render_multi_genctrl fs x ys ws2
<a name="line-897"></a>       name' <font color=Red>=</font> substitute name <font color=Magenta>'%'</font> <font color=Cyan>(</font>dshow theta<font color=Cyan>)</font>
<a name="line-898"></a>    GPhase t ws c ncf <font color=Red>-&gt;</font> <font color=Cyan>(</font>s2<font color=Cyan>,</font> t2 <font color=Cyan>&gt;&gt;</font> t3<font color=Cyan>)</font>
<a name="line-899"></a>      <font color=Green><u>where</u></font>
<a name="line-900"></a>        y <font color=Red>=</font> <font color=Green><u>case</u></font> <font color=Cyan>(</font>ws<font color=Cyan>,</font> c<font color=Cyan>)</font> <font color=Green><u>of</u></font>
<a name="line-901"></a>          <font color=Cyan>(</font>[]<font color=Cyan>,</font> []<font color=Cyan>)</font> <font color=Red>-&gt;</font> maximum <font color=Cyan>(</font><font color=Magenta>0.0</font> <font color=Red><b>:</b></font> Map<font color=Cyan>.</font>elems ys<font color=Cyan>)</font>
<a name="line-902"></a>          <font color=Cyan>(</font>[]<font color=Cyan>,</font> c<font color=Cyan>)</font>  <font color=Red>-&gt;</font> minimum <font color=Red>[</font> ymap w <font color=Red>|</font> Signed w b <font color=Red>&lt;-</font> c <font color=Red>]</font>
<a name="line-903"></a>          <font color=Cyan>(</font>ws<font color=Cyan>,</font> c<font color=Cyan>)</font>  <font color=Red>-&gt;</font> minimum <font color=Red>[</font> ymap w <font color=Red>|</font> w <font color=Red>&lt;-</font> ws <font color=Red>]</font>
<a name="line-904"></a>        s2 <font color=Red>=</font> render_controlwire_float x ys y c
<a name="line-905"></a>        t2 <font color=Red>=</font> render_controldots fs x ys c
<a name="line-906"></a>        t3 <font color=Red>=</font> <font color=Cyan>(</font>render_gphasegate fs <font color=Cyan>(</font>dshow t<font color=Cyan>)</font> x y<font color=Cyan>)</font>
<a name="line-907"></a>    CNot w c ncf <font color=Red>-&gt;</font> <font color=Cyan>(</font>s2<font color=Cyan>,</font> t2 <font color=Cyan>&gt;&gt;</font> t3<font color=Cyan>)</font>
<a name="line-908"></a>      <font color=Green><u>where</u></font>
<a name="line-909"></a>        y <font color=Red>=</font> ymap w
<a name="line-910"></a>        s2 <font color=Red>=</font> render_controlwire x ys <font color=Red>[</font>w<font color=Red>]</font> c
<a name="line-911"></a>        t2 <font color=Red>=</font> render_controldots fs x ys c
<a name="line-912"></a>        t3 <font color=Red>=</font> <font color=Cyan>(</font>render_not fs x y<font color=Cyan>)</font>
<a name="line-913"></a>    CGate <font color=Magenta>"if"</font> w <font color=Red>[</font>a<font color=Cyan>,</font>b<font color=Cyan>,</font>c<font color=Red>]</font> ncf <font color=Red>-&gt;</font> <font color=Cyan>(</font>s2<font color=Cyan>,</font> t1 <font color=Cyan>&gt;&gt;</font> t3<font color=Cyan>)</font>  <font color=Blue><i>-- special case</i></font>
<a name="line-914"></a>      <font color=Green><u>where</u></font>
<a name="line-915"></a>       y <font color=Red>=</font> ymap w
<a name="line-916"></a>       s2 <font color=Red>=</font> render_controlwire x ys <font color=Red>[</font>w<font color=Cyan>,</font>a<font color=Cyan>,</font>b<font color=Cyan>,</font>c<font color=Red>]</font> []
<a name="line-917"></a>       t1 <font color=Red>=</font> render_multi_named_ctrl fs x ys <font color=Red>[</font>a<font color=Cyan>,</font>b<font color=Cyan>,</font>c<font color=Red>]</font> <font color=Red>[</font><font color=Magenta>"if"</font><font color=Cyan>,</font> <font color=Magenta>"then"</font><font color=Cyan>,</font> <font color=Magenta>"else"</font><font color=Red>]</font>
<a name="line-918"></a>       t3 <font color=Red>=</font> render_namedgate fs <font color=Magenta>"&gt;"</font> False x y
<a name="line-919"></a>    CGateInv <font color=Magenta>"if"</font> w <font color=Red>[</font>a<font color=Cyan>,</font>b<font color=Cyan>,</font>c<font color=Red>]</font> ncf <font color=Red>-&gt;</font> <font color=Cyan>(</font>s2<font color=Cyan>,</font> t1 <font color=Cyan>&gt;&gt;</font> t3<font color=Cyan>)</font>  <font color=Blue><i>-- special case</i></font>
<a name="line-920"></a>      <font color=Green><u>where</u></font>
<a name="line-921"></a>       y <font color=Red>=</font> ymap w
<a name="line-922"></a>       s2 <font color=Red>=</font> render_controlwire x ys <font color=Red>[</font>w<font color=Cyan>,</font>a<font color=Cyan>,</font>b<font color=Cyan>,</font>c<font color=Red>]</font> []
<a name="line-923"></a>       t1 <font color=Red>=</font> render_multi_named_ctrl fs x ys <font color=Red>[</font>a<font color=Cyan>,</font>b<font color=Cyan>,</font>c<font color=Red>]</font> <font color=Red>[</font><font color=Magenta>"if"</font><font color=Cyan>,</font> <font color=Magenta>"then"</font><font color=Cyan>,</font> <font color=Magenta>"else"</font><font color=Red>]</font>
<a name="line-924"></a>       t3 <font color=Red>=</font> render_namedgate fs <font color=Magenta>"&lt;"</font> False x y
<a name="line-925"></a>    CGate name w c ncf <font color=Red>-&gt;</font> <font color=Cyan>(</font>s2<font color=Cyan>,</font> t2 <font color=Cyan>&gt;&gt;</font> t3<font color=Cyan>)</font>
<a name="line-926"></a>      <font color=Green><u>where</u></font>
<a name="line-927"></a>       y <font color=Red>=</font> ymap w
<a name="line-928"></a>       s2 <font color=Red>=</font> render_controlwire x ys <font color=Cyan>(</font>w<font color=Red><b>:</b></font>c<font color=Cyan>)</font> []
<a name="line-929"></a>       t2 <font color=Red>=</font> render_multi_named_ctrl fs x ys c <font color=Red>[</font> <font color=Magenta>"  "</font> <font color=Red>|</font> a <font color=Red>&lt;-</font> c <font color=Red>]</font>
<a name="line-930"></a>       t3 <font color=Red>=</font> render_namedgate fs name False x y
<a name="line-931"></a>    CGateInv name w c ncf <font color=Red>-&gt;</font> <font color=Cyan>(</font>s2<font color=Cyan>,</font> t2 <font color=Cyan>&gt;&gt;</font> t3<font color=Cyan>)</font>
<a name="line-932"></a>      <font color=Green><u>where</u></font>
<a name="line-933"></a>       y <font color=Red>=</font> ymap w
<a name="line-934"></a>       s2 <font color=Red>=</font> render_controlwire x ys <font color=Cyan>(</font>w<font color=Red><b>:</b></font>c<font color=Cyan>)</font> []
<a name="line-935"></a>       t2 <font color=Red>=</font> render_multi_named_ctrl fs x ys c <font color=Red>[</font> <font color=Magenta>"  "</font> <font color=Red>|</font> a <font color=Red>&lt;-</font> c <font color=Red>]</font>
<a name="line-936"></a>       t3 <font color=Red>=</font> render_namedgate fs name True x y
<a name="line-937"></a>    CSwap w1 w2 c ncf <font color=Red>-&gt;</font> <font color=Cyan>(</font>s2<font color=Cyan>,</font> t2 <font color=Cyan>&gt;&gt;</font> t3<font color=Cyan>)</font>
<a name="line-938"></a>      <font color=Green><u>where</u></font>
<a name="line-939"></a>        y1 <font color=Red>=</font> ymap w1
<a name="line-940"></a>        y2 <font color=Red>=</font> ymap w2
<a name="line-941"></a>        s2 <font color=Red>=</font> render_controlwire x ys <font color=Red>[</font>w1<font color=Cyan>,</font>w2<font color=Red>]</font> c
<a name="line-942"></a>        t2 <font color=Red>=</font> render_controldots fs x ys c
<a name="line-943"></a>        t3 <font color=Red>=</font> <font color=Cyan>(</font>render_swap fs x y1<font color=Cyan>)</font> <font color=Cyan>&gt;&gt;</font> <font color=Cyan>(</font>render_swap fs x y2<font color=Cyan>)</font>
<a name="line-944"></a>    QPrep w ncf <font color=Red>-&gt;</font> <font color=Cyan>(</font>return ()<font color=Cyan>,</font> t3<font color=Cyan>)</font>
<a name="line-945"></a>      <font color=Green><u>where</u></font>
<a name="line-946"></a>        y <font color=Red>=</font> ymap w
<a name="line-947"></a>        t3 <font color=Red>=</font> <font color=Cyan>(</font>render_namedgate fs <font color=Magenta>"prep"</font> False x y<font color=Cyan>)</font>
<a name="line-948"></a>    QUnprep w ncf <font color=Red>-&gt;</font> <font color=Cyan>(</font>return ()<font color=Cyan>,</font> t3<font color=Cyan>)</font>
<a name="line-949"></a>      <font color=Green><u>where</u></font>
<a name="line-950"></a>        y <font color=Red>=</font> ymap w
<a name="line-951"></a>        t3 <font color=Red>=</font> <font color=Cyan>(</font>render_namedgate fs <font color=Magenta>"unprep"</font> False x y<font color=Cyan>)</font>
<a name="line-952"></a>    QInit b w ncf <font color=Red>-&gt;</font> <font color=Cyan>(</font>return ()<font color=Cyan>,</font> t3<font color=Cyan>)</font>
<a name="line-953"></a>      <font color=Green><u>where</u></font>
<a name="line-954"></a>        y <font color=Red>=</font> ymap w
<a name="line-955"></a>        t3 <font color=Red>=</font> <font color=Cyan>(</font>render_init fs <font color=Cyan>(</font><font color=Green><u>if</u></font> b <font color=Green><u>then</u></font> <font color=Magenta>"1"</font> <font color=Green><u>else</u></font> <font color=Magenta>"0"</font><font color=Cyan>)</font> x y<font color=Cyan>)</font>
<a name="line-956"></a>    CInit b w ncf <font color=Red>-&gt;</font> <font color=Cyan>(</font>return ()<font color=Cyan>,</font> t3<font color=Cyan>)</font>
<a name="line-957"></a>      <font color=Green><u>where</u></font>
<a name="line-958"></a>        y <font color=Red>=</font> ymap w
<a name="line-959"></a>        t3 <font color=Red>=</font> <font color=Cyan>(</font>render_init fs <font color=Cyan>(</font><font color=Green><u>if</u></font> b <font color=Green><u>then</u></font> <font color=Magenta>"1"</font> <font color=Green><u>else</u></font> <font color=Magenta>"0"</font><font color=Cyan>)</font> x y<font color=Cyan>)</font>
<a name="line-960"></a>    QTerm b w ncf <font color=Red>-&gt;</font> <font color=Cyan>(</font>return ()<font color=Cyan>,</font> t3<font color=Cyan>)</font>
<a name="line-961"></a>      <font color=Green><u>where</u></font>
<a name="line-962"></a>        y <font color=Red>=</font> ymap w
<a name="line-963"></a>        t3 <font color=Red>=</font> <font color=Cyan>(</font>render_term fs <font color=Cyan>(</font><font color=Green><u>if</u></font> b <font color=Green><u>then</u></font> <font color=Magenta>"1"</font> <font color=Green><u>else</u></font> <font color=Magenta>"0"</font><font color=Cyan>)</font> x y<font color=Cyan>)</font>
<a name="line-964"></a>    CTerm b w ncf <font color=Red>-&gt;</font> <font color=Cyan>(</font>return ()<font color=Cyan>,</font> t3<font color=Cyan>)</font>
<a name="line-965"></a>      <font color=Green><u>where</u></font>
<a name="line-966"></a>        y <font color=Red>=</font> ymap w
<a name="line-967"></a>        t3 <font color=Red>=</font> <font color=Cyan>(</font>render_term fs <font color=Cyan>(</font><font color=Green><u>if</u></font> b <font color=Green><u>then</u></font> <font color=Magenta>"1"</font> <font color=Green><u>else</u></font> <font color=Magenta>"0"</font><font color=Cyan>)</font> x y<font color=Cyan>)</font>
<a name="line-968"></a>    QMeas w <font color=Red>-&gt;</font> <font color=Cyan>(</font>return ()<font color=Cyan>,</font> t3<font color=Cyan>)</font>
<a name="line-969"></a>      <font color=Green><u>where</u></font>
<a name="line-970"></a>        y <font color=Red>=</font> ymap w
<a name="line-971"></a>        t3 <font color=Red>=</font> <font color=Cyan>(</font>render_namedgate fs <font color=Magenta>"meas"</font> False x y<font color=Cyan>)</font>
<a name="line-972"></a>    QDiscard w <font color=Red>-&gt;</font> <font color=Cyan>(</font>return ()<font color=Cyan>,</font> t3<font color=Cyan>)</font>
<a name="line-973"></a>      <font color=Green><u>where</u></font>
<a name="line-974"></a>        y <font color=Red>=</font> ymap w
<a name="line-975"></a>        t3 <font color=Red>=</font> <font color=Cyan>(</font>render_bar fs x y<font color=Cyan>)</font>
<a name="line-976"></a>    CDiscard w <font color=Red>-&gt;</font> <font color=Cyan>(</font>return ()<font color=Cyan>,</font> t3<font color=Cyan>)</font>
<a name="line-977"></a>      <font color=Green><u>where</u></font>
<a name="line-978"></a>        y <font color=Red>=</font> ymap w
<a name="line-979"></a>        t3 <font color=Red>=</font> <font color=Cyan>(</font>render_bar fs x y<font color=Cyan>)</font>
<a name="line-980"></a>    DTerm b w <font color=Red>-&gt;</font> <font color=Cyan>(</font>return ()<font color=Cyan>,</font> t3<font color=Cyan>)</font>
<a name="line-981"></a>      <font color=Green><u>where</u></font>
<a name="line-982"></a>        y <font color=Red>=</font> ymap w
<a name="line-983"></a>        t3 <font color=Red>=</font> <font color=Cyan>(</font>render_dterm fs <font color=Cyan>(</font><font color=Green><u>if</u></font> b <font color=Green><u>then</u></font> <font color=Magenta>"1"</font> <font color=Green><u>else</u></font> <font color=Magenta>"0"</font><font color=Cyan>)</font> x y<font color=Cyan>)</font>
<a name="line-984"></a>    Subroutine boxid inv ws1 a1 ws2 a2 c ncf scf rep <font color=Red>-&gt;</font> <font color=Cyan>(</font>s2<font color=Cyan>,</font> t2 <font color=Cyan>&gt;&gt;</font> t3<font color=Cyan>)</font>
<a name="line-985"></a>      <font color=Green><u>where</u></font>
<a name="line-986"></a>       ws <font color=Red>=</font> union ws1 ws2
<a name="line-987"></a>       s2 <font color=Red>=</font> render_controlwire x ys ws c
<a name="line-988"></a>       t2 <font color=Red>=</font> render_multi_gate fs x ys label inv ws
<a name="line-989"></a>       t3 <font color=Red>=</font> render_controldots fs x ys c
<a name="line-990"></a>       show_rep <font color=Red>=</font> <font color=Green><u>if</u></font> rep <font color=Cyan>==</font> RepeatFlag <font color=Magenta>1</font> <font color=Green><u>then</u></font> <font color=Magenta>""</font> <font color=Green><u>else</u></font> <font color=Magenta>"(x"</font> <font color=Cyan>++</font> show rep <font color=Cyan>++</font> <font color=Magenta>")"</font>
<a name="line-991"></a>       BoxId name shape <font color=Red>=</font> boxid
<a name="line-992"></a>       label <font color=Red>=</font> name <font color=Cyan>++</font> show_rep <font color=Cyan>++</font> <font color=Green><u>if</u></font> <font color=Cyan>(</font>subroutineshape fs<font color=Cyan>)</font> <font color=Green><u>then</u></font> <font color=Cyan>(</font><font color=Magenta>", shape "</font> <font color=Cyan>++</font> shape<font color=Cyan>)</font> <font color=Green><u>else</u></font> <font color=Magenta>""</font>
<a name="line-993"></a>    Comment s inv ws <font color=Red>-&gt;</font> <font color=Cyan>(</font>return ()<font color=Cyan>,</font> t1 <font color=Cyan>&gt;&gt;</font> t2<font color=Cyan>)</font>
<a name="line-994"></a>      <font color=Green><u>where</u></font>
<a name="line-995"></a>        t1 <font color=Red>=</font> render_comment fs <font color=Cyan>(</font>null ws<font color=Cyan>)</font> s' x <font color=Cyan>(</font>ymap <font color=Magenta>0</font><font color=Cyan>)</font> maxh
<a name="line-996"></a>        t2 <font color=Red>=</font> sequence_ <font color=Red>[</font>render_label fs <font color=Cyan>(</font>null s<font color=Cyan>)</font> l x <font color=Cyan>(</font>ymap w<font color=Cyan>)</font> <font color=Red>|</font> <font color=Cyan>(</font>w<font color=Cyan>,</font>l<font color=Cyan>)</font> <font color=Red>&lt;-</font> ws<font color=Red>]</font>
<a name="line-997"></a>        s' <font color=Red>=</font> s <font color=Cyan>++</font> optional inv <font color=Magenta>"*"</font>
<a name="line-998"></a>
<a name="line-999"></a><a name="render_gates"></a><font color=Blue><i>-- | Render the gates in the circuit. The parameters are: /xarity/:</i></font>
<a name="line-1000"></a><font color=Blue><i>-- the 'Xarity' of the currently pending wires. /xgs/: the list of</i></font>
<a name="line-1001"></a><font color=Blue><i>-- gates, paired with pre-computed /x/-coordinates. /ys/: a map from</i></font>
<a name="line-1002"></a><font color=Blue><i>-- wires to pre-computed /y/-coordinates. /x/: the right-most</i></font>
<a name="line-1003"></a><font color=Blue><i>-- /x/-coordinate where the final wires will be drawn to. /maxh/: the</i></font>
<a name="line-1004"></a><font color=Blue><i>-- maximal height of comments.</i></font>
<a name="line-1005"></a><font color=Blue>render_gates</font> <font color=Red>::</font> FormatStyle <font color=Red>-&gt;</font> Xarity <font color=Red>-&gt;</font> <font color=Red>[</font><font color=Cyan>(</font>Gate<font color=Cyan>,</font> X<font color=Cyan>)</font><font color=Red>]</font> <font color=Red>-&gt;</font> Map Wire Y <font color=Red>-&gt;</font> X <font color=Red>-&gt;</font> Y <font color=Red>-&gt;</font> <font color=Cyan>(</font>Draw ()<font color=Cyan>,</font> Draw ()<font color=Cyan>)</font>
<a name="line-1006"></a><font color=Blue>render_gates</font> fs xarity xgs ys x maxh <font color=Red>=</font>
<a name="line-1007"></a>  <font color=Green><u>case</u></font> xgs <font color=Green><u>of</u></font>
<a name="line-1008"></a>    [] <font color=Red>-&gt;</font>
<a name="line-1009"></a>      <font color=Green><u>let</u></font> s2 <font color=Red>=</font> render_xarity fs ys xarity x
<a name="line-1010"></a>      <font color=Green><u>in</u></font> <font color=Cyan>(</font>s2<font color=Cyan>,</font> return ()<font color=Cyan>)</font>
<a name="line-1011"></a>    <font color=Cyan>(</font>g<font color=Cyan>,</font>newx<font color=Cyan>)</font><font color=Red><b>:</b></font>gls <font color=Red>-&gt;</font>
<a name="line-1012"></a>      <font color=Green><u>let</u></font> <font color=Cyan>(</font>xarity_term<font color=Cyan>,</font> xarity_new<font color=Cyan>)</font> <font color=Red>=</font> update_xarity xarity g newx <font color=Green><u>in</u></font>
<a name="line-1013"></a>      <font color=Green><u>let</u></font> s1 <font color=Red>=</font> render_xarity fs ys xarity_term newx <font color=Green><u>in</u></font>
<a name="line-1014"></a>      <font color=Green><u>let</u></font> <font color=Cyan>(</font>s2<font color=Cyan>,</font> t2<font color=Cyan>)</font> <font color=Red>=</font> render_gate fs g newx ys maxh <font color=Green><u>in</u></font>
<a name="line-1015"></a>      <font color=Green><u>let</u></font> <font color=Cyan>(</font>sx<font color=Cyan>,</font> tx<font color=Cyan>)</font> <font color=Red>=</font> render_gates fs xarity_new gls ys x maxh <font color=Green><u>in</u></font>
<a name="line-1016"></a>      <font color=Cyan>(</font>s1 <font color=Cyan>&gt;&gt;</font> s2 <font color=Cyan>&gt;&gt;</font> sx<font color=Cyan>,</font> t2 <font color=Cyan>&gt;&gt;</font> tx<font color=Cyan>)</font>
<a name="line-1017"></a>
<a name="line-1018"></a><a name="ps_parameters"></a><font color=Blue><i>-- | PostScript definitions of various parameters.</i></font>
<a name="line-1019"></a><font color=Blue>ps_parameters</font> <font color=Red>::</font> FormatStyle <font color=Red>-&gt;</font> String
<a name="line-1020"></a><font color=Blue>ps_parameters</font> fs <font color=Red>=</font>
<a name="line-1021"></a>  <font color=Magenta>"% some parameters\n"</font>
<a name="line-1022"></a>  <font color=Cyan>++</font> printf <font color=Magenta>"%f setlinewidth\n"</font> <font color=Cyan>(</font>linewidth fs<font color=Cyan>)</font>
<a name="line-1023"></a>  <font color=Cyan>++</font> printf <font color=Magenta>"/gatepad %f def\n"</font> <font color=Cyan>(</font>gatepad fs<font color=Cyan>)</font>
<a name="line-1024"></a>  <font color=Cyan>++</font> printf <font color=Magenta>"/gateheight %f def\n"</font> <font color=Cyan>(</font>gateheight fs<font color=Cyan>)</font>
<a name="line-1025"></a>  <font color=Cyan>++</font> printf <font color=Magenta>"/stringbase %f def\n"</font> <font color=Cyan>(</font>stringbase fs<font color=Cyan>)</font>
<a name="line-1026"></a>  <font color=Cyan>++</font> printf <font color=Magenta>"/dotradius %f def\n"</font> <font color=Cyan>(</font>dotradius fs<font color=Cyan>)</font>
<a name="line-1027"></a>  <font color=Cyan>++</font> printf <font color=Magenta>"/oplusradius %f def\n"</font> <font color=Cyan>(</font>oplusradius fs<font color=Cyan>)</font>
<a name="line-1028"></a>  <font color=Cyan>++</font> printf <font color=Magenta>"/crossradius %f def\n"</font> <font color=Cyan>(</font>crossradius fs<font color=Cyan>)</font>
<a name="line-1029"></a>  <font color=Cyan>++</font> printf <font color=Magenta>"/barwidth %f def\n"</font> <font color=Cyan>(</font>barwidth fs<font color=Cyan>)</font>
<a name="line-1030"></a>  <font color=Cyan>++</font> printf <font color=Magenta>"/barheight %f def\n"</font> <font color=Cyan>(</font>barheight fs<font color=Cyan>)</font>
<a name="line-1031"></a>  <font color=Cyan>++</font> printf <font color=Magenta>"/dwidth %f def\n"</font> <font color=Cyan>(</font>dwidth fs<font color=Cyan>)</font>
<a name="line-1032"></a>  <font color=Cyan>++</font> printf <font color=Magenta>"/dheight %f def\n"</font> <font color=Cyan>(</font>dheight fs<font color=Cyan>)</font>
<a name="line-1033"></a>  <font color=Cyan>++</font> printf <font color=Magenta>"/maxgatelabelwidth %f def\n"</font> <font color=Cyan>(</font>maxgatelabelwidth fs<font color=Cyan>)</font>
<a name="line-1034"></a>  <font color=Cyan>++</font> printf <font color=Magenta>"/maxlabelwidth %f def\n"</font> <font color=Cyan>(</font>maxlabelwidth fs<font color=Cyan>)</font>
<a name="line-1035"></a>  <font color=Cyan>++</font> printf <font color=Magenta>"/maxnumberwidth %f def\n"</font> <font color=Cyan>(</font>maxnumberwidth fs<font color=Cyan>)</font>
<a name="line-1036"></a>  <font color=Cyan>++</font> <font color=Magenta>"/gatefont { /Times-Roman findfont .5 scalefont setfont } def\n"</font>
<a name="line-1037"></a>  <font color=Cyan>++</font> <font color=Magenta>"/labelfont { /Times-Roman findfont .3 scalefont setfont } def\n"</font>
<a name="line-1038"></a>  <font color=Cyan>++</font> <font color=Magenta>"/commentfont { /Times-Roman findfont .3 scalefont setfont } def\n"</font>
<a name="line-1039"></a>  <font color=Cyan>++</font> <font color=Magenta>"/numberfont { /Times-Roman findfont .5 scalefont setfont } def\n"</font>
<a name="line-1040"></a>  <font color=Cyan>++</font> <font color=Magenta>"/labelcolor { 0 0 1 setrgbcolor } def\n"</font>
<a name="line-1041"></a>  <font color=Cyan>++</font> <font color=Magenta>"/commentcolor { 1 0.2 0.2 setrgbcolor } def\n"</font>
<a name="line-1042"></a>  <font color=Cyan>++</font> <font color=Magenta>"/numbercolor { 0 0.7 0 setrgbcolor } def\n"</font>
<a name="line-1043"></a>
<a name="line-1044"></a><font color=Blue><i>-- | PostScript definitions for various drawing subroutines. The</i></font>
<a name="line-1045"></a><font color=Blue><i>-- subroutines provided are:</i></font>
<a name="line-1046"></a><font color=Blue><i>-- </i></font>
<a name="line-1047"></a><font color=Blue><i>-- &gt; x0 y0 x1 y1 line       : draw a line from (x0,y0) to (x1,y1)</i></font>
<a name="line-1048"></a><font color=Blue><i>-- &gt; x0 y0 x1 y1 dashedline : draw a dashed line from (x0,y0) to (x1,y1)</i></font>
<a name="line-1049"></a><font color=Blue><i>-- &gt; x y h w rect           : draw a rectangle of dimensions w x h centered at (x,y)</i></font>
<a name="line-1050"></a><font color=Blue><i>-- &gt; x y h w oval           : draw an oval of dimensions w x h centered at (x,y)</i></font>
<a name="line-1051"></a><font color=Blue><i>-- &gt; x y dot           : draw a filled dot at (x,y)</i></font>
<a name="line-1052"></a><font color=Blue><i>-- &gt; x y circ          : draw an empty dot at (x,y)</i></font>
<a name="line-1053"></a><font color=Blue><i>-- &gt; x y oplus         : draw a "not" gate at (x,y)</i></font>
<a name="line-1054"></a><font color=Blue><i>-- &gt; x y cross         : draw a cross ("swap" gate component) at (x,y)</i></font>
<a name="line-1055"></a><font color=Blue><i>-- &gt; x y bar           : draw an init/term bar at (x,y)</i></font>
<a name="line-1056"></a><font color=Blue><i>-- &gt; x y dbar          : draw a dterm bar at (x,y)</i></font>
<a name="line-1057"></a><font color=Blue><i>-- &gt; name x y box      : draw an empty box at (x,y), big enough to fit name</i></font>
<a name="line-1058"></a><font color=Blue><i>-- &gt; name x y gate     : draw a named box at (x,y)</i></font>
<a name="line-1059"></a><font color=Blue><i>-- &gt; name x y circgate : draw a named round box at (x,y)</i></font>
<a name="line-1060"></a><font color=Blue><i>-- &gt; name x y gphase   : draw a global phase gate (x,y)</i></font>
<a name="line-1061"></a><font color=Blue><i>-- &gt; b x y init        : draw an "init" gate at (x,y), with state b</i></font>
<a name="line-1062"></a><font color=Blue><i>-- &gt; b x y term        : draw a "term" gate at (x,y), with state b</i></font>
<a name="line-1063"></a><font color=Blue><i>-- &gt; b x y dterm       : draw a "dterm" gate at (x,y), with state b</i></font>
<a name="line-1064"></a><font color=Blue><i>-- &gt; string x y m b comment : draw a vertical comment at (x,y), with max height m and baseline adjustment b</i></font>
<a name="line-1065"></a><font color=Blue><i>-- &gt; string x y clabel      : draw a wire label at (x,y), x-centered</i></font>
<a name="line-1066"></a><font color=Blue><i>-- &gt; string x y rlabel      : draw a wire label at (x,y), right of x</i></font>
<a name="line-1067"></a><font color=Blue><i>-- &gt; string x y lnumber     : draw a numbered input at (x,y)</i></font>
<a name="line-1068"></a><font color=Blue><i>-- &gt; string x y rnumber     : draw a numbered output at (x,y)</i></font>
<a name="line-1069"></a>
<a name="line-1070"></a><a name="ps_subroutines"></a><font color=Blue>ps_subroutines</font> <font color=Red>::</font> String
<a name="line-1071"></a><font color=Blue>ps_subroutines</font> <font color=Red>=</font> 
<a name="line-1072"></a>    <font color=Magenta>"% subroutine definitions\n"</font>
<a name="line-1073"></a>    <font color=Cyan>++</font> <font color=Magenta>"/line { moveto lineto stroke } bind def\n"</font>
<a name="line-1074"></a>    <font color=Cyan>++</font> <font color=Magenta>"/dashedline { moveto gsave [0.3 0.2] .15 setdash lineto stroke grestore } bind def\n"</font>
<a name="line-1075"></a>    <font color=Cyan>++</font> <font color=Magenta>"/rect { /H exch def /W exch def -.5 W mul .5 H mul moveto W 0 rlineto 0 H neg rlineto W neg 0 rlineto closepath } bind def\n"</font>
<a name="line-1076"></a>    <font color=Cyan>++</font> <font color=Magenta>"/oval { /H exch def /W exch def gsave .5 W mul .5 H mul scale 0 0 1 0 360 newpath arc gsave 1.0 setgray fill grestore stroke grestore } bind def\n"</font>
<a name="line-1077"></a>    <font color=Cyan>++</font> <font color=Magenta>"/dot { dotradius 0 360 newpath arc gsave 0 setgray fill grestore newpath } bind def\n"</font>
<a name="line-1078"></a>    <font color=Cyan>++</font> <font color=Magenta>"/circ { dotradius 0 360 newpath arc gsave 1.0 setgray fill grestore stroke } bind def\n"</font>
<a name="line-1079"></a>    <font color=Cyan>++</font> <font color=Magenta>"/oplus { gsave translate 0 0 oplusradius 0 360 newpath arc gsave 1.0 setgray fill grestore stroke 0 oplusradius neg 0 oplusradius line oplusradius neg 0 oplusradius 0 line grestore } bind def\n"</font>
<a name="line-1080"></a>    <font color=Cyan>++</font> <font color=Magenta>"/cross { gsave translate crossradius dup dup neg dup line crossradius dup neg dup dup neg line grestore } bind def\n"</font>
<a name="line-1081"></a>    <font color=Cyan>++</font> <font color=Magenta>"/bar { gsave translate barwidth barheight rect fill grestore } bind def\n"</font>
<a name="line-1082"></a>    <font color=Cyan>++</font> <font color=Magenta>"/dbar { gsave translate barwidth 0.5 mul 0 translate dwidth dheight scale -1 -.5 moveto -.5 0 .5 -90 90 arc -1 .5 lineto closepath fill grestore } bind def\n"</font>
<a name="line-1083"></a>    <font color=Cyan>++</font> <font color=Magenta>"/box { gsave translate gatefont stringwidth pop /w exch def /w1 w gatepad add def w1 gateheight rect gsave 1.0 setgray fill grestore stroke grestore } bind def\n"</font>
<a name="line-1084"></a>    <font color=Cyan>++</font> <font color=Magenta>"/gate { gsave translate dup gatefont stringwidth pop /w exch def /fontscale w maxgatelabelwidth div def /fontscale fontscale 1 le {1} {fontscale} ifelse def /w2 w fontscale div def /w1 w2 gatepad add def w1 gateheight rect gsave 1.0 setgray fill grestore stroke 1 fontscale div dup scale 0 .5 w mul sub -0.5 stringbase mul moveto show grestore } bind def\n"</font>
<a name="line-1085"></a>    <font color=Cyan>++</font> <font color=Magenta>"/circgate { gsave translate dup gatefont stringwidth pop /w exch def /fontscale w maxgatelabelwidth div def /fontscale fontscale 1 le {1} {fontscale} ifelse def /w2 w fontscale div def /w1 w2 gatepad add def w1 0.8 gateheight mul oval gsave 1.0 setgray fill grestore stroke 1 fontscale div dup scale 0 .5 w mul sub -0.5 stringbase mul moveto show grestore } bind def\n"</font>
<a name="line-1086"></a>    <font color=Cyan>++</font> <font color=Magenta>"/gphase { gsave translate 0 -0.5 circgate grestore } bind def\n"</font>
<a name="line-1087"></a>    <font color=Cyan>++</font> <font color=Magenta>"/init { gsave translate dup gatefont stringwidth pop /w exch def /w1 w gatepad add def -.5 w1 mul 0 translate 0.5 w1 mul 0 bar 0 .5 w mul sub -0.5 stringbase mul moveto show grestore } bind def\n"</font>
<a name="line-1088"></a>    <font color=Cyan>++</font> <font color=Magenta>"/term { gsave translate dup gatefont stringwidth pop /w exch def /w1 w gatepad add def .5 w1 mul 0 translate -0.5 w1 mul 0 bar 0 .5 w mul sub -0.5 stringbase mul moveto show grestore } bind def\n"</font>
<a name="line-1089"></a>    <font color=Cyan>++</font> <font color=Magenta>"/dterm { gsave translate dup gatefont stringwidth pop /w exch def /w1 w gatepad add def .5 w1 mul 0 translate -0.5 w1 mul 0 dbar 0 .5 w mul sub -0.5 stringbase mul moveto show grestore } bind def\n"</font>
<a name="line-1090"></a>    <font color=Cyan>++</font> <font color=Magenta>"/comment { gsave /b exch def /maxh exch def /y exch def /x exch def commentfont commentcolor x y maxh sub x y 0.4 add 1.0 b textbox grestore } bind def\n"</font>
<a name="line-1091"></a>    <font color=Cyan>++</font> <font color=Magenta>"/clabel { gsave translate dup labelfont stringwidth pop /w exch def /fontscale w maxlabelwidth 2 mul div def /fontscale fontscale 1 le {1} {fontscale} ifelse def 0 0.15 translate 1 fontscale div dup scale -0.5 w mul 0 moveto labelcolor show grestore } bind def\n"</font>
<a name="line-1092"></a>    <font color=Cyan>++</font> <font color=Magenta>"/rlabel { gsave translate dup labelfont stringwidth pop /w exch def /fontscale w maxlabelwidth div def /fontscale fontscale 1 le {1} {fontscale} ifelse def 0 0.15 translate 1 fontscale div dup scale 0 0 moveto labelcolor show grestore } bind def\n"</font>
<a name="line-1093"></a>    <font color=Cyan>++</font> <font color=Magenta>"/lnumber { gsave translate dup numberfont stringwidth pop /w exch def /fontscale w maxnumberwidth div def /fontscale fontscale 1 le {1} {fontscale} ifelse def -0.2 -0.15 translate 1 fontscale div dup scale -1 w mul 0 moveto numbercolor show grestore } bind def\n"</font>
<a name="line-1094"></a>    <font color=Cyan>++</font> <font color=Magenta>"/rnumber { gsave translate dup numberfont stringwidth pop /w exch def /fontscale w maxnumberwidth div def /fontscale fontscale 1 le {1} {fontscale} ifelse def 0.2 -0.15 translate 1 fontscale div dup scale 0 0 moveto numbercolor show grestore } bind def\n"</font>
<a name="line-1095"></a>      
<a name="line-1096"></a><a name="page_of_ocircuit"></a><font color=Blue><i>-- | @'page_of_ocircuit' name ocirc@: Render the circuit /ocirc/ on a</i></font>
<a name="line-1097"></a><font color=Blue><i>-- single page.</i></font>
<a name="line-1098"></a><font color=Blue><i>-- </i></font>
<a name="line-1099"></a><font color=Blue><i>-- The rendering takes place in the following user coordinate system:</i></font>
<a name="line-1100"></a><font color=Blue><i>-- </i></font>
<a name="line-1101"></a><font color=Blue><i>-- \[image coord.png]</i></font>
<a name="line-1102"></a><font color=Blue>page_of_ocircuit</font> <font color=Red>::</font> FormatStyle <font color=Red>-&gt;</font> Maybe BoxId <font color=Red>-&gt;</font> OCircuit <font color=Red>-&gt;</font> Document ()
<a name="line-1103"></a><font color=Blue>page_of_ocircuit</font> fs boxid ocirc <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-1104"></a>  newpage bboxx bboxy <font color=Cyan>$</font> <font color=Green><u>do</u></font>
<a name="line-1105"></a>    when <font color=Cyan>(</font>isJust boxid<font color=Cyan>)</font> <font color=Cyan>$</font> <font color=Green><u>do</u></font>
<a name="line-1106"></a>      comment <font color=Cyan>(</font><font color=Magenta>"drawing commands for "</font> <font color=Cyan>++</font> string_of_boxid <font color=Cyan>(</font>fromJust boxid<font color=Cyan>)</font><font color=Cyan>)</font>
<a name="line-1107"></a>    
<a name="line-1108"></a>    <font color=Blue><i>-- set up the user coordinate system</i></font>
<a name="line-1109"></a>    scale sc sc
<a name="line-1110"></a>    translate <font color=Cyan>(</font><font color=Cyan>(</font>xoff fs<font color=Cyan>)</font> <font color=Cyan>+</font> <font color=Magenta>1</font><font color=Cyan>)</font> <font color=Magenta>1</font>
<a name="line-1111"></a>    
<a name="line-1112"></a>    <font color=Blue><i>-- drawing commands</i></font>
<a name="line-1113"></a>    setlinewidth <font color=Cyan>(</font>linewidth fs<font color=Cyan>)</font>
<a name="line-1114"></a>    when <font color=Cyan>(</font>isJust boxid<font color=Cyan>)</font> <font color=Cyan>$</font> <font color=Green><u>do</u></font>
<a name="line-1115"></a>      textbox align_left <font color=Cyan>(</font>gatefont fs<font color=Cyan>)</font> <font color=Cyan>(</font>foregroundcolor fs<font color=Cyan>)</font> <font color=Cyan>(</font><font color=Blue><i>-</i></font><font color=Cyan>(</font>xoff fs<font color=Cyan>)</font><font color=Cyan>)</font> <font color=Cyan>(</font>raw_height<font color=Blue><i>-</i></font><font color=Magenta>0.25</font><font color=Cyan>)</font> raw_width <font color=Cyan>(</font>raw_height<font color=Blue><i>-</i></font><font color=Magenta>0.25</font><font color=Cyan>)</font> <font color=Cyan>(</font>stringbase fs<font color=Cyan>)</font> <font color=Cyan>(</font><font color=Magenta>"Subroutine "</font> <font color=Cyan>++</font> string_of_boxid <font color=Cyan>(</font>fromJust boxid<font color=Cyan>)</font> <font color=Cyan>++</font> <font color=Magenta>":"</font><font color=Cyan>)</font>
<a name="line-1116"></a>    rendered_wires
<a name="line-1117"></a>    rendered_gates
<a name="line-1118"></a>    render_ordering fs <font color=Cyan>(</font><font color=Blue><i>-</i></font><font color=Cyan>(</font>xoff fs<font color=Cyan>)</font><font color=Cyan>)</font> ys False w_in
<a name="line-1119"></a>    render_ordering fs raw_width ys True w_out
<a name="line-1120"></a>  <font color=Green><u>where</u></font>
<a name="line-1121"></a>    <font color=Blue><i>-- unit scale: distance, in points, between wires</i></font>
<a name="line-1122"></a>    sc <font color=Red>=</font> <font color=Magenta>10</font>
<a name="line-1123"></a>    
<a name="line-1124"></a>    <font color=Blue><i>-- decompose OCircuit</i></font>
<a name="line-1125"></a>    OCircuit <font color=Cyan>(</font>w_in<font color=Cyan>,</font> circ<font color=Cyan>,</font> w_out<font color=Cyan>)</font> <font color=Red>=</font> ocirc
<a name="line-1126"></a>    <font color=Cyan>(</font>a1<font color=Cyan>,</font>gs<font color=Cyan>,</font>a2<font color=Cyan>,</font><font color=Green><u>_</u></font><font color=Cyan>)</font> <font color=Red>=</font> circ
<a name="line-1127"></a>    
<a name="line-1128"></a>    <font color=Blue><i>-- figure out y-coordinates and height</i></font>
<a name="line-1129"></a>    ws <font color=Red>=</font> wirelist_of_circuit circ
<a name="line-1130"></a>    raw_height <font color=Red>=</font> fromIntegral <font color=Cyan>$</font> length ws
<a name="line-1131"></a>    ys <font color=Red>=</font> Map<font color=Cyan>.</font>fromList <font color=Cyan>(</font>zip <font color=Cyan>(</font>reverse ws<font color=Cyan>)</font> <font color=Red>[</font><font color=Magenta>0.0</font> <font color=Red>..</font><font color=Red>]</font><font color=Cyan>)</font>
<a name="line-1132"></a>    maxh <font color=Red>=</font> raw_height <font color=Cyan>+</font> <font color=Magenta>0.3</font>
<a name="line-1133"></a>    bboxy <font color=Red>=</font> sc <font color=Cyan>*</font> <font color=Cyan>(</font>raw_height <font color=Cyan>+</font> <font color=Magenta>1</font><font color=Cyan>)</font>
<a name="line-1134"></a>    
<a name="line-1135"></a>    <font color=Blue><i>-- figure out x-coordinates and width</i></font>
<a name="line-1136"></a>    <font color=Cyan>(</font>raw_width<font color=Cyan>,</font>xgs<font color=Cyan>)</font> <font color=Red>=</font> assign_x_coordinates fs gs <font color=Magenta>0.0</font>
<a name="line-1137"></a>    bboxx <font color=Red>=</font> sc <font color=Cyan>*</font> <font color=Cyan>(</font>raw_width <font color=Cyan>+</font> <font color=Cyan>(</font>xoff fs<font color=Cyan>)</font> <font color=Cyan>+</font> <font color=Magenta>2.0</font><font color=Cyan>)</font>
<a name="line-1138"></a>    
<a name="line-1139"></a>    xa1 <font color=Red>=</font> IntMap<font color=Cyan>.</font>map <font color=Cyan>(</font><font color=Red>\</font>t <font color=Red>-&gt;</font> <font color=Cyan>(</font>t<font color=Cyan>,</font> <font color=Blue><i>-</i></font><font color=Cyan>(</font>xoff fs<font color=Cyan>)</font><font color=Cyan>)</font><font color=Cyan>)</font> a1
<a name="line-1140"></a>    <font color=Cyan>(</font>rendered_wires<font color=Cyan>,</font> rendered_gates<font color=Cyan>)</font> <font color=Red>=</font> render_gates fs <font color=Cyan>(</font>Map<font color=Cyan>.</font>fromList <font color=Cyan>(</font>IntMap<font color=Cyan>.</font>assocs xa1<font color=Cyan>)</font><font color=Cyan>)</font> xgs ys raw_width maxh
<a name="line-1141"></a>
<a name="line-1142"></a><a name="render_bcircuit"></a><font color=Blue><i>-- | Render a low-level boxed quantum circuit as a graphical</i></font>
<a name="line-1143"></a><font color=Blue><i>-- 'Document'. If there are subroutines, each of them is placed on a</i></font>
<a name="line-1144"></a><font color=Blue><i>-- separate page.</i></font>
<a name="line-1145"></a><font color=Blue>render_bcircuit</font> <font color=Red>::</font> FormatStyle <font color=Red>-&gt;</font> BCircuit <font color=Red>-&gt;</font> Document ()
<a name="line-1146"></a><font color=Blue>render_bcircuit</font> fs <font color=Cyan>(</font>circ<font color=Cyan>,</font> namespace<font color=Cyan>)</font> <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-1147"></a>  page_of_ocircuit fs Nothing <font color=Cyan>(</font>OCircuit <font color=Cyan>(</font>[]<font color=Cyan>,</font> circ<font color=Cyan>,</font> []<font color=Cyan>)</font><font color=Cyan>)</font>
<a name="line-1148"></a>  sequence_ <font color=Red>[</font> page_of_ocircuit fs <font color=Cyan>(</font>Just boxid<font color=Cyan>)</font> ocirc <font color=Red>|</font> <font color=Cyan>(</font>boxid<font color=Cyan>,</font> TypedSubroutine ocirc <font color=Green><u>_</u></font> <font color=Green><u>_</u></font> <font color=Green><u>_</u></font><font color=Cyan>)</font> <font color=Red>&lt;-</font> Map<font color=Cyan>.</font>toList namespace<font color=Red>]</font>
<a name="line-1149"></a>
<a name="line-1150"></a><a name="render_dbcircuit"></a><font color=Blue><i>-- | Render a low-level dynamic quantum circuit as a graphical</i></font>
<a name="line-1151"></a><font color=Blue><i>-- 'Document'. If there are subroutines, each of them is placed on a</i></font>
<a name="line-1152"></a><font color=Blue><i>-- separate page.  If the circuit uses dynamic lifting, an error is</i></font>
<a name="line-1153"></a><font color=Blue><i>-- produced.</i></font>
<a name="line-1154"></a><font color=Blue>render_dbcircuit</font> <font color=Red>::</font> FormatStyle <font color=Red>-&gt;</font> ErrMsg <font color=Red>-&gt;</font> DBCircuit a <font color=Red>-&gt;</font> Document ()
<a name="line-1155"></a><font color=Blue>render_dbcircuit</font> fs e dbcirc <font color=Red>=</font> render_bcircuit fs bcirc <font color=Green><u>where</u></font>
<a name="line-1156"></a>  <font color=Cyan>(</font>bcirc<font color=Cyan>,</font> <font color=Green><u>_</u></font><font color=Cyan>)</font> <font color=Red>=</font> bcircuit_of_static_dbcircuit errmsg dbcirc
<a name="line-1157"></a>  errmsg x <font color=Red>=</font> e <font color=Cyan>(</font><font color=Magenta>"operation not permitted during graphical rendering: "</font> <font color=Cyan>++</font> x<font color=Cyan>)</font>
<a name="line-1158"></a>
<a name="line-1159"></a><a name="print_bcircuit_format"></a><font color=Blue><i>-- | Print a representation of a low-level quantum circuit, in the</i></font>
<a name="line-1160"></a><font color=Blue><i>-- requested graphics format, directly to standard output. If there</i></font>
<a name="line-1161"></a><font color=Blue><i>-- are boxed subcircuits, each of them is placed on a separate page.</i></font>
<a name="line-1162"></a><font color=Blue>print_bcircuit_format</font> <font color=Red>::</font> FormatStyle <font color=Red>-&gt;</font> BCircuit <font color=Red>-&gt;</font> IO ()
<a name="line-1163"></a><font color=Blue>print_bcircuit_format</font> fs bcirc <font color=Red>=</font>
<a name="line-1164"></a>  render_custom_stdout <font color=Cyan>(</font>renderformat fs<font color=Cyan>)</font> cust <font color=Cyan>(</font>render_bcircuit fs bcirc<font color=Cyan>)</font>
<a name="line-1165"></a>    <font color=Green><u>where</u></font>
<a name="line-1166"></a>      cust <font color=Red>=</font> custom <font color=Cyan>{</font>
<a name="line-1167"></a>        creator <font color=Red>=</font> <font color=Magenta>"Quipper"</font><font color=Cyan>,</font>
<a name="line-1168"></a>        ps_defs <font color=Red>=</font> ps_parameters fs <font color=Cyan>++</font> ps_subroutines 
<a name="line-1169"></a>        <font color=Cyan>}</font>
<a name="line-1170"></a>
<a name="line-1171"></a><a name="print_dbcircuit_format"></a><font color=Blue><i>-- | Print a representation of a low-level dynamic quantum circuit, in</i></font>
<a name="line-1172"></a><font color=Blue><i>-- the requested graphics format, directly to standard output. If</i></font>
<a name="line-1173"></a><font color=Blue><i>-- there are boxed subcircuits, each of them is placed on a separate</i></font>
<a name="line-1174"></a><font color=Blue><i>-- page. If the circuit uses dynamic lifting, an error is produced.</i></font>
<a name="line-1175"></a><font color=Blue>print_dbcircuit_format</font> <font color=Red>::</font> FormatStyle <font color=Red>-&gt;</font> ErrMsg <font color=Red>-&gt;</font> DBCircuit a <font color=Red>-&gt;</font> IO ()
<a name="line-1176"></a><font color=Blue>print_dbcircuit_format</font> fs e dbcirc <font color=Red>=</font> 
<a name="line-1177"></a>  render_custom_stdout <font color=Cyan>(</font>renderformat fs<font color=Cyan>)</font> cust <font color=Cyan>(</font>render_dbcircuit fs e dbcirc<font color=Cyan>)</font>
<a name="line-1178"></a>    <font color=Green><u>where</u></font> 
<a name="line-1179"></a>      cust <font color=Red>=</font> custom <font color=Cyan>{</font>
<a name="line-1180"></a>        creator <font color=Red>=</font> <font color=Magenta>"Quipper"</font><font color=Cyan>,</font>
<a name="line-1181"></a>        ps_defs <font color=Red>=</font> ps_parameters fs <font color=Cyan>++</font> ps_subroutines
<a name="line-1182"></a>        <font color=Cyan>}</font>
<a name="line-1183"></a>
<a name="line-1184"></a><font color=Blue><i>-- ----------------------------------------------------------------------</i></font>
<a name="line-1185"></a><font color=Blue><i>-- * Interface to external programs</i></font>
<a name="line-1186"></a>
<a name="line-1187"></a><a name="system_pdf_viewer"></a><font color=Blue><i>-- | @'system_pdf_viewer' zoom pdffile@: Call a system-specific PDF</i></font>
<a name="line-1188"></a><font color=Blue><i>-- viewer on /pdffile/ file. The /zoom/ argument is out of 100 and may</i></font>
<a name="line-1189"></a><font color=Blue><i>-- or may not be ignored by the viewer.</i></font>
<a name="line-1190"></a><font color=Blue>system_pdf_viewer</font> <font color=Red>::</font> Double <font color=Red>-&gt;</font> String <font color=Red>-&gt;</font> IO ()
<a name="line-1191"></a><font color=Blue>system_pdf_viewer</font> zoom pdffile <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-1192"></a>  envList <font color=Red>&lt;-</font> getEnvironment
<a name="line-1193"></a>  <font color=Green><u>if</u></font> <font color=Cyan>(</font>List<font color=Cyan>.</font>elem <font color=Cyan>(</font><font color=Magenta>"OS"</font><font color=Cyan>,</font> <font color=Magenta>"Windows_NT"</font><font color=Cyan>)</font> envList<font color=Cyan>)</font>
<a name="line-1194"></a>  <font color=Green><u>then</u></font> <font color=Green><u>do</u></font>
<a name="line-1195"></a>    rawSystem <font color=Magenta>"acroread.bat"</font> <font color=Red>[</font>pdffile<font color=Red>]</font>
<a name="line-1196"></a>  <font color=Green><u>else</u></font> <font color=Green><u>if</u></font> <font color=Cyan>(</font>os <font color=Cyan>==</font> <font color=Magenta>"darwin"</font><font color=Cyan>)</font>
<a name="line-1197"></a>  <font color=Green><u>then</u></font> <font color=Green><u>do</u></font>
<a name="line-1198"></a>    rawSystem <font color=Magenta>"open"</font> <font color=Red>[</font>pdffile<font color=Red>]</font>
<a name="line-1199"></a>    rawSystem <font color=Magenta>"sleep"</font> <font color=Red>[</font><font color=Magenta>"1"</font><font color=Red>]</font> <font color=Blue><i>-- required or the file may be deleted too soon</i></font>
<a name="line-1200"></a>  <font color=Green><u>else</u></font> <font color=Green><u>do</u></font>
<a name="line-1201"></a>    rawSystem <font color=Magenta>"acroread"</font> <font color=Red>[</font><font color=Magenta>"/a"</font><font color=Cyan>,</font> <font color=Magenta>"zoom=100"</font><font color=Cyan>,</font> pdffile<font color=Red>]</font>
<a name="line-1202"></a>  return ()
<a name="line-1203"></a>
<a name="line-1204"></a><font color=Blue><i>-- ----------------------------------------------------------------------</i></font>
<a name="line-1205"></a><font color=Blue><i>-- * Previewing</i></font>
<a name="line-1206"></a>
<a name="line-1207"></a><a name="preview_document"></a><font color=Blue><i>-- | Display a document directly in Acrobat Reader. This may not be</i></font>
<a name="line-1208"></a><font color=Blue><i>-- portable. It requires the external program \"acroread\" to be</i></font>
<a name="line-1209"></a><font color=Blue><i>-- installed.</i></font>
<a name="line-1210"></a><font color=Blue>preview_document</font> <font color=Red>::</font> Document a <font color=Red>-&gt;</font> IO a
<a name="line-1211"></a><font color=Blue>preview_document</font> <font color=Red>=</font> preview_document_custom custom
<a name="line-1212"></a>
<a name="line-1213"></a><a name="preview_document_custom"></a><font color=Blue><i>-- | Display a document directly in Acrobat Reader. This may not be</i></font>
<a name="line-1214"></a><font color=Blue><i>-- portable. It requires the external program \"acroread\" to be</i></font>
<a name="line-1215"></a><font color=Blue><i>-- installed.</i></font>
<a name="line-1216"></a><font color=Blue>preview_document_custom</font> <font color=Red>::</font> Custom <font color=Red>-&gt;</font> Document a <font color=Red>-&gt;</font> IO a
<a name="line-1217"></a><font color=Blue>preview_document_custom</font> custom doc <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-1218"></a>  tmpdir <font color=Red>&lt;-</font> getTemporaryDirectory
<a name="line-1219"></a>  <font color=Cyan>(</font>pdffile<font color=Cyan>,</font> fd<font color=Cyan>)</font> <font color=Red>&lt;-</font> openTempFile tmpdir <font color=Magenta>"Quipper.pdf"</font>
<a name="line-1220"></a>  a <font color=Red>&lt;-</font> render_custom_file fd Format_PDF custom doc
<a name="line-1221"></a>  hClose fd
<a name="line-1222"></a>  system_pdf_viewer <font color=Magenta>100</font> pdffile
<a name="line-1223"></a>  removeFile pdffile
<a name="line-1224"></a>  return a
<a name="line-1225"></a>
<a name="line-1226"></a><a name="preview_bcircuit"></a><font color=Blue><i>-- | Display the circuit directly in Acrobat Reader. This may not be</i></font>
<a name="line-1227"></a><font color=Blue><i>-- portable. It requires the external program \"acroread\" to be</i></font>
<a name="line-1228"></a><font color=Blue><i>-- installed.</i></font>
<a name="line-1229"></a><font color=Blue>preview_bcircuit</font> <font color=Red>::</font> BCircuit <font color=Red>-&gt;</font> IO ()
<a name="line-1230"></a><font color=Blue>preview_bcircuit</font> bcirc <font color=Red>=</font>
<a name="line-1231"></a>  preview_document doc
<a name="line-1232"></a>  <font color=Green><u>where</u></font>
<a name="line-1233"></a>    doc <font color=Red>=</font> render_bcircuit pdf bcirc
<a name="line-1234"></a>
<a name="line-1235"></a><a name="preview_dbcircuit"></a><font color=Blue><i>-- | Display a low-level dynamic quantum circuit directly in Acrobat</i></font>
<a name="line-1236"></a><font color=Blue><i>-- Reader. This may not be portable. It requires the external program</i></font>
<a name="line-1237"></a><font color=Blue><i>-- \"acroread\" to be installed. If the circuit uses dynamic lifting,</i></font>
<a name="line-1238"></a><font color=Blue><i>-- an error is produced.</i></font>
<a name="line-1239"></a><font color=Blue>preview_dbcircuit</font> <font color=Red>::</font> ErrMsg <font color=Red>-&gt;</font> DBCircuit a <font color=Red>-&gt;</font> IO ()
<a name="line-1240"></a><font color=Blue>preview_dbcircuit</font> e dbcirc <font color=Red>=</font> preview_bcircuit bcirc <font color=Green><u>where</u></font>
<a name="line-1241"></a>  <font color=Cyan>(</font>bcirc<font color=Cyan>,</font> <font color=Green><u>_</u></font><font color=Cyan>)</font> <font color=Red>=</font> bcircuit_of_static_dbcircuit errmsg dbcirc
<a name="line-1242"></a>  errmsg x <font color=Red>=</font> e <font color=Cyan>(</font><font color=Magenta>"operation not permitted for PDF preview: "</font> <font color=Cyan>++</font> x<font color=Cyan>)</font>
<a name="line-1243"></a>
<a name="line-1244"></a><font color=Blue><i>-- ----------------------------------------------------------------------</i></font>
<a name="line-1245"></a><font color=Blue><i>-- * Gate counts</i></font>
<a name="line-1246"></a>
<a name="line-1247"></a><font color=Blue><i>-- ** Gate types</i></font>
<a name="line-1248"></a>
<a name="line-1249"></a><font color=Blue><i>-- $ The type 'Gate' contains too much information to be used as the </i></font>
<a name="line-1250"></a><font color=Blue><i>-- index for counting gates: all 'CNot' gates, for instance,</i></font>
<a name="line-1251"></a><font color=Blue><i>-- should be counted together, regardless of what wires they are</i></font>
<a name="line-1252"></a><font color=Blue><i>-- applied to.</i></font>
<a name="line-1253"></a><font color=Blue><i>--</i></font>
<a name="line-1254"></a><font color=Blue><i>-- We define 'Gatetype' to remedy this, with each value of </i></font>
<a name="line-1255"></a><font color=Blue><i>-- 'Gatetype' corresponding to an equivalence class of</i></font>
<a name="line-1256"></a><font color=Blue><i>-- gates as they should appear in gate counts.</i></font>
<a name="line-1257"></a><font color=Blue><i>--</i></font>
<a name="line-1258"></a><font color=Blue><i>-- During gate counting, a little more information needs to be retained,</i></font>
<a name="line-1259"></a><font color=Blue><i>-- so that operations such as adding controls to subroutine counts can</i></font>
<a name="line-1260"></a><font color=Blue><i>-- be accurately performed.  'AnnGatetype' supplies this information.</i></font>
<a name="line-1261"></a>
<a name="line-1262"></a><a name="ControlType"></a><font color=Blue><i>-- | An abbreviated representation of the controls of a gate: </i></font>
<a name="line-1263"></a><a name="ControlType"></a><font color=Blue><i>-- the number of positive and negative controls, respectively.</i></font>
<a name="line-1264"></a><a name="ControlType"></a><font color=Green><u>type</u></font> ControlType <font color=Red>=</font> <font color=Cyan>(</font>Int<font color=Cyan>,</font>Int<font color=Cyan>)</font> 
<a name="line-1265"></a>
<a name="line-1266"></a><a name="controltype"></a><font color=Blue><i>-- | From a list of controls, extract the number of positive and</i></font>
<a name="line-1267"></a><font color=Blue><i>-- negative controls.</i></font>
<a name="line-1268"></a><font color=Blue>controltype</font> <font color=Red>::</font> Controls <font color=Red>-&gt;</font> ControlType
<a name="line-1269"></a><font color=Blue>controltype</font> c <font color=Red>=</font>
<a name="line-1270"></a>  <font color=Cyan>(</font>length <font color=Cyan>$</font> filter get_sign c<font color=Cyan>,</font> length <font color=Cyan>$</font> filter <font color=Cyan>(</font>not <font color=Cyan>.</font> get_sign<font color=Cyan>)</font> c<font color=Cyan>)</font>
<a name="line-1271"></a>
<a name="line-1272"></a><a name="nocontrols"></a><font color=Blue><i>-- | Convenience constant for uncontrolled gates.</i></font>
<a name="line-1273"></a><font color=Blue>nocontrols</font> <font color=Red>::</font> ControlType
<a name="line-1274"></a><font color=Blue>nocontrols</font> <font color=Red>=</font> <font color=Cyan>(</font><font color=Magenta>0</font><font color=Cyan>,</font><font color=Magenta>0</font><font color=Cyan>)</font>
<a name="line-1275"></a>
<a name="line-1276"></a><a name="Gatetype"></a><font color=Blue><i>-- | A data type representing equivalence classes of basic gates,</i></font>
<a name="line-1277"></a><a name="Gatetype"></a><font color=Blue><i>-- for the output of gatecounts.</i></font>
<a name="line-1278"></a><a name="Gatetype"></a><font color=Green><u>data</u></font> Gatetype <font color=Red>=</font> 
<a name="line-1279"></a>  Gatetype String ControlType
<a name="line-1280"></a>  <font color=Red>|</font> GatetypeSubroutine BoxId InverseFlag ControlType
<a name="line-1281"></a> <font color=Green><u>deriving</u></font> <font color=Cyan>(</font>Eq<font color=Cyan>,</font> Ord<font color=Cyan>,</font> Show<font color=Cyan>)</font>
<a name="line-1282"></a>
<a name="line-1283"></a><a name="AnnGatetype"></a><font color=Blue><i>-- | A data type analogous to 'Gatetype', but with extra annotations,</i></font>
<a name="line-1284"></a><a name="AnnGatetype"></a><font color=Blue><i>-- e.g. a 'NoControlFlag', for use in the computation of gate counts.</i></font>
<a name="line-1285"></a><a name="AnnGatetype"></a><font color=Green><u>data</u></font> AnnGatetype <font color=Red>=</font> 
<a name="line-1286"></a>    AnnGatetype String <font color=Cyan>(</font>Maybe String<font color=Cyan>)</font> ControlType NoControlFlag ControllableFlag
<a name="line-1287"></a>  <font color=Red>|</font> AnnGatetypeSubroutine BoxId InverseFlag ControlType NoControlFlag ControllableFlag
<a name="line-1288"></a>  <font color=Green><u>deriving</u></font> <font color=Cyan>(</font>Eq<font color=Cyan>,</font> Ord<font color=Cyan>,</font> Show<font color=Cyan>)</font>
<a name="line-1289"></a>
<a name="line-1290"></a><a name="unannotate_gatetype"></a><font color=Blue><i>-- | Forget the annotations of an 'AnnGatetype'</i></font>
<a name="line-1291"></a><font color=Blue>unannotate_gatetype</font> <font color=Red>::</font> AnnGatetype <font color=Red>-&gt;</font> Gatetype
<a name="line-1292"></a><font color=Blue>unannotate_gatetype</font> <font color=Cyan>(</font>AnnGatetype n <font color=Green><u>_</u></font> cs <font color=Green><u>_</u></font> <font color=Green><u>_</u></font><font color=Cyan>)</font> <font color=Red>=</font> Gatetype n cs
<a name="line-1293"></a><font color=Blue>unannotate_gatetype</font> <font color=Cyan>(</font>AnnGatetypeSubroutine n i cs <font color=Green><u>_</u></font> <font color=Green><u>_</u></font><font color=Cyan>)</font> <font color=Red>=</font> GatetypeSubroutine n i cs
<a name="line-1294"></a>
<a name="line-1295"></a><a name="add_controls_gatetype"></a><font color=Blue><i>-- | Add controls to an annotated gate type, or throw an error message if it is not controllable; </i></font>
<a name="line-1296"></a><font color=Blue><i>-- unless its 'NoControlFlag' is set, in which case leave it unchanged.</i></font>
<a name="line-1297"></a><font color=Blue>add_controls_gatetype</font> <font color=Red>::</font> ErrMsg <font color=Red>-&gt;</font> ControlType <font color=Red>-&gt;</font> AnnGatetype <font color=Red>-&gt;</font> AnnGatetype
<a name="line-1298"></a><font color=Blue>add_controls_gatetype</font> e <font color=Cyan>(</font>x'<font color=Cyan>,</font>y'<font color=Cyan>)</font> g<font color=Red>@</font><font color=Cyan>(</font>AnnGatetype n n_inv <font color=Cyan>(</font>x<font color=Cyan>,</font>y<font color=Cyan>)</font> ncf cf<font color=Cyan>)</font> <font color=Red>=</font>
<a name="line-1299"></a>  <font color=Green><u>if</u></font> ncf <font color=Green><u>then</u></font> g
<a name="line-1300"></a>  <font color=Green><u>else</u></font> <font color=Green><u>case</u></font> cf <font color=Green><u>of</u></font>
<a name="line-1301"></a>     AllCtl           <font color=Red>-&gt;</font> AnnGatetype n n_inv <font color=Cyan>(</font>x<font color=Cyan>+</font>x'<font color=Cyan>,</font>y<font color=Cyan>+</font>y'<font color=Cyan>)</font> ncf cf
<a name="line-1302"></a>     OnlyClassicalCtl <font color=Red>-&gt;</font> AnnGatetype n n_inv <font color=Cyan>(</font>x<font color=Cyan>+</font>x'<font color=Cyan>,</font>y<font color=Cyan>+</font>y'<font color=Cyan>)</font> ncf cf
<a name="line-1303"></a>     NoCtl            <font color=Red>-&gt;</font> error <font color=Cyan>$</font> e <font color=Magenta>"add_controls_gatetype: gate "</font> <font color=Cyan>++</font> n <font color=Cyan>++</font> <font color=Magenta>" is not controllable."</font>
<a name="line-1304"></a>
<a name="line-1305"></a><font color=Blue>add_controls_gatetype</font> e <font color=Cyan>(</font>x'<font color=Cyan>,</font>y'<font color=Cyan>)</font> g<font color=Red>@</font><font color=Cyan>(</font>AnnGatetypeSubroutine n inv <font color=Cyan>(</font>x<font color=Cyan>,</font>y<font color=Cyan>)</font> ncf cf<font color=Cyan>)</font> <font color=Red>=</font>
<a name="line-1306"></a>  <font color=Green><u>if</u></font> ncf <font color=Green><u>then</u></font> g
<a name="line-1307"></a>  <font color=Green><u>else</u></font> <font color=Green><u>case</u></font> cf <font color=Green><u>of</u></font>
<a name="line-1308"></a>     AllCtl           <font color=Red>-&gt;</font> AnnGatetypeSubroutine n inv <font color=Cyan>(</font>x<font color=Cyan>+</font>x'<font color=Cyan>,</font>y<font color=Cyan>+</font>y'<font color=Cyan>)</font> ncf cf
<a name="line-1309"></a>     OnlyClassicalCtl <font color=Red>-&gt;</font> AnnGatetypeSubroutine n inv <font color=Cyan>(</font>x<font color=Cyan>+</font>x'<font color=Cyan>,</font>y<font color=Cyan>+</font>y'<font color=Cyan>)</font> ncf cf
<a name="line-1310"></a>     NoCtl            <font color=Red>-&gt;</font> error <font color=Cyan>$</font> e <font color=Magenta>"add_controls_gatetype: subroutine "</font> <font color=Cyan>++</font> show n <font color=Cyan>++</font> <font color=Magenta>" is not controllable."</font>
<a name="line-1311"></a>
<a name="line-1312"></a><a name="reverse_gatetype"></a><font color=Blue><i>-- | Reverse an annotated gate type, of throw an error if it is not reversible. </i></font>
<a name="line-1313"></a><font color=Blue>reverse_gatetype</font> <font color=Red>::</font> ErrMsg <font color=Red>-&gt;</font> AnnGatetype <font color=Red>-&gt;</font> AnnGatetype
<a name="line-1314"></a><font color=Blue>reverse_gatetype</font> e g<font color=Red>@</font><font color=Cyan>(</font>AnnGatetype n n_inv cs ncf cf<font color=Cyan>)</font> <font color=Red>=</font>
<a name="line-1315"></a>  <font color=Green><u>case</u></font> n_inv <font color=Green><u>of</u></font>
<a name="line-1316"></a>    Just n' <font color=Red>-&gt;</font> <font color=Cyan>(</font>AnnGatetype n' <font color=Cyan>(</font>Just n<font color=Cyan>)</font> cs ncf cf<font color=Cyan>)</font>
<a name="line-1317"></a>    Nothing <font color=Red>-&gt;</font> error <font color=Cyan>$</font> e <font color=Magenta>"reverse_gatetype: gate "</font> <font color=Cyan>++</font> n <font color=Cyan>++</font> <font color=Magenta>" is not reversible"</font>
<a name="line-1318"></a><font color=Blue>reverse_gatetype</font> e g<font color=Red>@</font><font color=Cyan>(</font>AnnGatetypeSubroutine n inv cs ncf cf<font color=Cyan>)</font> <font color=Red>=</font>
<a name="line-1319"></a>  <font color=Cyan>(</font>AnnGatetypeSubroutine n <font color=Cyan>(</font>not inv<font color=Cyan>)</font> cs ncf cf<font color=Cyan>)</font>
<a name="line-1320"></a>
<a name="line-1321"></a><a name="set_ncf_gatetype"></a><font color=Blue><i>-- | Set the 'NoControlFlag' of an annotated gate type to 'True'.</i></font>
<a name="line-1322"></a><font color=Blue>set_ncf_gatetype</font> <font color=Red>::</font> AnnGatetype <font color=Red>-&gt;</font> AnnGatetype
<a name="line-1323"></a><font color=Blue>set_ncf_gatetype</font> <font color=Cyan>(</font>AnnGatetype n n_inv cs ncf cf<font color=Cyan>)</font> <font color=Red>=</font>
<a name="line-1324"></a>                 <font color=Cyan>(</font>AnnGatetype n n_inv cs True cf<font color=Cyan>)</font>
<a name="line-1325"></a><font color=Blue>set_ncf_gatetype</font> <font color=Cyan>(</font>AnnGatetypeSubroutine n inv cs ncf cf<font color=Cyan>)</font> <font color=Red>=</font>
<a name="line-1326"></a>                 <font color=Cyan>(</font>AnnGatetypeSubroutine n inv cs True cf<font color=Cyan>)</font>
<a name="line-1327"></a>
<a name="line-1328"></a><a name="with_arity"></a><font color=Blue><i>-- | Helper function for 'gatetype': append a formatted arity to a string.</i></font>
<a name="line-1329"></a><font color=Blue>with_arity</font> <font color=Red>::</font> String <font color=Red>-&gt;</font> Int <font color=Red>-&gt;</font> String
<a name="line-1330"></a><a name="with_arity"></a><font color=Blue>n</font> <font color=Cyan>`with_arity`</font> a <font color=Red>=</font> n <font color=Cyan>++</font> <font color=Magenta>", arity "</font> <font color=Cyan>++</font> show a
<a name="line-1331"></a>
<a name="line-1332"></a><a name="gatetype"></a><font color=Blue><i>-- | Convert a given low-level gate to an annotated gate type</i></font>
<a name="line-1333"></a><font color=Blue>gatetype</font> <font color=Red>::</font> Gate <font color=Red>-&gt;</font> AnnGatetype
<a name="line-1334"></a><font color=Blue>gatetype</font> <font color=Cyan>(</font>QGate n inv ws vs c ncf<font color=Cyan>)</font> <font color=Red>=</font>
<a name="line-1335"></a>  AnnGatetype <font color=Cyan>(</font>n' inv'<font color=Cyan>)</font> <font color=Cyan>(</font>Just <font color=Cyan>$</font> n' <font color=Cyan>$</font> notinv'<font color=Cyan>)</font> <font color=Cyan>(</font>controltype c<font color=Cyan>)</font> ncf AllCtl
<a name="line-1336"></a>  <font color=Green><u>where</u></font> 
<a name="line-1337"></a>    n' b <font color=Red>=</font> <font color=Cyan>(</font>n <font color=Cyan>++</font> optional b <font color=Magenta>"*"</font><font color=Cyan>)</font> <font color=Cyan>`with_arity`</font> <font color=Cyan>(</font>length ws <font color=Cyan>+</font> length vs<font color=Cyan>)</font>
<a name="line-1338"></a>    inv' <font color=Red>=</font> inv <font color=Cyan>&amp;&amp;</font> not <font color=Cyan>(</font>self_inverse n ws vs<font color=Cyan>)</font>
<a name="line-1339"></a>    notinv' <font color=Red>=</font> not inv <font color=Cyan>&amp;&amp;</font> not <font color=Cyan>(</font>self_inverse n ws vs<font color=Cyan>)</font>
<a name="line-1340"></a><font color=Blue>gatetype</font> <font color=Cyan>(</font>QRot n inv t ws vs c ncf<font color=Cyan>)</font> <font color=Red>=</font>
<a name="line-1341"></a>  AnnGatetype <font color=Cyan>(</font>n' inv<font color=Cyan>)</font> <font color=Cyan>(</font>Just <font color=Cyan>$</font> n' <font color=Cyan>$</font> not inv<font color=Cyan>)</font> <font color=Cyan>(</font>controltype c<font color=Cyan>)</font> ncf AllCtl
<a name="line-1342"></a>  <font color=Green><u>where</u></font> n' b <font color=Red>=</font> <font color=Cyan>(</font>printf <font color=Magenta>"Rot(%s,%f)"</font> <font color=Cyan>(</font>n<font color=Cyan>++</font> optional b <font color=Magenta>"*"</font><font color=Cyan>)</font> t<font color=Cyan>)</font> <font color=Cyan>`with_arity`</font> <font color=Cyan>(</font>length ws <font color=Cyan>+</font> length vs<font color=Cyan>)</font>
<a name="line-1343"></a><font color=Blue>gatetype</font> <font color=Cyan>(</font>GPhase t w c ncf<font color=Cyan>)</font> <font color=Red>=</font> 
<a name="line-1344"></a>  AnnGatetype <font color=Cyan>(</font>phase_name t<font color=Cyan>)</font> <font color=Cyan>(</font>Just <font color=Cyan>$</font> phase_name <font color=Cyan>(</font><font color=Blue><i>-</i></font>t<font color=Cyan>)</font><font color=Cyan>)</font> <font color=Cyan>(</font>controltype c<font color=Cyan>)</font> ncf AllCtl
<a name="line-1345"></a>  <font color=Green><u>where</u></font> phase_name t <font color=Red>=</font> <font color=Cyan>(</font>printf <font color=Magenta>"exp^(%f i pi)"</font> t<font color=Cyan>)</font>
<a name="line-1346"></a><font color=Blue>gatetype</font> <font color=Cyan>(</font>CNot w c ncf<font color=Cyan>)</font> <font color=Red>=</font> 
<a name="line-1347"></a>  AnnGatetype <font color=Magenta>"CNot"</font> <font color=Cyan>(</font>Just <font color=Magenta>"CNot"</font><font color=Cyan>)</font> <font color=Cyan>(</font>controltype c<font color=Cyan>)</font> ncf AllCtl
<a name="line-1348"></a><font color=Blue>gatetype</font> <font color=Cyan>(</font>CGate n w ws ncf<font color=Cyan>)</font> <font color=Red>=</font> 
<a name="line-1349"></a>  AnnGatetype <font color=Cyan>(</font>n' True<font color=Cyan>)</font> <font color=Cyan>(</font>Just <font color=Cyan>$</font> n' False<font color=Cyan>)</font> nocontrols ncf AllCtl
<a name="line-1350"></a>  <font color=Green><u>where</u></font> n' b <font color=Red>=</font> n <font color=Cyan>++</font> optional b <font color=Magenta>"*"</font> <font color=Cyan>`with_arity`</font> length ws
<a name="line-1351"></a><font color=Blue>gatetype</font> <font color=Cyan>(</font>CGateInv n w ws ncf<font color=Cyan>)</font> <font color=Red>=</font>
<a name="line-1352"></a>  AnnGatetype <font color=Cyan>(</font>n' False<font color=Cyan>)</font> <font color=Cyan>(</font>Just <font color=Cyan>$</font> n' True<font color=Cyan>)</font> nocontrols ncf AllCtl
<a name="line-1353"></a>  <font color=Green><u>where</u></font> n' b <font color=Red>=</font> n <font color=Cyan>++</font> optional b <font color=Magenta>"*"</font> <font color=Cyan>`with_arity`</font> length ws
<a name="line-1354"></a><font color=Blue>gatetype</font> <font color=Cyan>(</font>CSwap w v c ncf<font color=Cyan>)</font> <font color=Red>=</font>
<a name="line-1355"></a>  AnnGatetype <font color=Magenta>"CSwap"</font> <font color=Cyan>(</font>Just <font color=Magenta>"CSwap"</font><font color=Cyan>)</font> <font color=Cyan>(</font>controltype c<font color=Cyan>)</font> ncf AllCtl
<a name="line-1356"></a><font color=Blue>gatetype</font> <font color=Cyan>(</font>QPrep w ncf<font color=Cyan>)</font> <font color=Red>=</font>
<a name="line-1357"></a>  AnnGatetype <font color=Magenta>"Prep"</font> <font color=Cyan>(</font>Just <font color=Magenta>"Unprep"</font><font color=Cyan>)</font> nocontrols ncf NoCtl
<a name="line-1358"></a><font color=Blue>gatetype</font> <font color=Cyan>(</font>QUnprep w ncf<font color=Cyan>)</font> <font color=Red>=</font> 
<a name="line-1359"></a>  AnnGatetype <font color=Magenta>"Unprep"</font> <font color=Cyan>(</font>Just <font color=Magenta>"Prep"</font><font color=Cyan>)</font> nocontrols ncf NoCtl
<a name="line-1360"></a><font color=Blue>gatetype</font> <font color=Cyan>(</font>QInit b w ncf<font color=Cyan>)</font> <font color=Red>=</font>
<a name="line-1361"></a>  AnnGatetype <font color=Cyan>(</font><font color=Magenta>"Init"</font> <font color=Cyan>++</font> b'<font color=Cyan>)</font> <font color=Cyan>(</font>Just <font color=Cyan>$</font> <font color=Magenta>"Term"</font> <font color=Cyan>++</font> b'<font color=Cyan>)</font> nocontrols ncf NoCtl
<a name="line-1362"></a>  <font color=Green><u>where</u></font> b' <font color=Red>=</font> show <font color=Cyan>$</font> <font color=Green><u>if</u></font> b <font color=Green><u>then</u></font> <font color=Magenta>1</font> <font color=Green><u>else</u></font> <font color=Magenta>0</font>
<a name="line-1363"></a><font color=Blue>gatetype</font> <font color=Cyan>(</font>CInit b w ncf<font color=Cyan>)</font> <font color=Red>=</font>
<a name="line-1364"></a>  AnnGatetype <font color=Cyan>(</font><font color=Magenta>"CInit"</font> <font color=Cyan>++</font> b'<font color=Cyan>)</font> <font color=Cyan>(</font>Just <font color=Cyan>$</font> <font color=Magenta>"CTerm"</font> <font color=Cyan>++</font> b'<font color=Cyan>)</font> nocontrols ncf NoCtl
<a name="line-1365"></a>  <font color=Green><u>where</u></font> b' <font color=Red>=</font> show <font color=Cyan>$</font> <font color=Green><u>if</u></font> b <font color=Green><u>then</u></font> <font color=Magenta>1</font> <font color=Green><u>else</u></font> <font color=Magenta>0</font>
<a name="line-1366"></a><font color=Blue>gatetype</font> <font color=Cyan>(</font>QTerm b w ncf<font color=Cyan>)</font> <font color=Red>=</font>
<a name="line-1367"></a>  AnnGatetype <font color=Cyan>(</font><font color=Magenta>"Term"</font> <font color=Cyan>++</font> b'<font color=Cyan>)</font> <font color=Cyan>(</font>Just <font color=Cyan>$</font> <font color=Magenta>"Init"</font> <font color=Cyan>++</font> b'<font color=Cyan>)</font> nocontrols ncf NoCtl
<a name="line-1368"></a>  <font color=Green><u>where</u></font> b' <font color=Red>=</font> show <font color=Cyan>$</font> <font color=Green><u>if</u></font> b <font color=Green><u>then</u></font> <font color=Magenta>1</font> <font color=Green><u>else</u></font> <font color=Magenta>0</font>
<a name="line-1369"></a><font color=Blue>gatetype</font> <font color=Cyan>(</font>CTerm b w ncf<font color=Cyan>)</font> <font color=Red>=</font>
<a name="line-1370"></a>  AnnGatetype <font color=Cyan>(</font><font color=Magenta>"CTerm"</font> <font color=Cyan>++</font> b'<font color=Cyan>)</font> <font color=Cyan>(</font>Just <font color=Cyan>$</font> <font color=Magenta>"CInit"</font> <font color=Cyan>++</font> b'<font color=Cyan>)</font> nocontrols ncf NoCtl
<a name="line-1371"></a>  <font color=Green><u>where</u></font> b' <font color=Red>=</font> show <font color=Cyan>$</font> <font color=Green><u>if</u></font> b <font color=Green><u>then</u></font> <font color=Magenta>1</font> <font color=Green><u>else</u></font> <font color=Magenta>0</font>
<a name="line-1372"></a><font color=Blue>gatetype</font> <font color=Cyan>(</font>QMeas w<font color=Cyan>)</font> <font color=Red>=</font> 
<a name="line-1373"></a>  AnnGatetype <font color=Magenta>"Meas"</font> Nothing nocontrols False NoCtl
<a name="line-1374"></a><font color=Blue>gatetype</font> <font color=Cyan>(</font>QDiscard w<font color=Cyan>)</font> <font color=Red>=</font>
<a name="line-1375"></a>  AnnGatetype <font color=Magenta>"Discard"</font> Nothing nocontrols False NoCtl
<a name="line-1376"></a><font color=Blue>gatetype</font> <font color=Cyan>(</font>CDiscard w<font color=Cyan>)</font> <font color=Red>=</font>
<a name="line-1377"></a>  AnnGatetype <font color=Magenta>"CDiscard"</font> Nothing nocontrols False NoCtl
<a name="line-1378"></a><font color=Blue>gatetype</font> <font color=Cyan>(</font>DTerm b w<font color=Cyan>)</font> <font color=Red>=</font>
<a name="line-1379"></a>  AnnGatetype <font color=Magenta>"CDiscard"</font> Nothing nocontrols False NoCtl
<a name="line-1380"></a><font color=Blue>gatetype</font> <font color=Cyan>(</font>Subroutine boxid inv ws1 a1 ws2 a2 c ncf ctrble reps<font color=Cyan>)</font> <font color=Red>=</font>
<a name="line-1381"></a>  AnnGatetypeSubroutine boxid inv <font color=Cyan>(</font>controltype c<font color=Cyan>)</font> ncf ctrble
<a name="line-1382"></a><font color=Blue>gatetype</font> <font color=Cyan>(</font>Comment <font color=Green><u>_</u></font> inv ws<font color=Cyan>)</font> <font color=Red>=</font> AnnGatetype <font color=Cyan>(</font><font color=Magenta>"Comment"</font><font color=Cyan>)</font> <font color=Cyan>(</font>Just <font color=Magenta>"Comment"</font><font color=Cyan>)</font> nocontrols True NoCtl
<a name="line-1383"></a>
<a name="line-1384"></a><a name="string_of_gatetype"></a><font color=Blue><i>-- | Convert a gate type to a human-readable string.</i></font>
<a name="line-1385"></a><font color=Blue>string_of_gatetype</font> <font color=Red>::</font> Gatetype <font color=Red>-&gt;</font> String
<a name="line-1386"></a><font color=Blue>string_of_gatetype</font> <font color=Cyan>(</font>Gatetype s <font color=Cyan>(</font>c1<font color=Cyan>,</font>c2<font color=Cyan>)</font><font color=Cyan>)</font> <font color=Red>=</font>
<a name="line-1387"></a>  printf <font color=Magenta>"\"%s\""</font> s
<a name="line-1388"></a>  <font color=Cyan>++</font> <font color=Green><u>if</u></font> c2<font color=Cyan>==</font><font color=Magenta>0</font> <font color=Cyan>&amp;&amp;</font> c1<font color=Cyan>==</font><font color=Magenta>0</font> <font color=Green><u>then</u></font> <font color=Magenta>""</font> <font color=Green><u>else</u></font>
<a name="line-1389"></a>     <font color=Green><u>if</u></font> c2<font color=Cyan>==</font><font color=Magenta>0</font> <font color=Green><u>then</u></font> printf <font color=Magenta>", controls %d"</font> c1 <font color=Green><u>else</u></font>
<a name="line-1390"></a>     printf <font color=Magenta>" controls %d+%d"</font> c1 c2
<a name="line-1391"></a><font color=Blue>string_of_gatetype</font> <font color=Cyan>(</font>GatetypeSubroutine boxid i <font color=Cyan>(</font>c1<font color=Cyan>,</font>c2<font color=Cyan>)</font><font color=Cyan>)</font> <font color=Red>=</font>
<a name="line-1392"></a>  <font color=Magenta>"Subroutine"</font> <font color=Cyan>++</font> optional i <font color=Magenta>"*"</font> <font color=Cyan>++</font> cs <font color=Cyan>++</font> <font color=Magenta>": "</font> <font color=Cyan>++</font> string_of_boxid boxid
<a name="line-1393"></a>  <font color=Green><u>where</u></font>
<a name="line-1394"></a>    cs <font color=Red>=</font> <font color=Green><u>if</u></font> c2<font color=Cyan>==</font><font color=Magenta>0</font> <font color=Cyan>&amp;&amp;</font> c1<font color=Cyan>==</font><font color=Magenta>0</font> <font color=Green><u>then</u></font> <font color=Magenta>""</font> <font color=Green><u>else</u></font>
<a name="line-1395"></a>         <font color=Green><u>if</u></font> c2<font color=Cyan>==</font><font color=Magenta>0</font> <font color=Green><u>then</u></font> printf <font color=Magenta>", controls %d"</font> c1 <font color=Green><u>else</u></font>
<a name="line-1396"></a>         printf <font color=Magenta>" controls %d+%d"</font> c1 c2
<a name="line-1397"></a>
<a name="line-1398"></a><font color=Blue><i>-- ** Gate counts</i></font>
<a name="line-1399"></a>
<a name="line-1400"></a><a name="Gatecount"></a><font color=Blue><i>-- | Gate counts of circuits.  </i></font>
<a name="line-1401"></a><a name="Gatecount"></a><font color=Green><u>type</u></font> Gatecount <font color=Red>=</font> Map Gatetype Integer
<a name="line-1402"></a>
<a name="line-1403"></a><a name="AnnGatecount"></a><font color=Blue><i>-- | Annotated gate counts of circuits.  </i></font>
<a name="line-1404"></a><a name="AnnGatecount"></a><font color=Green><u>type</u></font> AnnGatecount <font color=Red>=</font> Map AnnGatetype Integer
<a name="line-1405"></a>
<a name="line-1406"></a><a name="reverse_gatecount"></a><font color=Blue><i>-- | Given the (annotated) gatecount of a circuit, return the gatecount of</i></font>
<a name="line-1407"></a><font color=Blue><i>-- the reverse circuit, or throw an error if any component is not reversible.</i></font>
<a name="line-1408"></a><font color=Blue>reverse_gatecount</font> <font color=Red>::</font> ErrMsg <font color=Red>-&gt;</font> AnnGatecount <font color=Red>-&gt;</font> AnnGatecount
<a name="line-1409"></a><font color=Blue>reverse_gatecount</font> e <font color=Red>=</font> Map<font color=Cyan>.</font>mapKeysWith <font color=Cyan>(</font><font color=Cyan>+</font><font color=Cyan>)</font> <font color=Cyan>(</font>reverse_gatetype e<font color=Cyan>)</font>
<a name="line-1410"></a>
<a name="line-1411"></a><a name="add_controls_gatecount"></a><font color=Blue><i>-- | Given the (annotated) gatecount of a circuit, return the gatecount of</i></font>
<a name="line-1412"></a><font color=Blue><i>-- the same circuit with controls added, or throw an error if any component</i></font>
<a name="line-1413"></a><font color=Blue><i>-- is not controllable.</i></font>
<a name="line-1414"></a><font color=Blue>add_controls_gatecount</font> <font color=Red>::</font> ErrMsg <font color=Red>-&gt;</font> ControlType <font color=Red>-&gt;</font> AnnGatecount <font color=Red>-&gt;</font> AnnGatecount
<a name="line-1415"></a><font color=Blue>add_controls_gatecount</font> e cs <font color=Red>=</font> Map<font color=Cyan>.</font>mapKeysWith <font color=Cyan>(</font><font color=Cyan>+</font><font color=Cyan>)</font> <font color=Cyan>(</font>add_controls_gatetype e cs<font color=Cyan>)</font>
<a name="line-1416"></a>
<a name="line-1417"></a><a name="set_ncf_gatecount"></a><font color=Blue><i>-- | Set the ncf of all gates in a gatecount to 'True'.</i></font>
<a name="line-1418"></a><font color=Blue>set_ncf_gatecount</font> <font color=Red>::</font> AnnGatecount <font color=Red>-&gt;</font> AnnGatecount
<a name="line-1419"></a><font color=Blue>set_ncf_gatecount</font> <font color=Red>=</font> Map<font color=Cyan>.</font>mapKeysWith <font color=Cyan>(</font><font color=Cyan>+</font><font color=Cyan>)</font> set_ncf_gatetype
<a name="line-1420"></a>
<a name="line-1421"></a><a name="unannotate_gatecount"></a><font color=Blue><i>-- | Remove the annotations from a gatecount.</i></font>
<a name="line-1422"></a><font color=Blue>unannotate_gatecount</font> <font color=Red>::</font> AnnGatecount <font color=Red>-&gt;</font> Gatecount
<a name="line-1423"></a><font color=Blue>unannotate_gatecount</font> <font color=Red>=</font> Map<font color=Cyan>.</font>mapKeysWith <font color=Cyan>(</font><font color=Cyan>+</font><font color=Cyan>)</font> unannotate_gatetype
<a name="line-1424"></a>
<a name="line-1425"></a><a name="count"></a><font color=Blue><i>-- | Input a list of items and output a map from items to counts.</i></font>
<a name="line-1426"></a><font color=Blue><i>-- Example: </i></font>
<a name="line-1427"></a><font color=Blue><i>-- </i></font>
<a name="line-1428"></a><font color=Blue><i>-- &gt; count ['a', 'b', 'a'] = Map.fromList [('a',2), ('b',1)]</i></font>
<a name="line-1429"></a><font color=Blue>count</font> <font color=Red>::</font> <font color=Cyan>(</font>Ord a<font color=Cyan>,</font> Num int<font color=Cyan>)</font> <font color=Red>=&gt;</font> <font color=Red>[</font><font color=Cyan>(</font>int<font color=Cyan>,</font>a<font color=Cyan>)</font><font color=Red>]</font> <font color=Red>-&gt;</font> Map a int
<a name="line-1430"></a><font color=Blue>count</font> list <font color=Red>=</font>
<a name="line-1431"></a>  foldl' <font color=Cyan>(</font><font color=Red>\</font>mp <font color=Cyan>(</font>i<font color=Cyan>,</font>x<font color=Cyan>)</font> <font color=Red>-&gt;</font> Map<font color=Cyan>.</font>insertWith' <font color=Cyan>(</font><font color=Cyan>+</font><font color=Cyan>)</font> x i mp<font color=Cyan>)</font> Map<font color=Cyan>.</font>empty list 
<a name="line-1432"></a>
<a name="line-1433"></a><a name="anngatecount_of_circuit"></a><font color=Blue><i>-- | Count the number of gates of each type in a circuit, with annotations,</i></font>
<a name="line-1434"></a><font color=Blue><i>-- treating subroutine calls as atomic gates.</i></font>
<a name="line-1435"></a><font color=Blue>anngatecount_of_circuit</font> <font color=Red>::</font> Circuit <font color=Red>-&gt;</font> AnnGatecount
<a name="line-1436"></a><font color=Blue>anngatecount_of_circuit</font> <font color=Cyan>(</font><font color=Green><u>_</u></font><font color=Cyan>,</font>gs<font color=Cyan>,</font><font color=Green><u>_</u></font><font color=Cyan>,</font><font color=Green><u>_</u></font><font color=Cyan>)</font> <font color=Red>=</font> count <font color=Cyan>$</font> map <font color=Cyan>(</font><font color=Red>\</font>x <font color=Red>-&gt;</font> <font color=Cyan>(</font>repeated x<font color=Cyan>,</font> gatetype x<font color=Cyan>)</font><font color=Cyan>)</font> <font color=Cyan>$</font> filter <font color=Cyan>(</font>not <font color=Cyan>.</font> is_comment<font color=Cyan>)</font> gs
<a name="line-1437"></a>  <font color=Green><u>where</u></font>
<a name="line-1438"></a>    is_comment <font color=Cyan>(</font>Comment <font color=Green><u>_</u></font> <font color=Green><u>_</u></font> <font color=Green><u>_</u></font><font color=Cyan>)</font> <font color=Red>=</font> True
<a name="line-1439"></a>    is_comment <font color=Green><u>_</u></font> <font color=Red>=</font> False
<a name="line-1440"></a>    repeated <font color=Cyan>(</font>Subroutine <font color=Green><u>_</u></font> <font color=Green><u>_</u></font> <font color=Green><u>_</u></font> <font color=Green><u>_</u></font> <font color=Green><u>_</u></font> <font color=Green><u>_</u></font> <font color=Green><u>_</u></font> <font color=Green><u>_</u></font> <font color=Green><u>_</u></font> <font color=Cyan>(</font>RepeatFlag repeat<font color=Cyan>)</font><font color=Cyan>)</font> <font color=Red>=</font> repeat
<a name="line-1441"></a>    repeated <font color=Green><u>_</u></font> <font color=Red>=</font> <font color=Magenta>1</font>
<a name="line-1442"></a>
<a name="line-1443"></a><a name="gatecount_of_circuit"></a><font color=Blue><i>-- | Count the number of gates of each type in a circuit,</i></font>
<a name="line-1444"></a><font color=Blue><i>-- treating subroutine calls as atomic gates.</i></font>
<a name="line-1445"></a><font color=Blue>gatecount_of_circuit</font> <font color=Red>::</font> Circuit <font color=Red>-&gt;</font> Gatecount
<a name="line-1446"></a><font color=Blue>gatecount_of_circuit</font> <font color=Red>=</font> unannotate_gatecount <font color=Cyan>.</font> anngatecount_of_circuit
<a name="line-1447"></a>
<a name="line-1448"></a><a name="gatecount_of_subroutine_call"></a><font color=Blue><i>-- | Given an 'AnnGatetype' describing a subroutine call</i></font>
<a name="line-1449"></a><font color=Blue><i>-- (possibly repeated),</i></font>
<a name="line-1450"></a><font color=Blue><i>-- and a gate count for the subroutine itself, return the gatecount </i></font>
<a name="line-1451"></a><font color=Blue><i>-- of the subroutine call.</i></font>
<a name="line-1452"></a><font color=Blue><i>--</i></font>
<a name="line-1453"></a><font color=Blue><i>-- (This may be the reverse of the original subroutine, may have</i></font>
<a name="line-1454"></a><font color=Blue><i>-- controls added, etc.)</i></font>
<a name="line-1455"></a><font color=Blue>gatecount_of_subroutine_call</font> <font color=Red>::</font> ErrMsg <font color=Red>-&gt;</font> AnnGatetype <font color=Red>-&gt;</font> RepeatFlag <font color=Red>-&gt;</font> AnnGatecount <font color=Red>-&gt;</font> AnnGatecount
<a name="line-1456"></a><font color=Blue>gatecount_of_subroutine_call</font> e <font color=Cyan>(</font>AnnGatetypeSubroutine boxid inv cs ncf ctrble<font color=Cyan>)</font> <font color=Cyan>(</font>RepeatFlag reps<font color=Cyan>)</font> <font color=Red>=</font>
<a name="line-1457"></a>  <font color=Cyan>(</font><font color=Green><u>if</u></font> inv <font color=Green><u>then</u></font> reverse_gatecount err_inv <font color=Green><u>else</u></font> id<font color=Cyan>)</font>
<a name="line-1458"></a>  <font color=Cyan>.</font> <font color=Cyan>(</font><font color=Green><u>if</u></font> cs <font color=Cyan>==</font> nocontrols <font color=Green><u>then</u></font> id
<a name="line-1459"></a>       <font color=Green><u>else</u></font> <font color=Green><u>case</u></font> ctrble <font color=Green><u>of</u></font>
<a name="line-1460"></a>             AllCtl           <font color=Red>-&gt;</font> add_controls_gatecount err_ctrl cs
<a name="line-1461"></a>             OnlyClassicalCtl <font color=Red>-&gt;</font> add_controls_gatecount err_ctrl cs
<a name="line-1462"></a>             NoCtl            <font color=Red>-&gt;</font> error <font color=Cyan>$</font> err_ctrble<font color=Cyan>)</font>
<a name="line-1463"></a>  <font color=Cyan>.</font> <font color=Cyan>(</font><font color=Green><u>if</u></font> reps <font color=Cyan>==</font> <font color=Magenta>1</font> <font color=Green><u>then</u></font> id <font color=Green><u>else</u></font> <font color=Cyan>(</font>Map<font color=Cyan>.</font>map <font color=Cyan>(</font><font color=Cyan>*</font> reps<font color=Cyan>)</font><font color=Cyan>)</font><font color=Cyan>)</font>
<a name="line-1464"></a>  <font color=Cyan>.</font> <font color=Cyan>(</font><font color=Green><u>if</u></font> ncf <font color=Green><u>then</u></font> set_ncf_gatecount <font color=Green><u>else</u></font> id<font color=Cyan>)</font> 
<a name="line-1465"></a>  <font color=Green><u>where</u></font>
<a name="line-1466"></a>    err_inv <font color=Red>=</font> e <font color=Cyan>.</font> <font color=Cyan>(</font><font color=Cyan>(</font><font color=Magenta>"gatecount_of_subroutine_call, inverting subroutine "</font> <font color=Cyan>++</font> longname <font color=Cyan>++</font> <font color=Magenta>": "</font><font color=Cyan>)</font> <font color=Cyan>++</font><font color=Cyan>)</font>
<a name="line-1467"></a>    err_ctrl <font color=Red>=</font> e <font color=Cyan>.</font> <font color=Cyan>(</font><font color=Cyan>(</font><font color=Magenta>"gatecount_of_subroutine_call, controlling subroutine "</font> <font color=Cyan>++</font> longname <font color=Cyan>++</font> <font color=Magenta>": "</font><font color=Cyan>)</font> <font color=Cyan>++</font><font color=Cyan>)</font>
<a name="line-1468"></a>    err_ctrble <font color=Red>=</font> e <font color=Cyan>$</font> <font color=Magenta>"gatecount_of_subroutine_call: subroutine "</font> <font color=Cyan>++</font> longname <font color=Cyan>++</font> <font color=Magenta>" not controllable"</font>
<a name="line-1469"></a>    longname <font color=Red>=</font> string_of_boxid boxid
<a name="line-1470"></a>    
<a name="line-1471"></a><font color=Blue>gatecount_of_subroutine_call</font> e <font color=Green><u>_</u></font> <font color=Green><u>_</u></font> <font color=Red>=</font> error <font color=Cyan>$</font> e <font color=Magenta>"internal error (gatecount_of_subroutine_call called on non-subroutine)"</font>
<a name="line-1472"></a>
<a name="line-1473"></a><a name="anngatecount_of_circuit_with_sub_cts"></a><font color=Blue><i>-- | Given a circuit and gatecounts for its subroutines, </i></font>
<a name="line-1474"></a><font color=Blue><i>-- give an (aggregated) gatecount for the circuit.</i></font>
<a name="line-1475"></a><font color=Blue>anngatecount_of_circuit_with_sub_cts</font> <font color=Red>::</font> ErrMsg <font color=Red>-&gt;</font> Map BoxId AnnGatecount <font color=Red>-&gt;</font> Circuit <font color=Red>-&gt;</font> AnnGatecount
<a name="line-1476"></a><font color=Blue>anngatecount_of_circuit_with_sub_cts</font> e sub_cts <font color=Cyan>(</font><font color=Green><u>_</u></font><font color=Cyan>,</font>gs<font color=Cyan>,</font><font color=Green><u>_</u></font><font color=Cyan>,</font><font color=Green><u>_</u></font><font color=Cyan>)</font> <font color=Red>=</font>
<a name="line-1477"></a>  foldr action Map<font color=Cyan>.</font>empty gs
<a name="line-1478"></a>  <font color=Green><u>where</u></font>
<a name="line-1479"></a>    action <font color=Cyan>(</font>Comment <font color=Green><u>_</u></font> <font color=Green><u>_</u></font> <font color=Green><u>_</u></font><font color=Cyan>)</font> <font color=Red>=</font> id
<a name="line-1480"></a>    action g<font color=Red>@</font><font color=Cyan>(</font>Subroutine n <font color=Green><u>_</u></font> <font color=Green><u>_</u></font> <font color=Green><u>_</u></font> <font color=Green><u>_</u></font> <font color=Green><u>_</u></font> <font color=Green><u>_</u></font> <font color=Green><u>_</u></font> <font color=Green><u>_</u></font> reps<font color=Cyan>)</font> <font color=Red>=</font> 
<a name="line-1481"></a>      <font color=Green><u>case</u></font> Map<font color=Cyan>.</font>lookup n sub_cts <font color=Green><u>of</u></font>
<a name="line-1482"></a>        Nothing <font color=Red>-&gt;</font> error <font color=Cyan>$</font> e <font color=Cyan>$</font> <font color=Magenta>"subroutine not found: "</font> <font color=Cyan>++</font> show n
<a name="line-1483"></a>        Just n_ct <font color=Red>-&gt;</font> flip <font color=Cyan>(</font>Map<font color=Cyan>.</font>unionWith <font color=Cyan>(</font><font color=Cyan>+</font><font color=Cyan>)</font><font color=Cyan>)</font> <font color=Cyan>$</font>
<a name="line-1484"></a>                       gatecount_of_subroutine_call e <font color=Cyan>(</font>gatetype g<font color=Cyan>)</font> reps n_ct
<a name="line-1485"></a>    action g <font color=Red>=</font> Map<font color=Cyan>.</font>insertWith' <font color=Cyan>(</font><font color=Cyan>+</font><font color=Cyan>)</font> <font color=Cyan>(</font>gatetype g<font color=Cyan>)</font> <font color=Magenta>1</font>
<a name="line-1486"></a>
<a name="line-1487"></a><a name="aggregate_gatecounts_of_bcircuit"></a><font color=Blue><i>-- | Give the aggregate gate count of a 'BCircuit'; that is, the</i></font>
<a name="line-1488"></a><font color=Blue><i>-- the total count of basic gates once all subroutines are fully inlined.</i></font>
<a name="line-1489"></a><font color=Blue>aggregate_gatecounts_of_bcircuit</font> <font color=Red>::</font> BCircuit <font color=Red>-&gt;</font> Gatecount
<a name="line-1490"></a><font color=Blue>aggregate_gatecounts_of_bcircuit</font> <font color=Cyan>(</font>main_circ<font color=Cyan>,</font> namespace<font color=Cyan>)</font>
<a name="line-1491"></a>  <font color=Red>=</font> unannotate_gatecount <font color=Cyan>$</font>
<a name="line-1492"></a>    anngatecount_of_circuit_with_sub_cts e sub_cts main_circ
<a name="line-1493"></a>    <font color=Green><u>where</u></font>
<a name="line-1494"></a>      sub_cts <font color=Red>=</font> Map<font color=Cyan>.</font>map <font color=Cyan>(</font>anngatecount_of_circuit_with_sub_cts e sub_cts <font color=Cyan>.</font> circuit_of_typedsubroutine<font color=Cyan>)</font> namespace
<a name="line-1495"></a>      e <font color=Red>=</font> <font color=Cyan>(</font><font color=Magenta>"aggregate_gatecounts_of_bcircuit: "</font> <font color=Cyan>++</font><font color=Cyan>)</font>
<a name="line-1496"></a>
<a name="line-1497"></a><font color=Blue><i>-- ** Wire usage count</i></font>
<a name="line-1498"></a>
<a name="line-1499"></a><font color=Blue><i>-- | Count by how much a low-level gate changes the number of wires in the arity.</i></font>
<a name="line-1500"></a>
<a name="line-1501"></a><a name="gate_wires_change"></a><font color=Blue><i>-- Implementation note: writing this function explicitly case-by-case appears</i></font>
<a name="line-1502"></a><font color=Blue><i>-- very slightly faster (~0.5%), but more fragile/less maintainable.</i></font>
<a name="line-1503"></a><font color=Blue>gate_wires_change</font> <font color=Red>::</font> Gate <font color=Red>-&gt;</font> Integer
<a name="line-1504"></a><font color=Blue>gate_wires_change</font> g <font color=Red>=</font> 
<a name="line-1505"></a>  <font color=Green><u>let</u></font> <font color=Cyan>(</font>a_in<font color=Cyan>,</font>a_out<font color=Cyan>)</font> <font color=Red>=</font> gate_arity g
<a name="line-1506"></a>  <font color=Green><u>in</u></font> fromIntegral <font color=Cyan>$</font> length a_out <font color=Blue><i>-</i></font> length a_in
<a name="line-1507"></a>
<a name="line-1508"></a><a name="aggregate_maxwires_of_bcircuit"></a><font color=Blue><i>-- | Find the maximum number of wires used simultaneously in a 'BCircuit',</i></font>
<a name="line-1509"></a><font color=Blue><i>-- assuming all subroutines inlined. </i></font>
<a name="line-1510"></a><font color=Blue>aggregate_maxwires_of_bcircuit</font> <font color=Red>::</font> BCircuit <font color=Red>-&gt;</font> Integer
<a name="line-1511"></a><font color=Blue>aggregate_maxwires_of_bcircuit</font> <font color=Cyan>(</font>main_circ<font color=Cyan>,</font> namespace<font color=Cyan>)</font>
<a name="line-1512"></a>  <font color=Red>=</font> maxwires_of_circuit_with_sub_maxwires e sub_maxs main_circ
<a name="line-1513"></a>    <font color=Green><u>where</u></font>
<a name="line-1514"></a>      e <font color=Red>=</font> <font color=Cyan>(</font><font color=Magenta>"aggregate_maxwires_of_bcircuit: "</font> <font color=Cyan>++</font><font color=Cyan>)</font>
<a name="line-1515"></a>      sub_maxs <font color=Red>=</font> Map<font color=Cyan>.</font>map <font color=Cyan>(</font>maxwires_of_circuit_with_sub_maxwires e sub_maxs <font color=Cyan>.</font> circuit_of_typedsubroutine<font color=Cyan>)</font> namespace
<a name="line-1516"></a>
<a name="line-1517"></a><a name="maxwires_of_circuit_with_sub_maxwires"></a><font color=Blue><i>-- | Given a circuit and gatecounts for its subroutines, </i></font>
<a name="line-1518"></a><font color=Blue><i>-- give an (aggregated) gatecount for the circuit.</i></font>
<a name="line-1519"></a><font color=Blue>maxwires_of_circuit_with_sub_maxwires</font> <font color=Red>::</font> ErrMsg <font color=Red>-&gt;</font> Map BoxId Integer <font color=Red>-&gt;</font> Circuit <font color=Red>-&gt;</font> Integer
<a name="line-1520"></a><font color=Blue>maxwires_of_circuit_with_sub_maxwires</font> e sub_maxs <font color=Cyan>(</font>a1<font color=Cyan>,</font>gs<font color=Cyan>,</font>a2<font color=Cyan>,</font><font color=Green><u>_</u></font><font color=Cyan>)</font> <font color=Red>=</font>
<a name="line-1521"></a>  snd <font color=Cyan>$</font> foldl <font color=Cyan>(</font>flip action<font color=Cyan>)</font> <font color=Cyan>(</font>in_wires<font color=Cyan>,</font> in_wires<font color=Cyan>)</font> gs
<a name="line-1522"></a>  <font color=Green><u>where</u></font>
<a name="line-1523"></a>    in_wires <font color=Red>=</font> fromIntegral <font color=Cyan>$</font> IntMap<font color=Cyan>.</font>size a1
<a name="line-1524"></a>    update w_change <font color=Cyan>(</font><font color=Cyan>!</font>w_old<font color=Cyan>,</font> <font color=Cyan>!</font>wmax_old<font color=Cyan>)</font> <font color=Red>=</font>
<a name="line-1525"></a><font color=Blue><i>-- Implementation note: strictness in this pattern is to avoid putting the whole</i></font>
<a name="line-1526"></a><font color=Blue><i>-- tower of &#8220;max&#8221; applications on the stack.</i></font>
<a name="line-1527"></a>      <font color=Green><u>let</u></font> w_new <font color=Red>=</font> w_old <font color=Cyan>+</font> w_change <font color=Green><u>in</u></font> <font color=Cyan>(</font>w_new<font color=Cyan>,</font> max wmax_old w_new<font color=Cyan>)</font>
<a name="line-1528"></a>    action g<font color=Red>@</font><font color=Cyan>(</font>Subroutine n <font color=Green><u>_</u></font> ws1 <font color=Green><u>_</u></font> ws2 <font color=Green><u>_</u></font> <font color=Green><u>_</u></font> <font color=Green><u>_</u></font> <font color=Green><u>_</u></font> <font color=Cyan>(</font>RepeatFlag r<font color=Cyan>)</font><font color=Cyan>)</font> <font color=Red>=</font> 
<a name="line-1529"></a>      <font color=Green><u>case</u></font> Map<font color=Cyan>.</font>lookup n sub_maxs <font color=Green><u>of</u></font>
<a name="line-1530"></a>        Nothing <font color=Red>-&gt;</font> error <font color=Cyan>$</font> <font color=Magenta>"subroutine not found: "</font> <font color=Cyan>++</font> show n
<a name="line-1531"></a>        Just n_max <font color=Red>-&gt;</font> <font color=Cyan>(</font>update <font color=Cyan>$</font> <font color=Cyan>(</font>fromIntegral <font color=Cyan>$</font> length ws2<font color=Cyan>)</font> <font color=Blue><i>-</i></font> n_max<font color=Cyan>)</font>
<a name="line-1532"></a>                      <font color=Cyan>.</font> <font color=Cyan>(</font>update <font color=Cyan>$</font> n_max <font color=Blue><i>-</i></font> <font color=Cyan>(</font>fromIntegral <font color=Cyan>$</font> length ws1<font color=Cyan>)</font><font color=Cyan>)</font>
<a name="line-1533"></a>    action g <font color=Red>=</font> update <font color=Cyan>$</font> gate_wires_change g
<a name="line-1534"></a>
<a name="line-1535"></a><font color=Blue><i>-- ** Printing gate counts</i></font>
<a name="line-1536"></a>
<a name="line-1537"></a><a name="print_gatecount"></a><font color=Blue><i>-- | Print a gate count, as a table of integers and gate types. </i></font>
<a name="line-1538"></a><font color=Blue>print_gatecount</font> <font color=Red>::</font> Gatecount <font color=Red>-&gt;</font> IO ()
<a name="line-1539"></a><font color=Blue>print_gatecount</font> cts <font color=Red>=</font> mapM_
<a name="line-1540"></a>  <font color=Cyan>(</font><font color=Red>\</font><font color=Cyan>(</font>gt<font color=Cyan>,</font>k<font color=Cyan>)</font> <font color=Red>-&gt;</font> putStr <font color=Cyan>(</font>printf <font color=Cyan>(</font><font color=Magenta>"%"</font> <font color=Cyan>++</font> show max_digits <font color=Cyan>++</font> <font color=Magenta>"d: %s\n"</font><font color=Cyan>)</font> k <font color=Cyan>(</font>string_of_gatetype gt<font color=Cyan>)</font><font color=Cyan>)</font><font color=Cyan>)</font>
<a name="line-1541"></a>  <font color=Cyan>(</font>Map<font color=Cyan>.</font>assocs cts<font color=Cyan>)</font>
<a name="line-1542"></a>  <font color=Green><u>where</u></font>
<a name="line-1543"></a>    max_digits <font color=Red>=</font> maximum <font color=Cyan>$</font> <font color=Magenta>5</font><font color=Red><b>:</b></font><font color=Cyan>(</font>map <font color=Cyan>(</font><font color=Cyan>(</font><font color=Magenta>1</font><font color=Cyan>+</font><font color=Cyan>)</font> <font color=Cyan>.</font> floor <font color=Cyan>.</font> logBase <font color=Magenta>10</font> <font color=Cyan>.</font> fromIntegral<font color=Cyan>)</font> <font color=Cyan>(</font>Map<font color=Cyan>.</font>elems cts<font color=Cyan>)</font><font color=Cyan>)</font>
<a name="line-1544"></a>
<a name="line-1545"></a><a name="print_gatecounts_circuit"></a><font color=Blue><i>-- | Print the simple gate count, plus summary information, for a simple circuit.</i></font>
<a name="line-1546"></a><font color=Blue>print_gatecounts_circuit</font> <font color=Red>::</font> Circuit <font color=Red>-&gt;</font> IO ()
<a name="line-1547"></a><font color=Blue>print_gatecounts_circuit</font> circ<font color=Red>@</font><font color=Cyan>(</font>a1<font color=Cyan>,</font>gs<font color=Cyan>,</font>a2<font color=Cyan>,</font>n<font color=Cyan>)</font> <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-1548"></a>  print_gatecount cts
<a name="line-1549"></a>  putStrLn <font color=Cyan>$</font> printf <font color=Magenta>"Total gates: %d"</font> <font color=Cyan>$</font> sum <font color=Cyan>$</font> Map<font color=Cyan>.</font>elems cts
<a name="line-1550"></a>  putStrLn <font color=Cyan>$</font> printf <font color=Magenta>"Inputs: %d"</font> <font color=Cyan>$</font> IntMap<font color=Cyan>.</font>size a1
<a name="line-1551"></a>  putStrLn <font color=Cyan>$</font> printf <font color=Magenta>"Outputs: %d"</font> <font color=Cyan>$</font> IntMap<font color=Cyan>.</font>size a2
<a name="line-1552"></a>  putStrLn <font color=Cyan>$</font> printf <font color=Magenta>"Qubits in circuit: %d"</font> n
<a name="line-1553"></a>  <font color=Green><u>where</u></font>
<a name="line-1554"></a>    cts <font color=Red>=</font> gatecount_of_circuit circ
<a name="line-1555"></a>
<a name="line-1556"></a><a name="print_gatecounts_bcircuit"></a><font color=Blue><i>-- | Print gate counts for a boxed circuit:</i></font>
<a name="line-1557"></a><font color=Blue><i>-- first the simple gate count for each subroutine separately,</i></font>
<a name="line-1558"></a><font color=Blue><i>-- then the aggregated count for the whole circuit.</i></font>
<a name="line-1559"></a><font color=Blue>print_gatecounts_bcircuit</font> <font color=Red>::</font> BCircuit <font color=Red>-&gt;</font> IO ()
<a name="line-1560"></a><font color=Blue>print_gatecounts_bcircuit</font> bcirc<font color=Red>@</font><font color=Cyan>(</font>circ<font color=Red>@</font><font color=Cyan>(</font>a1<font color=Cyan>,</font><font color=Green><u>_</u></font><font color=Cyan>,</font>a2<font color=Cyan>,</font><font color=Green><u>_</u></font><font color=Cyan>)</font><font color=Cyan>,</font>namespace<font color=Cyan>)</font> <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-1561"></a>  print_gatecounts_circuit circ
<a name="line-1562"></a>  when <font color=Cyan>(</font>not <font color=Cyan>$</font> Map<font color=Cyan>.</font>null namespace<font color=Cyan>)</font> <font color=Cyan>$</font> <font color=Green><u>do</u></font>
<a name="line-1563"></a>    sequence_ <font color=Red>[</font> <font color=Cyan>(</font>putStrLn <font color=Magenta>""</font><font color=Cyan>)</font> <font color=Cyan>&gt;&gt;</font> <font color=Cyan>(</font>print_gatecounts_subroutine sub<font color=Cyan>)</font> <font color=Red>|</font> sub <font color=Red>&lt;-</font> Map<font color=Cyan>.</font>toList namespace <font color=Red>]</font>
<a name="line-1564"></a>    putStrLn <font color=Magenta>""</font>
<a name="line-1565"></a>    putStrLn <font color=Magenta>"Aggregated gate count:"</font> 
<a name="line-1566"></a>    <font color=Green><u>let</u></font> aggregate_cts <font color=Red>=</font> aggregate_gatecounts_of_bcircuit bcirc
<a name="line-1567"></a>        maxwires <font color=Red>=</font> aggregate_maxwires_of_bcircuit bcirc
<a name="line-1568"></a>    print_gatecount aggregate_cts
<a name="line-1569"></a>    putStrLn <font color=Cyan>$</font> printf <font color=Magenta>"Total gates: %d"</font> <font color=Cyan>$</font> sum <font color=Cyan>$</font> Map<font color=Cyan>.</font>elems aggregate_cts
<a name="line-1570"></a>    putStrLn <font color=Cyan>$</font> printf <font color=Magenta>"Inputs: %d"</font> <font color=Cyan>$</font> IntMap<font color=Cyan>.</font>size a1
<a name="line-1571"></a>    putStrLn <font color=Cyan>$</font> printf <font color=Magenta>"Outputs: %d"</font> <font color=Cyan>$</font> IntMap<font color=Cyan>.</font>size a2
<a name="line-1572"></a>    putStrLn <font color=Cyan>$</font> printf <font color=Magenta>"Qubits in circuit: %d"</font> maxwires
<a name="line-1573"></a>
<a name="line-1574"></a><a name="print_gatecounts_subroutine"></a><font color=Blue><i>-- | Print gate counts for a named subroutine.</i></font>
<a name="line-1575"></a><font color=Blue>print_gatecounts_subroutine</font> <font color=Red>::</font> <font color=Cyan>(</font>BoxId<font color=Cyan>,</font> TypedSubroutine<font color=Cyan>)</font> <font color=Red>-&gt;</font> IO ()
<a name="line-1576"></a><font color=Blue>print_gatecounts_subroutine</font> <font color=Cyan>(</font>boxid<font color=Cyan>,</font> TypedSubroutine ocirc <font color=Green><u>_</u></font> <font color=Green><u>_</u></font> <font color=Green><u>_</u></font><font color=Cyan>)</font> <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-1577"></a>  putStrLn <font color=Cyan>(</font><font color=Magenta>"Subroutine: "</font> <font color=Cyan>++</font> show name<font color=Cyan>)</font>
<a name="line-1578"></a>  putStrLn <font color=Cyan>(</font><font color=Magenta>"Shape: "</font> <font color=Cyan>++</font> show shape<font color=Cyan>)</font>
<a name="line-1579"></a>  print_gatecounts_circuit circ
<a name="line-1580"></a>  <font color=Green><u>where</u></font>
<a name="line-1581"></a>    OCircuit <font color=Cyan>(</font><font color=Green><u>_</u></font><font color=Cyan>,</font> circ<font color=Cyan>,</font> <font color=Green><u>_</u></font><font color=Cyan>)</font> <font color=Red>=</font> ocirc
<a name="line-1582"></a>    BoxId name shape <font color=Red>=</font> boxid
<a name="line-1583"></a>
<a name="line-1584"></a><a name="print_gatecounts_dbcircuit"></a><font color=Blue><i>-- | Print gate counts for a static 'DBCircuit'. The circuit may not</i></font>
<a name="line-1585"></a><font color=Blue><i>-- use any dynamic lifting, or else an error will be produced.</i></font>
<a name="line-1586"></a><font color=Blue>print_gatecounts_dbcircuit</font> <font color=Red>::</font> ErrMsg <font color=Red>-&gt;</font> DBCircuit a <font color=Red>-&gt;</font> IO ()
<a name="line-1587"></a><font color=Blue>print_gatecounts_dbcircuit</font> e dbcirc <font color=Red>=</font> print_gatecounts_bcircuit bcirc <font color=Green><u>where</u></font>
<a name="line-1588"></a>  <font color=Cyan>(</font>bcirc<font color=Cyan>,</font> <font color=Green><u>_</u></font><font color=Cyan>)</font> <font color=Red>=</font> bcircuit_of_static_dbcircuit errmsg dbcirc
<a name="line-1589"></a>  errmsg x <font color=Red>=</font> e <font color=Cyan>(</font><font color=Magenta>"operation not permitted during gate count: "</font> <font color=Cyan>++</font> x<font color=Cyan>)</font>
<a name="line-1590"></a>
<a name="line-1591"></a><font color=Blue><i>-- ----------------------------------------------------------------------</i></font>
<a name="line-1592"></a><font color=Blue><i>-- * Printing to multiple formats</i></font>
<a name="line-1593"></a>
<a name="line-1594"></a><font color=Blue><i>-- | Available output formats.</i></font>
<a name="line-1595"></a>
<a name="line-1596"></a><a name="Format"></a><font color=Green><u>data</u></font> Format <font color=Red>=</font> 
<a name="line-1597"></a>  EPS         <font color=Blue><i>-- ^ Encapsulated PostScript graphics.</i></font>
<a name="line-1598"></a>  <font color=Red>|</font> PDF       <font color=Blue><i>-- ^ Portable Document Format. One circuit per page.</i></font>
<a name="line-1599"></a>  <font color=Red>|</font> PS        <font color=Blue><i>-- ^ PostScript. One circuit per page.</i></font>
<a name="line-1600"></a>  <font color=Red>|</font> ASCII     <font color=Blue><i>-- ^ A textual representation of circuits.</i></font>
<a name="line-1601"></a>  <font color=Red>|</font> Preview   <font color=Blue><i>-- ^ Don't print anything, but preview directly on screen (requires the external program /acroread/).</i></font>
<a name="line-1602"></a>  <font color=Red>|</font> GateCount <font color=Blue><i>-- ^ Print statistics on gate counts.</i></font>
<a name="line-1603"></a>  <font color=Red>|</font> CustomStyle FormatStyle
<a name="line-1604"></a>  <font color=Green><u>deriving</u></font> Show
<a name="line-1605"></a>    
<a name="line-1606"></a><a name="format_enum"></a><font color=Blue><i>-- | A mapping from lower-case strings (to be used, e.g., with command</i></font>
<a name="line-1607"></a><font color=Blue><i>-- line options) to available formats.</i></font>
<a name="line-1608"></a><font color=Blue>format_enum</font> <font color=Red>::</font> <font color=Red>[</font><font color=Cyan>(</font>String<font color=Cyan>,</font> Format<font color=Cyan>)</font><font color=Red>]</font>
<a name="line-1609"></a><font color=Blue>format_enum</font> <font color=Red>=</font> <font color=Red>[</font>
<a name="line-1610"></a>  <font color=Cyan>(</font><font color=Magenta>"eps"</font><font color=Cyan>,</font> EPS<font color=Cyan>)</font><font color=Cyan>,</font>
<a name="line-1611"></a>  <font color=Cyan>(</font><font color=Magenta>"pdf"</font><font color=Cyan>,</font> PDF<font color=Cyan>)</font><font color=Cyan>,</font>
<a name="line-1612"></a>  <font color=Cyan>(</font><font color=Magenta>"ps"</font><font color=Cyan>,</font> PS<font color=Cyan>)</font><font color=Cyan>,</font>
<a name="line-1613"></a>  <font color=Cyan>(</font><font color=Magenta>"postscript"</font><font color=Cyan>,</font> PS<font color=Cyan>)</font><font color=Cyan>,</font>
<a name="line-1614"></a>  <font color=Cyan>(</font><font color=Magenta>"ascii"</font><font color=Cyan>,</font> ASCII<font color=Cyan>)</font><font color=Cyan>,</font>
<a name="line-1615"></a>  <font color=Cyan>(</font><font color=Magenta>"preview"</font><font color=Cyan>,</font> Preview<font color=Cyan>)</font><font color=Cyan>,</font>
<a name="line-1616"></a>  <font color=Cyan>(</font><font color=Magenta>"gatecount"</font><font color=Cyan>,</font> GateCount<font color=Cyan>)</font>
<a name="line-1617"></a>  <font color=Red>]</font>
<a name="line-1618"></a>                    
<a name="line-1619"></a><a name="print_dbcircuit"></a><font color=Blue><i>-- | Print a low-level quantum circuit directly to the IO monad, using</i></font>
<a name="line-1620"></a><font color=Blue><i>-- the specified format.</i></font>
<a name="line-1621"></a><font color=Blue>print_dbcircuit</font> <font color=Red>::</font> Format <font color=Red>-&gt;</font> ErrMsg <font color=Red>-&gt;</font> DBCircuit a <font color=Red>-&gt;</font> IO ()
<a name="line-1622"></a><font color=Blue>print_dbcircuit</font> EPS <font color=Red>=</font> print_dbcircuit_format eps
<a name="line-1623"></a><font color=Blue>print_dbcircuit</font> PDF <font color=Red>=</font> print_dbcircuit_format pdf
<a name="line-1624"></a><font color=Blue>print_dbcircuit</font> PS <font color=Red>=</font> print_dbcircuit_format ps
<a name="line-1625"></a><font color=Blue>print_dbcircuit</font> ASCII <font color=Red>=</font> print_dbcircuit_ascii
<a name="line-1626"></a><font color=Blue>print_dbcircuit</font> Preview <font color=Red>=</font> preview_dbcircuit
<a name="line-1627"></a><font color=Blue>print_dbcircuit</font> GateCount <font color=Red>=</font> print_gatecounts_dbcircuit
<a name="line-1628"></a><font color=Blue>print_dbcircuit</font> <font color=Cyan>(</font>CustomStyle fs<font color=Cyan>)</font> <font color=Red>=</font> print_dbcircuit_format fs
<a name="line-1629"></a>
<a name="line-1630"></a><a name="print_of_document"></a><font color=Blue><i>-- | Print a document to the requested format, which must be one of</i></font>
<a name="line-1631"></a><font color=Blue><i>-- 'PS', 'PDF', 'EPS', or 'Preview'.</i></font>
<a name="line-1632"></a><font color=Blue>print_of_document</font> <font color=Red>::</font> Format <font color=Red>-&gt;</font> Document a <font color=Red>-&gt;</font> IO a
<a name="line-1633"></a><font color=Blue>print_of_document</font> <font color=Red>=</font> print_of_document_custom custom
<a name="line-1634"></a>
<a name="line-1635"></a><a name="print_of_document_custom"></a><font color=Blue><i>-- | Like 'print_of_document', but also takes a 'Custom' data</i></font>
<a name="line-1636"></a><font color=Blue><i>-- structure.</i></font>
<a name="line-1637"></a><font color=Blue>print_of_document_custom</font> <font color=Red>::</font> Custom <font color=Red>-&gt;</font> Format <font color=Red>-&gt;</font> Document a <font color=Red>-&gt;</font> IO a
<a name="line-1638"></a><font color=Blue>print_of_document_custom</font> custom PS doc <font color=Red>=</font> render_custom_stdout Format_PS custom doc
<a name="line-1639"></a><font color=Blue>print_of_document_custom</font> custom PDF doc <font color=Red>=</font> render_custom_stdout Format_PDF custom doc
<a name="line-1640"></a><font color=Blue>print_of_document_custom</font> custom EPS doc <font color=Red>=</font> render_custom_stdout <font color=Cyan>(</font>Format_EPS <font color=Magenta>1</font><font color=Cyan>)</font> custom doc
<a name="line-1641"></a><font color=Blue>print_of_document_custom</font> custom Preview doc <font color=Red>=</font> preview_document_custom custom doc
<a name="line-1642"></a><font color=Blue>print_of_document_custom</font> custom format doc <font color=Red>=</font> error <font color=Cyan>(</font><font color=Magenta>"print_of_document: method "</font> <font color=Cyan>++</font> show format <font color=Cyan>++</font> <font color=Magenta>" can't be used in this context"</font><font color=Cyan>)</font>
<a name="line-1643"></a>
<a name="line-1644"></a><font color=Blue><i>-- ======================================================================</i></font>
<a name="line-1645"></a><font color=Blue><i>-- * Generic printing</i></font>
<a name="line-1646"></a>
<a name="line-1647"></a><a name="print_errmsg"></a><font color=Blue><i>-- | Like 'print_unary', but also takes a stub error message.</i></font>
<a name="line-1648"></a><font color=Blue>print_errmsg</font> <font color=Red>::</font> <font color=Cyan>(</font>QCData qa<font color=Cyan>)</font> <font color=Red>=&gt;</font> ErrMsg <font color=Red>-&gt;</font> Format <font color=Red>-&gt;</font> <font color=Cyan>(</font>qa <font color=Red>-&gt;</font> Circ b<font color=Cyan>)</font> <font color=Red>-&gt;</font> qa <font color=Red>-&gt;</font> IO ()
<a name="line-1649"></a><font color=Blue>print_errmsg</font> e format f shape <font color=Red>=</font> print_dbcircuit format e dbcircuit
<a name="line-1650"></a>  <font color=Green><u>where</u></font> 
<a name="line-1651"></a>    <font color=Cyan>(</font>in_bind<font color=Cyan>,</font> dbcircuit<font color=Cyan>)</font> <font color=Red>=</font> encapsulate_dynamic f shape
<a name="line-1652"></a>
<a name="line-1653"></a><a name="print_unary"></a><font color=Blue><i>-- | Print a circuit generating function to the specified format; this</i></font>
<a name="line-1654"></a><font color=Blue><i>-- requires a shape parameter.</i></font>
<a name="line-1655"></a><font color=Blue>print_unary</font> <font color=Red>::</font> <font color=Cyan>(</font>QCData qa<font color=Cyan>)</font> <font color=Red>=&gt;</font> Format <font color=Red>-&gt;</font> <font color=Cyan>(</font>qa <font color=Red>-&gt;</font> Circ b<font color=Cyan>)</font> <font color=Red>-&gt;</font> qa <font color=Red>-&gt;</font> IO ()
<a name="line-1656"></a><font color=Blue>print_unary</font> <font color=Red>=</font> print_errmsg errmsg
<a name="line-1657"></a>  <font color=Green><u>where</u></font> 
<a name="line-1658"></a>    errmsg x <font color=Red>=</font> <font color=Magenta>"print_unary: "</font> <font color=Cyan>++</font> x
<a name="line-1659"></a>
<a name="line-1660"></a><font color=Blue><i>-- | Print a circuit generating function to the specified</i></font>
<a name="line-1661"></a><font color=Blue><i>-- format. Unlike 'print_unary', this can be applied to a</i></font>
<a name="line-1662"></a><font color=Blue><i>-- circuit-generating function in curried form with /n/ arguments, for</i></font>
<a name="line-1663"></a><font color=Blue><i>-- any /n &gt;= 0/. It then requires /n/ shape parameters.</i></font>
<a name="line-1664"></a><font color=Blue><i>-- </i></font>
<a name="line-1665"></a><font color=Blue><i>-- The type of this heavily overloaded function is difficult to</i></font>
<a name="line-1666"></a><font color=Blue><i>-- read. In more readable form, it has all of the following types:</i></font>
<a name="line-1667"></a><font color=Blue><i>-- </i></font>
<a name="line-1668"></a><font color=Blue><i>-- &gt; print_generic :: Format -&gt; Circ qa -&gt; IO ()</i></font>
<a name="line-1669"></a><font color=Blue><i>-- &gt; print_generic :: (QCData qa) =&gt; Format -&gt; (qa -&gt; Circ qb) -&gt; a -&gt; IO ()</i></font>
<a name="line-1670"></a><font color=Blue><i>-- &gt; print_generic :: (QCData qa, QCData qb) =&gt; Format -&gt; (qa -&gt; qb -&gt; Circ qc) -&gt; a -&gt; b -&gt; IO ()</i></font>
<a name="line-1671"></a><font color=Blue><i>-- </i></font>
<a name="line-1672"></a><font color=Blue><i>-- and so forth.</i></font>
<a name="line-1673"></a> 
<a name="line-1674"></a><a name="print_generic"></a><font color=Blue>print_generic</font> <font color=Red>::</font> <font color=Cyan>(</font>QCData qa<font color=Cyan>,</font> QCurry qfun qa b<font color=Cyan>,</font> Curry fun qa <font color=Cyan>(</font>IO()<font color=Cyan>)</font><font color=Cyan>)</font> <font color=Red>=&gt;</font> Format <font color=Red>-&gt;</font> qfun <font color=Red>-&gt;</font> fun
<a name="line-1675"></a><font color=Blue>print_generic</font> format f <font color=Red>=</font> g <font color=Green><u>where</u></font>
<a name="line-1676"></a>  f1 <font color=Red>=</font> quncurry f
<a name="line-1677"></a>  g1 <font color=Red>=</font> print_errmsg errmsg format f1
<a name="line-1678"></a>  g <font color=Red>=</font> mcurry g1
<a name="line-1679"></a>  errmsg x <font color=Red>=</font> <font color=Magenta>"print_generic: "</font> <font color=Cyan>++</font> x
<a name="line-1680"></a>
<a name="line-1681"></a><a name="print_simple"></a><font color=Blue><i>-- | Like 'print_generic', but only works at simple types, and</i></font>
<a name="line-1682"></a><font color=Blue><i>-- therefore requires no shape parameters.</i></font>
<a name="line-1683"></a><font color=Blue>print_simple</font> <font color=Red>::</font> <font color=Cyan>(</font>QCData qa<font color=Cyan>,</font> QCurry qfun qa b<font color=Cyan>,</font> Curry fun qa <font color=Cyan>(</font>IO()<font color=Cyan>)</font><font color=Cyan>,</font> QCData_Simple qa<font color=Cyan>)</font> <font color=Red>=&gt;</font> Format <font color=Red>-&gt;</font> qfun <font color=Red>-&gt;</font> IO ()
<a name="line-1684"></a><font color=Blue>print_simple</font> format f <font color=Red>=</font> print_errmsg errmsg format f1 fs_shape <font color=Green><u>where</u></font>
<a name="line-1685"></a>  f1 <font color=Red>=</font> quncurry f
<a name="line-1686"></a>  errmsg x <font color=Red>=</font> <font color=Magenta>"print_simple: "</font> <font color=Cyan>++</font> x
</pre>
</body>
</html>